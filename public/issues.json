[{"url":"https://api.github.com/repos/alienzhou/blog/issues/49","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/49/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/49/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/49/events","html_url":"https://github.com/alienzhou/blog/issues/49","id":874384348,"node_id":"MDU6SXNzdWU4NzQzODQzNDg=","number":49,"title":"DNS æŸ¥è¯¢å¯¼è‡´çš„ Nodejs æœåŠ¡ç–‘ä¼¼â€œå†…å­˜æ³„æ¼â€é—®é¢˜","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-05-03T09:06:42Z","updated_at":"2021-05-03T09:06:42Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## 1ã€OOM æŠ¥è­¦ï¼šå†…å­˜æ³„æ¼ï¼Ÿ\r\n\r\næŸå¤©ä¸‹åˆï¼Œçº¿ä¸Šçš„æœåŠ¡ç›‘æ§å‘å‡ºæŠ¥è­¦ï¼šåœ¨åŒä¸€ä¸ªæœåŠ¡ä¸‹ï¼Œéƒ¨ç½²çš„ä¼—å¤šå®¹å™¨ä¸­ï¼ŒæŸä¸€ä¸ªå®¹å™¨å‡ºç° OOM é—®é¢˜ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116858691-5edf4e80-ac31-11eb-94aa-752708dd5df6.png)\r\n\r\nä¸Šå›¾æ˜¯å®¹å™¨ç»´åº¦çš„èµ„æºä½¿ç”¨ç‡ç›‘æ§å›¾ã€‚å¯ä»¥çœ‹åˆ°çº¢è‰²çš„å†…å­˜ä½¿ç”¨ç‡æ›²çº¿ï¼Œé€æ­¥å‡é«˜å°†è¿‘åˆ° 100% ååˆè¿…é€Ÿé™è‡³ 0%ã€‚è¿™æ˜¯å› ä¸ºè§¦å‘ OOM åå®¹å™¨è‡ªåŠ¨é‡å¯ã€‚è€Œåœ¨é‡å¯åï¼Œå®¹å™¨çš„çš„å†…å­˜ä½¿ç”¨ç‡ä»åœ¨ç¼“æ…¢ä¸Šå‡ã€‚\r\n\r\nè¯¥å®¹å™¨åˆ†é…çš„èµ„æºä¸º 1 æ ¸ 1Gï¼Œå…¶å®¹å™¨å†…åªè¿è¡Œä¸€ä¸ª Nodejs è¿›ç¨‹ã€‚è¿è¡Œçš„ Nodejs è¿›ç¨‹åœ¨æŸæ®µæ—¶é—´çš„ç›‘æ§æ›²çº¿å¦‚ä¸‹ï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116858722-6a327a00-ac31-11eb-8bc8-51e464321ed6.png)\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œå †å†…å­˜ä½¿ç”¨ç‡ä¹Ÿæ˜¯é€æ­¥æ”€å‡ï¼ŒCPU ä½¿ç”¨ç‡åˆ™è¾ƒä¸ºç¨³å®šã€‚å…¶ä¸å®¹å™¨ç»´åº¦çš„ç›‘æ§è¡¨ç°ä¸€è‡´ã€‚ä»å®¹å™¨ä¸ Nodejs è¿›ç¨‹çš„æ›²çº¿ä¸Šæ¥çœ‹ï¼Œéå¸¸åƒæ˜¯ Nodejs æœåŠ¡å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚\r\n\r\n## 2ã€ä½¿ç”¨å †å†…å­˜å¿«ç…§ï¼Œæ’æŸ¥å †å†…å­˜é—®é¢˜\r\n\r\næ—¢ç„¶æ˜¯å†…å­˜é—®é¢˜ï¼Œæˆ‘å¾ˆå¿«æƒ³åˆ°è¦é€šè¿‡å †å†…å­˜å¿«ç…§ï¼ˆHeap Snapshotï¼‰æ¥æ’æŸ¥ã€‚è¯¥æœåŠ¡ä½¿ç”¨äº†å¿«æ‰‹å†…éƒ¨è‡ªç ”çš„ KNode è¿è¡Œæ—¶æ¥éƒ¨ç½²æœåŠ¡ï¼Œå› æ­¤å¯ä»¥åœ¨çº¿ä¸ŠæŒ‰éœ€å®æ—¶åœ°æ‰“å‡ºå †å¿«ç…§ï¼Œå¹¶åœ¨çº¿æŸ¥çœ‹ï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116858755-761e3c00-ac31-11eb-9b0e-307ea6cf0a6d.png)\r\n\r\n> Heapsnaphost ä¸­å„é¡¹çš„å«ä¹‰ä»¥åŠå¦‚ä½•æŸ¥çœ‹ï¼Œå¦‚æœä¸äº†è§£å¯ä»¥çœ‹ [Chrome Devtools çš„è¯´æ˜æ–‡æ¡£](https://developer.chrome.com/docs/devtools/memory-problems/memory-101/)ã€‚\r\n\r\nä¸è¿‡å¯èƒ½æ˜¯ç”±äºå †å¿«ç…§æ˜¯ä¸€ä¸ªåˆ‡é¢æ•°æ®ï¼ŒåŒæ—¶ï¼Œæ‰“å°è¿™å¼ å¿«ç…§æ—¶å †å†…å­˜ä½¿ç”¨ç‡ä¹Ÿä¸æ˜¯å¤ªé«˜ï¼ˆå¤§æ¦‚ä¸º 20%ï¼‰ï¼Œæ‰€ä»¥åœ¨åˆæ­¥çœ‹äº†å †å¿«ç…§åï¼Œé—®é¢˜çº¿ç´¢ä¸å¤ªç›´æ¥ã€‚é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œè¿˜æœ‰ä¸€ä¸ªå¥½åŠæ³•ï¼Œå°±æ˜¯åšä¸¤ä¸ªæ—¶é—´ç‚¹çš„å¿«ç…§ Diffã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116858773-7e767700-ac31-11eb-90a0-bd52b454c9ab.png)\r\n\r\nv8 ä¼šç»™æ¯ä¸ªå †å†…å­˜å¯¹è±¡åˆ†é…ä¸€ä¸ª IDã€‚å› æ­¤å¯ä»¥åœ¨ Heap ä½¿ç”¨ç‡è¾ƒä½å’Œè¾ƒé«˜ä¸¤ä¸ªæ—¶é—´ç‚¹ï¼Œåˆ†åˆ«æ‰“å°å¯¹åº”çš„å †å¿«ç…§ï¼Œé€šè¿‡è¿™ä¸ªå…³è” IDï¼Œå°±å¯ä»¥å¯¹æ¯”å‡ºè¿™æ®µæ—¶é—´å†…æ–°å¢å’Œå›æ”¶é‡Šæ”¾çš„å †å†…å­˜å¯¹è±¡ã€‚è€Œ Chrome Devtools æœ¬èº«ä¹Ÿæ”¯æŒå †å¿«ç…§çš„ comparison å±•ç¤ºã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116858799-8c2bfc80-ac31-11eb-9084-53ddc0988df7.png)\r\n\r\nä¸Šå›¾å±•ç¤ºäº†åœ¨å †å†…å­˜ä» 20% æ¶¨åˆ° 50% åæ–°ç”³è¯·è€Œæ²¡æœ‰è¢« GC çš„å¯¹è±¡ï¼ˆObject Allocatedï¼‰ã€‚ç»“åˆä¹‹å‰çš„å †å¿«ç…§ï¼ˆåˆ‡é¢æ•°æ®ï¼‰å’Œä¸Šé¢çš„ comparison æ•°æ®ï¼ˆDiff æ•°æ®ï¼‰ï¼Œå¯ä»¥å‘ç°ï¼Œçº¢æ¡†ä¸­çš„è¿™ä¸¤ç±»å¯¹è±¡éå¸¸çªå‡ºã€‚ä¹Ÿå°±æ˜¯ `GetAddrInfoReqWrap` ä¸ `Socket`ã€‚\r\n\r\n`Socket` å’Œç½‘ç»œè¿æ¥ç›¸å…³ï¼Œå±äºæ¯”è¾ƒå¹¿çš„èŒƒå›´ã€‚å› ä¸ºæˆ‘å°†ç›®å…‰æ”¾åœ¨äº† `GetAdrrInfoReqWrap` ä¸Šã€‚åŸºäºä¹‹å‰å¯¹ Nodejs çš„äº†è§£ï¼Œæˆ‘çŸ¥é“è¿™æ˜¯å’Œ DNS æŸ¥è¯¢ç›¸å…³çš„ JS å±‚ wrapper å¯¹è±¡ã€‚å½“ç„¶ï¼Œå¦‚æœå¤§å®¶ä¸çŸ¥é“è¿™ä¸ªå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥é€šè¿‡[æŸ¥é˜… Nodejs æºç ](https://github.com/nodejs/node/blob/v14.16.1/lib/dns.js#L141)æ¥äº†è§£åˆ°å®ƒçš„åŠŸèƒ½ã€‚å±•å¼€å †å¿«ç…§ä¸­çš„å¯¹è±¡ï¼Œçœ‹ä¸‹å…·ä½“ä¿¡æ¯ï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116858812-94843780-ac31-11eb-839e-714ecabe5c9b.png)\r\n\r\nä»å¿«ç…§ä¸­å¯¹è±¡çš„å…·ä½“ä¿¡æ¯çœ‹ï¼Œå…¶ hostname æ¯”è¾ƒåˆ†æ•£ï¼Œæ‰€ä»¥æ„Ÿè§‰æ˜¯å’Œå®¹å™¨å†…æ•´ä¸ª DNS æŸ¥è¯¢æœ‰å…³ã€‚\r\n\r\n## 3ã€ä»å…¶ä»– Nodejs ç›‘æ§é¡¹ï¼Œæ¥çœ‹è¿™ä¸ªé—®é¢˜\r\n\r\nå¦‚æœæ˜¯ DNS æŸ¥è¯¢çš„é—®é¢˜ï¼Œè‚¯å®šä¹Ÿä¼šé—´æ¥å½±å“åˆ° HTTP ç›¸å…³çš„ç›‘æ§é¡¹ã€‚è€Œæƒ…å†µä¹Ÿç¡®å®å¦‚æ­¤ã€‚ä» Nodejs è¿›ç¨‹å‘èµ·çš„ HTTP è¯·æ±‚çš„ç›‘æ§æ¥çœ‹ï¼Œæœ‰é—®é¢˜çš„å®¹å™¨ï¼Œæ¯åˆ†é’Ÿèƒ½å®Œæˆçš„è¯·æ±‚æ•°åªæœ‰ 3 æ¬¡ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116858829-9bab4580-ac31-11eb-9b84-2f103e1b69b7.png)\r\n\r\nè€ŒåŒä¸€ä¸ªæœåŠ¡ä¸‹çš„æ­£å¸¸å®¹å™¨å†…ï¼Œæ¯ä¸ª Nodejs è¿›ç¨‹æ¯åˆ†é’Ÿå¯ä»¥æ­£å¸¸å‘é€è¶…è¿‡ 150 ä¸ª HTTP è¯·æ±‚ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116858851-a2d25380-ac31-11eb-8ec1-fbd74de339a4.png)\r\n\r\nåŒæ—¶ï¼Œå¼‚å¸¸å®¹å™¨ä¸­çš„ Nodejs å‘é€å®Œæˆä¸€ä¸ª HTTP è¯·æ±‚çš„å¹³å‡è€—æ—¶è¶…è¿‡äº† 800 ç§’ï¼ˆ>13åˆ†é’Ÿï¼‰ã€‚è€Œæ­£å¸¸æƒ…å†µä¸‹å†…ç½‘æœåŠ¡ä¹‹é—´çš„ HTTP è¯·æ±‚è€—æ—¶ä¸€èˆ¬éƒ½åœ¨å‡ åæ¯«ç§’ï¼Œæ…¢çš„ä¹Ÿä¸å¤ªä¼šè¶…è¿‡å‡ ç™¾æ¯«ç§’ã€‚\r\n\r\næ­¤å¤–ï¼Œå¦‚æœæŸ¥çœ‹ Nodejs çš„ Active Handle çš„æ•°é‡ï¼Œä¹Ÿæ˜¯å¤„äºä¸€ä¸ªæŒç»­ä¸Šæ¶¨çš„çŠ¶æ€ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116858882-b4b3f680-ac31-11eb-8a6a-f1bbfa8e204f.png)\r\n\r\nè¿™é‡Œçš„ Active Handle æ˜¯æŒ‡ [libuv ä¸­çš„ Handle](http://docs.libuv.org/en/v1.x/design.html#handles-and-requests)ï¼Œä¸å…¶ç±»ä¼¼çš„è¿˜æœ‰ä¸€ä¸ªå« Request çš„æ¦‚å¿µã€‚å®ƒæ˜¯ libuv ä¸­çš„æŠ½è±¡æ¦‚å¿µï¼Œç”¨æ¥æŒ‡ä»£ libuv ä¸­æŸé¡¹æ“ä½œçš„å¯¹è±¡ï¼Œä¾‹å¦‚å®šæ—¶å™¨ã€è®¾å¤‡ IO ç­‰ã€‚Nodejs è¿›ç¨‹ä¸­çš„ Active Handle æ•°é‡æŒç»­ä¸Šæ¶¨å¾€å¾€æ˜¯æœ‰é—®é¢˜çš„ï¼Œå®ƒè¯´æ˜ Nodejs è¦å¤„ç†çš„ä¸œè¥¿â€œç§¯å‹â€åœ°è¶Šæ¥è¶Šå¤šã€‚\r\n\r\nå› æ­¤ï¼ŒåŸºæœ¬æ€€ç–‘å°±æ˜¯ DNS æŸ¥è¯¢çš„é—®é¢˜å¯¼è‡´è¯·æ±‚ç§¯å‹ï¼Œä»è€Œå¯¼è‡´äº†è¯¥æ•…éšœã€‚\r\n\r\n## 4ã€æ•…éšœç¡®å®šä¸ä¿®å¤\r\n\r\né€šè¿‡ä¸Šé¢çš„åˆ†æï¼ŒåŸºæœ¬å¯ä»¥ç¡®å®šå’Œ DNS æŸ¥è¯¢è„±ä¸äº†å¹²ç³»ã€‚å› ä¸ºåœ¨æœåŠ¡éƒ¨ç½²çš„ä¼—å¤šå®¹å™¨ä¸­ï¼Œåªæœ‰è¿™ä¸€ä¸ªæœ‰ OOM é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘åˆ†åˆ«ç™»è¿›ä¸€ä¸ªå¥åº·å®¹å™¨å’Œè¿™ä¸ªé—®é¢˜å®¹å™¨ï¼Œæ‰§è¡Œä»¥ä¸‹ JS ä»£ç æ¥ç¡®è®¤ DNS æŸ¥è¯¢æƒ…å†µï¼ˆæœ¬æ–‡éšå»äº†å®é™…åŸŸåï¼‰ï¼š\r\n\r\n```js\r\nconsole.time('dns');\r\nrequire('dns').lookup('xxx.xxxx.xxx', () => {\r\n    console.timeEnd('dns');\r\n});\r\n```\r\n\r\nè¿™é‡Œéœ€è¦æä¸€ä¸‹ã€‚Nodejs å°è£…äº†ä¸¤ç±» DNS æŸ¥è¯¢çš„æ–¹æ³•ï¼Œä¸€ç±»å°±æ˜¯ä¸Šé¢ç”¨åˆ°çš„ `dns.lookup()`ï¼›å¦ä¸€ä¸ªå°±æ˜¯ `dns.resolve()` å’Œ `dns.resolve*()`ã€‚è¿™é‡Œä¹‹æ‰€ä»¥åœ¨æµ‹è¯•ä»£ç ä¸­ä½¿ç”¨ `dns.lookup()` æ–¹æ³•ï¼Œæ˜¯å› ä¸ºä½¿ç”¨ Nodejs ä¸­å†…ç½® http æ¨¡å—çš„ `http.request()` è¯·æ±‚æ—¶ï¼Œé»˜è®¤ä½¿ç”¨çš„å°±æ˜¯è¯¥æ–¹æ³•ï¼Œè€Œä¸æ˜¯ `dns.resolve()`ã€‚\r\n\r\né¡¹ç›®ä½¿ç”¨äº† axiosï¼Œè€Œå…¶åœ¨ [Nodejs ç¯å¢ƒ](https://github.com/axios/axios/blob/v0.21.1/lib/defaults.js#L18-L24)ä¸‹[ä½¿ç”¨çš„æ˜¯ `http.request()`](https://github.com/axios/axios/blob/v0.21.1/lib/adapters/http.js#L7) æ–¹æ³•æ¥å‘èµ· HTTP è¯·æ±‚ã€‚`http.request()` ä¼šè°ƒç”¨ net æ¨¡å—ä¸­çš„ [`createConnection` æ–¹æ³•](https://github.com/nodejs/node/blob/v14.16.1/lib/_http_client.js#L321)æ¥å»ºç«‹è¿æ¥ã€‚net æ¨¡å—åˆ›å»ºè¿æ¥æ—¶ï¼Œ[é»˜è®¤çš„ lookup æ–¹æ³•](https://github.com/nodejs/node/blob/v14.16.1/lib/net.js#L1039)å°±æ˜¯ `dns.lookup()`ï¼š\r\n\r\n```js\r\nfunction lookupAndConnect(self, options) {\r\n  // ...\r\n  const lookup = options.lookup || dns.lookup;\r\n  defaultTriggerAsyncIdScope(self[async_id_symbol], function() {\r\n    lookup(host, dnsopts, function emitLookup(err, ip, addressType) {\r\n      self.emit('lookup', err, ip, addressType, host);\r\n      // ...\r\n    });\r\n  });\r\n}\r\n```\r\n\r\nå½“ç„¶ï¼Œlookup æ–¹æ³•æ˜¯[å¯ä»¥è®¾ç½®](https://nodejs.org/dist/latest-v14.x/docs/api/http.html#http_http_request_url_options_callback)çš„ï¼Œä¾‹å¦‚å¯ä»¥ä¼ å…¥ `dns.resolve()` æˆ–è€…è‡ªå®šä¹‰çš„æ–¹æ³•ã€‚ä¸‹å›¾å°±æ˜¯ Nodejs å®˜æ–¹æ–‡æ¡£ä¸­çš„è¯´æ˜æˆªå›¾ï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116858928-c5646c80-ac31-11eb-932f-39f6f4964728.png)\r\n\r\nå›åˆ°è¯¥æ•…éšœã€‚æµ‹è¯•ä»£ç è¿è¡Œåï¼Œæ­£å¸¸å®¹å™¨ï¼ˆä¸‹å›¾å·¦ï¼‰çš„ DNS æŸ¥è¯¢è€—æ—¶ä¸º 33 æ¯«ç§’ï¼›æ•…éšœå®¹å™¨çš„è€—æ—¶ä¸º 5000 æ¯«ç§’ï¼Œå·®å¼‚æå¤§ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116858956-ce553e00-ac31-11eb-83fb-e41250143b91.png)\r\n\r\né‚£ä¹ˆæ˜¯ä»€ä¹ˆå¯¼è‡´çš„è€—æ—¶å·®å¼‚å‘¢ï¼Ÿ\r\n\r\n`dns.lookup()` æ–¹æ³•ä¼šä½¿ç”¨ç³»ç»Ÿçš„ [`/etc/resolv.conf` é…ç½®æ–‡ä»¶](https://nodejs.org/dist/latest-v14.x/docs/api/dns.html#dns_dns_lookup_hostname_options_callback)ã€‚è¯¥æ–‡ä»¶ä¸­ä¼šè®¾ç½® nameserver çš„åœ°å€ã€è¶…æ—¶æ—¶é—´ã€é‡è¯•æ¬¡æ•°ã€rotate ç­–ç•¥ç­‰ã€‚é€šè¿‡å¯¹æ¯”æ­£å¸¸å®¹å™¨å’Œæ•…éšœå®¹å™¨ï¼Œå‘ç°äº†é…ç½®å·®å¼‚ï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116858966-d44b1f00-ac31-11eb-8b6e-7ca12cb69769.png)\r\n\r\næ•…éšœå®¹å™¨ä¸­ï¼ˆä¸Šå›¾å³ï¼‰æœ‰ä¸ª nameserver é…ç½®ä¸ºäº† `10.62.38.17`ï¼ˆæ­£å¸¸å®¹å™¨æ˜¯ `10.6.6.6`ï¼‰ã€‚è€Œ `10.62.38.17` è¿™ä¸ª nameserver ä¹‹å‰å‡ºç°äº†é—®é¢˜ï¼Œå·²ç»è¢«æ›¿æ¢æ‰äº†ã€‚ä½†æ˜¯åœ¨åŸºç¡€å¹³å°æ‰¹é‡åˆ·é…ç½®çš„æ“ä½œä¸­ï¼Œæ•…éšœå®¹å™¨æ‰€å±çš„å®¿ä¸»æœºå¯èƒ½é—æ¼æˆ–è€…å¤±è´¥äº†ã€‚å®šä½åˆ°å…·ä½“åŸå› åï¼Œè”ç³»äº†å¸å†…çš„å®¹å™¨åŒ–éƒ¨ç½²/è¿è¥å¹³å°çš„åŒå­¦ï¼Œä¿®å¤è¯¥é…ç½®ååæ•…éšœå°±è§£å†³äº†ã€‚\r\n\r\n## 5ã€æ€»ç»“\r\n\r\nè¿™ä¸ªé—®é¢˜æ›²æŠ˜çš„ç‚¹åœ¨äºï¼šå…¶ç›‘æ§è¡¨è±¡åˆçœ‹åƒæ˜¯å†…å­˜æ³„æ¼ï¼Œè€Œä¸€èˆ¬æ¥è¯´å†…å­˜æ³„æ¼éƒ½æ˜¯ä»£ç  bug å¯¼è‡´çš„ã€‚ä½†è¿™ä¸ªæ•…éšœå…¶å®å¹¶éå¦‚æ­¤ï¼Œå®é™…æ˜¯å®¿ä¸»æœº DNS nameserver çš„é…ç½®é—®é¢˜ã€‚\r\n\r\nåŸå› å¤§è‡´å°±æ˜¯ï¼Œç”±äº Nodejs ä¸­ DNS æŸ¥è¯¢è€—æ—¶è¿‡é•¿å¯¼è‡´äº†è¯·æ±‚å †ç§¯ï¼Œä¸Šæ¸¸æœåŠ¡ä¸ Nodejs å»ºç«‹çš„è¿æ¥ä¹Ÿä¸ä¼šé‡Šæ”¾ã€‚æ‰€ä»¥åœ¨æ•´ä¸ªè¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸä¸­ã€ŒæŒæœ‰ã€çš„å¯¹è±¡æœªè¢«é‡Šæ”¾ï¼Œå †å†…å­˜ä¸­å¯¹è±¡ä¸æ–­å¢å¤šï¼Œä»è€Œçœ‹èµ·æ¥åƒæ˜¯ã€Œå†…å­˜æ³„æ¼ã€ã€‚\r\n\r\n---\r\n\r\n## åŠ é¤ï¼šèŠèŠ Nodejs ä¸­ DNS æŸ¥è¯¢ä¸è¯·æ±‚å †ç§¯\r\n\r\nä¸Šé¢è¿˜æ˜¯åªä¸€ä¸ªç²—ç•¥çš„åˆ†æå’Œå®šä½ã€‚åœ¨è¿™ä¸€èŠ‚ä¼šå°è¯•èƒ½æ›´æ·±å…¥ä¸€äº›ï¼Œå°†æ•…éšœç°è±¡å’Œ Nodejs å®ç°ç»†èŠ‚è”ç³»èµ·æ¥ã€‚\r\n\r\nå…³äº Nodejs ä¸­ DNS æŸ¥è¯¢æ•…éšœå¯¼è‡´çš„æœåŠ¡ä¸å“åº”çš„é—®é¢˜ï¼Œä¹‹å‰å·²ç»æœ‰æ–‡ç« é˜è¿°äº†ç±»ä¼¼çš„é—®é¢˜ï¼š\r\n\r\n> - [nodeä¸­è¯·æ±‚è¶…æ—¶çš„ä¸€äº›å‘](https://acemood.github.io/2020/05/02/node%E4%B8%AD%E8%AF%B7%E6%B1%82%E8%B6%85%E6%97%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/)\r\n> - [NodeJS ä¸­ DNS æŸ¥è¯¢çš„å‘ & DNS cache åˆ†æ](https://zhuanlan.zhihu.com/p/138584520)\r\n\r\nä¸‹é¢å†å°è¯•ç®€å•è§£é‡Šä¸€ä¸‹ã€‚\r\n\r\nä½¿ç”¨ http æ¨¡å—çš„ `http.request()` æ–¹æ³•é»˜è®¤ä¼šä½¿ç”¨ `dns.lookup()` ä½œä¸º DNS æŸ¥è¯¢çš„æ–¹æ³•ï¼ˆè¿™ä¸ªåœ¨ä¸Šä¸­æ–‡ä¹Ÿå·²ç»æåˆ°äº†ï¼‰ã€‚è€Œ `dns.lookup()` é€šè¿‡ binding ä¼šè°ƒç”¨åˆ° [`GetAddrInfo()` å‡½æ•°](https://github.com/nodejs/node/blob/v14.16.1/src/cares_wrap.cc#L1987-L1991)ï¼š\r\n\r\n```c++\r\nvoid GetAddrInfo(const FunctionCallbackInfo<Value>& args) {\r\n  // ...\r\n  int err = req_wrap->Dispatch(uv_getaddrinfo,\r\n                               AfterGetAddrInfo,\r\n                               *hostname,\r\n                               nullptr,\r\n                               &hints);\r\n  if (err == 0)\r\n    // Release ownership of the pointer allowing the ownership to be transferred\r\n    USE(req_wrap.release());\r\n\r\n  args.GetReturnValue().Set(err);\r\n}\r\n```\r\n\r\nå…¶ä¸­æœ€é‡è¦çš„è°ƒç”¨çš„å°±æ˜¯ `uv_getaddrinfo()`ï¼Œå®ƒä¼šå°† [`uv__getaddrinfo_work` æäº¤åˆ°çº¿ç¨‹æ± çš„å·¥ä½œä»»åŠ¡ä¸­](https://github.com/nodejs/node/blob/v14.16.1/deps/uv/src/unix/getaddrinfo.c#L209-L213)ï¼š\r\n\r\n```c++\r\nuv__work_submit(loop,\r\n                &req->work_req,\r\n                UV__WORK_SLOW_IO,\r\n                uv__getaddrinfo_work,\r\n                uv__getaddrinfo_done);\r\n```\r\n\r\nè€Œ `uv__getaddrinfo_work()` ä¸­å°±ä¼šä½¿ç”¨ [`getaddrinfo` å‡½æ•°](https://github.com/nodejs/node/blob/v14.16.1/deps/uv/src/unix/getaddrinfo.c#L101-L108)æ¥åš DNS æŸ¥è¯¢ï¼š\r\n\r\n```c++\r\nstatic void uv__getaddrinfo_work(struct uv__work* w) {\r\n  uv_getaddrinfo_t* req;\r\n  int err;\r\n\r\n  req = container_of(w, uv_getaddrinfo_t, work_req);\r\n  err = getaddrinfo(req->hostname, req->service, req->hints, &req->addrinfo);\r\n  req->retcode = uv__getaddrinfo_translate_error(err);\r\n}\r\n```\r\n\r\né‚£ä¹ˆä¸ºä»€ä¹ˆä¼šæ¶‰åŠåˆ°çº¿ç¨‹æ± æ¦‚å¿µå‘¢ï¼Ÿå› ä¸ºè°ƒç”¨ `getaddrinfo()` å‡½æ•°æ˜¯ä¸€ä¸ªåŒæ­¥è°ƒç”¨ï¼Œæ‰€ä»¥ [libuv ä¼šé€šè¿‡çº¿ç¨‹æ± ](https://docs.libuv.org/en/latest/threadpool.html)æ¥å®ç° Nodejs æ‰€éœ€çš„å¼‚æ­¥ IOã€‚çº¿ç¨‹æ± é»˜è®¤å¤§å°ä¸º 4ï¼Œå¯ä»¥é€šè¿‡ [`UV_THREADPOOL_SIZE` è¿™ä¸ªç¯å¢ƒå˜é‡](https://github.com/nodejs/node/blob/v14.16.1/deps/uv/src/threadpool.c#L194)æ¥é…ç½®ï¼Œåœ¨ Nodejs v14 ä¸­æœ€å¤§æ˜¯ 1024ã€‚\r\n\r\nå›åˆ°æ•…éšœåœºæ™¯ï¼š\r\n\r\nä»æ­£å¸¸è¿›ç¨‹çš„ç›‘æ§æ•°æ®çœ‹åˆ°ï¼Œæ¯åˆ†é’Ÿ Nodejs è¿›ç¨‹å‘èµ·çš„è¯·æ±‚å¤§è‡´ä¸º 150 ä¸ªï¼Œä¹Ÿå°±æ˜¯ 1 ç§’ 2.5 ä¸ªã€‚è€Œåœ¨æ•…éšœå®¹å™¨ä¸­ï¼Œè¯·æ±‚åœ¨ DNS æŸ¥è¯¢é˜¶æ®µå°±è¦è€—æ—¶ 5sã€‚å³ä½¿ä¸è€ƒè™‘å…¶ä»–è€—æ—¶ä¹Ÿè¦ 5s æ‰èƒ½å‘å®Œä¸€ä¸ªè¯·æ±‚ã€‚4 ä¸ªçº¿ç¨‹å¹³å‡ä¸‹æ¥ï¼Œä¹Ÿå°±æ˜¯ 1 ç§’æœ€å¤šèƒ½å¤„ç† 0.8 ä¸ªè¯·æ±‚ã€‚æ˜¾ç„¶ï¼Œ2.5 è¦è¿œå¤§äº 0.8ï¼Œå¤„ç†èƒ½åŠ›å’Œè¯·æ±‚æ•°é‡ä¸¥é‡ä¸åŒ¹é…ã€‚æ‰€ä»¥æœåŠ¡è¿è¡Œæ—¶é—´è¶Šé•¿ï¼Œç§¯å‹çš„è¯·æ±‚æ•°ã€è¿æ¥æ•°å°±è¶Šå¤šã€‚\r\n\r\nåˆ°è¿™é‡Œï¼Œè¿˜æœ‰å‡ ä¸ªé—®é¢˜å¯ä»¥å†è¯´æ˜ä¸‹ï¼š\r\n\r\n### å…³äºè¶…æ—¶\r\n\r\nå¯¹äº HTTP è¯·æ±‚ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šè®¾ç½®è¶…æ—¶æ—¶é—´ã€‚ä½†æ˜¯ Nodejs å‘èµ·çš„è¯·æ±‚å¯èƒ½ä¸ä¼šè§¦å‘åˆ°è¶…æ—¶ï¼Œç”±æ­¤ä½¿å¾—ä¸Šæ¸¸æœåŠ¡åˆ° Nodejs çš„è¿æ¥ä¸ä¼šåŠæ—¶æ–­å¼€ã€‚è¿™æ˜¯åœ¨ä½¿ç”¨ axios æ—¶å¯èƒ½å‡ºç°çš„é—®é¢˜ã€‚\r\n\r\nå› ä¸º axios ä¼šåŸºäº [`requset.setTimeout`](https://github.com/axios/axios/blob/v0.21.1/lib/adapters/http.js#L278) æ¥è®¾ç½®è¶…æ—¶ã€‚ä¹‹å‰çš„[æ–‡ç« ](https://acemood.github.io/2020/05/02/node%E4%B8%AD%E8%AF%B7%E6%B1%82%E8%B6%85%E6%97%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/)ä¹Ÿåˆ†æè¿‡ï¼Œå®ƒæ˜¯ä¸åŒ…å« DNS æŸ¥è¯¢æ—¶é—´çš„ã€‚ä» [Nodejs å®˜ç½‘æ–‡æ¡£](https://nodejs.org/dist/latest-v14.x/docs/api/http.html#http_request_settimeout_timeout_callback)ä¸­ä¹Ÿèƒ½å¤§è‡´çœ‹å‡ºè¿™ä¸ªæ„æ€ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116858995-ddd48700-ac31-11eb-9e76-f5dae1de9eac.png)\r\n\r\n### å…³äº DNS cache\r\n\r\nNodejs æœ¬èº«ä¸åš DNS æŸ¥è¯¢ç»“æœçš„ç¼“å­˜ï¼ˆä¸€äº›è®¨è®ºä¹Ÿè®¤ä¸º cache æ”¾åœ¨ userland å¯èƒ½ä¼šåˆç†äº›ï¼‰ã€‚æ‰€ä»¥å¦‚æœ `getaddrinfo()` æœ¬èº«ä¹Ÿæ²¡æœ‰ DNS cacheï¼ˆå¼€å¯ nscd ä¼¼ä¹å¯ä»¥ï¼‰ï¼ŒNodejs å°±ä¼šåœ¨æ¯æ¬¡ä½¿ç”¨åŸŸååš http è¯·æ±‚æ—¶ï¼Œéƒ½ä¼šå»è¯·æ±‚ DNS nameserverã€‚ä¸Šæ–‡æ•…éšœä¸­çš„æƒ…å†µä¾¿æ˜¯å¦‚æ­¤ã€‚\r\n\r\nå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨ç±»ä¼¼åƒ [dnscache](https://www.npmjs.com/package/dnscache) è¿™ç±»åŒ…æ¥åš monkey patchï¼Œåœ¨ JS å±‚ä¸º DNS æŸ¥è¯¢æ·»åŠ ç¼“å­˜ï¼›æˆ–è€…é€šè¿‡åœ¨ axios ä¸­æ·»åŠ æ‹¦æˆªå™¨ï¼Œå®ç°ç¼“å­˜ã€‚ä¸è¿‡ä½¿ç”¨ç¼“å­˜ä¸€å®šè¦æ³¨æ„å¤„ç†ç¼“å­˜è¿‡æœŸçš„é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ DNS server è¿”å›çš„ TTLã€‚ä¸è¿‡æœ‰æ—¶è¿™ä¸ªå€¼ä¹Ÿä¸å¤ªå¯é ï¼Œå¯èƒ½ä¼šéœ€è¦åŸºäºä¸šåŠ¡åœºæ™¯è®¾ç½®ä¸€ä¸ªå°½é‡å°çš„å€¼ã€‚æ€»ä¹‹ä½¿ç”¨ç¼“å­˜ä¸€å®šè¦è°¨æ…ï¼\r\n\r\n### å…³äº `dns.resolve()`/`dns.resolve*()`\r\n\r\nä»æ–‡ç« ä¹‹å‰çš„ç« èŠ‚å¯ä»¥çŸ¥é“ï¼Œ`dns.resolve()`/`dns.resolve*()` ä¸ `dns.lookup()` çš„å®ç°å¹¶ä¸ç›¸åŒã€‚å®ƒä»¬æ˜¯åŸºäº [c-ares](https://github.com/c-ares/c-ares) å®ç°çš„ã€‚\r\n\r\n> This is c-ares, an asynchronous resolver library. It is intended for applications which need to perform DNS queries without blocking, or need to perform multiple DNS queries in parallel.\r\n\r\n`http.request()` æ˜¯æ”¯æŒé€šè¿‡åœ¨ options ä¸­ä¼ å…¥ lookup é…ç½®æ¥è¦†ç›–é»˜è®¤çš„ `dns.lookup` çš„ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„ `dns.resolve()` å’Œ `dns.lookup` å­˜åœ¨çš„[å¯èƒ½åŒºåˆ«](https://nodejs.org/dist/latest-v14.x/docs/api/dns.html#dns_dns_resolve_dns_resolve_and_dns_reverse)ã€‚\r\n\r\næ­¤å¤–ï¼Œå®ƒä»¬åªæ˜¯ä¸ç”¨å†ä½¿ç”¨çº¿ç¨‹æ± ï¼Œå¦‚æœé‡åˆ°åƒæ–‡ä¸­çš„æ•…éšœï¼ŒDNS æŸ¥è¯¢çš„è€—æ—¶ä¸€æ ·ä¼šå¾ˆé«˜ï¼ŒåŒæ ·ä¼šæœ‰ç±»ä¼¼é—®é¢˜ã€‚\r\n\r\nå®Œã€‚\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/48","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/48/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/48/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/48/events","html_url":"https://github.com/alienzhou/blog/issues/48","id":873974537,"node_id":"MDU6SXNzdWU4NzM5NzQ1Mzc=","number":48,"title":"npm script æ‰§è¡Œâ€ä¸¢å¤±â€œ root æƒé™çš„é—®é¢˜","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845014,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE0","url":"https://api.github.com/repos/alienzhou/blog/labels/JavaScript","name":"JavaScript","color":"d73a4a","default":false,"description":""},{"id":2966265382,"node_id":"MDU6TGFiZWwyOTY2MjY1Mzgy","url":"https://api.github.com/repos/alienzhou/blog/labels/Troubleshooting","name":"Troubleshooting","color":"bfdadc","default":false,"description":""},{"id":1159845016,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%BB%BC%E5%90%88","name":"ç»¼åˆ","color":"a2eeef","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-05-02T15:45:44Z","updated_at":"2021-05-02T15:45:44Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"![image](https://user-images.githubusercontent.com/9822789/116818901-3f4c1580-aba0-11eb-9760-48660692f9c4.png)\r\n\r\n## 1ã€é—®é¢˜èƒŒæ™¯\r\n\r\nè¿‘æœŸï¼Œåœ¨çº¿ä¸Šè¿è¡ŒæœåŠ¡æ—¶é‡åˆ°äº†ä¸€ä¸ªè¯¡å¼‚çš„ Linux æƒé™é—®é¢˜ï¼šroot ç”¨æˆ·åœ¨æ“ä½œæœ¬è¯¥æœ‰æƒé™çš„èµ„æºæ—¶ï¼Œå´æŠ¥äº†æƒé™é”™è¯¯ã€‚\r\n\r\næŠ¥é”™å¦‚ä¸‹ï¼š\r\n\r\n```text\r\nError: EACCES: permission denied, mkdir '/root/.pm2/logs'\r\n    at Object.mkdirSync (fs.js:921:3)\r\n    at mkdirpNativeSync (/home/web_server/project/node_modules/pm2/node_modules/mkdirp/lib/mkdirp-native.js:29:10)\r\n    at Function.mkdirpSync [as sync] (/home/web_server/project/node_modules/pm2/node_modules/mkdirp/index.js:21:7)\r\n    at module.exports.Client.initFileStructure (/home/web_server/project/node_modules/pm2/lib/Client.js:133:25)\r\n    at new module.exports (/home/web_server/project/node_modules/pm2/lib/Client.js:38:8)\r\n    at new API (/home/web_server/project/node_modules/pm2/lib/API.js:108:19)\r\n    at Object.<anonymous> (/home/web_server/ã€project/node_modules/pm2/lib/binaries/CLI.js:22:11)\r\n    at Module._compile (internal/modules/cjs/loader.js:1137:30)\r\n    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1157:10)\r\n    at Module.load (internal/modules/cjs/loader.js:985:32)\r\n```\r\n\r\nè¿™ä¸ªé”™è¯¯éå¸¸ç›´è§‚ï¼Œå°±æ˜¯ç”¨æˆ·æƒ³è¦åˆ›å»º `/root/.pm2/logs` æ–‡ä»¶å¤¹ï¼Œä½†æ˜¯æ²¡æœ‰æƒé™ã€‚è¯¥æœåŠ¡ä½¿ç”¨ pm2 åšå¤šè¿›ç¨‹ç®¡ç†ã€‚pm2 é»˜è®¤ä¼šå°†å…¶æ—¥å¿—ä¿¡æ¯ã€è¿›ç¨‹ä¿¡æ¯ç­‰å†™å…¥åˆ° `$HOME/.pm2` ä¸‹ã€‚å› ä¸ºæ˜¯ root åç”¨æˆ·æ‰€ä»¥å†™åˆ°äº† `/root/.pm2` é‡Œã€‚\r\n\r\nä½†è¿™ä¸ªé—®é¢˜çš„å¥‡æ€ªä¹‹å¤„åœ¨äºï¼ŒæœåŠ¡æ˜¯é€šè¿‡ root ç”¨æˆ·å¯åŠ¨çš„ï¼Œå¯¹ `/root` ç›®å½•æ˜¯å…·æœ‰å†™å…¥æƒé™çš„ã€‚ä½†è¿™é‡Œå´æŠ¥äº†åä¼˜æƒé™çš„é”™æˆ‘ã€‚\r\n\r\né‚£ä¹ˆæ˜¯ä»€ä¹ˆå¯¼è‡´ root ç”¨æˆ·æ“ä½œ `/root` ç›®å½•çš„æƒé™â€œä¸¢å¤±â€äº†å‘¢ï¼Ÿ\r\n\r\n## 2ã€åˆæ­¥æ’æŸ¥\r\n\r\né¡¹ç›®æ˜¯å®¹å™¨åŒ–éƒ¨ç½²ï¼Œä½¿ç”¨ npm script å¯åŠ¨ï¼Œä»£ç æ–‡ä»¶ä½äº `/home/web_server/project` ä¸‹ã€‚æ‰§è¡Œ `npm start` å³å¯å¯åŠ¨ã€‚\r\n\r\nè¿™æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„ä¸€å¥—æ ‡å‡†çš„æ„å»ºä¸éƒ¨ç½²ã€Œæ¨¡ç‰ˆã€ï¼Œå·²ç»åœ¨ä¸Šç™¾ä¸ªæœåŠ¡ä¸Šåº”ç”¨ï¼Œä¸”ä¸€ç›´éƒ½æ­£å¸¸ã€‚çŸ¥é“è¿‘æœŸçš„ä¸€æ¬¡ä¸Šçº¿å‡ºç°äº†ä¸Šé¢è¿™ä¸ªé—®é¢˜ã€‚\r\n\r\nè¿™æ¬¡çªç„¶å‡ºç°çš„è¿™ä¸ªé—®é¢˜è®©æˆ‘å……æ»¡äº†ç–‘æƒ‘ â€”â€” åŸºäºå¯¹ Linux ç³»ç»Ÿç”¨æˆ·ã€ç”¨æˆ·ç»„æƒé™æ§åˆ¶çš„ç†è§£ï¼Œä¸å¯èƒ½å‡ºç°è¿™ä¸ªé”™è¯¯ã€‚éš¾é“æ˜¯æˆ‘ç†è§£æœ‰è¯¯ï¼Ÿ\r\n\r\nåœ¨ç–‘æƒ‘çš„åŒæ—¶ï¼Œæˆ‘å°è¯•ä¸ä½¿ç”¨ npm scriptï¼Œç›´æ¥é€šè¿‡ pm2 å‘½ä»¤è¡Œ `pm2 start ecosystem.config.js` å¯åŠ¨ï¼Œå‘ç°æœåŠ¡æ­£å¸¸å¯åŠ¨äº†ï¼è«éæ˜¯ npm å¯¼è‡´çš„ï¼Ÿ\r\n\r\nè€Œåœ¨è¿™æ¬¡ä¸Šçº¿çš„æ—¶å€™ï¼Œç¡®å®æ›´æ–°äº†åŸºç¡€é•œåƒï¼Œå‡çº§äº† npm cliã€‚ä¹‹å‰æ˜¯ v6.xï¼Œè¿™æ¬¡æ›´æ–°åˆ°äº† v7.xã€‚è€Œå½“æˆ‘å°† npm ç‰ˆæœ¬å›é€€åˆ° v6.x åï¼Œé—®é¢˜å°æ—¶ã€‚çœ‹æ¥æ˜¯ v7.x çš„æ”¹åŠ¨å¯¼è‡´äº†è¿™ä¸ªé—®é¢˜ã€‚\r\n\r\n## 3ã€é—®é¢˜å®šä½\r\n\r\nå…ˆè¯´ç»“è®ºï¼šnpm v6.x ä½¿ç”¨ npm script æ‰§è¡Œå‘½ä»¤æ—¶é»˜è®¤ä¼šä½¿ç”¨ unsafe æ¨¡å¼ï¼Œå°†å­æ‰§è¡Œå‘½ä»¤çš„å­è¿›ç¨‹è®¾ç½®ä¸º root ç”¨æˆ·/ç”¨æˆ·ç»„ï¼Œè¯¥è¡Œä¸ºå¯ä»¥é€šè¿‡ `unafe-pem` é…ç½®æ¥æ§åˆ¶ã€‚è€Œåœ¨ v7.x ä¸­ï¼Œå¦‚æœé€šè¿‡ root ç”¨æˆ·æ‰§è¡Œ npm scriptï¼Œåˆ™ä¼šåŸºäºå½“å‰ç›®å½•ï¼ˆcwdï¼‰æ‰€å±ç”¨æˆ·æ¥è®¾ç½®ã€‚\r\n\r\nä¸‹é¢é€šè¿‡ä»£ç æ¥ä¸€èµ·çœ‹ä¸‹ã€‚\r\n\r\n### 3.1ã€v7.x ä¸­ npm script çš„å®ç°\r\n\r\n> ä»¥ä¸‹ä»£ç æ¥è‡ª [npm/cli v7.11.1](https://github.com/npm/cli/tree/v7.11.1)\r\n\r\nnpm script çš„æ‰§è¡Œé€»è¾‘å¯ä»¥ä» [`lib/exec.js`](https://github.com/npm/cli/blob/v7.11.1/lib/exec.js#L88) ä¸­æŸ¥çœ‹ï¼š\r\n\r\n```js\r\nclass Exec extends BaseCommand {\r\n  // ...\r\n  async _exec (_args, { locationMsg, path, runPath }) {\r\n    // ...\r\n    if (call && _args.length)\r\n      throw this.usage\r\n\r\n    return libexec({\r\n      ...flatOptions,\r\n      args,\r\n      // ...\r\n    })\r\n  }\r\n}\r\n```\r\n\r\nçœç•¥æ— å…³ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°æ‰§è¡Œ npm script æ—¶ä¼šè°ƒç”¨ `libexec` æ–¹æ³•ï¼Œ[`libexec` æ–¹æ³•](https://github.com/npm/cli/blob/v7.11.1/node_modules/libnpmexec/lib/index.js#L50)å†…éƒ¨ä¼šè°ƒç”¨ [`runScript` æ–¹æ³•](https://github.com/npm/cli/blob/v7.11.1/node_modules/libnpmexec/lib/index.js#L50)æ¥æ‰§è¡Œå‘½ä»¤ã€‚\r\n\r\n> å› ä¸ºè°ƒç”¨é“¾æ¯”è¾ƒé•¿ï¼Œæˆ‘æŠŠä¸­é—´ä»£ç çœç•¥äº†ï¼Œåªè´´å‡ºå…³é”®çš„ä»£ç ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ç‚¹å‡»æ–‡ä¸­é“¾æ¥è·³è½¬æŸ¥çœ‹ã€‚\r\n\r\né€šè¿‡[ä¸€ç³»åˆ—](https://github.com/npm/cli/blob/v7.11.1/node_modules/%40npmcli/run-script/lib/run-script.js#L9)æ›²æŠ˜çš„è°ƒç”¨ï¼Œä»£ç æœ€åä¼šè°ƒç”¨åˆ° [`promiseSpawn` æ–¹æ³•](https://github.com/npm/cli/blob/v7.11.1/node_modules/%40npmcli/run-script/lib/run-script-pkg.js#L54)ã€‚è¿™ä¸ªæ–¹æ³•æœ€ç»ˆä¼šä½¿ç”¨ child_process å†…ç½®æ¨¡å—é‡Œæçš„ `spawn` æ–¹æ³•æ¥å¯åŠ¨å­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤ï¼Œå…¶[ç›¸å…³ä»£ç ](https://github.com/npm/cli/blob/v7.11.1/node_modules/%40npmcli/promise-spawn/index.js#L13-L20)å¦‚ä¸‹ï¼š\r\n\r\n```js\r\nconst promiseSpawn = (cmd, args, opts, extra = {}) => {\r\n  const cwd = opts.cwd || process.cwd()\r\n  const isRoot = process.getuid && process.getuid() === 0\r\n  const { uid, gid } = isRoot ? inferOwner.sync(cwd) : {}\r\n  return promiseSpawnUid(cmd, args, {\r\n    ...opts,\r\n    cwd,\r\n    uid,\r\n    gid\r\n  }, extra)\r\n}\r\n```\r\n\r\nä¸Šé¢çš„å®ç°ä¸­ï¼Œæœ‰ä¸€è¡Œéå¸¸é‡è¦ï¼š\r\n\r\n```js\r\nconst { uid, gid } = isRoot ? inferOwner.sync(cwd) : {}\r\n```\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœå½“å‰è¿›ç¨‹çš„ç”¨æˆ·æ˜¯ rootï¼Œåˆ™ä¼šä½¿ç”¨ `inferOwner` æ–¹æ³•æ¥è®¾ç½®å¯åŠ¨çš„å­è¿›ç¨‹çš„ uid å’Œ gidï¼ˆä¹Ÿå°±æ˜¯ç”¨æˆ· id å’Œç”¨æˆ·ç»„ idï¼‰ã€‚\r\n\r\né‚£ä¹ˆ `inferOwner` æ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿå®ƒå…¶å®å°±æ˜¯[ç”¨æ¥è·å–æŸä¸ªæ–‡ä»¶æ‰€å±çš„ç”¨æˆ·ä¸ç”¨æˆ·ç»„](https://github.com/npm/cli/blob/v7.11.1/node_modules/%40npmcli/promise-spawn/index.js#L13-L20)çš„ï¼š\r\n\r\n```js\r\nconst inferOwnerSync = path => {\r\n  path = resolve(path)\r\n  if (cache.has(path))\r\n    return cache.get(path)\r\n\r\n  const parent = dirname(path)\r\n\r\n  let threw = true\r\n  try {\r\n    const st = fs.lstatSync(path)\r\n    threw = false\r\n    const { uid, gid } = st\r\n    cache.set(path, { uid, gid })\r\n    return { uid, gid }\r\n  } finally {\r\n    if (threw && parent !== path) {\r\n      const owner = inferOwnerSync(parent)\r\n      cache.set(path, owner)\r\n      return owner // eslint-disable-line no-unsafe-finally\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nå…¶ä¸­æœ€é‡è¦çš„ä»£ç æ˜¯è¿™å‡ è¡Œï¼š\r\n\r\n```js\r\nconst st = fs.lstatSync(path)\r\n// ...\r\nconst { uid, gid } = st\r\n```\r\n\r\n[`fs.lstatSync` æ–¹æ³•](https://nodejs.org/dist/latest-v14.x/docs/api/fs.html#fs_fs_lstatsync_path_options) ä¼šä½¿ç”¨ [`fstat`](https://man7.org/linux/man-pages/man2/lstat.2.html) è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ¥è·å–æ–‡ä»¶çš„ uid å’Œ gidã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116818830-e67c7d00-ab9f-11eb-902b-143e08bffe04.png)\r\n\r\n`promiseSpawn` ä¸­ä¼šå°† cwd ä¼ å…¥æ¥è·å– uid å’Œ gidã€‚è€Œåœ¨æˆ‘ä»¬çº¿ä¸ŠæœåŠ¡çš„å®¹å™¨é‡Œï¼Œæˆ‘ä»¬æ˜¯åœ¨ `/home/web_server/project` ä¸‹æ‰§è¡Œ `npm start`ï¼Œè¯¥ç›®å½•æ‰€å±ç”¨æˆ·æ˜¯ `web_server`ï¼Œç”¨æˆ·ç»„æ˜¯ `web_server`ã€‚æ‰€ä»¥ npm åœ¨å¯åŠ¨å­è¿›ç¨‹æ—¶â€œåˆ‡æ¢â€äº†ç”¨æˆ·ã€‚\r\n\r\næ‰€ä»¥å®é™…æƒ…å†µæ˜¯ï¼Œ`pm2 start ecosystemt.config.js` ç›¸å½“äºæ˜¯è¢« web_server ç”¨æˆ·å¯åŠ¨çš„ï¼Œä½†æ˜¯ç¯å¢ƒå˜é‡ `$HOME` ä»ç„¶æ˜¯ `/root`ã€‚æ‰€ä»¥åœ¨ `/root` ä¸­åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œè‡ªç„¶å°±æ²¡æœ‰æƒé™ã€‚\r\n\r\n### 3.2ã€v6.x ä¸­ npm script å®ç°æ–¹å¼çš„åŒºåˆ«\r\n\r\n> ä»¥ä¸‹ä»£ç æ¥è‡ª [npm/cli v6.14.8](https://github.com/npm/cli/tree/v6.14.8)\r\n\r\nv7.x ä¸ºäº†æƒé™å®‰å…¨ï¼Œåšäº†ä¸Šè¿°æ“ä½œï¼Œé‚£ä¹ˆ v6.x å¦‚ä½•å‘¢ï¼Ÿ\r\n\r\nv6.x çš„ npm script å…¥å£æ˜¯ [`lib/run-script.js` æ–‡ä»¶](https://github.com/npm/cli/blob/v6.14.8/lib/run-script.js#L173)ï¼š\r\n\r\n```js\r\nfunction run (pkg, wd, cmd, args, cb) {\r\n  // ...\r\n  chain(cmds.map(function (c) {\r\n    // pass cli arguments after -- to script.\r\n    if (pkg.scripts[c] && c === cmd) {\r\n      pkg.scripts[c] = pkg.scripts[c] + joinArgs(args)\r\n    }\r\n\r\n    // when running scripts explicitly, assume that they're trusted.\r\n    return [lifecycle, pkg, c, wd, { unsafePerm: true }]\r\n  }), cb)\r\n}\r\n```\r\n\r\nè€Œå…¶å®é™…æ‰§è¡Œåˆ™éœ€è¦ä» `lifecycle` æ–¹æ³•ä¸­æ¥æ‰¾ã€‚ä¸Šé¢è¿™æ®µä»£ç çš„æœ€åä¸€è¡Œè¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„å‚æ•° `{ unsafePerm: true }`ï¼Œä¹‹åä¼šç”¨åˆ°ã€‚\r\n\r\n[lifecycle](https://github.com/npm/cli/blob/v6.14.8/lib/utils/lifecycle.js#L13) æœ¬èº«ä»£ç å¹¶ä¸å¤æ‚ï¼Œä¸»è¦å°±æ˜¯å‚æ•°è°ƒæ•´ï¼Œç„¶åè°ƒç”¨å®é™…å‡½æ•°ã€‚å’Œ uidã€gid å®é™…çš„è®¾ç½®ä»£ç æ˜¯åœ¨ [`npm-lifecycle/index.js` ä¸­çš„ `runCmd`](https://github.com/npm/cli/blob/v6.14.8/node_modules/npm-lifecycle/index.js#L264-L276) é‡Œï¼š\r\n\r\n```js\r\nfunction runCmd (note, cmd, pkg, env, stage, wd, opts, cb) {\r\n  // ...\r\n  var unsafe = opts.unsafePerm\r\n  var user = unsafe ? null : opts.user\r\n  var group = unsafe ? null : opts.group\r\n  \r\n  // ...\r\n  if (unsafe) {\r\n    runCmd_(cmd, pkg, env, wd, opts, stage, unsafe, 0, 0, cb)\r\n  } else {\r\n    uidNumber(user, group, function (er, uid, gid) {\r\n      if (er) {\r\n        er.code = 'EUIDLOOKUP'\r\n        opts.log.resume()\r\n        process.nextTick(dequeue)\r\n        return cb(er)\r\n      }\r\n      runCmd_(cmd, pkg, env, wd, opts, stage, unsafe, uid, gid, cb)\r\n    })\r\n  }\r\n}\r\n\r\n// ...\r\nfunction runCmd_ (cmd, pkg, env, wd, opts, stage, unsafe, uid, gid, cb_) {\r\n  // ...\r\n  var proc = spawn(sh, args, conf, opts.log)\r\n  // ...\r\n}\r\n```\r\n\r\n`runCmd` é‡Œä¼šé€šè¿‡ä¼ å…¥çš„ `opt.unsafePem` å‚æ•°ï¼ˆå°±æ˜¯ä¸Šé¢è®¾ç½®çš„é‚£ä¸ª `{ unsafePerm: true }`ï¼‰æ¥åˆ¤æ–­æ˜¯å¦æ˜¯ `unsafe` çš„ã€‚å¦‚æœæ˜¯ `unsafe`ï¼Œåˆ™ä¼šåœ¨è°ƒç”¨ `runCmd_` æ—¶å°† uidã€gid è®¾ç½®ä¸º 0ã€‚0 å°±ä»£è¡¨ root ç”¨æˆ·å’Œ root ç”¨æˆ·ç»„ã€‚\r\n\r\nè€Œæœ€ç»ˆåœ¨ `runCmd_` ä¸­çš„ [`spawn`](https://github.com/npm/cli/blob/v6.14.8/node_modules/npm-lifecycle/lib/spawn.js#L36) å°±æ˜¯ `child_process` ä¸­çš„ `spawn` æ–¹æ³•ï¼š\r\n\r\n```js\r\nconst _spawn = require('child_process').spawn\r\n// ...\r\nfunction spawn (cmd, args, options, log) {\r\n  // ...\r\n  const raw = _spawn(cmd, args, options)\r\n  // ...\r\n}\r\n```\r\n\r\n---\r\n\r\nåˆ°è¿™é‡Œæˆ‘ä»¬å°±å®šä½åˆ°äº†è¯¥é—®é¢˜ï¼š\r\n\r\n- åœ¨ v6.x ä¸­ï¼Œåªè¦æ²¡æœ‰è®¾ç½® `unsafe-pem` è¿™ä¸ª npm configï¼Œnpm script å°±ä¼šåœ¨å¯åŠ¨å­è¿›ç¨‹æ—¶é»˜è®¤è®¾ç½®ä¸º rootã€‚\r\n- è€Œåœ¨ v7.x ä¸­ï¼Œå¦‚æœè¿è¡Œæ—¶æ˜¯ root ç”¨æˆ·ï¼Œåˆ™ä¼šæ ¹æ® cwd æ‰€å±çš„ç”¨æˆ·/ç”¨æˆ·ç»„ï¼Œæ¥è®¾ç½®å¯åŠ¨å­è¿›ç¨‹çš„ uid å’Œ gidã€‚\r\n\r\nç›®å‰ä»ä»£ç å®ç°æ¥çœ‹ï¼Œä¼¼ä¹æ²¡æœ‰ç‰¹åˆ«å¥½çš„å¤„ç†æ–¹å¼ï¼Œæ¯”è¾ƒç®€ç­”çš„ä¸¤ç§å°±æ˜¯ï¼š\r\n\r\n- å¦‚æœç”¨ v7.xï¼Œåœ¨æˆ‘ä»¬è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œå¯ä»¥æŠŠ `/home/web_server/project` æ‰€å±ç”¨æˆ·/ç”¨æˆ·ç»„æ”¹ä¸º rootã€‚ä½†æƒé™çš„æ”¹åŠ¨å¯èƒ½ä¼šå¼•å‘å…¶ä»–é—®é¢˜ã€‚\r\n- å…ˆæš‚æ—¶å›é€€åˆ° v6.xï¼Œä½¿ç¯å¢ƒå’Œä¿æŒä¸€è‡´ã€‚\r\n\r\n### 3.3ã€npm cli çš„å˜æ›´æ—¥å¿—\r\n\r\nå…¶å®ï¼Œè¿™ä¸ªå˜æ›´åœ¨ npm [v7.0.0-beta.0 å‘å¸ƒæ—¶çš„ CHANGELOG](https://github.com/npm/cli/blob/v7.11.1/CHANGELOG.md#all-lifecycle-scripts) é‡Œæ˜¯æœ‰æåˆ°çš„ã€‚ä¸è¿‡åªæœ‰å¯¥å¯¥ä¸€è¡Œï¼š\r\n\r\n> The user, group, uid, gid, and unsafe-perms configurations are no longer relevant. When npm is run as root, scripts are always run with the effective uid and gid of the working directory owner.\r\n\r\nå¤§è‡´è¯´çš„å°±æ˜¯å’±ä»¬ä¸Šé¢ä»ä»£ç åˆ†æçš„ç»“è®ºï¼šå¦‚æœæ˜¯ root è¿è¡Œ npmï¼Œåˆ™åœ¨è„šæœ¬æ‰§è¡Œæ—¶åˆ‡æ¢åˆ°å½“å‰å·¥ä½œç›®å½•çš„ ownerã€‚\r\n\r\nç„¶åå¦‚æœä½ è·Ÿç€ä»£ç çœ‹ä¸‹æ¥ï¼Œä¹Ÿä¼šå‘ç° v6.x ä¸­çš„ `unsafe-pem` é…ç½®ï¼Œåœ¨ v7.0.0 å¼€å§‹å°±è¢«åºŸå¼ƒäº†ã€‚ä¸è¿‡ npm cli æ–‡æ¡£æ›´æ–°çš„è¾ƒæ…¢ï¼Œç›´åˆ° v7.0.0 æ­£å¼ç‰ˆå‘å¸ƒåçš„ä¸€ä¸ªæœˆåï¼Œæ‰åœ¨ [v7.0.15 çš„ Release](https://github.com/npm/cli/blob/v7.11.1/CHANGELOG.md#documentation-16) é‡ŒæŠŠ `unsafe-pem` ä»æ–‡æ¡£ä¸­ç§»é™¤ã€‚\r\n\r\n### 3.4ã€å…¶ä»–å¯èƒ½å‡ºç°çš„é—®é¢˜\r\n\r\nè¿™ä¸ªåŠŸèƒ½å®ç°çš„å˜æ›´ï¼Œé™¤äº†ä¼šå¯¼è‡´ä¸€äº›æ–‡ä»¶æ“ä½œæ—¶çš„æƒé™é—®é¢˜ï¼Œè¿˜ä¼šæœ‰ä¸€äº›å…¶ä»–åœºæ™¯çš„æƒé™é”™è¯¯ã€‚ä¾‹å¦‚åœ¨å¦‚æœä½ ç”¨ npm script å¯åŠ¨ä¸€ä¸ª nodejs serverï¼Œè¦ç»‘å®š 443 ç«¯å£ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½å°±ä¼šæŠ¥é”™ã€‚å› ä¸ºä¼šéœ€è¦ root æƒé™æ¥æ‰§è¡Œè¿™ä¸ªç«¯å£ç»‘å®šã€‚åœ¨ [issue é‡Œå°±æœ‰äººæåˆ°äº†è¿™ä¸ªæƒ…å†µ](https://github.com/npm/cli/issues/3110)ã€‚\r\n\r\n---\r\n\r\n## 4ã€åŠ é¤ï¼šchild_process#spawn æ˜¯å¦‚ä½•è®¾ç½® user å’Œ group çš„ï¼Ÿ\r\n\r\né€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œé—®é¢˜å·²ç»è¢«è§£å†³äº†ã€‚æ²¿ç€è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å…·ä½“çœ‹äº†ä¸‹ Nodejs ä¸­ï¼Œchild_process æ¨¡å—çš„ `spawn` æ–¹æ³•æ˜¯å¦‚ä½•è®¾ç½® user å’Œ group çš„ã€‚\r\n\r\n> ä»¥ä¸‹ä»£ç åŸºäº [Nodejs v14.16.1](https://github.com/nodejs/node/tree/v14.16.1)ã€‚åªå…³æ³¨ unix å®ç°ã€‚\r\n\r\nNodejs ä¸­ï¼Œæˆ‘ä»¬åœ¨ä¸Šå±‚å¼•å…¥çš„æ¨¡å—ï¼Œæ˜¯ç›´æ¥æ”¾åœ¨ `lib` ä¸‹é¢çš„ï¼Œè€Œå…¶ä¸€èˆ¬ä¼šåœ¨è°ƒç”¨ `lib/internal` ä¸‹çš„å¯¹åº”æ¨¡å—ï¼Œè¿™éƒ¨åˆ†ä¼šç›´æ¥ä½¿ç”¨ internalBinding æ¥è°ƒç”¨ C++ å¯¹è±¡å’Œæ–¹æ³•ã€‚child_process ä¹Ÿä¸ä¾‹å¤–ï¼Œä½ ä¼šåœ¨ [`lib/internal/child_process.js`](https://github.com/nodejs/node/blob/v14.16.1/lib/internal/child_process.js#L378) ä¸­çœ‹åˆ°å¦‚ä¸‹ä»£ç ï¼š\r\n\r\n```js\r\nChildProcess.prototype.spawn = function(options) {\r\n  // ...\r\n  const err = this._handle.spawn(options);\r\n  // ...\r\n```\r\n\r\nå› ä¸ºæ¯”è¾ƒç®€ç­”ï¼Œæ‰€ä»¥è¿™é‡Œçœå»äº† `lib/child_process.js` ä¸­çš„æ–¹æ³•ã€‚åªè¦çŸ¥é“ï¼Œæˆ‘ä»¬åœ¨ JavaScript å±‚ä½¿ç”¨ `spawn` æ–¹æ³•æ—¶ï¼Œæœ€åä¼šè°ƒç”¨åˆ° ChildProcess å®ä¾‹çš„ `spawn` æ–¹æ³•å³å¯ã€‚å¯ä»¥çœ‹åˆ°æœ€åæ˜¯è°ƒç”¨äº† `this._handle.spawn`ã€‚é‚£ä¹ˆ `this._handle` æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\r\n\r\nå®ƒå…¶å®å°±æ˜¯[é€šè¿‡ binding åˆ›å»ºçš„ Process å¯¹è±¡](https://github.com/nodejs/node/blob/v14.16.1/lib/internal/child_process.js#L250)ï¼š\r\n\r\n```js\r\nconst { Process } = internalBinding('process_wrap');\r\n\r\n// ...\r\nfunction ChildProcess() {\r\n  EventEmitter.call(this);\r\n\r\n  // ...\r\n  this._handle = new Process();\r\n  // ...\r\n}\r\n```\r\n\r\nè¿™ä¸ª binding çš„è®¾ç½®åœ¨ [`src/process_wrap.cc`](https://github.com/nodejs/node/blob/v14.16.1/src/process_wrap.cc#L157-L174) ä¸­ï¼Œ\r\n\r\n```c++\r\n  static void Spawn(const FunctionCallbackInfo<Value>& args) {\r\n    // ...\r\n\r\n    // options.uid\r\n    Local<Value> uid_v =\r\n        js_options->Get(context, env->uid_string()).ToLocalChecked();\r\n    if (!uid_v->IsUndefined() && !uid_v->IsNull()) {\r\n      CHECK(uid_v->IsInt32());\r\n      const int32_t uid = uid_v.As<Int32>()->Value();\r\n      options.flags |= UV_PROCESS_SETUID;\r\n      options.uid = static_cast<uv_uid_t>(uid);\r\n    }\r\n\r\n    // options.gid\r\n    Local<Value> gid_v =\r\n        js_options->Get(context, env->gid_string()).ToLocalChecked();\r\n    if (!gid_v->IsUndefined() && !gid_v->IsNull()) {\r\n      CHECK(gid_v->IsInt32());\r\n      const int32_t gid = gid_v.As<Int32>()->Value();\r\n      options.flags |= UV_PROCESS_SETGID;\r\n      options.gid = static_cast<uv_gid_t>(gid);\r\n    }\r\n    \r\n    int err = uv_spawn(env->event_loop(), &wrap->process_, &options);\r\n    wrap->MarkAsInitialized();\r\n    \r\n    // ...\r\n}\r\n```\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œå®ƒæŠŠä» JavaScript å±‚è®¾ç½®çš„ uid å’Œ gid è®¾ç½®åˆ° options ä¸Šï¼Œç„¶åè°ƒç”¨äº† [`uv_spawn`](https://docs.libuv.org/en/latest/process.html?highlight=uv_spawn#c.uv_spawn) å‡½æ•°åˆ›å»ºå­è¿›ç¨‹ã€‚åœ¨ `uv_spawn` ä¸­å¯¹äºåˆ›å»ºçš„å­è¿›ç¨‹ä¼šé€šè¿‡ [`uv__process_child_init` æ¥åšåˆå§‹åŒ–è®¾ç½®](https://github.com/nodejs/node/blob/v14.16.1/deps/uv/src/unix/process.c#L408)ï¼š\r\n\r\n```c++\r\nint uv_spawn(uv_loop_t* loop,\r\n             uv_process_t* process,\r\n             const uv_process_options_t* options) {\r\n\r\n    // ...\r\n    if (pid == 0) {\r\n        uv__process_child_init(options, stdio_count, pipes, signal_pipe[1]);\r\n        abort();\r\n    }\r\n    // ...\r\n}\r\n```\r\n\r\næœ€ååˆ™æ˜¯åœ¨ [`uv__process_child_init`](https://github.com/nodejs/node/blob/v14.16.1/deps/uv/src/unix/process.c#L346-L365) é‡Œé€šè¿‡ [`setuid`](https://man7.org/linux/man-pages/man2/setuid.2.html) å’Œ [`setgid`](https://man7.org/linux/man-pages/man2/setgid.2.html) è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨æ¥å®ç°çš„ï¼š\r\n\r\n```c++\r\nstatic void uv__process_child_init(const uv_process_options_t* options,\r\n                                   int stdio_count,\r\n                                   int (*pipes)[2],\r\n                                   int error_fd) {\r\n    // ...\r\n    if ((options->flags & UV_PROCESS_SETGID) && setgid(options->gid)) {\r\n        uv__write_int(error_fd, UV__ERR(errno));\r\n        _exit(127);\r\n    }\r\n\r\n    if ((options->flags & UV_PROCESS_SETUID) && setuid(options->uid)) {\r\n        uv__write_int(error_fd, UV__ERR(errno));\r\n        _exit(127);\r\n    }\r\n    // ...\r\n}\r\n```\r\n\r\nåœ¨ Nodejs å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿæœ‰ä»‹ç»ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116818837-fac07a00-ab9f-11eb-8abf-81c61edf69d3.png)\r\n\r\næˆ‘ä»¬é€šè¿‡é˜…è¯»ä»£ç ä¹Ÿå°è¯äº†è¿™ä¸€ç‚¹ã€‚\r\n\r\nå®Œã€‚\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/47","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/47/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/47/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/47/events","html_url":"https://github.com/alienzhou/blog/issues/47","id":868421126,"node_id":"MDU6SXNzdWU4Njg0MjExMjY=","number":47,"title":"è®°ä¸€æ¬¡ Node gRPC é™æ€ç”Ÿæˆæ–‡ä»¶å¼•å‘çš„é—®é¢˜","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":2045616625,"node_id":"MDU6TGFiZWwyMDQ1NjE2NjI1","url":"https://api.github.com/repos/alienzhou/blog/labels/Node.js","name":"Node.js","color":"c3ea81","default":false,"description":""},{"id":1159855196,"node_id":"MDU6TGFiZWwxMTU5ODU1MTk2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E6%9C%8D%E5%8A%A1%E7%AB%AF","name":"æœåŠ¡ç«¯","color":"0bbaae","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-04-27T03:34:51Z","updated_at":"2021-04-27T07:05:08Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"![image](https://user-images.githubusercontent.com/9822789/116182463-e2d79900-a74e-11eb-892f-09e7c4687069.png)\r\n\r\næœ¬æ–‡è®°å½•äº†ä½¿ç”¨ Node gRPCï¼ˆstatic codegen æ–¹å¼ï¼‰æ—¶ï¼Œé‡åˆ°çš„ä¸€ä¸ªâ€œå¥‡æ€ªâ€çš„å‘ã€‚è™½ç„¶é—®é¢˜æœ¬èº«å¹¶ä¸å¸¸è§ï¼Œä½†é¡ºç€é—®é¢˜æ’æŸ¥å‘ç°å…¶ä¸­æ¶‰åŠåˆ°äº†ä¸€äº›æœ‰æ„æ€çš„ç‚¹ã€‚å»æ²¿ç€é—®é¢˜è¿½æ ¹ç©¶åº•ã€å¢é•¿ç»éªŒæ˜¯ä¸€ç§ä¸é”™çš„å­¦ä¹ æ–¹å¼ã€‚æ‰€ä»¥æˆ‘æŠŠè¿™æ¬¡æ’æŸ¥çš„è¿‡ç¨‹ä»¥åŠæ¶‰åŠåˆ°çš„ç‚¹è®°å½•äº†ä¸‹æ¥ã€‚\r\n\r\n> ä¸ºäº†è®©å¤§å®¶åœ¨é˜…è¯»æ—¶æœ‰æ›´å¥½çš„ä½“éªŒï¼Œæˆ‘å‡†å¤‡äº†ä¸€ä¸ª [demo](https://github.com/alienzhou/grpc-static-pollute-demo) æ¥è¿˜åŸè¯¥é—®é¢˜ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ clone ä¸‹æ¥ï¼Œé…åˆæ–‡ç« ä¸€èµ·â€œé£Ÿç”¨â€ã€‚\r\n\r\n## 1ã€åœºæ™¯è¿˜åŸ\r\n\r\nå¦‚æœåœ¨ä½ äº†è§£è¿‡æˆ–åœ¨ NodeJS ä¸­ä½¿ç”¨è¿‡ gRPCï¼Œé‚£ä¹ˆä¸€å®šä¼šçŸ¥é“å®ƒæœ‰ä¸¤ç§ä½¿ç”¨æ¨¡å¼ â€”â€”ã€ŒåŠ¨æ€ä»£ç ç”Ÿæˆã€ï¼ˆdynamic codegenï¼‰å’Œã€Œé™æ€ä»£ç ç”Ÿæˆã€ï¼ˆstatic codegenï¼‰ã€‚\r\n\r\n> è¿™é‡Œç®€å•è§£é‡Šä¸‹ï¼ˆå¯¹ gRPC æœ‰äº†è§£çš„å°ä¼™ä¼´å¯ä»¥ç›´æ¥è·³è¿‡è¿™æ®µï¼‰ã€‚RPC æ¡†æ¶ä¸€èˆ¬éƒ½ä¼šé€‰æ‹©ä¸€ç§ IDLï¼Œè€Œ gRPC é»˜è®¤ä½¿ç”¨çš„å°±æ˜¯ [protocol bufffers](https://developers.google.com/protocol-buffers)ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå«è¯¥æ–‡ä»¶ PB æˆ– proto æ–‡ä»¶ã€‚æ ¹æ® PB æ–‡ä»¶å¯ä»¥è‡ªåŠ¨ç”Ÿæˆåºåˆ—åŒ–/ååºåˆ—åŒ–ä»£ç ï¼ˆ_xxx_pb.js_ï¼‰ï¼Œç”¨äº gRPC æ—¶è¿˜ä¼šç”Ÿæˆé€‚é… gRPC çš„ä»£ç ï¼ˆ_xxx_grpc_pb.js_`ï¼‰ã€‚å¦‚æœåœ¨ Nodejs è¿›ç¨‹å¯åŠ¨åï¼Œå† load PB æ–‡ä»¶ç”Ÿæˆå¯¹åº”æ–¹æ³•ï¼Œå«åšã€ŒåŠ¨æ€ä»£ç ç”Ÿæˆã€ï¼›è€Œå…ˆç”¨å·¥å…·ç”Ÿæˆå‡ºå¯¹åº”çš„ js æ–‡ä»¶ï¼Œè¿è¡Œæ—¶ç›´æ¥ require ç”Ÿæˆçš„ js åˆ™å«ä½œã€Œé™æ€ä»£ç ç”Ÿæˆã€ã€‚å¯ä»¥å‚è§ gRPC å®˜æ–¹åº“ä¸­æä¾›çš„[ç¤ºä¾‹](https://github.com/grpc/grpc/tree/master/examples/node)ã€‚\r\n\r\næˆ‘ä»¬çš„é¡¹ç›®ä½¿ç”¨äº†å…¬å¸å†…éƒ¨çš„è§£å¯†ç»„ä»¶åŒ…ï¼ˆä¹Ÿæ˜¯æˆ‘ä»¬ç»´æŠ¤çš„ï¼‰ï¼Œå« keycenterã€‚è§£å¯†ç»„ä»¶ä¸­éœ€è¦ç”¨åˆ° gRPC è¯·æ±‚ï¼Œå¹¶ä¸”å®ƒä½¿ç”¨äº†ã€Œé™æ€ä»£ç ç”Ÿæˆã€è¿™ç§æ¨¡å¼ã€‚\r\n\r\nä¹‹å‰é¡¹ç›®ä¸€ç›´éƒ½æ­£å¸¸è¿è¡Œã€‚ç›´åˆ°æœ‰ä¸€å¤©å¼•å…¥äº† redis ç»„ä»¶æ¥å®ç°ç¼“å­˜åŠŸèƒ½ã€‚åœ¨æ»¡å¿ƒæ¬¢å–œåœ°åŠ å®Œä»£ç è¿è¡Œåï¼Œæ§åˆ¶å°æŠ¥å‡ºäº†å¦‚ä¸‹é”™è¯¯ä¿¡æ¯ï¼š\r\n\r\n```bash\r\nError: 13 INTERNAL: Request message serialization failure: Expected argument of type keycenter.SecretData\r\n    at Object.callErrorFromStatus (/Users/xxxx/server/node_modules/@infra-node/grpc-js/build/src/call.js:31:26)\r\n    at Object.onReceiveStatus (/Users/xxxx/server/node_modules/@infra-node/grpc-js/build/src/client.js:176:52)\r\n    at Object.onReceiveStatus (/Users/xxxx/server/node_modules/@infra-node/grpc-js/build/src/client-interceptors.js:342:141)\r\n    at Object.onReceiveStatus (/Users/xxxx/server/node_modules/@infra-node/grpc-js/build/src/client-interceptors.js:305:181)\r\n    at /Users/zhouhongxuan/programming/xxxx/server/node_modules/@infra-node/grpc-js/build/src/call-stream.js:124:78\r\n    at processTicksAndRejections (internal/process/task_queues.js:75:11)\r\n```\r\n\r\nè€Œè¿™ä¸ª redis ç»„ä»¶ç¡®å®é—´æ¥ä¾èµ–äº† gRPCã€‚è¿™é‡Œæ”¾ä¸€ä¸ªç»„ä»¶æ¨¡å—ä¾èµ–å…³ç³»ï¼Œè¯´æ˜ä¸€ä¸‹é¡¹ç›®ä½¿ç”¨çš„å„ç»„ä»¶åŒ…ä¹‹é—´çš„å…³ç³»ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116182094-4ad9af80-a74e-11eb-8ed3-50d848392c04.png)\r\n\r\nå…¶ä¸­æ¯ä¸ªé»„è‰²ç»„ä»¶å°±æ˜¯ä¸€å•ç‹¬çš„ npm åŒ…ã€‚ä¸šåŠ¡ä»£ç ç›´æ¥ä½¿ç”¨äº† keycenter åŒ…è¿›è¡Œäº†ç§˜é’¥çš„è§£å¯†ï¼›åŒæ—¶å¼•å…¥äº† redis ç¼“å­˜ç»„ä»¶ï¼Œè€Œç¼“å­˜æ¨¡å—é—´æ¥ä¾èµ–äº† keycenterã€‚æœ€ç»ˆ keycenter ç»„ä»¶é€šè¿‡ã€Œé™æ€ä»£ç ç”Ÿæˆã€çš„æ–¹å¼ä½¿ç”¨ gRPCã€‚\r\n\r\nä¸‹é¢æˆ‘ä»¬å°±æ¥ä¸€èµ·çœ‹çœ‹è¿™ä¸ªé—®é¢˜ã€‚\r\n\r\n## 2ã€é—®é¢˜æ’æŸ¥\r\n\r\n>â—ï¸ ä»¥ä¸‹çš„ç« èŠ‚é¡ºåºå¹¶éæ˜¯æ’æŸ¥æ—¶çš„å®é™…é¡ºåºã€‚å¤§å®¶å®é™…æ’æŸ¥é—®é¢˜æ—¶ï¼Œè¿˜æ˜¯å»ºè®®å…ˆçœ‹â€œæœ€è¿‘çš„ç°åœºâ€ã€‚ ğŸ‘€  ä¾‹å¦‚è¿™ä¸ªé—®é¢˜ï¼Œå°±ä¼šé¦–å…ˆå» `Request message serialization failure` æŠ›é”™çš„åœ°æ–¹æŸ¥çœ‹æƒ…å†µã€‚åŒæ—¶å†è¾…ä»¥ä¸Šå±‚ï¼ˆå¤–å±‚ï¼‰é€»è¾‘çš„æ’æŸ¥ï¼Œä¸¤å¤´å¤¹é€¼æ‰¾åˆ°çœŸç›¸ã€‚ä½†ä¸ºäº†è®©æ–‡ç« é˜…è¯»èµ·æ¥æ›´é¡ºç•…ï¼Œèƒ½å¤Ÿæœ‰ä»é—®é¢˜è¡¨è±¡ä¸€æ­¥æ­¥èµ°è¿‘çœŸç›¸ï¼Œæ‰€ä»¥é€‰æ‹©äº†ç›®å‰çš„æ–‡ç« ç»“æ„ã€‚æˆ‘ä¼šå°è¯•å»å°½é‡ä¿ç•™å®é™…çš„æ’æŸ¥è·¯å¾„ã€‚\r\n\r\n### 2.1ã€è«éæ˜¯ redis ç»„ä»¶å†…éƒ¨é€»è¾‘å‡ºé”™äº†ï¼Ÿ\r\n\r\næœ€ç›´æ¥çš„æƒ³æ³•å°±æ˜¯ï¼šæ–°å¼•å…¥çš„è¿™ä¸ª redis ç»„ä»¶æœ‰é—®é¢˜ã€‚å› ä¸ºå‡ºç°é—®é¢˜çš„ç¬¬ä¸€æ—¶é—´ï¼Œæˆ‘å°±æŠŠé¡¹ç›®é‡Œä¸‹é¢è¿™è¡Œä»£ç æ³¨é‡Šæ‰äº†ï¼š\r\n\r\n```diff\r\n- this.redis = new Redis(redisConfig);\r\n+ // this.redis = new Redis(redisConfig);\r\n```\r\n\r\næ³¨é‡Šå®Œæœç„¶å°±å¥½äº†ã€‚æ‰€ä»¥å¼•å…¥æ–°ç»„ä»¶ç¡®å®å¯¼è‡´äº†é—®é¢˜ã€‚\r\n\r\nç”±äºæŠ¥é”™å’Œ gRPC æœ‰å…³ï¼Œè€Œ redis å†…éƒ¨ä¹Ÿé—´æ¥ä¾èµ–åˆ°äº† gRPCï¼ˆå› ä¸ºé—´æ¥ä¾èµ–äº† keycenterï¼‰ï¼Œé‚£ä¹ˆæˆ‘çš„ç¬¬ä¸€ååº”å°±æ˜¯ï¼Œè¿™ä¸ªç»„ä»¶å†…éƒ¨é€»è¾‘å¯èƒ½æœ‰é—®é¢˜ã€‚ä¹Ÿè®¸æ˜¯å“ªæ­¥æ“ä½œä½¿ç”¨åˆ°äº† keycenter æ–¹æ³•ï¼Œç„¶åæŠ¥å‡ºäº†é”™è¯¯ã€‚\r\n\r\nä½†è¿™ä¸ªæƒ³æ³•å‡ºç°çš„æœ‰å¤šå¿«ï¼Œæ’é™¤çš„å°±æœ‰å¤šå¿«ã€‚\r\n\r\né€šè¿‡æ·»åŠ æ–­ç‚¹ã€æ—¥å¿—çš„æ–¹å¼ï¼Œå¾ˆå¿«å°±å¾—å‡ºäº†ä¸€ä¸ªç»“è®ºï¼šredis ç»„ä»¶è™½ç„¶ä¾èµ–åˆ°äº† keycenterï¼Œä½†æ˜¯æ•´ä¸ªå®ä¾‹åŒ–è¿‡ç¨‹ä¸­å®Œå…¨ä¸ä¼šè°ƒç”¨å®ƒçš„æ–¹æ³•ï¼Œæ—¢ç„¶æ²¡æœ‰è°ƒç”¨ï¼Œè¿™ä¸ª gRPC çš„é”™è¯¯è‡ªç„¶ä¸æ˜¯å®ƒç›´æ¥å¯¼è‡´çš„ã€‚\r\n\r\nä½†å®ƒå’Œ redis ç»„ä»¶æˆ–å¤šæˆ–å°‘è„±ä¸äº†å…³ç³»ã€‚\r\n\r\n### 2.2ã€æ˜¯å¦çœŸçš„æ˜¯ redis å®ä¾‹åŒ–å¯¼è‡´äº†æŠ¥é”™ï¼Ÿ\r\n\r\nä¸Šé¢æˆ‘é€šè¿‡æ³¨é‡Šæ‰ Redis å®ä¾‹åŒ–çš„ä»£ç è¡Œåè¿è¡Œæ­£å¸¸ï¼Œåˆæ­¥åˆ¤æ–­æ˜¯å®ä¾‹åŒ–å¯¼è‡´çš„é—®é¢˜ã€‚ç„¶è€Œæˆ‘å¿½ç•¥äº†é‡è¦çš„ä¸€ç‚¹ï¼Œtypescript ç¼–è¯‘æ—¶ï¼Œå¯¹äº import ä½†æ˜¯æ²¡æœ‰ä½¿ç”¨çš„æ¨¡å—ï¼Œåœ¨äº§å‡ºçš„ä»£ç é‡Œæ˜¯ä¼šæŠŠæ¨¡å—å¼•å…¥çš„è¿™æ®µåˆ é™¤çš„ã€‚\r\n\r\nä¾‹å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼Œå¯¼å…¥çš„æ¨¡å—å®é™…æ²¡æœ‰ä½¿ç”¨ï¼Œ[åœ¨ç¼–è¯‘äº§å‡ºçš„ä»£ç ä¸­å°±ä¸ä¼šå¯¼å…¥è¯¥æ¨¡å—](https://www.typescriptlang.org/play?module=1#code/JYWwDg9gTgLgBAJQKYBNgGc4DMoRHAcgAFgA7HAQwFpSIUkB6KVDAgbgCgkAPSWOelgoBXADbwAjGyA)ï¼š\r\n\r\n```typescript\r\nimport Redis from '@infra-node/redis';\r\nexport default 1;\r\n```\r\n\r\nè€Œå¦‚æœæ˜¯[è¿™æ ·](https://www.typescriptlang.org/play?module=1#code/JYWwDg9gTgLgBAJQKYBNgGc4DMoRHAcgAFgA7HAQwFpSIUkB6KVDAgbgChk102g)\r\n\r\n```typescript\r\nimport Redis from '@infra-node/redis';\r\nRedis;\r\n```\r\n\r\næˆ–è€…[è¿™æ ·](https://www.typescriptlang.org/play?module=1#code/JYWwDg9gTgLgBAcgALAHYDMoEMC0qIAmApgPRREHADOCA3EA)\r\n\r\n```typescript\r\nimport '@infra-node/redis';\r\n```\r\n\r\nåˆ™æ¨¡å—å¼•å…¥çš„ä»£ç  `require(@infra-node/redis)` åœ¨äº§å‡ºä¸­ä¼šè¢«ä¿ç•™ã€‚å› æ­¤ï¼Œå®ä¾‹åŒ–æ“ä½œå¾ˆå¯èƒ½å¹¶ä¸æ˜¯å¯¼è‡´é—®é¢˜çš„åŸå› ã€‚\r\n\r\né€šè¿‡è¿›ä¸€æ­¥æµ‹è¯•ï¼Œå‘ç°ç›´æ¥åŸå› æ˜¯å¼•å…¥äº† `@infra-node/redis` æ¨¡å—ã€‚å¯¼å…¥æ¨¡å—å°±ä¼šå¯¼è‡´é—®é¢˜ï¼Œåªè¦ä¸å¯¼å…¥å°±æ²¡äº‹å„¿ï¼Œæˆ‘ç¬¬ä¸€æ—¶é—´çš„ç›´è§‰æœ‰ä¸¤ä¸ªï¼š\r\n\r\n- å‰¯ä½œç”¨\r\n- ä¾èµ–å…³ç³»\r\n\r\n---\r\n\r\nåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆå›åˆ°æœ€åˆçš„é—®é¢˜ã€‚\r\n\r\n### 2.3ã€`new A instanceof A === false`?\r\n\r\nè¿˜è®°å¾—æœ€åˆçš„é—®é¢˜ä¹ˆï¼Ÿé—®é¢˜çš„æŠ›é”™ `Error: 13 INTERNAL: Request message serialization failure: Expected argument of type XXX` æ¥è‡ªäº [grpc-tools ç”Ÿæˆ](https://github.com/grpc/grpc-node/blob/grpc%401.24.x/packages/grpc-tools/src/node_generator.cc#L132-L135)çš„ Nodejs ç‰ˆ _xxx_grpc_pb.js_ ä»£ç ï¼š\r\n\r\n```JavaScript\r\nfunction serialize_keycenter_SecretData(arg) {\r\n  if (!(arg instanceof keycenter_pb.SecretData)) {\r\n    throw new Error('Expected argument of type keycenter.SecretData');\r\n  }\r\n  return Buffer.from(arg.serializeBinary());\r\n}\r\n```\r\n\r\n`serialize_keycenter_SecretData` æ˜¯ç”¨äºåœ¨è¯·æ±‚æ—¶å°† `SecretData` å®ä¾‹åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶æ•°æ®çš„æ–¹æ³•ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ–¹æ³•é‡Œä¼šåˆ¤æ–­ `arg` æ˜¯å¦æ˜¯ `keycenter_pb.SecretData` çš„å®ä¾‹ã€‚\r\n\r\nåœ¨æˆ‘ä»¬é¡¹ç›®çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬äº‹å…ˆä¼šå¾—åˆ°äº† pb å¯¹è±¡äºŒè¿›åˆ¶çš„ base64 ç¼–ç å€¼ï¼Œæ‰€ä»¥åœ¨ä»£ç ä¸­ä¼šä½¿ç”¨ _xxx_pb.js_ æ–‡ä»¶æä¾›çš„ååºåˆ—åŒ–ç”Ÿæˆ `SecretData` çš„å®ä¾‹ï¼Œå¹¶è®¾ç½®å…¶ä»–å±æ€§ã€‚\r\n\r\n```typescript\r\nimport { SecretData } from '../gen/keycenter_pb';\r\n// ...\r\n\r\n// ååºåˆ—åŒ–äºŒè¿›åˆ¶\r\nconst secretData = SecretData.deserializeBinary(Buffer.from(base64, 'base64'));\r\nsecretData.setKeyName(keyName);\r\n\r\nkeyCenter.decrypt(secretData, metadata, (err, res) => {\r\n    // ...\r\n});\r\n```\r\n\r\nå¹¶ä¸”è¿™é‡Œæˆ‘æ‰“å° `arg` åï¼Œåœ¨æ§åˆ¶å°çœ‹èµ·æ¥å®ƒçš„å€¼ä¹Ÿå¾ˆæ­£å¸¸ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116182179-6775e780-a74e-11eb-8f94-87b3fbf3a26f.png)\r\n\r\n`SecretData.deserializeBinary` çš„æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š\r\n\r\n```typescript\r\nproto.keycenter.SecretData.deserializeBinary = function(bytes) {\r\n  var reader = new jspb.BinaryReader(bytes);\r\n  var msg = new proto.keycenter.SecretData;\r\n  return proto.keycenter.SecretData.deserializeBinaryFromReader(msg, reader);\r\n};\r\n\r\nproto.keycenter.SecretData.deserializeBinaryFromReader = function(msg, reader) {\r\n  while (reader.nextField()) {\r\n    if (reader.isEndGroup()) {\r\n      break;\r\n    }\r\n    var field = reader.getFieldNumber();\r\n    switch (field) {\r\n    case 1:\r\n      var value = /** @type {string} */ (reader.readString());\r\n      msg.setKeyName(value);\r\n      break;\r\n    case 2:\r\n      ...\r\n    }\r\n  }\r\n  return msg;\r\n};\r\n```\r\n\r\nä» `var msg = new proto.keycenter.SecretData;` çœ‹èµ·å…¶å°±æ˜¯é€šè¿‡ `SecretData` æ„é€ å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶ä¼ å…¥ `.deserializeBinaryFromReader` æ–¹æ³•ä¸­è¿›è¡Œèµ‹å€¼ï¼Œæœ€åè¿”å›è¯¥å®ä¾‹ã€‚\r\n\r\næ‰€ä»¥ç›®å‰ä»è¿™ä¸ªé”™è¯¯çœ‹èµ·æ¥ï¼Œåƒæ˜¯ä¸€ä¸ª `new A instanceof A === false` çš„ä¼ªå‘½é¢˜ã€‚ä½†æ˜¾ç„¶å¹¶ä¸å¯èƒ½ã€‚æ‰€ä»¥æˆ‘çš„åˆ¤æ–­æ˜¯ï¼Œè¿™é‡Œé¢ä¸€å®šæœ‰ä¸€ä¸ªâ€œæé¬¼â€ â€”â€” æœ‰ä¸€ä¸ªçœ‹èµ·æ¥åƒæ˜¯ `SecretData` ä½†å®é™…ä¸æ˜¯çš„å®¶ä¼™å†’å……äº†å®ƒã€‚\r\n\r\nå¬èµ·æ¥ä¼¼ä¹å¾ˆå¥‡æ€ªã€‚åªèƒ½æ£ç€æ€§å­ç»§ç»­æ’æŸ¥ã€‚\r\n\r\n### 2.4ã€â€œå¥‡æ€ªâ€çš„ä¾èµ–å®‰è£…ï¼Ÿ\r\n\r\né¦–å…ˆå›é¡¾ä¸€ä¸‹ä¸Šé¢åˆ—å‡ºçš„åŒ…/æ¨¡å—ä¾èµ–å…³ç³»ï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116182094-4ad9af80-a74e-11eb-8ed3-50d848392c04.png)\r\n\r\næˆ‘çŸäº†ä¸‹ç›®å‰å®é™…çš„åŒ…å®‰è£…æƒ…å†µã€‚å¤§è‡´å¦‚ä¸‹ï¼ˆçœç•¥äº†ä¸€äº›æ— å…³çš„åŒ…ä¿¡æ¯ï¼‰ï¼š\r\n\r\n```\r\n.\r\nâ”œâ”€â”€ grpc-js\r\nâ”‚   ...\r\nâ”œâ”€â”€ keycenter\r\nâ””â”€â”€ redis\r\n    â”œâ”€â”€ Changelog.md\r\n    â”œâ”€â”€ LICENSE\r\n    â”œâ”€â”€ README.md\r\n    â”œâ”€â”€ built\r\n    â”œâ”€â”€ node_modules\r\n    â”‚Â Â  â”œâ”€â”€ @infra-node\r\n    â”‚   â”‚   â”‚ ...\r\n    â”‚Â Â  â”‚Â Â  â””â”€â”€ keycenter\r\n    â”‚Â Â  â”œâ”€â”€ chokidar\r\n    â”‚Â Â  â”œâ”€â”€ debug\r\n    â”‚Â Â  â”œâ”€â”€ p-map\r\n    â”‚Â Â  â””â”€â”€ readdirp\r\n    â””â”€â”€ package.json\r\n```\r\n\r\nä¸Šé¢åˆ—å‡ºäº†ç›®å‰é¡¹ç›®ä¸­çš„åŒ…å®‰è£…æƒ…å†µã€‚å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼šå¤–å±‚å­˜åœ¨ä¸€ä¸ª keycenter åŒ…ï¼ŒåŒæ—¶åœ¨ redis å†…éƒ¨ä¹Ÿå®‰è£…äº†ä¸€ä¸ª keycenter åŒ…ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ\r\n\r\nåŸå› å¾ˆç®€å•ï¼šé¡¹ç›®ç›´æ¥ä¾èµ–çš„ keycenter ç‰ˆæœ¬å£°æ˜ä¸ redis ä¸­çš„ä¾èµ–ç‰ˆæœ¬æ— æ³•åˆå¹¶æŒ‡å‘åŒä¸€ç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¼šåœ¨ä¸¤ä¸ªåœ°æ–¹åˆ†åˆ«å®‰è£…ã€‚è¿™æ˜¯ npm çš„æ­£å¸¸æœºåˆ¶ã€‚ä¸€èˆ¬è¿™ç§æƒ…å†µä¹Ÿå¹¶ä¸ä¼šå‡ºç°é—®é¢˜ã€‚\r\n\r\nä½†å½“æˆ‘æ‰‹åŠ¨åˆ é™¤äº† redis ä¸­çš„ keycenter åï¼Œé¡¹ç›®åˆå¯ä»¥æ­£å¸¸è¿è¡Œäº†ã€‚çœ‹æ¥â€œæé¬¼â€å°±æ˜¯è¿™å„¿äº†ã€‚\r\n\r\n### 2.5ã€è«éå¼•ç”¨äº†é”™è¯¯çš„æ¨¡å—æ–‡ä»¶ï¼Ÿ\r\n\r\nç»“åˆä¸Šé¢çš„æƒ…å†µï¼Œå¯¹äº `new A instanceof A === false` çš„é—®é¢˜ï¼ŒåŸºæœ¬å¯ä»¥è®¤å®šä¸ºæ˜¯ `new A' instanceof A === false`ï¼ˆæ³¨æ„é‡Œé¢çš„ A å’Œ A'ï¼‰ã€‚ä¹Ÿå°±æ˜¯åœ¨\r\n\r\n```JavaScript\r\nfunction serialize_keycenter_SecretData(arg) {\r\n  if (!(arg instanceof keycenter_pb.SecretData)) {\r\n    throw new Error('Expected argument of type keycenter.SecretData');\r\n  }\r\n  return Buffer.from(arg.serializeBinary());\r\n}\r\n```\r\n\r\nè¿™ä¸ªæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œä¼ å…¥çš„ `arg` çš„æ„é€ å‡½æ•°ä¸æ–¹æ³•ä¸­çš„ `keycenter_pb.SecretData` å®é™…ä¸åŒã€‚è¿™è®©æˆ‘æ€€ç–‘ï¼Œæ˜¯ä¸æ˜¯å¼•ç”¨äº†é”™è¯¯çš„ __pb.js_ æ–‡ä»¶ã€‚ä¾‹å¦‚ä¸€ä¸ªæ˜¯ç”¨çš„å¤–å±‚ keycenter ä¸­çš„ `keycenter_pb.js`ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯ä½¿ç”¨åˆ°äº† redis ä¸­ keycenter ä¸­çš„ `keycenter_pb.js`ã€‚ä¸¤ä¸ªæ–‡ä»¶ä¸€æ¨¡ä¸€æ ·ï¼Œå‡½æ•°ç­¾åä¸€æ¨¡ä¸€æ ·ï¼Œä½†çœ‹èµ·ç›¸åŒçš„ä¸¤ä¸ªå¯¹è±¡ï¼Œå®åˆ™ä¸åŒï¼Œè‡ªç„¶è¿‡ä¸äº†åˆ¤æ–­ã€‚\r\n\r\néš¾é“æ˜¯æ„é€  `arg` å‚æ•°æ—¶å¼•å…¥çš„ `keycenter_pb.js` å’Œ `serialize_keycenter_SecretData` æ–¹æ³•å¼•å…¥çš„ `keycenter_pb.js` ä¸åŒä¹ˆï¼Ÿ\r\n\r\nåŸºäºæˆ‘å¯¹ Nodejs `require` æœºåˆ¶çš„äº†è§£ï¼ŒåŸºæœ¬æ’é™¤äº†è¿™ä¸ªå¯èƒ½ã€‚å®ƒä»¬æ˜¯é€šè¿‡ç›¸å¯¹è·¯å¾„å¼•å…¥ï¼Œæ ¹æ®æ¨¡å—å¯»è·¯çš„è§„åˆ™ï¼Œéƒ½ä¼šå‘½ä¸­å„è‡ªåŒ…å†…çš„ä»£ç æ¨¡å—ã€‚ä¸å­˜åœ¨å¼•åˆ°å…¶ä»–åŒ…å†…çš„ä»£ç æ–‡ä»¶çš„æƒ…å†µã€‚\r\n\r\n### 2.6ã€æ¨¡å—æ˜¯å¦‚ä½•è¢«â€œæ±¡æŸ“â€çš„ï¼Ÿ\r\n\r\nå¦‚æœå¼•ç”¨çš„æ¨¡å—æ²¡æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆä¼šä¸ä¼šæ˜¯æ¨¡å—å†…çš„å˜é‡è¢«â€œæ±¡æŸ“â€äº†ï¼Ÿ\r\n\r\nè¿™å°±å’Œæˆ‘æœ€å¼€å§‹çš„ç›´è§‰ â€”â€” â€œå‰¯ä½œç”¨â€ï¼Œæœ‰äº›å…³è”äº†ã€‚å‰¯ä½œç”¨çš„äº§ç”Ÿåœºæ™¯å¾ˆå¤šï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªåœºæ™¯éå¸¸å…¸å‹ï¼Œå°±æ˜¯å…¨å±€å˜é‡çš„ä½¿ç”¨ã€‚åœ¨æŸ¥çœ‹ `keycenter_pb.js` æ–‡ä»¶çš„ä»£ç åï¼Œæˆ‘å‘ç°æœç„¶å¦‚æ­¤ï¼š\r\n\r\n```JavaScript\r\nvar jspb = require('google-protobuf');\r\nvar goog = jspb;\r\nvar global = Function('return this')();\r\n// ...\r\ngoog.exportSymbol('proto.keycenter.SecretData', null, global);\r\n// ...\r\ngoog.object.extend(exports, proto.keycenter);\r\n```\r\n\r\nä»£ç é€šè¿‡ `Function('return this')()` è·å–äº†å…¨å±€å¯¹è±¡ã€‚ç„¶åé€šè¿‡æ‰§è¡Œ `goog.exportSymbol` æ–¹æ³•ï¼Œåœ¨å…¨å±€å¯¹è±¡ä¸ŠæŒ‚è½½ `global.proto.keycenter.SecretData` å±æ€§å€¼ã€‚æœ€åå†åœ¨ `exports` ä¸ŠæŒ‚è½½ `proto.keycenter` å¯¹è±¡ä½œä¸ºå¯¼å‡ºã€‚\r\n\r\nä½†å¦‚æœä»”ç»†åˆ†æï¼Œä»…ä»…ä¸Šè¿°ä»£ç ï¼Œå¹¶ä¸ä¼šå¯¼è‡´è¿™ä¸ªé”™è¯¯ã€‚å› ä¸ºå®ƒä¼šå…ˆä¿®æ”¹ global å¼•ç”¨çš„æŒ‡å‘ï¼Œå†ä¿®æ”¹ global ä¸Šå¯¹åº”çš„å¯¹è±¡ã€‚ä¾‹å¦‚å¼•å…¥æ¨¡å—åå¼•ç”¨å…³ç³»å¤§è‡´å¦‚ä¸‹ï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116182221-75c40380-a74e-11eb-966f-f407ccfca1d7.png)\r\n\r\nå½“è¿è¡Œç¯å¢ƒä¸­å†æ¬¡å¼•å…¥ä¸€ä¸ªåŒæ ·å†…å®¹ `_pb'.js` æ–‡ä»¶åï¼Œå°±ä¼šå˜æˆå¦‚ä¸‹å¼•ç”¨å…³ç³»ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/116182235-7a88b780-a74e-11eb-8649-7676223b8c93.png)\r\n\r\nå¯ä»¥çœ‹åˆ°åŸå…ˆçš„ proto å¯¹è±¡å¹¶ä¸ä¼šè¢«ä¿®æ”¹ï¼Œå³å¤–éƒ¨ä¹‹å‰å¯¼å…¥çš„å¯¹è±¡å¹¶ä¸ä¼šå˜ã€‚é‚£ä¹ˆç©¶ç«Ÿæ˜¯å¦‚ä½•è¢«â€œæ±¡æŸ“â€çš„å‘¢ï¼Ÿ\r\n\r\nå…¶å®é—®é¢˜æ¥è‡ªäº 2.3 èŠ‚ä¸­ç”¨åˆ°çš„ `.deserializeBinary` è¿™ä¸ªæ–¹æ³•ã€‚è¿™æ˜¯ `_pb.js` åœ¨æ„é€ å‡½æ•°ä¸Šæš´éœ²å‡ºæ¥çš„é™æ€æ–¹æ³•ï¼Œå¯ä»¥æ ¹æ®äºŒè¿›åˆ¶æ•°æ®ç”Ÿæˆå¯¹åº”çš„å®ä¾‹å¯¹è±¡ï¼š\r\n\r\n```JavaScript\r\nproto.keycenter.SecretData.deserializeBinary = function(bytes) {\r\n    var reader = new jspb.BinaryReader(bytes);\r\n    var msg = new proto.keycenter.SecretData;\r\n    return proto.keycenter.SecretData.deserializeBinaryFromReader(msg, reader);\r\n};\r\n```\r\n\r\næ³¨æ„ç¬¬äºŒè¡Œ `var msg = new proto.keycenter.SecretData`ï¼Œä½¿ç”¨äº† `proto.keycenter.SecretData` è¿™ä¸ªæ„é€ å‡½æ•°ï¼Œè€Œæˆ‘ä»¬æ ¹æ®å‰é¢çš„ä»£ç å¯ä»¥çŸ¥é“ï¼Œè¿™é‡Œçš„ proto å…¶å®æ˜¯ `[global].proto`ã€‚æ‰€ä»¥ä¸€æ—¦æˆ‘ä»¬çš„å…¨å±€å¯¹è±¡ä¸Šçš„æŒ‡å‘è¢«ä¿®æ”¹åï¼Œè¿™é‡Œä½¿ç”¨çš„ `keycenter.SecretData` å…¶å®å°±æ˜¯å¦ä¸€ä¸ªæ„é€ å‡½æ•°äº†ã€‚\r\n\r\nçœŸç›¸å¤§ç™½ã€‚å¯¼è‡´é”™è¯¯çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š\r\n\r\n1. é¦–å…ˆ `keycenter_grpc_pb.js` å¼•å…¥äº†åŒç›®å½•ä¸‹ `keycenter_pb.js` æ–‡ä»¶ï¼Œæ¨¡å—ä¸­çš„ `keycenter.SecretData` æ„é€ å‡½æ•°è¿™æ—¶å€™å°±ç¡®å®šäº†\r\n1. å› ä¸ºä¸€äº›å…¶ä»–åŸå› ï¼ŒæŸä¸ªåŒ…å¼•ç”¨äº†å¦ä¸€ä¸ªåœ°æ–¹çš„ã€å†…å®¹ç›¸åŒçš„ pb æ–‡ä»¶ï¼Œä¸ºäº†åŒºåˆ†æˆ‘ä»¬å«å®ƒ `keycenter_pb-2.js`ã€‚å®ƒå’Œ `keycenter_pb.js` å†…å®¹ä¸€æ‘¸ä¸€æ ·ï¼Œä¸è¿‡æ˜¯ä¸¤ä¸ªæ–‡ä»¶ã€‚è¿™æ—¶å€™ global ä¸ŠæŒ‡å‘çš„å¯¹è±¡å°±è¢«ä¿®æ”¹äº†\r\n1. ç„¶åå¯¼å…¥ `keycenter_pb.js` æ¨¡å—ï¼Œå†ä½¿ç”¨ `SecretData.deserializeBinary` ç”Ÿæˆå®ä¾‹ï¼Œä¼ å…¥ `keycenter_grpc_pb.js` ä¸­çš„æ–¹æ³•å°±ä¼šå‡ºé”™äº†\r\n\r\nâœ¨ ä¸ºäº†å¤§å®¶æ›´å¥½ç†è§£ï¼Œæˆ‘å¤åˆ»äº†è¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒé€»è¾‘ï¼Œ[åšæˆäº† demo](https://github.com/alienzhou/grpc-static-pollute-demo)ï¼Œå¤§å®¶å¯ä»¥ clone åˆ°æœ¬åœ°å†é…åˆæ–‡ç« å†…å®¹æ¥æŸ¥çœ‹ã€è¿è¡Œã€‚\r\n\r\n---\r\n\r\nâ˜•ï¸ ä¸Šé¢å·²ç»å®Œæˆäº†é—®é¢˜çš„æ’æŸ¥ï¼Œä¸‹é¢çš„æ–‡ç« ä¼šè¿›å…¥åˆ°å¦ä¸€ä¸ªä¸»é¢˜ â€”â€” é—®é¢˜ä¿®å¤ã€‚æœ¬èº«ä»¥ä¸ºä¼šè¾ƒä¸ºé¡ºç•…çš„ä¿®å¤è¿‡ç¨‹ï¼Œä¹Ÿé‡åˆ°ä¸€äº›æ„æ–™ä¹‹å¤–çš„é—®é¢˜ã€‚\r\n\r\n---\r\n\r\n## 3ã€è§£å†³æ€è·¯\r\n\r\nå¦‚æœç†è§£äº†é”™è¯¯åŸå› ï¼Œå°±ä¼šå‘ç°è¿™ä¸ªé”™è¯¯å‡ºç°çš„æ¡ä»¶è¿˜æ˜¯æ¯”è¾ƒè‹›åˆ»çš„ã€‚éœ€è¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªå¿…è¦æ¡ä»¶æ‰ä¼šå¤ç°ï¼š\r\n\r\n1. è¿›è¡Œäº†æŒ‚è½½å…¨å±€å˜é‡çš„æ“ä½œ\r\n1. é¡¹ç›®åŒæ—¶ import ä¸¤ä¸ªå†…å®¹ç›¸åŒçš„ `_pb.js` æ–‡ä»¶\r\n1. ä½¿ç”¨äº† `.deserializeBinary` æ–¹æ³•æ¥åˆ›å»ºå®ä¾‹å¯¹è±¡\r\n1. æ¨¡å—çš„ import é¡ºåºéœ€è¦å…ˆå¯¼å…¥ `_grpc_pb.js`ï¼Œå†å¯¼å…¥ `_pb'.js`ï¼ˆåŒå†…å®¹çš„å¦ä¸€ä¸ª pb æ–‡ä»¶ï¼‰\r\n\r\né’ˆå¯¹ 2ï½4 è¿™ä¸‰ä¸ªæ¡ä»¶ï¼Œæˆ‘ä»¬åªè¦ç ´åå…¶ä¸€ï¼Œå°±å¯ä»¥é¿å…é—®é¢˜å‘ç”Ÿã€‚æˆ‘åœ¨ [demo é¡¹ç›®](https://github.com/alienzhou/grpc-static-pollute-demo)ä¸­åˆ†åˆ«å†™äº†å¯¹åº”çš„ä»£ç ï¼ˆcorrect-2.tsã€correct-3.tsã€correct-4.tsï¼‰ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥è¯•ä¸‹ã€‚\r\n\r\nå¦‚æœä½œä¸ºåŒ…æä¾›æ–¹ï¼Œè¦è§£å†³è¿™ä¸ªé—®é¢˜è™½ç„¶çœ‹ä¼¼æ–¹å¼å¾ˆå¤šï¼Œä½†æ˜¯ç°å®ä¸Šæˆ‘ä»¬èƒ½æ§åˆ¶çš„æœ‰é™ â€”â€”\r\n\r\n- å…ˆæ˜¯ç¬¬ 2 æ¡ï¼Œä¼šéœ€è¦ä¿è¯åªå®‰è£…ä¸€ä¸ª keycenter åŒ…ã€‚ä¸åŒåŒ…ã€æ¨¡å—å¯¹äºåŒ…çš„ç‰ˆæœ¬ä¾èµ–æ˜¯å¤–éƒ¨æ§åˆ¶çš„ï¼Œä¸å—åŒ…è‡ªèº«æ§åˆ¶ï¼Œå› æ­¤å¾ˆéš¾ç¡®ä¿æ ¹é™¤ï¼›\r\n- ç„¶åæ˜¯ç¬¬ 3 æ¡ï¼Œä½¿ç”¨ `.deserializeBinary` æ˜¯åŠŸèƒ½è¦æ±‚ï¼Œå¦‚æœè¦è§„é¿è¿™ä¸ªæ–¹æ³•çš„å‘ä¼šä½¿ä»£ç å˜å¾—è¾ƒä¸º trickyï¼›\r\n- æœ€åæ˜¯ç¬¬ 4 æ¡ï¼Œå¼•ç”¨é¡ºåºæ˜¾ç„¶ä¹Ÿæ˜¯å¤–éƒ¨æ§åˆ¶çš„ï¼Œä¸å—åŒ…è‡ªèº«æ‰€æ§\r\n\r\næ‰€ä»¥æˆ‘ä»¬å°½é‡è¿˜æ˜¯å¸Œæœ›èƒ½æ‰¾ä¸€ä¸ªâ€œæ­£è§„â€çš„è·¯å­ï¼Œä½¿å¾—é€šè¿‡ grpc-tools æˆ–è€… protoc ç”Ÿæˆçš„ `_pb.js` æ–‡ä»¶ï¼Œä¸ä¼šäº§ç”Ÿå…¨å±€æ±¡æŸ“ï¼ˆä¹Ÿå°±æ˜¯ç ´é™¤æ¡ä»¶ 1ï¼‰ã€‚\r\n\r\n## 4ã€ä¿®å¤ä¹‹è·¯\r\n\r\n### 4.1ã€è®© protoc ç”Ÿæˆçš„ä»£ç é¿å…å…¨å±€æ±¡æŸ“\r\n\r\næŒ‰ä¸Šé¢çš„æ€è·¯ï¼Œæˆ‘ä»¬ä¼šå¸Œæœ›åœ¨ protoc ç”Ÿæˆæ—¶å°±äº§å‡ºä¸€ä»½â€œå®‰å…¨â€çš„ `_pb.js` é™æ€æ–‡ä»¶ã€‚\r\n\r\nprotoc æ”¯æŒåœ¨ js_out å‚æ•°ä¸­è®¾ç½® `import_style` æ¥æ§åˆ¶æ¨¡å—ç±»å‹ã€‚[å®˜æ–¹æ–‡æ¡£](https://developers.google.com/protocol-buffers/docs/reference/javascript-generated#commonjs-imports)é‡Œæä¾›äº† `commonjs` è¿™ä¸ªå‚æ•°ã€‚\r\n\r\n```bash\r\nprotoc --proto_path=src --js_out=import_style=commonjs,binary:build/gen src/foo.proto src/bar/baz.proto\r\n```\r\n\r\nä½†æ˜¯é—æ†¾çš„æ˜¯ï¼Œè¿™ä¸ªå‚æ•°å¹¶ä¸ä¼šç”Ÿæˆæˆ‘ä»¬é¢„æƒ³çš„ä»£ç ï¼Œå®ƒç”Ÿæˆçš„ä»£ç å°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šæ–‡ä¸­çœ‹åˆ°çš„â€œé—®é¢˜ä»£ç â€ã€‚æ‰€ä»¥è¿˜æœ‰å…¶ä»– `import_style` ä¹ˆï¼Ÿ\r\n\r\næ–‡æ¡£é‡Œæ²¡æœ‰ï¼Œåªèƒ½å»æºç é‡Œæ‰¾ç­”æ¡ˆäº†ã€‚\r\n\r\n> ä¸‹é¢ä¼šæ¶‰åŠåˆ° protocï¼Œè¿™é‡Œç®€å•ä»‹ç»äº†ä¸€ä¸‹ï¼Œä¾¿äºä¸äº†è§£çš„æœ‹å‹èƒ½å¿«é€Ÿç†è§£ã€‚[protobuf](https://github.com/protocolbuffers/protobuf#protocol-compiler-installation) è¿™ä¸ªä»“åº“ä¸­åŒ…å«äº† Protocol Compilerã€‚å…¶ä¸­å„ä¸ªè¯­è¨€ç›¸å…³çš„ä»£ç ç”Ÿæˆå™¨æ”¾åœ¨äº† `src/google/protobuf/compiler/` ä¸‹é¢å¯¹åº”åç§°çš„æ–‡ä»¶å¤¹é‡Œã€‚ä¾‹å¦‚ JavaScript å°±æ˜¯ [`/js` æ–‡ä»¶å¤¹å†…](https://github.com/protocolbuffers/protobuf/tree/v3.15.7/src/google/protobuf/compiler/js)ã€‚\r\n\r\nåœ¨æºç ä¸­å¯ä»¥å‘ç°ï¼Œå…¶[æ”¯æŒçš„ style å€¼](https://github.com/protocolbuffers/protobuf/blob/v3.15.7/src/google/protobuf/compiler/js/js_generator.cc#L3492-L3502)å¹¶éåªæœ‰ commonjs å’Œ closure ä¸¤ç§ï¼š\r\n\r\n```c++\r\n// ...\r\nelse if (options[i].first == \"import_style\") {\r\n  if (options[i].second == \"closure\") {\r\n    import_style = kImportClosure;\r\n  } else if (options[i].second == \"commonjs\") {\r\n    import_style = kImportCommonJs;\r\n  } else if (options[i].second == \"commonjs_strict\") {\r\n    import_style = kImportCommonJsStrict;\r\n  } else if (options[i].second == \"browser\") {\r\n    import_style = kImportBrowser;\r\n  } else if (options[i].second == \"es6\") {\r\n    import_style = kImportEs6;\r\n  } else {\r\n    *error = \"Unknown import style \" + options[i].second + \", expected \" +\r\n              \"one of: closure, commonjs, browser, es6.\";\r\n  }\r\n}\r\n// ...\r\n```\r\n\r\nä½†å¤§è‡´æµè§ˆå®Œæºç åï¼Œæˆ‘å‘ç° browser å’Œ es6 ä¸¤ç§ style å®é™…ä¹Ÿä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚è¿™æ—¶å€™å°±å‰©ä¸‹ `commonjs_strict` äº†ã€‚è¿™ä¸ª strict æ„Ÿè§‰å°±ä¼šéå¸¸è´´åˆæˆ‘ä»¬çš„ç›®æ ‡ã€‚\r\n\r\nä¸»è¦çš„[ç›¸å…³ä»£ç ](https://github.com/protocolbuffers/protobuf/blob/v3.15.7/src/google/protobuf/compiler/js/js_generator.cc#L3635-L3645)å¦‚ä¸‹ï¼š\r\n\r\n```c++\r\n// Generate \"require\" statements.\r\nif ((options.import_style == GeneratorOptions::kImportCommonJs ||\r\n      options.import_style == GeneratorOptions::kImportCommonJsStrict)) {\r\n  printer->Print(\"var jspb = require('google-protobuf');\\n\");\r\n  printer->Print(\"var goog = jspb;\\n\");\r\n\r\n  // Do not use global scope in strict mode\r\n  if (options.import_style == GeneratorOptions::kImportCommonJsStrict) {\r\n    printer->Print(\"var proto = {};\\n\\n\");\r\n  } else {\r\n    printer->Print(\"var global = Function('return this')();\\n\\n\");\r\n  }\r\n  // ...\r\n}\r\n```\r\n\r\nè¿™é‡Œå°±å¯ä»¥çœ‹å‡º `commonjs_strict` å’Œ `commonjs` æœ€å¤§çš„åŒºåˆ«å°±æ˜¯æ˜¯å¦ä½¿ç”¨äº†å…¨å±€å˜é‡ã€‚å¦‚æœæ˜¯ `commonjs_strict` åˆ™ä¼šä½¿ç”¨ `var proto = {};` æ¥ä»£æ›¿å…¨å±€å˜é‡ã€‚å®Œå…¨æ»¡è¶³éœ€æ±‚ï¼\r\n\r\nä½†æ˜¯ï¼Œå®é™…ä½¿ç”¨åï¼Œæˆ‘å‘ç°äº†å¦ä¸€ä¸ªé—®é¢˜ã€‚\r\n\r\n### 4.2ã€grpc-tools å¹¶ä¸é€‚é… `commonjs_strict`\r\n\r\n`import_style=commonjs_strict` å¦ä¸€ä¸ªæœ€å¤§çš„åŒºåˆ«åœ¨äº[å¯¼å‡ºä»£ç çš„ç”Ÿæˆ](https://github.com/protocolbuffers/protobuf/blob/v3.15.7/src/google/protobuf/compiler/js/js_generator.cc#L3690-L3697)ï¼š\r\n\r\n```c++\r\n// if provided is empty, do not export anything\r\nif (options.import_style == GeneratorOptions::kImportCommonJs &&\r\n    !provided.empty()) {\r\n  printer->Print(\"goog.object.extend(exports, $package$);\\n\", \"package\",\r\n                  GetNamespace(options, file));\r\n} else if (options.import_style == GeneratorOptions::kImportCommonJsStrict) {\r\n  printer->Print(\"goog.object.extend(exports, proto);\\n\", \"package\",\r\n                  GetNamespace(options, file));\r\n}\r\n```\r\n\r\nè¿™æ ·çœ‹å¯èƒ½ä¸å¤ªç›´è§‚ï¼Œç›´æ¥è´´ä¸¤ç§ style ç”Ÿæˆçš„ä»£ç å°±å¾ˆæ˜ç™½äº†ã€‚\r\n\r\nä¸‹é¢æ˜¯ç”¨ `commonjs_strict` ç”Ÿæˆçš„ï¼š\r\n\r\n```\r\ngoog.object.extend(exports, proto);\r\n```\r\n\r\nä¸‹é¢æ˜¯ç”¨ `commonjs` ç”Ÿæˆçš„ï¼š\r\n\r\n```\r\ngoog.object.extend(exports, proto.keycenter);\r\n```\r\n\r\nè¿™æ ·å°±èƒ½æ˜æ˜¾çœ‹å‡ºåŒºåˆ«äº†ã€‚`commonjs` å½¢å¼å¯¼å‡ºæ—¶ä¼šå¯¼å‡º package ä¸‹çš„å¯¹è±¡ã€‚å› æ­¤ï¼Œåœ¨æˆ‘ä»¬ä½¿ç”¨å¯¹åº”çš„ `_pb.js` æ–‡ä»¶æ—¶ï¼Œä¼šéœ€è¦è°ƒæ•´ä¸€ä¸‹å¯¼å…¥çš„ä»£ç ã€‚æ­¤å¤–ï¼Œgrpc-tools ç”Ÿæˆçš„ __grpc_pd.js_ é™æ€ä»£ç å› ä¸ºä¹Ÿä¼šå¯¼å…¥ `_pb.js` æ–‡ä»¶ï¼Œå› æ­¤ä¹Ÿéœ€è¦é€‚é…è¿™ç§å¯¼å‡ºã€‚\r\n\r\n> è¿™é‡Œç®€å•ä»‹ç»ä¸‹ grpc-tools çš„è§’è‰²ã€‚å®ƒåšäº†ä¸¤ä»¶äº‹ï¼Œä¸€ä¸ªæ˜¯ wrap äº†ä¸€äº› protoc å‘½ä»¤è¡Œï¼Œè¿™æ ·ç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨ grpc-tools è€Œä¸å»å…³å¿ƒ protocï¼›å¦ä¸€ä¸ªæ˜¯å®ç°äº†ä¸€ä¸ª protoc çš„ grpc æ’ä»¶ã€‚å…³äº protoc æ’ä»¶æœºåˆ¶ä¸å¦‚ä½•å®ç°ä¸€ä¸ª protoc æ’ä»¶ï¼Œåç»­æœ‰æœºä¼šå¯ä»¥å•å†™ç¯‡æ–‡ç« ä»‹ç»ã€‚\r\n\r\nè€Œå½“æˆ‘æ»¡å¿ƒæ¬¢å–œåœ°å»ç¿»é˜… [grpc-tools æºç ](https://github.com/grpc/grpc-node/blob/grpc%401.24.6/packages/grpc-tools/src/node_generator.cc#L218-L221)æ—¶å‘ç°ï¼Œ\r\n\r\n```c++\r\ngrpc::string file_path =\r\n    GetRelativePath(file->name(), GetJSMessageFilename(file->name()));\r\nout->Print(\"var $module_alias$ = require('$file_path$');\\n\", \"module_alias\",\r\n            ModuleAlias(file->name()), \"file_path\", file_path);\r\n```\r\n\r\nå®ƒå¹¶ä¸ä¼šè€ƒè™‘ `import_style=commonjs_strict` è¿™ç§æƒ…å†µï¼Œè€Œæ˜¯å›ºå®šç”Ÿæˆå¯¹åº” `commonjs` çš„å¯¼å…¥ä»£ç ã€‚ä¹Ÿæœ‰ [issue](https://github.com/grpc/grpc-node/issues/1445) æåˆ°äº†è¿™ä¸ªé—®é¢˜ã€‚\r\n\r\n### 4.3ã€åªèƒ½è‡ªå·±åŠ¨æ‰‹äº†\r\n\r\nå¥½å§ï¼Œè¿™ä¸ªå¯¼å…¥/å¯¼å‡ºçš„é—®é¢˜ç›®å‰æ²¡æœ‰ç‰¹åˆ«å¥½çš„è§£å†³åŠæ³•ã€‚\r\n\r\næˆ‘ä»¬è¿™è¾¹ä¹‹å‰å› ä¸ºä¸€äº›ç‰¹æ®Šéœ€æ±‚ï¼Œæ‰€ä»¥ folk äº† grpc-tools çš„ä»£ç ï¼Œä¿®æ”¹äº†å†…éƒ¨å®ç°ä»¥é€‚é…æˆ‘ä»¬çš„ RPC æ¡†æ¶ã€‚å› æ­¤è¿™å—å°±è‡ªå·±ä¸Šæ‰‹ï¼Œæ”¯æŒäº† `import_style=commonjs_strict` è¿™ç§æƒ…å†µï¼Œä¿®æ”¹äº†å¯¼å…¥æ—¶çš„ä»£ç ï¼š\r\n\r\n```c++\r\ngrpc::string pb_package = file->package();\r\nif (params.commonjs_strict && !pb_package.empty()) {\r\n  out->Print(\"var $module_alias$ = require('$file_path$').$pb_package$;\\n\", \"module_alias\",\r\n           ModuleAlias(file->name()), \"file_path\", file_path, \"pb_package\", pb_package);\r\n} else {\r\n  out->Print(\"var $module_alias$ = require('$file_path$');\\n\", \"module_alias\",\r\n           ModuleAlias(file->name()), \"file_path\", file_path);\r\n}\r\n```\r\n\r\nå½“ç„¶è¿˜éœ€è¦é…åˆåšä¸€äº›å…¶ä»–æ”¹åŠ¨ï¼Œä¾‹å¦‚ CLI å…¥å‚çš„åˆ¤æ–­å¤„ç†ç­‰ï¼Œè¿™é‡Œå°±ä¸è´´äº†ã€‚\r\n\r\nå½“ç„¶ï¼Œä»¤äººå¤´ç–¼çš„é—®é¢˜ä¸æ­¢è¿™ä¸€ä¸ªï¼Œå¦‚æœä½ ä½¿ç”¨äº†å…¶ä»– protoc æ’ä»¶è‡ªåŠ¨ç”Ÿæˆ .d.ts æ–‡ä»¶çš„è¯ï¼Œè¿™å—ä¹Ÿä¼šéœ€è¦é€‚é… `import_style=commonjs_strict` çš„æƒ…å†µã€‚\r\n\r\n\r\n## 5ã€æœ€å\r\n\r\næœ¬æ–‡ä¸»è¦è®°å½•äº†ä¸€æ¬¡ gRPC ç›¸å…³æŠ¥é”™çš„æ’æŸ¥è¿‡ç¨‹ã€‚åŒ…æ‹¬æ‰¾å‡ºåŸå› ã€æå‡ºè§£å†³æ€è·¯åˆ°æœ€åä¿®å¤çš„æ•´ä¸ªè¿‡ç¨‹ã€‚\r\n\r\næ’æŸ¥é—®é¢˜æ˜¯æ¯ä¸ªå·¥ç¨‹å¸ˆç»å¸¸ä¼šé¢å¯¹çš„äº‹å„¿ï¼Œä¹Ÿå¸¸å¸¸å……æ»¡æŒ‘æˆ˜ã€‚å¾€å¾€è¿™äº›é—®é¢˜çš„è½è„šå¤„å¯èƒ½å¹¶ä¸å¤§ï¼Œä¿®å¤å·¥ä½œä¹Ÿåªæ˜¯ç®€å•å‡ è¡Œä»£ç ã€‚è€Œæ’éšœçš„è¿‡ç¨‹ï¼Œä¼´éšç€å„ç±»çŸ¥è¯†æˆ–æŠ€æœ¯ç‚¹çš„ä½¿ç”¨ï¼Œä»è¡¨è±¡åˆ°çœŸç›¸ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¹Ÿæ˜¯å·¥ç¨‹å¸ˆç‹¬æœ‰çš„ä¹è¶£ã€‚\r\n\r\nè€Œåœ¨æ–‡ç« å†™ä½œä¸Šï¼Œç›¸æ¯”ä»‹ç»ä¸€ä¸ªæŠ€æœ¯ç‚¹ï¼Œè¦å†™å¥½ä¸€ç¯‡æ’éšœæ–‡ç« å¾€å¾€æ›´ä¸å®¹æ˜“ï¼Œæ‰€ä»¥ä¹Ÿæƒ³æŒ‘æˆ˜ä¸€ä¸‹è‡ªå·±ã€‚\r\n\r\n> æ–‡ç« å†…å®¹æœ‰ä¸€ä¸ªé…å¥—çš„ [demo ä»£ç ](https://github.com/alienzhou/grpc-static-pollute-demo)ï¼Œå¯ä»¥ç”¨æ¥é…åˆç†è§£æ–‡ç« ä¸­çš„é—®é¢˜ã€‚","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/45","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/45/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/45/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/45/events","html_url":"https://github.com/alienzhou/blog/issues/45","id":818888328,"node_id":"MDU6SXNzdWU4MTg4ODgzMjg=","number":45,"title":"vue-cli è¿ç§» vite2 å®è·µå°ç»“","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":2782716193,"node_id":"MDU6TGFiZWwyNzgyNzE2MTkz","url":"https://api.github.com/repos/alienzhou/blog/labels/vue","name":"vue","color":"42b983","default":false,"description":""},{"id":1159845016,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%BB%BC%E5%90%88","name":"ç»¼åˆ","color":"a2eeef","default":false,"description":""},{"id":1160330255,"node_id":"MDU6TGFiZWwxMTYwMzMwMjU1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7","name":"è‡ªåŠ¨åŒ–å·¥å…·","color":"f9c0d1","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-03-01T13:53:28Z","updated_at":"2021-03-09T07:57:10Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"ä¸¤å‘¨å‰ï¼ˆ202.02.17ï¼‰ï¼Œ[vite2.0 å‘å¸ƒäº†](https://dev.to/yyx990803/announcing-vite-2-0-2f0a)ï¼Œä½œä¸ºä½¿ç”¨äº†æµè§ˆå™¨åŸç”Ÿ ESM ä¸ºä¸‹ä¸€ä»£å‰ç«¯å·¥å…·ï¼Œvite 2.0 ç›¸è¾ƒäº 1.0 æ›´åŠ æˆç†Ÿã€‚åœ¨æ­¤ä¹‹å‰ç¬”è€…å°±å¼€å§‹[å…³æ³¨è¿™ç±»ã€Œæ–°å‹ã€çš„å‰ç«¯å·¥å…·](https://github.com/alienzhou/blog/issues/42)ã€‚è¿™æ¬¡è¶ç€ vite 2.0 å‘å¸ƒï¼Œä¹ŸæˆåŠŸå°†ä¸€ä¸ªåŸºäº vue-cli(-service) + vue2 çš„å·²æœ‰é¡¹ç›®è¿›è¡Œäº†è¿ç§»ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/109505512-a1709780-7ad7-11eb-8315-8fb324a34dfd.png)\r\n\r\nè¿ç§»å·¥ä½œæ¯”è¾ƒé¡ºåˆ©ï¼ŒèŠ±äº†ä¸åˆ°åŠå¤©æ—¶é—´ã€‚ä½†æ•´ä¸ªè¿ç§»è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº†ä¸€äº›å°é—®é¢˜ï¼Œè¿™é‡Œæ±‡æ€»ä¸€ä¸‹ï¼Œä¹Ÿæ–¹ä¾¿é‡åˆ°ç±»ä¼¼é—®é¢˜çš„æœ‹å‹ä¸€èµ·äº¤æµå’Œå‚è€ƒã€‚\r\n\r\n## é¡¹ç›®èƒŒæ™¯\r\n\r\nåœ¨ä»‹ç»å…·ä½“è¿ç§»å·¥ä½œå‰ï¼Œå…ˆç®€å•ä»‹ç»ä¸‹é¡¹ç›®æƒ…å†µã€‚ç›®å‰è¯¥é¡¹ç›®ä¸Šçº¿ä¸åˆ°ä¸€å¹´ï¼Œä¸å¤ªæœ‰æ„å»ºç›¸å…³çš„å†å²é—ç•™å€ºåŠ¡ã€‚é¡¹ç›®åŒ…å« 1897 ä¸ªæ¨¡å—æ–‡ä»¶ï¼ˆåŒ…æ‹¬ node_modules ä¸­æ¨¡å—ï¼‰ï¼Œä½¿ç”¨äº† vue2 + vuex + typescript çš„æŠ€æœ¯æ ˆï¼Œæ„å»ºå·¥å…·ä½¿ç”¨çš„æ˜¯ vue-cliï¼ˆwebpackï¼‰ã€‚ç®—æ˜¯ä¸€å¥—æ¯”è¾ƒæ ‡å‡†çš„ vue æŠ€æœ¯æ ˆã€‚ç”±äºæ˜¯å†…éƒ¨ç³»ç»Ÿï¼Œé¡¹ç›®å¯¹å…¼å®¹æ€§çš„è¦æ±‚è¾ƒä½ï¼Œç”¨æˆ·åŸºæœ¬éƒ½ä½¿ç”¨è¾ƒæ–°çš„ Chrome æµè§ˆå™¨ï¼ˆå°‘éƒ¨åˆ†ä½¿ç”¨ Safariï¼‰ã€‚\r\n\r\n## è¿ç§»å·¥ä½œ\r\n\r\nä¸‹é¢å…·ä½“æ¥è¯´ä¸‹è¿ç§»ä¸­éƒ½åšäº†å“ªäº›å¤„ç†ã€‚\r\n\r\n### 1ã€é…ç½®æ–‡ä»¶\r\n\r\né¦–å…ˆéœ€è¦å®‰è£… vite å¹¶åˆ›å»º vite çš„é…ç½®æ–‡ä»¶ã€‚\r\n\r\n```bash\r\nnpm i -D vite\r\n```\r\n\r\nvue-cli-service ä¸­ä½¿ç”¨ `vue.config.js` ä½œä¸ºé…ç½®æ–‡ä»¶ï¼›è€Œ vite åˆ™é»˜è®¤ä¼šéœ€è¦åˆ›å»ºä¸€ä¸ª `vite.config.ts` æ¥ä½œä¸ºé…ç½®æ–‡ä»¶ã€‚åŸºç¡€çš„é…ç½®æ–‡ä»¶å¾ˆç®€å•ï¼š\r\n\r\n```typescript\r\nimport { defineConfig } from 'vite';\r\n\r\nexport default defineConfig({\r\n  plugins: [\r\n    // ...\r\n  ],\r\n})\r\n```\r\n\r\nåˆ›å»ºè¯¥é…ç½®æ–‡ä»¶ï¼Œä¹‹å‰çš„ vue.config.js å°±ä¸å†ä½¿ç”¨äº†ã€‚\r\n\r\n### 2ã€å…¥å£ä¸ HTML æ–‡ä»¶\r\n\r\nåœ¨ vite ä¸­ä¹Ÿéœ€è¦æŒ‡å®šå…¥å£æ–‡ä»¶ã€‚ä½†å’Œ webpack ä¸åŒï¼Œåœ¨ vite ä¸­ä¸æ˜¯æŒ‡å®š js/ts ä½œä¸ºå…¥å£ï¼Œè€Œæ˜¯æŒ‡å®šå®é™…çš„ HTML æ–‡ä»¶ä½œä¸ºå…¥å£ã€‚\r\n\r\nåœ¨ webpack ä¸­ï¼Œç”¨æˆ·é€šè¿‡å°† entry è®¾ç½®ä¸ºå…¥å£ jsï¼ˆä¾‹å¦‚ `src/app.js`ï¼‰æ¥æŒ‡å®š js æ‰“åŒ…çš„å…¥å£æ–‡ä»¶ï¼Œè¾…ä»¥ HtmlWebpackPlugin å°†ç”Ÿæˆçš„ js æ–‡ä»¶è·¯å¾„æ³¨å…¥åˆ° HTML ä¸­ã€‚è€Œ vite ç›´æ¥ä½¿ç”¨ HTML æ–‡ä»¶ï¼Œå®ƒä¼šè§£æ HTML ä¸­çš„ script æ ‡ç­¾æ¥æ‰¾åˆ°å…¥å£çš„ js æ–‡ä»¶ã€‚\r\n\r\nå› æ­¤ï¼Œæˆ‘ä»¬åœ¨å…¥å£ HTML ä¸­åŠ å…¥å¯¹ js/ts æ–‡ä»¶çš„ script æ ‡ç­¾å¼•ç”¨ï¼š\r\n\r\n```diff\r\n<!DOCTYPE html>\r\n<html lang=\"en\">\r\n\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\r\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1.0\">\r\n  <title><%= htmlWebpackPlugin.options.title %></title>\r\n</head>\r\n\r\n<body>\r\n  <noscript>\r\n    We're sorry but <%= htmlWebpackPlugin.options.title %> doesn't work properly without JavaScript enabled.\r\n  </noscript>\r\n  <div id=\"app\"></div>\r\n+ <script type=\"module\" src=\"/src/main.ts\"></script>\r\n</body>\r\n\r\n</html>\r\n```\r\n\r\næ³¨æ„ä¸Šé¢ `<script type=\"module\" src=\"/src/main.ts\"></script>` è¿™ä¸€è¡Œï¼Œå®ƒä½¿ç”¨æµè§ˆå™¨åŸç”Ÿçš„ ESM æ¥åŠ è½½è¯¥è„šæœ¬ï¼Œ`/src/main.ts` å°±æ˜¯å…¥å£ js çš„æºç ä½ç½®ã€‚åœ¨ vite dev æ¨¡å¼å¯åŠ¨æ—¶ï¼Œå®ƒå…¶å®å¯åŠ¨äº†ä¸€ä¸ªç±»ä¼¼é™æ€æœåŠ¡å™¨çš„ serverï¼Œå°† serve æºç ç›®å½•ï¼Œå› æ­¤ä¸éœ€è¦åƒ webpack é‚£æ ·çš„å¤æ‚æ¨¡å—æ‰“åŒ…è¿‡ç¨‹ã€‚æ¨¡å—çš„ä¾èµ–åŠ è½½å°†å®Œå…¨ä¾æ‰˜äºæµè§ˆå™¨ä¸­å¯¹ `import` è¯­æ³•çš„å¤„ç†ï¼Œå› æ­¤å¯ä»¥çœ‹åˆ°å¾ˆé•¿ä¸€ä¸²çš„è„šæœ¬åŠ è½½ç€‘å¸ƒæµï¼š\r\n\r\n![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/027b6d2e82584d8da2cb8a32c145fff1~tplv-k3u1fbpfcp-watermark.image)\r\n\r\nè¿™é‡Œè¿˜éœ€è¦æ³¨æ„ [project root çš„è®¾ç½®](https://vitejs.dev/config/#root)ã€‚åœ¨é»˜è®¤æ˜¯ `process.cwd()`ï¼Œè€Œ index.html ä¹Ÿä¼šåœ¨ project root ä¸‹è¿›è¡Œå¯»æ‰¾ã€‚ä¸ºäº†æ–¹ä¾¿æˆ‘å°† `./public/index.html` ç§»åˆ°äº† `./index.html`ã€‚\r\n\r\n### 3ã€ä½¿ç”¨ vue æ’ä»¶\r\n\r\nvite 2.0 æä¾›äº†å¯¹ vue é¡¹ç›®çš„è‰¯å¥½æ”¯æŒï¼Œä½†å…¶æœ¬èº«å¹¶ä¸å’Œ vue è¿›è¡Œè¾ƒå¼ºè€¦åˆï¼Œå› æ­¤é€šè¿‡æ’ä»¶çš„å½¢å¼æ¥æ”¯æŒå¯¹ vue æŠ€æœ¯æ ˆçš„é¡¹ç›®è¿›è¡Œæ„å»ºã€‚vite 2.0 å®˜ç½‘ç›®å‰ï¼ˆ2021.2.28ï¼‰æ¨èçš„ vue æ’ä»¶ä¼šå’Œ [vue3 çš„ SFC](https://vitejs.dev/plugins/#vitejs-plugin-vue) ä¸€èµ·ä½¿ç”¨æ›´å¥½ã€‚å› æ­¤è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªä¸“é—¨ç”¨æ¥æ”¯æŒ vue2 çš„æ’ä»¶ [vite-plugin-vue2](https://www.npmjs.com/package/vite-plugin-vue2)ï¼Œæ”¯æŒ JSXï¼ŒåŒæ—¶ç›®å‰æœ€æ–°ç‰ˆæœ¬ä¹Ÿæ˜¯[æ”¯æŒ vite2 çš„](https://github.com/underfin/vite-plugin-vue2/pull/13)ã€‚\r\n\r\nä½¿ç”¨ä¸Šä¹Ÿå¾ˆç®€å•ï¼š\r\n\r\n```diff\r\nimport { defineConfig } from 'vite';\r\n+ import { createVuePlugin } from 'vite-plugin-vue2';\r\n\r\nexport default defineConfig({\r\n  plugins: [\r\n+   createVuePlugin(),\r\n  ],\r\n});\r\n```\r\n\r\n### 4ã€å¤„ç† typescript è·¯å¾„æ˜ å°„\r\n\r\nä½¿ç”¨ vite æ„å»º ts é¡¹ç›®æ—¶ï¼Œå¦‚æœä½¿ç”¨äº† [typescript è·¯å¾„æ˜ å°„](https://www.typescriptlang.org/docs/handbook/module-resolution.html#path-mapping)çš„åŠŸèƒ½ï¼Œå°±éœ€è¦è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œå¦åˆ™ä¼šå‡ºç°æ¨¡å—æ— æ³•è§£æï¼ˆæ‰¾ä¸åˆ°ï¼‰çš„é”™è¯¯ï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/109505866-fdd3b700-7ad7-11eb-85a2-780129e9ada3.png)\r\n\r\nè¿™é‡Œéœ€è¦ä½¿ç”¨ [vite-tsconfig-paths](https://github.com/aleclarson/vite-tsconfig-paths) è¿™ä¸ªæ’ä»¶æ¥åšè·¯å¾„æ˜ å°„çš„è§£ææ›¿æ¢ã€‚å…¶åŸç†è¾ƒä¸ºç®€å•ï¼Œå¤§è‡´å°±æ˜¯ vite æ’ä»¶çš„ [resolveId é’©å­](https://vitejs.dev/guide/api-plugin.html#universal-hooks)é˜¶æ®µï¼Œåˆ©ç”¨ [tsconfig-paths](https://www.npmjs.com/package/tsconfig-paths) è¿™ä¸ªåº“æ¥å°†è·¯å¾„æ˜ å°„è§£æä¸ºå®é™…æ˜ å°„è¿”å›ã€‚æœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸‹è¯¥æ’ä»¶çš„å®ç°ï¼Œæ¯”è¾ƒç®€çŸ­ã€‚\r\n\r\nå…·ä½“ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š\r\n\r\n```diff\r\nimport { defineConfig } from 'vite';\r\nimport { createVuePlugin } from 'vite-plugin-vue2';\r\n+ import tsconfigPaths from 'vite-tsconfig-paths';\r\n\r\n// https://vitejs.dev/config/\r\nexport default defineConfig({\r\n  plugins: [\r\n    createVuePlugin(),\r\n+   tsconfigPaths(),\r\n  ],\r\n});\r\n```\r\n\r\n### 5ã€æ›¿æ¢ CommonJS\r\n\r\nvite ä½¿ç”¨ ESM ä½œä¸ºæ¨¡å—åŒ–æ–¹æ¡ˆï¼Œå› æ­¤ä¸æ”¯æŒä½¿ç”¨ `require` æ–¹å¼æ¥å¯¼å…¥æ¨¡å—ã€‚å¦åˆ™åœ¨è¿è¡Œæ—¶ä¼šæŠ¥ `Uncaught ReferenceError: require is not defined` çš„é”™è¯¯ï¼ˆæµè§ˆå™¨å¹¶ä¸æ”¯æŒ CJSï¼Œè‡ªç„¶æ²¡æœ‰ require æ–¹æ³•æ³¨å…¥ï¼‰ã€‚\r\n\r\næ­¤å¤–ï¼Œä¹Ÿå¯èƒ½ä¼šé‡åˆ° ESM å’Œ CJS çš„å…¼å®¹é—®é¢˜ã€‚å½“ç„¶è¿™å¹¶ä¸æ˜¯ vite æ„å»ºæ‰€å¯¼è‡´çš„é—®é¢˜ï¼Œä½†éœ€è¦æ³¨æ„è¿™ä¸€ç‚¹ã€‚ç®€å•æ¥è¯´å°±æ˜¯ ESM æœ‰ default è¿™ä¸ªæ¦‚å¿µï¼Œè€Œ CJS æ²¡æœ‰ã€‚ä»»ä½•å¯¼å‡ºçš„å˜é‡åœ¨ CJS çœ‹æ¥éƒ½æ˜¯ module.exports è¿™ä¸ªå¯¹è±¡ä¸Šçš„å±æ€§ï¼ŒESM çš„ default å¯¼å‡ºä¹Ÿåªæ˜¯ cjs ä¸Šçš„ module.exports.default å±æ€§è€Œå·²ã€‚ä¾‹å¦‚åœ¨ typescript ä¸­æˆ‘ä»¬ä¼šé€šè¿‡ esModuleInterop é…ç½®æ¥è®© tsc æ·»åŠ ä¸€äº›å…¼å®¹ä»£ç å¸®åŠ©è§£æå¯¼å…¥çš„æ¨¡å—ï¼Œwebpack ä¸­ä¹Ÿæœ‰ç±»ä¼¼æ“ä½œã€‚\r\n\r\nä¾‹å¦‚ä¹‹å‰çš„ä»£ç ï¼š\r\n\r\n```typescript\r\nmodule.exports = {\r\n    SSO_LOGIN_URL: 'https://xxx.yyy.com',\r\n    SSO_LOGOUT_URL: 'https://xxx.yyy.com/cas/logout',\r\n}\r\n```\r\n\r\n```typescript\r\nconst config = require('./config');\r\n```\r\n\r\nåœ¨å¯¼å‡ºå’Œå¯¼å…¥ä¸Šéƒ½éœ€è¦ä¿®æ”¹ä¸º ESMï¼Œä¾‹å¦‚ï¼š\r\n\r\n```typescript\r\nexport default {\r\n    SSO_LOGIN_URL: 'https://xxx.yyy.com',\r\n    SSO_LOGOUT_URL: 'https://xxx.yyy.com/cas/logout',\r\n}\r\n```\r\n\r\n```typescript\r\nimport config from './config';\r\n```\r\n\r\n### 6ã€ç¯å¢ƒå˜é‡çš„ä½¿ç”¨æ–¹å¼\r\n\r\nä½¿ç”¨ vue-cliï¼ˆwebpackï¼‰æ—¶æˆ‘ä»¬ç»å¸¸ä¼šåˆ©ç”¨ç¯å¢ƒå˜é‡æ¥åšè¿è¡Œæ—¶çš„ä»£ç åˆ¤æ–­ï¼Œä¾‹å¦‚ï¼š\r\n\r\n```typescript\r\nconst REPORTER_HOST = process.env.REPORTER_TYPE === 'mock'\r\n  ? 'http://mock-report.xxx.com'\r\n  : 'http://report.xxx.com';\r\n```\r\n\r\n[vite ä»ç„¶æ”¯æŒç¯å¢ƒå˜é‡](https://vitejs.dev/guide/env-and-mode.html#env-variables)çš„ä½¿ç”¨ï¼Œä½†ä¸å†æä¾› `process.env` è¿™æ ·çš„è®¿é—®æ–¹å¼ã€‚è€Œæ˜¯éœ€è¦é€šè¿‡ [`import.meta.env`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/import.meta) æ¥è®¿é—®ç¯å¢ƒå˜é‡ï¼š\r\n\r\n```diff\r\n-const REPORTER_HOST = process.env.REPORTER_TYPE === 'mock'\r\n+const REPORTER_HOST = import.meta.env.REPORTER_TYPE === 'mock'\r\n  ? 'http://mock-report.xxx.com'\r\n  : 'http://report.xxx.com';\r\n```\r\n\r\nä¸ webpack ç±»ä¼¼ï¼Œvite ä¹Ÿ[å†…ç½®äº†ä¸€äº›ç¯å¢ƒå˜é‡](https://vitejs.dev/guide/env-and-mode.html#env-variables)ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚\r\n\r\n### 7ã€`import.meta.env` types\r\n\r\n> è¡¥å……ï¼švite æä¾›äº†å®ƒæ‰€éœ€è¦çš„ types å®šä¹‰ï¼Œå¯ä»¥ç›´æ¥åº”ç”¨ [vite/client](https://github.com/vitejs/vite/blob/v2.0.3/packages/vite/client.d.ts) æ¥å¼•å…¥ï¼Œå¯ä»¥ä¸éœ€è¦é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥è‡ªå·±æ·»åŠ ã€‚\r\n\r\nå¦‚æœåœ¨ typescript ä¸­é€šè¿‡ [`import.meta.env`](https://github.com/microsoft/TypeScript/issues/22861) æ¥è®¿é—®ç¯å¢ƒå˜é‡ï¼Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ª ts é”™è¯¯æç¤ºï¼š`ç±»å‹â€œImportMetaâ€ä¸Šä¸å­˜åœ¨å±æ€§â€œenvâ€`ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/109505944-13e17780-7ad8-11eb-80a2-3bdbd61c241e.png)\r\n\r\nè¿™æ˜¯å› ä¸ºåœ¨ç›®å‰ç‰ˆæœ¬ä¸‹ï¼ˆv4.2.2ï¼‰`import.meta` çš„å®šä¹‰è¿˜æ˜¯ä¸€ä¸ª[ç©ºçš„ interface](https://github.com/microsoft/TypeScript/blob/v4.2.2/lib/lib.es5.d.ts#L608-L615)ï¼š\r\n\r\n```typescript\r\ninterface ImportMeta {\r\n}\r\n```\r\n\r\nä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡ interface çš„ merge èƒ½åŠ›ï¼Œåœ¨é¡¹ç›®ä¸­è¿›ä¸€æ­¥å®šä¹‰ ImportMeta çš„ç±»å‹æ¥æ‹“å±•å¯¹ `import.meta.env` çš„ç±»å‹æ”¯æŒã€‚ä¾‹å¦‚ä¹‹å‰é€šè¿‡ vue-cli ç”Ÿæˆçš„ ts é¡¹ç›®åœ¨ src ç›®å½•ä¸‹ä¼šç”Ÿæˆ `vue-shims.d.ts` æ–‡ä»¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ‹“å±• env ç±»å‹çš„æ”¯æŒï¼š\r\n\r\n```typescript\r\ndeclare global {\r\n  interface ImportMeta {\r\n    env: Record<string, unknown>;\r\n  }\r\n}\r\n```\r\n\r\nè¿™æ ·å°±ä¸ä¼šæŠ¥é”™äº†ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/109505976-1c39b280-7ad8-11eb-824e-e9ca017b0c6a.png)\r\n\r\n### 8ã€webpack require context\r\n\r\nåœ¨ webpack ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ [`require.context`](https://webpack.js.org/api/module-methods/#requirecontext) æ–¹æ³•ã€ŒåŠ¨æ€ã€è§£ææ¨¡å—ã€‚æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ä¸ªåšæ³•å°±æ˜¯æŒ‡å®šæŸä¸ªç›®å½•ï¼Œé€šè¿‡æ­£åˆ™åŒ¹é…ç­‰æ–¹å¼åŠ è½½æŸäº›æ¨¡å—ï¼Œè¿™æ ·åœ¨åç»­å¢åŠ æ–°çš„æ¨¡å—åï¼Œå¯ä»¥èµ·åˆ°ã€ŒåŠ¨æ€è‡ªåŠ¨å¯¼å…¥ã€çš„æ•ˆæœã€‚\r\n\r\nä¾‹å¦‚åœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬åŠ¨æ€åŒ¹é… modules æ–‡ä»¶å¤¹ä¸‹çš„ route.ts æ–‡ä»¶ï¼Œåœ¨å…¨å±€çš„ vue-router ä¸­è®¾ç½® router é…ç½®ï¼š\r\n\r\n```typescript\r\nconst routes = require.context('./modules', true, /([\\w\\d-]+)\\/routes\\.ts/)\r\n    .keys()\r\n    .map(id => context(id))\r\n    .map(mod => mod.__esModule ? mod.default : mod)\r\n    .reduce((pre, list) => [...pre, ...list], []);\r\n\r\nexport default new VueRouter({ routes });\r\n```\r\n\r\næ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š\r\n\r\n```\r\nsrc/modules\r\nâ”œâ”€â”€ admin\r\nâ”‚Â Â  â”œâ”€â”€ pages\r\nâ”‚Â Â  â””â”€â”€ routes.ts\r\nâ”œâ”€â”€ alert\r\nâ”‚Â Â  â”œâ”€â”€ components\r\nâ”‚Â Â  â”œâ”€â”€ pages\r\nâ”‚Â Â  â”œâ”€â”€ routes.ts\r\nâ”‚Â Â  â”œâ”€â”€ store.ts\r\nâ”‚Â Â  â””â”€â”€ utils\r\nâ”œâ”€â”€ environment\r\nâ”‚Â Â  â”œâ”€â”€ store\r\nâ”‚Â Â  â”œâ”€â”€ types\r\nâ”‚Â Â  â””â”€â”€ utils\r\nâ””â”€â”€ service\r\n    â”œâ”€â”€ assets\r\n    â”œâ”€â”€ pages\r\n    â”œâ”€â”€ routes.ts\r\n    â”œâ”€â”€ store\r\n    â””â”€â”€ types\r\n```\r\n\r\nrequire context æ˜¯ webpack æä¾›çš„ç‰¹æœ‰çš„æ¨¡å—æ–¹æ³•ï¼Œå¹¶ä¸æ˜¯è¯­è¨€æ ‡å‡†ï¼Œæ‰€ä»¥åœ¨ vite ä¸­ä¸å†èƒ½ä½¿ç”¨ require contextã€‚ä½†å¦‚æœå®Œå…¨æ”¹ä¸ºå¼€å‘è€…æ‰‹åŠ¨ import æ¨¡å—ï¼Œä¸€æ¥æ˜¯å¯¹å·²æœ‰ä»£ç æ”¹åŠ¨å®¹æ˜“äº§ç”Ÿæ¨¡å—å¯¼å…¥çš„é—æ¼ï¼›äºŒæ¥æ˜¯æ”¾å¼ƒäº†è¿™ç§ã€Œçµæ´»ã€çš„æœºåˆ¶ï¼Œå¯¹åç»­çš„å¼€å‘æ¨¡å¼ä¹Ÿä¼šæœ‰ä¸€å®šæ”¹å˜ã€‚ä½†å¥½åœ¨ vite2.0 æä¾›äº† [glob æ¨¡å¼çš„æ¨¡å—å¯¼å…¥](https://vitejs.dev/guide/features.html#glob-import)ã€‚è¯¥åŠŸèƒ½å¯ä»¥å®ç°ä¸Šè¿°ç›®æ ‡ã€‚å½“ç„¶ï¼Œä¼šéœ€è¦åšä¸€å®šçš„ä»£ç æ”¹åŠ¨ï¼š\r\n\r\n```typescript\r\nconst routesModules = import.meta.globEager<{default: unknown[]}>('./modules/**/routes.ts');\r\nconst routes = Object\r\n  .keys(routesModules)\r\n  .reduce<any[]>((pre, k) => [...pre, ...routesMod[k].default], []);\r\n\r\nexport default new VueRouter({ routes });\r\n```\r\n\r\nä¸»è¦å°±æ˜¯å°† `require.context` æ”¹ä¸º `import.meta.globEager`ï¼ŒåŒæ—¶é€‚é…è¿”å›å€¼ç±»å‹ã€‚å½“ç„¶ï¼Œä¸ºäº†æ”¯æŒ typesï¼Œå¯ä»¥ä¸º ImportMeta æ¥å£æ·»åŠ ä¸€äº›ç±»å‹ï¼š\r\n\r\n```diff\r\ndeclare global {\r\n  interface ImportMeta {\r\n    env: Record<string, unknown>;\r\n+   globEager<T = unknown>(globPath: string): Record<string, T>;\r\n  }\r\n}\r\n```\r\n\r\næ­¤å¤–å†æä¸€ä¸‹ï¼Œ`import.meta.globEager` ä¼šåœ¨æ„å»ºæ—¶åšé™æ€åˆ†æå°†ä»£ç æ›¿æ¢ä¸ºé™æ€ import è¯­å¥ã€‚å¦‚æœå¸Œæœ›èƒ½æ”¯æŒ dynamic importï¼Œè¯·ä½¿ç”¨ `import.meta.glob` æ–¹æ³•ã€‚\r\n\r\n### 9ã€API ä»£ç†\r\n\r\nvite2.0 æœ¬åœ°å¼€å‘æ—¶ï¼ˆDEV æ¨¡å¼ï¼‰ä»ç„¶æä¾›äº†ä¸€ä¸ª HTTP serverï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒ[é€šè¿‡ proxy é¡¹è®¾ç½®ä»£ç†](https://vitejs.dev/config/#server-proxy)ã€‚å…¶èƒŒåå’Œ webpack ä¸€æ ·ä¹Ÿæ˜¯ä½¿ç”¨äº† [http-proxy](https://github.com/http-party/node-http-proxy)ï¼Œå› æ­¤é’ˆå¯¹ vue-cli çš„ proxy è®¾ç½®å¯ä»¥è¿ç§»åˆ° vite ä¸­ï¼š\r\n\r\n```diff\r\nimport { defineConfig } from 'vite';\r\nimport tsconfigPaths from 'vite-tsconfig-paths';\r\nimport { createVuePlugin } from 'vite-plugin-vue2';\r\n+ import proxy from './src/tangram/proxy-table';\r\n\r\nexport default defineConfig({\r\n  plugins: [\r\n    tsconfigPaths(),\r\n    createVuePlugin(),\r\n  ],\r\n+ server: {\r\n+   proxy,\r\n+ }\r\n});\r\n```\r\n\r\n### 10ã€HTML å†…å®¹æ’å…¥\r\n\r\nåœ¨åŸºäº vue-cli ä¸­æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ webpack çš„ HtmlWebpackPlugin æ¥å®ç° HTML ä¸­å€¼çš„æ›¿æ¢ï¼Œä¾‹å¦‚ `<%= htmlWebpackPlugin.options.title %>` è¿™ç§å½¢å¼æ¥å°†è¯¥å¤„æ¨¡æ¿å˜é‡åœ¨ç¼–è¯‘æ—¶ï¼Œæ›¿æ¢ä¸ºå®é™…çš„ title å€¼ã€‚è¦å®ç°è¿™æ ·çš„åŠŸèƒ½ä¹Ÿéå¸¸ç®€å•ï¼Œä¾‹å¦‚ [vite-plugin-html](https://www.npmjs.com/package/vite-plugin-html) ã€‚è¿™ä¸ªæ’ä»¶åŸºäº ejs æ¥å®ç°æ¨¡æ¿å˜é‡æ³¨å…¥ï¼Œé€šè¿‡ `transformIndexHtml` é’©å­ï¼Œæ¥æ”¶åŸå§‹ HTML å­—ç¬¦ä¸²ï¼Œç„¶åé€šè¿‡ ejs æ¸²æŸ“æ³¨å…¥çš„å˜é‡åè¿”å›ã€‚\r\n\r\nä¸‹é¢æ˜¯è¿ç§»åï¼Œä½¿ç”¨ vite-plugin-html çš„é…ç½®æ–¹å¼ï¼š\r\n\r\n```diff\r\nimport { defineConfig } from 'vite';\r\nimport tsconfigPaths from 'vite-tsconfig-paths';\r\nimport { createVuePlugin } from 'vite-plugin-vue2';\r\n+ import { injectHtml } from 'vite-plugin-html';\r\n\r\nexport default defineConfig({\r\n  plugins: [\r\n    tsconfigPaths(),\r\n    createVuePlugin(),\r\n+   injectHtml({\r\n+     injectData: {\r\n+       title: 'ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ',\r\n+     },\r\n    }),\r\n  ],\r\n  server: {\r\n    proxy,\r\n  },\r\n});\r\n```\r\n\r\nå¯¹åº”çš„éœ€æ±‚ä¿®æ”¹ä¸€ä¸‹ HTML çš„æ¨¡æ¿å˜é‡å†™æ³•ï¼š\r\n\r\n```diff\r\n<!DOCTYPE html>\r\n<html lang=\"en\">\r\n\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\r\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1.0\">\r\n- <title><%= htmlWebpackPlugin.options.title %></title>\r\n+ <title><%= title %></title>\r\n</head>\r\n\r\n<body>\r\n  <noscript>\r\n-   We're sorry but <%= htmlWebpackPlugin.options.title %> doesn't work properly without JavaScript enabled.\r\n+   We're sorry but <%= title %> doesn't work properly without JavaScript enabled.\r\n  </noscript>\r\n  <div id=\"app\"></div>\r\n  <script type=\"module\" src=\"/src/main.ts\"></script>\r\n</body>\r\n\r\n</html>\r\n```\r\n\r\n### 11ã€å…¼å®¹æ€§å¤„ç†\r\n\r\nåœ¨é¡¹ç›®èƒŒæ™¯ä»‹ç»ä¸Šæœ‰æåˆ°è¯¥é¡¹ç›®å¯¹å…¼å®¹æ€§è¦æ±‚å¾ˆä½ï¼Œæ‰€ä»¥è¿™å—åœ¨è¿ç§»ä¸­å®é™…å¹¶æœªæ¶‰åŠã€‚\r\n\r\nå½“ç„¶ï¼Œå¦‚æœå¯¹å…¼å®¹æ€§æœ‰è¦æ±‚çš„é¡¹ç›®ï¼Œå¯ä»¥ä½¿ç”¨ [@vitejs/plugin-legacy](https://github.com/vitejs/vite/tree/main/packages/plugin-legacy) æ’ä»¶ã€‚è¯¥æ’ä»¶ä¼šæ‰“åŒ…å‡ºä¸¤å¥—ä»£ç ï¼Œä¸€å¥—é¢å‘æ–°å¼æµè§ˆå™¨ï¼Œå¦ä¸€å¥—åˆ™åŒ…å«å„ç±» polyfill å’Œè¯­æ³•å…¼å®¹æ¥é¢å‘è€å¼æµè§ˆå™¨ã€‚åŒæ—¶åœ¨ HTML ä¸­ä½¿ç”¨ [module/nomodule æŠ€æœ¯](https://philipwalton.com/articles/using-native-javascript-modules-in-production-today/)æ¥å®ç°æ–°/è€æµè§ˆå™¨ä¸­çš„ã€Œæ¡ä»¶åŠ è½½ã€ã€‚\r\n\r\n## æ€»ç»“\r\n\r\nè¯¥é¡¹ç›®åŒ…å« 1897 ä¸ªæ¨¡å—æ–‡ä»¶ï¼ˆåŒ…æ‹¬ node_modules ä¸­æ¨¡å—ï¼‰ï¼Œè¿ç§»å‰åçš„æ„å»ºï¼ˆæ— ç¼“å­˜ï¼‰è€—æ—¶å¦‚ä¸‹ï¼š\r\n\r\n|     | vue-cli  | vite 2 |\r\n|  ----  | ----  | ----  |\r\n| dev æ¨¡å¼ | ~8s | ~400ms |\r\n| prod æ¨¡å¼ | ~42s | ~36s |\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œåœ¨ DEV æ¨¡å¼ä¸‹ vite2 æ„å»ºæ•ˆç‡çš„æå‡éå¸¸æ˜æ˜¾ï¼Œè¿™ä¹Ÿæ˜¯å› ä¸ºå…¶åœ¨ DEV æ¨¡å¼ä¸‹åªåšä¸€äº›è½»é‡çº§æ¨¡å—æ–‡ä»¶å¤„ç†ï¼Œä¸ä¼šåšè¾ƒé‡çš„æ‰“åŒ…å·¥ä½œï¼Œè€Œåœ¨ç”Ÿäº§æ¨¡å¼ä¸‹ï¼Œç”±äºä»ç„¶éœ€è¦ä½¿ç”¨ esbuild å’Œ rollup åšæ„å»ºï¼Œæ‰€ä»¥åœ¨è¯¥é¡¹ç›®ä¸­æ•ˆç‡æå‡å¹¶ä¸æ˜æ˜¾ã€‚\r\n\r\n---\r\n\r\nä»¥ä¸Šå°±æ˜¯ç¬”è€…åœ¨åš vue-cli è¿ç§» vite 2.0 æ—¶ï¼Œé‡åˆ°çš„ä¸€äº›é—®é¢˜ã€‚éƒ½æ˜¯ä¸€äº›æ¯”è¾ƒå°çš„ç‚¹ï¼Œæ•´ä½“è¿ç§»ä¸Šå¹¶æœªé‡åˆ°å¤ªå¤§çš„é˜»ç¢ï¼Œç”¨äº†ä¸åˆ°åŠå¤©æ—¶é—´å°±è¿ç§»äº†ã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿæœ‰èµ–äºè¿‘å¹´æ¥ JavaScriptã€HTML ç­‰æ ‡å‡†åŒ–å·¥ä½œä½¿å¾—æˆ‘ä»¬å†™çš„ä¸»æµä»£ç ä¹Ÿèƒ½å¤Ÿå…·å¤‡ä¸€å®šçš„ç»Ÿä¸€æ€§ã€‚è¿™ä¹Ÿæ˜¯è¿™äº›å‰ç«¯å·¥å…·è®©æˆ‘ä»¬ã€Œé¢å‘æœªæ¥ã€ç¼–ç¨‹å¸¦æ¥çš„ä¸€å¤§ä¼˜ç‚¹ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿç»™ï¼Œå‡†å¤‡å°è¯•è¿ç§»åˆ° vite 2.0 çš„å„ä½æœ‹å‹ä¸€äº›å‚è€ƒã€‚","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/43","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/43/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/43/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/43/events","html_url":"https://github.com/alienzhou/blog/issues/43","id":748529110,"node_id":"MDU6SXNzdWU3NDg1MjkxMTA=","number":43,"title":"å¦‚ä½•å®ç°å¯å¤ç”¨çš„æ§åˆ¶å°â€œè‰ºæœ¯å­—â€æ‰“å°","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":2045616625,"node_id":"MDU6TGFiZWwyMDQ1NjE2NjI1","url":"https://api.github.com/repos/alienzhou/blog/labels/Node.js","name":"Node.js","color":"c3ea81","default":false,"description":""},{"id":1159845016,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%BB%BC%E5%90%88","name":"ç»¼åˆ","color":"a2eeef","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-11-23T06:59:49Z","updated_at":"2021-03-01T13:55:47Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"ä¹‹å‰åœ¨ä½¿ç”¨ä¸€äº›å¼€æºé¡¹ç›®æ—¶ï¼Œç»å¸¸ä¼šçœ‹åˆ°åœ¨æ§åˆ¶å°è¾“å‡ºé¡¹ç›®å¤§å¤§çš„ LOGOã€‚ä¾‹å¦‚ï¼š\r\n\r\n- hexo minos ä¸»é¢˜å¯åŠ¨æ—¶åœ¨æ§åˆ¶å°é‡Œä¼šæ˜¾ç¤ºã€ŒMINOSã€æ–‡æ¡ˆ\r\n- fis3 å¯åŠ¨æ—¶ä¹Ÿä¼šæœ‰æ˜¾ç¤ºã€ŒFISã€\r\n\r\næ·»åŠ è¿™ç§å¤§å·ã€Œè‰ºæœ¯å­—ã€å¯ä»¥è¾¾åˆ°ã€Œå“ç‰Œéœ²å‡ºã€çš„æ•ˆæœï¼Œå½“ç„¶ï¼Œä¹Ÿæ˜¯ç¨‹åºå‘˜ç‰¹æœ‰ã€Œæƒ…è¶£ã€çš„ä½“ç°ã€‚ ğŸ˜„\r\n\r\nä½†å®ƒä»¬çš„å®ç°æ–¹å¼æ— å¤–ä¹æŠŠç¼–æ’å¥½çš„ Logo é€šè¿‡ `console.log` è¾“å‡ºã€‚è¿™ç§æ–¹å¼é—®é¢˜åœ¨äºå®ƒå‡ ä¹æ²¡æœ‰ä»»ä½•å¤ç”¨èƒ½åŠ›ï¼Œè€Œä¸”ä¸€äº›éœ€è¦è½¬ä¹‰çš„æƒ…å†µè¿˜ä¼šå¯¼è‡´å­—ç¬¦ä¸²çš„å¯ç»´æŠ¤æ€§æå·®ã€‚å› æ­¤ï¼Œæˆ‘èŠ±äº†ä¸€ä¸ªå‘¨æœ«çš„æ—¶å€™ï¼Œå®ç°äº†ä¸€ä¸ªæ˜“ç”¨çš„ã€å¯å¤ç”¨çš„æ§åˆ¶å°ã€Œè‰ºæœ¯å­—ã€libã€‚è¿™æ ·ï¼Œä¸‹æ¬¡æœ‰æ–°çš„éœ€æ±‚ï¼Œåªéœ€è¦æŠŠæ­£å¸¸çš„æ–‡æœ¬ä¼ ç»™å®ƒï¼Œå®ƒå°±å¯ä»¥å¸®ä½ **è‡ªåŠ¨ç¼–æ’ä¸æ‰“å°**ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/99935706-4a527c80-2d9c-11eb-8e36-a455808a03c4.png)\r\n\r\n## 1. ç›®æ ‡\r\n\r\næ­£å¦‚ä¸ŠèŠ‚æ‰€è¯´ï¼Œç›®å‰ä¸€èˆ¬é¡¹ç›®çš„åšæ³•éƒ½æ˜¯è‡ªå®šå†™ä¸€ä¸²ç‰¹å®šçš„æ–‡æœ¬ï¼Œä¾‹å¦‚ minosï¼š\r\n\r\n```JavaScript\r\nlogger.info(`=======================================\r\nâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—\r\nâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â•â•â•\r\nâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—\r\nâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â•šâ•â•â•â•â–ˆâ–ˆâ•‘\r\nâ–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘\r\nâ•šâ•â•     â•šâ•â• â•šâ•â• â•šâ•â•  â•šâ•â•â•â•  â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•â•\r\n=============================================`);\r\n```\r\n\r\nè¿˜æœ‰ fis3 è¿™ç§ç”±äºéœ€è¦æ·»åŠ è½¬ä¹‰æ‰€ä»¥æ˜¾å¾—å‡Œä¹±ä¸å¥½ç»´æŠ¤çš„\r\n\r\n```JavaScript\r\nlogo = [\r\n      '   /\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\  /\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\     /\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\   ',\r\n      '   \\\\/\\\\\\\\\\\\///////////  \\\\/////\\\\\\\\\\\\///    /\\\\\\\\\\\\/////////\\\\\\\\\\\\        ',\r\n      '    \\\\/\\\\\\\\\\\\                 \\\\/\\\\\\\\\\\\      \\\\//\\\\\\\\\\\\      \\\\///  ',\r\n      '     \\\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\         \\\\/\\\\\\\\\\\\       \\\\////\\\\\\\\\\\\              ',\r\n      '      \\\\/\\\\\\\\\\\\///////          \\\\/\\\\\\\\\\\\          \\\\////\\\\\\\\\\\\          ',\r\n      '       \\\\/\\\\\\\\\\\\                 \\\\/\\\\\\\\\\\\             \\\\////\\\\\\\\\\\\      ',\r\n      '        \\\\/\\\\\\\\\\\\                 \\\\/\\\\\\\\\\\\      /\\\\\\\\\\\\      \\\\//\\\\\\\\\\\\  ',\r\n      '         \\\\/\\\\\\\\\\\\              /\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\///\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\/   ',\r\n      '          \\\\///              \\\\///////////    \\\\///////////     ',\r\n      ''\r\n    ].join('\\n');\r\n```\r\n\r\nè¿™ç§äº›æ–¹å¼éƒ½æ˜¯é€šè¿‡ã€Œç¡¬ç¼–ç ã€æ¥å®ç°çš„ï¼Œå¦‚æœæœ‰äº†æ–°é¡¹ç›®æˆ–éœ€æ±‚å˜åŠ¨è¿˜å¾—é‡æ–°ç¼–æ’è°ƒæ•´ã€‚\r\n\r\nå› æ­¤ï¼Œå‡†å¤‡å®ç°ä¸€ç§èƒ½å¤Ÿæ ¹æ®è¾“å…¥çš„å­—ç¬¦ä¸²è¿›è¡Œè‡ªåŠ¨æ’ç‰ˆå±•ç¤ºçš„æ§åˆ¶å°ã€Œè‰ºæœ¯å­—ã€æ‰“å°åº“ï¼Œä¾‹å¦‚é€šè¿‡ `yo('yoo-hoo')` å°±ä¼šè¾“å‡ºï¼š\r\n\r\n```text\r\n /\\\\\\    /\\\\\\  /\\\\\\\\\\\\\\\\      /\\\\\\\\\\\\\\\\                /\\\\\\    /\\\\\\    /\\\\\\\\\\\\\\\\      /\\\\\\\\\\\\\\\\\r\n \\/\\\\\\   /\\\\\\ /\\\\\\_____/\\\\\\  /\\\\\\_____/\\\\\\             \\/\\\\\\   \\/\\\\\\  /\\\\\\_____/\\\\\\  /\\\\\\_____/\\\\\\\r\n   \\/_\\\\\\/\\\\\\ \\/\\\\\\    \\/\\\\\\ \\/\\\\\\    \\/\\\\\\             \\/\\\\\\   \\/\\\\\\ \\/\\\\\\    \\/\\\\\\ \\/\\\\\\    \\/\\\\\\\r\n      \\/_\\\\\\\\  \\/\\\\\\    \\/\\\\\\ \\/\\\\\\    \\/\\\\\\  /\\\\\\\\\\\\\\\\\\ \\/\\\\\\\\\\\\\\\\\\\\\\ \\/\\\\\\    \\/\\\\\\ \\/\\\\\\    \\/\\\\\\\r\n         \\/\\\\\\  \\/\\\\\\    \\/\\\\\\ \\/\\\\\\    \\/\\\\\\ \\/_______/  \\/\\\\\\____/\\\\\\ \\/\\\\\\    \\/\\\\\\ \\/\\\\\\    \\/\\\\\\\r\n          \\/\\\\\\  \\/\\\\\\    \\/\\\\\\ \\/\\\\\\    \\/\\\\\\             \\/\\\\\\   \\/\\\\\\ \\/\\\\\\    \\/\\\\\\ \\/\\\\\\    \\/\\\\\\\r\n           \\/\\\\\\  \\/_/\\\\\\\\\\\\\\\\\\  \\/_/\\\\\\\\\\\\\\\\\\              \\/\\\\\\   \\/\\\\\\ \\/_/\\\\\\\\\\\\\\\\\\  \\/_/\\\\\\\\\\\\\\\\\\\r\n            \\/_/     \\/_______/     \\/_______/               \\/_/    \\/_/    \\/_______/     \\/_______/\r\n```\r\n\r\nä¸‹æ¬¡å¦‚æœæ–‡æ¡ˆæ”¹äº†ï¼Œç›´æ¥æ¢ä¸‹å­—ç¬¦ä¸²å‚æ•°å°±è¡Œ â€”â€” `yo('new-one')`ï¼š\r\n\r\n```text\r\n/\\\\\\\\\\     /\\\\\\  /\\\\\\\\\\\\\\\\\\\\  /\\\\\\  \\\\\\  \\\\\\                /\\\\\\\\\\\\\\\\    /\\\\\\\\\\     /\\\\\\  /\\\\\\\\\\\\\\\\\\\\\r\n\\/\\\\\\ \\\\\\  \\/\\\\\\ \\/\\\\\\_____/  \\/\\\\\\  \\\\\\  \\\\\\              /\\\\\\_____/\\\\\\ \\/\\\\\\ \\\\\\  \\/\\\\\\ \\/\\\\\\_____/\r\n \\/\\\\\\ /\\\\\\ \\/\\\\\\ \\/\\\\\\        \\/\\\\\\  \\\\\\  \\\\\\             \\/\\\\\\    \\/\\\\\\ \\/\\\\\\ /\\\\\\ \\/\\\\\\ \\/\\\\\\\r\n  \\/\\\\\\  /\\\\\\ /\\\\\\ \\/\\\\\\\\\\\\\\\\\\\\ \\/\\\\\\  \\\\\\  \\\\\\  /\\\\\\\\\\\\\\\\\\ \\/\\\\\\    \\/\\\\\\ \\/\\\\\\  /\\\\\\ /\\\\\\ \\/\\\\\\\\\\\\\\\\\\\\\r\n   \\/\\\\\\ \\/\\\\\\ /\\\\\\ \\/\\\\\\_____/  \\/\\\\\\  \\\\\\  \\\\\\ \\/_______/  \\/\\\\\\    \\/\\\\\\ \\/\\\\\\ \\/\\\\\\ /\\\\\\ \\/\\\\\\_____/\r\n    \\/\\\\\\ \\ /\\\\\\ \\\\\\ \\/\\\\\\        \\/\\\\\\ \\\\\\\\\\ \\\\\\             \\/\\\\\\    \\/\\\\\\ \\/\\\\\\ \\ /\\\\\\ \\\\\\ \\/\\\\\\\r\n     \\/\\\\\\  \\/_\\\\\\\\\\\\ \\/\\\\\\\\\\\\\\\\\\\\ \\/\\\\\\\\\\__/\\\\\\\\\\             \\/_/\\\\\\\\\\\\\\\\\\  \\/\\\\\\  \\/_\\\\\\\\\\\\ \\/\\\\\\\\\\\\\\\\\\\\\r\n      \\/_/    \\/____/  \\/________/  \\/_/      \\/_/                \\/_______/   \\/_/    \\/____/  \\/________/\r\n```\r\n\r\næ€»ç»“æ¥è¯´ï¼Œå°±æ˜¯å®ç°ä¸€ä¸ªé€šç”¨çš„ã€å¯å¤ç”¨çš„æ§åˆ¶å°ã€Œè‰ºæœ¯å­—ã€æ‰“å°åŠŸèƒ½ã€‚åŸºäºè¿™ä¸ªç›®æ ‡å¼€å‘äº† [yoo-hoo](https://github.com/alienzhou/yoo-hoo) è¿™ä¸ªåº“ã€‚\r\n\r\nä¸‹é¢æ¥è¯´è¯´å¤§è‡´æ€ä¹ˆå®ç°ã€‚\r\n\r\n## 2. å¦‚ä½•å®ç°\r\n\r\nå’Œå…¶ä»–å­—ä½“æ˜¾ç¤ºçš„éœ€æ±‚ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†åŠŸèƒ½æŠ½è±¡ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š\r\n\r\n1. å­—ä½“åº“çš„ç”Ÿæˆ\r\n2. å­—ä½“çš„æ’ç‰ˆ\r\n3. å­—ä½“çš„æ¸²æŸ“\r\n\r\nè¿™é‡Œæˆ‘ä»¬å…ˆè¯´ä¸€ä¸‹å­—ä½“çš„æ¸²æŸ“ã€‚\r\n\r\n### 2.1. å­—ä½“æ¸²æŸ“\r\n\r\nä¹‹æ‰€ä»¥å…ˆè¯´è¿™éƒ¨åˆ†ï¼Œæ˜¯å› ä¸ºå®ƒä¼šå½±å“æ’ç‰ˆä¿¡æ¯çš„è¾“å‡ºæ ¼å¼ã€‚\r\n\r\nå…¶å®å­—ä½“æ¸²æŸ“è¿™éƒ¨åˆ†å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œæˆ‘ä»¬åœ¨æ§åˆ¶å°è¿™ä¸ªç¯å¢ƒï¼Œå—é™äº APIï¼ŒåŸºæœ¬å°±æ˜¯ä½¿ç”¨ `console.log` æ¥å°†å†…å®¹ã€Œæ¸²æŸ“ã€åˆ°å±å¹•ä¸Šã€‚ä¸è¿‡ï¼Œæ­£æ˜¯è¿™é‡Œçš„ã€Œæ¸²æŸ“ã€å½¢å¼çš„é™åˆ¶ï¼Œä¼šå€’æ¨æˆ‘ä»¬çš„æ’ç‰ˆæ–¹å¼ã€‚\r\n\r\næˆ‘ä»¬çŸ¥é“ï¼Œæ§åˆ¶å°åŸºæœ¬éƒ½æ˜¯å•è¡Œé¡ºåºæ¸²æŸ“çš„ï¼Œå¤§è‡´å°±æ˜¯ã€ŒZã€å­—å‹ã€‚åŒæ—¶ï¼Œç”±äºæˆ‘ä»¬çš„ã€Œè‰ºæœ¯å­—ã€ä¼šå æ®å¤šè¡Œï¼Œæ‰€ä»¥æœ€ç»ˆçš„æ¸²æŸ“ä¸æ˜¯æŒ‰å•ä¸ªå­—é¡ºåºæ¸²æŸ“çš„ï¼Œéœ€è¦å…ˆæ’å¥½ç‰ˆï¼Œç„¶åæŒ‰è¡Œæ¥é€æ­¥æ¸²æŸ“åˆ°å±å¹•ä¸Šã€‚\r\n\r\nè¿™æœ‰ç‚¹åƒæ˜¯å’±ä»¬å¸¸è§çš„æ‰“å°æœºã€‚å¦‚æœä½ è¦æ‰“å°ä¸€ä¸ªè‹¹æœï¼Œå®ƒä¼šä»ä¸Šå¾€ä¸‹é€æ­¥æ‰“å°å‡ºè¿™ä¸ªè‹¹æœï¼Œè€Œä¸æ˜¯ç›´æ¥åƒç›–ç« é‚£æ ·\b\bç›´æ¥å°åˆ·ä¸€ä¸ªè‹¹æœã€‚\r\n\r\nä¸‹é¢æˆ‘ä»¬ä¼šå…ˆä»‹ç»å­—ä½“åº“çš„ç”Ÿæˆï¼Œè€Œä¸æ˜¯ç´§æ¥æŒ¨ç€çš„å­—ä½“æ’ç‰ˆã€‚å› ä¸ºæ’ç‰ˆæ˜¯ä¸€ä¸ªæ‰¿ä¸Šå¯ä¸‹çš„è¿‡ç¨‹ï¼Œå½“æˆ‘ä»¬ç¡®å®šäº†ä¸Šä¸‹æ¸¸ç¯èŠ‚ï¼Œè¿™å—çš„é€»è¾‘è‡ªç„¶ä¹Ÿå°±ç¡®å®šäº†ã€‚\r\n\r\n### 2.2. å­—ä½“åº“ç”Ÿæˆ\r\n\r\nå½“æˆ‘ä»¬æƒ³è¦å®ç°å¯å¤ç”¨èƒ½åŠ›æ—¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰¾åˆ°æˆ–è€…æŠ½è±¡å‡ºç³»ç»Ÿå†…é€»è¾‘ä¸Šçš„æœ€å°å¯å¤ç”¨å•å…ƒ â€”â€” åœ¨è¿™é‡Œæ˜¾ç„¶å°±æ˜¯å­—ç¬¦ã€‚ç®€å•æ¥è¯´ï¼Œå¯¹äºè¾“å…¥å­—ç¬¦ä¸² `JS` æ—¶ï¼Œå¦‚æœæˆ‘ä»¬èƒ½æ‰¾åˆ°å¯¹åº”çš„ J å’Œ S çš„å­—ç¬¦è¡¨ç¤ºå½¢å¼ï¼Œè¾…ä»¥æ’ç‰ˆï¼Œç†è®ºä¸Šå°±æœ‰èƒ½åŠ›å®ç°æˆ‘ä»¬çš„ç›®æ ‡ã€‚è¿™æœ‰ç‚¹åƒæ˜¯å’±ä»¬è€ç¥–å®—çš„æ´»å­—å°åˆ·æœ¯ã€‚\r\n\r\næ‰€ä»¥åœ¨å­—ä½“åº“è¿™é‡Œï¼Œæˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ªå­—ä¹‰ä¸å­—å‹çš„æ˜ å°„ã€‚è¿™ä¸ªå…¶å®å’Œå’±ä»¬å‰ç«¯å¸¸è§çš„å­—ä½“æ–‡ä»¶å†…æ ¼å¼çš„æ€æƒ³ä¸€æ ·ï¼Œéƒ½éœ€è¦æœ‰è¿™ä¹ˆä¸€ä¸ªæ˜ å°„å…³ç³»ã€‚\r\n\r\nå­—å‹å“ªé‡Œæ¥å‘¢ï¼Ÿå¥½å§ï¼Œæˆ‘ä¹Ÿæ˜¯ç”¨äº†ä¸€ä¸ªç¬¨åŠæ³• â€”â€” è‡ªå·±ã€Œæ‰‹ç»˜ã€ğŸ˜‚ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢å°±æ˜¯æˆ‘ã€Œæ‰‹ç»˜ã€çš„ 1ï¼š\r\n\r\n```text\r\n1\r\n  /\\\\\\\r\n/\\\\\\\\\\\\\r\n\\/__/\\\\\\\r\n    \\/\\\\\\\r\n     \\/\\\\\\\r\n      \\/\\\\\\\r\n      /\\\\\\\\\\\\\\\r\n      \\/_____/\r\n```\r\n\r\nç»˜åˆ¶çš„è¿‡ç¨‹æ˜¯æ¯ç‡¥çš„ï¼Œå¥½å†å¾ˆå¤šå­—å‹çš„å±€éƒ¨æ˜¯æœ‰ä¸€å®šå¤ç”¨çš„ï¼Œç®€åŒ–äº†è¿™é¡¹ç¹ççš„å·¥ä½œã€‚å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€æ¬¡æ€§çš„å·¥ä½œï¼Œä¸€æ—¦åˆ›å»ºå¥½ä¸€ç±»ã€Œå­—ä½“ã€ï¼Œä»¥åå°±ä¸éœ€è¦å†é‡å¤è¿™é¡¹å·¥ä½œäº†ã€‚\r\n\r\næˆ‘æŠŠä¸Šé¢è¿™ä¸ªå†…å®¹å­˜åœ¨ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œç›®å‰ç›´æ¥ä»¥ .txt ä¸ºåç¼€ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„å­—ä½“åŸå§‹æ ¼å¼ã€‚ä¹‹æ‰€ä»¥ä¸æ”¾åœ¨ .js ä¸­ï¼Œæ˜¯å› ä¸º JavaScript ä¸­ `\\` æ˜¯æƒ³è¦è½¬ä¹‰çš„ï¼Œè¿™æ ·æ–‡æœ¬çš„è§†è§‰å’Œæœ€åçš„å‘ˆç°æ•ˆæœå°±ä¸ä¸€è‡´äº†ï¼Œä¸åˆ©äºè°ƒè¯•å’Œç»´æŠ¤ã€‚\r\n\r\nåŸå§‹å­—ä½“æ–‡ä»¶åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š\r\n\r\n- ä¸Šé¢ç¬¬ä¸€è¡Œæ˜¯å­—ä¹‰ï¼Œæ”¯æŒä¸€ä¸ªå¤šä¸ªå­—ä¹‰å¯¹åº”ä¸€ä¸ªå›¾å½¢ã€‚ä¾‹å¦‚ `Â·` å’Œ `*` æˆ‘ä½¿ç”¨äº†åŒä¸€ä¸ªå›¾å½¢ã€‚å¤šä¸ªå­—ä¹‰é—´ç©ºæ ¼åˆ†å‰²ï¼Œä¸æ¢è¡Œã€‚\r\n- é™¤å»ç¬¬ä¸€è¡Œï¼Œå‰©ä¸‹çš„å†…å®¹å°±æ˜¯å­—å‹ã€‚\r\n\r\nç†è®ºä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä»¥è¿™ä¸ªåŸå§‹å­—ä½“æ–‡ä»¶æ¥ä½œä¸ºå­—ä½“åº“äº†ï¼Œé€šè¿‡ NodeJS ä¸­çš„ `fs` æ¨¡å—è¯»å–å¹¶è§£ææ–‡ä»¶å†…å®¹å³å¯å¾—åˆ°æ˜ å°„å…³ç³»ã€‚\r\n\r\nä½†æˆ‘å¸Œæœ›å®ƒä¹Ÿèƒ½åœ¨é NodeJS ç¯å¢ƒï¼ˆä¾‹å¦‚æµè§ˆå™¨ï¼‰ä¸­ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸èƒ½ä¾èµ– `fs` æ¨¡å—ã€‚è¿™é‡Œåšäº†ä¸€ä¸ªåŸå§‹æ–‡ä»¶çš„è§£æè„šæœ¬ï¼Œç”Ÿæˆå¯¹åº”çš„ JS æ¨¡å—ã€‚ç”±äºæˆ‘ä»¬å¹¶ä¸ç›´æ¥ç»´æŠ¤è¿™äº›ç”Ÿæˆçš„ JS æ¨¡å—ï¼Œæ‰€ä»¥å®ƒçš„å¯è¯»æ€§ä¸é‡è¦ï¼Œå¯ä»¥è®¾è®¡æ•°æ®æ ¼å¼çš„æ—¶å€™å¯ä»¥å®Œå…¨é¢å‘åç»­çš„æ’ç‰ˆæµç¨‹ã€‚\r\n\r\né¦–å…ˆå®ç°ä¸€ä¸ªç®€å•çš„è§£æå™¨æ¥è§£æç¬¬ä¸€è¡Œçš„å­—ä¹‰ã€‚è¿™ä¹Ÿç±»ä¼¼ä¸€ä¸ªè¯æ³•è§£æå™¨ï¼Œä½†ç”±äºè¯­æ³•è§„åˆ™æå…¶å¼±æ™ºï¼ˆç®€å•ï¼‰ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸ç”¨å¤šè¯´äº†ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š\r\n\r\n```typescript\r\nconst parseDefinition = function (line: string) {\r\n    let token = '';\r\n    const defs: string[] = [];\r\n    for (const char of line) {\r\n        if (char === ' ' && token) {\r\n            defs.push(token);\r\n            token = '';\r\n        }\r\n        if (char !== ' ') {\r\n            token += char;\r\n        }\r\n    }\r\n    if (token) {\r\n        defs.push(token);\r\n    }\r\n    return defs;\r\n}\r\n```\r\n\r\nä¸‹é¢å°±æ˜¯å¤„ç†å­—å‹éƒ¨åˆ†ã€‚ä¹‹æ‰€ä»¥éœ€è¦å¤„ç†å­—å‹ï¼Œæ˜¯å› ä¸ºä¸Šé¢æåˆ°çš„è½¬ä¹‰é—®é¢˜ã€‚ç”±äºæˆ‘ä»¬åœ¨åŸå§‹æ ¼å¼ä¸­ä½¿ç”¨äº† `\\` æ¥è¿›è¡Œå­—å‹å±•ç¤ºï¼Œè€Œå°†å…¶ç›´æ¥æ”¾å…¥ç”Ÿæˆçš„ JS æ–‡ä»¶ä¸­è¿™ä¸ª `\\` å°±å˜ä¸ºäº†è½¬ä¹‰ç¬¦ï¼Œè¦æƒ³æ­£å¸¸å±•ç¤ºéœ€è¦å˜ä¸º `\\\\`ã€‚ä¸€ç§æ–¹å¼æ˜¯æ­£åˆ™åŒ¹é…ï¼Œå°†æ‰€æœ‰æºæ–‡æœ¬ä¸­çš„ `\\` æ›¿æ¢ä¸º `\\\\` å†å†™å…¥ã€‚ä½†æˆ‘é€‰æ‹©äº†å¦ä¸€ç§æ–¹å¼ã€‚\r\n\r\nå°†å­—ç¬¦é€šè¿‡ `.charCodeAt` æ–¹æ³•è½¬ä¸º char code å­˜å‚¨ï¼Œè¯»å–å­—ä½“ä¿¡æ¯æ—¶å†é€šè¿‡ `String.fromCharCode` è½¬å›æ¥ã€‚åŸæ¥çš„å­—ç¬¦ä¸²å˜æˆäº†æ•°å­—ç±»å‹çš„æ•°ç»„ï¼Œè¿™æ ·å°±æ²¡æœ‰ç‰¹æ®Šå­—ç¬¦çš„é—®é¢˜äº†ã€‚æœ€åï¼Œé€šè¿‡æ‹¼æ¥æ–‡æœ¬å¹¶ç”Ÿæˆ JS æ–‡ä»¶æ¥å°†åŸå§‹çš„ã€åˆ©äºäººç»´æŠ¤çš„å­—ä½“æ–‡ä»¶ï¼Œè½¬æˆäº†ç¼–è¯‘ JS å·¥ä½œçš„æ¨¡å—ã€‚\r\n\r\n```typescript\r\nconst arrayToString = <T>(arr: T[]) => '[' + arr.map(d => `'${d}'`).join(',') + ']';\r\n\r\nconst text = parsedFonts.reduce((t, f, idx) => {\r\n    return t + (\r\n        '\\n/**\\n'\r\n        + f.content\r\n        + '\\n*/\\n'\r\n        + `fonts[${idx}] = {\\n`\r\n        + `  defs: ${arrayToString(f.defs)},\\n`\r\n        + `  codes: ${arrayToString(f.codes)}\\n`\r\n        + '};\\n'\r\n    );\r\n}, '');\r\nconst moduleText = (\r\n    'const fonts = [];\\n'\r\n    + text\r\n    + 'module.exports.fonts = fonts;\\n'\r\n);\r\n\r\nfs.writeFileSync(fontFilepath, moduleText, 'utf-8');\r\n```\r\n\r\nå…¶ä¸­ defs å°±æ˜¯è¿™ä¸ªå­—å‹å¯¹åº”çš„å­—ä¹‰åˆ—è¡¨ï¼Œcodes åˆ™æ˜¯å­—å‹çš„ char code æ•°ç»„ï¼Œæ‰€æœ‰çš„å­—ä½“éƒ½è¢«æ”¾åœ¨ä¸€ä¸ª JS æ–‡ä»¶ä¸­ã€‚\r\n\r\nè¿™é‡Œæä¸€ä¸‹ï¼Œç¬¬ 3 è¡Œçš„ `parsedFonts` å°±æ˜¯éå†æ‰€æœ‰åŸå§‹å­—ä½“æ–‡ä»¶è§£æåˆ°çš„å†…å®¹ï¼Œå› æ­¤å¾—åˆ°è¿™éƒ¨åˆ†ä¹Ÿæ˜¯éœ€è¦é€šè¿‡ NodeJS çš„ `fs` æ¨¡å—æ¥é€’å½’è¯»å–æºæ–‡ä»¶ç›®å½•ä¸‹çš„å­—ä½“æ–‡ä»¶çš„ã€‚ç®—æ˜¯åŸºæ“ï¼Œå°±ä¸ç”¨å±•å¼€äº†ã€‚\r\n\r\nç”±äºè¿™éƒ¨åˆ†æ˜¯å¯ä»¥æå‰è§£æç¼–è¯‘çš„ï¼Œä¸€æ—¦ç”Ÿæˆäº† JS æ¨¡å—åå°±ä¸ä¼šå¯¹ NodeJS è¿è¡Œæ—¶æœ‰ä¾èµ–ï¼Œæ‰€ä»¥ä¿è¯äº†å…¶ä¾ç„¶å¯ä»¥è¿è¡Œåœ¨æµè§ˆå™¨ä¸­ã€‚\r\n\r\n### 2.3. å­—ä½“çš„æ’ç‰ˆ\r\n\r\næˆ‘ä»¬çš„å­—ä½“æ ¼å¼ç¡®å®šäº†ï¼Œç›®æ ‡çš„æ¸²æŸ“æ–¹å¼ä¹Ÿç¡®å®šäº†ã€‚æœ€åå°±å¯ä»¥å¡«å……è¿™éƒ¨åˆ†çš„é€»è¾‘å®ç°äº†ã€‚\r\n\r\nå…·ä½“æ’ç‰ˆä¸Šä¼šé‡åˆ°ä¸€äº›ç»†èŠ‚ç‚¹ï¼Œä¾‹å¦‚ä¸ç­‰é«˜å­—ä½“çš„ç©ºè¡Œå¡«å……ã€æœ€å¤§è¡Œå®½çš„æ¢è¡Œåˆ¤æ–­ï¼ˆéœ€è¦ç”¨æˆ·æ‰§è¡Œè¡Œå®½ï¼‰ï¼Œä¸è¿‡è¿™äº›éƒ½æ˜¯å°ç‚¹ï¼Œå¤„ç†ä¹Ÿä¸å¤ªå¤æ‚ã€‚è¿™é‡Œå¯èƒ½ä»‹ç»ä¸€ä¸‹ç¨æœ‰ç‰¹æ®Šçš„ä¸€å— â€”â€” å­—é—´è·è°ƒæ•´ã€‚\r\n\r\næˆ‘ä»¬çŸ¥é“ï¼Œä¸€äº›è‰ºæœ¯å­—çš„å€¾æ–œç¨‹åº¦å¯èƒ½å¾ˆå¤§ï¼Œä¾‹å¦‚è¿™ä¸ªå­—ç¬¦ã€Œ1ã€ï¼š\r\n\r\n```text\r\n  /\\\\\\\r\n/\\\\\\\\\\\\\r\n\\/__/\\\\\\\r\n    \\/\\\\\\\r\n     \\/\\\\\\\r\n      \\/\\\\\\\r\n      /\\\\\\\\\\\\\\\r\n      \\/_____/\r\n```\r\n\r\nå¦‚æœæŒ‰ç®€å•çš„çŸ©å½¢å‹åŒ…å›´ç›’æ¥åˆ†é…ç©ºé—´ï¼Œå¤§æ¦‚ä¼šæ˜¯ä¸‹é¢è¿™æ ·ï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/99935762-69e9a500-2d9c-11eb-82bc-64406030d8fe.png)\r\n\r\nå‰åä¸¤ä¸ªå­—ä½“ï¼Œå³ä½¿è®¾ç½®ä¸ºæœ€å°é—´è·ï¼ˆ0ï¼‰ï¼Œä»ç„¶ä¼šè·ç¦»å¾ˆè¿œï¼Œè¿™æ ·å°±ç ´åäº†ä¸€å®šçš„æ˜¾ç¤ºæ•ˆæœã€‚ä¾‹å¦‚ä¸Šå›¾ä¸­æˆ‘ä¸¤ä¸ªåŒ…å›´ç›’é—´è·å…¶å®åªæœ‰ 1ï¼Œä½†çœ‹èµ·æ¥å°±å¾ˆå¤§ã€‚æˆ‘ä»¬å®é™…å¸Œæœ›çš„å¯èƒ½æ˜¯ä¸‹é¢è¿™æ ·ï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/99935801-808ffc00-2d9c-11eb-8c66-62e50570aa97.png)\r\n\r\né—´è·ä¸º 1 æ—¶ï¼Œä¸¤ä¸ªå­—ç¬¦ã€Œ1ã€è°ƒæ•´ä¸ºåœ¨æœ€è¿‘çš„åœ°æ–¹é—´è·ä¸º 1ã€‚å¦‚æœè¦æ›´å®½çš„æ•ˆæœå¯ä»¥è®¾ç½®æ›´å¤šé—´è·ã€‚è¿™ä¸ªå¤„ç†èµ·æ¥ä¸»è¦å°±æ˜¯éœ€è¦ç®—å‡ºæœ€å¤§çš„ã€ŒæŒ¤å‹ç©ºé—´ã€ï¼ˆå³ä¸¤ä¸ªç›’å­æœ€å¤§æ”¯æŒçš„äº¤å‰ç©ºé—´ï¼‰ã€‚æœ€å¼€å§‹æ¸²æŸ“çš„æ—¶å€™è¯´äº†ï¼Œæˆ‘ä»¬æ˜¯æŒ‰ console å‡ºçš„è¡Œæ¥å­˜å‚¨çš„ä¸æ‰“å°çš„ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œè¿™ä¸ªã€Œ1ã€é«˜åº¦ä¸º 8 ï¼Œæ‰€ä»¥æ¸²æŸ“çš„æ—¶å€™å°±æ˜¯ä¸€ä¸ª 8 ä¸ªå…ƒç´ çš„å­—ç¬¦ä¸²æ•°ç»„ï¼š\r\n\r\n```text\r\nconst lines = [\r\n    '  /\\\\\\',\r\n    '/\\\\\\\\\\\\',\r\n    '\\/__/\\\\\\',\r\n    '    \\/\\\\\\',\r\n    '     \\/\\\\\\',\r\n    '      \\/\\\\\\',\r\n    '      /\\\\\\\\\\\\\\',\r\n    '      \\/_____/',\r\n];\r\n```\r\n\r\næ¸²æŸ“çš„æ—¶å€™ç›´æ¥ `lines.forEach(l => console.log(l))` å³å¯ã€‚\r\n\r\n> ğŸ’£ æ³¨æ„ï¼Œä¸ºäº†ä¾¿äºè¯»è€…é˜…è¯»ï¼Œä¸Šé¢çš„ lines æ•°ç»„å†…çš„å­—ç¬¦ä¸²æˆ‘æ²¡æœ‰åŠ ä¸Šè½¬ä¹‰ï¼Œå®ƒæ˜¯ä¸åˆæ³•çš„ï¼åªæ˜¯ä¸ºäº†å±•ç¤ºèµ·æ¥æ›´ä¾¿äºé˜…è¯»ç†è§£ï¼Œå®é™…ä¸­ä¸èƒ½è¿™ä¹ˆå†™ã€‚\r\n\r\næœ€å¤§ç¼©è¿›ï¼ˆç¼©è¿›è¿™ä¸ªè¯ä¸å‡†ç¡®ï¼Œä½†å¸Œæœ›å¤§å®¶èƒ½å¤Ÿç†è§£é‚£ä¸ªæ„æ€ï¼‰çš„è®¡ç®—åªéœ€è¦çŸ¥é“ä¹‹å‰çš„æ¯ä¸ª line å°¾éƒ¨å¯¹åº”æœ‰å¤šå°‘ç©ºæ ¼ï¼ŒåŒæ—¶éœ€è¦å†å…¶åæ–°æ·»åŠ å­—ç¬¦æ¯ä¸ª line å‰é¢åˆåˆ†åˆ«æœ‰å¤šå°‘ç©ºæ ¼ï¼Œç»¼åˆä¸¤è€…ï¼Œå†éå†æ‰€æœ‰çš„ line å–ä¸€ä¸ªæœ€å°å€¼å³å¯ï¼š\r\n\r\n```typescript\r\n// calc the prefix space\r\nconst prefixSpace = function (str: string) {\r\n    const matched = /^\\s+/gu.exec(str);\r\n\r\n    return matched ? matched[0].length : 0;\r\n};\r\n\r\n// calc the tail space\r\nconst tailSpace = function (str: string) {\r\n    const matched = /\\s+$/gu.exec(str);\r\n\r\n    return matched ? matched[0].length : 0;\r\n};\r\n\r\n// calc how many spaces need for indent for layout\r\n// overwise the gap between two characters will be different\r\nconst calcIndent = function (lines: string[], charLines: string[]): number {\r\n    // maximum indent that won't break the layout\r\n    let maxPossible = Infinity;\r\n\r\n    for (let i = 1; i < lines.length; i++) {\r\n        const formerTailNum = tailSpace(lines[i]);\r\n        const latterPrefixNum = prefixSpace(charLines[i]);\r\n\r\n        maxPossible = Math.min(maxPossible, formerTailNum + latterPrefixNum);\r\n    }\r\n\r\n    return maxPossible;\r\n};\r\n```\r\n\r\næœ€å `calcIndent` æ–¹æ³•è¿”å›çš„å°±æ˜¯æ–°å­—ç¬¦éœ€è¦å‘å‰ç¼©è¿›ï¼ˆæˆ–è€…è¯´ç¼©ç´§ï¼‰çš„å€¼ã€‚æœ€åæ¸²æŸ“çš„æ—¶å€™æ ¹æ®è¿™ä¸ªå€¼æ¥è°ƒæ•´æ¯è¡Œè¿æ¥æ—¶æ·»åŠ çš„ç©ºæ ¼æ•°å³å¯ã€‚\r\n\r\næå¸¦ä¸€æï¼Œä¹‹å‰çš„å­—ä½“æ ¼å¼ load è¿›æ¥ä¼šè¢«è½¬æ¢ä¸ºç±»ä¼¼å­—å…¸çš„æ ¼å¼ â€”â€” å­—ä¹‰ä½œä¸º keyï¼Œå­—å‹ç­‰ä¸€ç³»åˆ—å±æ€§ä½œä¸º valueï¼š\r\n\r\n```JavaScript\r\nconst dictionary = {\r\n    'a': {\r\n        lines: [...],\r\n        width: ...,\r\n        height: ...,\r\n    },\r\n    'b': {\r\n        ...\r\n    },\r\n    ...\r\n}\r\n```\r\n\r\nè¿™æ ·éäº `split` å®Œç”¨æˆ·ä¼ å…¥çš„å­—ç¬¦ä¸²åï¼Œæ›´ç®€å•çš„ç´¢å¼•åˆ°å¯¹åº”çš„å­—å‹å’Œå­—ä½“ä¿¡æ¯ã€‚\r\n\r\n### 2.4. å…¶ä»–\r\n\r\nå½“ç„¶ï¼Œå…¶ä»–è¿˜ä¼šæœ‰ä¸€äº›å·¥ä½œï¼ŒåŒ…æ‹¬\r\n\r\n- æ”¯æŒé¢œè‰²\r\n- æ”¯æŒè¿”å›æ’ç‰ˆå®Œçš„ lines è®©ç”¨æˆ·è‡ªå·±æ¸²æŸ“\r\n- æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰è°ƒæ•´å­—é—´è·\r\n\r\nè¿™äº›ç›®å‰å®ç°ä¸Šé‡åˆ°çš„é—®é¢˜ä¸å¤§ï¼Œç¯‡å¹…åŸå› ä¹Ÿå°±ä¸è¯´äº†ã€‚å…·ä½“çš„ä»£ç å¯ä»¥åœ¨ [Github](https://github.com/alienzhou/yoo-hoo) ä¸Šçœ‹åˆ°ã€‚\r\n\r\n## 3. æ€»ç»“\r\n\r\nå®ç°å¯å¤ç”¨çš„æ§åˆ¶å°â€œè‰ºæœ¯å­—â€åŠŸèƒ½ï¼Œæ€»çš„æ¥è¯´å¹¶æ²¡æœ‰å¤ªå¤šå¤æ‚çš„ç‚¹ï¼Œæ•´ä½“çš„æµç¨‹æ¨¡å‹å°±æ˜¯\r\n\r\n`ç”Ÿæˆå­—ä½“åº“ --> å­—ä½“æ’ç‰ˆ --> æ¸²æŸ“æ–‡æœ¬`\r\n\r\nè¿™å¯¹äºå‰ç«¯æ¥è¯´åº”è¯¥æ˜¯éå¸¸å¥½ç†è§£çš„ã€‚\r\n\r\nåšè¿™ä¸ªé¡¹ç›®ä¹Ÿç¡®å®æ˜¯è‡ªå·±åœ¨å·¥ä½œä¸­å¸Œæœ›ç»™ä¸€äº›åº“åŠ ä¸Šè¿™ç§ logo æˆ–è€… banner å±•ç¤ºï¼Œä½†æ¯æ¬¡é‡å¤æ¯ç‡¥çš„å·¥ä½œç¡®å®ä»¤äººåæ„Ÿã€‚æ‰€ä»¥æƒ³äº†ä¸‹å¯è¡Œæ€§ä¹‹åå°±æäº† [yoo-hoo](https://www.npmjs.com/package/yoo-hoo) è¿™ä¹ˆä¸ªå°ç©æ„å„¿ï¼Œå¦‚æœå¤§å®¶ä¹Ÿé‡åˆ°ç±»ä¼¼çš„é—®é¢˜ï¼Œå¸Œæœ›èƒ½æœ‰æ‰€å¸®åŠ©ã€‚\r\n\r\n```bash\r\nnpm i yoo-hoo\r\n```\r\n\r\n## 4. æœ€å\r\n\r\nç›®å‰ yoo-hoo@1.0.x å†…ç½®äº†ä¸€å¥— 26 ä¸ªå­—æ¯ï¼ˆA-Zï¼‰ã€10 ä¸ªæ•°å­—ï¼ˆ0-9ï¼‰ã€`Â·` `*` `-` `|` è¿™äº›å­—ç¬¦çš„å­—ä½“åº“ã€‚\r\n\r\nè€ƒè™‘åˆ°å•ä¸€çš„å­—å‹å’Œæœ‰é™çš„å­—ä½“é‡è‚¯å®šä¸èƒ½æ»¡è¶³æ‰€æœ‰éœ€æ±‚ï¼Œæ‰€ä»¥å¼€å‘æ—¶ä»£ç ç»“æ„å°±ç•™ä¸‹äº†æ”¯æŒå¤–éƒ¨æ‰©å±•çš„æ¨¡å¼ã€‚\r\n\r\nåç»­å¯ä»¥æŠŠ 2.2 èŠ‚ä¸­çš„å­—ä½“æºæ–‡ä»¶è§£æå·¥å…·ç‹¬ç«‹å‡ºæ¥ï¼Œæ”¯æŒç”¨æˆ·ã€Œæ‰‹ç»˜ã€è‡ªå·±çš„å­—å‹ï¼Œç”¨å·¥å…·ç”Ÿæˆå¯¹åº”æ ¼å¼åï¼Œå°†å­—ä½“çš„ JS æ¨¡å—ä¼ å…¥ `yo` æ–¹æ³•ä¸­ä½œä¸ºæ‰©å±•å­—ä½“åŠ è½½ã€‚\r\n\r\nå­—ä½“æºæ–‡ä»¶çš„ã€Œæ‰‹ç»˜ã€è™½æœ‰æˆæœ¬ï¼Œä½†æ‰€è§å³æ‰€å¾—ï¼Œç¼–å†™éš¾åº¦ä¸å¤§ ğŸ¶ åŒæ—¶ä¹Ÿç®—æ˜¯ä¸€åŠ³æ°¸é€¸ã€‚\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/42","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/42/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/42/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/42/events","html_url":"https://github.com/alienzhou/blog/issues/42","id":748524877,"node_id":"MDU6SXNzdWU3NDg1MjQ4Nzc=","number":42,"title":"æ›¿ä»£ webpackï¼Ÿå¸¦ä½ äº†è§£ snowpack åŸç†","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845016,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%BB%BC%E5%90%88","name":"ç»¼åˆ","color":"a2eeef","default":false,"description":""},{"id":1160330255,"node_id":"MDU6TGFiZWwxMTYwMzMwMjU1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7","name":"è‡ªåŠ¨åŒ–å·¥å…·","color":"f9c0d1","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-11-23T06:52:41Z","updated_at":"2021-03-01T13:55:30Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"è¿‘æœŸï¼Œéšç€ vue3 çš„å„ç§æ›å…‰ï¼Œ[vite](https://github.com/vitejs/vite) çš„çƒ­åº¦ä¸Šå‡ï¼Œä¸ vite ç±»ä¼¼çš„ [snowpack](https://github.com/pikapkg/snowpack) çš„å…³æ³¨åº¦ä¹Ÿé€æ¸å¢åŠ äº†ã€‚**ç›®å‰ï¼ˆ2020.06.18ï¼‰snowpack åœ¨ Github ä¸Šå·²ç»æœ‰äº†å°†è¿‘ 1w starsã€‚**\r\n\r\nsnowpack çš„ä»£ç å¾ˆè½»é‡ï¼Œæœ¬æ–‡ä¼šä»å®ç°åŸç†çš„è§’åº¦ä»‹ç» snowpack çš„ç‰¹ç‚¹ã€‚åŒæ—¶ï¼Œå¸¦å¤§å®¶ä¸€èµ·çœ‹çœ‹ï¼Œä½œä¸ºä¸€ä¸ªä»¥åŸç”Ÿ JavaScript æ¨¡å—åŒ–ä¸ºæ ¸å¿ƒçš„å¹´è½»çš„æ„å»ºå·¥å…·ï¼Œå®ƒæ˜¯å¦‚ä½•å®ç°â€œè€ç‰Œâ€æ„å»ºå·¥å…·æ‰€æä¾›çš„é‚£äº›ç‰¹æ€§çš„ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/99935319-64d82600-2d9b-11eb-935f-edf098721a3e.png)\r\n\r\n<!-- more -->\r\n\r\n## 1. åˆè¯† snowpack\r\n\r\nè¿‘æœŸï¼Œéšç€ vue3 çš„å„ç§æ›å…‰ï¼Œ[vite](https://github.com/vitejs/vite) çš„çƒ­åº¦ä¸Šå‡ï¼Œä¸ vite ç±»ä¼¼çš„ [snowpack](https://github.com/pikapkg/snowpack) çš„å…³æ³¨åº¦ä¹Ÿé€æ¸å¢åŠ äº†ã€‚ç›®å‰ï¼ˆ2020.06.18ï¼‰snowpack åœ¨ Github ä¸Šå·²ç»æœ‰äº†å°†è¿‘ 1w starsã€‚\r\n\r\næ—¶é—´æ‹¨å›åˆ° 2019 å¹´ä¸ŠåŠå¹´ï¼Œä¸€å¤©ä¸­åˆæˆ‘ç™¾æ— èŠèµ–åœ°è¯»åˆ°äº† [A Future Without Webpack](https://www.pika.dev/blog/pika-web-a-future-without-webpack) è¿™ç¯‡æ–‡ç« ã€‚é€šè¿‡å®ƒäº†è§£åˆ°äº† pika/snowpack è¿™ä¸ªé¡¹ç›®ï¼ˆå½“æ—¶è¿˜å« pika/webï¼‰ã€‚\r\n\r\næ–‡ç« çš„æ ¸å¿ƒè§‚ç‚¹å¦‚ä¸‹ï¼š\r\n\r\nåœ¨å¦‚ä»Šï¼ˆ2019å¹´ï¼‰ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æŠ›å¼ƒæ‰“åŒ…å·¥å…·ï¼Œè€Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿçš„ JavaScript æ¨¡å—åŠŸèƒ½ã€‚è¿™ä¸»è¦åŸºäºä¸‰ç‚¹è€ƒè™‘ï¼š\r\n\r\n1. å…¼å®¹æ€§å¯æ¥å—ï¼šåŸºæœ¬ä¸»æµçš„æµè§ˆå™¨ç‰ˆæœ¬éƒ½æ”¯æŒç›´æ¥ä½¿ç”¨ JavaScript Module äº†ï¼ˆå½“ç„¶ï¼ŒIE ä¸€å¦‚æ—¢å¾€é™¤å¤–ï¼‰ã€‚\r\n2. æ€§èƒ½é—®é¢˜çš„æ”¹å–„ï¼šä¹‹å‰æ‰“åŒ…çš„ä¸€ä¸ªé‡è¦åŸå› æ˜¯ HTTP/1.1 çš„ç‰¹æ€§å¯¼è‡´ï¼Œæˆ‘ä»¬åˆå¹¶è¯·æ±‚æ¥ä¼˜åŒ–æ€§èƒ½ï¼›è€Œå¦‚ä»Š HTTP/2 æ™®åŠä¹‹åï¼Œè¿™ä¸ªæ€§èƒ½é—®é¢˜ä¸åƒä»¥å‰é‚£ä¹ˆçªå‡ºäº†ã€‚\r\n3. æ‰“åŒ…çš„å¿…è¦æ€§ï¼šæ‰“åŒ…å·¥å…·çš„å­˜åœ¨ä¸»è¦å°±æ˜¯ä¸ºäº†å¤„ç†æ¨¡å—åŒ–ä¸åˆå¹¶è¯·æ±‚ï¼Œè€Œä»¥ä¸Šä¸¤ç‚¹åŸºæœ¬è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ï¼›å†åŠ ä¹‹æ‰“åŒ…å·¥å…·è¶Šæ¥è¶Šå¤æ‚ï¼Œæ­¤æ¶ˆå½¼é•¿ï¼Œå…¶å­˜åœ¨çš„å¿…è¦æ€§è‡ªç„¶è¢«ä½œè€…æ‰€è´¨ç–‘ã€‚\r\n\r\n---\r\n\r\nç”±äºæˆ‘è®¤ä¸º webpack ä¹‹ç±»çš„æ‰“åŒ…å·¥å…·ï¼Œâ€œå‘å®¶â€åè½¬å‹åšæ„å»ºå·¥å…·å¹¶éæœ€ä¼˜è§£ï¼Œå®æ˜¯ä¸€ç§é˜´å·®é˜³é”™çš„é˜¶æ®µæ€§æˆæœã€‚æ‰€ä»¥å½“æ—¶å¯¹è¿™ä¸ªé¡¹ç›®æåˆ°çš„è§‚ç‚¹ä¹Ÿå¾ˆèµåŒï¼Œå…¶ä¸­å°è±¡æœ€æ·±çš„å½“å±å®ƒæåˆ°çš„ï¼š\r\n\r\n> In 2019, you should use a bundler because you want to, not because you need to.\r\n\r\nåŒæ—¶ï¼Œæˆ‘ä¹Ÿè®¤ä¸ºï¼Œæ‰“åŒ…å·¥å…·(Bundler) â‰  æ„å»ºå·¥å…·(Build Tools) â‰  å·¥ç¨‹åŒ–ã€‚\r\n\r\n## 2. åˆçª¥ snowpack\r\n\r\nçœ‹åˆ°è¿™ç‰‡æ–‡ç« åï¼ˆå¤§æ¦‚æ˜¯19å¹´6ã€7æœˆï¼Ÿï¼‰ï¼ŒæŠ±ç€å¥½å¥‡ç«‹åˆ»å» Github ä¸Šè¯»äº†è¿™ä¸ªé¡¹ç›®ã€‚å½“æ—¶çœ‹è¿™ä¸ªé¡¹ç›®çš„æ—¶å€™å¤§æ¦‚æ˜¯ 0.4.x ç‰ˆæœ¬ï¼Œå…¶æºç å’ŒåŠŸèƒ½éƒ½éå¸¸ç®€å•ã€‚\r\n\r\nsnowpack çš„æœ€åˆç‰ˆæ ¸å¿ƒç›®æ ‡å°±æ˜¯æ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿçš„ JavaScript Module èƒ½åŠ›ã€‚æ‰€ä»¥ä»å®ƒçš„å¤„ç†æµç¨‹ä¸Šæ¥çœ‹ï¼Œ**å¯¹ä¸šåŠ¡ä»£ç çš„æ¨¡å—ï¼ŒåŸºæœ¬åªéœ€è¦æŠŠ ESM å‘å¸ƒï¼ˆæ‹·è´ï¼‰åˆ°å‘å¸ƒç›®å½•ï¼Œå†å°†æ¨¡å—å¯¼å…¥è·¯å¾„ä»æºç è·¯å¾„æ¢ä¸ºå‘å¸ƒè·¯å¾„å³å¯ã€‚**\r\n\r\nè€Œå¯¹ node_modules åˆ™é€šè¿‡éå† package.json ä¸­çš„ä¾èµ–ï¼ŒæŒ‰è¯¥ä¾èµ–åˆ—è¡¨ä¸ºç²’åº¦å°† node_modules ä¸­çš„ä¾èµ–æ‰“åŒ…ã€‚**ä»¥ node_modules ä¸­æ¯ä¸ªåŒ…çš„å…¥å£ä½œä¸ºæ‰“åŒ… entryï¼Œä½¿ç”¨ rollup ç”Ÿæˆå¯¹åº”çš„ ESM æ¨¡å—æ–‡ä»¶ï¼Œæ”¾åˆ° web_modules ç›®å½•ä¸­ï¼Œæœ€åæ›¿æ¢æºç çš„ import è·¯å¾„ï¼Œæ˜¯å¾—å¯ä»¥é€šè¿‡åŸç”Ÿ JavaScript Module æ¥åŠ è½½ node_modules ä¸­çš„åŒ…ã€‚**\r\n\r\n```diff\r\n- import { createElement, Component } from \"preact\";\r\n- import htm from \"htm\";\r\n+ import { createElement, Component } from \"/web_modules/preact.js\";\r\n+ import htm from \"/web_modules/htm.js\";\r\n```\r\n\r\nä» [v0.4.0 ç‰ˆæœ¬çš„æºç ](https://github.com/pikapkg/snowpack/blob/v0.4.0/src/index.ts) å¯ä»¥çœ‹å‡ºï¼Œå…¶åˆæœŸåŠŸèƒ½ç¡®å®éå¸¸ç®€å•ï¼Œç”šè‡³æœ‰äº›ç®€é™‹ï¼Œä»¥è‡³äºç¼ºä¹å¾ˆå¤šç°ä»£å‰ç«¯å¼€å‘æ‰€éœ€çš„ç‰¹æ€§ï¼Œæ˜æ˜¾æ˜¯ä¸èƒ½ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ã€‚\r\n\r\nç›´è§‚æ„Ÿå—æ¥è¯´ï¼Œå®ƒå½“æ—¶å°±æ¬ ç¼ºä»¥ä¸‹èƒ½åŠ›ï¼š\r\n\r\n1. import CSS / image / â€¦ï¼šç”±äº webpack ä¸€åˆ‡çš†æ¨¡å—çš„ç†å¿µ + ç»„ä»¶åŒ–å¼€å‘çš„æ·±å…¥äººå¿ƒï¼Œimport anything çš„ä¹¦å†™æ¨¡å¼å·²ç»æ·±å…¥å¼€å‘è€…çš„è§‚å¿µä¸­ã€‚å¯¹ CSS ç­‰å†…å®¹ä¾èµ–ä¸åŠ è½½èƒ½åŠ›çš„ç¼ºå¤±ï¼Œå°†æˆä¸ºå®ƒçš„é˜¿å…‹ç‰æ–¯ä¹‹è¸µã€‚\r\n2. è¯­æ³•è½¬æ¢èƒ½åŠ›ï¼šä½œä¸ºç›®æ ‡æˆä¸ºæ„å»ºå·¥å…·çš„ snowpackï¼ˆå½“æ—¶å« webï¼‰ï¼Œå¹¶æ²¡æœ‰èƒ½å¤Ÿç¼–è¯‘ Typescriptã€JSX ç­‰è¯­æ³•æ–‡ä»¶çš„èƒ½åŠ›ï¼Œä½ å½“ç„¶å¯ä»¥å†å¼„ä¸€ä¸ªå’Œå®ƒæ¯«æ— å…³ç³»çš„å·¥å…·æ¥å¤„ç†è¯­æ³•ï¼Œä½†æ˜¯ï¼Œè¿™ä¸å°±æ˜¯æ„å»ºå·¥å…·åº”è¯¥é›†æˆçš„ä¹ˆï¼Ÿ\r\n3. HMRï¼šè¿™å¯èƒ½ä¸é‚£ä¹ˆè¦å‘½ï¼Œä½†ä¿—è¯è¯´ã€Œç”±ä¿­å…¥å¥¢æ˜“ï¼Œç”±å¥¢å…¥ä¿­éš¾ã€ï¼Œè¢«â€œæƒ¯åâ€å¼€å‘è€…ä»¬è‡ªç„¶ä¼šæœ‰äººæŠµè§¦è¿™ä¸€ç‰¹æ€§çš„ç¼ºå¤±ã€‚\r\n4. æ€§èƒ½ï¼šè™½è¯´å®ƒæŒ‡å‡ºï¼Œä¸Šäº† HTTP2 åï¼Œä½¿ç”¨ JavaScript modules æ€§èƒ½å¹¶ä¸ä¼šå·®ï¼Œä½†æ¯•ç«Ÿæ²¡æœ‰å®è·µè¿‡ï¼Œå¯¹æ­¤è¿˜æ˜¯æŠ±æœ‰æ€€ç–‘ã€‚\r\n5. ç¯å¢ƒå˜é‡ï¼šè¿™è™½ç„¶æ˜¯ä¸€ä¸ªå°ç‰¹æ€§ï¼Œä½†åœ¨æˆ‘æ¥è§¦è¿‡çš„å¤§å¤šæ•°é¡¹ç›®ä¸­éƒ½ä¼šç”¨åˆ°å®ƒï¼Œå®ƒå¯ä»¥å¸®åŠ©å¼€å‘è€…è‡ªåŠ¨æµ‹å¸è½½çº¿ä¸Šä»£ç ä¸­çš„è°ƒè¯•å·¥å…·ï¼Œå¯ä»¥æ ¹æ®ç¯å¢ƒåˆ¤æ–­ï¼Œè‡ªåŠ¨å°†åŸ‹ç‚¹ä¸ŠæŠ¥åˆ°ä¸åŒçš„æœåŠ¡ä¸Šã€‚ç¡®å®éœ€è¦ä¸€ä¸ªè¿™æ ·å¥½ç”¨çš„ç‰¹æ€§ã€‚\r\n\r\n## 3. snowpack çš„è¿›åŒ–\r\n\r\næ—¶é—´å›åˆ° 2020 å¹´ä¸ŠåŠå¹´ï¼Œéšç€ vue3 çš„ä¸æ–­æ›å…‰ï¼Œä¸å…¶æœ‰ä¸€å®šå…³è”çš„å¦ä¸€ä¸ªé¡¹ç›® vite ä¹Ÿé€æ¸å¸å¼•äº†äººä»¬çš„ç›®å…‰ã€‚è€Œå…¶[ä»‹ç»ä¸­æåˆ°çš„ snowpack](https://github.com/vitejs/vite#how-is-this-different-from-snowpack) ä¹Ÿçªç„¶å¸å¼•åˆ°äº†æ›´å¤šçš„çƒ­åº¦ä¸è®¨è®ºã€‚å½“æ—¶æˆ‘åªæ˜¯å¯¹ pika æ„Ÿåˆ°ç†Ÿæ‚‰ï¼Œå¥½å¥‡çš„ç‚¹å¼€ snowpack é¡¹ç›®ä¸»é¡µçš„æ—¶å€™ï¼Œæ‰å‘ç°è¿™ä¸ªä¸€å¹´å‰åˆè¯†çš„é¡¹ç›®ï¼ˆpika/webï¼‰å·²ç»å‡çº§åˆ°äº† pika/snowpack v2ã€‚è€Œé¡¹ç›®æºç ä¹Ÿä¸å†æ˜¯ä¹‹å‰é‚£å”¯ä¸€è€Œç®€å•çš„ index.tsï¼Œåœ¨æ ¸å¿ƒä»£ç å¤–ï¼Œè¿˜åŒ…å«äº†è¯¸å¤šå®˜æ–¹æ’ä»¶ã€‚\r\n\r\nçœ‹ç€å·²ç»å®Œå…¨å˜æ ·çš„ Readmeï¼Œæˆ‘çš„ç¬¬ä¸€ç›´è§‰æ˜¯ï¼Œä¹‹å‰æˆ‘æƒ³åˆ°çš„é‚£äº›é—®é¢˜ï¼Œåº”è¯¥å·²ç»æœ‰äº†è§£å†³æ–¹æ¡ˆã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/99935332-702b5180-2d9b-11eb-93e6-26b8efca9160.png)\r\n\r\næŠ±ç€å­¦ä¹ çš„æ€åº¦ï¼Œå¯¹å®ƒè¿›è¡Œé‡æ–°äº†è§£ä¹‹åï¼Œå‘ç°æœç„¶å¦‚æ­¤ã€‚å¥½å¥‡å¿ƒè¶‹åŠ¿æˆ‘å¯¹å®ƒçš„è§£å†³æ–¹æ¡ˆå»ä¸€æ¢ç©¶ç«Ÿã€‚\r\n\r\n> æœ¬æ–‡å†™äº 2020.06.18ï¼Œæºç åŸºäº [snowpack@2.5.1](https://github.com/pikapkg/snowpack/tree/v2.5.1)\r\n\r\n### 3.1. import CSS\r\n\r\nimport CSS çš„é—®é¢˜è¿˜æœ‰ä¸€ä¸ªæ›´å¤§çš„èŒƒå›´ï¼Œå°±æ˜¯é JavaScript èµ„æºçš„åŠ è½½ï¼ŒåŒ…æ‹¬å›¾ç‰‡ã€JSON æ–‡ä»¶ã€æ–‡æœ¬ç­‰ã€‚\r\n\r\nå…ˆè¯´è¯´ CSSã€‚\r\n\r\n```JavaScript\r\nimport './index.css';\r\n```\r\n\r\nä¸Šé¢è¿™ç§è¯­æ³•ç›®å‰æµè§ˆæ˜¯ä¸æ”¯æŒçš„ã€‚æ‰€ä»¥ snowpack ç”¨äº†ä¸€ä¸ªå’Œä¹‹å‰ webpack å¾ˆç±»ä¼¼çš„æ–¹å¼ï¼Œå°† CSS æ–‡ä»¶å˜ä¸ºç”¨äºæ³¨å…¥æ ·å¼çš„ JS æ¨¡å—ã€‚å¦‚æœä½ ç†Ÿæ‚‰ webpackï¼Œè‚¯å®šçŸ¥é“å¦‚æœä½ åªæ˜¯åœ¨ loader ä¸­å¤„ç† CSSï¼Œé‚£ä¹ˆå¹¶ä¸ä¼šç”Ÿæˆå•ç‹¬çš„ CSS æ–‡ä»¶ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¼šæœ‰ [`mini-css-extract-plugin`](https://webpack.js.org/plugins/mini-css-extract-plugin/)ï¼‰ï¼Œè€Œæ˜¯åŠ è½½ä¸€ä¸ª JS æ¨¡å—ï¼Œç„¶ååœ¨ JS æ¨¡å—ä¸­é€šè¿‡ DOM API å°† CSS æ–‡æœ¬ä½œä¸º style æ ‡ç­¾çš„å†…å®¹æ’å…¥åˆ°é¡µé¢ä¸­ã€‚\r\n\r\nä¸ºæ­¤ï¼Œsnowpack è‡ªå·±å†™äº†ä¸€ä¸ªç®€å•çš„æ¨¡æ¿æ–¹æ³•ï¼Œç”Ÿæˆå°† CSS æ ·å¼æ³¨å…¥é¡µé¢çš„ JS æ¨¡å—ã€‚ä¸‹é¢è¿™æ®µä»£ç å¯ä»¥å®ç°æ ·å¼æ³¨å…¥çš„åŠŸèƒ½ï¼š\r\n\r\n```JavaScript\r\nconst code = '.test { height: 100px }';\r\nconst styleEl = document.createElement(\"style\");\r\nconst codeEl = document.createTextNode(code);\r\nstyleEl.type = 'text/css';\r\nstyleEl.appendChild(codeEl);\r\ndocument.head.appendChild(styleEl);\r\n```\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†ç¬¬ä¸€è¡Œå¼å­çš„å³å€¼ï¼Œå…¶ä»–éƒ½æ˜¯ä¸å˜çš„ï¼Œå› æ­¤å¯ä»¥å¾ˆå®¹æ˜“ç”Ÿæˆä¸€ä¸ªç¬¦åˆéœ€æ±‚çš„ JS æ¨¡å—ï¼š\r\n\r\n```JavaScript\r\nconst jsContent = `\r\n  const code = ${JSON.stringify(code)};\r\n  const styleEl = document.createElement(\"style\");\r\n  const codeEl = document.createTextNode(code);\r\n  styleEl.type = 'text/css';\r\n  styleEl.appendChild(codeEl);\r\n  document.head.appendChild(styleEl);\r\n`;\r\n\r\nfs.writeFileSync(filename, jsContent);\r\n```\r\n\r\nsnowpack ä¸­çš„[å®ç°ä»£ç ](https://github.com/pikapkg/snowpack/blob/v2.5.1/src/commands/build-util.ts#L146-L169)æ¯”æˆ‘ä»¬ä¸Šé¢å¤šäº†ä¸€äº›ä¸œè¥¿ï¼Œä¸è¿‡ä¸æ ·å¼æ³¨å…¥æ— å…³ï¼Œè¿™ä¸ªæ”¾åˆ°åé¢å†è¯´ã€‚\r\n\r\né€šè¿‡å°† CSS æ–‡ä»¶çš„å†…å®¹ä¿å­˜åˆ° JS å˜é‡ï¼Œç„¶åå†ä½¿ç”¨ JS è°ƒç”¨ DOM API åœ¨é¡µé¢æ³¨å…¥ CSS å†…å®¹å³å¯ä½¿ç”¨ JavaScript Modules çš„èƒ½åŠ›åŠ è½½ CSSã€‚è€Œæºç ä¸­çš„ `index.css` ä¹Ÿä¼šè¢«æ›¿æ¢ä¸º `index.css.proxy.js`ï¼š\r\n\r\n```diff\r\n- import './index.css';\r\n+ import './index.css.proxy.js';\r\n```\r\n\r\nproxy è¿™ä¸ªåè¯ä¹‹åä¼šå¤šæ¬¡å‡ºç°ï¼Œå› ä¸ºä¸ºäº†èƒ½å¤Ÿä»¥æ¨¡å—åŒ–æ–¹å¼å¯¼å…¥é JS èµ„æºï¼Œsnowpack æŠŠç”Ÿæˆçš„ä¸­é—´ JavaScript æ¨¡å—éƒ½å«åš proxyã€‚è¿™ç§å®ç°æ–¹å¼ä¹Ÿå‡ ä¹å’Œ webpack ä¸€è„‰ç›¸æ‰¿ã€‚\r\n\r\n### 3.2. å›¾ç‰‡çš„ import\r\n\r\nåœ¨ç›®å‰çš„å‰ç«¯å¼€å‘åœºæ™¯ä¸­ï¼Œè¿˜æœ‰ä¸€ç±»éå¸¸å…¸å‹çš„èµ„æºå°±æ˜¯å›¾ç‰‡ã€‚\r\n\r\n```JavaScript\r\nimport avatar from './avatar.png';\r\n\r\nfunction render() {\r\n    return (\r\n        <div class=\"user\">\r\n            <img src={avatar} />\r\n        </div>\r\n    );\r\n}\r\n```\r\n\r\nä¸Šé¢ä»£ç çš„ä¹¦å†™æ–¹å¼å·²ç»æ™®éåº”ç”¨åœ¨å¾ˆå¤šé¡¹ç›®ä»£ç ä¸­äº†ã€‚é‚£ä¹ˆ snowpack æ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿ\r\n\r\nå¤ªé˜³åº•ä¸‹æ²¡æœ‰æ–°é²œäº‹ï¼Œsnowpack å’Œ webpack ä¸€æ ·ï¼Œå¯¹äºä»£ç ä¸­å¯¼å…¥çš„ `avatar` å˜é‡ï¼Œæœ€åå…¶å®éƒ½æ˜¯è¯¥é™æ€èµ„æºçš„ URIã€‚\r\n\r\næˆ‘ä»¬ä»¥ snowpack æä¾›çš„å®˜æ–¹ React æ¨¡ç‰ˆä¸ºä¾‹æ¥çœ‹çœ‹å›¾ç‰‡èµ„æºçš„å¼•å…¥å¤„ç†ã€‚\r\n\r\n> `npx create-snowpack-app snowpack-test --template @snowpack/app-template-react`\r\n\r\nåˆå§‹åŒ–æ¨¡ç‰ˆè¿è¡Œåï¼Œå¯ä»¥çœ‹åˆ°æºç ä¸æ„å»ºåçš„ä»£ç å·®å¼‚å¦‚ä¸‹ï¼š\r\n\r\n```diff\r\n- import React, { useState } from 'react';\r\n- import logo from './logo.svg';\r\n- import './App.css';\r\n\r\n+ import React, { useState } from '/web_modules/react.js';\r\n+ import logo from './logo.svg.proxy.js';\r\n+ import './App.css.proxy.js';\r\n```\r\n\r\nä¸ CSS ç±»ä¼¼ï¼Œä¹Ÿä¸ºå›¾ç‰‡ï¼ˆsvgï¼‰ç”Ÿæˆäº†ä¸€ä¸ª JS æ¨¡å— logo.svg.proxy.jsï¼Œå…¶æ¨¡å—å†…å®¹ä¸ºï¼š\r\n\r\n```JavaScript\r\n// logo.svg.proxy.js\r\nexport default \"/_dist_/logo.svg\";\r\n```\r\n\r\nå¥—è·¯ä¸ webpack å¦‚å‡ºä¸€è¾™ã€‚ä»¥ build å‘½ä»¤ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ snowpack çš„å¤„ç†æ–¹å¼ã€‚\r\n\r\né¦–å…ˆæ˜¯å°†æºç ä¸­çš„é™æ€æ–‡ä»¶ï¼ˆlogo.svgï¼‰[æ‹·è´åˆ°å‘å¸ƒç›®å½•](https://github.com/pikapkg/snowpack/blob/master/src/commands/build.ts#L219)ï¼š\r\n\r\n```JavaScript\r\nallFiles = glob.sync(`**/*`, {\r\n    ...\r\n});\r\nconst allBuildNeededFiles: string[] = [];\r\nawait Promise.all(\r\n    allFiles.map(async (f) => {\r\n        f = path.resolve(f); // this is necessary since glob.sync() returns paths with / on windows.  path.resolve() will switch them to the native path separator.\r\n        ...\r\n        return fs.copyFile(f, outPath);\r\n    }),\r\n);\r\n```\r\n\r\nç„¶åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° snowpack ä¸­çš„ä¸€ä¸ªå« `transformEsmImports` çš„å…³é”®æ–¹æ³•è°ƒç”¨ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥å°†æºç  JS ä¸­ import çš„æ¨¡å—è·¯å¾„è¿›è¡Œè½¬æ¢ã€‚ä¾‹å¦‚å¯¹ node_modules ä¸­çš„å¯¼å…¥éƒ½æ›¿æ¢ä¸º web_modulesã€‚åœ¨è¿™é‡Œ[å¯¹ svg æ–‡ä»¶çš„å¯¼å…¥åä¹Ÿä¼šè¢«åŠ ä¸Š `.proxy.js`](https://github.com/pikapkg/snowpack/blob/master/src/commands/build.ts#L315-L317)ï¼š\r\n\r\n```JavaScript\r\ncode = await transformEsmImports(code, (spec) => {\r\n    â€¦â€¦\r\n    if (spec.startsWith('/') || spec.startsWith('./') || spec.startsWith('../')) {\r\n        const ext = path.extname(spec).substr(1);\r\n        if (!ext) {\r\n            â€¦â€¦\r\n        }\r\n        const extToReplace = srcFileExtensionMapping[ext];\r\n        if (extToReplace) {\r\n            â€¦â€¦\r\n        }\r\n        if (spec.endsWith('.module.css')) {\r\n            â€¦â€¦\r\n        } else if (!isBundled && (extToReplace || ext) !== 'js') {\r\n            const resolvedUrl = path.resolve(path.dirname(outPath), spec);\r\n            allProxiedFiles.add(resolvedUrl);\r\n            spec = spec + '.proxy.js';\r\n        }\r\n        return spec;\r\n    }\r\n    â€¦â€¦\r\n});\r\n```\r\n\r\næ­¤æ—¶ï¼Œæˆ‘ä»¬çš„ svg æ–‡ä»¶å’Œæºç çš„å¯¼å…¥è¯­æ³•ï¼ˆ`import logo from './logo.svg.proxy.js'`ï¼‰å‡å·²å°±ç»ªï¼Œæœ€åå‰©ä¸‹çš„å°±æ˜¯[ç”Ÿæˆ proxy æ–‡ä»¶](https://github.com/pikapkg/snowpack/blob/master/src/commands/build.ts#L359-L369)äº†ã€‚ä¹Ÿéå¸¸ç®€å•ï¼š\r\n\r\n```JavaScript\r\nfor (const proxiedFileLoc of allProxiedFiles) {\r\n    const proxiedCode = await fs.readFile(proxiedFileLoc, {encoding: 'utf8'});\r\n    const proxiedExt = path.extname(proxiedFileLoc);\r\n    const proxiedUrl = proxiedFileLoc.substr(buildDirectoryLoc.length);\r\n    const proxyCode = wrapEsmProxyResponse({\r\n      url: proxiedUrl,\r\n      code: proxiedCode,\r\n      ext: proxiedExt,\r\n      config,\r\n    });\r\n    const proxyFileLoc = proxiedFileLoc + '.proxy.js';\r\n    await fs.writeFile(proxyFileLoc, proxyCode, {encoding: 'utf8'});\r\n }\r\n```\r\n\r\n`wrapEsmProxyResponse` æ˜¯ä¸€ä¸ªç”Ÿæˆ proxy æ¨¡å—çš„æ–¹æ³•ï¼Œç›®å‰åªå¤„ç†åŒ…æ‹¬ JSONã€image å’Œå…¶ä»–ç±»å‹çš„æ–‡ä»¶ï¼Œå¯¹äºå…¶ä»–ç±»å‹ï¼ˆåŒ…æ‹¬äº†å›¾ç‰‡ï¼‰ï¼Œå°±æ˜¯éå¸¸ç®€å•çš„[å¯¼å‡º url](https://github.com/pikapkg/snowpack/blob/v2.5.1/src/commands/build-util.ts#L168)ï¼š\r\n\r\n```JavaScript\r\nreturn `export default ${JSON.stringify(url)};`;\r\n```\r\n\r\næ‰€ä»¥ï¼Œå¯¹äº CSS ä¸å›¾ç‰‡ï¼Œç”±äºæµè§ˆå™¨æ¨¡å—è§„èŒƒå‡ä¸æ”¯æŒè¯¥ç±»å‹ï¼Œæ‰€ä»¥éƒ½ä¼šè½¬æ¢ä¸º JS æ¨¡å—ï¼Œè¿™å— snowpack å’Œ webpack å®ç°å¾ˆç±»ä¼¼ã€‚\r\n\r\n### 3.3. HMRï¼ˆçƒ­æ›´æ–°ï¼‰\r\n\r\nå¦‚æœä½ åˆšæ‰ä»”ç»†å»çœ‹äº† `wrapEsmProxyResponse` æ–¹æ³•ï¼Œä¼šå‘ç°å¯¹äº CSS â€œæ¨¡å—â€ï¼Œå®ƒé™¤äº†æœ‰æ³¨å…¥ CSS çš„åŠŸèƒ½ä»£ç å¤–ï¼Œè¿˜å¤šç€è¿™ä¹ˆå‡ è¡Œï¼š\r\n\r\n```JavaScript\r\nimport * as __SNOWPACK_HMR_API__ from '/${buildOptions.metaDir}/hmr.js';\r\nimport.meta.hot = __SNOWPACK_HMR_API__.createHotContext(import.meta.url);\r\nimport.meta.hot.accept();\r\nimport.meta.hot.dispose(() => {\r\n  document.head.removeChild(styleEl);\r\n});\r\n```\r\n\r\nè¿™äº›ä»£ç å°±æ˜¯ç”¨æ¥å®ç°çƒ­æ›´æ–°çš„ï¼Œä¹Ÿå°±æ˜¯ HMRï¼ˆHot Module Reloadï¼‰ã€‚å®ƒä½¿å¾—å½“ä¸€ä¸ªæ¨¡å—æ›´æ–°æ—¶ï¼Œåº”ç”¨ä¼šåœ¨å‰ç«¯è‡ªåŠ¨æ›¿æ¢è¯¥æ¨¡å—ï¼Œè€Œä¸éœ€è¦ reload æ•´ä¸ªé¡µé¢ã€‚è¿™å¯¹äºä¾èµ–çŠ¶æ€æ„å»ºçš„å•é¡µåº”ç”¨å¼€å‘éå¸¸å‹å¥½ã€‚\r\n\r\n`import.meta` æ˜¯ä¸€ä¸ªåŒ…å«æ¨¡å—å…ƒä¿¡æ¯çš„å¯¹è±¡ï¼Œä¾‹å¦‚æ¨¡å—è‡ªèº«çš„ url å°±å¯ä»¥åœ¨è¿™é‡Œé¢å–åˆ°ã€‚è€Œ HMR å…¶å®å’Œ `import.meta` æ²¡å¤ªå¤§å…³ç³»ï¼Œsnowpack åªæ˜¯å€Ÿç”¨è¿™å—åœ°æ–¹å­˜å‚¨äº† HMR ç›¸å…³åŠŸèƒ½å¯¹è±¡ã€‚æ‰€ä»¥ä¸å¿…è¿‡åˆ†çº ç»“äºå®ƒã€‚\r\n\r\næˆ‘ä»¬å†æ¥ä»”ç»†çœ‹çœ‹ä¸Šé¢è¿™æ®µ HMR çš„åŠŸèƒ½ä»£ç ï¼ŒAPI æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Ÿå¯ä¸‹é¢è¿™æ®µå¯¹æ¯”ä¸€ä¸‹\r\n\r\n```diff\r\nimport _ from 'lodash';\r\nimport printMe from './print.js';\r\n\r\nfunction component() {\r\n  const element = document.createElement('div');\r\n  const btn = document.createElement('button');\r\n\r\n  element.innerHTML = _.join(['Hello', 'webpack'], ' ');\r\n\r\n  btn.innerHTML = 'Click me and check the console!';\r\n  btn.onclick = printMe;\r\n\r\n  element.appendChild(btn);\r\n\r\n  return element;\r\n}\r\n\r\ndocument.body.appendChild(component());\r\n+\r\n+ if (module.hot) {\r\n+   module.hot.accept('./print.js', function() {\r\n+     console.log('Accepting the updated printMe module!');\r\n+     printMe();\r\n+   })\r\n+ }\r\n```\r\n\r\nä¸Šé¢çš„ä»£ç å–è‡ª webpack å®˜ç½‘ä¸Š HMR åŠŸèƒ½çš„[ä½¿ç”¨è¯´æ˜](https://webpack.js.org/guides/hot-module-replacement/)ï¼Œå¯è§ï¼Œsnowpack ç«™åœ¨â€œå·¨äººâ€çš„è‚©è†€ä¸Šï¼Œæ²¿è¢­äº† webpack çš„ APIï¼Œå…¶åŸç†ä¹ŸåŠå…¶ç›¸ä¼¼ã€‚ç½‘ä¸Šå…³äº webpack HMR çš„è®²è§£æ–‡æ¡£å¾ˆå¤šï¼Œè¿™é‡Œå°±ä¸ç»†è¯´äº†ï¼ŒåŸºæœ¬çš„å®ç°åŸç†å°±æ˜¯ï¼š\r\n\r\n- snowpack è¿›è¡Œæ„å»ºï¼Œå¹¶ watch æºç ï¼›\r\n- åœ¨ snowpack æœåŠ¡ç«¯ä¸å‰ç«¯åº”ç”¨é—´å»ºç«‹ websocket è¿æ¥ï¼›\r\n- å½“æºç å˜åŠ¨æ—¶ï¼Œé‡æ–°æ„å»ºï¼Œå®Œæˆåé€šè¿‡ websocket å°†æ¨¡å—ä¿¡æ¯ï¼ˆid/urlï¼‰æ¨é€ç»™å‰ç«¯åº”ç”¨ï¼›\r\n- å‰ç«¯åº”ç”¨ç›‘å¬åˆ°è¿™ä¸ªæ¶ˆæ¯åï¼Œæ ¹æ®æ¨¡å—ä¿¡æ¯åŠ è½½æ¨¡å—\r\n- åŒæ—¶ï¼Œè§¦å‘è¯¥æ¨¡å—ä¹‹å‰æ³¨å†Œçš„å›è°ƒäº‹ä»¶ï¼Œè¿™ä¸ªåœ¨ä»¥ä¸Šä»£ç ä¸­å°±æ˜¯ä¼ å…¥ `accept` å’Œ `dispose` ä¸­çš„æ–¹æ³•\r\n\r\nå› æ­¤ï¼Œ`wrapEsmProxyResponse` é‡Œæ„é€ å‡ºçš„è¿™æ®µä»£ç \r\n\r\n```JavaScript\r\nimport.meta.hot.dispose(() => {\r\n  document.head.removeChild(styleEl);\r\n});\r\n```\r\n\r\nå…¶å®å°±æ˜¯è¡¨ç¤ºï¼Œå½“è¯¥ CSS æ›´æ–°å¹¶è¦è¢«æ›¿æ¢æ—¶ï¼Œéœ€è¦ç§»é™¤ä¹‹å‰æ³¨å…¥çš„æ ·å¼ã€‚è€Œæ‰§è¡Œé¡ºåºæ˜¯ï¼šè¿œç¨‹æ¨¡å— --> åŠ è½½å®Œæ¯• --> æ‰§è¡Œæ—§æ¨¡å—çš„ accept å›è°ƒ --> æ‰§è¡Œæ—§æ¨¡å—çš„ dispose å›è°ƒã€‚\r\n\r\nsnowpack ä¸­ HMR å‰ç«¯æ ¸å¿ƒä»£ç æ”¾åœ¨äº† [`assets/hmr.js`](https://github.com/pikapkg/snowpack/blob/v2.5.1/assets/hmr.js)ã€‚ä»£ç ä¹Ÿéå¸¸ç®€çŸ­ï¼Œå…¶ä¸­å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸åƒ webpack ä½¿ç”¨å‘é¡µé¢æ·»åŠ  script æ ‡ç­¾æ¥åŠ è½½æ–°æ¨¡å—ï¼Œsnowpack ç›´æ¥ä½¿ç”¨äº†åŸç”Ÿçš„ dynamic import æ¥[åŠ è½½æ–°æ¨¡å—](https://github.com/pikapkg/snowpack/blob/v2.5.1/assets/hmr.js#L109-L112)ï¼š\r\n\r\n```JavaScript\r\nconst [module, ...depModules] = await Promise.all([\r\n  import(id + `?mtime=${updateID}`),\r\n  ...deps.map((d) => import(d + `?mtime=${updateID}`)),\r\n]);\r\n```\r\n\r\nä¹Ÿæ˜¯ç§‰æ‰¿äº†ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿ JavaScript Modules èƒ½åŠ›çš„ç†å¿µã€‚\r\n\r\n---\r\n\r\nå°æ†©ä¸€ä¸‹ã€‚çœ‹å®Œä¸Šé¢çš„å†…å®¹ï¼Œä½ æ˜¯ä¸æ˜¯å‘ç°ï¼Œè¿™äº›æŠ€æœ¯æ–¹æ¡ˆéƒ½å’Œ webpack çš„å®ç°éå¸¸ç±»ä¼¼ã€‚snowpack æ­£æ˜¯å€Ÿé‰´äº†è¿™äº›å‰ç«¯å¼€å‘çš„ä¼˜ç§€å®è·µï¼Œè€Œå…¶ä¸€å¼€å§‹çš„ç†å¿µä¹Ÿå¾ˆæ˜ç¡®ï¼š**ä¸ºå‰ç«¯å¼€å‘æä¾›ä¸€ä¸ªä¸éœ€è¦æ‰“åŒ…å™¨ï¼ˆBundlerï¼‰çš„æ„å»ºå·¥å…·ã€‚**\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/99935359-7de0d700-2d9b-11eb-9960-084a9af6a686.png)\r\n\r\nwebpack çš„ä¸€å¤§çŸ¥è¯†ç‚¹å°±æ˜¯ä¼˜åŒ–ï¼Œæ—¢åŒ…æ‹¬æ„å»ºé€Ÿåº¦çš„ä¼˜åŒ–ï¼Œä¹ŸåŒ…æ‹¬æ„å»ºäº§ç‰©çš„ä¼˜åŒ–ã€‚å…¶ä¸­ä¸€ä¸ªç‚¹å°±æ˜¯å¦‚ä½•æ‹†åŒ…ã€‚webpack v3 ä¹‹å‰æœ‰ CommonChunkPluginï¼Œv4 ä¹‹åé€šè¿‡ SplitChunk è¿›è¡Œé…ç½®ã€‚ä½¿ç”¨å£°æ˜å¼çš„é…ç½®ï¼Œæ¯”æˆ‘ä»¬äººå·¥åˆåŒ…æ‹†åŒ…æ›´åŠ â€œæ™ºèƒ½â€ã€‚åˆå¹¶ä¸æ‹†åˆ†æ˜¯ä¸ºäº†å‡å°‘é‡å¤ä»£ç ï¼ŒåŒæ—¶å¢åŠ ç¼“å­˜åˆ©ç”¨ç‡ã€‚ä½†å¦‚æœæœ¬èº«å°±ä¸æ‰“åŒ…ï¼Œè‡ªç„¶è¿™ä¸¤ä¸ªé—®é¢˜å°±ä¸å†å­˜åœ¨ã€‚è€Œå¦‚æœéƒ½æ˜¯ç›´æ¥åŠ è½½ ESMï¼Œé‚£ä¹ˆ Tree-Shaking çš„æ‰€è§£å†³çš„é—®é¢˜ä¹Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šä¹Ÿè¢«ç¼“è§£äº†ï¼ˆå½“ç„¶å¹¶æœªæ ¹æ²»ï¼‰ã€‚\r\n\r\nå†ç»“åˆæœ€å¼€å§‹æåˆ°çš„æ€§èƒ½ä¸å…¼å®¹æ€§ï¼Œå¦‚æœè¿™ä¸¤ä¸ªåç¡®å®è¿ˆäº†è¿‡å»ï¼Œé‚£æˆ‘ä»¬ä½•å¿…è¦ç”¨ä¸€ä¸ªå†…éƒ¨æµç¨‹å¤æ‚ã€ä¸Šä¸‡è¡Œä»£ç çš„å·¥å…·æ¥è§£å†³ä¸€ä¸ªä¸å†å­˜åœ¨çš„é—®é¢˜å‘¢ï¼Ÿ\r\n\r\nå¥½äº†ï¼Œè®©æˆ‘ä»¬å›æ¥ç»§ç»­èŠèŠ snowpack é‡Œå…¶ä»–ç‰¹æ€§çš„å®ç°ã€‚\r\n\r\n---\r\n\r\n### 3.4. ç¯å¢ƒå˜é‡\r\n\r\né€šè¿‡ç¯å¢ƒæ¥åˆ¤æ–­æ˜¯å¦å…³é—­è°ƒè¯•åŠŸèƒ½æ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„éœ€æ±‚ã€‚\r\n\r\n```JavaScript\r\nif (process.env.NODE_ENV === 'production') {\r\n  disableDebug();\r\n}\r\n```\r\n\r\nsnowpack ä¸­ä¹Ÿå®ç°äº†ç¯å¢ƒå˜é‡çš„åŠŸèƒ½ã€‚ä»ä½¿ç”¨æ–‡æ¡£ä¸Šæ¥çœ‹ï¼Œä½ å¯ä»¥åœ¨æ¨¡å—ä¸­çš„ `import.meta.env` ä¸Šå–åˆ°å˜é‡ã€‚åƒä¸‹é¢è¿™ä¹ˆä½¿ç”¨ï¼š\r\n\r\n```JavaScript\r\nif (import.meta.env.NODE_ENV === 'production') {\r\n  disableDebug();\r\n}\r\n```\r\n\r\né‚£ä¹ˆç¯å¢ƒå˜é‡æ˜¯å¦‚ä½•è¢«æ³¨å…¥è¿›å»çš„å‘¢ï¼Ÿ\r\n\r\nè¿˜æ˜¯ä»¥ build çš„æºç ä¸ºä¾‹ï¼Œåœ¨ä»£ç ç”Ÿæˆçš„é˜¶æ®µä¸Šï¼Œé€šè¿‡ [`wrapImportMeta` æ–¹æ³•çš„è°ƒç”¨](https://github.com/pikapkg/snowpack/blob/v2.5.1/src/commands/build.ts#L346)ç”Ÿæˆäº†æ–°çš„ä»£ç æ®µï¼Œ\r\n\r\n```JavaScript\r\ncode = wrapImportMeta({code, env: true, hmr: false, config});\r\n```\r\n\r\né‚£ä¹ˆç»è¿‡ `wrapImportMeta` å¤„ç†åçš„ä»£ç å’Œä¹‹å‰æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿç­”æ¡ˆä»æºç é‡Œå°±èƒ½çŸ¥æ™“ï¼š\r\n\r\n```JavaScript\r\nexport function wrapImportMeta({\r\n  code,\r\n  hmr,\r\n  env,\r\n  config: {buildOptions},\r\n}: {\r\n  code: string;\r\n  hmr: boolean;\r\n  env: boolean;\r\n  config: SnowpackConfig;\r\n}) {\r\n  if (!code.includes('import.meta')) {\r\n    return code;\r\n  }\r\n  return (\r\n    (hmr\r\n      ? `import * as  __SNOWPACK_HMR__ from '/${buildOptions.metaDir}/hmr.js';\\nimport.meta.hot = __SNOWPACK_HMR__.createHotContext(import.meta.url);\\n`\r\n      : ``) +\r\n    (env\r\n      ? `import __SNOWPACK_ENV__ from '/${buildOptions.metaDir}/env.js';\\nimport.meta.env = __SNOWPACK_ENV__;\\n`\r\n      : ``) +\r\n    '\\n' +\r\n    code\r\n  );\r\n}\r\n```\r\n\r\nå¯¹äºåŒ…å« `import.meta` è°ƒç”¨çš„ä»£ç ï¼Œsnowpack éƒ½ä¼šåœ¨é‡Œé¢æ³¨å…¥å¯¹ `env.js` æ¨¡å—çš„å¯¼å…¥ï¼Œå¹¶å°†å¯¼å…¥å€¼èµ‹åœ¨ `import.meta.env` ä¸Šã€‚å› æ­¤æ„å»ºåçš„ä»£ç ä¼šå˜ä¸ºï¼š\r\n\r\n```diff\r\n+ import __SNOWPACK_ENV__ from '/__snowpack__/env.js';\r\n+ import.meta.env = __SNOWPACK_ENV__;\r\n\r\nif (import.meta.env.NODE_ENV === 'production') {\r\n    disableDebug();\r\n}\r\n```\r\n\r\nå¦‚æœæ˜¯åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œè¿˜ä¼šåŠ ä¸Š `env.js` çš„ HMRã€‚è€Œ `env.js` çš„å†…å®¹ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ç›´æ¥å°† env ä¸­çš„é”®å€¼ä½œä¸ºå¯¹è±¡çš„é”®å€¼ï¼Œé€šè¿‡ `export default` å¯¼å‡ºã€‚\r\n\r\né»˜è®¤æƒ…å†µä¸‹ `env.js` åªåŒ…å« MODE å’Œ NODE_ENV ä¸¤ä¸ªå€¼ï¼Œä½ å¯ä»¥é€šè¿‡ @snowpack/plugin-dotenv æ’ä»¶æ¥ç›´æ¥è¯»å– `.env` ç›¸å…³æ–‡ä»¶ã€‚\r\n\r\n### 3.5. CSS Modules çš„æ”¯æŒ\r\n\r\nCSS çš„æ¨¡å—åŒ–ä¸€ç›´æ˜¯ä¸€ä¸ªéš¾é¢˜ï¼Œå…¶ä¸€ä¸ªé‡è¦çš„ç›®çš„å°±æ˜¯åš CSS æ ·å¼çš„éš”ç¦»ã€‚å¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆåŒ…æ‹¬ï¼š\r\n\r\n- ä½¿ç”¨ BEM è¿™æ ·çš„å‘½åæ–¹å¼\r\n- ä½¿ç”¨ webpack æä¾›çš„ CSS Module åŠŸèƒ½\r\n- ä½¿ç”¨ styled components è¿™æ ·çš„ CSS in JS æ–¹æ¡ˆ\r\n- shadow dom çš„æ–¹æ¡ˆ\r\n\r\næˆ‘ä¹‹å‰çš„[æ–‡ç« ](https://juejin.im/post/5b20e8e0e51d4506c60e47f5)è¯¦ç»†ä»‹ç»äº†è¿™å‡ ç±»æ–¹æ¡ˆã€‚snowpack ä¹Ÿæä¾›äº†ç±»ä¼¼ webpack ä¸­çš„ CSS Modules åŠŸèƒ½ã€‚\r\n\r\n```JavaScript\r\nimport styles from './index.module.css' \r\n\r\nfunction render() {\r\n    return <div className={styles.main}>Hello world!</div>;\r\n}\r\n```\r\n\r\nè€Œåœ¨ snowpack ä¸­å¯ç”¨ CSS Module å¿…é¡»è¦ä»¥ `.module.css` ç»“å°¾ï¼Œåªæœ‰è¿™æ ·æ‰ä¼š[å°†æ–‡ä»¶ç‰¹æ®Šå¤„ç†](https://github.com/pikapkg/snowpack/blob/v2.5.1/src/commands/build.ts#L310-L313)ï¼š\r\n\r\n```JavaScript\r\nif (spec.endsWith('.module.css')) {\r\n    const resolvedUrl = path.resolve(path.dirname(outPath), spec);\r\n    allCssModules.add(resolvedUrl);\r\n    spec = spec.replace('.module.css', '.css.module.js');\r\n}\r\n```\r\n\r\nè€Œæ‰€æœ‰ CSS Module éƒ½ä¼šç»è¿‡ `wrapCssModuleResponse` æ–¹æ³•çš„[åŒ…è£…](https://github.com/pikapkg/snowpack/blob/v2.5.1/src/commands/build.ts#L362-L367)ï¼Œå…¶ä¸»è¦ä½œç”¨å°±æ˜¯å°†ç”Ÿæˆçš„å”¯ä¸€ class åçš„ token æ³¨å…¥åˆ°æ–‡ä»¶å†…ï¼Œå¹¶ä½œä¸º default å¯¼å‡ºï¼š\r\n\r\n```\r\n_cssModuleLoader = _cssModuleLoader || new (require('css-modules-loader-core'))();\r\nconst {injectableSource, exportTokens} = await _cssModuleLoader.load(code, url, undefined, () => {\r\n    throw new Error('Imports in CSS Modules are not yet supported.');\r\n});\r\nreturn `\r\n    â€¦â€¦\r\n    export let code = ${JSON.stringify(injectableSource)};\r\n    let json = ${JSON.stringify(exportTokens)};\r\n    export default json;\r\n    â€¦â€¦\r\n`;\r\n```\r\n\r\nè¿™é‡Œæˆ‘å°† HMR å’Œæ ·å¼æ³¨å…¥çš„ä»£ç çœå»äº†ï¼Œåªä¿ç•™äº† CSS Module åŠŸèƒ½çš„éƒ¨åˆ†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå®ƒå…¶å®æ˜¯å€ŸåŠ›äº† [css-modules-loader-core](https://www.npmjs.com/package/css-modules-loader-core) æ¥å®ç°çš„ CSS Module ä¸­ token ç”Ÿæˆè¿™ä¸€æ ¸å¿ƒèƒ½åŠ›ã€‚\r\n\r\nä»¥åˆ›å»ºçš„ React æ¨¡ç‰ˆä¸ºä¾‹ï¼Œå°† App.css æ”¹ä¸º App.module.css ä½¿ç”¨åï¼Œä»£ç ä¸­ä¼šå¤šå¤„å¦‚ä¸‹éƒ¨åˆ†ï¼š\r\n\r\n```diff\r\n+ let json = {\"App\":\"_dist_App_module__App\",\"App-logo\":\"_dist_App_module__App-logo\",\"App-logo-spin\":\"_dist_App_module__App-logo-spin\",\"App-header\":\"_dist_App_module__App-header\",\"App-link\":\"_dist_App_module__App-link\"};\r\n+ export default json;\r\n```\r\n\r\nå¯¹äºå¯¼å‡ºçš„é»˜è®¤å¯¹è±¡ï¼Œé”®ä¸º CSS æºç ä¸­çš„ classnameï¼Œè€Œå€¼åˆ™æ˜¯æ„å»ºåå®é™…çš„ classnameã€‚\r\n\r\n### 3.6. æ€§èƒ½é—®é¢˜\r\n\r\nè¿˜è®°å¾—[é›…è™æ€§èƒ½ä¼˜åŒ– 35 æ¡å†›è§„](https://github.com/creeperyang/blog/issues/1)ä¹ˆï¼Ÿå…¶ä¸­å°±æåˆ°äº†é€šè¿‡åˆå¹¶æ–‡ä»¶æ¥å‡å°‘è¯·æ±‚æ•°ã€‚è¿™æ—¢æ˜¯å› ä¸º TCP çš„æ…¢å¯åŠ¨ç‰¹ç‚¹ï¼Œä¹Ÿæ˜¯å› ä¸ºæµè§ˆå™¨çš„å¹¶å‘é™åˆ¶ã€‚è€Œä¼´éšè¿™å‰ç«¯å¯Œåº”ç”¨éœ€æ±‚çš„å¢å¤šï¼Œå‰ç«¯é¡µé¢å†ä¹Ÿä¸æ˜¯æ‰‹å·¥å¼•å…¥å‡ ä¸ª script è„šæœ¬å°±å¯ä»¥äº†ã€‚åŒæ—¶ï¼Œæµè§ˆå™¨ä¸­ JS åŸç”Ÿçš„æ¨¡å—åŒ–èƒ½åŠ›ç¼ºå¤±ä¹Ÿè®©ç®—æ˜¯ç«ä¸Šæµ‡æ²¹ï¼Œåˆ°åæ¥å†åŠ ä¸Š npm çš„åŠ æŒï¼Œæ‰“åŒ…å·¥å…·å‘¼ä¹‹æ¬²å‡ºã€‚webpack ä¹Ÿæ˜¯é‚£ä¸ªæ—¶ä»£èµ°è¿‡æ¥çš„äº§ç‰©ã€‚\r\n\r\néšç€è¿‘å¹´æ¥ HTTP/2 çš„æ™®åŠï¼Œ5G çš„å‘å±•è½åœ°ï¼Œæµè§ˆå™¨ä¸­ JS æ¨¡å—åŒ–çš„ä¸æ–­å‘å±•ï¼Œè¿™ä¸ªåˆå¹¶è¯·æ±‚çš„â€œçœŸç†â€ä¹Ÿè®¸å€¼å¾—æˆ‘ä»¬å†é‡æ–°å®¡è§†ä¸€ä¸‹ã€‚å»å¹´ PHILIP WALTON åœ¨åšå®¢ä¸Šå‘çš„ã€Œ[Using Native JavaScript Modules in Production Today](https://philipwalton.com/articles/using-native-javascript-modules-in-production-today/)ã€å°±æ¨èå¤§å®¶å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å°è¯•ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿçš„ JS æ¨¡å—åŠŸèƒ½ã€‚\r\n\r\nã€ŒUsing Native JavaScript Modules in Production Todayã€ è¿™ç‰‡æ–‡ç« æåˆ°ï¼Œæ ¹æ®ä¹‹å‰çš„æµ‹è¯•ï¼Œéæ‰“åŒ…ä»£ç çš„æ€§èƒ½è¾ƒæ‰“åŒ…ä»£ç è¦å·®å¾ˆå¤šã€‚ä½†è¯¥å®éªŒæœ‰åå·®ï¼ŒåŒæ—¶éšç€è¿‘æœŸçš„ä¼˜åŒ–ï¼Œéæ‰“åŒ…çš„æ€§èƒ½ä¹Ÿæœ‰äº†å¾ˆå¤§æå‡ã€‚å…¶ä¸­æ¨èçš„å®è·µæ–¹å¼å’Œ snowpack å¯¹ node_modules çš„å¤„ç†åŸºæœ¬å¦‚å‡ºä¸€è¾™ã€‚ä¿è¯äº†åŠ è½½ä¸ä¼šè¶…è¿‡ 100 ä¸ªæ¨¡å—å’Œ 5 å±‚çš„æ·±åº¦ã€‚\r\n\r\nåŒæ—¶ï¼Œç”±äºä¸šåŠ¡æŠ€æœ¯å½¢æ€çš„åŸå› ï¼Œæˆ‘æ‰€åœ¨çš„ä¸šåŠ¡çº¿ç»å†äº†ä¸€æ¬¡æ„å»ºå·¥å…·è¿ç§»ï¼Œå¯¹äºæ¨¡å—çš„å¤„ç†ä¸Šä¹Ÿç”¨äº†ç±»ä¼¼çš„ç­–ç•¥ï¼šä¸šåŠ¡ä»£ç æ¨¡å—ä¸åˆå¹¶ï¼Œåªæ‰“åŒ… node_modules ä¸­çš„æ¨¡å—ï¼Œéƒ½èµ° HTTP/2ã€‚ä½†æ˜¯æ²¡æœ‰ä½¿ç”¨åŸç”Ÿæ¨¡å—åŠŸèƒ½ï¼Œåªæ˜¯æ¨¡å—çš„åˆ†å¸ƒçŠ¶æ€ä¸ snowpack å’Œè¯¥æ–‡ä¸­æåˆ°çš„ç±»ä¼¼ã€‚ä»ä¸Šçº¿åçš„æ€§èƒ½æ•°æ®æ¥çœ‹ï¼Œæ€§èƒ½å¹¶æœªä¸‹é™ã€‚å½“ç„¶ï¼Œç”±äºå¹¶éä½¿ç”¨åŸç”Ÿæ¨¡å—åŠŸèƒ½æ¥åŠ è½½ä¾èµ–ï¼Œæ‰€ä»¥å¹¶ä¸å…¨å®Œç›¸åŒã€‚ä½†ä¹Ÿç®—æœ‰äº›å‚è€ƒä»·å€¼ã€‚\r\n\r\n### 3.7. JSX / Typescript / Vue / Less â€¦\r\n\r\nå¯¹äºéæ ‡å‡†çš„ JavaScript å’Œ CSS ä»£ç ï¼Œåœ¨ webpack ä¸­æˆ‘ä»¬ä¸€èˆ¬ä¼šç”¨ babelã€less ç­‰å·¥å…·åŠ ä¸Šå¯¹åº”çš„ loader æ¥å¤„ç†ã€‚æœ€åˆç‰ˆçš„ snowpack å¹¶æ²¡æœ‰å¯¹è¿™äº›è¯­æ³•çš„å¤„ç†èƒ½åŠ›ï¼Œè€Œæ˜¯æ¨èå°†ç›¸å…³çš„åŠŸèƒ½å¤–æ¥åˆ° snowpack å‰ï¼Œå…ˆæŠŠä»£ç è½¬æ¢å®Œï¼Œå†äº¤ç»™ snowpack æ„å»ºã€‚\r\n\r\nè€Œæ–°ç‰ˆæœ¬ä¸‹ï¼Œsnowpack å·²ç»å†…ç½®äº† JSX å’Œ Typescript æ–‡ä»¶çš„å¤„ç†ã€‚å¯¹äº typescriptï¼Œsnowpack å…¶å®ç”¨äº† typescript å®˜æ–¹æä¾›çš„ tsc æ¥ç¼–è¯‘ã€‚å¯¹äº JSX åˆ™æ˜¯é€šè¿‡ [@snowpack/plugin-babel](https://www.npmjs.com/package/@snowpack/plugin-babel) è¿›è¡Œç¼–è¯‘ï¼Œå…¶å®é™…ä¸Šåªæ˜¯å¯¹ @babel/core çš„ä¸€å±‚ç®€å•åŒ…è£…ï¼Œæœºä¸Š babel ç›¸å…³é…ç½®å³å¯å®Œæˆ JSX çš„ç¼–è¯‘ã€‚\r\n\r\n```JavaScript\r\nconst babel = require(\"@babel/core\");\r\n\r\nmodule.exports = function plugin(config, options) {\r\n  return {\r\n    defaultBuildScript: \"build:js,jsx,ts,tsx\",\r\n    async build({ contents, filePath, fileContents }) {\r\n      const result = await babel.transformAsync(contents || fileContents, {\r\n        filename: filePath,\r\n        cwd: process.cwd(),\r\n        ast: false,\r\n      });\r\n\r\n      return { result: result.code };\r\n    },\r\n  };\r\n};\r\n```\r\n\r\nä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒå°±æ˜¯è°ƒç”¨äº† `babel.transformAsync` æ–¹æ³•ã€‚è€Œä½¿ç”¨ [@snowpack/app-template-react-typescript](https://github.com/pikapkg/create-snowpack-app/tree/master/templates/app-template-react-typescript) æ¨¡æ¿ç”Ÿæˆçš„é¡¹ç›®ï¼Œä¾èµ–äº†ä¸€ä¸ªå« @snowpack/app-scripts-react çš„åŒ…ï¼Œå®ƒé‡Œé¢å°±ä½¿ç”¨äº† @snowpack/plugin-babelï¼Œä¸”ç›¸å…³çš„ babel.config.json å¦‚ä¸‹ï¼š\r\n\r\n```JavaScript\r\n{\r\n  \"presets\": [[\"@babel/preset-react\"], \"@babel/preset-typescript\"],\r\n  \"plugins\": [\"@babel/plugin-syntax-import-meta\"]\r\n}\r\n```\r\n\r\nå¯¹äº Vue é¡¹ç›® snowpack ä¹Ÿæä¾›äº†ä¸€ä¸ªå¯¹åº”çš„æ’ä»¶ [@snowpack/plugin-vue](https://www.npmjs.com/package/@snowpack/plugin-vue) æ¥æ‰“é€šæ„å»ºæµç¨‹ï¼Œå¦‚æœå»çœ‹ä¸‹è¯¥æ’ä»¶ï¼Œæ ¸å¿ƒæ˜¯ä½¿ç”¨çš„ [@vue/compiler-sfc](https://www.npmjs.com/package/@vue/compiler-sfc) æ¥è¿›è¡Œ vue ç»„ä»¶çš„ç¼–è¯‘ã€‚\r\n\r\næ­¤å¤–ï¼Œå¯¹äº Sassï¼ˆLess ä¹Ÿç±»ä¼¼ï¼‰ï¼Œsnowpack åˆ™æ¨èä½¿ç”¨è€…æ·»åŠ ç›¸åº”çš„ script å‘½ä»¤ï¼š\r\n\r\n```JavaScript\r\n\"scripts\": {\r\n  \"run:sass\": \"sass src/css:public/css --no-source-map\",\r\n  \"run:sass::watch\": \"$1 --watch\"\r\n}\r\n```\r\n\r\næ‰€ä»¥å®é™…ä¸Šå¯¹äº Sass çš„ç¼–è¯‘ç›´æ¥ä½¿ç”¨äº† sass å‘½ä»¤ï¼Œsnowpack åªæ˜¯æŒ‰å…¶çº¦å®šè¯­æ³•å¯¹åé¢çš„æŒ‡ä»¤è¿›è¡Œæ‰§è¡Œã€‚è¿™æœ‰ç‚¹ç±»ä¼¼ gulp / gruntï¼Œä½ åœ¨ scripts ä¸­å®šä¹‰çš„æ˜¯ä¸€ä¸ªç®€å•çš„â€œå·¥ä½œæµâ€ã€‚\r\n\r\nç»¼åˆ tsã€jsxã€vueã€sass è¿™äº›è¯­æ³•å¤„ç†çš„æ–¹å¼å¯ä»¥å‘ç°ï¼Œsnowpack åœ¨è¿™å—è‡ªå·±å®ç°çš„ä¸å¤šï¼Œä¸»è¦ä¾é â€œæ¡¥æ¥â€å·²æœ‰çš„å„ç§å·¥å…·ï¼Œç”¨ä¸€ç§æ–¹å¼å°†å…¶èå…¥åˆ°è‡ªå·±çš„ç³»ç»Ÿä¸­ã€‚ä¸æ­¤ç±»ä¼¼çš„ï¼Œwebpack çš„ loader ä¹Ÿæ˜¯è¿™ä¸€æ€æƒ³ï¼Œä¾‹å¦‚ babel-loader å°±æ˜¯ webpack å’Œ babel çš„æ¡¥ã€‚è¯´åˆ°åº•ï¼Œè¿˜æ˜¯æŒ‡è´£è¾¹ç•Œçš„é—®é¢˜ã€‚å¦‚æœç›®æ ‡æ˜¯æˆä¸ºå‰ç«¯å¼€å‘çš„æ„å»ºå·¥å…·ï¼Œä½ å¯ä»¥ä¸å»å®ç°å·²æœ‰çš„è¿™äº›å­æ„å»ºè¿‡ç¨‹ï¼Œä½†éœ€è¦å°†å…¶èå…¥åˆ°è‡ªå·±çš„ä½“ç³»é‡Œã€‚\r\n\r\nä¹Ÿæ­£æ˜¯å› ä¸ºè¿‘å¹´æ¥å‰ç«¯æ„å»ºå·¥å…·çš„ç¹è£ï¼Œè®© snowpack å¯ä»¥æ‰¾åˆ°å„ç±»å€ŸåŠ›çš„å·¥å…·ï¼Œè½»é‡çº§åœ°å®ç°äº†æ„å»ºæµç¨‹ã€‚\r\n\r\n## 4. æœ€åèŠèŠ\r\n\r\nsnowpack çš„ä¸€å¤§ç‰¹ç‚¹æ˜¯å¿« â€”â€” å…¨é‡æ„å»ºå¿«ï¼Œå¢é‡æ„å»ºä¹Ÿå¿«ã€‚å› ä¸ºä¸éœ€è¦æ‰“åŒ…ï¼Œæ‰€ä»¥å®ƒä¸éœ€è¦åƒ webpack é‚£æ ·æ„ç­‘ä¸€ä¸ªå·¨å¤§çš„ä¾èµ–å›¾è°±ï¼Œå¹¶æ ¹æ®ä¾èµ–å…³ç³»è¿›è¡Œå„ç§åˆå¹¶ã€æ‹†åˆ†è®¡ç®—ã€‚snowpack çš„å¢é‡æ„å»ºåŸºæœ¬å°±æ˜¯æ”¹åŠ¨ä¸€ä¸ªæ–‡ä»¶å°±å¤„ç†è¿™ä¸ªæ–‡ä»¶å³å¯ï¼Œæ¨¡å—ä¹‹é—´ç®—æ˜¯â€œæ¾æ•£â€çš„è€¦åˆã€‚\r\n\r\nè€Œ webpack è¿˜æœ‰ä¸€å¤§ç—›ç‚¹å°±æ˜¯â€œå¤–éƒ¨â€œä¾èµ–çš„å¤„ç†ï¼Œâ€œå¤–éƒ¨â€ä¾èµ–æ˜¯æŒ‡ï¼š\r\n\r\n- æ¨¡å— A è¿è¡Œæ—¶å¯¹ B æ˜¯æœ‰ä¾èµ–å…³ç³»\r\n- ä½†æ˜¯ä¸å¸Œæœ›åœ¨ A æ„å»ºé˜¶æ®µæŠŠ B ä¹Ÿæ‹¿æ¥ä¸€èµ·æ„å»º\r\n\r\nè¿™æ—¶å€™ B å°±åƒæ˜¯â€œå¤–éƒ¨â€ä¾èµ–ã€‚åœ¨ä¹‹å‰å…¸å‹çš„ä¸€ä¸ªè§£å†³æ–¹å¼å°±æ˜¯ externalï¼Œå½“ç„¶è¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨å‰ç«¯åŠ è½½å™¨åŠ è½½ UMDã€AMD åŒ…ã€‚æˆ–è€…æ›´è¿›ä¸€æ­¥ï¼Œåœ¨ webpack 5 ä¸­ä½¿ç”¨ Module Federation æ¥å®ç°ã€‚è¿™ä¸€éœ€æ±‚çš„å¯èƒ½åœºæ™¯å°±æ˜¯å¾®å‰ç«¯ã€‚å„ä¸ªå‰ç«¯å¾®æœåŠ¡å¦‚æœè¦ç»Ÿä¸€ä¸€èµ·æ„å»ºï¼Œå¿…ç„¶ä¼šéšç€é¡¹ç›®çš„è†¨èƒ€æ„å»ºè¶Šæ¥è¶Šæ…¢ï¼Œæ‰€ä»¥ç‹¬ç«‹æ„å»ºï¼ŒåŠ¨æ€åŠ è½½è¿è¡Œçš„éœ€æ±‚ä¹Ÿå°±å‡ºç°äº†ã€‚\r\n\r\nå¯¹äºæ‰“åŒ…å™¨æ¥è¯´ï¼Œ`import 'B.js'` é»˜è®¤å…¶å®å°±æ˜¯éœ€è¦å°† B æ¨¡å—æ‰“åŒ…è¿›æ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰éœ€è¦é‚£ä¹ˆå¤šâ€œåå‘â€çš„é…ç½®å°†è¿™ç§é»˜è®¤è¡Œä¸ºç¦æ­¢æ‰ï¼ŒåŒæ—¶æä¾›ä¸€ä¸ªé¢„æœŸçš„è¿è¡Œæ—¶æ–¹æ¡ˆã€‚è€Œå¦‚æœç«™åœ¨åŸç”Ÿ JavaScript Module çš„å·¥ä½œæ–¹å¼ä¸Šæ¥è¯´ï¼Œ`import '/dist/B.js'` å¹¶ä¸éœ€è¦åœ¨æ„å»ºçš„æ—¶å€™è·å– B æ¨¡å—ï¼Œè€Œåªæ˜¯åœ¨è¿è¡Œæ—¶æ‰æœ‰è€¦åˆå…³ç³»ã€‚å…¶å¤©ç”Ÿå°±æ˜¯æ„å»ºæ—¶éä¾èµ–ï¼Œè¿è¡Œæ—¶ä¾èµ–çš„ã€‚å½“ç„¶ï¼Œç›®å‰ snowpack åœ¨æ„å»ºæ—¶å¦‚æœç¼ºå°‘çš„ä¾èµ–æ¨¡å—ä»ç„¶ä¼šæŠ›å‡ºé”™è¯¯ï¼Œä½†ä¸Šé¢æ‰€è¯´çš„æœ¬è´¨ä¸Šæ˜¯å¯å®ç°ï¼Œéš¾åº¦è¾ƒæ‰“åŒ…å™¨ä¼šä½å¾ˆå¤šï¼Œè€Œä¸”ä¼šæ›´ç¬¦åˆä½¿ç”¨è€…çš„ç›´è§‰ã€‚\r\n\r\né‚£ä¹ˆ snowpack æ˜¯ bundleless çš„ä¹ˆï¼Ÿæˆ‘ä»¬å¯ä»¥ä»è¿™å‡ ä¸ªæ–¹é¢æ¥çœ‹ï¼š\r\n\r\n- å®ƒå¯¹ä¸šåŠ¡ä»£ç çš„å¤„ç†æ˜¯ bundleless çš„\r\n- ç›®å‰å¯¹ node_modules çš„å¤„ç†æ˜¯åšäº† bundle çš„\r\n- å®ƒä»ç„¶æä¾›äº† @snowpack/plugin-webpack / @snowpack/plugin-parcel è¿™æ ·çš„æ’ä»¶æ¥è®©ä½ èƒ½[ä¸ºç”Ÿäº§ç¯å¢ƒåšæ‰“åŒ…](https://www.snowpack.dev/#bundle-for-production)ã€‚æ‰€ä»¥ï¼Œé…åˆ module/nomodule æŠ€æœ¯ï¼Œå®ƒå°†ä¼šæœ‰æ›´å¼ºçš„æŠµå¾¡å…¼å®¹æ€§é—®é¢˜çš„èƒ½åŠ›ï¼Œè¿™ä¹Ÿç®—æ˜¯ä¸€ç§æ¸è¿›å¼è¥é”€æ‰‹æ®µ\r\n\r\næœ€åï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼š\r\n\r\n**In 2019, you should use a bundler because you want to, not because you need to.**","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/39","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/39/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/39/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/39/events","html_url":"https://github.com/alienzhou/blog/issues/39","id":612641497,"node_id":"MDU6SXNzdWU2MTI2NDE0OTc=","number":39,"title":"lookup-dns-cache ç›¸å…³è°ƒç ”","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":2045616625,"node_id":"MDU6TGFiZWwyMDQ1NjE2NjI1","url":"https://api.github.com/repos/alienzhou/blog/labels/Node.js","name":"Node.js","color":"c3ea81","default":false,"description":""},{"id":1159855196,"node_id":"MDU6TGFiZWwxMTU5ODU1MTk2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E6%9C%8D%E5%8A%A1%E7%AB%AF","name":"æœåŠ¡ç«¯","color":"0bbaae","default":false,"description":""},{"id":1159845016,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%BB%BC%E5%90%88","name":"ç»¼åˆ","color":"a2eeef","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-05-05T14:21:00Z","updated_at":"2020-05-08T08:18:51Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## å¼•è¨€\r\n\r\nè¿‘æœŸåœ¨åšä¸€ä¸ª DNS æœåŠ¡å™¨åˆ‡æ¢çš„æ¼”ç»ƒä¸­å‘ç°æˆ‘ä»¬åœ¨ NodeJS ä¸­ä½¿ç”¨çš„ axios ä»¥åŠé»˜è®¤çš„ `dns.lookup` æ–¹æ³•å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä¼šå¯¼è‡´åˆ‡æ¢è¿‡ç¨‹ä¸­çš„å“åº”è€—æ—¶ä» ~80ms ä¸Šå‡è‡³ ~3minï¼ˆå…·ä½“å‚è§[nodeä¸­è¯·æ±‚è¶…æ—¶çš„ä¸€äº›å‘](https://acemood.github.io/2020/05/02/node%E4%B8%AD%E8%AF%B7%E6%B1%82%E8%B6%85%E6%97%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/)ï¼‰ã€‚è®¡åˆ’çš„éƒ¨åˆ†è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ lookup-dns-cache æ¥æ›¿æ¢é»˜è®¤çš„ `dns.lookup` æ–¹æ³•ã€‚\r\n\r\n## éœ€è¦è§£ç­”çš„ç–‘é—®\r\n\r\nå¦‚æœä½¿ç”¨ lookup-dns-cache æ¥æ›¿æ¢é»˜è®¤çš„ `dns.lookup`ï¼Œéœ€è¦ç¡®è®¤ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼š\r\n\r\n1. ä½¿ç”¨è¯¥ package åï¼ŒDNS æŸ¥è¯¢ä¸ç¼“å­˜çš„å…·ä½“å®ç°ç»†èŠ‚æ˜¯æ€æ ·çš„ï¼Ÿ\r\n1. ä½¿ç”¨è¯¥ package åæ˜¯å¦ä¸ `dns.lookup` ä¸€æ ·ï¼Œåœ¨ Linux ä¸Šä¹Ÿä½¿ç”¨ resolv.conf é…ç½®ï¼Ÿ\r\n1. ä½¿ç”¨ lookup-dns-cache åæ— æ³•æ§åˆ¶ timeout å€¼\r\n\r\nä¸‹é¢åŸºäº [NodeJS v12.16.3](https://github.com/nodejs/node/tree/v12.16.3) åˆ†åˆ«å¯¹è¿™ä¸‰ä¸ªé—®é¢˜è¿›è¡Œåˆ†æã€‚\r\n\r\n## TL;DR\r\n\r\n1. lookup-dns-cache åœ¨ JS è¿™ä¸€å±‚åšäº†é˜²æ­¢é‡å¤è¯·æ±‚å’Œç¼“å­˜ä¸¤å¤„ä¼˜åŒ–\r\n1. lookup-dns-cache æœ€åº•å±‚ä¹Ÿä½¿ç”¨äº† resolv.conf è¿™ä¸ªé…ç½®\r\n1. ä½¿ç”¨ lookup-dns-cache åæ— æ³•æ§åˆ¶ timeout å€¼\r\n\r\n## é—®é¢˜ä¸€ï¼šæŸ¥è¯¢ä¸ç¼“å­˜å®ç°ç»†èŠ‚\r\n\r\n[lookup-dns-cache](https://www.npmjs.com/package/lookup-dns-cache) æ•´ä½“ä»£ç é‡å¾ˆå°‘ï¼ŒDNS æŸ¥è¯¢ç›¸å…³åŠŸèƒ½éƒ½å§”æ‰˜ç»™äº† `dns.resolve*` æ–¹æ³•ã€‚[ä¸ `dns.lookup` ä¸åŒ](https://nodejs.org/docs/latest-v10.x/api/dns.html#dns_implementation_considerations)ï¼Œ`dns.resolve*` å¹¶ä¸ä½¿ç”¨ `getaddrinfo`ï¼Œå¹¶ä¸”æ˜¯å¼‚æ­¥å®ç°ã€‚\r\n\r\nlookup-dns-cache ä¸»è¦æ˜¯åœ¨ `dns.resolve*` ä¹‹ä¸Šæä¾›äº†ä¸¤ä¸ªä¼˜åŒ–ç‚¹ï¼š\r\n\r\n1. é¿å…é¢å¤–çš„å¹¶è¡Œè¯·æ±‚ï¼šå¯¹åŒä¸€ä¸ª hostname çš„å¹¶è¡ŒæŸ¥è¯¢ï¼Œåœ¨æŸ¥è¯¢è¯·æ±‚æœªç»“æŸå‰ï¼Œåªä¼šæ‰§è¡Œä¸€æ¬¡ `dns.resolve*`ï¼Œå…¶ä½™æ”¾ç½®åœ¨å›è°ƒé˜Ÿåˆ—ï¼›\r\n1. DNS æŸ¥è¯¢ç»“æœçš„ç¼“å­˜ï¼šæä¾›åŸºäº TTL çš„ç¼“å­˜èƒ½åŠ›ã€‚\r\n\r\n### 1 - é¿å…é¢å¤–çš„å¹¶è¡Œè¯·æ±‚\r\n\r\nè¯¥å¤„ä¸»è¦æ˜¯ç”¨è¿‡ `TasksManager` æ¥å®ç°ã€‚[å®ç°å¾ˆç®€å•](https://github.com/eduardbcom/lookup-dns-cache/blob/2.1.0/src/TasksManager.js)ï¼Œå‘èµ· DNS æŸ¥è¯¢æ—¶ï¼Œç”¨ Map å­˜å‚¨å½“å‰æ­£åœ¨è¿›è¡ŒæŸ¥è¯¢çš„ hostnameï¼ŒæŸ¥è¯¢ç»“æŸåï¼Œä» Map ä¸­åˆ é™¤ã€‚å…·ä½“è°ƒç”¨åˆ™åœ¨ Lookup.js çš„ [`_innerResolve` ä¸­](https://github.com/eduardbcom/lookup-dns-cache/blob/2.1.0/src/Lookup.js#L200-L218)ï¼š\r\n\r\n```JavaScript\r\nlet task = this._tasksManager.find(key);\r\n\r\nif (task) {\r\n  task.addResolvedCallback(callback);\r\n} else {\r\n  task = new ResolveTask(hostname, ipVersion);\r\n  this._tasksManager.add(key, task);\r\n  task.on('addresses', addresses => {\r\n    this._addressCache.set(key, addresses);\r\n  });\r\n  task.on('done', () => {\r\n    this._tasksManager.done(key);\r\n  });\r\n  task.addResolvedCallback(callback);\r\n  task.run();\r\n}\r\n```\r\n\r\nå…¶ä¸­çš„ key æ˜¯é€šè¿‡ ``${hostname}_${ipVersion}`` æ‹¼æ¥è€Œæˆï¼ˆipVersion:ipv4/ipv4ï¼‰ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœåœ¨ `TasksManager` å®ä¾‹ä¸­æ‰¾åˆ° taskï¼Œåˆ™åªæ·»åŠ å›è°ƒï¼Œå¦åˆ™å°±å‘èµ·ä¸€ä¸ªæŸ¥è¯¢ï¼Œå³åˆ›å»ºä¸€ä¸ª `ResolveTask` å®ä¾‹ã€‚\r\n\r\n### 2 - DNS ç¼“å­˜\r\n\r\nlookup-dns-cache é€šè¿‡ä¸º resolve* æ–¹æ³•è®¾ç½® `ttl: true` æ¥è®© DNS æŸ¥è¯¢ç»“æœè¿”å› TTL å€¼ã€‚å¯¹äºæŸ¥è¯¢å›æ¥çš„ç»“æœä¼šåœ¨å½“å‰æ—¶é—´åŸºç¡€ä¸Š[åŠ ä¸Š TTL æ¥ä½œä¸ºè¿‡æœŸæ—¶é—´](https://github.com/eduardbcom/lookup-dns-cache/blob/2.1.0/src/ResolveTask.js#L82-L85)ï¼š\r\n\r\n```JavaScript\r\naddresses.forEach(address => {\r\n  address.family = this._ipVersion;\r\n  address.expiredTime = Date.now() + address.ttl * 1000;\r\n});\r\n```\r\n\r\nå½“è¿›è¡Œ DNS æŸ¥è¯¢å‰ï¼Œä¼šå…ˆæŸ¥ç¼“å­˜ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥è¿”å›ã€‚è€Œåœ¨ AddressCache ä¸­è¿›è¡Œç¼“å­˜æŸ¥è¯¢æ—¶ï¼Œ[å¦‚æœåˆ¤æ–­å½“å‰æ—¶é—´è¶…è¿‡è¿‡æœŸæ—¶é—´ï¼Œåˆ™ä¸å†è¿”å›ç¼“å­˜ç»“æœ](https://github.com/eduardbcom/lookup-dns-cache/blob/2.1.0/src/AddressCache.js#L21-L23)ï¼š\r\n\r\n```JavaScript\r\nfind(key) {\r\n  if (!this._cache.has(key)) {\r\n    return;\r\n  }\r\n\r\n  const addresses = this._cache.get(key);\r\n  if (this._isExpired(addresses)) {\r\n    return;\r\n  }\r\n\r\n  return addresses;\r\n}\r\n```\r\n\r\nè¿™é‡Œå¯èƒ½ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœæŸ¥è¯¢çš„åŸŸååç§°æ— é™ï¼Œç”±äºç¼“å­˜ä¸­ä»…åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼Œå¹¶æ— è¿‡æœŸæ¸…ç†æ“ä½œï¼Œå› æ­¤è¿‡æœŸç¼“å­˜å¯èƒ½ä¼šä¸€ç›´å ç”¨å†…å­˜è€Œä¸é‡Šæ”¾ã€‚å½“ç„¶ï¼Œç”±äºæ™®é€šä¸šåŠ¡é¡¹ç›®ä¸­ï¼ŒåŸŸåæŸ¥è¯¢çš„ç§ç±»æœ‰é™ï¼Œå¹¶ä¸”åŸºæœ¬ä¼šä¸€ç›´é‡å¤ï¼Œå› æ­¤å¹¶ä¸ä¼šæš´éœ²è¯¥é—®é¢˜ã€‚\r\n\r\n---\r\n\r\n## é—®é¢˜äºŒï¼šæ˜¯å¦ä½¿ç”¨ resolv.conf é…ç½®\r\n\r\n### 1 - `dns.resolve*` ç­‰æ–¹æ³•æºç åˆ†æ\r\n\r\n#### NodeJS éƒ¨åˆ†\r\n\r\nåœ¨ `lib/dns.js` æœ€åå¯ä»¥å‘ç°ï¼Œdns æ¨¡å—å¯¼å‡ºçš„ç›¸å…³ resolve æ–¹æ³•æ˜¯é€šè¿‡\r\n\r\n```JavaScript\r\nbindDefaultResolver(module.exports, getDefaultResolver());\r\n```\r\n\r\nè¿™è¡Œç»‘å®šä¸Šå»çš„ã€‚\r\n\r\nè€Œåœ¨ `lib/internal/dns/utils.js` ä¸­ä¼šå‘ç°ï¼Œ`getDefaultResolver` æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª Resolver å®ä¾‹ã€‚åœ¨è¿™ä¸ªæ¨¡å—é‡Œå¹¶æ²¡æœ‰å„ç§ resolve æ–¹æ³•ï¼Œè€Œå…·ä½“å…¶ä¸Šçš„ resolve æ–¹æ³•åˆ™è¿˜æ˜¯åœ¨ [`lib/dns.js` ä¸­å®ç°çš„](https://github.com/nodejs/node/blob/v12.16.3/lib/dns.js#L207-L246)ï¼š\r\n\r\n```JavaScript\r\n...\r\nfunction resolver(bindingName) {\r\n  function query(name, /* options, */ callback) {\r\n    let options;\r\n    if (arguments.length > 2) {\r\n      options = callback;\r\n      callback = arguments[2];\r\n    }\r\n\r\n    validateString(name, 'name');\r\n    if (typeof callback !== 'function') {\r\n      throw new ERR_INVALID_CALLBACK(callback);\r\n    }\r\n\r\n    const req = new QueryReqWrap();\r\n    req.bindingName = bindingName;\r\n    req.callback = callback;\r\n    req.hostname = name;\r\n    req.oncomplete = onresolve;\r\n    req.ttl = !!(options && options.ttl);\r\n    const err = this._handle[bindingName](req, toASCII(name));\r\n    if (err) throw dnsException(err, bindingName, name);\r\n    return req;\r\n  }\r\n  ObjectDefineProperty(query, 'name', { value: bindingName });\r\n  return query;\r\n}\r\n\r\nconst resolveMap = ObjectCreate(null);\r\nResolver.prototype.resolveAny = resolveMap.ANY = resolver('queryAny');\r\nResolver.prototype.resolve4 = resolveMap.A = resolver('queryA');\r\nResolver.prototype.resolve6 = resolveMap.AAAA = resolver('queryAaaa');\r\nResolver.prototype.resolveCname = resolveMap.CNAME = resolver('queryCname');\r\n...\r\n```\r\n\r\nè€Œè¿™é‡Œå…³äº DNS æŸ¥è¯¢è°ƒç”¨çš„æ ¸å¿ƒçš„æ–¹æ³•å°±æ˜¯ `this._handle[bindingName](req, toASCII(name))`ã€‚å¦‚æœæˆ‘ä»¬å†å›åˆ° [`lib/internal/dns/utils.js` è¿™ä¸ªå®šä¹‰ Resolver ç±»çš„åœ°æ–¹å°±ä¼šå‘ç°](https://github.com/nodejs/node/blob/v12.16.3/lib/internal/dns/utils.js#L28)ï¼š\r\n\r\n```JavaScript\r\n...\r\nclass Resolver {\r\n  constructor() {\r\n    this._handle = new ChannelWrap();\r\n  }\r\n  ...\r\n}\r\n...\r\n```\r\n\r\n`this._handle` æ˜¯ `ChannelWrap` çš„ä¸€ä¸ªå®ä¾‹ã€‚`ChannelWrap` æ¥è‡ªäºå¯¹ [c-ares](https://github.com/c-ares/c-ares) çš„å†…éƒ¨ç»‘å®š â€”â€” [cares_wrap.cc](https://github.com/nodejs/node/blob/v12.16.3/src/cares_wrap.cc)ã€‚\r\n\r\n> [c-ares](https://github.com/c-ares/c-ares): This is an asynchronous resolver library. It is intended for applications which need to perform DNS queries without blocking, or need to perform multiple DNS queries in parallel.\r\n\r\n**æŒ‰ç…§å®˜æ–¹æ–‡æ¡£çš„è¯´æ³•ï¼Œc-ares æ”¯æŒ resolv.confã€‚ä½†ä¸ºäº†ä¿é™©èµ·è§ï¼Œå…·ä½“æƒ…å†µå¦‚ä½•éœ€è¦ç»§ç»­å‘ä¸‹è¿›ä¸€æ­¥ç¡®è®¤ã€‚**\r\n\r\næ‹‰åˆ° cares_wrap.cc çš„æœ€åå°±å¯ä»¥çœ‹åˆ°é’ˆå¯¹ NodeJS å±‚çš„[ä¸€äº›ç»‘å®šä»£ç ](https://github.com/nodejs/node/blob/v12.16.3/src/cares_wrap.cc#L2225-L2251)ï¼Œè¿™é‡Œæˆªå–å’Œ `dns.resolve` ç›¸å…³éƒ¨åˆ†ï¼š\r\n\r\n```C++\r\n...\r\nLocal<FunctionTemplate> channel_wrap =\r\n      env->NewFunctionTemplate(ChannelWrap::New);\r\n  channel_wrap->InstanceTemplate()->SetInternalFieldCount(1);\r\n  channel_wrap->Inherit(AsyncWrap::GetConstructorTemplate(env));\r\nenv->SetProtoMethod(channel_wrap, \"queryAny\", Query<QueryAnyWrap>);\r\nenv->SetProtoMethod(channel_wrap, \"queryA\", Query<QueryAWrap>);\r\nenv->SetProtoMethod(channel_wrap, \"queryAaaa\", Query<QueryAaaaWrap>);\r\nenv->SetProtoMethod(channel_wrap, \"queryCname\", Query<QueryCnameWrap>);\r\n...\r\nLocal<String> channelWrapString =\r\n      FIXED_ONE_BYTE_STRING(env->isolate(), \"ChannelWrap\");\r\n  channel_wrap->SetClassName(channelWrapString);\r\n  target->Set(env->context(), channelWrapString,\r\n              channel_wrap->GetFunction(context).ToLocalChecked()).Check();\r\n...\r\n```\r\n\r\nä»¥ä¸Šä»£ç ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåœ¨ C++ å±‚åˆ›å»ºäº† JS çš„ `ChannelWrap` ç±»ï¼ŒåŒæ—¶è®¾ç½®ç›¸åº”çš„åŸå‹æ–¹æ³•ã€‚å› æ­¤ï¼Œåœ¨ JS å±‚ `new ChannelWrap()` åŸºæœ¬ä¸Šçš„è°ƒç”¨é“¾æ¡ä¸º `ChannelWrap::New` --> `ChannelWrap::ChannelWrap` --> `ChannelWrap::Setup`ã€‚å…¶ä¸­ Setup é˜¶æ®µè°ƒç”¨äº† c-ares çš„[åˆå§‹åŒ–é…ç½®æ–¹æ³•](https://github.com/nodejs/node/blob/v12.16.3/src/cares_wrap.cc#L476)ï¼š\r\n\r\n```C++\r\nvoid ChannelWrap::Setup() {\r\n  ...\r\n\r\n  /* We do the call to ares_init_option for caller. */\r\n  r = ares_init_options(&channel_,\r\n                        &options,\r\n                        ARES_OPT_FLAGS | ARES_OPT_SOCK_STATE_CB);\r\n\r\n  ...\r\n}\r\n```\r\n\r\næ³¨æ„è¿™é‡Œçš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå°±æ˜¯è¯¥æ–¹æ³•çš„ opmaskï¼Œä¼šå†³å®šä½¿ç”¨å“ªäº› optionsã€‚\r\n\r\n#### c-ares éƒ¨åˆ†\r\n\r\nåœ¨ c-ares ä¸­å…·ä½“é…ç½®ï¼ˆåŒ…æ‹¬ dns serverï¼‰çš„åˆå§‹åŒ–æœ‰å››ä¸ªæ­¥éª¤ï¼Œä»å‰åˆ°ååˆ†åˆ«æ˜¯ï¼š\r\n\r\n- [é€šè¿‡ä¼ å‚åˆå§‹åŒ–é…ç½®ï¼šinit_by_options](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_init.c#L196)\r\n- [é€šè¿‡ç¯å¢ƒå˜é‡åˆå§‹åŒ–é…ç½®ï¼šinit_by_environment](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_init.c#L203)\r\n- [é€šè¿‡ resolv conf åˆå§‹åŒ–ï¼š init_by_resolv_conf](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_init.c#L208)\r\n- [é»˜è®¤å€¼å¡«å……ï¼šinit_by_defaults](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_init.c#L218)\r\n\r\nåœ¨ç¬¬ä¸€ç§é€šè¿‡ option ç»“æ„ä½“ä¼ å‚ä¸­ï¼Œares ä¼šé€šè¿‡ `options->nservers` æ¥è·å– DNS æœåŠ¡å™¨é…ç½®ã€‚ä½†åŒæ—¶ï¼Œéœ€è¦åœ¨[æ“ä½œæ©ç ä¸­è®¾ç½® `ARES_OPT_SERVERS`](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_init.c#L482-L502)ã€‚è€Œåœ¨ NodeJS ä¸­å€¼è®¾ç½®äº† `ARES_OPT_FLAGS | ARES_OPT_SOCK_STATE_CB`ï¼Œå› æ­¤ä¸ä¼šè®¾ç½® nserversã€‚æ­¤å¤–ï¼Œinit_by_options ä¸­è¿˜ä¼š[è®¾ç½® resolvconf_path çš„å€¼](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_init.c#L547-L552)ï¼Œè¯¥å€¼æ‰€æŒ‡å‘çš„åœ°å€å°±æ˜¯ç³»ç»Ÿ resolv.conf çš„åœ°å€ï¼š\r\n\r\n```C++\r\n/* Set path for resolv.conf file, if given. */\r\nif ((optmask & ARES_OPT_RESOLVCONF) && !channel->resolvconf_path)\r\n  {\r\n    channel->resolvconf_path = ares_strdup(options->resolvconf_path);\r\n    if (!channel->resolvconf_path && options->resolvconf_path)\r\n      return ARES_ENOMEM;\r\n  }\r\n```\r\n\r\nåŒæ ·çš„ï¼Œä»ä¸Šé¢èŠ‚é€‰çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒNodeJS è°ƒç”¨ä¸­ optmask å¹¶ä¸åŒ…å« `ARES_OPT_RESOLVCONF`ï¼Œå› æ­¤ `channel->resolvconf_path` ä¸ºç©ºï¼Œè€Œæ­¤å¤„ä¹Ÿä¼šå½±å“åç»­çš„ `init_by_resolv_conf` æ–¹æ³•ã€‚\r\n\r\nä» `ares_init_options` ä»£ç çš„æµç¨‹æ§åˆ¶æ¥çœ‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œè®¾ç½®å®Œä¼ å‚å’Œç¯å¢ƒå˜é‡åï¼Œæœ€ç»ˆä¼šèµ°åˆ° `init_by_resolv_conf` ä¸­ã€‚`init_by_resolv_conf` æ–¹æ³•ä¸»è¦æ˜¯ç”¨æ¥è§£æå’Œè·å– nameserversï¼Œå…¶ä¸­åŒ…å«æ¯”è¾ƒå¤šå¹³å°ç›¸å…³çš„æ¡ä»¶ç¼–è¯‘ï¼Œæˆ‘ä»¬å¯ä»¥å…³æ³¨ä¸¤ä¸ªæ¡ä»¶åˆ†æ”¯ï¼š\r\n\r\n- `#elif defined(CARES_USE_LIBRESOLV)`\r\n- æœ€åçš„æ¡ä»¶åˆ†æ”¯\r\n\r\n`CARES_USE_LIBRESOLV` è¿™ä¸ªå®è¡¨ç¤º[æ˜¯å¦ä½¿ç”¨ resolv è¿™ä¸ªåº“](https://github.com/c-ares/c-ares/blob/baf6f4eb4240d6c8844f751570b3c151af263d93/CMakeLists.txt#L140-L142)ã€‚\r\n\r\n```\r\nIF ((IOS OR APPLE) AND HAVE_LIBRESOLV)\r\n\tSET (CARES_USE_LIBRESOLV 1)\r\nENDIF()\r\n```\r\n\r\nçœ‹èµ·æ¥ä¼¼ä¹æ˜¯åœ¨è‹¹æœç³»ç»Ÿä¸‹ä¼šå¯ç”¨ã€‚ä¸€æ—¦ä½¿ç”¨è¿™ä¸ªåº“ï¼Œæ¡ä»¶åˆ†æ”¯é‡Œå°±ä¼šæœ‰ä¸¤ä¸ªé‡è¦çš„å‡½æ•°è°ƒç”¨ â€”â€” [`res_ninit`](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_init.c#L1607) å’Œ [`res_getservers`](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_init.c#L1613)ã€‚\r\n\r\nä»æ‰‹å†Œä¸­å¯ä»¥çœ‹å‡ºï¼Œ`res_ninit` ä¼šè¯»å– [resolv.conf](http://man7.org/linux/man-pages/man3/resolver.3.html#:~:text=read%20the%20configuration%20files)ï¼Œ\r\n\r\n> The res_ninit() and res_init() functions read the configuration files (see resolv.conf(5)) to get the default domain name and name server address(es).\r\n\r\nå› æ­¤åœ¨è¯¥åˆ†æ”¯ä¸­ä¼šä½¿ç”¨ resolv.conf æ–‡ä»¶ã€‚\r\n\r\nå†çœ‹å¦ä¸€æ¡åˆ†æ”¯ã€‚[æœ€åæ¡ä»¶åˆ†æ”¯ï¼ˆçœ‹èµ·æ¥åº”è¯¥æ˜¯ Linuxï¼‰çš„å¤„ç†](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_init.c#L1661)ï¼Œå…¶ä¸­ä¼š[ä¼˜å…ˆè¯»å– resolv.conf çš„é…ç½®åœ°å€ï¼Œä¸å­˜åœ¨åˆ™å–é¢„å®šä¹‰çš„å®å˜é‡](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_init.c#L1678-L1682)ï¼š\r\n\r\n```C++\r\n/* Support path for resolvconf filename set by ares_init_options */\r\nif(channel->resolvconf_path) {\r\n  resolvconf_path = channel->resolvconf_path;\r\n} else {\r\n  resolvconf_path = PATH_RESOLV_CONF;\r\n}\r\n```\r\n\r\n`PATH_RESOLV_CONF` åˆ™å®šä¹‰åœ¨ [`ares_private.h`](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_private.h#L84) ä¸­ï¼š\r\n\r\n```C++\r\n#define PATH_RESOLV_CONF        \"/etc/resolv.conf\"\r\n```\r\n\r\n`channel->nservers` çš„è®¾ç½®ä¹Ÿæ˜¯é€šè¿‡è¯»å–æ–‡ä»¶ä¸­çš„ nameserver é…ç½®é¡¹æ¥æ·»åŠ çš„ï¼š\r\n\r\n```C++\r\nelse if ((p = try_config(line, \"nameserver\", ';')) &&\r\n      channel->nservers == -1)\r\n  status = config_nameserver(&servers, &nservers, p);\r\n```\r\n\r\n> è¿™é‡Œæœ‰ä¸ªå€¼å¾—æ³¨æ„çš„åœ°æ–¹ï¼Œå¦‚æœä½ å…·ä½“å»çœ‹ï¼Œä¼šå‘ç°å¹¶æ²¡æœ‰è¯»å– timeout é…ç½®ï¼Œè¿™ä¸ªå¯èƒ½è¯´æ˜ï¼Œå¦‚æœä½¿ç”¨ `dns.resolve`ï¼Œé…ç½®ä¸­çš„ timeout å˜é‡å¹¶ä¸ä¼šç”Ÿæ•ˆã€‚\r\n\r\n\r\nè®¾ç½®å®Œæˆä¹‹åï¼Œå½“éœ€è¦è¿›è¡Œ DNS æŸ¥è¯¢æ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ ares_send.c ä¸­çš„ `ares_send` æ–¹æ³•æ¥å‘é€æŸ¥è¯¢è¯·æ±‚ã€‚å…¶ä¸­å°±ä¼š[ä½¿ç”¨ `channel->nservers` ä¸­çš„å€¼æ¥ä½œä¸ºæœ¬åœ° DNS æŸ¥è¯¢æœåŠ¡å™¨](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_send.c#L103-L105)ï¼Œå…¶ä¸­ last_server [é»˜è®¤ä¸º 0](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_init.c#L174)ï¼š\r\n\r\n```C++\r\n/* Choose the server to send the query to. If rotation is enabled, keep track\r\n * of the next server we want to use. */\r\nquery->server = channel->last_server;\r\nif (channel->rotate == 1)\r\n  channel->last_server = (channel->last_server + 1) % channel->nservers;\r\n```\r\n\r\n> è¿™é‡Œè¿˜æœ‰ä¸ªç»†èŠ‚ï¼Œ[ä»ä»£ç ä¸Šæ¥çœ‹](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_send.c#L104-L105)ï¼Œå¯ä»¥é€šè¿‡æ§åˆ¶ `channel->rotate` çš„å€¼ä¸º 1 æ¥å¼€å¯æœ¬åœ° DNS æŸ¥è¯¢æœåŠ¡å™¨çš„ RoundRobin ç­–ç•¥ã€‚è€Œä»å®ç°ä¸Šæ¥çœ‹ï¼Œå®ƒæ˜¯é€šè¿‡ options å’Œ opmask æ¥æ§åˆ¶çš„ï¼Œä¼¼ä¹ä¸ä¼šå› ä¸º resolv.conf é…ç½®å¤šä¸ª nameserver è€Œè‡ªåŠ¨ rrï¼Ÿ\r\n\r\nç»¼åˆä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼Œåœ¨ NodeJSï¼ˆv12.16.3ï¼‰ä¸­ï¼Œè°ƒç”¨ `dns.resolve*` ç›¸å…³æ–¹æ³•ï¼Œåº•å±‚ä¼šè°ƒç”¨ [c-ares](https://github.com/c-ares/c-ares) è¿™ä¸ªåº“ã€‚æ ¹æ® c-ares çš„å®ç°æ¥åˆ†æï¼Œå…¶æœ€ç»ˆä¼šè¯»å– `resolv.conf` çš„ nameserver è®¾ç½®æœ¬åœ° DNSï¼Œå¹¶ç”¨å…¶è¿›è¡ŒæŸ¥è¯¢ã€‚\r\n\r\nP.S. c-ares ä¹Ÿ[ä¾èµ– glibc çš„ resolv](https://github.com/c-ares/c-ares/blob/master/CMakeLists.txt#L217-L218)ã€‚\r\n\r\n### 2 - å®é™…éªŒè¯\r\n\r\nç»è¿‡ä¸Šé¢çš„åˆ†æä¹‹åï¼Œå¯ä»¥å†ç®€å•è¿›è¡Œä¸€ä¸‹å®é™…éªŒè¯ã€‚ä¸‹é¢æ˜¯ä¸€æ®µè°ƒç”¨ `dns.resolve`ï¼ˆå…¶ä»– resolve æ–¹æ³•åŒç†ï¼‰çš„ä»£ç ï¼š\r\n\r\n```JavaScript\r\nconst dns = require('dns');\r\ndns.resolve('www.acfun.cn', function (...args) {\r\n  console.log(...args);\r\n});\r\n```\r\n\r\n#### å®éªŒä¸€ï¼š\r\n\r\nç¯å¢ƒï¼šCentOS Linux release 7.4.1708\r\n\r\nè¿è¡Œè¾“å‡ºï¼š\r\n\r\n```TEXT\r\n$ node test.js\r\nnull [ '172.18.201.64' ]\r\n```\r\n\r\nç”¨ strace çœ‹ä¸‹å®ƒçš„è°ƒç”¨é“¾ï¼š\r\n\r\n```Bash\r\n$ strace node test.js\r\n```\r\n\r\nå†…å®¹æ¯”è¾ƒå¤šï¼Œä¸‹å›¾åªæˆªå–å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹åˆ°æ‰“å¼€å¹¶è¯»å–äº† resolv.confã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/81075707-47399100-8f1d-11ea-87c3-52bc9e6e6558.png)\r\n\r\nstrace è¾“å‡ºï¼ˆç¬¬8è¡Œçš„ open è°ƒç”¨ï¼‰ï¼š\r\n\r\n```\r\nmprotect(0x43c0b904000, 503808, PROT_READ|PROT_EXEC) = 0\r\nread(21, \"const dns = require('dns');\\ndns.\"..., 102) = 102\r\nclose(21)                               = 0\r\nmprotect(0x43c0b884000, 503808, PROT_READ|PROT_WRITE) = 0\r\nmprotect(0x43c0b904000, 503808, PROT_READ|PROT_WRITE) = 0\r\nmprotect(0x43c0b884000, 503808, PROT_READ|PROT_EXEC) = 0\r\nmprotect(0x43c0b904000, 503808, PROT_READ|PROT_EXEC) = 0\r\nopen(\"/etc/resolv.conf\", O_RDONLY)      = 21\r\nfstat(21, {st_mode=S_IFREG|0644, st_size=176, ...}) = 0\r\nmmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f4d5c7e6000\r\nread(21, \"#nameserver 10.75.60.252\\n#namese\"..., 4096) = 176\r\nread(21, \"\", 4096)                      = 0\r\nclose(21)                               = 0\r\nmunmap(0x7f4d5c7e6000, 4096)            = 0\r\nopen(\"/etc/nsswitch.conf\", O_RDONLY)    = 21\r\nfstat(21, {st_mode=S_IFREG|0644, st_size=1746, ...}) = 0\r\nmmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f4d5c7e6000\r\nread(21, \"#\\n# /etc/nsswitch.conf\\n#\\n# An ex\"..., 4096) = 1746\r\nread(21, \"\", 4096)                      = 0\r\nclose(21)                               = 0\r\nmunmap(0x7f4d5c7e6000, 4096)            = 0\r\nuname({sysname=\"Linux\", nodename=\"hb2-acfuntest-ls004.aliyun\", ...}) = 0\r\nopen(\"/dev/urandom\", O_RDONLY)          = 21\r\nfstat(21, {st_mode=S_IFCHR|0666, st_rdev=makedev(1, 9), ...}) = 0\r\n```\r\n\r\n#### å®éªŒäºŒï¼š\r\n\r\nç¯å¢ƒï¼šmacOS 10.15.3 \r\n\r\nè¿è¡Œè¾“å‡ºï¼š\r\n\r\n```TEXT\r\n$ node test.js\r\nnull [\r\n  '61.149.11.118',\r\n  '111.206.4.103',\r\n  '61.149.11.116',\r\n  '61.149.11.117',\r\n  '61.149.11.115',\r\n  '61.149.11.113',\r\n  '61.149.11.112',\r\n  '111.206.4.98',\r\n  '111.206.4.97',\r\n  '61.149.11.119',\r\n  '111.206.4.96',\r\n  '61.149.11.114'\r\n]\r\n```\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼ŒåŸŸåè¢«æ­£å¸¸è§£æäº†ã€‚ä¸‹é¢ä¿®æ”¹ `/etc/resolv.conf` å†…å®¹ï¼Œå°† nameserver æ”¹ä¸ºä¸€ä¸ªæ— æ³•è®¿é—®çš„ IPï¼ˆå‰é¢ä¸‰ä¸ªè¢«æ³¨é‡Šçš„æ˜¯åŸ DNS serverï¼‰ï¼š\r\n\r\n```\r\n#\r\n# macOS Notice\r\n#\r\n# This file is not consulted for DNS hostname resolution, address\r\n# resolution, or the DNS query routing mechanism used by most\r\n# processes on this system.\r\n#\r\n# To view the DNS configuration used by this system, use:\r\n#   scutil --dns\r\n#\r\n# SEE ALSO\r\n#   dns-sd(1), scutil(8)\r\n#\r\n# This file is automatically generated.\r\n#\r\n#nameserver 172.18.1.166\r\n#nameserver 192.168.43.27\r\n#nameserver 192.168.1.1\r\nnameserver 192.168.2.2\r\n```\r\n\r\næ­¤æ—¶å†æ‰§è¡Œï¼Œä¼šè§¦å‘è¶…æ—¶é”™è¯¯ï¼š\r\n\r\n```\r\nError: queryA ETIMEOUT www.acfun.cn\r\n    at QueryReqWrap.onresolve [as oncomplete] (dns.js:202:19) {\r\n  errno: 'ETIMEOUT',\r\n  code: 'ETIMEOUT',\r\n  syscall: 'queryA',\r\n  hostname: 'www.acfun.cn'\r\n}\r\n```\r\n\r\n### ç»“è®º\r\n\r\né€šè¿‡æºç å’Œæµ‹è¯•ï¼Œå¯ä»¥ç¡®å®š dns.resolve ç›¸å…³æ–¹æ³•ï¼Œåœ¨ Linux ä»ç„¶ä¼šè¯»å– resolv.conf é…ç½®æ¥è®¾ç½®æœ¬åœ° DNS æœåŠ¡å™¨ã€‚\r\n\r\n---\r\n\r\n## é—®é¢˜ä¸‰ï¼šå…³äº DNS æŸ¥è¯¢çš„ timeout\r\n\r\nåœ¨ c-ares éƒ¨åˆ†æœ‰æåˆ°ä¸¤ä¸ªç¼–è¯‘åˆ†æ”¯ï¼Œåœ¨æœ€åä¸€ä¸ª else ä¸­ï¼Œå¹¶ä¸ä¼šå¯¹ timeout çš„å€¼è¿›è¡Œå¤„ç†ï¼Œå› æ­¤ä¼šè½åˆ°æœ€åçš„é»˜è®¤èµ‹å€¼ä¸Šï¼ˆ5sï¼‰\r\n\r\n```C++\r\nif (channel->timeout == -1)\r\n    channel->timeout = DEFAULT_TIMEOUT;\r\n```\r\n\r\n`DEFAULT_TIMEOUT` [å®šä¹‰åœ¨è¿™](https://github.com/nodejs/node/blob/v12.16.3/deps/cares/src/ares_private.h#L40:9)ï¼Œä¸º 5s \r\n\r\n```C++\r\n#define DEFAULT_TIMEOUT         5000 /* milliseconds */\r\n```\r\n\r\nè€Œå¯¹äºèµ°åˆ° CARES_USE_LIBRESOLV åˆ†æ”¯çš„ä»£ç ï¼Œåˆ™å› ä¸ºè°ƒç”¨äº† `res_ninit`ï¼Œå¯ä»¥åœ¨ [`__res_state`](https://github.com/lattera/glibc/blob/895ef79e04a953cac1493863bcae29ad85657ee1/resolv/bits/types/res_state.h#L13) ç»“æ„ä½“ä¸­å–åˆ° retrans å€¼ï¼Œè¯¥å€¼ä¼šè¢«[ç”¨ä½œ timeout å€¼](https://github.com/lattera/glibc/blob/895ef79e04a953cac1493863bcae29ad85657ee1/resolv/bits/types/res_state.h#L13)ï¼š\r\n\r\n```C++\r\nif (channel->timeout == -1)\r\n      channel->timeout = res.retrans * 1000;\r\n```\r\n\r\n> c-ares æ–‡æ¡£ä¹Ÿæœ‰å…³äº timeout çš„[ç®€å•è¯´æ˜](https://c-ares.haxx.se/ares_init_options.html#:~:text=ARES_OPT_TIMEOUTMS%20int%20timeout;)\r\n\r\nå¦‚æœä»¥ä¸Šåˆ†ææ²¡æœ‰é—®é¢˜çš„è¯ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”è¯¥æ˜¯å±äºä¸Šä¸€ç§æƒ…å†µï¼Œä½†ç”±äº NodeJS å±‚æ²¡æœ‰æš´éœ²å¯¹åº”è®¾ç½®è¶…æ—¶çš„å…¥å£ï¼Œæ‰€ä»¥ï¼Œå¦‚æœæ›¿æ¢ä¸º lookup-dns-cacheï¼Œåˆ™æ— æ³•æ§åˆ¶ timeout çš„æ—¶é—´ã€‚\r\n\r\n## ç»¼ä¸Š\r\n\r\n1. lookup-dns-cache åœ¨ JS è¿™ä¸€å±‚åšäº†é˜²æ­¢é‡å¤è¯·æ±‚å’Œç¼“å­˜ä¸¤å¤„ä¼˜åŒ–\r\n1. lookup-dns-cache æœ€åº•å±‚ä¹Ÿä½¿ç”¨äº† resolv.conf è¿™ä¸ªé…ç½®\r\n1. ä½¿ç”¨ lookup-dns-cache åæ— æ³•æ§åˆ¶ DNS æŸ¥è¯¢çš„ timeout å€¼\r\n\r\n## å‚è€ƒèµ„æ–™\r\n\r\n- NodeJS å®˜æ–¹æ–‡æ¡£\r\n  - [DNS](https://nodejs.org/dist/latest-v12.x/docs/api/dns.html)\r\n  - [Dependencies](https://nodejs.org/en/docs/meta/topics/dependencies/#c-ares)\r\n- [c-ares](https://github.com/c-ares/c-ares)\r\n- [man-pages: RESOLVER](http://man7.org/linux/man-pages/man3/resolver.3.html)\r\n- [How to fix nodejs DNS issues?](https://medium.com/@amirilovic/how-to-fix-node-dns-issues-5d4ec2e12e95)\r\n- [axios: difference in timeout behavior between versions 0.18.1 and 0.19.0-2](https://github.com/axios/axios/issues/2710)\r\n\r\n---\r\n\r\nP.S. resolv ä¸­è®¾ç½® timeoutï¼ˆretransï¼‰å€¼ç›®æµ‹æ˜¯åœ¨[è¿™ä¸ªåœ°æ–¹](https://github.com/lattera/glibc/blob/895ef79e04a953cac1493863bcae29ad85657ee1/resolv/res_init.c#L644-L651)\r\n\r\n```C++\r\n...\r\nelse if (!strncmp (cp, \"timeout:\", sizeof (\"timeout:\") - 1))\r\n{\r\n  int i = atoi (cp + sizeof (\"timeout:\") - 1);\r\n  if (i <= RES_MAXRETRANS)\r\n    parser->template.retrans = i;\r\n  else\r\n    parser->template.retrans = RES_MAXRETRANS;\r\n}\r\n...\r\n```\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/38","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/38/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/38/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/38/events","html_url":"https://github.com/alienzhou/blog/issues/38","id":589535488,"node_id":"MDU6SXNzdWU1ODk1MzU0ODg=","number":38,"title":"èŠä¸€èŠ webpack çš„æ‰“åŒ…ä¼˜åŒ–å®è·µ","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1392194871,"node_id":"MDU6TGFiZWwxMzkyMTk0ODcx","url":"https://api.github.com/repos/alienzhou/blog/labels/Performance","name":"Performance","color":"65ed99","default":false,"description":""},{"id":1159845019,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE5","url":"https://api.github.com/repos/alienzhou/blog/labels/Webpack","name":"Webpack","color":"e4e669","default":false,"description":""},{"id":1160330255,"node_id":"MDU6TGFiZWwxMTYwMzMwMjU1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7","name":"è‡ªåŠ¨åŒ–å·¥å…·","color":"f9c0d1","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-03-28T08:44:33Z","updated_at":"2020-03-28T08:48:08Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"# é‡åˆ°äº†ä»€ä¹ˆé—®é¢˜?\r\n\r\nå»å¹´æ¥è§¦äº†å…¬å¸å†…ä¸€ä¸ªå¼€å‘è¿è¡Œäº†ä¸¤å¹´å¤šçš„é¡¹ç›®ï¼Œæ•´ä½“åº”ç”¨æ˜¯åŸºäº React æŠ€æœ¯æ ˆçš„ï¼Œå¤šä¸ªå•é¡µåº”ç”¨æœ‰æ„æˆäº†å¤šé¡µåº”ç”¨ã€‚å¯ä»¥ç†è§£ä¸ºæ¯”è¾ƒç‹¬ç«‹çš„å­ä¸šåŠ¡ä¹‹é—´æ˜¯ MPA å½¢å¼è·³è½¬ï¼Œè€Œå­ä¸šåŠ¡å†…éƒ¨åˆ™æ˜¯ SPA å½¢å¼ã€‚\r\n\r\né¡¹ç›®çš„æ„å»ºä½¿ç”¨äº† webpackï¼Œå‘ç°å­˜åœ¨è¾ƒå¤§é—®é¢˜ï¼š\r\n\r\n- åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šçº¿ç¼–è¯‘å¤§è‡´éœ€è¦ 13 min+ï¼›\r\n- æœ¬åœ°å¼€å‘ç¯å¢ƒä¸‹ï¼Œä»£ç æ”¹åŠ¨åçš„çƒ­æ›´æ–°ï¼ˆå¢é‡ç¼–è¯‘ï¼‰éœ€è¦å¤§æ¦‚ 10ï½20s çš„æ—¶é—´ï¼Œä½¿å¾—å¼€å‘ä½“éªŒå¾ˆå·®ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2020/3/28/1711ccd02f1caa9e?w=794&h=335&f=png&s=227359)\r\n\r\nç›¸ä¿¡è¿™äº›é—®é¢˜åœ¨å¾ˆå¤šä¸Šçº¿è¿­ä»£äº†å¾ˆé•¿æ—¶é—´çš„ã€ä½¿ç”¨äº† webpack çš„å›¢é˜Ÿä¸­éƒ½ä¼šé‡åˆ°ï¼Œæ‰€ä»¥æŠŠè‡ªå·±çš„ä¼˜åŒ–å®è·µç»å†å†™å‡ºæ¥ï¼Œå’Œå¤§å®¶äº¤æµä¸‹ã€‚æˆ‘åœ¨ä¼˜åŒ–çš„æ—¶å€™ä¹Ÿå‚è€ƒäº†è®¸å¤šç½‘ç»œä¸Šä»‹ç»çš„ä¼˜åŒ–æ‰‹æ®µï¼Œå½“ç„¶ï¼Œæœ‰äº›å…·æœ‰ä¸é”™æ•ˆæœï¼Œæœ‰äº›å¯èƒ½å¯¹æˆ‘ä»¬æ¥è¯´ä¸é€‚ç”¨ã€‚è¿™å¹¶ä¸æ˜¯ä¸€ç¯‡ç½—åˆ—å„ç§ webpack ä¼˜åŒ–æŠ€å·§çš„æ–‡ç« ï¼Œé™¤äº†ä¼˜åŒ–å®è·µï¼Œè¿˜ä¼šæœ‰ä¸€äº›æœŸé—´çš„åæ€ã€‚\r\n\r\n# å¦‚ä½•åˆ†ææ€§èƒ½é—®é¢˜?\r\n\r\nä¼˜åŒ–å‰è‡ªç„¶éœ€è¦æ‰¾åˆ°é—®é¢˜ç‚¹ã€‚\r\n\r\né¦–å…ˆï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€äº›å¼€æºå·¥å…·æ¥åˆ†æã€‚é’ˆå¯¹ webpack æ€§èƒ½åˆ†æçš„å·¥å…·ï¼Œç”¨çš„å¾ˆå¤šçš„æœ‰ [speed-measure-webpack-plugin](https://github.com/stephencookdev/speed-measure-webpack-plugin)ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥ç»Ÿè®¡å„ä¸ª plugin å’Œ loader çš„è€—æ—¶ã€‚è¿™éƒ¨åˆ†ä¸Šç½‘ç»œå„ç±»ä»‹ç» webpack æ€§èƒ½ä¼˜åŒ–çš„æ–‡ç« éƒ½ä¼šæåˆ°ï¼Œæœ¬æ–‡å°±ä¸èµ˜è¿°äº†ã€‚\r\n\r\n![](https://www.alienzhou.com/img/improvement-in-webpack/1711a6ee306dd462.jpg)\r\n\r\nå…¶æ¬¡ï¼Œéœ€è¦ç»“åˆä½ çš„ä¸šåŠ¡æ¥å…·ä½“åˆ†æã€‚ä¾‹å¦‚ï¼Œåœ¨æœ€å¼€å¤´æˆ‘æåˆ°ï¼Œæˆ‘ä»¬çš„é¡¹ç›®è™½ç„¶åœ¨å­ä¸šåŠ¡ä¸­æ˜¯å±äº SPA å½¢å¼çš„ï¼Œä½†æ˜¯æ•´ä½“ä¸Šæ˜¯ MPA çš„æ–¹å¼ï¼Œå› æ­¤åœ¨é¡¹ç›®æ‰“åŒ…æ—¶ä¼šæœ‰å¤šä¸ªå…¥å£ï¼Œé’ˆå¯¹æ¯ä¸ªå…¥å£ [html-webpack-plugin](https://github.com/jantimon/html-webpack-plugin) ä¹Ÿä¼šå¸®æˆ‘ä»¬ç”Ÿæˆå¤šä¸ªæ–‡ä»¶ã€‚å› æ­¤ï¼Œå³ä½¿æˆ‘åªå¼€å‘ä¸€ä¸ªç”¨æˆ·ä¸­å¿ƒå­ä¸šåŠ¡ï¼Œä¹Ÿä¼šå®Œæ•´ç¼–è¯‘ä¸€æ¬¡æ•´ä½“é¡¹ç›®ï¼Œæ˜¾ç„¶æ˜¯å­˜åœ¨é—®é¢˜çš„ã€‚\r\n\r\næœ€åï¼Œä¼˜åŒ–ä¹Ÿä¼šæœ‰ä¸€äº›é€šç”¨çš„æ‰‹æ®µï¼Œæˆ–è€…è¯´æ˜¯ä¸šåŠ¡â€œæœ€ä½³å®è·µç»éªŒâ€çš„æ€»ç»“ã€‚ä¾‹å¦‚ï¼Œä¿æŒå‡çº§åˆ°æ–°ç‰ˆçš„ webpackï¼ˆè¿™é‡Œæ˜¯æŒ‡ major versionï¼‰ï¼Œä¸º loader æä¾› cache ç­‰ã€‚\r\n\r\nè¿™å¤§è‡´å°±æ˜¯æ€§èƒ½ä¼˜åŒ–å‰è¿›è¡Œé—®é¢˜å’Œç°çŠ¶åˆ†æçš„ä¸€äº›æ‰‹æ®µã€‚æ€»è®¡æ¥è¯´å°±æ˜¯ï¼š\r\n\r\n- é€šè¿‡è‡ªåŠ¨åŒ–æ£€æµ‹å·¥å…·ï¼Œæ¥ç›´è§‚åæ˜ å‡ºç³»ç»Ÿçš„æ€§èƒ½æ•°æ®ï¼›\r\n- å……åˆ†ç†è§£ä¸šåŠ¡ç‰¹ç‚¹ï¼Œç»“åˆå®é™…ä¸šåŠ¡æƒ…å†µåˆ†æé—®é¢˜ï¼›\r\n- æŸ¥é˜…ä¸äº†è§£ä¸€äº›ä¸šåŠ¡â€œé€šç”¨å»ºè®®â€ï¼Œè¿™äº›ä¸€èˆ¬éƒ½å…·æœ‰ä¸€å®šæ™®é€‚æ€§ï¼Œå¯ä»¥è¿›ä¸€æ­¥å¸®åŠ©ä½ ä¼˜åŒ–ã€‚\r\n\r\n# æ€§èƒ½ä¼˜åŒ–çš„å®è·µä¸æ€è€ƒ\r\n\r\nä¸€æ—¦åˆ†æå®Œç›®å‰é¡¹ç›®ä¸­ webpack çš„æ€§èƒ½é—®é¢˜ï¼Œå°±å¯ä»¥ç€æ‰‹è¿›è¡Œä¼˜åŒ–å®è·µäº†ã€‚ä¸è¿‡å¾ˆå¤šæ—¶å€™ï¼Œæ€§èƒ½é—®é¢˜çš„åˆ†æä¸å¤„ç†æ˜¯ä¸€ä¸ªäº¤é”™å¾ªç¯çš„è¿‡ç¨‹ã€‚ä½ åœ¨è§£å†³æ€§èƒ½é—®é¢˜çš„åŒæ—¶ï¼Œä¹Ÿå¯èƒ½å‘ç°æ–°çš„æ€§èƒ½ä¼˜åŒ–ç‚¹ã€‚\r\n\r\nä¸‹é¢ä»‹ç»ä¸€äº›æˆ‘åœ¨é¡¹ç›®ä¸­å°è¯•çš„ä¼˜åŒ–æªæ–½ã€ä¼˜åŒ–æ•ˆæœå’Œä¸€äº›æ€è€ƒã€‚\r\n\r\n## éœ€è¦å‡çº§åˆ°æœ€æ–°çš„ webpack ä¹ˆï¼Ÿ\r\n\r\nwebpack çš„ä¸€äº›ç‰ˆæœ¬è¿­ä»£æœ¬èº«å°±ä¼šåŒ…å«å…¶è‡ªèº«çš„æ€§èƒ½ä¼˜åŒ–ï¼Œæ‰€ä»¥å‡å¦‚æœä½ çš„ major version æ¯”è¾ƒè€äº†ï¼Œé‚£ä¹ˆå‡çº§åˆ°æ–°ç‰ˆå°±ä¼šæé«˜æ•´ä½“çš„æ€§èƒ½ã€‚\r\n\r\nä¾‹å¦‚æˆ‘æ¥è§¦åˆ°è¯¥ä¸šåŠ¡é¡¹ç›®æ—¶ï¼Œç”±äºå…¶æ­¤ 2017 å¹´å¼€å§‹å°±æ²¡æœ‰å‡çº§è¿‡ webpackï¼Œæ‰€ä»¥è¿˜æ˜¯ä½¿ç”¨çš„ webpack v3ã€‚ç€æ‰‹ä¼˜åŒ–çš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯å°†å…¶å‡çº§åˆ° webpack v4ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2020/3/28/1711ccd31ee8f82b?w=794&h=360&f=png&s=635290)\r\n\r\nwebpack v4 å·²ç»å‘å¸ƒå¾ˆé•¿æ—¶é—´äº†ï¼ˆç›®å‰ webpack v5 çš„ beta ç‰ˆéƒ½å·²ç»æ›´æ–°äº†å¾ˆå¤šæ¬¡äº†ï¼‰ï¼Œè€Œé¡¹ç›®ä¸­è¿˜åœ¨ä½¿ç”¨ webpack v3 ç®—æ˜¯ä¸€ä¸ªé—ç•™é—®é¢˜ï¼Œæœ‰å¿…è¦å‡çº§ã€‚å…³äº v3 å‡çº§åˆ° v4 çš„æŒ‡å—ç½‘ä¸Šå¾ˆå¤šï¼Œä¸»è¦éƒ½æ˜¯ä¸€äº›é…ç½®æ›´æ–°ï¼Œåƒæ˜¯ä»£ç å‹ç¼©ã€commonChunks æ›´æ–°åˆ° splitChunksã€ä½¿ç”¨ MiniCssExtractPlugin ç­‰ï¼Œ[å®˜æ–¹](https://v4.webpack.js.org/migrate/4/)ä¹Ÿæä¾›äº†å‡çº§æŒ‡å¯¼ï¼Œæˆ‘åœ¨è¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œåªæ˜¯åˆ—å‡ ä¸ªé¡¹ç›®ä¸­å¯èƒ½ä¼šç”¨åˆ°çš„ä¾èµ–é¡¹çš„ç‰ˆæœ¬æ›´æ–°å§ï¼š\r\n\r\n- html-webpack-plugin >= 4.0.0ï¼ˆç”¨äºå’Œ splitChunks é…åˆä½¿ç”¨ï¼‰\r\n- eslint-loader >= 2.1.0ï¼‰\r\n- react-dev-utils >= 6.0.0ï¼ˆä¸€äº›æ—©æœŸ create-react-app åˆ›å»ºçš„é¡¹ç›® eject åéœ€è¦å‡çº§è¿™ä¸ªï¼‰\r\n- happypack >= 5.0.0\r\n- file-loader >= 2.0.0\r\n\r\nå‡çº§å®Œæˆåçš„æ•ˆæœæ˜¾è‘—ï¼Œæ ¹æ®å¤šæ¬¡å¯¹æ¯”å®éªŒçš„ç»“æœï¼Œä¼šæœ‰ **30%ï½40% çš„æ€§èƒ½æå‡**ã€‚æ­£å¦‚æ±Ÿæ¹–ä¸­æ‰€è¯´ï¼Œå¾ˆå¤šæ—¶å€™å„ç§ä¼˜åŒ–æ‰‹æ®µå¸¦æ¥çš„æå‡ï¼Œä¸åŠå‡çº§ä¸€ä¸‹ webpackã€‚æ‰€ä»¥åç»­ webpack v5 ç¨³å®šåå¤§å®¶è·Ÿä¸Šä¹Ÿæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚å› æ­¤ï¼Œå¦‚æœä½ é¡¹ç›®ä¸­çš„ webpack çš„ä¸»ç‰ˆæœ¬å·²ç»è½åä¸»æµï¼ˆç¨³å®šï¼‰çš„ç‰ˆæœ¬ï¼Œå»ºè®®ä¼˜å…ˆè¿›è¡Œå‡çº§ã€‚\r\n\r\n## ä½¿ç”¨ DLLPlugin æœ‰æ”¶ç›Šä¹ˆï¼Ÿ\r\n\r\n[DLLPlugin](https://v4.webpack.js.org/plugins/dll-plugin/) æ˜¯å€Ÿé‰´ DLL çš„æ€è·¯ï¼Œå°†ä¸€äº›æ›´æ–°é¢‘ç‡æä½çš„æ¨¡å—ï¼ˆä¾‹å¦‚ node_modules ä¸­çš„å„ä¸ªåŒ…ï¼‰å•ç‹¬å­˜å‚¨åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç„¶åé¡¹ç›®ä¸­é€šè¿‡ç”Ÿæˆçš„ manifest ä¸ DLL äº§ç‰©å°†æ‰€éœ€çš„æ¨¡å—æ‰“åŒ…è¿›é¡¹ç›®ä¸­ã€‚\r\n\r\næˆ‘ä»¬ä¹Ÿæ˜¯ä½¿ç”¨ä¸šç•Œå¸¸è§çš„ä¸€ç§ç”¨æ³•ï¼Œå¯¹ node_modules ä¸­ä»£ç è¿ç”¨çš„ DLLPluginï¼Œä¸è¿‡åœ¨ä¸šåŠ¡åº”ç”¨åæå‡å¹¶ä¸æ˜æ˜¾ã€‚åŒæ—¶ä½¿ç”¨ DLL è¿˜æœ‰ä¸€ä¸ªéœ€è¦è§£å†³çš„é—®é¢˜ã€‚\r\n\r\næˆ‘ä»¬å„ç±»é¡¹ç›®éƒ½æ˜¯ç”¨äº‘ç«¯ç¼–è¯‘çš„æ–¹å¼ï¼Œåªå°†æºä»£ç æäº¤ä»“åº“ï¼Œé€šè¿‡ CI åœ¨ç¼–è¯‘é›†ç¾¤ä¸­ç¼–è¯‘ã€‚ä»»ä½•äº§å‡ºçš„ä»£ç éƒ½ä¸ä¼šæäº¤ä»“åº“å†…ã€‚è¿™æ ·ä¿è¯æ‰€æœ‰çš„ç¼–è¯‘ç¯å¢ƒã€ç¼–è¯‘å·¥å…·éƒ½æ˜¯æ”¶æ•›ç»Ÿä¸€çš„ã€‚ç”±äº DLL æ–‡ä»¶æ˜¯ç¼–è¯‘äº§å‡ºçš„ï¼Œè¿™å¥—ç†å¿µä¹‹ä¸‹ï¼Œæˆ‘ä»¬è‡ªç„¶ä¹Ÿå€¾å‘äºä¸åœ¨æœ¬åœ°æ„å»ºå‡º DLLï¼Œè€Œæ˜¯äº‘ç«¯ç¼–è¯‘ã€‚\r\n\r\nå¦ä¸€æ–¹é¢ï¼Œä¸šåŠ¡ä»£ç åœ¨æäº¤åˆ°ä»“åº“è¿›è¡Œäº‘ç«¯ç¼–è¯‘æ—¶ï¼Œå°±ä¼šéœ€è¦å»è·å– DLL æ–‡ä»¶åŠ å…¥åˆ°è‡ªå·±çš„ç¼–è¯‘æµç¨‹ä¸­ã€‚è¿™æ—¶å€™å¯èƒ½æœ‰è¿™ä¹ˆå‡ ç§è·å– DLL çš„æ–¹å¼ï¼š\r\n\r\n1. å¼€å‘è€…æŠŠä¹‹å‰äº‘ç«¯ç¼–è¯‘å¥½çš„ DLL å’Œæ”¾åˆ°ä»“åº“é‡Œä¸€èµ·æäº¤ã€‚ä½†è¿™ä¸ªé‡Œé¢æœ‰è¾ƒå¤§çš„ç»´æŠ¤æˆæœ¬ï¼Œå¼€å‘è€…éœ€è¦çŸ¥é“ DLL ä»€ä¹ˆæ—¶å€™æ›´æ–°äº†ï¼Œå¹¶ä¸”æ‰‹åŠ¨è·å–åˆ°æœ€æ–°çš„ DLLã€‚ä¸æ¨èã€‚\r\n2. è‡ªåˆ¶ä¸€å¥— DLL çš„å‘å¸ƒã€æ›´æ–°ä¸æ‹‰å–æœåŠ¡ï¼Œç„¶ååœ¨ä¸šåŠ¡é¡¹ç›®ä¸­å£°æ˜æ‰€éœ€çš„ DLLï¼Œåœ¨æ„å»ºæµç¨‹ä¸­é›†æˆ DLL çš„æ‹‰å–æ“ä½œã€‚å¦‚æœè¦åšçš„å®Œå–„ï¼Œä¼šéœ€è¦è¾ƒå¤§æˆæœ¬ã€‚\r\n3. æŠŠ DLL ä¸ manifest å‘å¸ƒä¸ºä¸€ä¸ª npm åŒ…ï¼Œä¸šåŠ¡ä»£ç é€šè¿‡ node_modules æ–¹å¼å¼•å…¥ã€‚å…¶å®å°±æ˜¯å€Ÿç”¨ npm çš„èƒ½åŠ›å®ç°äº†æ–¹æ³•2ä¸­èƒ½åŠ›ã€‚æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚\r\n\r\nä½†æ˜¯æœ€ç»ˆæˆ‘å¹¶æ²¡æœ‰ä½¿ç”¨ DLLPluginã€‚ä¸€æ˜¯å› ä¸ºä¸Šé¢æåˆ°çš„ï¼Œåœ¨æˆ‘ä»¬çš„ä¸šåŠ¡ä¸­å®é™…æå‡æ•ˆæœä¸æ˜æ˜¾ï¼›å…¶äºŒæ˜¯å¼•å…¥åå³ä½¿ç”¨æ–¹æ³•3ï¼Œä¹Ÿä¼šå¢åŠ å¤æ‚æ€§ï¼Œæé«˜å¼€å‘äººå‘˜ç†è§£çš„é—¨æ§›ã€‚æ­£è´Ÿå‘æ•ˆæœæƒè¡¡åï¼Œå¹¶æ²¡æœ‰ç”¨ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2020/3/28/1711ccd63915f3c6?w=794&h=399&f=png&s=556071)\r\n\r\næ‰€ä»¥è¿™é‡Œä¹Ÿæƒ³è¯´æ˜ï¼Œ**ä¸€äº›å¤§å®¶æ¨èçš„æ–¹å¼ï¼Œç©¶ç«Ÿæœ‰æ²¡æœ‰æ”¶ç›Šï¼Œä»ç„¶éœ€è¦ç»“åˆè‡ªå·±çš„é¡¹ç›®æ¥è€ƒé‡ã€‚åˆ©å¼Šæƒè¡¡ï¼Œæ–¹å¾—æ­£é“**ã€‚\r\n\r\n## æ˜¯å¦éœ€è¦ä½¿ç”¨ Linterï¼Ÿ\r\n\r\nè¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªå¼€å€’è½¦çš„é—®é¢˜ã€‚åœ¨å‰ç«¯å·¥ç¨‹åŒ–ä¸æ–­å®Œå–„çš„ä»Šå¤©ï¼ŒLinter è¢«æ— æ•°æ¬¡è¯æ˜å…¶ä»·å€¼ï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨å‘¢ï¼Ÿä½†ç»“åˆæœ¬ç¯‡ã€Œwebpack æ‰“åŒ…ä¼˜åŒ–ã€çš„ä¸»é¢˜ï¼Œå®ƒå…¶å®æ˜¯åœ¨é—®ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ webpack ä¸­é›†æˆ Linter ä¹ˆï¼Ÿ\r\n\r\nä¼—æ‰€å‘¨çŸ¥ï¼Œæˆ‘ä»¬åœ¨ webpack ä¸­å¯ä»¥é€šè¿‡ eslint-loader æ¥é›†æˆ eslintã€‚è¿™ä¹ˆåšçš„ç›®æ ‡ä¸»è¦åŒ…æ‹¬ï¼š\r\n\r\n1. è®©å¼€å‘äººå‘˜èƒ½å®æ—¶è·çŸ¥ä»£ç æ£€æŸ¥çš„ç»“æœï¼Œè¶Šæ—©çŸ¥é“ï¼Œè¶Šå®¹æ˜“ä¿®å¤ï¼›\r\n2. åŒæ—¶ä¹Ÿæ˜¯æä¾›ä»£ç æ£€æŸ¥çš„è§„èŒƒï¼Œæ§åˆ¶ä¸è‰¯çš„ç¼–ç è¿›å…¥ä»“åº“ã€‚\r\n\r\nä½†åœ¨ webpack ä¸­é›†æˆ Linter å¹¶ä¸ä¸€å®šæ˜¯æœ€ä½³è§£æ³•ã€‚é’ˆå¯¹ç›®çš„ 1ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨ç¼–è¾‘å™¨ä¸­åŠ å…¥ç›¸åº”çš„ Linter è§„èŒƒã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå›¢é˜Ÿå†…ç¼–ç è§„èŒƒä¸€æ—¦ç¡®å®šï¼Œå°±ä¸å¸¸æ›´æ”¹ã€‚æ‰€ä»¥æä¾›ä¸ç¼–è¾‘å™¨é›†æˆçš„ Linter å¯¹äºå®Œæˆç›®æ ‡ 1 æ¥è¯´æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚è€Œé‰´äº vscode çš„æµç¨‹ä¸æ’ä»¶ä½“ç³»çš„ä¾¿åˆ©ï¼Œæä¾›ä¸€ä¸ªåŒ…å«ä½ ä»¬å›¢é˜Ÿ Linter è§„åˆ™çš„ vscode æ’ä»¶æˆæœ¬å¹¶ä¸é«˜ï¼Œå¹¶ä¸”è¦†ç›–é¢å¹¿ã€‚\r\n\r\nè€Œé’ˆå¯¹ç›®æ ‡ 2ï¼Œå¯ä»¥é€šè¿‡ git hook çš„æ–¹å¼åœ¨æ¥è§¦å‘ä»£ç æ£€æŸ¥ã€‚æœ€ç®€å•çš„æ–¹å¼å¯ä»¥é€šè¿‡ [husky](https://github.com/typicode/husky) æ¥é…ç½®ï¼Œè®© eslint åœ¨ `git commit` æˆ– `git push` æ—¶è§¦å‘ã€‚ä½†æ˜¯æœ¬åœ°æ£€æŸ¥æ˜¯å¯ä»¥äººä¸ºæ³¨é”€çš„ï¼ˆä¾‹å¦‚ä¸ºäº†ç»•è¿‡æ£€æŸ¥åœ¨æäº¤æ—¶æ³¨é‡Šæ‰ hookï¼‰ã€‚æ‰€ä»¥æ›´è¿›ä¸€æ­¥ï¼Œå¦‚æœä½ ä»¬å…¬å¸çš„åŸºå»ºèƒ½åŠ›å¤Ÿå¼ºï¼Œå¹¶ä¸”éœ€è¦å¤§èŒƒå›´æ¨å¹¿ä»£ç è§„èŒƒï¼Œç”šè‡³å¯ä»¥è€ƒè™‘ç»™ git æµç¨‹æ·»åŠ æ›´ä¸¥æ ¼çš„æ§åˆ¶ã€‚è®©æ‰€æœ‰ push çš„ä»£ç éƒ½åªèƒ½å…ˆæ¨å…¥æš‚å­˜åˆ†æ”¯ï¼Œåˆ†æ”¯åˆå…¥å¿…é¡»å»ä»£ç ç®¡ç†å¹³å°æ“ä½œï¼Œåˆå…¥å‰æœåŠ¡ç«¯ä¼š diff æ–‡ä»¶å¹¶è¿è¡Œ Linter è¿›è¡Œæ£€æŸ¥ã€‚\r\n\r\næ­¤å¤–ï¼ŒLinter å…¶å®åªéœ€è¦æ£€æŸ¥å˜åŠ¨çš„æ–‡ä»¶ã€‚ç”±äºé›†æˆåœ¨ webpack ä¸­ï¼Œæ‰€ä»¥å®ƒæ— æ³•é€šè¿‡ `git diff` æ¥é™åˆ¶åªæ£€æŸ¥å˜åŒ–çš„æ–‡ä»¶ï¼Œå…¨é‡ç¼–è¯‘æ—¶å¤„ç†äº†å¾ˆå¤šä¸å¿…è¦çš„æ–‡ä»¶ã€‚åŒæ—¶ï¼Œeslint å’Œ webpack çš„â€œæ ‡é…â€ babel ä¸€æ ·ï¼Œéƒ½è¦ç»è¿‡ source code -> AST -> source code çš„è¿‡ç¨‹ï¼Œä½†ä¸¤è€… AST åˆæ— æ³•å…±äº«ï¼Œæœ¬èº«ä¹Ÿæœ‰æ•ˆç‡çš„æµªè´¹ã€‚\r\n\r\næ—¢ç„¶ä¼šå¸¦æ¥é¢å¤–å¼€é”€åŒæ—¶ä¹Ÿä¸æ˜¯æœ€å¥½çš„é€‰æ‹©ï¼Œé‚£è‡ªç„¶é€‰æ‹©ç§»é™¤ webpack ä¸­çš„ eslint ä½¿ç”¨ã€‚ä½†è¿™å¹¶ä¸ä»£è¡¨ä¸è¦ Linter äº†ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œä¼šæä¾›ä¸€ä¸ª vscode æ’ä»¶æ¥æœåŠ¡äºå¼€å‘é˜¶æ®µï¼ŒåŒæ—¶åœ¨ CI/CD ä¸­å°† git èƒ½åŠ›ä¸ Linter é›†æˆï¼Œåšæ›´æœ‰æ•ˆçš„ä»£ç æ£€æŸ¥ã€‚\r\n\r\nå€Ÿç€è¿™ä¸ªè¯é¢˜ï¼Œæƒ³é¢å¤–å±•å¼€ä¸€å¥ã€‚ä¸€äº›å°ä¼™ä¼´åœ¨æåˆ°å‰ç«¯æ„å»ºã€å‰ç«¯å·¥ç¨‹åŒ–æ—¶ï¼Œçœ¼å…‰éƒ½è½åœ¨ webpack ä¸Šã€‚ä½†å®ƒå…¶å®åªæ˜¯æ„å»ºå·¥å…·ä¸­çš„ä¸€ç§ç”šè‡³åªæ˜¯ä¸€éƒ¨åˆ†ï¼Œå¯¹äºå·¥ç¨‹åŒ–æ›´æ˜¯å¦‚æ­¤ã€‚æ²¡å¿…è¦è®© webpack å»æ‰¿è½½æ‰€æœ‰å·¥ä½œã€‚\r\n\r\n## ä½¿ç”¨ cache é¦™ä¸é¦™ï¼Ÿ\r\n\r\nåˆ©ç”¨ cache æ˜¯å„ç±»ä¼˜åŒ–çš„ä¸€ä¸ªå¸¸è§æ‰‹æ®µã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2020/3/28/1711ccd9116d31ff?w=794&h=301&f=png&s=538889)\r\n\r\nåœ¨ webpack v4 ä¸­å¯ä»¥ä½¿ç”¨ [cache-loader](https://github.com/webpack-contrib/cache-loader) æ¥æé«˜ loader å¤„ç†çš„æ•ˆç‡ã€‚æ›´è¿›ä¸€æ­¥çš„ï¼Œå¯ä»¥ä½¿ç”¨ [hard-source-webpack-plugin](https://github.com/mzgoddard/hard-source-webpack-plugin) æ¥ç¼“å­˜ç¼–è¯‘çš„ä¸­é—´äº§ç‰©ï¼Œå¤§å¹…æå‡åç»­çš„ç¼–è¯‘æ•ˆç‡ã€‚è€Œ webpack v5 çš„ä¸€å¤§äº®ç‚¹ä¹Ÿæ˜¯[åŠ å…¥äº†ç¼“å­˜èƒ½åŠ›](https://zhuanlan.zhihu.com/p/110995118)ï¼Œhard-source-webpack-plugin ä¹…æœªç»´æŠ¤ä¼°è®¡ä¹Ÿæ˜¯å› ä¸ºå…¶ä½œè€…åŠ å…¥ webpack v5 çš„å¼€å‘ä¸­ã€‚\r\n\r\n> åŒæ—¶æä¸€å¥ï¼Œhard-source-webpack-plugin ä» 0.7.x ç‰ˆæœ¬åï¼Œåªæ”¯æŒ node 8+ã€‚\r\n\r\nä¸ªäººå®è·µåï¼Œä½¿ç”¨ cache-loader ä¸ hard-source-webpack-plugin ç¡®å®å¯ä»¥æœ‰æ•ˆæå‡ç¼–è¯‘æ•ˆç‡ã€‚å°¤å…¶æ˜¯ hard-source-webpack-pluginï¼Œä½¿ç”¨åå¯ä»¥è·å– 60%ï½70% çš„æ•ˆç‡æå‡ã€‚ä¸è¿‡å¼•å…¥è¯¥æ’ä»¶ä¸€å®šè¦éå¸¸è°¨æ…ï¼Œè¿™ä¸ªæ’ä»¶å¾ˆâ€œè„†å¼±â€ï¼Œå› ä¸ºå®ƒä½¿ç”¨ webpack å†…éƒ¨çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›æ•°æ®ç»“æ„æœ¬èº«å°±æ˜¯ä¸å‡†å¤‡å¼€æ”¾ç»™å¤–éƒ¨å¼€å‘è€…å’Œç”¨æˆ·çš„ï¼Œå› æ­¤å¹¶æ²¡æœ‰å¾ˆå¥½çš„ä¿éšœï¼Œå¾ˆå¯èƒ½ä¼šå› ä¸º webpack çš„è¿­ä»£æˆ–å¼•å…¥ä¸€äº›æ’ä»¶å¯¼è‡´å‡ºé”™ã€‚ä¾‹å¦‚ï¼Œæˆ‘å°±é‡åˆ°äº†ä¸€ä¸ªä¸ DLL ä¸€èµ·ä½¿ç”¨åæ— æ³•è§£å†³çš„ bugã€‚\r\n\r\nåŒæ—¶ï¼Œå¦‚æœä½ ä½¿ç”¨äº‘ç«¯ç¼–è¯‘çš„æ–¹å¼ï¼Œç”Ÿäº§ç¯å¢ƒä¸€èˆ¬ä¹Ÿæ˜¯æ— æ³•ä½¿ç”¨ç¼“å­˜çš„ã€‚å¦‚æœæ˜¯ç”¨ç¼–è¯‘é›†ç¾¤ï¼Œç¼–è¯‘æœºçš„ä¸€èˆ¬æµç¨‹æ˜¯ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºç›®å½•ï¼Œæ‹‰å–æœ€æ–°ä»£ç ï¼Œå®‰è£…ä¾èµ–ï¼Œæ‰§è¡Œæ‰“åŒ…ç¼–è¯‘ï¼Œå°†äº§ç‰©ä¼ åˆ°äº§å“åº“ä¸­ï¼Œæœ€åæ¸…ç†æ–‡ä»¶ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­èµ„æºéƒ½æ˜¯å…¨æ–°çš„ï¼Œä¸ä¼šå­˜åœ¨ç¼“å­˜ï¼›è€Œæœ¬æ¬¡äº§å‡ºçš„ç¼“å­˜ä¸‹æ¬¡ä¹Ÿä¸ä¼šç”¨ä¸Šã€‚ç”šè‡³å¯èƒ½ä¼šä½¿ç”¨åƒ docker è¿™æ ·çš„å®¹å™¨æŠ€æœ¯æ¥åˆ›å»ºç¼–è¯‘ç¯å¢ƒã€‚é‚£ä¹ˆä¸ä»…èµ„æºæ˜¯å…¨æ–°çš„ï¼Œè¿ç¯å¢ƒä¹Ÿæ˜¯å…¨æ–°çš„ã€‚\r\n\r\næ‰€ä»¥åœ¨è¿™ç§ä¸»æµçš„æ„å»ºæ¨¡å¼ä¸‹ï¼Œæœ¬åœ°å¼€å‘å¯ä»¥äº«å—ç¼“å­˜ï¼Œå‘å¸ƒç”Ÿäº§ç¯å¢ƒçš„æµç¨‹æ˜¯æ— æ³•åˆ©ç”¨ç¼“å­˜çš„ã€‚åŒæ—¶ï¼Œåƒ hard-source-webpack-plugin è¿™ç±»çš„æ’ä»¶ï¼Œæˆ‘ä¸ªäººçš„ä¿¡ä»»åº¦è¿˜æ˜¯æ¯”è¾ƒä½ï¼Œè€Œå…¶ç¡®å®ä¹Ÿå®¹æ˜“å‡ºé”™ï¼Œæ‰€ä»¥å®Œå…¨ä¸æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒã€‚ä¸ªäººå»ºè®®æ˜¯ï¼Œå¦‚æœæƒ³åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ç¼“å­˜ï¼Œä¸€å®šè¦æ…é‡ï¼Œç¡®ä¿ç¼“å­˜åŠŸèƒ½æ˜¯â€œå®˜æ–¹è®¤è¯â€ä¸”ç»å†è¿‡è€ƒéªŒçš„ã€‚å› ä¸ºè¿™ç±»åŠŸèƒ½å¾ˆå®¹æ˜“æˆä¸ºé”™è¯¯çš„æ¥æºã€‚\r\n\r\né’ˆå¯¹ä¸Šé¢æåˆ°çš„è¿™ç§æ„å»ºæµç¨‹ï¼Œå½“ä½ å†³å®šäº†è¦åœ¨ç”Ÿäº§ç¯å¢ƒçš„ç¼–è¯‘ä¸­ä½¿ç”¨ cache æ—¶ï¼Œä¸è®ºæ˜¯åœ¨ v4 ä¸­ä½¿ç”¨ cache-loader ä¸ hard-source-webpack-plugin è¿™æ ·çš„å·¥å…·è¿˜æ˜¯ä½¿ç”¨ v5 çš„ç¼“å­˜ï¼Œä½ éƒ½éœ€è¦ä¸€å¥—ä¿å­˜ä¸ä½¿ç”¨ç¼“å­˜çš„æœºåˆ¶ã€‚è¿™å¯èƒ½éœ€è¦ä½ å’ŒåŸºå»ºæˆ–å·¥ç¨‹æ•ˆç‡å›¢é˜Ÿçš„åŒå­¦åˆä½œï¼Œå¢åŠ ç›¸åº”çš„æµç¨‹æœºåˆ¶äº†ã€‚\r\n\r\nåŸºäºä¸Šé¢çš„è€ƒè™‘ï¼Œæˆ‘è¿˜æ˜¯é€‰æ‹©åªåœ¨å¼€å‘ç¯å¢ƒæ”¯æŒ cacheï¼ŒåŒæ—¶æä¾›ä¸€ä¸ªå¼€å…³ï¼Œå¼€å‘äººå‘˜å¯ä»¥è‡ªç”±é€‰æ‹©æ˜¯å¦ä½¿ç”¨ cacheï¼›è€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹å®Œå…¨ä¸ä½¿ç”¨ cacheã€‚\r\n\r\n## æœ€å¿«çš„ç¼–è¯‘å°±æ˜¯ä¸ç¼–è¯‘\r\n\r\nè®©ä½ çš„ä»“åº“ç¼–è¯‘é€Ÿåº¦æœ€å¿«çš„æ–¹æ³•å°±æ˜¯æŠŠæ‰€æœ‰æ¨¡å—æ–‡ä»¶éƒ½åˆ æ‰ï¼Œå˜æˆä¸€ä¸ªç©ºä»£ç ä»“åº“ï¼Œè¿™æ ·è¿ä¸€æ¯«ç§’éƒ½ä¸ä¼šèŠ±äº†ã€‚\r\n\r\nå½“ç„¶è¿™æ˜¯ä¸€ä¸ªç©ç¬‘ã€‚ä½†å®ƒè¡¨è¾¾çš„è§‚ç‚¹æ˜¯ï¼šåªç¼–è¯‘ä½ æ‰€éœ€è¦çš„ä¸œè¥¿ï¼Œç¼–è¯‘çš„è¶Šå°‘ï¼Œç¼–è¯‘å°±è¶Šå¿«ã€‚\r\n\r\n\r\n![](https://user-gold-cdn.xitu.io/2020/3/27/1711cb2a4f6b370d?w=587&h=350&f=png&s=226698)\r\n\r\næˆ‘ä»¬çš„ä¸šåŠ¡æ˜¯ä¸€ä¸ªåœ¨ MPA ä¸­èåˆ SPA çš„å½¢æ€ â€”â€” ç‹¬ç«‹å­ä¸šåŠ¡é—´æ˜¯ MPA çš„å½¢å¼ï¼Œè€Œå­ä¸šåŠ¡å†…åˆ™æ˜¯ SPA çš„æ¨¡å¼ã€‚å› æ­¤é’ˆå¯¹æ¯ä¸ªå­ä¸šåŠ¡çš„ SPA åœ¨ webpack ä¸­éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ entryã€‚ç¼–è¯‘çš„è¿‡ç¨‹å°±æ˜¯å°†æ‰€æœ‰è¿™äº›å­ä¸šåŠ¡çš„ entry ä¸¢ç»™ webpack è®©å®ƒä¸€èµ·ç¼–è¯‘ã€‚ç”±äºå­ä¸šåŠ¡é—´çš„ä¾èµ–è¾ƒä¸ºå¤æ‚ï¼Œä¸ªäººä¸­å¿ƒçš„ä»£ç å¯èƒ½ `import` äº†ä¸€ä¸ªèµ„æºæœç´¢ä¸šåŠ¡ä¸­çš„æ¨¡å—ï¼Œè€Œ common é‡Œçš„æœ‰äº›æ¨¡å—åˆâ€œä¸å¤Ÿcommonâ€ï¼Œæ‰€ä»¥å½“ä¸‹åˆæ— æ³•ç®€å•çš„æ‹†åˆ†ä¸ºä¸åŒä»“åº“åˆ†å¼€ç¼–è¯‘ã€‚å¼€å‘äººå‘˜çš„ä½“éªŒéå¸¸å·®ï¼Œå› ä¸ºæˆ‘åªéœ€è¦å¼€å‘å…¶ä¸­ä¸€å°éƒ¨åˆ†ï¼Œå´è¦æ•´ä¸ªä»“åº“å„ç±»å­ä¸šåŠ¡éƒ½ç¼–è¯‘ä¸€éã€‚å¼€å‘çš„å¯åŠ¨å’Œå¢é‡ç¼–è¯‘æ—¶é—´éƒ½å¾ˆé•¿ã€‚\r\n\r\nä½ å¯èƒ½ä¼šè§‰å¾—ä¸åˆç†ï¼Œä½†ä¸šåŠ¡ä¸šåŠ¡æ˜¯æ¼”è¿›çš„ï¼Œæ¶æ„å’ŒæŠ€æœ¯ä¹Ÿæ˜¯æ¼”è¿›çš„ã€‚å¹¶ä¸”é—®é¢˜å·²ç»å‡ºç°ï¼Œéœ€è¦å»è§£å†³ï¼Œåƒæ˜¯ç»™è¡Œé©¶çš„è½¦å­æ¢è½®èƒï¼Œä½ æ—¢ä¸èƒ½è¦æ±‚åœè½¦ï¼Œä¹Ÿä¸èƒ½åè§†ä¸ç®¡ã€‚é€šè¿‡è‰¯å¥½çš„ä¸šåŠ¡æ‹†åˆ†ä¸æ¶æ„è¿ç§»ä¹Ÿè®¸å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†ç›®å‰æ—¶é—´ä¸äººåŠ›ä¸å…è®¸ï¼Œå› æ­¤ä¼˜å…ˆç€çœ¼ç¼–è¯‘çš„ä¼˜åŒ–ã€‚\r\n\r\nåŠæ³•å…¶å®å¾ˆç®€å•ã€‚å› ä¸ºä¸€èˆ¬æŸä¸ªäººä¸€æ®µæ—¶é—´çš„å¼€å‘éƒ½æ˜¯é›†ä¸­åœ¨ä¸€ä¸ªå­ä¸šåŠ¡å†…ï¼Œå› æ­¤å¯ä»¥åœ¨å¼€å§‹å¼€å‘æ—¶ï¼Œè®©å¼€å‘äººå‘˜é€‰æ‹©éœ€è¦ç¼–è¯‘çš„å­ä¸šåŠ¡ï¼Œwebpack åªéœ€è¦è£…è½½è¿™ä¸€éƒ¨åˆ† entry å³å¯ã€‚å…·ä½“å¯ä»¥é€šè¿‡ä½¿ç”¨ [enquirer](https://github.com/enquirer/enquirer) åˆ—å‡º entry é€‰é¡¹è®©å¼€å‘è€…é€‰æ‹©ï¼Œä¹‹åå†å°†æ‰€é€‰ entry æ”¾å…¥ webpack config ä¸­å¯åŠ¨ã€‚è¿™ä¸ªåŠŸèƒ½å¯ä»¥æ·»åŠ åˆ°ä½ çš„ build è„šæœ¬ä¹‹ä¸­ã€‚\r\n\r\nå®æ–½æ—¶ï¼Œä¸šåŠ¡æ€»å…±æœ‰äº”ä¸ªå­ä¸šåŠ¡ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†çš„å¼€å‘å·¥ä½œé›†ä¸­åœ¨ä¸€ä¸ªè¾ƒæ–°çš„å­ä¸šåŠ¡ä¸­ã€‚é€šè¿‡åªé€‰æ‹©å®ƒï¼Œé¿å…äº†ç¼–è¯‘å¦ä¸€ä¸ªâ€œæ²‰é‡â€çš„è€ä¸šåŠ¡æ¨¡å—ï¼Œå¼€å‘ç¯å¢ƒçš„å¯åŠ¨è€—æ—¶å¤§å¹…ç¼©å‡ã€‚\r\n\r\né¢å¤–è¿˜è¦æä¸€ä¸‹ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯æ¶æ„æ¨¡å¼å¯¼è‡´çš„ï¼Œè¿™é‡Œçš„æ–¹æ³•ç®—æ˜¯æŒ‡æ ‡ä¸æ²»æœ¬ã€‚ä½†æœ‰äº›æ—¶å€™ï¼Œæ­¢ç–¼è¯ä¹Ÿå¾—å…ˆåƒç€ã€‚è€Œå…³äºå‰ç«¯ä»£ç æ¶æ„çš„æ‹†åˆ†çš„è®¨è®ºå°±ä¸åœ¨æœ¬ä¸»é¢˜èŒƒå›´å†…äº†ã€‚\r\n\r\n## å‡å°‘é¡¹ç›®ä¾èµ–çš„å®‰è£…\r\n\r\næœ¬å—é’ˆå¯¹çš„æ˜¯ç¼–è¯‘é›†ç¾¤é‡Œè¿›è¡Œçš„ç”Ÿäº§ç¼–è¯‘çš„ä¼˜åŒ–ã€‚æˆ‘ä»¬çš„é¡¹ç›®æ¯æ¬¡å‘å¸ƒï¼Œéƒ½ä¼šåœ¨ç¼–è¯‘æœºä¸Šï¼Œæ‹‰å–é¡¹ç›®ä»£ç åï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºç¯å¢ƒï¼Œä½¿ç”¨ `npm i` å®‰è£…ä¸€éä¾èµ–ï¼ˆåŒ…æ‹¬ç¼–è¯‘å·¥å…·å’Œæºç ä¾èµ–ï¼‰ã€‚è¿™å…¶ä¸­çš„ä¸¤å—åœ°æ–¹å¯èƒ½æ˜¯ä¸å¿…è¦çš„ï¼š\r\n\r\n- ä¸€äº›é¡¹ç›®ä¾èµ–å…¶å®å·²ç»åºŸå¼ƒäº†ï¼Œä¸éœ€è¦å®‰è£…ï¼›\r\n- è¿˜æœ‰ä¸€äº›ç¼–è¯‘å·¥å…·æ˜¯é•¿æœŸç¨³å®šçš„ï¼Œå¯ä»¥è€ƒè™‘åšé¢„è£…ã€‚\r\n\r\né’ˆå¯¹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒåŸºæœ¬ä¸ä¼šæœ‰å¤ªå¤šäº‰è®®ï¼Œè¿™ç±»ä¾èµ–åº”è¯¥ä»é¡¹ç›®ä¸­ç§»é™¤ã€‚å…·ä½“åšæ³•å¯ä»¥åŸºäº babel å†™ä¸€ä¸ªç®€å•çš„å·¥å…·éå† JavaScript ä»£ç ï¼Œæ”¶é›†å…¶ä¸­æ‰€æœ‰å¯¹ node_modules ä¸­å„åŒ…çš„ä¾èµ–ï¼Œæœ€ç»ˆä¸ package.json è¿›è¡Œå¯¹æ¯”ï¼Œæ ‡å‡ºæ‰€æœ‰æ²¡æœ‰ç”¨åˆ°çš„åŒ…ã€‚\r\n\r\né’ˆå¯¹ç¬¬äºŒä¸ªé—®é¢˜ï¼Œä¸€ç§åšæ³•æ˜¯å›ºå®šç¼–è¯‘å·¥å…·é›†ã€‚ä¸€èˆ¬å¯¹äºç¼–è¯‘å·¥å…·æ¥è¯´ï¼Œå›¢é˜Ÿå†…éƒ¨ä¼šå°½é‡ç»Ÿä¸€ä¸æ”¶æ•›ï¼Œä¾‹å¦‚ webpackã€Babelã€PostCSSã€Less è¿™äº›åŒ…é•¿æœŸä¼šç¨³å®šä½¿ç”¨æŸä¸€ä¸ªç‰ˆæœ¬ï¼Œå› æ­¤å¯ä»¥è€ƒè™‘åœ¨ç¼–è¯‘æœºä¸Šé¢„è£…è¿™äº›ä¾èµ–ã€‚å°¤å…¶åƒ SASS è¿™ç§è¿˜éœ€è¦ binding.node çš„å®‰è£…è€—æ—¶æ›´é•¿ã€‚å¦‚æœå¸Œæœ›åšç¯å¢ƒéš”ç¦»ï¼Œè¿˜å¯ä»¥è€ƒè™‘é€šè¿‡è™šæ‹Ÿæœºæˆ–å®¹å™¨çš„æ–¹å¼æ¥äº¤ä»˜ä½ å®šåˆ¶è¯çš„æ„å»ºå·¥å…·ç¯å¢ƒã€‚\r\n\r\nå½“ç„¶ï¼Œå¯¹äºç¬¬äºŒä¸ªé—®é¢˜ï¼Œä¹Ÿæœ‰åŒå­¦ä¼šè§‰å¾—ï¼Œæ¯æ¬¡å‘å¸ƒé‡æ–°å®‰è£…ä¸€éç¼–è¯‘å·¥å…·é›†ä¼šæ›´å¥½ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡ npm ç‰ˆæœ¬çš„è¯­ä¹‰æ¥è‡ªåŠ¨å®‰è£…é€‚åˆçš„ç‰ˆæœ¬ï¼Œå¯ä»¥äº«å—åˆ°ä¸€äº›è¡¥ä¸ä¿®å¤çš„å¥½å¤„ã€‚ä¸Šé¢æåˆ°çš„é¢„è£…ï¼Œåˆ™æ˜¯ä¸€ç§å˜ç›¸çš„æ‰€ç‰ˆæœ¬äº†ã€‚å…³äºæ˜¯å¦è¦é”ç‰ˆæœ¬è¿™å—å…¶å®ä¹Ÿæ˜¯ä»è€…è§ä»æ™ºè€…è§æ™ºã€‚\r\n\r\næˆ‘åœ¨å®è·µä¸­åˆ™æ˜¯è¿™å—å¿«éƒ½è¿›è¡Œäº†ä¼˜åŒ–ã€‚é€šè¿‡ä¼˜åŒ–ï¼Œåœ¨ç¼–è¯‘é›†ç¾¤ä¸­è¿›è¡Œç”Ÿäº§ç¯å¢ƒç¼–è¯‘çš„æ•´ä½“è€—æ—¶å‡å°‘äº† 10% å·¦å³ã€‚\r\n\r\n## å…¶ä»–\r\n\r\nè¿˜æœ‰ä¸€äº›å…¶ä»–çš„ä¼˜åŒ–ç»†èŠ‚å¯ä»¥ç®€å•è¯´ä¸€ä¸‹ï¼š\r\n\r\n- å¼€å‘ç¯å¢ƒå¯ä»¥å°† [`devtool`](https://v4.webpack.js.org/configuration/devtool/#devtool) è®¾ä¸º `eval`ã€‚\r\n- å¼€å‘æ—¶å¦‚æœæ²¡æœ‰éœ€æ±‚ï¼Œå¯ä»¥è€ƒè™‘å°† `pathinfo` è®¾ä¸º `false`ã€‚\r\n- html-webpack-plugin çš„ç¼“å­˜æœºåˆ¶ä¼¼ä¹ä»ç„¶æœ‰äº›é—®é¢˜ï¼Œå¦‚æœè¿½æ±‚æè‡´çš„çƒ­æ›´æ–°ï¼ˆå¢é‡ç¼–è¯‘ï¼‰é€Ÿåº¦ï¼Œå¯ä»¥åŠ å…¥ä¸€äº›[é­”æ”¹ä»£ç ](https://github.com/jantimon/html-webpack-plugin/pull/963/files)ã€‚ç”±äºçƒ­æ›´æ–°æœ¬æ¥å°±åˆ†ç§’å¿…äº‰ï¼ˆæ˜¯ 0.1sï¼Œè¿˜æ˜¯ 1sï¼Œè¿˜æ˜¯ 10s çœ‹åˆ°çƒ­æ›´æ–°æ•ˆæœï¼Œä½“éªŒå·®è·å¾ˆå¤§ï¼‰ï¼Œå› æ­¤è¯¥æ”¹åŠ¨è¿˜æ˜¯ä¼šå¸¦æ¥ä¸€å®šçš„æå‡ã€‚\r\n- [happypack](https://github.com/amireh/happypack)ã€‚happypack å·ç§°ä¼šåˆ©ç”¨å¤šçº¿ç¨‹åŠ é€Ÿ loader å¤„ç†ï¼Œä¸è¿‡ä½ å¯åƒä¸‡åˆ«æœŸæœ›å¼€ 4 ä¸ªçº¿ç¨‹å°±ä¼šä½¿ loader è€—æ—¶å˜ä¸ºåŸå…ˆçš„ 1/4ã€‚å®è·µä¸‹æ¥å¾ˆå¤šæ—¶å€™æ€§èƒ½æå‡å¹¶ä¸æ˜æ˜¾ï¼Œåœ¨æå¥½çš„æœºå­ï¼ˆä¾‹å¦‚ 32 coreï¼‰ä¸Šå·®è·æ‰ä¼šæ˜æ˜¾ã€‚åŒæ—¶ï¼Œhappypack ä½œè€…å·²ç»å£°æ˜ä¸å†ç»´æŠ¤è¯¥ä»“åº“ï¼Œå¦‚æœæœ‰éœ€æ±‚å¯ä»¥è€ƒè™‘ç”¨ [thread-loader](https://github.com/webpack-contrib/thread-loader)ã€‚æ‰€ä»¥æˆ‘å»ºè®®åœ¨è‡ªå·±çš„é¡¹ç›®ä¸æ„å»ºç¯å¢ƒä¸­å®æµ‹ä¸€ä¸‹æ•ˆæœï¼Œå†å†³å®šä½¿ä¸ä½¿ç”¨ã€‚\r\n- åˆç†ä½¿ç”¨ `noParse` æ¥è·³è¿‡ä¸€äº›ä»£ç æ¨¡å—ï¼Œä¾‹å¦‚ jqueryã€‚\r\n- æ­¤å¤–ï¼Œresolve ä¹Ÿä¼šæœ‰æ¶ˆè€—ï¼Œå¯ä»¥å°½é‡é¿å…ä¸€äº›åç¼€ä¸å…¨æˆ–è·¯å¾„æŸ¥æ‰¾ã€‚\r\n\r\n## æ•ˆæœ\r\n\r\né€šè¿‡ä¸Šé¢çš„ä¸€ç³»åˆ—ä¼˜åŒ–ï¼Œ\r\n\r\n- å¼€å‘ç¯å¢ƒå…¨é‡ç¼–è¯‘ä»è€—æ—¶ç¼©å‡ 71%ã€‚å¦‚æœåªç¼–è¯‘å¼€å‘æ‰€éœ€çš„å•å…¥å£ï¼Œè€—æ—¶å¯ä¸‹é™ 91%ã€‚\r\n- å¼€å‘ç¯å¢ƒå¢é‡ç¼–è¯‘ä»åŸå…ˆçš„ 20s ä¸‹é™ä¸º 870ms å·¦å³ï¼Œè€—æ—¶ç¼©å‡ 95%ã€‚\r\n- ç”Ÿäº§ç¯å¢ƒç¼–è¯‘ä»åŸå…ˆçš„ 13min+ ç¼©å‡ä¸º 5minï¼Œè€—æ—¶é™ä½ 61 %ã€‚\r\n\r\n# æœ€å\r\n\r\nå¼€ç¯‡å°±è¯´åˆ°ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ç¯‡ç½—åˆ—å„ç§ webpack ä¼˜åŒ–æŠ€å·§çš„æ–‡ç« ï¼Œæ›´åƒæ˜¯å¯¹äºä¸€æ¬¡ä¼˜åŒ–å®è·µçš„æ€»ç»“ä¸åæ€ã€‚\r\n\r\næˆ‘çš„ç›®çš„ä¸€ç›´æ˜¯æå‡ CI/CD ä¸­ã€Œæ„å»ºã€è¿™ä¸€ç¯çš„æ•ˆç‡å’Œç¨³å®šæ€§ï¼ŒåŒæ—¶æå‡æœ¬åœ°å¼€å‘ä½“éªŒï¼Œè€Œé¡¹ç›®åœ¨è¿™ä¸€ç¯èŠ‚çš„æ ¸å¿ƒå·¥å…·å°±æ˜¯ webpackã€‚æ‰€ä»¥ä¼˜åŒ–çš„ä¸­å¾ˆå¤šå·¥ä½œæ¶‰åŠåˆ°äº†è¿™ä¸€å—ã€‚ä½†æ˜¯ï¼Œä½ å®Œå…¨æ²¡å¿…è¦å±€é™åœ¨ webpack çš„ä¼˜åŒ–ä¸Šã€‚æ­£å¦‚æ–‡ä¸­å…³äº Linter çš„é‚£ä¸€èŠ‚ï¼Œå¹¶æ²¡æœ‰ä¸€é—¨å¿ƒæ€å»æƒ³å¦‚ä½•åœ¨ webpack ä¸­åŠ é€Ÿ eslintï¼Œè€Œæ˜¯ç›´æ¥æŠŠå®ƒä» webpack é‡Œå»æ‰äº†ã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥æŠŠå®ƒå®‰æ’åœ¨å…¶ä»–åœ°æ–¹ï¼Œè¿™æ ·åªéœ€è¦æ£€æŸ¥æ›´å°‘çš„æ–‡ä»¶ï¼Œåšæ›´å°‘æ¬¡çš„æ£€æŸ¥ï¼Œå°±å¯ä»¥è¾¾åˆ°ç›¸åŒçš„ç›®çš„ï¼Œç”šè‡³æ›´å¥½çš„æ•ˆæœã€‚\r\n\r\næ‰€ä»¥ï¼Œä¼˜åŒ– webpack æ‰“åŒ…æ€§èƒ½åªæ˜¯æ‰‹æ®µï¼Œä¸æ˜¯ç›®çš„ã€‚è„šæ‰‹æ¶æ˜¯å› ä¸ºå…¶è‡ªèº«è¾¹ç•Œçš„åŸå› ï¼Œæ‰€ä»¥å°†å¾ˆå¤šå·¥å…·éƒ½é›†ä¸­åœ¨äº† webpack èº«ä¸Šï¼Œä½†ä½ ç¡®å®Œå…¨ä¸å¿…ï¼Œå› ä¸ºä½ é¢å‰çš„æ˜¯æ˜Ÿè¾°å¤§æµ·ã€‚å¦‚æœä½ çœ¼é‡Œåªæœ‰ webpackï¼Œé‚£ä½ çœ‹ä»€ä¹ˆéƒ½ä¼šæ˜¯ loader å’Œ pluginã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2020/3/28/1711cbc8be7e5116?w=794&h=336&f=png&s=510966)","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/36","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/36/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/36/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/36/events","html_url":"https://github.com/alienzhou/blog/issues/36","id":573776420,"node_id":"MDU6SXNzdWU1NzM3NzY0MjA=","number":36,"title":"ä¿¡æ¯è§„åˆ™ï¼šç½‘ç»œç»æµçš„ç­–ç•¥æŒ‡å¯¼","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1940757530,"node_id":"MDU6TGFiZWwxOTQwNzU3NTMw","url":"https://api.github.com/repos/alienzhou/blog/labels/Reading","name":"Reading","color":"c9ff9e","default":false,"description":""},{"id":1159845016,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%BB%BC%E5%90%88","name":"ç»¼åˆ","color":"a2eeef","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-03-02T07:39:52Z","updated_at":"2020-03-28T08:49:43Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"https://www.alienzhou.com/2020/03/02/a-strategic-guide-to-the-network-economy/\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/75654765-699ffb80-5c9b-11ea-8ca3-adbbc5b7fba1.png)\r\n\r\nä»Šå¤©çš„è®¸å¤šç®¡ç†è€…â€œåªè§æ ‘æœ¨ä¸è§æ£®æ—â€ï¼Œä»…ä»…å…³æ³¨æŠ€æœ¯å˜é©ï¼Œè€Œå¿½è§†å†³å®šç”Ÿæ­»çš„ç»æµè§„å¾‹ã€‚å¦‚æœä½ æ— æ³•ç†è§£ç½‘ç»œç»æµï¼ˆnetwork economyï¼‰ï¼Œé‚£ä¹ˆå¦‚ä½•èƒ½å¤Ÿç†è§£ä¿¡æ¯æ—¶ä»£ï¼ˆä¾‹å¦‚äº’è”ç½‘ï¼‰çš„å•†ä¸šè¿ä½œæ¨¡å¼å‘¢ï¼Ÿ\r\n\r\nè®°å¾—è¯»ä¹¦æ—¶è€å¸ˆæ›¾ç»æ¨èè¿‡ä¸€ç¯‡ Hal Varian çš„å¾®è§‚ç»æµå­¦è®ºæ–‡ï¼Œæ–‡ç« å¾ˆå¤šï¼Œæ²¡æœ‰é‚£ç§è®ºæ–‡é‡Œé¢å¸¸è§çš„â€œå¼¯å¼¯ç»•ç»•â€çš„æªè¾ï¼Œæ•°å­¦æ¨¡å‹è®¡ç®—ä¸æ¨ç†ç®€æ´æ˜äº†ï¼Œçœ‹ç€å°±åƒæ˜¯ä¸€ä»½éšå ‚ä½œä¸šä¸€èˆ¬çš„éšç¬”ä¹‹ä½œã€‚ç„¶è€Œæ–‡ç« å‘åœ¨äº†ç»æµå­¦çš„é‡è¦æœŸåˆŠä¸Šï¼Œä¸å¾—ä¸è®©äººä½©æœï¼Œå¤§å¸ˆå°±æ˜¯å¤§å¸ˆã€‚\r\n\r\nè€Œè¿™æœ¬[ã€Šä¿¡æ¯è§„åˆ™ã€‹](https://book.douban.com/subject/27179558/)ä¸æ˜¯ç½‘ä¸Šé‚£ç§å……æ–¥ç€åšäººçœ¼çƒçš„å°çŸ¥è¯†ç‚¹çš„â€œä¼ªå­¦æœ¯â€ä¹¦ï¼Œä¹Ÿä¸æ˜¯é‚£ç§åœ¨å­¦æ ¡å›¾ä¹¦é¦†é‡Œçš„æ¯ç‡¥çš„æ•™è¯¾ä¹¦ã€‚ä¹¦ä¸­æ²¡æœ‰æ™¦æ¶©çš„ä¸“ä¸šçŸ¥è¯†ï¼Œè‰°æ·±çš„æ¨¡å‹å…¬å¼ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªä¸ªç°å®æ¡ˆä¾‹æ¥å¯¹ä¹¦ä¸­æåˆ°çš„è®ºç‚¹è¿›è¡Œè§£é‡Šå’Œå°è¯ã€‚è®©å³ä½¿ä¸å…·å¤‡ç»æµå­¦åŸºç¡€çš„è¯»è€…ä¹Ÿèƒ½å¾ˆå¥½ç†è§£å…¶ä¸­çš„å†…å®¹ã€‚\r\n\r\n---\r\n\r\nç½‘ç»œç»æµå’Œä»¥å‰çš„ç»æµè§„å¾‹æœ‰åŒºåˆ«ä¹ˆï¼Ÿ\r\n\r\n**æœ‰ä¹Ÿæ²¡æœ‰ã€‚**\r\n\r\nä¹‹æ‰€ä¸€è¯´æœ‰æ˜¯åœ¨äºï¼Œä¹¦ä¸­æåˆ°ï¼Œä½œè€…ä»¬ç»å¸¸å¬åˆ°åˆ«äººæŠ±æ€¨è¯´ç»æµå­¦åœ¨ç°ä»Šçš„ç»æµæ´»åŠ¨ä¸­å·²æ²¡ä»€ä¹ˆç”¨äº†ã€‚ä¹‹åä»–ä»¬äº†è§£åˆ°ï¼šâ€œæŠ±æ€¨é’ˆå¯¹çš„æ˜¯å¤§å¤šæ•°åœ¨æ ¡å­¦ä¹ çš„å¤å…¸ç»æµå­¦ï¼Œå…¶æ ¸å¿ƒæ˜¯ä¾›ç»™éœ€æ±‚æ›²çº¿å’Œå®Œå…¨ç«äº‰å¸‚åœºï¼Œæ¯”å¦‚å†œäº§å“å¸‚åœºâ€ã€‚æ˜¾ç„¶ï¼Œé’ˆå¯¹å½“ä»Šä¿¡æ¯ç»æµçš„ä¸€äº›ç»æµå­¦ç ”ç©¶æ˜¯ä¸ä¼ ç»Ÿå¤å…¸ç»æµå­¦å­˜åœ¨å·®å¼‚çš„ã€‚è€Œæ­£æ˜¯æœ‰è¿™äº›å·®å¼‚ï¼Œæ‰éœ€è¦è¿™ä¹ˆä¸€æœ¬ä¹¦æ¥è¿›è¡Œåˆ†æä¸å½’çº³ã€‚\r\n\r\nè€Œè¯´å®ƒæ²¡æœ‰ï¼Œä¹Ÿæ˜¯å› ä¸ºä¿¡æ¯ç»æµå¹¶éæ˜¯ä¸€ç§æ¨ªç©ºå‡ºä¸–ã€è¶…è„±äºæ‰€æœ‰ç»æµè§„å¾‹çš„â€œç¥ç‰©â€ã€‚å¦‚æœä½ ä»”ç»†åˆ†æï¼Œä¼šå‘ç°ä»ç„¶æœ‰è®¸å¤šç»æµè§„å¾‹åœ¨å…¶ä¸­è¿è¡Œï¼Œåªæ˜¯ç°åœ¨çš„é™åˆ¶æ¡ä»¶ã€å‰æå˜äº†ã€‚ä¹¦ä¸­ç»å¸¸ä¼šæŒ‡å‡ºä¸€äº›ç»æµæ´»åŠ¨æˆ–å½¢å¼èƒŒåçš„æœ¬è´¨é€»è¾‘ï¼Œå¹¶æä¾›ä¸€äº›å†å²ä¸Šçš„å…ˆä¾‹æ¥å‘Šè¯‰ä½  â€”â€” å®ƒå¹¶ä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹ã€‚ä¾‹å¦‚æ•°å­—åŒ–æ‹·è´å¸¦æ¥çš„æ›´ä¾¿å®œçš„ç”Ÿäº§å’Œåˆ†é”€æœºåˆ¶ï¼Œåœ¨å†å²ä¸Šçš„å›¾ä¹¦é¦†ã€æ‰“å°æœºã€å¤å°æœºä¹Ÿä¸€æ ·å¯¼è‡´äº†è¿™äº›å˜é©ã€‚åˆä¾‹å¦‚åœ¨é˜è¿°â€œé”å®šâ€çš„ç« èŠ‚ï¼Œä½œè€…è¯´ï¼šâ€œæ‘©æ“¦å¹¶æ²¡æœ‰æ¶ˆå¤±ï¼Œå®ƒä»¬åªæ˜¯å˜æ¢äº†å½¢å¼â€ã€‚\r\n\r\næ‰€ä»¥æˆ‘ä»¬æ›´åº”è¯¥è¾¨è¯åœ°çœ‹å¾…ç½‘ç»œç»æµï¼šæ—¢è¦è®¤è¯†åˆ°å®ƒçš„ç‹¬ç‰¹ä¹‹å¤„ï¼Œå­¦ä¹ æ–°æ—¶ä»£çš„â€œç©æ³•â€ï¼›ä¹Ÿè¦é¿å…â€œç¥è¯â€è¿™ç§ç°è±¡ï¼Œå› ä¸ºå®ƒä¹Ÿæ˜¯ç¬¦åˆç»æµå­¦è§„å¾‹ï¼Œå¾ˆå¤šå†å²å…ˆä¾‹æ›´æˆ‘ä»¬æä¾›äº†ä¸€äº›è“æœ¬ã€‚\r\n\r\nä¹¦ä¸­ä¿¡æ¯è¿˜æ˜¯æ¯”è¾ƒä¸°å¯Œçš„ï¼Œæ•´ç†äº†å¦‚ä¸‹çš„æ€ç»´å¯¼å›¾ä»¥ä¾›å‚è€ƒï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/75654892-a4099880-5c9b-11ea-9469-aab477812e47.png)\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/35","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/35/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/35/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/35/events","html_url":"https://github.com/alienzhou/blog/issues/35","id":569461009,"node_id":"MDU6SXNzdWU1Njk0NjEwMDk=","number":35,"title":"å‡¤å‡°é¡¹ç›®ï¼šä¸€ä¸ª IT è¿ç»´çš„ä¼ å¥‡æ•…äº‹","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1940757530,"node_id":"MDU6TGFiZWwxOTQwNzU3NTMw","url":"https://api.github.com/repos/alienzhou/blog/labels/Reading","name":"Reading","color":"c9ff9e","default":false,"description":""},{"id":1159845016,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%BB%BC%E5%90%88","name":"ç»¼åˆ","color":"a2eeef","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-02-23T08:30:33Z","updated_at":"2020-03-28T08:49:31Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"![image](https://user-images.githubusercontent.com/9822789/75106637-a9426400-5659-11ea-814d-ae8e225d5860.png)\r\n\r\n> è¿™æ˜¯ä¸€æœ¬éå¸¸çœŸå®çš„è™šæ„å°è¯´ï¼Œååº”äº†ä»Šå¤© IT éƒ¨é—¨å‡ ä¹æ‰€æœ‰å¸¸è§é—®é¢˜ã€‚ã€‚ã€‚\r\n\r\n[ã€Šå‡¤å‡°é¡¹ç›®ï¼šä¸€ä¸ª IT è¿ç»´çš„ä¼ å¥‡æ•…äº‹ã€‹](https://book.douban.com/subject/34820436/)è™½ç„¶æ˜¯ä¸€æœ¬å’Œ DevOps ç›¸å…³çš„â€œæŠ€æœ¯ä¹¦â€ï¼Œä½†ä¸»ä½“å†…å®¹å…¶å®æ˜¯ä½¿ç”¨å°è¯´çš„å½¢å¼å‘ˆç°çš„ã€‚\r\n\r\næ•…äº‹çš„ä¸»äººå…¬æ¯”å°”åŸæœ¬åªæ˜¯ä¸€ä¸ªä¸­å‹æœºç®¡ç†éƒ¨çš„æŠ€æœ¯ç»ç†ï¼Œä½†å…¬å¸é¢ä¸´ IT é¡¹ç›®å±æœºï¼Œä»–ä¸´å±å—å‘½ï¼Œå‡ºä»» IT è¿ç»´å‰¯æ€»è£ã€‚åˆ«ä»¥ä¸ºè¿™æ˜¯ä¸ªç¾å·®ï¼Œå¯¹äºä»–æ¥è¯´ï¼Œèµ°å‡ºèˆ’é€‚åœˆï¼Œåœ¨ç»éªŒä¸è¶³çš„åŒæ—¶ï¼Œé¢ä¸´çš„æ˜¯å‡ è¿‘å´©æºƒçš„ IT çŠ¶å†µ ğŸ’¢ï¼š\r\n\r\n<!-- more -->\r\n\r\n- ğŸ˜µç®¡ç†æ··è®ºä¸å ªï¼Œæ²¡äººèƒ½è¯´æ¸…æ¥šå¤§å®¶éƒ½åœ¨åšä»€ä¹ˆï¼›\r\n- ğŸ•³é¡¹ç›®ä¸æ–­å»¶æœŸï¼Œæ°¸è¿œæ²¡æœ‰èƒ½æŒ‰æ—¶å®Œæˆçš„éœ€æ±‚ï¼›\r\n- ğŸ’£äº‹æ•…ä¸æ–­ï¼Œå‡ ä¹æ¯å¤©éƒ½è¦å¤„ç†å®‰å…¨ã€è´¢åŠ¡ç­‰ç›¸å…³çš„ IT äº‹æ•…ï¼›\r\n- ğŸ§Ÿâ€â™‚ï¸æ ¸å¿ƒé¡¹ç›®å¤±è´¥ï¼Œâ€œå‡¤å‡°â€å»¶æœŸä¸¤å¹´å¤šï¼Œè€—èµ„ 2000 ä¸‡ç¾å…ƒï¼Œçœ¼çœ‹ç€å°±è¦è¡€æœ¬æ— å½’ï¼›\r\n- â€¦â€¦\r\n\r\né¢å¯¹è¿™äº›é—®é¢˜ï¼Œæœ¬ä¹¦ä»ä¸»äººå…¬æ¯”å°”çš„ç¬¬ä¸€è§†è§’å±•å¼€ï¼Œå¸¦æˆ‘ä»¬çœ‹äº†ä»–å¦‚ä½•ä»è¿·èŒ«ã€å‡ºå…¥é—¨é“ã€æ‰¾åˆ°æ–¹å‘åˆ°æœ€åè§£å†³é—®é¢˜ï¼Œæœ€ç»ˆå¸®åŠ©å…¬å¸æ‰­äºä¸ºç›ˆçš„ä¼ å¥‡â€œå†é™©æ•…äº‹â€ã€‚æ–‡ä¸­æ²¡æœ‰å¤§æ®µçš„è¯´æ•™ã€å…¬å¼ã€å®šå¾‹ï¼ŒæŠ›å¼€è¿™äº›æ•™ç§‘ä¹¦å¼çš„å†…å®¹å½¢æ€ï¼Œè¿™æœ¬æŠ€æœ¯ä¹¦ä»¥å°è¯´çš„å½¢å¼æ¥é˜è¿°ï¼Œå¼•äººå…¥èƒœï¼Œå®Œå…¨ä¸æ— èŠã€‚å¦‚æœä¸æ˜¯æƒ³è§„èŒƒè‡ªå·±çš„ä½œæ¯ï¼Œå¾ˆå¤šæ¬¡æˆ‘éƒ½æƒ³é€šå®µåˆ·å®Œã€‚\r\n\r\né€šè¿‡æ•…äº‹çš„æ–¹å¼æ¥é˜è¿°æœ‰ä¸€ä¸ªéå¸¸çªå‡ºçš„æœ‰ä¼˜ç‚¹ï¼Œæ‰€æœ‰çš„ç†è®ºå’Œæ–¹æ³•ä¸å†æ˜¯å†·å†°å†°çš„æ–‡å­—ï¼Œä½ å¯ä»¥ä»ä¸»äººå…¬é¢ä¸´çš„é—®é¢˜å¼€å§‹ï¼Œä¸€æ­¥æ­¥æ¨æ¼”å‡ºè§£å†³æ–¹æ¡ˆä¸æœ€ä½³å®è·µã€‚æ›´å¥½çš„æ˜¯ï¼Œå¾ˆå¤šç« èŠ‚éƒ½ä»¥é—®é¢˜ç»“æŸï¼Œè¿™æ—¶å€™ä½ å¯ä»¥è‡ªç„¶åœ°åœä¸‹æ¥ï¼Œæ€è€ƒå¦‚æœæ˜¯ä½ ï¼Œä½ ä¼šæ€ä¹ˆåŠï¼Œç„¶åå†æ¥æ­å¼€â€œç­”æ¡ˆâ€ã€‚æ–‡ä¸­æœ‰å¾ˆå¤šæ–¹æ³•è®ºï¼Œå¯èƒ½éœ€è¦ä½ åœ¨å®è·µä¸­ä½“ä¼šæ‰èƒ½æ›´æ·±å…¥åœ°ç†è§£ã€‚æ‰€ä»¥æˆ‘ä¸å‡†å¤‡ç½—åˆ—æ‰€æœ‰è¿™äº›ï¼Œåªæ˜¯ç®€å•è°ˆè°ˆä¸€äº›å°è±¡æ¯”è¾ƒæ·±åˆ»çš„åœ°æ–¹ã€‚\r\n\r\nä¹¦ä¸­å…¶å®æœ‰ä¸€ä¸ªéå¸¸å†…æ ¸çš„é—®é¢˜ï¼šIT çš„ä»·å€¼æµåˆ°åº•æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿè¿™æ—¢éœ€è¦ä½ å›ç­”ï¼ŒIT å·¥ä½œæ˜¯å¦‚ä½•æµåŠ¨çš„ï¼ŒåŒæ—¶ï¼Œè¿˜éœ€è¦ä½ è®¤è¯†åˆ°ï¼ŒIT ä¹Ÿæ˜¯ä¸šåŠ¡ä»·å€¼çš„ç”Ÿäº§éƒ¨é—¨ï¼Œè¿™å°±æ„å‘³ç€ï¼Œä½ éœ€è¦è®©è¿™ä¸ªä»·å€¼æµ/å·¥ä½œæµæ›´å¥½åœ°ä¸ä¸Šä¸‹æ¸¸éƒ¨åˆ†å¯¹æ¥ã€‚æ–‡ä¸­ä¸€ä¸ªå…¸å‹æ¡ˆä¾‹å°±æ˜¯ä¿¡æ¯å®‰å…¨éƒ¨é—¨çš„è´Ÿè´£äººçº¦ç¿°ã€‚ä»–ä¸€ç›´å¼ºè°ƒå®‰å…¨çš„é‡è¦æ€§ï¼Œå¹¶ä¸€ç›´æŠ±æ€¨ç€å¤§å®¶å¯¹ä»–ä»¬çš„å®‰å…¨å·¥ä½œé‡è§†å¤ªä½ï¼Œè¿™ä¼¼ä¹ä¹Ÿç¬¦åˆæˆ‘ä»¬æŠ€æœ¯äººçš„ç›´è§‰ã€‚ä½†ç›´åˆ°æœ‰ä¸€æ¬¡ï¼Œä¸€ä¸ªå…³ä¹å…¬å¸å­˜äº¡çš„å®‰å…¨å®¡è®¡åœ¨æ²¡æœ‰ä»–çš„å®‰å…¨éƒ¨é—¨çš„å¸®åŠ©ä¸‹ï¼Œè€Œæ˜¯é€šè¿‡ä¸šåŠ¡éƒ¨é—¨çš„åŠªåŠ›è¢«æˆåŠŸåŒ–è§£äº†ï¼Œä»–æ‰å¼€å§‹åæ€ã€‚æ­£å¦‚ä¹¦ä¸­çš„å¤§å¸ˆè‰¾ç‘å…‹å‘Šè¯«ä»–çš„é‚£æ ·ï¼šå¦‚æœä»–ï¼ˆçº¦ç¿°ï¼‰æä¸æ¸…æ¥šä¸šåŠ¡éƒ¨é—¨æ˜¯å¦‚ä½•åœ¨æ²¡æœ‰å®‰å…¨éƒ¨é—¨çš„å¸®åŠ©ä¸‹æ¸¡è¿‡å®‰å…¨å±æœºçš„ï¼Œé‚£ä»–å°±ä¸å¯èƒ½åšå‡ºâ€œå¥½äº‹â€ã€‚\r\n\r\néš¾é“å®‰å…¨é—®é¢˜ä¸é‡è¦ä¹ˆï¼Ÿæ˜¾ç„¶é‡è¦ã€‚ä½†å…³é”®åœ¨äºï¼Œä½ ä»ä»€ä¹ˆç»´åº¦ï¼Œä»ä»€ä¹ˆè§†è§’æ¥çœ‹å¾…å®ƒã€è§£å†³å®ƒã€‚ä½ éœ€è¦æŠŠ IT çš„ä»·å€¼æµä¸å…¶ä»–éƒ¨é—¨çš„ä»·å€¼æµè¿é€šèµ·æ¥ï¼Œè¿™æ ·ï¼Œé¡ºç•…çš„ IT â€œç®¡é“â€æ‰èƒ½æ›´é«˜æ•ˆã€æ›´å®‰å…¨ã€æ›´ç¨³å®šåœ°å‘æ•´ä½“æˆ˜ç•¥è¾“é€å…»æ–™ã€‚æ­£å¦‚æ–‡ä¸­æ¯”å°”ã€çº¦ç¿°ä»–ä»¬åœ¨è¯„ä¼°å·¥ä½œçš„ä¼˜å…ˆçº§æ—¶ï¼Œæ­£æ˜¯ä»å‡†ç¡®ç†è§£ä¸šåŠ¡ç›®æ ‡å¼€å§‹ï¼Œåˆ†ç¦»å‡ºæ ¸å¿ƒä»»åŠ¡ï¼Œå†è¿›ä¸€æ­¥é€šè¿‡ä¼˜åŒ–å·¥ä½œæµæ¥æå‡ IT çš„ä»·å€¼æµçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ä½ éœ€è¦ä»å…¨å±€è§†è§’ï¼Œæ¥ç†è§£ IT å·¥ä½œçš„çš„ä»·å€¼ã€‚åŒæ—¶ï¼Œç†è§£å¦‚ä½•ä»å·¥ä½œæµè§’åº¦è€Œéä¸šåŠ¡åŠŸèƒ½è§’åº¦çœ‹ IT å·¥ä½œï¼Œè¶…è„±è§’è‰²é™åˆ¶ã€‚\r\n\r\næ­¤å¤–ï¼Œä¹¦ä¸­è¿˜æœ‰ä¸‰ä¸ªä¸é”™çš„çŸ¥è¯†ç‚¹ã€‚\r\n\r\né¦–å…ˆæ˜¯å…³äºç­‰å¾…æ—¶é—´çš„è®¨è®ºï¼Œå®ƒå‘Šè¯‰æˆ‘ä»¬\r\n\r\n> ç­‰å¾…æ—¶é—´ = å¿™ç¢Œæ—¶é—´ç™¾åˆ†æ¯” / ç©ºé—²æ—¶é—´ç™¾åˆ†æ¯”\r\n\r\næ‰€ä»¥æœ‰ä¸‹é¢è¿™å¼ å›¾ï¼ˆä¹Ÿæ˜¯ä¹¦ä¸­å”¯ä¸€ä¸€å¼ å›¾è¡¨ï¼‰ï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/75106642-b2333580-5659-11ea-9d71-bc55f7284beb.png)\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œå½“å¿™ç¢Œæ—¶é—´ç™¾åˆ†æ¯”è¶…è¿‡ 80% æ—¶ï¼Œç­‰å¾…æ—¶é—´å°†å‘ˆå‡ ä½•çº§ä¸Šå‡ã€‚\r\n\r\nå…¶æ¬¡ï¼Œæ˜¯â€œå››ç§å·¥ä½œå†…å®¹â€ï¼šä¸šåŠ¡é¡¹ç›®ã€IT å†…éƒ¨é¡¹ç›®ã€å˜æ›´å’Œè®¡åˆ’å¤–å·¥ä½œï¼ˆæ•‘ç«ï¼‰ã€‚è¿™å››ç§å·¥ä½œæ„æˆäº† IT è¿ç»´ï¼ˆæˆ–è€…ä¹Ÿå¯ä»¥è¯´å°±æ˜¯ ITï¼‰çš„æœ€ä¸»è¦å·¥ä½œã€‚å…¶ä¸­è®¡åˆ’å¤–å·¥ä½œå¾€å¾€æ˜¯ç”±äºå…¶ä»–å·¥ä½œæˆ–æµç¨‹ä¸Šçš„ç–å¿½å¸¦æ¥çš„é¢å¤–å·¥ä½œï¼Œæ˜¯æœ‰è´Ÿå‘å½±å“çš„ã€‚ä¾‹å¦‚ä½ æ­£æŒ‰è®¡åˆ’åœ¨å¼€å‘æŠ¥è¡¨ç³»ç»Ÿï¼Œè¿™æ—¶å€™çªç„¶æ•°æ®åº“å‘ç”Ÿæ•…éšœï¼Œè¿™å°±æ˜¯ä¸€ä¸ªè®¡åˆ’å¤–çš„å·¥ä½œã€‚è€Œé‡ç‚¹å°±æ˜¯å°½é‡å»é¿å…è®¡åˆ’å¤–çš„å·¥ä½œï¼Œä»æºå¤´ä¸Šéåˆ¶ä½å®ƒã€‚\r\n\r\næ­¤å¤–ï¼Œä¹¦ä¸­æåˆ°äº†ä¸‰æ­¥å·¥ä½œæ³•ï¼š\r\n\r\n- ç¬¬ä¸€å·¥ä½œæ³•æ˜¯å…³äºä»å¼€å‘åˆ° IT è¿ç»´å†åˆ°å®¢æˆ·çš„æ•´ä¸ªè‡ªå·¦å‘å³çš„å·¥ä½œæµã€‚æˆ‘ä»¬å¸Œæœ›æµé‡æœ€å¤§åŒ–ï¼Œå‡å°æ‰¹é‡è§„æ¨¡å’Œå·¥ä½œé—´éš”ã€‚\r\n- ç¬¬äºŒå·¥ä½œæ³•æ˜¯å…³äºä»·å€¼æµå„é˜¶æ®µè‡ªå³å‘å·¦çš„å¿«é€ŸæŒç»­åé¦ˆæµï¼Œæ”¾å¤§å…¶æ•ˆç›Šä»¥ç¡®ä¿é˜²æ­¢é—®é¢˜å†æ¬¡å‘ç”Ÿï¼Œæˆ–è€…æ›´å¿«åœ°å‘ç°å’Œä¿®å¤é—®é¢˜ã€‚\r\n- ç¬¬ä¸‰å·¥ä½œæ³•æ˜¯å…³äºåˆ›é€ å…¬å¸æ–‡åŒ–ï¼ŒåŒ…æ‹¬ï¼šä¸æ–­å°è¯•ï¼Œèƒ½å¤Ÿæ‰¿æ‹…é£é™©å¹¶ä»ä¸­å­¦ä¹ ç»éªŒæ•™è®­ï¼›ç†è§£é‡å¤å’Œç»ƒä¹ æ˜¯ç†Ÿç»ƒæŒæ¡çš„å‰æã€‚\r\n\r\næ–‡ä¸­çš„ä¸‰æ­¥å·¥ä½œæ³•ç»™æˆ‘å¾ˆå¤§å¯å‘ï¼Œè™½ç„¶å®ƒå…·ä½“è½åœ°æ˜¯åœ¨ DevOps ä¸Šï¼Œä½†å…¶æ€æƒ³å†…æ ¸åœ¨åœ¨æˆ–å¤§æˆ–å°åœ°æ–¹éƒ½æ˜¯å¯ä»¥ç”¨åˆ°çš„ã€‚å®ƒè¡¨è¿°äº†çš„ä¸‰éƒ¨åˆ†æ˜¯ï¼š\r\n\r\n1. æœ€ä¼˜åŒ–ä½ å¼€å±•å·¥ä½œçš„æµç¨‹\r\n2. å»ºç«‹åé¦ˆå¾ªç¯çš„æœºåˆ¶\r\n3. è¥é€ ä¸åŸ¹å…»ç›¸åº”çš„æ–‡åŒ–\r\n\r\nå°±æ‹¿æ¨è¡Œå•å…ƒæµ‹è¯•è¿™ä¸ªæŠ€æœ¯ä¾‹å­æ¥è¯´ï¼Œä½ éœ€è¦æ€è€ƒçš„ä¸å…‰æ˜¯ä»€ä¹ˆå•æµ‹æ¡†æ¶å¥½ç”¨ã€æ€æ ·ç»™ä¸€ä¸ªç§æœ‰æ–¹æ³•å†™æµ‹è¯•ï¼Œè€Œæ˜¯è¦å»åˆ†æä»ä¸šåŠ¡éœ€æ±‚åˆ°äº§ç”Ÿå•æµ‹å†åˆ°æœ€åè¾“å‡ºçš„æ•´ä¸ªæµç¨‹ï¼Œæ¸…æ¥šå®ƒæ˜¯å¦‚ä½•ä»ä¸šåŠ¡ä»·å€¼é‡Œæµå‘æ¥çš„ï¼Œå¹¶é€šè¿‡â€œçº¦æŸç†è®ºâ€ç­‰æ–¹æ³•æ¥ä¼˜åŒ–å®ƒã€‚é‚£å»ºç«‹åé¦ˆæœºåˆ¶å‘¢ï¼Ÿä¾‹å¦‚ä¸€ä¸ªå¯èƒ½çš„æ–¹å¼æ˜¯é€šè¿‡å•æµ‹ç»éªŒæˆ–æŠ¥å‘Šæ¥å¯¹åå“ºå¼€å‘å›¢é˜Ÿï¼Œæé«˜å…¶æ•ˆç‡ä¸ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚è€Œæœ€åä¸€æ­¥å·¥ä½œæ–‡åŒ–å‘¢ï¼Ÿåƒä¸‡ä¸è¦å°çœ‹å®ƒï¼ŒæŠ€æœ¯åªæ˜¯ä¸€ç§è§£å†³æ‰‹æ®µï¼Œåœ¨å¾ˆå¤š DevOps çš„åˆ†äº«ä¸­ä¹Ÿä¼šåœ¨å¼€ç¯‡ç« èŠ‚å°±å¼ºè°ƒï¼šDevOps æ›´é‡è¦çš„æ˜¯ä¸€ç§æ–‡åŒ–ï¼Œæ˜¯ä¸€ç³»åˆ—ä»·å€¼è§‚ï¼Œä½ åªæœ‰è®¤åŒå®ƒï¼ŒæŠ€æœ¯å·¥å…·æ‰æœ‰å‘æŒ¥çš„ç©ºé—´ã€‚è¯•æƒ³ï¼Œå¦‚æœæ¯ä¸ªå¼€å‘äººå‘˜ã€æµ‹è¯•äººå‘˜éƒ½ä¸è®¤åŒå•å…ƒæµ‹è¯•çš„ä»·å€¼ï¼Œé‚£ä¹ˆå³ä½¿å¼ºåˆ¶æ¨è¡Œäº†ï¼Œå†™å‡ºæ¥çš„æµ‹è¯•ä»£ç ä¹Ÿä¸è¿‡æ˜¯ä¸ºäº†é€šè¿‡æµ‹è¯•è¦†ç›–ç‡çš„ç´¯èµ˜ï¼Œæ—¢ä¸èƒ½æå‡è½¯ä»¶çš„å¯é æ€§ï¼Œä¹Ÿä¸èƒ½æé«˜ç ”å‘æ•ˆç‡ï¼Œä¹…è€Œä¹…ä¹‹ï¼Œåè€Œä¼šå¸¦æ¥å‰¯ä½œç”¨ï¼Œå½±å“äº§ç ”å›¢é˜Ÿï¼Œé˜»ç¢ä¸šåŠ¡å‘å±•ã€‚\r\n\r\næœ€åï¼Œæä¸€ä¸‹ä¹¦é‡Œç•™ç»™æˆ‘å½±å“å¾ˆæ·±çš„ä¸€ä¸ªç†è®º â€”â€” çº¦æŸç†è®ºã€‚å®ƒè¡¨æ˜ï¼Œåœ¨çº¦æŸç‚¹ä¹‹å¤–çš„ä»»ä½•åœ°æ–¹åšçš„ä»»ä½•æ”¹è¿›éƒ½æ˜¯å¾’åŠ³æ— åŠŸçš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å»è§£å†³çº¦æŸç‚¹çš„é—®é¢˜ï¼Œè§£å†³çš„æ­¥éª¤ä¸€èˆ¬æ˜¯ï¼š\r\n\r\n1. è¯†åˆ«çº¦æŸç‚¹\r\n2. åˆ©ç”¨çº¦æŸç‚¹\r\n3. è®©æ‰€æœ‰å…¶ä»–æ´»åŠ¨éƒ½ä»å±äºçº¦æŸç‚¹\r\n4. æŠŠçº¦æŸç‚¹æå‡åˆ°æ–°çš„æ°´å¹³\r\n5. å¯»æ‰¾ä¸‹ä¸€ä¸ªçº¦æŸç‚¹\r\n\r\nä¸è¿‡æœ¬ä¹¦åªæ˜¯å¼•ç”¨äº†ä¸€äº›çº¦æŸç†è®ºçš„æ–¹æ³•è®ºï¼Œå¦‚æœæƒ³æ·±å…¥ç†è§£æˆ‘å¯èƒ½å¾—å†å»è¯»ä¸€è¯»[é«˜å¾·æ‹‰ç‰¹çš„ã€Šç›®æ ‡ã€‹](https://book.douban.com/subject/3859892/)è¿™æœ¬ä¹¦äº†ã€‚\r\n\r\n---\r\n\r\nã€Šå‡¤å‡°é¡¹ç›®ï¼šä¸€ä¸ª IT è¿ç»´çš„ä¼ å¥‡æ•…äº‹ã€‹é‡Œå…¶å®å€Ÿé‰´äº†å¾ˆå¤šâ€œç”Ÿäº§è¿ä½œç®¡ç†â€å’Œâ€œç²¾ç›Šç”Ÿäº§â€çš„æ€æƒ³ä¸çŸ¥è¯†ã€‚é‰´äºæˆ‘ä¹Ÿä¿®è¿‡â€œç”Ÿäº§è¿ä½œç®¡ç†â€è¿™é—¨è¯¾ï¼Œæ‰€ä»¥è¯»èµ·æ¥ä¹Ÿæœ‰äº›äº²åˆ‡ã€‚ä¹¦ä¸­è‰¾ç‘å…‹åé—®æ¯”å°”ï¼šâ€œä½ ä»¥ä¸º IT è¿ç»´ç®¡ç†ä¼šæ¯”ç®¡ç†ä¸€ä¸ªç”Ÿäº§è½¦é—´æ›´å¤æ‚ã€æ›´é«˜æ·±ä¹ˆï¼Ÿâ€æˆ‘ä¸çŸ¥åˆ°ç©¶ç«Ÿå“ªä¸ªæ›´åŠ é«˜æ·±ï¼Œä½†æˆ‘ç›¸ä¿¡ï¼Œä»å…¶ä»–çš„å…ˆè¡Œé¢†åŸŸä¸­å€Ÿé‰´æ€æƒ³ï¼Œå¯»æ‰¾è§£å†³æ–¹æ¡ˆæ˜¯ä¸€ä¸ªèªæ˜çš„åšæ³•ï¼Œä»æ¥å¦‚æ­¤ã€‚\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/34","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/34/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/34/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/34/events","html_url":"https://github.com/alienzhou/blog/issues/34","id":558522134,"node_id":"MDU6SXNzdWU1NTg1MjIxMzQ=","number":34,"title":"ã€3åˆ†é’Ÿé€Ÿè§ˆã€‘å¦‚ä½•â€œä¸¥è°¨åœ°â€åˆ¤æ–­ä¸¤ä¸ªå˜é‡æ˜¯å¦ç›¸åŒ","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845014,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE0","url":"https://api.github.com/repos/alienzhou/blog/labels/JavaScript","name":"JavaScript","color":"d73a4a","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-02-01T10:44:44Z","updated_at":"2020-02-01T10:44:44Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## å¼•è¨€\r\n\r\nå¦‚ä½•â€œä¸¥è°¨åœ°â€åˆ¤æ–­ä¸¤ä¸ªå˜é‡ç›¸åŒï¼Ÿä»…ä»…ä½¿ç”¨ `===` å°±å¯ä»¥äº†ä¹ˆï¼Ÿ\r\n\r\n![](https://user-gold-cdn.xitu.io/2020/1/4/16f6f67316cf3a36?w=1400&h=200&f=png&s=34612)\r\n\r\n## ä¸¥æ ¼ç›¸ç­‰\r\n\r\næˆ‘ä»¬å¯ä»¥éå¸¸å¿«çš„å†™ä¸€ä¸ª `is` æ–¹æ³•æ¥åˆ¤æ–­å˜é‡ x æ˜¯å¦å°±æ˜¯ yï¼š\r\n\r\n```JavaScript\r\n// ç¬¬ä¸€ç‰ˆ\r\nfunction is(x, y) {\r\n  return x == y;\r\n}\r\n```\r\n\r\nå½“ç„¶ï¼Œä½ ä¼šå¾ˆå¿«å‘ç°ï¼Œæ–¹æ³•é‡Œç”¨äº† `==`ï¼Œç”±äº[éšå¼è½¬æ¢](https://www.w3schools.com/js/js_type_conversion.asp)çš„é—®é¢˜ï¼Œè¿™å¹¶ä¸ä¸¥è°¨ã€‚æ‰€ä»¥æˆ‘ä»¬è‡ªç„¶ä¼šä½¿ç”¨å¦‚ä¸‹çš„æ–¹æ³•ï¼š\r\n\r\n```JavaScript\r\n// ç¬¬äºŒç‰ˆ\r\nfunction is(x, y) {\r\n  return x === y;\r\n}\r\n```\r\n\r\né‚£ä¹ˆè¿™æ˜¯å¦å®Œç¾äº†å‘¢ï¼Ÿ\r\n\r\n## ä¸€ä¸ªâ€œæ›´ä¸¥è°¨â€çš„æ–¹æ³•\r\n\r\n```JavaScript\r\n// ç¬¬ä¸‰ç‰ˆ\r\nfunction is(x, y) {\r\n  if (x === y) {\r\n    return x !== 0 || y !== 0 || 1 / x === 1 / y;\r\n  } else {\r\n    return x !== x && y !== y;\r\n  }\r\n}\r\n```\r\n\r\nä¸Šé¢æ–¹æ³•ç›¸è¾ƒäºæˆ‘ä»¬å¸¸ç”¨çš„ç¬¬äºŒç‰ˆæ›´å¤æ‚äº†ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆå¤šäº†è¿™ä¹ˆå¤šåˆ¤æ–­å‘¢ï¼Ÿ\r\n\r\nä¸‹é¢è®©æˆ‘ä»¬æ¥è¯¦ç»†çœ‹çœ‹ã€‚\r\n\r\n### 1. Infinity\r\n\r\näº†è§£ JavaScript çš„åŒå­¦åº”è¯¥ä¼šè®°å¾—ï¼Œåœ¨å…¨å±€ä¸­æœ‰ä¸€ä¸ªå«åš [`Infinity`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Infinity) çš„å±æ€§ï¼Œè¡¨ç¤ºæ•°å€¼ä¸Šçš„æ— ç©·å¤§ã€‚\r\n\r\n| Infinity å±æ€§çš„å±æ€§ç‰¹æ€§ |  |\r\n|---|---|\r\n| writable | false |\r\n| enumerable | false |\r\n| configurable | false |\r\n\r\nåŒæ—¶ï¼Œä½ ç”¨ `Number.POSITIVE_INFINITY` ä¹Ÿèƒ½è·å–åˆ°è¯¥å€¼ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2020/1/4/16f6f132c0bec8ec?w=436&h=39&f=png&s=3876)\r\n\r\näºæ­¤å¯¹åº”çš„ï¼Œä¹Ÿæœ‰ä¸ª `Number.NEGATIVE_INFINITY` çš„å€¼ï¼Œå®é™…å°±æ˜¯ `-Infinity`ã€‚\r\n\r\nè€Œ `Infinity` æ¯”è¾ƒç‰¹æ®Šçš„ä¸€ç‚¹åœ¨äºï¼Œåœ¨ JavaScript ä¸­ `1 / Infinity` ä¸ `-1 / Infinity`ã€‚ è¢«è®¤ä¸ºæ˜¯ç›¸ç­‰çš„ï¼ˆç”±äº `+0` å’Œ `-0`ï¼Œä¸‹ä¸€èŠ‚ä¼šè¿›ä¸€æ­¥ä»‹ç»ï¼‰\r\n\r\n![](https://user-gold-cdn.xitu.io/2020/1/4/16f6f174c669e5f3?w=322&h=41&f=png&s=2913)\r\n\r\nè€Œåœ¨å¾ˆå¤šåœºæ™¯ä¸­ï¼ŒåŒ…æ‹¬åƒä¸€äº› deepEqual ä¹‹ç±»çš„æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å°†å…¶åˆ¤å®šä¸ºç›¸ç­‰ã€‚å­¦è¿‡ç»Ÿè®¡çš„åŒå­¦éƒ½çŸ¥é“[å‡è®¾æ£€éªŒä¸­æœ‰ä¸¤ç±»é”™è¯¯](https://en.wikipedia.org/wiki/False_positives_and_false_negatives)ï¼š\r\n\r\n- Iç±»é”™è¯¯ï¼šå¼ƒçœŸé”™è¯¯ï¼ˆfalse positiveï¼‰\r\n- IIç±»é”™è¯¯ï¼šå–ä¼ªé”™è¯¯ï¼ˆfalse negativeï¼‰\r\n\r\nç»“åˆæˆ‘ä»¬ä¸Šé¢æåˆ°çš„ï¼Œç¬¬ä¸€ä¸ªæ¡ä»¶åˆ¤æ–­å¯èƒ½å°±ä¼šçŠ¯IIç±»é”™è¯¯ â€”â€” `1 / Infinity` ä¸ `-1 / Infinity` ä¸ç›¸åŒï¼Œå´åˆ¤æ–­ä¸ºç›¸åŒäº†ã€‚æ‰€ä»¥éœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­ï¼š\r\n\r\n```JavaScript\r\nx !== 0 || y !== 0 || 1 / x === 1 / y\r\n```\r\n\r\n`1 / Infinity` ä¸ `-1 / Infinity` åœ¨ä¸ `0` çš„ç›¸ç­‰åˆ¤æ–­ä¸­éƒ½ä¼šä¸º `true`\r\n\r\n\r\n![](https://user-gold-cdn.xitu.io/2020/1/4/16f6f2ddd2f954bc?w=574&h=41&f=png&s=4875)\r\n\r\nè€Œå…¶å€’æ•° `Infinity` ä¸ `-Infinity` æ˜¯ä¸ç›¸ç­‰çš„ï¼Œæ‰€ä»¥é¿å…äº† `1 / Infinity` ä¸ `-1 / Infinity` çš„åˆ¤æ–­é—®é¢˜ã€‚\r\n\r\n### 2. `+0` ä¸ `-0`\r\n\r\nå…¶å®ï¼Œä¸Šé¢ `Infinity` é—®é¢˜çš„æ ¸å¿ƒåŸå› åœ¨äºäº JavaScript ä¸­å­˜åœ¨ `+0` ä¸ `-0`ã€‚\r\n\r\næˆ‘ä»¬çŸ¥é“æ¯ä¸ªæ•°å­—éƒ½æœ‰å…¶å¯¹åº”çš„äºŒè¿›åˆ¶ç¼–ç å½¢å¼ï¼Œå› æ­¤ `+0` ä¸ `-0` ç¼–ç æ˜¯æœ‰åŒºåˆ«çš„ï¼Œå¹³æ—¶æˆ‘ä»¬ä¸ä¸»åŠ¨å£°æ˜çš„è¯ï¼Œæ‰€ä½¿ç”¨çš„å…¶å®éƒ½æ˜¯ `+0`ï¼Œè€Œ JavaScript ä¸ºäº†æˆ‘ä»¬çš„è¿ç®—èƒ½æ›´åŠ æ–¹ä¾¿ï¼Œä¹Ÿåšäº†å¾ˆå¤šé¢å¤–å·¥ä½œã€‚\r\n\r\n> æƒ³è¦æ›´è¿›ä¸€æ­¥äº†è§£ `+0` ä¸ `-0` å¯ä»¥è¯»ä¸€ä¸‹ [JavaScriptâ€™s two zeros](https://2ality.com/2012/03/signedzero.html) è¿™ç¯‡æ–‡ç« ã€‚\r\n\r\nä½†åœ¨å¾ˆå¤šåˆ¤æ–­ç›¸ç­‰çš„å·¥ä½œä¸Šï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¼šæŠŠ `+0` ä¸ `-0` åŒºåˆ†å¼€ã€‚\r\n\r\n```JavaScript\r\nx !== 0 || y !== 0 || 1 / x === 1 / y\r\n```\r\n\r\nä¸Šé¢è¿™ä¸ªå¼å­ä¹Ÿå°±èµ·åˆ°äº†è¿™ä¸ªä½œç”¨ã€‚\r\n\r\n### 3. `NaN`\r\n\r\nJavaScript ä¸­è¿˜æœ‰ä¸€ä¸ªå« [`NaN`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/NaN) å…¨å±€å±æ€§ï¼Œç”¨æ¥è¡¨ç¤ºä¸æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆNot-A-Numberï¼‰\r\n\r\n| NaN å±æ€§çš„å±æ€§ç‰¹æ€§ |  |\r\n|---|---|\r\n| writable | false |\r\n| enumerable | false |\r\n| configurable | false |\r\n\r\nå®ƒæœ‰ä¸€ä¸ªç‰¹ç‚¹ â€”â€” è‡ªå·±ä¸ç­‰äºè‡ªå·±ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2020/1/4/16f6f35688449594?w=328&h=36&f=png&s=2128)\r\n\r\nè¿™å¯èƒ½ä¼šå¯¼è‡´åˆ¤æ–­å‡ºç° I ç±»é”™è¯¯ï¼ˆå¼ƒçœŸé”™è¯¯ï¼‰ï¼šåŸæœ¬æ˜¯ç›¸åŒçš„ï¼Œå´è¢«æˆ‘ä»¬åˆ¤æ–­ä¸ºä¸ç›¸åŒã€‚\r\n\r\nè§£å†³çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼ŒJavaScript ä¸­åªæœ‰ `NaN` ä¼šæœ‰â€œè‡ªå·±ä¸ç­‰äºè‡ªå·±â€çš„ç‰¹ç‚¹ã€‚æ‰€ä»¥åªéœ€è¦åˆ¤æ–­ä¸¤ä¸ªå˜é‡æ˜¯å¦éƒ½â€œè‡ªå·±ä¸ç­‰äºè‡ªå·±â€å³å¯ï¼Œå³éƒ½ä¸º `NaN` ï¼š\r\n\r\n```JavaScript\r\nx !== x && y !== y\r\n```\r\n\r\nå¦‚æœä¸¤ä¸ªå˜é‡éƒ½ä¸º `NaN`ï¼Œé‚£ä¹ˆä»–ä»¬å…¶å®å°±è¿˜æ˜¯ç›¸åŒçš„ã€‚\r\n\r\n## æ€»ç»“\r\n\r\næ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬çš„åŠ å¼ºç‰ˆå°±æ˜¯é¢å¤–å¤„ç†äº† `+0`/`-0` ä¸ `NaN` çš„æƒ…å†µã€‚\r\n\r\nå®é™…é¡¹ç›®ä¸­ï¼Œå¾ˆå¤šæ—¶å€™ç”±äºå¹¶ä¸ä¼šç¢°è¿™æ ·çš„ä¸šåŠ¡å€¼ï¼Œæˆ–è€…è¿™äº›è¾¹ç•Œæƒ…å†µçš„åˆ¤æ–­å¹¶ä¸å½±å“ä¸šåŠ¡é€»è¾‘ï¼Œæ‰€ä»¥ä½¿ç”¨ `===` å°±è¶³å¤Ÿäº†ã€‚\r\n\r\nè€Œåœ¨ä¸€äº›å¼€æºåº“ä¸­ï¼Œç”±äºéœ€è¦æ›´åŠ ä¸¥è°¨ï¼Œæ‰€ä»¥å¾ˆå¤šæ—¶å€™å°±ä¼šè€ƒè™‘ä½¿ç”¨ç¬¬ä¸‰ç‰ˆçš„è¿™ç±»æ–¹æ³•ã€‚ä¾‹å¦‚åœ¨ [react-redux ä¸­å¯¹ props å’Œ state å‰åç›¸ç­‰æ€§åˆ¤æ–­](https://github.com/reduxjs/react-redux/blob/58ae5edee510a2f2f3bc577f55057fe9142f2976/src/utils/shallowEqual.js#L1-L7)ï¼Œ[underscore ä¸­çš„ç›¸ç­‰åˆ¤æ–­æ–¹æ³•](https://github.com/jashkenas/underscore/blob/master/underscore.js#L1191-L1198)ç­‰ã€‚è€Œ underscore ä¸­æ›´è¿›ä¸€æ­¥è¿˜å¯¹ `null` ä¸ `undefined` åšäº†ç‰¹æ®Šå¤„ç†ã€‚\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/33","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/33/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/33/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/33/events","html_url":"https://github.com/alienzhou/blog/issues/33","id":545222880,"node_id":"MDU6SXNzdWU1NDUyMjI4ODA=","number":33,"title":"ã€æ¼«æ¸¸Githubã€‘æ— ç¼–è¯‘/æ— æœåŠ¡å™¨ï¼Œå®ç°æµè§ˆå™¨çš„ CommonJS æ¨¡å—åŒ–","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845014,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE0","url":"https://api.github.com/repos/alienzhou/blog/labels/JavaScript","name":"JavaScript","color":"d73a4a","default":false,"description":""},{"id":1159845015,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E6%B5%8F%E8%A7%88%E5%99%A8","name":"æµè§ˆå™¨","color":"cfd3d7","default":false,"description":""},{"id":1159845016,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%BB%BC%E5%90%88","name":"ç»¼åˆ","color":"a2eeef","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-01-04T01:14:32Z","updated_at":"2020-03-28T08:48:44Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## å¼•è¨€\r\n\r\nå¹³æ—¶ç»å¸¸ä¼šé€› Githubï¼Œé™¤äº†ä¸€äº› star æé«˜çš„å¤§é¡¹ç›®å¤–ï¼Œè¿˜ä¼šåœ¨ Github ä¸Šå‘ç°å¾ˆå¤šæœ‰æ„æ€çš„å°é¡¹ç›®ã€‚é¡¹ç›®æˆ–æ˜¯æƒ³æ³•å¾ˆæœ‰è¶£ï¼Œæˆ–æ˜¯æœ‰ä¸é”™çš„æŠ€æœ¯ç‚¹ï¼Œè¯»èµ·æ¥éƒ½è®©äººæœ‰æ‰€æ”¶è·ã€‚æ‰€ä»¥å‡†å¤‡å†™ä¸€ä¸ªã€Œæ¼«æ¸¸Githubã€ç³»åˆ—ï¼Œä¸å®šæœŸåˆ†äº«ä¸è§£è¯»åœ¨ Github ä¸Šå¶é‡çš„æœ‰è¶£é¡¹ç›®ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/71757685-7807ac00-2ed2-11ea-97e7-c93eec7b6017.png)\r\n\r\nå¥½äº†ä¸‹é¢è¿›å…¥æ­£é¢˜ã€‚æœ¬æœŸè¦ä»‹ç»çš„ä»“åº“å« [one-click.js](https://github.com/jordwalke/one-click.js) ã€‚\r\n\r\n## 1. one-click.js æ˜¯ä»€ä¹ˆ\r\n\r\n[one-click.js](https://github.com/jordwalke/one-click.js) æ˜¯ä¸ªå¾ˆæœ‰æ„æ€çš„åº“ã€‚Github é‡Œæ˜¯è¿™ä¹ˆä»‹ç»å®ƒçš„ï¼š\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/71757693-8f469980-2ed2-11ea-8e08-97f216665249.png)\r\n\r\næˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœå¸Œæœ› CommonJS çš„æ¨¡å—åŒ–ä»£ç èƒ½åœ¨æµè§ˆå™¨ä¸­æ­£å¸¸è¿è¡Œï¼Œé€šå¸¸éƒ½ä¼šéœ€è¦æ„å»º/æ‰“åŒ…å·¥å…·ï¼Œä¾‹å¦‚ webpackã€rollup ç­‰ã€‚è€Œ one-click.js å¯ä»¥è®©ä½ åœ¨ä¸éœ€è¦è¿™äº›æ„å»ºå·¥å…·çš„åŒæ—¶ï¼Œä¹Ÿå¯ä»¥åœ¨æµè§ˆå™¨ä¸­æ­£å¸¸è¿è¡ŒåŸºäº CommonJS çš„æ¨¡å—ç³»ç»Ÿã€‚\r\n\r\nè¿›ä¸€æ­¥çš„ï¼Œç”šè‡³ä½ éƒ½ä¸éœ€è¦å¯åŠ¨ä¸€ä¸ªæœåŠ¡å™¨ã€‚ä¾‹å¦‚è¯•ç€ä½ å¯ä»¥è¯•ä¸‹ clone ä¸‹ one-click.js é¡¹ç›®ï¼Œç›´æ¥åŒå‡»ï¼ˆç”¨æµè§ˆå™¨æ‰“å¼€ï¼‰å…¶ä¸­çš„ `example/index.html` å°±å¯ä»¥è¿è¡Œã€‚\r\n\r\nRepo é‡Œæœ‰ä¸€å¥è¯æ¦‚è¿°äº†å®ƒçš„åŠŸèƒ½ï¼š\r\n\r\n> Use CommonJS modules directly in the browser with no build step and no web server.\r\n\r\nä¸¾ä¸ªä¾‹å­æ¥è¯´ â€”â€”\r\n\r\nå‡è®¾åœ¨å½“å‰ç›®å½•ï¼ˆ`demo/`ï¼‰ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰ä¸‰ä¸ªâ€œæ¨¡å—â€æ–‡ä»¶ï¼š\r\n\r\n`demo/plus.js`ï¼š\r\n\r\n```JavaScript\r\n// plus.js\r\nmodule.exports = function plus(a, b) {\r\n    return a + b;\r\n}\r\n```\r\n\r\n`demo/divide.js`ï¼š\r\n\r\n```JavaScript\r\n// divide.js\r\nmodule.exports = function divide(a, b) {\r\n    return a / b;\r\n}\r\n```\r\n\r\nä¸å…¥å£æ¨¡å—æ–‡ä»¶ `demo/main.js`ï¼š\r\n\r\n```JavaScript\r\n// main.js\r\nconst plus = require('./plus.js');\r\nconst divide = require('./divide.js');\r\nconsole.log(divide(12, add(1, 2)));\r\n// output: 4\r\n```\r\n\r\nå¸¸è§ç”¨æ³•æ˜¯æŒ‡å®šå…¥å£ï¼Œç”¨ webpack ç¼–è¯‘æˆä¸€ä¸ª bundleï¼Œç„¶åæµè§ˆå™¨å¼•ç”¨ã€‚è€Œ one-click.js è®©ä½ å¯ä»¥æŠ›å¼ƒè¿™äº›ï¼Œåªéœ€è¦åœ¨ HTML ä¸­è¿™ä¹ˆç”¨ï¼š\r\n\r\n```HTML\r\n<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <title>one click example</title>\r\n</head>\r\n<body>\r\n    <script type=\"text/javascript\" src=\"./one-click.js\" data-main=\"./main.js\"></script>\r\n</body>\r\n</html>\r\n```\r\n\r\næ³¨æ„ `script` æ ‡ç­¾çš„ä½¿ç”¨æ–¹å¼ï¼Œå…¶ä¸­çš„ `data-main` å°±æŒ‡å®šäº†å…¥å£æ–‡ä»¶ã€‚æ­¤æ—¶ç›´æ¥ç”¨æµè§ˆå™¨æ‰“å¼€è¿™ä¸ªæœ¬åœ° HTML æ–‡ä»¶ï¼Œå°±å¯ä»¥æ­£å¸¸è¾“å‡ºç»“æœ 7ã€‚\r\n\r\n## 2. æ‰“åŒ…å·¥å…·æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ\r\n\r\nä¸Šä¸€èŠ‚ä»‹ç»äº† one-click.js çš„åŠŸèƒ½ â€”â€” æ ¸å¿ƒå°±æ˜¯å®ç°ä¸éœ€è¦æ‰“åŒ…/æ„å»ºçš„å‰ç«¯æ¨¡å—åŒ–èƒ½åŠ›ã€‚\r\n\r\nåœ¨ä»‹ç»å…¶å†…éƒ¨å®ç°è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹æ‰“åŒ…å·¥å…·éƒ½å¹²äº†ä»€ä¹ˆã€‚ä¿—è¯è¯´ï¼ŒçŸ¥å·±çŸ¥å½¼ï¼Œç™¾æˆ˜ä¸æ®†ã€‚\r\n\r\nè¿˜æ˜¯æˆ‘ä»¬é‚£ä¸‰ä¸ª JavaScript æ–‡ä»¶ã€‚\r\n\r\nplus.jsï¼š\r\n\r\n```JavaScript\r\n// plus.js\r\nmodule.exports = function plus(a, b) {\r\n    return a + b;\r\n}\r\n```\r\n\r\ndivide.jsï¼š\r\n\r\n```JavaScript\r\n// divide.js\r\nmodule.exports = function divide(a, b) {\r\n    return a / b;\r\n}\r\n```\r\n\r\nä¸å…¥å£æ¨¡å— main.jsï¼š\r\n\r\n```JavaScript\r\n// main.js\r\nconst plus = require('./plus.js');\r\nconst divide = require('./divide.js');\r\nconsole.log(divide(12, add(1, 2)));\r\n// output: 4\r\n```\r\n\r\nå›å¿†ä¸€ä¸‹ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ webpack æ—¶ï¼Œä¼šæŒ‡å®šå…¥å£ï¼ˆmain.jsï¼‰ã€‚webpack ä¼šæ ¹æ®è¯¥å…¥å£æ‰“åŒ…å‡ºä¸€ä¸ª bundleï¼ˆä¾‹å¦‚ bundle.jsï¼‰ã€‚æœ€åæˆ‘ä»¬åœ¨é¡µé¢ä¸­å¼•å…¥å¤„ç†å¥½çš„ bundle.js å³å¯ã€‚è¿™æ—¶çš„ bundle.js é™¤äº†æºç ï¼Œå·²ç»åŠ äº†å¾ˆå¤š webpack çš„â€œç§è´§â€ã€‚\r\n\r\nç®€å•ç†ä¸€ç†å…¶ä¸­ webpack æ¶‰åŠåˆ°çš„å·¥ä½œï¼š\r\n\r\n1. **ä¾èµ–åˆ†æ**ï¼šé¦–å…ˆï¼Œåœ¨æ‰“åŒ…æ—¶ webpack ä¼šæ ¹æ®è¯­æ³•åˆ†æç»“æœæ¥è·å–æ¨¡å—çš„ä¾èµ–å…³ç³»ã€‚ç®€å•æ¥è¯´ï¼Œåœ¨ CommonJS ä¸­å°±æ˜¯æ ¹æ®è§£æå‡ºçš„ require è¯­æ³•æ¥å¾—åˆ°å½“å‰æ¨¡å—æ‰€ä¾èµ–çš„å­æ¨¡å—ã€‚\r\n2. **ä½œç”¨åŸŸéš”ç¦»ä¸å˜é‡æ³¨å…¥**ï¼šå¯¹äºæ¯ä¸ªæ¨¡å—æ–‡ä»¶ï¼Œwebpack éƒ½ä¼šå°†å…¶åŒ…è£¹åœ¨ä¸€ä¸ª function ä¸­ã€‚è¿™æ ·æ—¢å¯ä»¥åšåˆ° `module`ã€`require` ç­‰å˜é‡çš„æ³¨å…¥ï¼Œåˆå¯ä»¥éš”ç¦»ä½œç”¨åŸŸï¼Œé˜²æ­¢å˜é‡çš„å…¨å±€æ±¡æŸ“ã€‚\r\n3. **æä¾›æ¨¡å—è¿è¡Œæ—¶**ï¼šæœ€åï¼Œä¸ºäº† `require`ã€`exports` çš„æœ‰æ•ˆæ‰§è¡Œï¼Œè¿˜éœ€è¦æä¾›ä¸€å¥—è¿è¡Œæ—¶ä»£ç ï¼Œæ¥å®ç°æ¨¡å—çš„åŠ è½½ã€æ‰§è¡Œã€å¯¼å‡ºç­‰åŠŸèƒ½ã€‚\r\n\r\n> å¦‚æœå¯¹ä»¥ä¸Šçš„ 2ã€3 é¡¹ä¸å¤ªäº†è§£ï¼Œå¯ä»¥ä»ç¯‡æ–‡ç« ä¸­äº†è§£ [webpack çš„æ¨¡å—è¿è¡Œæ—¶è®¾è®¡](https://juejin.im/post/5b82ac82f265da431d0e6d25#heading-3)ã€‚\r\n\r\n## 3. æˆ‘ä»¬é¢å¯¹çš„æŒ‘æˆ˜\r\n\r\næ²¡æœ‰äº†æ„å»ºå·¥å…·ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œä½¿ç”¨äº† CommonJS çš„æ¨¡å—ï¼Œå…¶å®å°±æ˜¯è¦æƒ³åŠæ³•å®Œæˆä¸Šé¢æåˆ°çš„ä¸‰é¡¹å·¥ä½œï¼š\r\n\r\n- ä¾èµ–åˆ†æ\r\n- ä½œç”¨åŸŸéš”ç¦»ä¸å˜é‡æ³¨å…¥\r\n- æä¾›æ¨¡å—è¿è¡Œæ—¶\r\n\r\nè§£å†³è¿™ä¸‰ä¸ªé—®é¢˜å°±æ˜¯ one-click.js çš„æ ¸å¿ƒä»»åŠ¡ã€‚ä¸‹é¢æˆ‘ä»¬æ¥åˆ†åˆ«çœ‹çœ‹æ˜¯å¦‚ä½•è§£å†³çš„ã€‚\r\n\r\n### 3.1. ä¾èµ–åˆ†æ\r\n\r\nè¿™æ˜¯ä¸ªéº»çƒ¦çš„é—®é¢˜ã€‚å¦‚æœæƒ³è¦æ­£ç¡®åŠ è½½æ¨¡å—ï¼Œå¿…é¡»å‡†ç¡®çŸ¥é“æ¨¡å—é—´çš„ä¾èµ–ã€‚ä¾‹å¦‚ä¸Šé¢æåˆ°çš„ä¸‰ä¸ªæ¨¡å—æ–‡ä»¶ â€”â€” `main.js` ä¾èµ– `plus.js` å’Œ `divide.js`ï¼Œæ‰€ä»¥åœ¨è¿è¡Œ `main.js` ä¸­ä»£ç æ—¶ï¼Œéœ€è¦ä¿è¯ `plus.js` å’Œ `divide.js` éƒ½å·²ç»åŠ è½½è¿›æµè§ˆå™¨ç¯å¢ƒã€‚ç„¶è€Œé—®é¢˜å°±åœ¨äºï¼Œæ²¡æœ‰ç¼–è¯‘å·¥å…·åï¼Œæˆ‘ä»¬è‡ªç„¶æ— æ³•è‡ªåŠ¨åŒ–çš„çŸ¥é“æ¨¡å—é—´çš„ä¾èµ–å…³ç³»ã€‚\r\n\r\nå¯¹äº [RequireJS](https://requirejs.org/) è¿™æ ·çš„æ¨¡å—åº“æ¥è¯´ï¼Œå®ƒæ˜¯åœ¨ä»£ç ä¸­å£°æ˜å½“å‰æ¨¡å—çš„ä¾èµ–ï¼Œç„¶åä½¿ç”¨å¼‚æ­¥åŠ è½½åŠ å›è°ƒçš„æ–¹å¼ã€‚æ˜¾ç„¶ï¼ŒCommonJS è§„èŒƒæ˜¯æ²¡æœ‰è¿™æ ·çš„å¼‚æ­¥ API çš„ã€‚\r\n\r\nè€Œ one-click.js ç”¨äº†ä¸€ä¸ªå–å·§ä½†æ˜¯æœ‰é¢å¤–æˆæœ¬çš„æ–¹å¼æ¥åˆ†æä¾èµ– â€”â€” åŠ è½½ä¸¤éæ¨¡å—æ–‡ä»¶ã€‚åœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ¨¡å—æ–‡ä»¶æ—¶ï¼Œä¸ºæ¨¡å—æ–‡ä»¶æä¾›ä¸€ä¸ª mock çš„ `require` æ–¹æ³•ï¼Œæ¯å½“æ¨¡å—è°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼Œå°±å¯ä»¥åœ¨ require ä¸­çŸ¥é“å½“å‰æ¨¡å—ä¾èµ–å“ªäº›å­æ¨¡å—äº†ã€‚\r\n\r\n```JavaScript\r\n// main.js\r\nconst plus = require('./plus.js');\r\nconst divide = require('./divide.js');\r\nconsole.log(minus(12, add(1, 2)));\r\n```\r\n\r\nä¾‹å¦‚ä¸Šé¢çš„ `main.js`ï¼Œæˆ‘ä»¬å¯ä»¥æä¾›ä¸€ä¸ªç±»ä¼¼ä¸‹é¢çš„ `require` æ–¹æ³•ï¼š\r\n\r\n```JavaScript\r\nconst recordedFieldAccessesByRequireCall = {};\r\nconst require = function collect(modPath) {\r\n    recordedFieldAccessesByRequireCall[modPath] = true;\r\n    var script = document.createElement('script');\r\n    script.src = modPath;\r\n    document.body.appendChild(script);\r\n};\r\n```\r\n\r\n`main.js` åŠ è½½åï¼Œä¼šåšä¸¤ä»¶äº‹ï¼š\r\n\r\n1. è®°å½•å½“å‰æ¨¡å—ä¸­ä¾èµ–çš„å­æ¨¡å—ï¼›\r\n2. åŠ è½½å­æ¨¡å—ã€‚\r\n\r\nè¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ `recordedFieldAccessesByRequireCall` ä¸­è®°å½•å½“å‰æ¨¡å—çš„ä¾èµ–æƒ…å†µï¼›åŒæ—¶åŠ è½½å­æ¨¡å—ã€‚è€Œå¯¹äºå­æ¨¡å—ä¹Ÿå¯ä»¥æœ‰é€’å½’æ“ä½œï¼Œç›´åˆ°ä¸å†æœ‰æ–°çš„ä¾èµ–å‡ºç°ã€‚æœ€åå°†å„ä¸ªæ¨¡å—çš„ `recordedFieldAccessesByRequireCall` æ•´åˆèµ·æ¥å°±æ˜¯æˆ‘ä»¬çš„ä¾èµ–å…³ç³»ã€‚\r\n\r\næ­¤å¤–ï¼Œå¦‚æœæˆ‘ä»¬è¿˜æƒ³è¦çŸ¥é“ `main.js` å®é™…è°ƒç”¨äº†å­æ¨¡å—ä¸­çš„å“ªäº›æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡ `Proxy` æ¥è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œç»Ÿè®¡è¿›ä¸€æ­¥çš„ä¾èµ–æƒ…å†µï¼š\r\n\r\n```JavaScript\r\nconst require = function collect(modPath) {\r\n    recordedFieldAccessesByRequireCall[modPath] = [];\r\n    var megaProxy = new Proxy(function(){}, {\r\n        get: function(target, prop, receiver) {\r\n            if(prop == Symbol.toPrimitive) {\r\n                return function() {0;};\r\n            }\r\n            return megaProxy;\r\n        }\r\n    });\r\n    var recordFieldAccess = new Proxy(function(){}, {\r\n        get: function(target, prop, receiver) {\r\n            window.recordedFieldAccessesByRequireCall[modPath].push(prop);\r\n            return megaProxy;\r\n        }\r\n    });\r\n    // â€¦â€¦ ä¸€äº›å…¶ä»–å¤„ç†\r\n    return recordFieldAccess;\r\n};\r\n```\r\n\r\nä»¥ä¸Šçš„ä»£ç ä¼šåœ¨ä½ è·å–è¢«å¯¼å…¥æ¨¡å—çš„å±æ€§æ—¶è®°å½•æ‰€ä½¿ç”¨çš„å±æ€§ã€‚\r\n\r\nä¸Šé¢æ‰€æœ‰æ¨¡å—çš„åŠ è½½å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„â€œåŠ è½½ä¸¤éâ€çš„ç¬¬ä¸€éï¼Œç”¨äºåˆ†æä¾èµ–å…³ç³»ã€‚è€Œç¬¬äºŒéå°±éœ€è¦åŸºäºå…¥å£æ¨¡å—çš„ä¾èµ–å…³ç³»ï¼Œâ€œé€†å‘â€åŠ è½½æ¨¡å—å³å¯ã€‚ä¾‹å¦‚ `main.js` ä¾èµ– `plus.js` å’Œ `divide.js`ï¼Œé‚£ä¹ˆå®é™…ä¸ŠåŠ è½½çš„é¡ºåºæ˜¯ `plus.js` -> `divide.js` -> `main.js`ã€‚\r\n\r\nå€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ‰€æœ‰æ¨¡å—çš„è¿‡ç¨‹ä¸­ï¼Œè¿™äº›æ¨¡å—æ‰§è¡ŒåŸºæœ¬éƒ½æ˜¯ä¼šæŠ¥é”™çš„ï¼ˆå› ä¸ºä¾èµ–çš„åŠ è½½é¡ºåºéƒ½æ˜¯é”™è¯¯çš„ï¼‰ï¼Œæˆ‘ä»¬ä¼šå¿½ç•¥æ‰§è¡Œçš„é”™è¯¯ï¼Œåªå…³æ³¨ä¾èµ–å…³ç³»çš„åˆ†æã€‚å½“æ‹¿åˆ°ä¾èµ–å…³ç³»åï¼Œå†ä½¿ç”¨æ­£ç¡®çš„é¡ºåºé‡æ–°åŠ è½½ä¸€éæ‰€æœ‰æ¨¡å—æ–‡ä»¶ã€‚one-click.js ä¸­æœ‰æ›´å®Œå¤‡çš„å®ç°ï¼Œè¯¥æ–¹æ³•åä¸º `scrapeModuleIdempotent`ï¼Œå…·ä½“[æºç å¯ä»¥çœ‹è¿™é‡Œ](https://github.com/jordwalke/one-click.js/blob/8db5f181fe7dafa050d5789741fbe4b2c87ba779/one-click.js#L378-L505)ã€‚\r\n\r\nåˆ°è¿™é‡Œä½ å¯èƒ½ä¼šå‘ç°ï¼šâ€œè¿™æ˜¯ä¸€ç§æµªè´¹å•Šï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½åŠ è½½äº†ä¸¤éã€‚â€\r\n\r\nç¡®å®å¦‚æ­¤ï¼Œè¿™ä¹Ÿæ˜¯ one-click.js çš„ [tradeoff](https://github.com/jordwalke/one-click.js#tradeoffs)ï¼š\r\n\r\n> In order to make this work offline, One Click needs to initialize your modules twice, once in the background upon page load, in order to map out the dependency graph, and then another time to actually perform the module loading.\r\n\r\n### 3.2. ä½œç”¨åŸŸéš”ç¦»\r\n\r\næˆ‘ä»¬çŸ¥é“ï¼Œæ¨¡å—æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹ç‚¹ â€”â€” æ¨¡å—é—´çš„ä½œç”¨åŸŸæ˜¯éš”ç¦»çš„ã€‚ä¾‹å¦‚ï¼Œå¯¹äºå¦‚ä¸‹æ™®é€šçš„ JavaScript è„šæœ¬ï¼š\r\n\r\n```JavaScript\r\n// normal script.js\r\nvar foo = 123;\r\n```\r\n\r\nå½“å…¶åŠ è½½è¿›æµè§ˆå™¨æ—¶ï¼Œ`foo` å˜é‡å®é™…ä¼šå˜æˆä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¯ä»¥é€šè¿‡ `window.foo` è®¿é—®åˆ°ï¼Œè¿™ä¹Ÿä¼šå¸¦æ¥å…¨å±€æ±¡æŸ“ï¼Œæ¨¡å—é—´çš„å˜é‡ã€æ–¹æ³•éƒ½å¯èƒ½äº’ç›¸å†²çªä¸è¦†ç›–ã€‚\r\n\r\nåœ¨ NodeJS ç¯å¢ƒä¸‹ï¼Œç”±äºä½¿ç”¨ CommonJS è§„èŒƒï¼ŒåŒæ ·åƒä¸Šé¢è¿™æ ·çš„æ¨¡å—æ–‡ä»¶è¢«å¯¼å…¥æ—¶ï¼Œ `foo` å˜é‡çš„ä½œç”¨åŸŸåªåœ¨æºæ¨¡å—ä¸­ï¼Œä¸ä¼šæ±¡æŸ“å…¨å±€ã€‚è€Œ NodeJS åœ¨å®ç°ä¸Šå…¶å®å°±æ˜¯[ç”¨ä¸€ä¸ª wrap function åŒ…è£¹äº†æ¨¡å—å†…çš„ä»£ç ](https://juejin.im/post/5b82ac82f265da431d0e6d25#heading-2)ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œfunction ä¼šå½¢æˆå…¶è‡ªå·±çš„ä½œç”¨åŸŸï¼Œå› æ­¤å°±å®ç°äº†éš”ç¦»ã€‚\r\n\r\nNodeJS ä¼šåœ¨ `require` æ—¶å¯¹æºç æ–‡ä»¶è¿›è¡ŒåŒ…è£…ï¼Œè€Œ webpack è¿™ç±»æ‰“åŒ…å·¥å…·ä¼šåœ¨ç¼–è¯‘æœŸå¯¹æºç æ–‡ä»¶è¿›è¡Œæ”¹å†™ï¼ˆä¹Ÿæ˜¯ç±»ä¼¼çš„åŒ…è£…ï¼‰ã€‚è€Œ one-click.js æ²¡æœ‰ç¼–è¯‘å·¥å…·ï¼Œé‚£ç¼–è¯‘æœŸæ”¹å†™è‚¯å®šè¡Œä¸é€šäº†ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿä¸‹é¢æ¥ä»‹ç»ä¸¤ç§å¸¸ç”¨æ–¹å¼ï¼š\r\n\r\n#### 3.2.1. JavaScript çš„åŠ¨æ€ä»£ç æ‰§è¡Œ\r\n\r\nä¸€ç§æ–¹å¼å¯ä»¥é€šè¿‡ `fetch` è¯·æ±‚è·å– script ä¸­æ–‡æœ¬å†…å®¹ï¼Œç„¶åé€šè¿‡ `new Function` æˆ– `eval` è¿™æ ·çš„æ–¹å¼æ¥å®ç°åŠ¨æ€ä»£ç çš„æ‰§è¡Œã€‚è¿™é‡Œä»¥ `fetch` + `new Function` æ–¹å¼æ¥åšä¸ªä»‹ç»ï¼š\r\n\r\nè¿˜æ˜¯ä¸Šé¢çš„é™¤æ³•æ¨¡å— `divide.js`ï¼Œç¨åŠ æ”¹é€ ä¸‹ï¼Œæºç å¦‚ä¸‹ï¼š\r\n\r\n```JavaScript\r\n// ä»¥è„šæœ¬å½¢å¼åŠ è½½æ—¶ï¼Œè¯¥å˜é‡å°†ä¼šå˜ä¸º window.outerVar çš„å…¨å±€å˜é‡ï¼Œé€ æˆæ±¡æŸ“\r\nvar outerVar = 123;\r\n\r\nmodule.exports = function (a, b) {\r\n    return a / b;\r\n}\r\n```\r\n\r\nç°åœ¨æˆ‘ä»¬æ¥å®ç°ä½œç”¨åŸŸå±è”½ï¼š\r\n\r\n```JavaScript\r\nconst modMap = {};\r\nfunction require(modPath) {\r\n    if (modMap[modPath]) {\r\n        return modMap[modPath].exports;\r\n    }\r\n}\r\n\r\nfetch('./divide.js')\r\n    .then(res => res.text())\r\n    .then(source => {\r\n        const mod = new Function('exports', 'require', 'module', source);\r\n        const modObj = {\r\n            id: 1,\r\n            filename: './divide.js',\r\n            parents: null,\r\n            children: [],\r\n            exports: {}\r\n        };\r\n\r\n        mod(modObj.exports, require, modObj);\r\n        modMap['./divide.js'] = modObj;\r\n        return;\r\n    })\r\n    .then(() => {\r\n        const divide = require('./divide.js')\r\n        console.log(divide(10, 2)); // 5\r\n        console.log(window.outerVar); // undefined\r\n    });\r\n```\r\n\r\nä»£ç å¾ˆç®€å•ï¼Œæ ¸å¿ƒå°±æ˜¯é€šè¿‡ `fetch` è·å–åˆ°æºç åï¼Œé€šè¿‡ `new Function` å°†å…¶æ„é€ åœ¨ä¸€ä¸ªå‡½æ•°å†…ï¼Œè°ƒç”¨æ—¶å‘å…¶â€œæ³¨å…¥â€ä¸€äº›æ¨¡å—è¿è¡Œæ—¶çš„å˜é‡ã€‚ä¸ºäº†ä»£ç é¡ºåˆ©è¿è¡Œï¼Œè¿˜æä¾›äº†ä¸€ä¸ªç®€å•çš„ `require` æ–¹æ³•æ¥å®ç°æ¨¡å—å¼•ç”¨ã€‚\r\n\r\nå½“ç„¶ï¼Œä¸Šé¢è¿™æ˜¯ä¸€ç§è§£å†³æ–¹å¼ï¼Œç„¶è€Œåœ¨ one-click.js çš„ç›®æ ‡ä¸‹å´è¡Œä¸é€šã€‚å› ä¸º one-click.js è¿˜æœ‰ä¸€ä¸ªç›®æ ‡æ˜¯èƒ½å¤Ÿåœ¨æ— æœåŠ¡å™¨ï¼ˆofflineï¼‰çš„æƒ…å†µä¸‹è¿è¡Œï¼Œæ‰€ä»¥ `fetch` è¯·æ±‚æ˜¯æ— æ•ˆçš„ã€‚\r\n\r\né‚£ä¹ˆ one-click.js æ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬å°±æ¥äº†è§£ä¸‹ï¼š\r\n\r\n#### 3.2.2. å¦ä¸€ç§ä½œç”¨åŸŸéš”ç¦»æ–¹å¼\r\n\r\nä¸€èˆ¬è€Œè¨€ï¼Œéš”ç¦»çš„éœ€æ±‚ä¸æ²™ç®±éå¸¸ç±»ä¼¼ï¼Œè€Œåœ¨å‰ç«¯åˆ›å»ºä¸€ä¸ªæ²™ç®±æœ‰ä¸€ç§å¸¸ç”¨çš„æ–¹å¼ï¼Œå°±æ˜¯ iframeã€‚ä¸‹é¢ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬æŠŠç”¨æˆ·å®é™…ä½¿ç”¨çš„çª—å£å«ä½œâ€œä¸»çª—å£â€ï¼Œè€Œå…¶ä¸­å†…åµŒçš„ iframe å«ä½œâ€œå­çª—å£â€ã€‚ç”±äº iframe å¤©ç„¶çš„ç‰¹æ€§ï¼Œæ¯ä¸ªå­çª—å£éƒ½æœ‰è‡ªå·±çš„ `window` å¯¹è±¡ï¼Œç›¸äº’ä¹‹é—´éš”ç¦»ï¼Œä¸ä¼šå¯¹ä¸»çª—å£è¿›è¡Œæ±¡æŸ“ï¼Œä¹Ÿä¸ä¼šç›¸äº’æ±¡æŸ“ã€‚\r\n\r\nä¸‹é¢ä»ç„¶ä»¥åŠ è½½ divide.js æ¨¡å—ä¸ºä¾‹ã€‚é¦–å…ˆæˆ‘ä»¬æ„é€ ä¸€ä¸ª iframe ç”¨äºåŠ è½½è„šæœ¬ï¼š\r\n\r\n```JavaScript\r\nvar iframe = document.createElement(\"iframe\");\r\niframe.style = \"display:none !important\";\r\ndocument.body.appendChild(iframe);\r\nvar doc = iframe.contentWindow.document;\r\nvar htmlStr = `\r\n    <html><head><title></title></head><body>\r\n    <script src=\"./divide.js\"></script></body></html>\r\n`;\r\ndoc.open();\r\ndoc.write(htmlStr);\r\ndoc.close();\r\n```\r\n\r\nè¿™æ ·å°±å¯ä»¥åœ¨â€œéš”ç¦»çš„ä½œç”¨åŸŸâ€ä¸­åŠ è½½æ¨¡å—è„šæœ¬äº†ã€‚ä½†æ˜¾ç„¶å®ƒè¿˜æ— æ³•æ­£å¸¸å·¥ä½œï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥æˆ‘ä»¬å°±è¦è¡¥å…¨å®ƒçš„æ¨¡å—å¯¼å…¥ä¸å¯¼å‡ºåŠŸèƒ½ã€‚æ¨¡å—å¯¼å‡ºè¦è§£å†³çš„é—®é¢˜å°±æ˜¯è®©ä¸»çª—å£èƒ½å¤Ÿè®¿é—®å­çª—å£ä¸­çš„æ¨¡å—å¯¹è±¡ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨å­çª—å£çš„è„šæœ¬åŠ è½½è¿è¡Œå®Œåï¼Œå°†å…¶æŒ‚è½½åˆ°ä¸»çª—å£çš„å˜é‡ä¸Šã€‚\r\n\r\nä¿®æ”¹ä»¥ä¸Šä»£ç ï¼š\r\n\r\n```JavaScript\r\n// â€¦â€¦çœç•¥é‡å¤ä»£ç \r\nvar htmlStr = `\r\n    <html><head><title></title></head><body>\r\n    <scrip>\r\n        window.require = parent.window.require;\r\n        window.exports = window.module.exports = undefined;\r\n    </script>\r\n    <script src=\"./divide.js\"></script>\r\n    <scrip>\r\n        if (window.module.exports !== undefined) {\r\n            parent.window.modObj['./divide.js'] = window.module.exports;\r\n        }\r\n    </script>\r\n    </body></html>\r\n`;\r\n// â€¦â€¦çœç•¥é‡å¤ä»£ç \r\n```\r\n\r\næ ¸å¿ƒå°±æ˜¯é€šè¿‡åƒ `parent.window` è¿™æ ·çš„æ–¹å¼å®ç°ä¸»çª—å£ä¸å­çª—å£ä¹‹é—´çš„â€œç©¿é€â€ï¼š\r\n\r\n- å°†å­çª—å£çš„å¯¹è±¡æŒ‚è½½åˆ°ä¸»çª—å£ä¸Šï¼›\r\n- åŒæ—¶æ”¯æŒå­çª—å£è°ƒç”¨ä¸»çª—å£ä¸­æ–¹æ³•çš„ä½œç”¨ã€‚\r\n\r\nä¸Šé¢åªæ˜¯ä¸€ä¸ªåŸç†æ€§çš„ç²—ç•¥å®ç°ï¼Œå¦‚æœå¯¹æ›´ä¸¥è°¨çš„å®ç°ç»†èŠ‚æ„Ÿå…´è¶£å¯ä»¥çœ‹æºç ä¸­çš„ [loadModuleForModuleData æ–¹æ³•](https://github.com/jordwalke/one-click.js/blob/8db5f181fe7dafa050d5789741fbe4b2c87ba779/one-click.js#L203-L281)ã€‚\r\n\r\nå€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨ã€Œ3.1. ä¾èµ–åˆ†æã€ä¸­æåˆ°å…ˆåŠ è½½ä¸€éæ‰€æœ‰æ¨¡å—æ¥è·å–ä¾èµ–å…³ç³»ï¼Œè€Œè¿™éƒ¨åˆ†çš„åŠ è½½ä¹Ÿæ˜¯æ”¾åœ¨ iframe ä¸­è¿›è¡Œçš„ï¼Œä¹Ÿéœ€è¦é˜²æ­¢â€œæ±¡æŸ“â€ã€‚\r\n\r\n### 3.3. æä¾›æ¨¡å—è¿è¡Œæ—¶\r\n\r\næ¨¡å—çš„è¿è¡Œæ—¶ä¸€ç‰ˆåŒ…æ‹¬äº†æ„é€ æ¨¡å—å¯¹è±¡ï¼ˆmodule objectï¼‰ã€å­˜å‚¨æ¨¡å—å¯¹è±¡ä»¥åŠæä¾›ä¸€ä¸ªæ¨¡å—å¯¼å…¥æ–¹æ³•ï¼ˆ`require`ï¼‰ã€‚æ¨¡å—è¿è¡Œæ—¶çš„å„ç±»å®ç°ä¸€èˆ¬éƒ½å¤§åŒå°å¼‚ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„å°±æ˜¯ï¼Œå¦‚æœéš”ç¦»çš„æ–¹æ³•ä½¿ç”¨ iframeï¼Œé‚£ä¹ˆéœ€è¦åœ¨ä¸»çª—å£ä¸å­çª—å£ä¸­ä¼ é€’ä¸€äº›è¿è¡Œæ—¶æ–¹æ³•å’Œå¯¹è±¡ã€‚\r\n\r\nå½“ç„¶ï¼Œç»†èŠ‚ä¸Šè¿˜å¯èƒ½ä¼šéœ€è¦æ”¯æŒæ¨¡å—è·¯å¾„è§£æï¼ˆresolveï¼‰ã€å¾ªç¯ä¾èµ–çš„å¤„ç†ã€é”™è¯¯å¤„ç†ç­‰ã€‚ç”±äºè¿™éƒ¨åˆ†çš„å®ç°å’Œå¾ˆå¤šåº“ç±»ä¼¼ï¼Œåˆæˆ–è€…ä¸ç®—ç‰¹åˆ«æ ¸å¿ƒï¼Œåœ¨è¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚\r\n\r\n## 4. æ€»ç»“\r\n\r\næœ€åå½’çº³ä¸€ä¸‹å¤§è‡´çš„è¿è¡Œæµç¨‹ï¼š\r\n\r\n1. é¦–å…ˆä»é¡µé¢ä¸­æ‹¿åˆ°å…¥å£æ¨¡å—ï¼Œåœ¨ one-click.js ä¸­å°±æ˜¯ `document.querySelector(\"script[data-main]\").dataset.main`ï¼›\r\n2. åœ¨ iframe ä¸­â€œé¡ºè—¤æ‘¸ç“œâ€åŠ è½½æ¨¡å—ï¼Œå¹¶åœ¨ `require` æ–¹æ³•ä¸­æ”¶é›†æ¨¡å—ä¾èµ–ï¼Œç›´åˆ°æ²¡æœ‰æ–°çš„ä¾èµ–å‡ºç°ï¼›\r\n3. æ”¶é›†å®Œæ¯•ï¼Œæ­¤æ—¶å°±æ‹¿åˆ°äº†å®Œæ•´çš„ä¾èµ–å›¾ï¼›\r\n4. æ ¹æ®ä¾èµ–å›¾ï¼Œâ€œé€†å‘â€åŠ è½½ç›¸åº”æ¨¡å—æ–‡ä»¶ï¼Œä½¿ç”¨ iframe éš”ç¦»ä½œç”¨åŸŸï¼ŒåŒæ—¶æ³¨æ„å°†ä¸»çª—å£ä¸­çš„æ¨¡å—è¿è¡Œæ—¶ä¼ ç»™å„ä¸ªå­çª—å£ï¼›\r\n5. æœ€åï¼Œå½“åŠ è½½åˆ°å…¥å£è„šæœ¬æ—¶ï¼Œæ‰€æœ‰ä¾èµ–å‡†å¤‡å°±ç»ªï¼Œç›´æ¥æ‰§è¡Œå³å¯ã€‚\r\n\r\næ€»çš„æ¥è¯´ï¼Œç”±äºæ²¡æœ‰äº†æ„å»ºå·¥å…·ä¸æœåŠ¡å™¨çš„å¸®åŠ©ï¼Œæ‰€ä»¥è¦å®ç°ä¾èµ–åˆ†æä¸ä½œç”¨åŸŸéš”ç¦»å°±æˆäº†å›°éš¾ã€‚è€Œ one-click.js è¿ç”¨ä¸Šé¢æåˆ°çš„æŠ€æœ¯æ‰‹æ®µè§£å†³äº†è¿™äº›é—®é¢˜ã€‚\r\n\r\né‚£ä¹ˆï¼Œone-click.js å¯ä»¥ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¹ˆï¼Ÿæ˜¾ç„¶æ˜¯[ä¸è¡Œçš„](https://github.com/jordwalke/one-click.js#not-using)ã€‚\r\n\r\n> Do not use this in production. The only purpose of this utility is to make local development simpler.\r\n\r\n**æ‰€ä»¥æ³¨æ„äº†**ï¼Œä½œè€…ä¹Ÿè¯´äº†ï¼Œè¿™ä¸ªåº“çš„ç›®çš„ä»…ä»…æ˜¯æ–¹ä¾¿æœ¬åœ°å¼€å‘ã€‚å½“ç„¶ï¼Œå…¶ä¸­ä¸€äº›æŠ€æœ¯æ‰‹æ®µä½œä¸ºå­¦ä¹ èµ„æ–™ï¼Œå’±ä»¬ä¹Ÿæ˜¯å¯ä»¥äº†è§£å­¦ä¹ ä¸€ä¸‹çš„ã€‚æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è®¿é—® [one-click.js ä»“åº“](https://github.com/jordwalke/one-click.js)è¿›ä¸€æ­¥äº†è§£ã€‚\r\n\r\n---\r\n\r\nå¥½äº†ï¼Œè¿™æœŸçš„ã€Œæ¼«æ¸¸ Githubã€å°±åˆ°è¿™é‡Œäº†ã€‚æœ¬ç³»åˆ—ä¼šä¸å®šæœŸå’Œå¤§å®¶ä¸€èµ·çœ‹ä¸€çœ‹ã€èŠä¸€èŠã€å­¦ä¸€å­¦ github ä¸Šæœ‰è¶£çš„é¡¹ç›®ï¼Œä¸ä»…å­¦ä¹ ä¸€äº›æŠ€æœ¯ç‚¹ï¼Œè¿˜å¯ä»¥äº†è§£ä½œè€…çš„æŠ€æœ¯æ€è€ƒï¼Œæ¬¢è¿æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å…³æ³¨ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/71757685-7807ac00-2ed2-11ea-97e7-c93eec7b6017.png)\r\n\r\n---\r\n\r\n## å¾€æœŸå†…å®¹\r\n\r\n- [ã€æ¼«æ¸¸Githubã€‘quicklink çš„å®ç°åŸç†ä¸ç»™å‰ç«¯çš„å¯å‘](https://juejin.im/post/5c21f8435188256d12597789)\r\n- [ã€æ¼«æ¸¸Githubã€‘å¦‚ä½•æå‡JSON.stringify()çš„æ€§èƒ½ï¼Ÿ](https://juejin.im/post/5cf61ed3e51d4555fd20a2f3)\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/32","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/32/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/32/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/32/events","html_url":"https://github.com/alienzhou/blog/issues/32","id":481087731,"node_id":"MDU6SXNzdWU0ODEwODc3MzE=","number":32,"title":" ã€æ€§èƒ½ä¼˜åŒ–æŒ‡å—ã€‘å¸¦ä½ å…¨é¢æŒæ¡å‰ç«¯æ€§èƒ½ä¼˜åŒ– ğŸš€ ","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1392194871,"node_id":"MDU6TGFiZWwxMzkyMTk0ODcx","url":"https://api.github.com/repos/alienzhou/blog/labels/Performance","name":"Performance","color":"65ed99","default":false,"description":""},{"id":1159845015,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E6%B5%8F%E8%A7%88%E5%99%A8","name":"æµè§ˆå™¨","color":"cfd3d7","default":false,"description":""},{"id":1298890220,"node_id":"MDU6TGFiZWwxMjk4ODkwMjIw","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%89%B9%E6%80%A7","name":"ç‰¹æ€§","color":"c2e0c6","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-08-15T10:19:26Z","updated_at":"2020-03-28T08:48:28Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"âœ¨ä»“åº“åœ°å€ï¼š[fe-performance-journey](https://github.com/alienzhou/fe-performance-journey) âœ¨\r\n\r\n![](https://alienzhou.github.io/fe-performance-journey/assets/img/intro.4a36214c.jpg)\r\n\r\n## å‰ç«¯éœ€è¦æ€§èƒ½ä¼˜åŒ–ä¹ˆï¼Ÿ\r\n\r\næ€§èƒ½ä¼˜åŒ–ä¸€ç›´ä»¥æ¥éƒ½æ˜¯å‰ç«¯å·¥ç¨‹é¢†åŸŸä¸­çš„ä¸€ä¸ªé‡è¦éƒ¨åˆ†ã€‚å¾ˆå¤šèµ„æ–™<sup>[1]</sup><sup>[2]</sup><sup>[3]</sup>è¡¨æ˜ï¼Œç½‘ç«™åº”ç”¨çš„æ€§èƒ½ä¼˜åŒ–å¯¹äºæé«˜ç”¨æˆ·ç•™å­˜ã€è½¬åŒ–ç‡ç­‰éƒ½æœ‰ç§¯æå½±å“ã€‚å¯ä»¥ç†è§£ä¸ºï¼Œæå‡ä½ çš„ç½‘ç«™æ€§èƒ½ï¼Œå°±æ˜¯æå‡ä½ çš„ä¸šåŠ¡æ•°æ®ï¼ˆç”šè‡³æ˜¯ä¸šåŠ¡æ”¶å…¥ï¼‰ã€‚\r\n\r\næ€§èƒ½ä¼˜åŒ–å¹¿ä¹‰ä¸ŠåŒ…å«å‰ç«¯ä¼˜åŒ–å’Œåç«¯ä¼˜åŒ–ã€‚åç«¯ä¼˜åŒ–çš„å…³æ³¨ç‚¹æ›´å¤šçš„æ—¶å€™æ˜¯åœ¨å¢åŠ èµ„æºåˆ©ç”¨ç‡ã€é™ä½èµ„æºæˆæœ¬ä»¥åŠæé«˜ç¨³å®šæ€§ä¸Šã€‚ç›¸è¾ƒäºåç«¯ï¼Œå‰ç«¯çš„æ€§èƒ½ä¼˜åŒ–ä¼šæ›´ç›´æ¥ä¸ç”¨æˆ·çš„ä½“éªŒæŒ‚é’©ã€‚ä»ç”¨æˆ·ä½“éªŒä¾§æ¥è¯´ï¼Œå‰ç«¯æœåŠ¡ 5s çš„åŠ è½½æ—¶é—´ä¼˜åŒ–ç¼©å‡ 80%(1s) ä¸åç«¯æœåŠ¡ 50ms çš„å“åº”ä¼˜åŒ–ç¼©å‡ 80%(10ms) ç›¸æ¯”ï¼Œç”¨æˆ·çš„ä½“éªŒæå‡ä¼šæ›´å¤§ã€‚å› æ­¤å¾ˆå¤šæ—¶å€™ï¼Œä¸ä½“éªŒç›¸å…³çš„æ€§èƒ½çš„ç“¶é¢ˆä¼šå‡ºç°åœ¨å‰ç«¯ã€‚\r\n\r\n![](https://alienzhou.github.io/fe-performance-journey/assets/img/waterfall.cbaa0ead.jpg)\r\n\r\n## å¦‚ä½•å­¦ä¹ å‰ç«¯æ€§èƒ½ä¼˜åŒ–ï¼Ÿ\r\n\r\nä½œä¸ºå‰ç«¯å·¥ç¨‹å¸ˆï¼Œå¤§å®¶å…¶å®éƒ½å…·å¤‡ä¸€å®šçš„æ€§èƒ½ä¼˜åŒ–æ„è¯†ï¼ŒåŒæ—¶ä¹Ÿæœ‰è‡ªå·±çš„ä¼˜åŒ–â€œæ­¦å™¨åº“â€ï¼Œä¾‹å¦‚æ‡’åŠ è½½ã€èµ„æºåˆå¹¶ã€é¿å… reflow ç­‰ç­‰ã€‚è™½ç„¶å¤§å®¶å¯¹æ€§èƒ½ä¼˜åŒ–éƒ½æœ‰è‡ªå·±çš„æ€è·¯ï¼Œä¸è¿‡å¤§å¤šæ˜¯åˆ†æ•£åœ¨æŸå‡ ä¸ªç‚¹ï¼Œè¾ƒéš¾å½¢æˆä¸€ä¸ªå®Œæ•´çš„ä½“ç³»ã€‚ä¸šç•Œä¹Ÿæœ‰å¾ˆå¤šä¼˜è´¨çš„èµ„æ–™ï¼Œä¾‹å¦‚[é›…è™çš„æ€§èƒ½ä¼˜åŒ– 35 æ¡](https://github.com/creeperyang/blog/issues/1)<sup>[4]</sup>ï¼Œä½†æ˜¯ **æ€§èƒ½ä¼˜åŒ–ä½œä¸ºä¸€ä¸ªç³»ç»Ÿæ€§å·¥ç¨‹**ï¼Œå¤§å®¶æƒ³è¦ç³»ç»Ÿæ€§åœ°å»å­¦ä¹ å¹¶ä¸å®¹æ˜“ã€‚\r\n\r\nä»ç”¨æˆ·å¼€å§‹è®¿é—®ä½ çš„ç½‘ç«™åº”ç”¨ï¼Œåˆ°æœ€ç»ˆå®ƒåœ¨ä¸Šé¢æµè§ˆä¿¡æ¯ã€æ“ä½œäº¤äº’ï¼Œå…¶é—´ç»å†äº†éå¸¸å¤šçš„ç¯èŠ‚ï¼Œæ¯ä¸ªç¯èŠ‚éƒ½æœ‰å¯èƒ½å‡ºç°æ€§èƒ½é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æˆ‘ä»¬å®ç°æ€§èƒ½æå‡æœºä¼šã€‚æ‰€ä»¥ï¼Œå‰ç«¯æ€§èƒ½ä¼˜åŒ–ä¼šè¦æ±‚ä½ ä»æ•´ä½“ç»´åº¦æ¥åˆ†æç³»ç»Ÿï¼Œç”šè‡³æ˜¯ä¸šåŠ¡ã€‚\r\n\r\né‚£ä¹ˆå¦‚ä½•èƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°æ¢³ç†ä¸ç†è§£æ€§èƒ½ä¼˜åŒ–å‘¢ï¼Ÿå›æƒ³åˆ°æ¯æ¯é¢è¯•éƒ½ä¼šè¢«é—®åˆ°ï¼šâ€œä»åœ°å€æ è¾“å…¥XXXåˆ°è®¿é—®ä¹‹é—´ç»å†äº†ä»€ä¹ˆï¼Ÿâ€å…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥ä»è¿™ä¸ªè§†è§’æ¥çœ‹å¾…æ€§èƒ½ä¼˜åŒ–ã€‚\r\n\r\nä»è®¿é—®å¼€å§‹ï¼Œç”¨æˆ·å¯èƒ½ä¼šç»å†ç±»ä¼¼ã€ŒæŸ¥è¯¢ç¼“å­˜ -> å‘é€è¯·æ±‚ -> ç­‰å¾…å“åº” -> é¡µé¢è§£æ -> ä¸‹è½½å¹¶å¤„ç†å„ç±»é™æ€èµ„æº -> è¿è¡Œæ—¶ -> é¢„åŠ è½½ï¼ˆç­‰å¾…åç»­çš„è¯·æ±‚ï¼‰ã€è¿™æ ·ä¸€ä¸ªä¸æ–­å¾€å¤çš„â€œæ—…ç¨‹â€ â€”â€” ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ã€Œæ€§èƒ½ä¼˜åŒ–ä¹‹æ—…ã€ã€‚Web åº”ç”¨åœ¨å…¶ä¸­æ¯ä¸€ç«™éƒ½å¯èƒ½é‡åˆ°æ€§èƒ½é—®é¢˜ï¼Œå½“ç„¶ä¹Ÿä¼šæœ‰å¯¹åº”çš„ä¼˜åŒ–æ‰‹æ®µã€‚\r\n\r\næ‰€ä»¥åœ¨è¿™æ¬¡çš„ã€Œæ€§èƒ½ä¼˜åŒ–ä¹‹æ—…ã€ä¼šæ²¿ç€è¿™æ¡è·¯å¾„å…·ä½“ä»‹ç»æ¯ä¸ªç¯èŠ‚ä¸­å¸¸è§çš„æ€§èƒ½é—®é¢˜ä»¥åŠä¼˜åŒ–æŠ€æœ¯ã€‚é€šè¿‡ä¸ Web åº”ç”¨çš„è®¿é—®æµç¨‹ç›¸ç»“åˆï¼Œå¸®åŠ©å¤§å®¶å…¨é¢ç†è§£ä¸æŒæ¡å‰ç«¯çš„æ€§èƒ½ä¼˜åŒ–ã€‚\r\n\r\nä¸‹é¢æ˜¯æ•´ä½“çš„å¤§çº²ï¼š\r\n\r\n![](https://alienzhou.github.io/fe-performance-journey/assets/img/overall.dcdd4140.svg)\r\n\r\nå¦‚æœå‡†å¤‡å¥½äº†ï¼Œå’±ä»¬å°±å¯ä»¥å‡ºå‘äº† â€”â€”\r\n\r\n## æ—…é€”çš„è¡Œç¨‹è·¯çº¿ğŸ‘‡\r\n\r\nç›®å‰å†…å®¹å·²å…¨éƒ¨æ›´æ–°è‡³ âœ¨ [fe-performance-journey](https://github.com/alienzhou/fe-performance-journey) âœ¨ ä»“åº“ä¸­ï¼Œé™†ç»­ä¼šå°†å†…å®¹åŒæ­¥ã€‚å¦‚æœå¸Œæœ›å°½å¿«é˜…è¯»ç›¸å…³å†…å®¹ï¼Œå¯ä»¥ç›´æ¥å»è¯¥ä»“åº“ä¸­æµè§ˆæ–‡ç« ã€‚å–œæ¬¢çš„æœ‹å‹å¯ä»¥å»ä»“åº“ star ä¸€ä¸‹ã€‚\r\n\r\n- ç¬¬ä¸€ç«™ - ç¼“å­˜\r\n- ç¬¬äºŒç«™ - å‘é€è¯·æ±‚\r\n- ç¬¬ä¸‰ç«™ - æœåŠ¡ç«¯å¤„ç†\r\n- ç¬¬å››ç«™ - ä¸‹è½½ä¸è§£æé¡µé¢\r\n- ç¬¬äº”ç«™ - é¡µé¢é™æ€èµ„æº\r\n  - JavaScript\r\n  - CSS\r\n  - å›¾ç‰‡\r\n  - å­—ä½“\r\n  - è§†é¢‘\r\n- ç¬¬å…­ç«™ - è¿è¡Œæ—¶\r\n- ç¬¬ä¸ƒç«™ - é¢„åŠ è½½\r\n- å°¾å£°\r\n- TODO:\r\n  - æ€§èƒ½æŒ‡æ ‡\r\n  - æ€§èƒ½ç›‘æ§\r\n\r\n---\r\n\r\n## å‚è€ƒèµ„æ–™\r\n\r\n1. [Driving user growth with performance improvements](https://medium.com/@Pinterest_Engineering/driving-user-growth-with-performance-improvements-cfc50dafadd7)\r\n1. [How Fast Should A Website Load in 2019?](https://www.hobo-web.co.uk/your-website-design-should-load-in-4-seconds/)\r\n1. [How long will you wait for a shopping website to load?](https://www.bbc.com/news/business-37100091)\r\n1. [Best Practices for Speeding Up Your Web Site (Yahoo)](https://github.com/creeperyang/blog/issues/1)\r\n1. [17 Things People Absolutely Hate About Your Website](https://blog.hubspot.com/blog/tabid/6307/bid/32307/15-things-people-absolutely-hate-about-your-website.aspx)\r\n1. [Why Performance Matters](https://developers.google.com/web/fundamentals/performance/why-performance-matters/)","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/31","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/31/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/31/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/31/events","html_url":"https://github.com/alienzhou/blog/issues/31","id":452470481,"node_id":"MDU6SXNzdWU0NTI0NzA0ODE=","number":31,"title":"ã€æ¼«æ¸¸Githubã€‘å¦‚ä½•æå‡JSON.stringify()çš„æ€§èƒ½ï¼Ÿ","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845014,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE0","url":"https://api.github.com/repos/alienzhou/blog/labels/JavaScript","name":"JavaScript","color":"d73a4a","default":false,"description":""},{"id":1392194871,"node_id":"MDU6TGFiZWwxMzkyMTk0ODcx","url":"https://api.github.com/repos/alienzhou/blog/labels/Performance","name":"Performance","color":"65ed99","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-06-05T12:20:32Z","updated_at":"2020-01-04T01:16:28Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## 1. ç†Ÿæ‚‰çš„`JSON.stringify()`\r\n\r\nåœ¨æµè§ˆå™¨ç«¯æˆ–æœåŠ¡ç«¯ï¼Œ`JSON.stringify()`éƒ½æ˜¯æˆ‘ä»¬å¾ˆå¸¸ç”¨çš„æ–¹æ³•ï¼š\r\n\r\n- å°† JSON object å­˜å‚¨åˆ° localStorage ä¸­ï¼›\r\n- POST è¯·æ±‚ä¸­çš„ JSON bodyï¼›\r\n- å¤„ç†å“åº”ä½“ä¸­çš„ JSON å½¢å¼çš„æ•°æ®ï¼›\r\n- ç”šè‡³æŸäº›æ¡ä»¶ä¸‹ï¼Œæˆ‘ä»¬è¿˜ä¼šç”¨å®ƒæ¥å®ç°ä¸€ä¸ªç®€å•çš„æ·±æ‹·è´ï¼›\r\n- â€¦â€¦\r\n\r\nåœ¨ä¸€äº›æ€§èƒ½æ•æ„Ÿçš„åœºåˆä¸‹ï¼ˆä¾‹å¦‚æœåŠ¡ç«¯å¤„ç†å¤§é‡å¹¶å‘ï¼‰ï¼Œæˆ–é¢å¯¹å¤§é‡ stringify çš„æ“ä½œæ—¶ï¼Œæˆ‘ä»¬ä¼šå¸Œæœ›å®ƒçš„æ€§èƒ½æ›´å¥½ï¼Œé€Ÿåº¦æ›´å¿«ã€‚è¿™ä¹Ÿå‚¬ç”Ÿäº†ä¸€äº›ä¼˜åŒ–çš„ stringify æ–¹æ¡ˆ/åº“ï¼Œä¸‹å›¾æ˜¯å®ƒä»¬ä¸åŸç”Ÿæ–¹æ³•çš„æ€§èƒ½å¯¹æ¯”ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/6/5/16b25784d49d825a?w=1200&h=488&f=png&s=42368)\r\n\r\nç»¿è‰²éƒ¨åˆ†æ—¶åŸç”Ÿ`JSON.stringify()`ï¼Œå¯è§æ€§èƒ½ç›¸è¾ƒè¿™äº›åº“éƒ½è¦ä½å¾ˆå¤šã€‚é‚£ä¹ˆï¼Œåœ¨å¤§å¹…çš„æ€§èƒ½æå‡èƒŒåçš„æŠ€æœ¯åŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\r\n\r\n## 2. æ¯” `stringify` æ›´å¿«çš„ `stringify`\r\n\r\nç”±äº JavaScript æ˜¯åŠ¨æ€æ€§å¾ˆå¼ºçš„è¯­è¨€ï¼Œæ‰€ä»¥å¯¹äºä¸€ä¸ª Object ç±»å‹çš„å˜é‡ï¼Œå…¶åŒ…å«çš„é”®åã€é”®å€¼ã€é”®å€¼ç±»å‹æœ€ç»ˆåªèƒ½åœ¨è¿è¡Œæ—¶ç¡®å®šã€‚å› æ­¤ï¼Œæ‰§è¡Œ`JSON.stringify()`æ—¶ä¼šæœ‰å¾ˆå¤šå·¥ä½œè¦åšã€‚åœ¨ä¸€æ— æ‰€çŸ¥çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æƒ³è¦å¤§å¹…ä¼˜åŒ–æ˜¾ç„¶æ— èƒ½ä¸ºåŠ›ã€‚\r\n\r\né‚£ä¹ˆå¦‚æœæˆ‘ä»¬çŸ¥é“è¿™ä¸ª Object ä¸­çš„é”®åã€é”®å€¼ä¿¡æ¯å‘¢ â€”â€” ä¹Ÿå°±æ˜¯çŸ¥é“å®ƒçš„ç»“æ„ä¿¡æ¯ï¼Œè¿™ä¼šæœ‰å¸®åŠ©ä¹ˆï¼Ÿ\r\n\r\nçœ‹ä¸ªä¾‹å­ï¼š\r\n\r\nä¸‹é¢è¿™ä¸ª Objectï¼Œ\r\n\r\n```JavaScript\r\nconst obj = {\r\n    name: 'alienzhou',\r\n    status: 6,\r\n    working: true\r\n};\r\n```\r\n\r\næˆ‘ä»¬å¯¹å®ƒåº”ç”¨`JSON.stringify()`ï¼Œå¾—åˆ°ç»“æœä¸º\r\n\r\n```JavaScript\r\nJSON.stringify(obj);\r\n// {\"name\":\"alienzhou\",\"status\":6,\"working\":true}\r\n```\r\n\r\nç°åœ¨å¦‚æœæˆ‘ä»¬çŸ¥é“è¿™ä¸ª`obj`çš„ç»“æ„æ˜¯å›ºå®šçš„ï¼š\r\n\r\n- é”®åä¸å˜\r\n- é”®å€¼çš„ç±»å‹ä¸€å®š\r\n\r\né‚£ä¹ˆå…¶å®ï¼Œæˆ‘å¯ä»¥åˆ›å»ºä¸€ä¸ªâ€œå®šåˆ¶åŒ–â€çš„ stringify æ–¹æ³•\r\n\r\n```JavaScript\r\nfunction myStringify(o) {\r\n    return (\r\n        '{\"name\":\"'\r\n        + o.name\r\n        + '\",\"status\":'\r\n        + o.status\r\n        + ',\"isWorking\":'\r\n        + o.working\r\n        + '}'\r\n    );\r\n}\r\n```\r\n\r\nçœ‹çœ‹æˆ‘ä»¬çš„`myStringify`æ–¹æ³•çš„è¾“å‡ºï¼š\r\n\r\n```JavaScript\r\nmyStringify({\r\n    name: 'alienzhou',\r\n    status: 6,\r\n    working: true\r\n});\r\n// {\"name\":\"alienzhou\",\"status\":6,\"isWorking\":true}\r\n\r\nmyStringify({\r\n    name: 'mengshou',\r\n    status: 3,\r\n    working: false\r\n});\r\n// {\"name\":\"mengshou\",\"status\":3,\"isWorking\":false}\r\n```\r\n\r\nå¯ä»¥å¾—åˆ°æ­£ç¡®çš„ç»“æœï¼Œä½†åªç”¨åˆ°äº†ç±»å‹è½¬æ¢å’Œå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œæ‰€ä»¥â€œå®šåˆ¶åŒ–â€æ–¹æ³•å¯ä»¥è®©â€œstringifyâ€æ›´å¿«ã€‚\r\n\r\næ€»ç»“æ¥çœ‹ï¼Œå¦‚ä½•å¾—åˆ°æ¯” `stringify` æ›´å¿«çš„ `stringify` æ–¹æ³•å‘¢ï¼Ÿ\r\n\r\n1. éœ€è¦å…ˆç¡®å®šå¯¹è±¡çš„ç»“æ„ä¿¡æ¯ï¼›\r\n2. æ ¹æ®å…¶ç»“æ„ä¿¡æ¯ï¼Œä¸ºè¯¥ç§ç»“æ„çš„å¯¹è±¡åˆ›å»ºâ€œå®šåˆ¶åŒ–â€çš„`stringify`æ–¹æ³•ï¼Œå…¶å†…éƒ¨å®é™…æ˜¯é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥ç”Ÿæˆç»“æœçš„ï¼›\r\n3. æœ€åï¼Œä½¿ç”¨è¯¥â€œå®šåˆ¶åŒ–â€çš„æ–¹æ³•æ¥ stringify å¯¹è±¡å³å¯ã€‚\r\n\r\nè¿™ä¹Ÿæ˜¯å¤§å¤šæ•° stringify åŠ é€Ÿåº“çš„å¥—è·¯ï¼Œè½¬åŒ–ä¸ºä»£ç å°±æ˜¯ç±»ä¼¼ï¼š\r\n\r\n```JavaScript\r\nimport faster from 'some_library_faster_stringify';\r\n\r\n// 1. é€šè¿‡ç›¸åº”è§„åˆ™ï¼Œå®šä¹‰ä½ çš„å¯¹è±¡ç»“æ„\r\nconst theObjectScheme = {\r\n    // â€¦â€¦\r\n};\r\n\r\n// 2. æ ¹æ®ç»“æ„ï¼Œå¾—åˆ°ä¸€ä¸ªå®šåˆ¶åŒ–çš„æ–¹æ³•\r\nconst stringify = faster(theObjectScheme);\r\n\r\n// 3. è°ƒç”¨æ–¹æ³•ï¼Œå¿«é€Ÿ stringify\r\nconst target = {\r\n    // â€¦â€¦\r\n};\r\nstringify(target);\r\n```\r\n\r\n## 3. å¦‚ä½•ç”Ÿæˆâ€œå®šåˆ¶åŒ–â€çš„æ–¹æ³•\r\n\r\næ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œæ ¸å¿ƒåŠŸèƒ½åœ¨äºï¼Œ**æ ¹æ®å…¶ç»“æ„ä¿¡æ¯ï¼Œä¸ºè¯¥ç±»å¯¹è±¡åˆ›å»ºâ€œå®šåˆ¶åŒ–â€çš„stringifyæ–¹æ³•ï¼Œå…¶å†…éƒ¨å®é™…æ˜¯ç®€å•çš„å±æ€§è®¿é—®ä¸å­—ç¬¦ä¸²æ‹¼æ¥ã€‚**\r\n\r\nä¸ºäº†äº†è§£å…·ä½“çš„å®ç°æ–¹å¼ï¼Œä¸‹é¢æˆ‘ä»¥ä¸¤ä¸ªå®ç°ä¸Šç•¥æœ‰å·®å¼‚çš„å¼€æºåº“ä¸ºä¾‹æ¥ç®€å•ä»‹ç»ä¸€ä¸‹ã€‚\r\n\r\n### 3.1. fast-json-stringify\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/6/4/16b21d1399c2e90b?w=2004&h=96&f=png&s=73286)\r\n\r\nä¸‹å›¾æ˜¯æ ¹æ® [fast-json-stringify](https://github.com/fastify/fast-json-stringify#benchmarks) æä¾›çš„ benchmark ç»“æœï¼Œæ•´ç†å‡ºæ¥çš„æ€§èƒ½å¯¹æ¯”ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/6/4/16b21db215453a98?w=872&h=434&f=png&s=33293)\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œåœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹å…·å¤‡2-5å€çš„æ€§èƒ½æå‡ã€‚\r\n\r\n#### 3.1.1. scheme çš„å®šä¹‰æ–¹å¼\r\n\r\nfast-json-stringify ä½¿ç”¨äº† [JSON Schema Validation ](http://json-schema.org/latest/json-schema-validation.html) æ¥å®šä¹‰ï¼ˆJSONï¼‰å¯¹è±¡çš„æ•°æ®æ ¼å¼ã€‚å…¶ scheme å®šä¹‰çš„ç»“æ„æœ¬èº«ä¹Ÿæ˜¯ JSON æ ¼å¼çš„ï¼Œä¾‹å¦‚å¯¹è±¡\r\n\r\n```JavaScript\r\n{\r\n    name: 'alienzhou',\r\n    status: 6,\r\n    working: true\r\n}\r\n```\r\n\r\nå¯¹åº”çš„ scheme å°±æ˜¯ï¼š\r\n\r\n```JavaScript\r\n{\r\n    title: 'Example Schema',\r\n    type: 'object',\r\n    properties: {\r\n        name: {\r\n            type: 'string'\r\n        },\r\n        status: {\r\n            type: 'integer'\r\n        },\r\n        working: {\r\n            type: 'boolean'\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nå…¶ scheme å®šä¹‰è§„åˆ™ä¸°å¯Œï¼Œå…·ä½“ä½¿ç”¨å¯ä»¥å‚è€ƒ [Ajv](https://ajv.js.org/) è¿™ä¸ª JSON æ ¡éªŒåº“ã€‚\r\n\r\n#### 3.1.2. stringify æ–¹æ³•çš„ç”Ÿæˆ\r\n\r\nfast-json-stringify ä¼šæ ¹æ®åˆšæ‰å®šä¹‰çš„ schemeï¼Œæ‹¼æ¥ç”Ÿæˆå‡ºå®é™…çš„å‡½æ•°ä»£ç å­—ç¬¦ä¸²ï¼Œç„¶åä½¿ç”¨ [Function æ„é€ å‡½æ•°](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function)åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆå¯¹åº”çš„ stringify å‡½æ•°ã€‚\r\n\r\nåœ¨ä»£ç ç”Ÿæˆä¸Šï¼Œé¦–å…ˆå®ƒä¼šæ³¨å…¥é¢„å…ˆå®šä¹‰å¥½çš„å„ç±»å·¥å…·æ–¹æ³•ï¼Œè¿™ä¸€éƒ¨åˆ†ä¸åŒçš„ scheme éƒ½æ˜¯ä¸€æ ·çš„ï¼š\r\n\r\n```JavaScript\r\nvar code = `\r\n    'use strict'\r\n  `\r\n\r\n  code += `\r\n    ${$asString.toString()}\r\n    ${$asStringNullable.toString()}\r\n    ${$asStringSmall.toString()}\r\n    ${$asNumber.toString()}\r\n    ${$asNumberNullable.toString()}\r\n    ${$asIntegerNullable.toString()}\r\n    ${$asNull.toString()}\r\n    ${$asBoolean.toString()}\r\n    ${$asBooleanNullable.toString()}\r\n  `\r\n```\r\n\r\nå…¶æ¬¡ï¼Œå°±ä¼šæ ¹æ® scheme å®šä¹‰çš„å…·ä½“å†…å®¹ç”Ÿæˆ stringify å‡½æ•°çš„å…·ä½“ä»£ç ã€‚è€Œç”Ÿæˆçš„æ–¹å¼ä¹Ÿæ¯”è¾ƒç®€å•ï¼šé€šè¿‡éå† schemeã€‚\r\n\r\néå† scheme æ—¶ï¼Œæ ¹æ®å®šä¹‰çš„ç±»å‹ï¼Œåœ¨å¯¹åº”ä»£ç å¤„æ’å…¥ç›¸åº”çš„å·¥å…·å‡½æ•°ç”¨äºé”®å€¼è½¬æ¢ã€‚ä¾‹å¦‚ä¸Šé¢ä¾‹å­ä¸­`name`è¿™ä¸ªå±æ€§ï¼š\r\n\r\n```JavaScript\r\nvar accessor = key.indexOf('[') === 0 ? sanitizeKey(key) : `['${sanitizeKey(key)}']`\r\nswitch (type) {\r\n    case 'null':\r\n        code += `\r\n            json += $asNull()\r\n        `\r\n        break\r\n    case 'string':\r\n        code += nullable ? `json += obj${accessor} === null ? null : $asString(obj${accessor})` : `json += $asString(obj${accessor})`\r\n        break\r\n    case 'integer':\r\n        code += nullable ? `json += obj${accessor} === null ? null : $asInteger(obj${accessor})` : `json += $asInteger(obj${accessor})`\r\n        break\r\n    â€¦â€¦\r\n```\r\n\r\nä¸Šé¢ä»£ç ä¸­çš„`code`å˜é‡ä¿å­˜çš„å°±æ˜¯æœ€åç”Ÿæˆçš„å‡½æ•°ä½“çš„ä»£ç ä¸²ã€‚ç”±äºåœ¨ scheme å®šä¹‰ä¸­ï¼Œ`name`ä¸º`string`ç±»å‹ï¼Œä¸”ä¸ä¸ºç©ºï¼Œæ‰€ä»¥ä¼šåœ¨`code`ä¸­æ·»åŠ å¦‚ä¸‹ä¸€æ®µä»£ç å­—ç¬¦ä¸²ï¼š\r\n\r\n```JavaScript\r\n\"json += $asString(obj['name'])\"\r\n```\r\n\r\n> ç”±äºè¿˜éœ€è¦å¤„ç†æ•°ç»„ã€åŠè”å¯¹è±¡ç­‰å¤æ‚æƒ…å†µï¼Œå®é™…çš„ä»£ç çœç•¥äº†å¾ˆå¤šã€‚\r\n\r\nç„¶åï¼Œç”Ÿæˆçš„å®Œæ•´çš„`code`å­—ç¬¦ä¸²å¤§è‡´å¦‚ä¸‹ï¼š\r\n\r\n```JavaScript\r\nfunction $asString(str) {\r\n    // â€¦â€¦\r\n}\r\nfunction $asStringNullable(str) {\r\n    // â€¦â€¦\r\n}\r\nfunction $asStringSmall(str) {\r\n    // â€¦â€¦\r\n}\r\nfunction $asNumber(i) {\r\n    // â€¦â€¦\r\n}\r\nfunction $asNumberNullable(i) {\r\n    // â€¦â€¦\r\n}\r\n/* ä»¥ä¸Šæ˜¯ä¸€ç³»åˆ—é€šç”¨çš„é”®å€¼è½¬æ¢æ–¹æ³• */\r\n\r\n/* $main å°±æ˜¯ stringify çš„ä¸»ä½“å‡½æ•° */\r\nfunction $main(input) {\r\n    var obj = typeof input.toJSON === 'function'\r\n        ? input.toJSON()\r\n        : input\r\n\r\n    var json = '{'\r\n    var addComma = false\r\n    if (obj['name'] !== undefined) {\r\n        if (addComma) {\r\n            json += ','\r\n        }\r\n        addComma = true\r\n        json += '\"name\":'\r\n        json += $asString(obj['name'])\r\n    }\r\n\r\n    // â€¦â€¦ å…¶ä»–å±æ€§(statusã€working)çš„æ‹¼æ¥\r\n\r\n    json += '}'\r\n    return json\r\n}\r\n\r\nreturn $main\r\n```\r\n\r\næœ€åï¼Œå°†`code`å­—ç¬¦ä¸²ä¼ å…¥ Function æ„é€ å‡½æ•°æ¥åˆ›å»ºç›¸åº”çš„ stringify å‡½æ•°ã€‚\r\n\r\n```JavaScript\r\n// dependencies ä¸»è¦ç”¨äºå¤„ç†åŒ…å« anyOf ä¸ if è¯­æ³•çš„æƒ…å†µ\r\ndependenciesName.push(code)\r\nreturn (Function.apply(null, dependenciesName).apply(null, dependencies))\r\n```\r\n\r\n### 3.2. slow-json-stringify\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/6/4/16b223db88e935e6?w=2004&h=92&f=png&s=66851)\r\n\r\n[slow-json-stringify](https://github.com/lucagez/slow-json-stringify) è™½ç„¶åå­—å« \"slow\"ï¼Œä½†å…¶å®æ˜¯ä¸€ä¸ª \"fast\" çš„ stringify åº“ï¼ˆå‘½åå¾ˆè°ƒçš®ï¼‰ã€‚\r\n\r\n> The slowest stringifier in the known universe. Just kidding, it's the fastest (:\r\n\r\nå®ƒçš„å®ç°æ¯”å‰é¢æåˆ°çš„ fast-json-stringify æ›´è½»é‡çº§ï¼Œæ€è·¯ä¹Ÿå¾ˆå·§å¦™ã€‚åŒæ—¶å®ƒ[åœ¨å¾ˆå¤šåœºæ™¯ä¸‹æ•ˆç‡ä¼šæ¯” fast-json-stringify æ›´å¿«](https://github.com/lucagez/slow-json-stringify/blob/master/benchmark.md)ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/6/5/16b25784d49d825a?w=1200&h=488&f=png&s=42368)\r\n\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/6/5/16b25793da834834?w=1092&h=396&f=png&s=29644)\r\n\r\n#### 3.2.1. scheme çš„å®šä¹‰æ–¹å¼\r\n\r\nslow-json-stringify çš„ scheme å®šä¹‰æ›´è‡ªç„¶ä¸ç®€å•ï¼Œä¸»è¦å°±æ˜¯å°†é”®å€¼æ›¿æ¢ä¸ºç±»å‹æè¿°ã€‚è¿˜æ˜¯ä¸Šé¢è¿™ä¸ªå¯¹è±¡çš„ä¾‹å­ï¼Œscheme ä¼šå˜ä¸º\r\n\r\n```JavaScript\r\n{\r\n    name: 'string',\r\n    status: 'number',\r\n    working: 'boolean'\r\n}\r\n```\r\n\r\nç¡®å®éå¸¸ç›´è§‚ã€‚\r\n\r\n#### 3.2.2. stringify æ–¹æ³•çš„ç”Ÿæˆ\r\n\r\nä¸çŸ¥é“ä½ æ³¨æ„åˆ°æ²¡æœ‰\r\n\r\n```JavaScript\r\n// scheme\r\n{\r\n    name: 'string',\r\n    status: 'number',\r\n    working: 'boolean'\r\n}\r\n\r\n// ç›®æ ‡å¯¹è±¡\r\n{\r\n    name: 'alienzhou',\r\n    status: 6,\r\n    working: true\r\n}\r\n```\r\n\r\nscheme å’ŒåŸå¯¹è±¡çš„ç»“æ„æ˜¯ä¸æ˜¯å¾ˆåƒï¼Ÿ\r\n\r\nè¿™ç§ scheme çš„å·§å¦™ä¹‹å¤„åœ¨äºï¼Œè¿™æ ·å®šä¹‰ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæŠŠ scheme `JSON.stringify`ä¸€ä¸‹ï¼Œç„¶åâ€œæ‰£å»â€æ‰€æœ‰ç±»å‹å€¼ï¼Œæœ€åç­‰ç€æˆ‘ä»¬çš„å°±æ˜¯æŠŠå®é™…çš„å€¼ç›´æ¥å¡«å……åˆ° scheme å¯¹åº”çš„ç±»å‹å£°æ˜å¤„ã€‚\r\n\r\nå…·ä½“å¦‚ä½•æ“ä½œå‘¢ï¼Ÿ\r\n\r\né¦–å…ˆï¼Œå¯ä»¥ç›´æ¥å¯¹ scheme è°ƒç”¨`JSON.stringify()`æ¥ç”ŸæˆåŸºç¡€æ¨¡ç‰ˆï¼ŒåŒæ—¶å€Ÿç”¨`JSON.stringify()`çš„ç¬¬äºŒä¸ªå‚æ•°æ¥ä½œä¸ºéå†æ–¹æ³•æ”¶é›†å±æ€§çš„è®¿é—®è·¯å¾„ï¼š\r\n\r\n```JavaScript\r\nlet map = {};\r\nconst str = JSON.stringify(schema, (prop, value) => {\r\n    const isArray = Array.isArray(value);\r\n    if (typeof value !== 'object' || isArray) {\r\n        if (isArray) {\r\n            const current = value[0];\r\n            arrais.set(prop, current);\r\n        }\r\n\r\n        _validator(value);\r\n\r\n        map[prop] = _deepPath(schema, prop);\r\n        props += `\"${prop}\"|`;\r\n    }\r\n    return value;\r\n});\r\n```\r\n\r\næ­¤æ—¶ï¼Œ`map` é‡Œæ”¶é›†æ‰€æœ‰å±æ€§çš„è®¿é—®è·¯å¾„ã€‚åŒæ—¶ç”Ÿæˆçš„`props`å¯ä»¥æ‹¼æ¥ä¸ºåŒ¹é…ç›¸åº”ç±»å‹å­—ç¬¦è¿˜çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œä¾‹å¦‚æˆ‘ä»¬è¿™ä¸ªä¾‹å­é‡Œçš„æ­£åˆ™è¡¨è¾¾å¼ä¸º`/name|status|working\"(string|number|boolean|undef)\"|\\\\[(.*?)\\\\]/`ã€‚\r\n\r\nç„¶åï¼Œæ ¹æ®æ­£åˆ™è¡¨è¾¾å¼æ¥é¡ºåºåŒ¹é…è¿™äº›å±æ€§ï¼Œæ›¿æ¢æ‰å±æ€§ç±»å‹çš„å­—ç¬¦ä¸²ï¼Œæ¢æˆç»Ÿä¸€çš„å ä½å­—ç¬¦ä¸²`\"__par__\"`ï¼Œå¹¶åŸºäº`\"__par__\"`æ‹†åˆ†å­—ç¬¦ä¸²ï¼š\r\n\r\n\r\n```JavaScript\r\nconst queue = [];\r\nconst chunks = str\r\n    .replace(regex, (type) => {\r\n      switch (type) {\r\n        case '\"string\"':\r\n        case '\"undefined\"':\r\n          return '\"__par__\"';\r\n        case '\"number\"':\r\n        case '\"boolean\"':\r\n        case '[\"array-simple\"]':\r\n        case '[null]':\r\n          return '__par__';\r\n        default:\r\n          const prop = type.match(/(?<=\\\").+?(?=\\\")/)[0];\r\n          queue.push(prop);\r\n          return type;\r\n      }\r\n    })\r\n    .split('__par__');\r\n```\r\n\r\nè¿™æ ·ä½ å°±ä¼šå¾—åˆ°`chunks`å’Œ`props`ä¸¤ä¸ªæ•°ç»„ã€‚`chunks`é‡ŒåŒ…å«äº†è¢«åˆ†å‰²çš„ JSON å­—ç¬¦ä¸²ã€‚ä»¥ä¾‹å­æ¥è¯´ï¼Œä¸¤ä¸ªæ•°ç»„åˆ†åˆ«å¦‚ä¸‹\r\n\r\n```JavaScript\r\n// chunks\r\n[\r\n    '{\"name\":\"',\r\n    '\",\"status\":\"',\r\n    '\",\"working\":\"',\r\n    '\"}'\r\n]\r\n\r\n// props\r\n[\r\n    'name',\r\n    'status',\r\n    'working'\r\n]\r\n```\r\n\r\næœ€åï¼Œç”±äº map ä¸­ä¿å­˜äº†å±æ€§åä¸è®¿é—®è·¯å¾„çš„æ˜ å°„ï¼Œå› æ­¤å¯ä»¥æ ¹æ® prop è®¿é—®åˆ°å¯¹è±¡ä¸­æŸä¸ªå±æ€§çš„å€¼ï¼Œå¾ªç¯éå†æ•°ç»„ï¼Œå°†å…¶ä¸å¯¹åº”çš„ chunks æ‹¼æ¥å³å¯ã€‚\r\n\r\nä»ä»£ç é‡å’Œå®ç°æ–¹å¼æ¥çœ‹ï¼Œè¿™ä¸ªæ–¹æ¡ˆä¼šæ›´è½»ä¾¿ä¸å·§å¦™ï¼ŒåŒæ—¶ä¹Ÿä¸éœ€è¦é€šè¿‡ Functionã€eval ç­‰æ–¹å¼åŠ¨æ€ç”Ÿæˆæˆ–æ‰§è¡Œå‡½æ•°ã€‚\r\n\r\n## 4. æ€»ç»“\r\n\r\nè™½ç„¶ä¸åŒåº“çš„å®ç°æœ‰å·®å¼‚ï¼Œä½†ä»æ•´ä½“æ€è·¯ä¸Šæ¥è¯´ï¼Œå®ç°é«˜æ€§èƒ½ stringify çš„æ–¹å¼éƒ½æ˜¯ä¸€æ ·çš„ï¼š\r\n\r\n1. å¼€å‘è€…å®šä¹‰ Object çš„ JSON schemeï¼›\r\n2. stringify åº“æ ¹æ® scheme ç”Ÿæˆå¯¹åº”çš„æ¨¡ç‰ˆæ–¹æ³•ï¼Œæ¨¡ç‰ˆæ–¹æ³•é‡Œä¼šå¯¹å±æ€§ä¸å€¼è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆæ˜¾ç„¶ï¼Œå±æ€§è®¿é—®ä¸å­—ç¬¦ä¸²æ‹¼æ¥çš„æ•ˆç‡è¦é«˜å¤šäº†ï¼‰ï¼›\r\n3. æœ€åå¼€å‘è€…è°ƒç”¨è¿”å›çš„æ–¹æ³•æ¥ stringify Object å³å¯ã€‚\r\n\r\nå½’æ ¹åˆ°åº•ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯é€šè¿‡é™æ€çš„ç»“æ„ä¿¡æ¯å°†ä¼˜åŒ–ä¸åˆ†æå‰ç½®äº†ã€‚\r\n\r\n## Tips\r\n\r\næœ€åï¼Œè¿˜æ˜¯æƒ³æä¸€ä¸‹\r\n\r\n- æ‰€æœ‰çš„ benchmark åªèƒ½ä½œä¸ºä¸€ä¸ªå‚è€ƒï¼Œå…·ä½“æ˜¯å¦æœ‰æ€§èƒ½æå‡ã€æå‡å¤šå°‘è¿˜æ˜¯å»ºè®®ä½ åœ¨å®é™…çš„ä¸šåŠ¡ä¸­æµ‹è¯•ï¼›\r\n- fast-json-stringify ä¸­ä½¿ç”¨åˆ°äº† Function æ„é€ å‡½æ•°ï¼Œå› æ­¤å»ºè®®ä¸è¦å°†ç”¨æˆ·è¾“å…¥ç›´æ¥ç”¨ä½œ schemeï¼Œä»¥é˜²ä¸€äº›å®‰å…¨é—®é¢˜ã€‚\r\n\r\n---\r\n\r\nå¥½äº†ï¼Œè¿™æœŸçš„ã€Œæ¼«æ¸¸ Githubã€å°±åˆ°è¿™é‡Œäº†ã€‚æœ¬ç³»åˆ—ä¼šä¸å®šæœŸå’Œå¤§å®¶ä¸€èµ·çœ‹ä¸€çœ‹ã€èŠä¸€èŠã€å­¦ä¸€å­¦ github ä¸Šæœ‰è¶£çš„é¡¹ç›®ï¼Œä¸ä»…å­¦ä¹ ä¸€äº›æŠ€æœ¯ç‚¹ï¼Œè¿˜å¯ä»¥äº†è§£ä½œè€…çš„æŠ€æœ¯æ€è€ƒï¼Œæ¬¢è¿æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å…³æ³¨ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/71757685-7807ac00-2ed2-11ea-97e7-c93eec7b6017.png)\r\n\r\n---","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/30","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/30/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/30/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/30/events","html_url":"https://github.com/alienzhou/blog/issues/30","id":446369405,"node_id":"MDU6SXNzdWU0NDYzNjk0MDU=","number":30,"title":"å¦‚ä½•åœ¨é›¶JSä»£ç æƒ…å†µä¸‹å®ç°ä¸€ä¸ªå®æ—¶èŠå¤©åŠŸèƒ½â“","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845018,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE4","url":"https://api.github.com/repos/alienzhou/blog/labels/CSS","name":"CSS","color":"7057ff","default":false,"description":""},{"id":1159855196,"node_id":"MDU6TGFiZWwxMTU5ODU1MTk2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E6%9C%8D%E5%8A%A1%E7%AB%AF","name":"æœåŠ¡ç«¯","color":"0bbaae","default":false,"description":""},{"id":1159845015,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E6%B5%8F%E8%A7%88%E5%99%A8","name":"æµè§ˆå™¨","color":"cfd3d7","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-05-21T00:52:44Z","updated_at":"2019-05-21T00:52:44Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## å¼•è¨€\r\n\r\nå‰æ®µæ—¶é—´åœ¨ github ä¸Šçœ‹åˆ°äº†ä¸€ä¸ªå¾ˆâ€œtrickâ€çš„é¡¹ç›®ï¼šç”¨çº¯ CSSï¼ˆå³ä¸ä½¿ç”¨ JavaScriptï¼‰å®ç°ä¸€ä¸ªèŠå¤©åº”ç”¨ â€”â€” [css-only-chat](https://github.com/kkuchta/css-only-chat)ã€‚å³ä¸‹å›¾æ‰€ç¤ºæ•ˆæœã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/5/20/16ad56d29a8af1c6?w=1503&h=870&f=gif&s=5194924)\r\n\r\nåœ¨æˆ‘ä»¬çš„å°è±¡é‡Œï¼Œå®ç°ä¸€ä¸ªç®€å•çš„èŠå¤©åº”ç”¨ï¼ˆæ¶ˆæ¯å‘é€ä¸å¤šé¡µé¢åŒæ­¥ï¼‰å¹¶ä¸å›°éš¾ â€”â€” è¿™æ˜¯åœ¨æˆ‘ä»¬æœ‰ JavaScript çš„å¸®åŠ©ä¸‹ã€‚è€Œå¦‚æœè®©ä½ åªèƒ½ä½¿ç”¨ CSSï¼Œä¸èƒ½æœ‰å‰ç«¯çš„ JavaScript ä»£ç ï¼Œé‚£ä½ èƒ½å¤Ÿå®ç°ä¹ˆï¼Ÿ\r\n\r\n> åŸç‰ˆæ˜¯ç”¨ Ruby å†™çš„åç«¯ã€‚å¯èƒ½å¤§å®¶å¯¹ Ruby ä¸å¤ªäº†è§£ï¼Œæ‰€ä»¥æˆ‘æŒ‰ç…§åŸä½œè€…æ€è·¯ï¼Œç”¨ NodeJS å®ç°äº†ä¸€ç‰ˆ [css-only-chat-node](https://github.com/alienzhou/css-only-chat-node)ï¼Œå¯¹å¤§å®¶æ¥è¯´å¯èƒ½ä¼šæ›´æ˜“è¯»äº›ã€‚\r\n\r\n## 1. æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜\r\n\r\né¦–å…ˆå¼ºè°ƒä¸€ä¸‹ï¼ŒæœåŠ¡ç«¯çš„ä»£ç è‚¯å®šè¿˜æ˜¯éœ€è¦å†™çš„ï¼Œè€Œä¸”è¿™éƒ¨åˆ†æ˜¾ç„¶ä¸èƒ½æ˜¯ CSSã€‚æ‰€ä»¥è¿™é‡Œçš„â€œçº¯ CSSâ€ä¸»è¦æŒ‡åœ¨æµè§ˆå™¨ç«¯åªä½¿ç”¨ CSSã€‚\r\n\r\nå›å¿†ä¸€ä¸‹ï¼Œå¦‚æœä½¿ç”¨ JavaScript æ¥å®ç°ä¸Šå›¾ä¸­å±•ç¤ºçš„èŠå¤©åŠŸèƒ½ï¼Œæœ‰å“ªäº›é—®é¢˜éœ€è¦å¤„ç†å‘¢ï¼Ÿ\r\n\r\n- é¦–å…ˆï¼Œéœ€è¦æ·»åŠ æŒ‰é’®çš„`click`äº‹ä»¶ç›‘å¬ï¼ŒåŒ…æ‹¬å­—ç¬¦æŒ‰é’®çš„ç‚¹å‡»ä¸å‘é€æŒ‰é’®çš„ç‚¹å‡»ï¼›\r\n- å…¶æ¬¡ï¼Œç‚¹å‡»ç›¸åº”æŒ‰é’®åï¼Œè¦å°†ä¿¡æ¯é€šè¿‡ Ajax çš„æ–¹å¼å‘é€åˆ°åç«¯æœåŠ¡ï¼›\r\n- å†è€…ï¼Œè¦å®ç°å®æ—¶çš„æ¶ˆæ¯å±•ç¤ºï¼Œä¸€èˆ¬ä¼šå»ºç«‹ä¸€ä¸ª WebSocket è¿æ¥ï¼›\r\n- æœ€åï¼Œå¯¹äºåç«¯åŒæ­¥æ¥çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬ä¼šåœ¨æµè§ˆå™¨ç«¯æ“ä½œ DOM API æ¥æ”¹å˜ DOM å†…å®¹ï¼Œå±•ç¤ºæ¶ˆæ¯è®°å½•ã€‚\r\n\r\næ¶‰åŠåˆ° JavaScript çš„æ“ä½œä¸»è¦å°±æ˜¯ä¸Šé¢å››ä¸ªäº†ã€‚ä½†æ˜¯ï¼Œç°åœ¨æˆ‘ä»¬åªèƒ½ä½¿ç”¨ CSSï¼Œé‚£å¯¹äºä¸Šé¢è¿™å‡ ä¸ªæ“ä½œï¼Œå¯ä»¥ç”¨ä»€ä¹ˆæ–¹å¼å®ç°å‘¢ï¼Ÿ\r\n\r\n## 2. Trick Time\r\n\r\n### 2.1. è§£å†³â€œç‚¹å‡»ç›‘å¬â€çš„é—®é¢˜\r\n\r\nä½¿ç”¨ JavaScript çš„è¯ä¸€è¡Œä»£ç å¯ä»¥æå®šï¼š\r\n\r\n```JavaScript\r\ndocument.getElementById('btn').addEventListener('click', function () {\r\n    // â€¦â€¦\r\n});\r\n```\r\n\r\nä½¿ç”¨ CSS çš„è¯ï¼Œå…¶å®æœ‰ä¸ªä¼ªç±»å¯ä»¥å¸®æˆ‘ä»¬ï¼Œå³`:active`ã€‚å®ƒå¯ä»¥é€‰æ‹©æ¿€æ´»çš„å…ƒç´ ï¼Œè€Œå½“æˆ‘ä»¬ç‚¹å‡»æŸä¸ªå…ƒç´ æ—¶ï¼Œå®ƒå°±ä¼šå¤„äºæ¿€æ´»çŠ¶æ€ã€‚\r\n\r\næ‰€ä»¥ï¼Œå¯¹äºä¸Šé¢åŠ¨å›¾ä¸­çš„26ä¸ªå­—æ¯ï¼ˆå†åŠ ä¸Š send æŒ‰é’®ï¼‰ï¼Œå¯ä»¥åˆ†é…ä¸åŒçš„`classname`ï¼Œç„¶åè®¾ç½®ä¼ªç±»é€‰æ‹©å™¨ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ç‚¹å‡»è¯¥å­—æ¯å¯¹åº”çš„æŒ‰é’®æ—¶è§¦å‘å‘½ä¸­æŸä¸ª CSS è§„åˆ™ã€‚ä¾‹å¦‚å¯ä»¥å¯¹å­—ç¬¦â€œaâ€è®¾ç½®å¦‚ä¸‹è§„åˆ™ç”¨äºâ€œæ•è·â€ç‚¹å‡»ï¼š\r\n\r\n```CSS\r\n.btn_a:active {\r\n    /* â€¦â€¦ */ \r\n}\r\n```\r\n\r\n### 2.2. å‘é€è¯·æ±‚\r\n\r\nå¦‚æœæœ‰ JavaScript çš„å¸®åŠ©ï¼Œå‘é€è¯·æ±‚åªéœ€è¦ç”¨ä¸ª XHR å³å¯ï¼Œå¾ˆæ–¹ä¾¿ã€‚è€Œå¯¹äº CSSï¼Œå¦‚æœè¦æƒ³å‘ä¸€ä¸ªè¯·æ±‚çš„è¯æœ‰ä»€ä¹ˆåŠæ³•ä¹ˆï¼Ÿ\r\n\r\nå¯ä»¥ä½¿ç”¨`background-image`å±æ€§ï¼Œå°†å®ƒæŒ‡å®šä¸ºæŸä¸ª URLï¼Œè¿™æ ·å‰ç«¯å°±ä¼šå‘æœåŠ¡å™¨å‘èµ·ä¸€ä¸ªèƒŒæ™¯å›¾ç‰‡çš„è¯·æ±‚ã€‚ä¹‹æ‰€ä»¥å¯ä»¥ä½¿ç”¨`background-image`å±æ€§è¿˜å› ä¸ºï¼šæµè§ˆå™¨åªæœ‰åœ¨è¯¥ CSS é€‰æ‹©å™¨è§„åˆ™è¢«å®é™…åº”ç”¨åˆ° DOM å…ƒç´ åæ‰ä¼šå®é™…å‘èµ·`background-image`çš„è¯·æ±‚ã€‚ä¾‹å¦‚ä¸‹é¢è¿™ä¸ªè§„åˆ™ï¼š\r\n\r\n```CSS\r\n.btn_a:active {\r\n    background-image: url('/keys/a');\r\n}\r\n```\r\n\r\nåªæœ‰åœ¨å­—ç¬¦â€œaâ€è¢«ç‚¹å‡»åï¼Œæµè§ˆå™¨æ‰ä¼šå‘æœåŠ¡å™¨è¯·æ±‚`/keys/a`è¿™å¼ â€œå›¾ç‰‡â€ã€‚è€Œåœ¨æœåŠ¡å™¨ç«¯ï¼Œé€šè¿‡åˆ¤æ–­ URL å¯ä»¥çŸ¥é“å‰ç«¯ç‚¹å‡»äº†å“ªä¸ªå­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œå¯¹äºæŒ‰é’®â€œbâ€ä¼šæœ‰å¦‚ä¸‹è§„åˆ™ï¼š\r\n\r\n```CSS\r\n.btn_b:active {\r\n    background-image: url('/keys/b');\r\n}\r\n```\r\n\r\nè¿™æ ·å°±ç›¸å½“äºå®ç°äº†åœ¨ URLï¼ˆ`/keys/a`ä¸`/keys/b`ï¼‰ ä¸­â€œä¼ å‚â€ã€‚ \r\n\r\n### 2.3. å®æ—¶æ¶ˆæ¯å±•ç¤º\r\n\r\nå®æ—¶çš„æ¶ˆæ¯å±•ç¤ºï¼Œæ ¸å¿ƒä¼šç”¨åˆ°ä¸€ç§å«â€œæœåŠ¡å™¨æ¨â€çš„æŠ€æœ¯ã€‚å…¶ä¸­æ¯”è¾ƒå¸¸è§æ–¹å¼æœ‰ï¼š\r\n\r\n- ä½¿ç”¨ JavaScript æ¥å’ŒæœåŠ¡ç«¯å»ºç«‹ WebSocket è¿æ¥\r\n- ä½¿ç”¨ JavaScript åˆ›å»ºå®šæ—¶å™¨ï¼Œå®šæ—¶å‘é€è¯·æ±‚è½®è¯¢\r\n- ä½¿ç”¨ JavaScript å’ŒæœåŠ¡ç«¯é…åˆæ¥å®ç°é•¿è½®è¯¢\r\n\r\nä½†è¿™äº›æ–¹æ³•éƒ½æ— æ³•è§„é¿ JavaScriptï¼Œæ˜¾ç„¶ä¸ç¬¦åˆå’±ä»¬çš„è¦æ±‚ã€‚å…¶å®è¿˜æœ‰ä¸€ç§æ–¹å¼ï¼Œæˆ‘åœ¨[ã€Šå„ç±»â€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯åŸç†ä¸å®ä¾‹ã€‹](https://juejin.im/post/5b135b78f265da6e420eab7d)ä¸­ä¹Ÿæœ‰æåˆ°ï¼Œé‚£å°±æ˜¯åŸºäº iframe çš„é•¿è¿æ¥æµï¼ˆstreamï¼‰æ¨¡å¼ã€‚\r\n\r\nè¿™é‡Œæˆ‘ä»¬ä¸»è¦æ˜¯å€Ÿé‰´äº†â€œé•¿è¿æ¥æµâ€è¿™ç§æ¨¡å¼ã€‚è®©æˆ‘ä»¬çš„é¡µé¢æ°¸è¿œå¤„äºä¸€ä¸ªæœªåŠ è½½å®Œæˆçš„çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œç”±äºè¯·æ±‚å¤´ä¸­åŒ…å«`Transfer-Encoding: chunked`ï¼Œå®ƒä¼šå‘Šè¯‰æµè§ˆå™¨ï¼Œè™½ç„¶é¡µé¢æ²¡æœ‰è¿”å›ç»“æŸï¼Œä½†ä½ å¯ä»¥å¼€å§‹æ¸²æŸ“é¡µé¢äº†ã€‚æ­£æ˜¯ç”±äºè¯¥è¯·æ±‚çš„å“åº”æ°¸è¿œä¸ä¼šç»“æŸï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¸æ–­å‘å…¶ä¸­å†™å…¥æ–°çš„å†…å®¹ï¼Œæ¥æ›´æ–°é¡µé¢å±•ç¤ºã€‚\r\n\r\nå®ç°èµ·æ¥ä¹Ÿéå¸¸ç®€å•ã€‚`http.ServerResponse`ç±»æœ¬èº«å°±æ˜¯ç»§æ‰¿è‡ª`Stream`çš„ï¼Œæ‰€ä»¥åªè¦åœ¨éœ€è¦æ›´æ–°é¡µé¢å†…å®¹æ—¶è°ƒç”¨`.write()`æ–¹æ³•å³å¯ã€‚ä¾‹å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼Œå¯ä»¥æ¯éš”2såœ¨é¡µé¢ä¸ŠåŠ¨æ€æ·»åŠ  \"hello\" å­—ç¬¦ä¸²è€Œä¸éœ€è¦ä»»ä½•æµè§ˆå™¨ç«¯çš„é…åˆï¼ˆä¹Ÿå°±ä¸éœ€è¦å†™ JavaScript ä»£ç äº†ï¼‰ï¼š\r\n\r\n```JavaScript\r\nconst http = require('http');\r\nhttp.createServer((req, res) => {\r\n    res.setHeader('connection', 'keep-alive');\r\n    res.setHeader('content-type', 'text/html; charset=utf-8');\r\n    res.statusCode = 200;\r\n    res.write('I will update by myself');\r\n\r\n    setInterval(() => res.write('<br>hello'), 2000);\r\n}).listen(8085);\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/5/20/16ad547da08e7d73?w=1077&h=534&f=gif&s=150336)\r\n\r\n### 2.4. æ”¹å˜é¡µé¢ä¿¡æ¯\r\n\r\nåœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»å¯ä»¥é€šè¿‡ Stream çš„æ–¹å¼ï¼Œä¸å€ŸåŠ© JavaScript å³å¯åŠ¨æ€æ”¹å˜é¡µé¢å†…å®¹äº†ã€‚ä½†æ˜¯å¦‚æœä½ ç»†å¿ƒä¼šå‘ç°ï¼Œè¿™ç§æ–¹å¼åªèƒ½ä¸æ–­â€œappendâ€å†…å®¹ã€‚è€Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œçœ‹èµ·æ¥æ›´åƒæ˜¯èƒ½å¤ŸåŠ¨æ€æ”¹å˜æŸä¸ª DOM ä¸­çš„æ–‡æœ¬ï¼Œä¾‹å¦‚éšç€ç‚¹å‡»ä¸åŒæŒ‰é’®ï¼Œâ€œCurrent Messageâ€åé¢çš„æ–‡æœ¬ä¼šä¸æ–­å˜åŒ–ã€‚\r\n\r\nè¿™é‡Œå…¶å®ä¹Ÿæœ‰ä¸ªå¾ˆâ€œtrickâ€çš„æ–¹å¼ã€‚ä¸‹å›¾è¿™ä¸ªéƒ¨åˆ†ï¼ˆæˆ‘ä»¬å§‘ä¸”å«å®ƒ ChatPanel å§ï¼‰\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/5/20/16ad543f357344b1?w=1300&h=330&f=png&s=93410)\r\n\r\nå…¶å®æˆ‘ä»¬æ¯æ¬¡è°ƒç”¨`res.write()`æ—¶éƒ½ä¼šè¿”å›ä¸€ä¸ªå…¨æ–°çš„ ChatPanel çš„ HTML ç‰‡æ®µã€‚äºæ­¤åŒæ—¶ï¼Œè¿˜ä¼šé™„å¸¦ä¸€ä¸ª`<style>`å…ƒç´ ï¼Œå°†ä¹‹å‰çš„ ChatPanel è®¾ä¸º`display: none`ã€‚æ‰€ä»¥çœ‹èµ·æ¥åƒæ˜¯æ›´æ–°äº†åŸæ¥çš„ ChatPanel çš„å†…å®¹ï¼Œä½†å…¶å®æ˜¯ append äº†ä¸€ä¸ªæ–°çš„ï¼ŒåŒæ—¶éšè—ä¹‹å‰çš„ ChatPanelã€‚\r\n\r\n### 2.5. ç‚¹å‡»é‡å¤çš„æŒ‰é’®\r\n\r\nåˆ°ç›®å‰ä¸ºæ­¢ï¼ŒåŸºæœ¬çš„æ–¹æ¡ˆéƒ½æœ‰äº†ï¼Œä½†è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„é—®é¢˜ï¼š\r\n\r\nåœ¨ CSS è§„åˆ™ä¸­çš„`background-image`åªä¼šåœ¨ç¬¬ä¸€æ¬¡åº”ç”¨åˆ°å…ƒç´ æ—¶å‘èµ·è¯·æ±‚ï¼Œä¹‹åå°±ä¸ä¼šå†å‘æœåŠ¡å™¨è¯·æ±‚äº†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨\r\n\r\n```CSS\r\n.btn_a:active {\r\n    background-image: url('/keys/a');\r\n}\r\n```\r\n\r\nè¿™ç§è§„åˆ™ï¼Œâ€œaâ€ è¿™ä¸ªæŒ‰é’®ç‚¹è¿‡ä¸€æ¬¡ä¹‹åï¼Œä¸‹æ¬¡å†ç‚¹å‡»å°±æ¯«æ— ååº”äº† â€”â€” å³åç«¯æ”¶ä¸åˆ°è¯·æ±‚äº†ã€‚\r\n\r\nè¦è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸€ä¸ªæ–¹æ³•ã€‚å¯ä»¥åœ¨æ¯æ¬¡è¿”å›çš„æ–°çš„ ChatPanelï¼ˆChatPanel æ˜¯å•¥å’±ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­æåˆ°äº†ï¼Œå¦‚æœå¿˜äº†å¯ä»¥å›å»çœ‹ä¸‹ï¼‰é‡Œï¼Œä¸ºæ¯ä¸ªå­—ç¬¦æŒ‰é’®éƒ½åº”ç”¨ä¸€å¥—æ–°çš„æ ·å¼è§„åˆ™ï¼Œå¹¶è®¾ç½®æ–°çš„èƒŒæ™¯å›¾ URLã€‚ä¾‹å¦‚æˆ‘ä»¬ç¬¬ä¸€æ¬¡ç‚¹å‡»äº†â€œhâ€ä¹‹åï¼Œè¿”å›çš„ ChatPanel é‡Œçš„æŒ‰é’®â€œaâ€çš„`classname`ä¼šè¯¥æˆ`btn_h_a`ï¼Œå¯¹åº”çš„ CSS è§„åˆ™æ”¹ä¸ºï¼š\r\n\r\n```CSS\r\n.btn_h_a:active {\r\n    background-image: url('/keys/h_a');\r\n}\r\n```\r\n\r\nå†æ¬¡ç‚¹å‡»â€œiâ€ä¹‹åï¼ŒChatPanel é‡Œå¯¹åº”çš„æŒ‰é’®çš„æ ·å¼è§„åˆ™æ”¹ä¸ºï¼š\r\n\r\n```CSS\r\n.btn_hi_a:active {\r\n    background-image: url('/keys/hi_a');\r\n}\r\n```\r\n\r\n### 2.6. å­˜å‚¨\r\n\r\nä¸ºäº†èƒ½å¤Ÿä¿å­˜æœªå‘é€çš„å†…å®¹ï¼ˆç‚¹å‡» send æŒ‰é’®ä¹‹å‰çš„è¾“å…¥å†…å®¹ï¼‰ï¼Œä»¥åŠåŒæ­¥å†å²æ¶ˆæ¯ï¼Œéœ€è¦æœ‰ä¸ªåœ°æ–¹å­˜å‚¨ç”¨æˆ·è¾“å…¥ã€‚åŒæ—¶æˆ‘ä»¬è¿˜ä¼šä¸ºæ¯ä¸ªè¿æ¥è®¾å®šä¸€ä¸ªå”¯ä¸€çš„ç”¨æˆ· IDã€‚åœ¨åŸç‰ˆçš„ css-only-chat ä¸­ä½¿ç”¨äº† Redisã€‚æˆ‘åœ¨ css-only-chat-node ä¸­ä¸ºäº†ç®€ä¾¿ï¼Œç›´æ¥å­˜å‚¨åœ¨äº†è¿è¡Œæ—¶çš„å†…å­˜å˜é‡ä¸­äº†ã€‚\r\n\r\n## 3. æœ€å\r\n\r\nä¹Ÿè®¸æœ‰æœ‹å‹ä¼šé—®ï¼Œè¿™ä¸ª DEMO æœ‰ä»€ä¹ˆå®ç”¨ä»·å€¼ä¹ˆï¼Ÿå¯ä»¥å‘å±•æˆä¸€ä¸ªå¯ç”¨çš„èŠå¤©å·¥å…·ä¹ˆï¼Ÿ\r\n\r\nå¥½å§ï¼Œå…¶å®æˆ‘è§‰å¾—æ²¡æœ‰å¤ªå¤§ç”¨ã€‚ä½†æ˜¯é‡Œé¢æ¶‰åŠåˆ°çš„ä¸€äº›â€œçŸ¥è¯†ç‚¹â€åˆ°æ˜¯äº†è§£ä¸‹ä¹Ÿæ— å¦¨ã€‚æˆ‘ä»¬æ¯å¤©é¢å¯¹é‚£ä¹ˆå¤šæ— è¶£çš„éœ€æ±‚ï¼Œå¶å°”çœ‹çœ‹è¿™ç§â€œæœ‰æ„æ€â€çš„é¡¹ç›®ä¹Ÿç®—æ˜¯æ”¾æ¾ä¸€ä¸‹å§ã€‚\r\n\r\næœ€åï¼Œå¦‚æœæƒ³çœ‹å…·ä½“çš„è¿è¡Œæ•ˆæœï¼Œæˆ–è€…æƒ³äº†è§£ä»£ç çš„ç»†èŠ‚ï¼Œå¯ä»¥çœ‹è¿™é‡Œï¼š\r\n\r\n- [css-only-chat-node](https://github.com/alienzhou/css-only-chat-node)ï¼šç”±äºåŸç‰ˆæ˜¯ Ruby å†™çš„ï¼Œæ‰€ä»¥å®ç°äº†ä¸€ä¸ª NodeJS ç‰ˆçš„ä¾¿äºå¤§å®¶æŸ¥çœ‹\r\n- [css-only-chat](https://github.com/kkuchta/css-only-chat)ï¼šcss-only-chat çš„åŸç‰ˆä»“åº“ï¼Œä½¿ç”¨ Ruby å®ç°\r\n\r\nJust have fun! ğŸ˜œ","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/29","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/29/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/29/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/29/events","html_url":"https://github.com/alienzhou/blog/issues/29","id":445055951,"node_id":"MDU6SXNzdWU0NDUwNTU5NTE=","number":29,"title":"ğŸ› å¦‚ä½•å¿«é€Ÿå¼€å‘ä¸€ä¸ªè‡ªå·±çš„é¡¹ç›®è„šæ‰‹æ¶ï¼Ÿ","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845016,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%BB%BC%E5%90%88","name":"ç»¼åˆ","color":"a2eeef","default":false,"description":""},{"id":1160330255,"node_id":"MDU6TGFiZWwxMTYwMzMwMjU1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7","name":"è‡ªåŠ¨åŒ–å·¥å…·","color":"f9c0d1","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-05-16T16:42:00Z","updated_at":"2019-05-16T16:42:00Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## å¼•è¨€\r\n\r\nä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨è„šæ‰‹æ¶æ¥åˆå§‹åŒ–é¡¹ç›®çš„å…¸å‹ä¾‹å­ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/5/16/16ac081750971790?w=1312&h=533&f=gif&s=1477981)\r\n\r\néšç€å‰ç«¯å·¥ç¨‹åŒ–çš„ç†å¿µä¸æ–­æ·±å…¥ï¼Œè¶Šæ¥è¶Šå¤šçš„äººé€‰æ‹©ä½¿ç”¨è„šæ‰‹æ¶æ¥ä»é›¶åˆ°ä¸€æ­å»ºè‡ªå·±çš„é¡¹ç›®ã€‚å…¶ä¸­å¤§å®¶æœ€ç†Ÿæ‚‰çš„å°±æ˜¯`create-react-app`å’Œ`vue-cli`ï¼Œå®ƒä»¬å¯ä»¥å¸®åŠ©æˆ‘ä»¬åˆå§‹åŒ–é…ç½®ã€ç”Ÿæˆé¡¹ç›®ç»“æ„ã€è‡ªåŠ¨å®‰è£…ä¾èµ–ï¼Œæœ€åæˆ‘ä»¬ä¸€è¡ŒæŒ‡ä»¤å³å¯è¿è¡Œé¡¹ç›®å¼€å§‹å¼€å‘ï¼Œæˆ–è€…è¿›è¡Œé¡¹ç›®æ„å»ºï¼ˆbuildï¼‰ã€‚\r\n\r\nè¿™äº›è„šæ‰‹æ¶æä¾›çš„éƒ½æ˜¯æ™®éæ„ä¹‰ä¸Šçš„æœ€ä½³å®è·µï¼Œä½†æ˜¯æˆ‘åœ¨å¼€å‘ä¸­å‘ç°ï¼Œéšç€ä¸šåŠ¡çš„ä¸æ–­å‘å±•ï¼Œå¿…ç„¶ä¼šå‡ºç°éœ€è¦é’ˆå¯¹ä¸šåŠ¡å¼€å‘çš„å®é™…æƒ…å†µæ¥è¿›è¡Œè°ƒæ•´ã€‚ä¾‹å¦‚ï¼š\r\n\r\n- é€šè¿‡è°ƒæ•´æ’ä»¶ä¸é…ç½®å®ç° Webpack æ‰“åŒ…æ€§èƒ½ä¼˜åŒ–å\r\n- åˆ é™¤è„šæ‰‹æ¶æ„å»ºå‡ºæ¥çš„éƒ¨åˆ†åŠŸèƒ½\r\n- é¡¹ç›®æ¶æ„è°ƒæ•´\r\n- èåˆå…¬å¸å¼€å‘å·¥å…·\r\n- â€¦â€¦\r\n\r\næ€»è€Œè¨€ä¹‹ï¼Œéšç€ä¸šåŠ¡å‘å±•ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šæ²‰æ·€å‡ºä¸€å¥—æ›´â€œä¸ªæ€§åŒ–â€çš„ä¸šåŠ¡æ–¹æ¡ˆã€‚è¿™æ—¶å€™æˆ‘ä»¬æœ€ç›´æ¥çš„åšæ³•å°±æ˜¯å¼€å‘å‡ºä¸€ä¸ªè¯¥æ–¹æ¡ˆçš„è„šæ‰‹æ¶æ¥ï¼Œä»¥ä¾¿ä»Šåèƒ½å¤ç”¨è¿™äº›æœ€ä½³å®è·µä¸æ–¹æ¡ˆã€‚\r\n\r\n## 1. è„šæ‰‹æ¶æ€ä¹ˆå·¥ä½œï¼Ÿ\r\n\r\nåŠŸèƒ½ä¸°å¯Œç¨‹åº¦ä¸åŒçš„è„šæ‰‹æ¶ï¼Œå¤æ‚ç¨‹åº¦è‡ªç„¶ä¹Ÿä¸å¤ªä¸€æ ·ã€‚ä½†æ˜¯æ€»ä½“æ¥è¯´ï¼Œè„šæ‰‹æ¶çš„å·¥ä½œå¤§ä½“éƒ½ä¼šåŒ…å«å‡ ä¸ªæ­¥éª¤ï¼š\r\n\r\n- åˆå§‹åŒ–ï¼Œä¸€èˆ¬åœ¨è¿™ä¸ªæ—¶å€™ä¼šè¿›è¡Œç¯å¢ƒçš„åˆå§‹åŒ–ï¼Œåšä¸€äº›å‰ç½®çš„æ£€æŸ¥\r\n- ç”¨æˆ·è¾“å…¥ï¼Œä¾‹å¦‚ç”¨ vue-cli çš„æ—¶å€™ï¼Œå®ƒä¼šâ€œé—®â€ä½ å¾ˆå¤šé…ç½®é€‰é¡¹\r\n- ç”Ÿæˆé…ç½®æ–‡ä»¶\r\n- ç”Ÿæˆé¡¹ç›®ç»“æ„ï¼Œè¿™æ˜¯å€™å¯èƒ½ä¼šä½¿ç”¨ä¸€ä¸ªé¡¹ç›®æ¨¡ç‰ˆ\r\n- å®‰è£…ä¾èµ–\r\n- æ¸…ç†ã€æ ¡éªŒç­‰æ”¶å°¾å·¥ä½œ\r\n\r\næ­¤å¤–ï¼Œä½ è¿˜éœ€è¦å¤„ç†å‘½ä»¤è¡Œè¡Œä¸ºç­‰ã€‚å¾€å¾€æˆ‘ä»¬åªæ˜¯æƒ³è½»é‡çº§ã€å¿«é€Ÿå¾—åˆ›å»ºä¸€ä¸ªç‰¹å®šåœºæ™¯çš„è„šæ‰‹æ¶ï¼ˆä¸ç”¨æƒ³vue-clié‚£ä¹ˆå®Œå¤‡ï¼‰ã€‚è€Œå¯¹äºæƒ³è¦å¿«é€Ÿåˆ›å»ºä¸€ä¸ªè„šæ‰‹æ¶ï¼Œå…¶å®æˆ‘ä»¬ä¸ç”¨å®Œå…¨ä»é›¶å¼€å§‹ã€‚[Yeoman](https://yeoman.io/) å°±æ˜¯ä¸€ä¸ªå¯ä»¥å¸®æˆ‘ä»¬å¿«é€Ÿåˆ›å»ºè„šæ‰‹æ¶çš„å·¥å…·ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/5/16/16ac137b8509c628?w=2296&h=854&f=png&s=377965)\r\n\r\nå¯èƒ½å¾ˆå¤šåŒå­¦éƒ½ä¸å¤ªäº†è§£ï¼Œé‚£ä¹ˆå…ˆç®€å•ä»‹ç»ä¸€ä¸‹ Yeoman æ˜¯ä»€ä¹ˆï¼Œåˆæ˜¯å¦‚ä½•å¸®æˆ‘ä»¬æ¥ç®€åŒ–è„šæ‰‹æ¶æ­å»ºçš„ã€‚\r\n\r\né¦–å…ˆï¼ŒYeoman å¯ä»¥ç®€å•ç†è§£ä¸ºæ˜¯ä¸€ä¸ªè„šæ‰‹æ¶çš„è¿è¡Œæ¡†æ¶ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªè„šæ‰‹æ¶åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ‰€è¦ç»å†çš„å„ä¸ªé˜¶æ®µï¼ˆä¾‹å¦‚æˆ‘ä»¬ä¸Šé¢è¯´çš„ï¼Œå¯èƒ½ä¼šå…ˆè¯»å–ç”¨æˆ·è¾“å…¥ï¼Œç„¶åç”Ÿæˆé¡¹ç›®æ–‡ä»¶ï¼Œæœ€åå®‰è£…ä¾èµ–ï¼‰ï¼Œæˆ‘ä»¬æ‰€éœ€è¦çš„å°±æ˜¯åœ¨ç”Ÿå‘½å‘¨æœŸçš„å¯¹åº”é˜¶æ®µï¼Œå¡«å……å¯¹åº”çš„æ“ä½œä»£ç å³å¯ã€‚è€Œæˆ‘ä»¬å¡«å……ä»£ç çš„åœ°æ–¹ï¼Œåœ¨ Yeoman ä¸­å«åš generatorï¼Œç‰©å¦‚å…¶åï¼ŒYeoman é€šè¿‡è°ƒç”¨æŸä¸ª generator å³å¯ç”Ÿæˆï¼ˆgenerateï¼‰å¯¹åº”çš„é¡¹ç›®ã€‚\r\n\r\nå¦‚æœä½ è¿˜ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šå®ƒä»¬ä¹‹é—´çš„å…³ç³»ï¼Œé‚£ä¹ˆå¯ä»¥ä¸¾ä¸ªå°ä¾‹å­ï¼š\r\n\r\nå°†è„šæ‰‹æ¶å¼€å‘ç±»æ¯”ä¸ºå‰ç«¯ç»„ä»¶å¼€å‘ï¼ŒYeoman çš„è§’è‰²å°±åƒæ˜¯ Reactï¼Œæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œå°¤å…¶æ˜¯å®šä¹‰äº†ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼›è€Œ generator ç±»ä¼¼äºä½ å†™çš„ä¸€ä¸ª React ä¸šåŠ¡ç»„ä»¶ï¼Œæ ¹æ® React çš„è§„åˆ™åœ¨å„ä¸ªç”Ÿå‘½å‘¨æœŸä¸­å¡«ä»£ç å³å¯ã€‚\r\n\r\n[Yeoman å†…ç½®çš„â€œç”Ÿå‘½å‘¨æœŸâ€æ–¹æ³•æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š](https://yeoman.io/authoring/running-context.html#the-run-loop)\r\n\r\n1. initializing\r\n2. prompting\r\n3. default\r\n4. writing\r\n5. conflicts\r\n6. install\r\n7. end\r\n\r\nå…¶ä¸­ default é˜¶æ®µä¼šæ‰§è¡Œä½ è‡ªå®šä¹‰åœ°å„ç§æ–¹æ³•ã€‚\r\n\r\nåŒæ—¶ï¼ŒYeoman è¿˜é›†æˆäº†è„šæ‰‹æ¶å¼€å‘ä¸­å¸¸ç”¨çš„å„ç±»å·¥å…·ï¼Œåƒæ˜¯æ–‡ä»¶æ“ä½œã€æ¨¡ç‰ˆå¡«å……ã€ç»ˆç«¯ä¸Šçš„ç”¨æˆ·äº¤äº’åŠŸèƒ½ï¼Œå‘½ä»¤è¡Œç­‰ï¼Œå¹¶ä¸”å°è£…æˆäº†ç®€å•æ˜“ç”¨çš„æ–¹æ³•ã€‚\r\n\r\né€šè¿‡è¿™ä¸¤ç‚¹ï¼ŒYeoman å¯ä»¥å¸®æˆ‘ä»¬å¤§å¤§è§„èŒƒä¸ç®€åŒ–è„šæ‰‹æ¶çš„å¼€å‘ã€‚\r\n\r\n## 2. å¼€å‘ä¸€ä¸ªè‡ªå·±çš„è„šæ‰‹æ¶\r\n\r\näº†è§£äº†ä¸€äº›è„šæ‰‹æ¶çš„å·¥ä½œæ–¹å¼ä¸ Yeoman çš„åŸºæœ¬æ¦‚å¿µï¼Œå’±ä»¬å°±å¯ä»¥æ¥åˆ›å»ºä¸€ä¸ªå±äºè‡ªå·±çš„è„šæ‰‹æ¶ã€‚ä½œä¸ºä¾‹å­ï¼Œè¿™ä¸ªè„šæ‰‹æ¶çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œå®ƒä¼šä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæœ€ç®€ç‰ˆçš„åŸºäº Webpack çš„å‰ç«¯é¡¹ç›®ã€‚æœ€ç»ˆè„šæ‰‹æ¶ä½¿ç”¨æ•ˆæœå¦‚ä¸‹ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/5/16/16ac081750971790?w=1312&h=533&f=gif&s=1477981)\r\n\r\n### 2.1. å‡†å¤‡ä¸€ä¸ªé¡¹ç›®æ¨¡ç‰ˆ\r\n\r\nè„šæ‰‹æ¶æ˜¯å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿç”Ÿæˆä¸€å¥—æ—¢å®šçš„é¡¹ç›®æ¶æ„ã€æ–‡ä»¶ã€é…ç½®ï¼Œè€Œæœ€å¸¸è§çš„åšæ³•çš„å°±æ˜¯å…ˆå†™å¥½ä¸€å¥—é¡¹ç›®æ¡†æ¶æ¨¡ç‰ˆï¼Œç­‰åˆ°è„šæ‰‹æ¶è¦ç”Ÿæˆé¡¹ç›®æ—¶ï¼Œåˆ™å°†è¿™å¥—æ¨¡ç‰ˆæ‹·è´åˆ°ç›®æ ‡ç›®å½•ä¸‹ã€‚è¿™é‡Œå…¶å®ä¼šæœ‰ä¸¤ä¸ªå°ç‚¹éœ€è¦å…³æ³¨ã€‚\r\n\r\nç¬¬ä¸€ä¸ªæ˜¯æ¨¡ç‰ˆå†…å˜é‡çš„å¡«å……ã€‚\r\n\r\nåœ¨æ¨¡ç‰ˆä¸­çš„æŸäº›æ–‡ä»¶å†…å®¹å¯èƒ½ä¼šéœ€è¦ç”Ÿæˆæ—¶åŠ¨æ€æ›¿æ¢ï¼Œä¾‹å¦‚æ ¹æ®ç”¨æˆ·åœ¨ç»ˆç«¯ä¸­è¾“å…¥çš„å†…å®¹ï¼ŒåŠ¨æ€å¡«å……`package.json`ä¸­çš„`name`å€¼ã€‚è€Œ Yeoman å†…ç½®äº† [ejs](https://github.com/mde/ejs) ä½œä¸ºæ¨¡ç‰ˆå¼•æ“ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚\r\n\r\nç¬¬äºŒä¸ªå°±æ˜¯æ¨¡ç‰ˆçš„æ”¾ç½®ä½ç½®ã€‚\r\n\r\nä¸€ç§æ˜¯ç›´æ¥æ”¾åœ¨æœ¬åœ°ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥æ”¾åˆ° generator ä¸­ï¼Œè·Ÿéš generator ä¸€èµ·ä¸‹è½½ï¼Œæ¯æ¬¡å®‰è£…éƒ½æ˜¯æœ¬åœ°æ‹·è´ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œä½†æ˜¯é¡¹ç›®æ¨¡ç‰ˆè‡ªèº«çš„æ›´æ–°å‡çº§æ¯”è¾ƒå›°éš¾ï¼Œéœ€è¦æç¤ºç”¨æˆ·å‡çº§ generatorã€‚\r\n\r\nå¦ä¸€ç§åˆ™æ˜¯å°†æ¨¡ç‰ˆæ–‡ä»¶æ”¾åˆ°æŸä¸ªæœåŠ¡å™¨ä¸Šï¼Œæ¯æ¬¡ä½¿ç”¨è„šæ‰‹æ¶åˆå§‹åŒ–æ—¶é€šè¿‡æŸä¸ªåœ°å€åŠ¨æ€ä¸‹è½½ï¼Œæƒ³è¦æ›´æ–°å‡çº§æ¨¡ç‰ˆä¼šå¾ˆæ–¹ä¾¿ï¼Œé€šå¸¸ä¼šé€‰æ‹©æ‰˜ç®¡åœ¨ github ä¸Šã€‚\r\n\r\nå…³äºç¬¬äºŒä¸ªæ¨¡ç‰ˆæ”¾ç½®ç©¶ç«Ÿæ˜¯é€‰æ‹©åœ¨æœ¬åœ°å¥½ï¼Œè¿˜æ˜¯è¿œç«¯å¥½ï¼Œå…¶å®è¿˜æ˜¯ä¾æ®ä½ ä¸ªäººçš„ä¸šåŠ¡åœºæ™¯è€Œå®šï¼Œåœ¨ä¸åŒçš„åœºæ™¯çš„é™åˆ¶çš„éœ€æ±‚ä¸åŒï¼Œæˆ‘ä¹‹å‰æ—¢å†™è¿‡æ¨¡ç‰ˆæ”¾åœ¨æœ¬åœ°çš„è„šæ‰‹æ¶ï¼ˆå³å’Œè„šæ‰‹æ¶ä¸€èµ·é€šè¿‡ npm å®‰è£…ï¼‰ï¼Œä¹Ÿå†™è¿‡æ‰˜ç®¡åœ¨ git ä»“åº“ä¸Šçš„è¿™ç§æ–¹å¼ã€‚\r\n\r\nå›åˆ°æˆ‘ä»¬ã€Œåˆ›å»ºä¸€ä¸ªæœ€ç®€ç‰ˆçš„åŸºäº Webpack çš„å‰ç«¯é¡¹ç›®ã€çš„ç›®æ ‡ï¼Œæˆ‘å‡†å¤‡äº†ä¸€ä¸ª[é¡¹ç›®æ¨¡ç‰ˆ](https://github.com/alienzhou/webpack-kickoff-template)ï¼Œä¹‹åå°±ä¼šç”¨å®ƒæ¥ä½œä¸ºè„šæ‰‹æ¶ç”Ÿæˆçš„é¡¹ç›®å†…å®¹ã€‚\r\n\r\n### 2.2. åˆ›å»º generatorï¼ˆyeoman-generatorï¼‰\r\n\r\nåˆ›å»º Yeoman çš„ generator éœ€è¦éµå¾ªå®ƒçš„è§„åˆ™ã€‚\r\n\r\né¦–å…ˆæ˜¯ generator å‘½åè§„åˆ™ã€‚éœ€è¦ä»¥`generator`æ‰“å¤´ï¼Œæ¨ªçº¿è¿æ¥ã€‚ä¾‹å¦‚ä½ æƒ³åˆ›å»ºä¸€ä¸ªåä¸º webpack-kickoff çš„ generatorï¼ŒåŒ…åéœ€è¦å–æˆ `generator-webpack-kickoff`ã€‚\r\n\r\nè¿™æ ·ï¼Œå½“ä½ é€šè¿‡\r\n\r\n```bash\r\nnpm i -g yo\r\n```\r\n\r\nå®‰è£…å®Œ Yeoman çš„ CLI åï¼Œå°±å¯ä»¥é€šè¿‡`yo`å‘½ä»¤æ¥ä½¿ç”¨ generator æ¥å¯åŠ¨è„šæ‰‹æ¶ï¼š\r\n\r\n```\r\nyo webpack-kickoff\r\n```\r\n\r\nè¿™é‡Œçš„ webpack-kickoff å°±æ˜¯åŒ…åé‡Œ`generator-`åé¢çš„å†…å®¹ï¼ŒYeoman ä¼šæŒ‰è¿™ä¸ªè§„åˆ™å»å…¨å±€æ‰¾ç›¸åŒ¹é…çš„åŒ…ã€‚\r\n\r\nå…¶æ¬¡ï¼Œä¾æ® Yeoman çš„è§„èŒƒï¼Œé»˜è®¤æƒ…å†µä¸‹ä½ éœ€è¦åœ¨é¡¹ç›®ï¼ˆå³ generatorï¼‰çš„`generators/app/`ç›®å½•ä¸‹åˆ›å»º`index.js`ï¼Œåœ¨å…¶ä¸­å†™å…¥ä½ çš„è„šæ‰‹æ¶å·¥ä½œæµç¨‹ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡[ä¿®æ”¹é…ç½®æ¥æ‰©å±•æˆ–æ”¹å˜è¿™ä¸ªè§„åˆ™](https://yeoman.io/authoring/index.html#folder-tree)ã€‚\r\n\r\næ­¤å¤–ï¼Œä½ åˆ›å»ºçš„ generator ç±»éœ€è¦ç»§æ‰¿ yeoman-generatorã€‚æ‰€ä»¥æˆ‘ä»¬ä¼šåœ¨`generators/app/index.js`ä¸­å†™å¦‚ä¸‹ä»£ç ï¼š\r\n\r\n```JavaScript\r\nconst Generator = require('yeoman-generator');\r\nclass WebpackKickoffGenerator extends Generator {\r\n    constructor(params, opts) {\r\n        super(params, opts);\r\n    }\r\n}\r\nmodule.exports = WebpackKickoffGenerator;\r\n```\r\n\r\nè¿˜è®°å¾—ä¹‹å‰æåˆ°çš„â€œç”Ÿå‘½å‘¨æœŸâ€æ–¹æ³•ä¹ˆï¼ŸåŒ…æ‹¬ initializingã€promptingã€defaultã€writingã€conflictsã€install å’Œ endã€‚é™¤äº†`default`ï¼Œå…¶ä»–éƒ½ä»£è¡¨äº† Generator ä¸­çš„ä¸€ä¸ªåŒåæ–¹æ³•ï¼Œä½ éœ€è¦çš„å°±æ˜¯åœ¨å­ç±»ä¸­é‡å†™åæ‰€éœ€çš„å¯¹åº”æ–¹æ³•ã€‚`default`é˜¶æ®µåˆ™ä¼šæ‰§è¡Œç”¨æˆ·å®šä¹‰çš„ç±»æ–¹æ³•ã€‚\r\n\r\nä¾‹å¦‚ï¼Œä½ æƒ³åœ¨åˆå§‹åŒ–æ—¶æ‰“å°ä¸‹ç‰ˆæœ¬ä¿¡æ¯ï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š\r\n\r\n```JavaScript\r\nconst Generator = require('yeoman-generator');\r\nclass WebpackKickoffGenerator extends Generator {\r\n    constructor(params, opts) {\r\n        super(params, opts);\r\n    }\r\n    \r\n    initializing() {\r\n        const version = require('../../package.json').version;\r\n        this.log(version);\r\n    }\r\n}\r\nmodule.exports = WebpackKickoffGenerator;\r\n```\r\n\r\nå¯è§ï¼Œå‰©ä¸‹çš„å·¥ä½œå°±æ˜¯åœ¨ WebpackKickoffGenerator ç±»ä¸­å¡«å……å„ç§æ–¹æ³•çš„å®ç°ç»†èŠ‚äº†ã€‚\r\n\r\n### 2.3. å¤„ç†ç”¨æˆ·äº¤äº’\r\n\r\nè„šæ‰‹æ¶å·¥ä½œä¸­ä¸€èˆ¬éƒ½ä¼šæœ‰ä¸€äº›ç”¨æˆ·è‡ªå®šä¹‰çš„å†…å®¹ï¼Œä¾‹å¦‚åˆ›å»ºçš„é¡¹ç›®ç›®å½•åï¼Œæˆ–è€…æ˜¯å¦å¯ç”¨æŸä¸ªé…ç½®ç­‰ã€‚è¿™äº›äº¤äº’ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡äº¤äº’å¼çš„ç»ˆç«¯æ¥å®ç°çš„ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ªåŠŸèƒ½ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/5/16/16ac080688a52242?w=810&h=227&f=png&s=30134)\r\n\r\nå¯ä»¥ä½¿ç”¨ [Inquirer.js](https://github.com/SBoudrias/Inquirer.js) æ¥å®ç°ã€‚è€Œ Yeoman å·²ç»å¸®æˆ‘ä»¬é›†æˆå¥½äº†ï¼Œç›´æ¥åœ¨ generator é‡Œè°ƒç”¨ `this.prompt` å³å¯ã€‚\r\n\r\nåœ¨ç”¨æˆ·äº¤äº’éƒ¨åˆ†çš„éœ€æ±‚ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦è¯¢é—®ç”¨æˆ·æ‰€éœ€åˆ›å»ºçš„é¡¹ç›®ç›®å½•åå³å¯ï¼Œéšåä¹Ÿä¼šä½œä¸ºé¡¹ç›®åã€‚æŒ‰ç…§ Yeoman çš„æµç¨‹è§„èŒƒï¼Œæˆ‘ä»¬å°†è¯¥éƒ¨åˆ†ä»£ç å†™åœ¨ `prompting` æ–¹æ³•ä¸­ï¼š\r\n\r\n```JavaScript\r\nclass WebpackKickoffGenerator extends Generator {\r\n    // â€¦â€¦\r\n    prompting() {\r\n        const done = this.async();\r\n\r\n        const opts = [{\r\n            type: 'input',\r\n            name: 'dirName',\r\n            message: 'Please enter the directory name for your projectï¼š',\r\n            default: 'webpack-app',\r\n            validate: dirName => {\r\n                if (dirName.length < 1) {\r\n                    return 'âš ï¸  directory name must not be nullï¼';\r\n                }\r\n                return true;\r\n            }\r\n        }];\r\n\r\n        return this.prompt(opts).then(({dirName}) => {\r\n            this.dirName = dirName;\r\n            done();\r\n        });\r\n    }\r\n    // â€¦â€¦\r\n}\r\n```\r\n\r\næ³¨æ„ï¼Œç”±äºç”¨æˆ·äº¤äº’æ˜¯ä¸€ä¸ªâ€œå¼‚æ­¥â€çš„è¡Œä¸ºï¼Œä¸ºäº†è®©åç»­ç”Ÿå‘½å‘¨æœŸæ–¹æ³•åœ¨â€œå¼‚æ­¥â€å®Œæˆåå†ç»§ç»­æ‰§è¡Œï¼Œéœ€è¦è°ƒç”¨`this.async()`æ–¹æ³•æ¥é€šçŸ¥æ–¹æ³•ä¸ºå¼‚æ­¥æ–¹æ³•ï¼Œé¿å…é¡ºåºæ‰§è¡Œå®ŒåŒæ­¥ä»£ç åç›´æ¥è°ƒç”¨ä¸‹ä¸€é˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚è°ƒç”¨åä¼šè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œå‡½æ•°è¡¨æ˜è¯¥é˜¶æ®µå®Œæˆã€‚\r\n\r\n### 2.4. ä¸‹è½½æ¨¡ç‰ˆ\r\n\r\næ­£å¦‚2.1.ä¸­æ‰€è¿°ï¼Œæˆ‘ä»¬é€‰æ‹©å°†æ¨¡ç‰ˆæ‰˜ç®¡åœ¨ [github](https://github.com/alienzhou/webpack-kickoff-template) ä¸Šï¼Œå› æ­¤åœ¨ç”Ÿæˆå…·ä½“é¡¹ç›®ä»£ç å‰ï¼Œéœ€è¦å°†ç›¸åº”çš„æ–‡ä»¶ä¸‹è½½ä¸‹æ¥ã€‚å¯ä»¥ä½¿ç”¨ [download-git-repo](https://github.com/flipxfx/download-git-repo) æ¥å¿«é€Ÿå®ç°ã€‚\r\n\r\n```JavaScript\r\nclass WebpackKickoffGenerator extends Generator {\r\n    // â€¦â€¦\r\n    _downloadTemplate() {\r\n        return new Promise((resolve, reject) => {\r\n            const dirPath = this.destinationPath(this.dirName, '.tmp');\r\n            download('alienzhou/webpack-kickoff-template', dirPath, err => {\r\n                if (err) {\r\n                    reject(err);\r\n                    return;\r\n                }\r\n                resolve();\r\n            });\r\n        });\r\n    }\r\n    // â€¦â€¦\r\n}\r\n```\r\n\r\nè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†`this.destinationPath()`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸»è¦ç”¨äºè·å–è·¯å¾„ã€‚ä¸ä¼ å‚æ—¶è¿”å›å½“å‰å‘½ä»¤è¡Œè¿è¡Œçš„ç›®å½•ï¼›å¦‚æœæ”¶åˆ°å¤šä¸ªå‚æ•°ï¼Œåˆ™ä¼šè¿›è¡Œè·¯å¾„çš„æ‹¼æ¥ã€‚\r\n\r\næ­¤å¤–ï¼Œå¦‚æœä½ ç»†å¿ƒçš„è¯ï¼Œä¼šå‘ç°`_downloadTemplate()`æ–¹æ³•å¸¦äº†ä¸€ä¸ªä¸‹åˆ’çº¿å‰ç¼€ã€‚è¿™æ˜¯ Yeoman ä¸­çš„ä¸€ä¸ªçº¦å®šï¼šYeoman æ‰§è¡Œé¡ºåºä¸­æœ‰ä¸ª`default`é˜¶æ®µï¼Œè¯¥é˜¶æ®µåŒ…å«äº†æ‰€æœ‰ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œå¦‚æœæŸäº›æ–¹æ³•ä½ ä¸å¸Œæœ›è¢« Yeoman çš„è„šæ‰‹æ¶æµç¨‹ç›´æ¥è°ƒç”¨ï¼Œè€Œæ˜¯ä½œä¸ºå·¥å…·æ–¹æ³•æä¾›ç»™å…¶ä»–ç±»æ–¹æ³•ï¼Œåˆ™å¯ä»¥æ·»åŠ ä¸€ä¸ªä¸‹åˆ’çº¿å‰ç¼€ã€‚å¯¹äºè¿™ç§å‘½åçš„æ–¹æ³•ï¼Œåˆ™ä¼šåœ¨`default`é˜¶æ®µè¢«å¿½ç•¥ã€‚\r\n\r\n### 2.5. æ¨¡ç‰ˆæ–‡ä»¶æ‹·è´\r\n\r\né¡¹ç›®æ¨¡ç‰ˆä¸‹è½½å®Œæ¯•åï¼Œä¸‹é¢å°±å¯ä»¥å°†ç›¸å…³çš„ç›®å½•ã€æ–‡ä»¶æ‹·è´åˆ°ç›®æ ‡æ–‡ä»¶å¤¹ä¸­ã€‚è¿™äº›éƒ½å¯ä»¥åœ¨`writing`é˜¶æ®µæ“ä½œã€‚æ­¤æ—¶éœ€è¦éå†æ¨¡ç‰ˆä¸­çš„æ‰€æœ‰ç›®å½•ï¼Œå°†æ‰€æœ‰æ–‡ä»¶è¿›è¡Œæ¨¡ç‰ˆå¡«å……ä¸æ‹·è´ã€‚éå†æ–¹å¼å¦‚ä¸‹ï¼š\r\n\r\n```JavaScript\r\nclass WebpackKickoffGenerator extends Generator {\r\n    // â€¦â€¦\r\n    _walk(filePath, templateRoot) {\r\n        if (fs.statSync(filePath).isDirectory()) {\r\n            fs.readdirSync(filePath).forEach(name => {\r\n                this._walk(path.resolve(filePath, name), templateRoot);\r\n            });\r\n            return;\r\n        }\r\n\r\n        const relativePath = path.relative(templateRoot, filePath);\r\n        const destination = this.destinationPath(this.dirName, relativePath);\r\n        this.fs.copyTpl(filePath, destination, {\r\n            dirName: this.dirName\r\n        });\r\n    }\r\n    // â€¦â€¦\r\n}\r\n```\r\n\r\nè¿™é‡Œä½¿ç”¨äº†`this.fs.copyTpl()`æ–¹æ³•ï¼Œå®ƒæ”¯æŒæ–‡ä»¶æ‹·è´ï¼ŒåŒæ—¶è¿˜å¯ä»¥æŒ‡å®šç›¸åº”çš„æ¨¡ç‰ˆå‚æ•°ï¼Œæ­¤å¤–ï¼Œå¦‚æœå‡ºç°é‡åè¦†ç›–æƒ…å†µä¼šåœ¨æ§åˆ¶å°è‡ªåŠ¨è¾“å‡ºç›¸åº”ä¿¡æ¯ã€‚\r\n\r\næœ€åï¼ŒæŠŠä¸‹è½½ä¸æ‹·è´æ•´åˆèµ·æ¥å³å¯å®Œæˆ`writing`é˜¶æ®µã€‚\r\n\r\n```JavaScript\r\nclass WebpackKickoffGenerator extends Generator {\r\n    // â€¦â€¦\r\n    writing() {\r\n        const done = this.async();\r\n        this._downloadTemplate()\r\n            .then(() => {\r\n                const templateRoot = this.destinationPath(this.dirName, '.tmp');\r\n                this._walk(templateRoot, templateRoot);\r\n                fs.removeSync(templateRoot);\r\n                done();\r\n            })\r\n            .catch(err => {\r\n                this.env.error(err);\r\n            });\r\n    }\r\n    // â€¦â€¦\r\n}\r\n```\r\n\r\n### 2.6. ä¾èµ–å®‰è£…\r\n\r\nåˆ°ç›®å‰ï¼Œè„šæ‰‹æ¶å·²ç»å¯ä»¥å¸®æˆ‘ä»¬æŠŠé¡¹ç›®å¼€å‘æ‰€éœ€çš„é…ç½®ã€ç›®å½•ç»“æ„ã€ä¾èµ–æ¸…å•éƒ½å‡†å¤‡å¥½äº†ã€‚è¿™æ—¶å€™å¯ä»¥è¿›ä¸€æ­¥å¸®å¼€å‘äººå‘˜å°†ä¾èµ–å®‰è£…å®Œæ¯•ï¼Œè¿™æ ·è„šæ‰‹æ¶åˆ›å»ºé¡¹ç›®å®Œæˆåï¼Œå¼€å‘äººå‘˜å°±å¯ä»¥ç›´æ¥å¼€å‘äº†ã€‚\r\n\r\nYeoman ä¹Ÿæä¾›äº†`this.npmInstall()`æ¥æ–¹æ³•æ¥å®ç° npm åŒ…çš„å®‰è£…ï¼š\r\n\r\n```JavaScript\r\nclass WebpackKickoffGenerator extends Generator {\r\n    // â€¦â€¦\r\n    install() {\r\n        this.npmInstall('', {}, {\r\n            cwd: this.destinationPath(this.dirName)\r\n        });\r\n    }\r\n    // â€¦â€¦\r\n}\r\n```\r\n\r\nåˆ°è¿™é‡Œï¼Œè„šæ‰‹æ¶çš„æ ¸å¿ƒåŠŸèƒ½å°±å®Œæˆäº†ã€‚å·²ç»å¯ä»¥ä½¿ç”¨å’±ä»¬çš„è¿™ä¸ª generator æ¥å¿«é€Ÿåˆ›å»ºé¡¹ç›®äº†ã€‚å¾ˆç®€å•å§~\r\n\r\n> å®Œæ•´çš„ä»£ç å¯ä»¥å‚è€ƒ [generator-webpack-kickoff](https://github.com/alienzhou/generator-webpack-kickoff)ã€‚\r\n\r\n## 3. ä½¿ç”¨è„šæ‰‹æ¶ ğŸš€\r\n\r\nä½¿ç”¨è¯¥è„šæ‰‹æ¶ä¼šåŒæ—¶éœ€è¦ Yeoman ä¸ä¸Šè¿°å’±ä»¬åˆšåˆ›å»ºçš„ yeoman-generatorã€‚å½“ç„¶ï¼Œæœ‰ä¸€ä¸ªå‰æï¼ŒYeoman ä¸è¿™ä¸ª generator éƒ½éœ€è¦å…¨å±€å®‰è£…ã€‚å…¨å±€å®‰è£… Yeoman æ²¡å•¥æœ‰é—®é¢˜ï¼ˆ`npm install -g yo`ï¼‰ï¼Œå¤„ç† generator-webpack-kickoff çš„è¯å¯èƒ½æœ‰å‡ ç§æ–¹å¼ï¼š\r\n\r\n1. ç›´æ¥å‘å¸ƒåˆ° npmï¼Œç„¶åæ­£å¸¸å…¨å±€å®‰è£…\r\n2. ç›´æ¥æ‰‹åŠ¨æ‹·è´åˆ°å…¨å±€ node_modules\r\n3. ä½¿ç”¨`npm link`å°†æŸä¸ªç›®å½•é“¾æ¥åˆ°å…¨å±€\r\n\r\nä¾æ®2.2.èŠ‚çš„å†…å®¹ï¼Œå’±ä»¬çš„ generator åç§°ä¸º generator-webpack-kickoffã€‚ç”±äºæˆ‘çš„åŒ…å·²ç»å‘åˆ° npm ä¸Šäº†ï¼Œæ‰€ä»¥è¦ä½¿ç”¨è¯¥è„šæ‰‹æ¶å¯ä»¥è¿è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š\r\n\r\n```bash\r\n# å®‰è£…ä¸€æ¬¡å³å¯\r\nnpm i -g yo\r\nnpm i -g generator-webpack-kickoff\r\n\r\n# å¯åŠ¨è„šæ‰‹æ¶\r\nyo webpack-kickoff\r\n```\r\n\r\n## 4. ä¼˜åŒ–\r\n\r\nä»ä¸Šæ–‡è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œå®ç°ä¸€ä¸ªè„šæ‰‹æ¶éå¸¸ç®€å•ã€‚ä¾‹å­è™½å°ï¼Œä½†ä¹ŸåŒ…å«äº†è„šæ‰‹æ¶å¼€å‘çš„ä¸»è¦éƒ¨åˆ†ã€‚å½“ç„¶ï¼Œè¿™ç¯‡æ–‡ç« ä¸ºäº†ç®€åŒ–ï¼Œçœç•¥äº†ä¸€äº›â€œä¼˜åŒ–â€åŠŸèƒ½ã€‚ä¾‹å¦‚\r\n\r\n- é¡¹ç›®ç›®å½•çš„é‡åæ£€æµ‹ï¼Œç”Ÿæˆé¡¹ç›®æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦ç›®å½•å·²å­˜åœ¨ï¼Œå¹¶æç¤ºè­¦å‘Š\r\n- é¡¹ç›®æ¨¡ç‰ˆçš„ç¼“å­˜ã€‚è™½ç„¶æˆ‘ä»¬ä½¿ç”¨ github æ‰˜ç®¡æ–¹å¼ï¼Œä½†ä¹Ÿå¯ä»¥è€ƒè™‘ä¸å¿…æ¯æ¬¡éƒ½é‡æ–°ä¸‹è½½ï¼Œå¯ä»¥æ”¾ä¸€ä»½æœ¬åœ°ç¼“å­˜ï¼Œç„¶åæ¯å¤©æˆ–æ¯å‘¨æ›´æ–°ï¼›\r\n- CLI çš„ä¼˜åŒ–ã€‚[å®Œæ•´ç‰ˆ](https://github.com/alienzhou/generator-webpack-kickoff)é‡Œè¿˜ä¼šåŒ…å«ä¸€äº›æ›´ä¸°å¯Œçš„ CLI ä½¿ç”¨ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨åŠ¨å›¾ä¸­çœ‹åˆ°çš„ loading æ•ˆæœã€å¤´å°¾æ˜¾ç¤ºçš„ä¿¡æ¯é¢æ¿ç­‰ã€‚è¿™äº›å·¥å…·åŒ…æ‹¬\r\n    - [ora](https://github.com/sindresorhus/ora)ï¼Œç”¨äºåˆ›å»º spinnerï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æ‰€è¯´çš„ loading æ•ˆæœ\r\n    - [chalk](https://github.com/chalk/chalk)ï¼Œç”¨äºæ‰“å°å½©è‰²çš„ä¿¡æ¯\r\n    - [update-notifier](https://github.com/yeoman/update-notifier)ï¼Œç”¨äºæ£€æŸ¥åŒ…çš„çº¿ä¸Šç‰ˆæœ¬ä¸æœ¬åœ°ç‰ˆæœ¬\r\n    - [beeper](https://github.com/sindresorhus/beeper)ï¼Œå¯ä»¥â€œå“”â€ä¸€ä¸‹ä½ ï¼Œä¾‹å¦‚å‡ºé”™çš„æ—¶å€™\r\n    - [boxen](https://github.com/sindresorhus/boxen)ï¼Œåˆ›å»ºå¤´å°¾çš„é‚£ä¸ªå°â€œé¢æ¿â€\r\n- ç‰ˆæœ¬æ£€æŸ¥ã€‚ä¸Šé¢æåˆ°å¯ä»¥ç”¨ [update-notifier](https://github.com/yeoman/update-notifier) æ¥æ£€æŸ¥ç‰ˆæœ¬ã€‚æ‰€ä»¥å¯ä»¥åœ¨ initializing é˜¶æ®µè¿›è¡Œç‰ˆæœ¬æ£€æŸ¥ï¼Œæç¤ºç”¨æˆ·æ›´æ–°è„šæ‰‹æ¶ã€‚\r\n\r\n## æœ€å\r\n\r\næœ¬æ–‡é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥å‘Šè¯‰å¤§å®¶å¦‚ä½•ä½¿ç”¨ Yeoman å¿«é€Ÿåˆ›å»ºè„šæ‰‹æ¶ã€‚è¦äº†è§£æ›´å¤š yeoman-generator çš„å¼€å‘ä¸ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒ[ç¤¾åŒºé‡Œå¤§å®¶å†™çš„å„ç±» generator](keywords:yeoman-generator)ã€‚ç›®å‰åœ¨ npm ä¸Šæœ‰è¶…è¿‡ 8000 ä¸ª yeoman-generatorï¼Œä¹Ÿè®¸å°±ä¼šæœ‰ä½ çš„èœã€‚\r\n\r\n> æ–‡ä¸­å®Œæˆçš„ä»£ç è¯·æŸ¥çœ‹ [generator-webpack-kickoff](https://github.com/alienzhou/generator-webpack-kickoff)ã€‚","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/28","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/28/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/28/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/28/events","html_url":"https://github.com/alienzhou/blog/issues/28","id":436120642,"node_id":"MDU6SXNzdWU0MzYxMjA2NDI=","number":28,"title":"âœ¨å¦‚ä½•å®ç°ä¸€ä¸ªé€šç”¨çš„â€œåˆ’è¯é«˜äº®â€åœ¨çº¿ç¬”è®°åŠŸèƒ½ï¼Ÿâœ¨ğŸ–ï¸","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845014,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE0","url":"https://api.github.com/repos/alienzhou/blog/labels/JavaScript","name":"JavaScript","color":"d73a4a","default":false,"description":""},{"id":1159845015,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E6%B5%8F%E8%A7%88%E5%99%A8","name":"æµè§ˆå™¨","color":"cfd3d7","default":false,"description":""},{"id":1159845016,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%BB%BC%E5%90%88","name":"ç»¼åˆ","color":"a2eeef","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2019-04-23T10:45:18Z","updated_at":"2019-10-30T01:50:06Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## 1. ä»€ä¹ˆæ˜¯â€œåˆ’è¯é«˜äº®â€ï¼Ÿ\r\n\r\næœ‰äº›åŒå­¦å¯èƒ½ä¸å¤ªæ¸…æ¥šâ€œåˆ’è¯é«˜äº®â€æ˜¯æŒ‡ä»€ä¹ˆï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œåˆ’è¯é«˜äº®â€ï¼š\r\n\r\n[![](http://upload-images.jianshu.io/upload_images/6476654-54773175bfd4fa3f?imageMogr2/auto-orient/strip)](https://alienzhou.github.io/web-highlighter/)\r\n\r\nä¸Šå›¾çš„ç¤ºä¾‹ç½‘ç«™å¯ä»¥[ç‚¹å‡»è¿™é‡Œè®¿é—®](https://alienzhou.github.io/web-highlighter/)ã€‚ç”¨æˆ·é€‰æ‹©ä¸€æ®µæ–‡æœ¬ï¼ˆå³åˆ’è¯ï¼‰ï¼Œå³ä¼šè‡ªåŠ¨å°†è¿™æ®µé€‰å–çš„æ–‡æœ¬æ·»åŠ é«˜äº®èƒŒæ™¯ï¼Œç”¨æˆ·å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä¸ºç½‘é¡µæ·»åŠ åœ¨çº¿ç¬”è®°ã€‚\r\n\r\nç¬”è€…å‰æ®µæ—¶é—´ä¸ºçº¿ä¸Šä¸šåŠ¡å®ç°äº†ä¸€ä¸ªä¸å†…å®¹ç»“æ„éè€¦åˆçš„æ–‡æœ¬é«˜äº®ç¬”è®°åŠŸèƒ½ã€‚éè€¦åˆæ˜¯æŒ‡**ä¸éœ€è¦ä¸ºé«˜äº®åŠŸèƒ½å»ºç«‹ç‰¹æ®Šçš„é¡µé¢ DOM ç»“æ„ï¼Œè€Œé«˜äº®åŠŸèƒ½å¯¹ä¸šåŠ¡è¿‘ä¹é€æ˜**ã€‚è¯¥åŠŸèƒ½æ ¸å¿ƒéƒ¨åˆ†å…·æœ‰è¾ƒå¼ºçš„é€šç”¨æ€§ä¸ç§»æ¤æ€§ï¼Œæ•…æ‹¿å‡ºæ¥å’Œå¤§å®¶åˆ†äº«äº¤æµä¸€ä¸‹ã€‚\r\n\r\n> æœ¬æ–‡å…·ä½“çš„æ ¸å¿ƒä»£ç å·²å°è£…æˆç‹¬ç«‹åº“ [web-highlighter](https://github.com/alienzhou/web-highlighter)ï¼Œé˜…è¯»ä¸­å¦‚æœ‰ç–‘é—®å¯å‚è€ƒå…¶ä¸­ä»£ç â†“â†“ã€‚\r\n> [![image](http://upload-images.jianshu.io/upload_images/6476654-0036b39ea5538bfd?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)](https://github.com/alienzhou/web-highlighter)\r\n\r\n## 2. å®ç°â€œåˆ’è¯é«˜äº®â€éœ€è¦è§£å†³å“ªäº›é—®é¢˜ï¼Ÿ\r\n\r\nå®ç°ä¸€ä¸ªâ€œåˆ’è¯é«˜äº®â€çš„åœ¨çº¿ç¬”è®°åŠŸèƒ½éœ€è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜æœ‰ä¸¤ä¸ªï¼š\r\n\r\n- åŠ é«˜äº®èƒŒæ™¯ã€‚å³å¦‚ä½•æ ¹æ®ç”¨æˆ·åœ¨ç½‘é¡µä¸Šçš„é€‰å–ï¼Œä¸ºç›¸åº”çš„æ–‡æœ¬æ·»åŠ é«˜äº®èƒŒæ™¯ï¼›\r\n- é«˜äº®åŒºåŸŸçš„æŒä¹…åŒ–ä¸è¿˜åŸã€‚å³å¦‚ä½•ä¿å­˜ç”¨æˆ·é«˜äº®ä¿¡æ¯ï¼Œå¹¶åœ¨ä¸‹æ¬¡æµè§ˆæ—¶å‡†ç¡®è¿˜åŸï¼Œå¦åˆ™ä¸‹æ¬¡æ‰“å¼€é¡µé¢ç”¨æˆ·é«˜äº®çš„ä¿¡æ¯å°±ä¸¢å¤±äº†ã€‚\r\n\r\nä¸€èˆ¬æ¥è¯´ï¼Œåˆ’è¯é«˜äº®çš„ä¸šåŠ¡éœ€æ±‚æ–¹ä¸»è¦æ˜¯é’ˆå¯¹è‡ªå·±äº§å‡ºçš„å†…å®¹ï¼Œä½ å¯ä»¥æ¯”è¾ƒå®¹æ˜“å¯¹å†…å®¹åœ¨ç½‘é¡µä¸Šçš„æ’ç‰ˆã€HTML æ ‡ç­¾ç­‰æ–¹é¢è¿›è¡Œæ§åˆ¶ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¤„ç†é«˜äº®éœ€æ±‚ä¼šæ›´æ–¹ä¾¿ä¸€äº›ï¼Œæ¯•ç«Ÿè‡ªå·±å¯ä»¥æ ¹æ®é«˜äº®éœ€æ±‚è°ƒæ•´ç°æœ‰å†…å®¹çš„ HTMLã€‚\r\n\r\nè€Œç¬”è€…é¢å¯¹çš„æƒ…å†µæ˜¯ï¼Œé¡µé¢ HTML æ’ç‰ˆç»“æ„å¤æ‚ï¼Œä¸”æ— æ³•æ ¹æ®é«˜äº®éœ€æ±‚æ¥æ¨åŠ¨ä¸šåŠ¡æ”¹åŠ¨ HTMLã€‚è¿™ä¹Ÿå‚¬ç”Ÿå‡ºäº†å¯¹è§£å†³æ–¹æ¡ˆæ›´é€šç”¨åŒ–çš„è¦æ±‚ï¼Œç›®æ ‡å°±æ˜¯ï¼š**é’ˆå¯¹ä»»æ„å†…å®¹å‡å¯â€œåˆ’è¯é«˜äº®â€å¹¶æ”¯æŒåç»­è®¿é—®æ—¶è¿˜åŸé«˜äº®çŠ¶æ€ï¼Œè€Œä¸ç”¨å»å…³å¿ƒå†…å®¹çš„ç»„ç»‡ç»“æ„**ã€‚\r\n\r\nä¸‹é¢å°±æ¥å…·ä½“è¯´è¯´ï¼Œå¦‚ä½•è§£å†³ä¸Šé¢çš„ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ã€‚\r\n\r\n## 3. å¦‚ä½•â€œåŠ é«˜äº®èƒŒæ™¯â€ï¼Ÿ\r\n\r\næ ¹æ®åŠ¨å›¾æ¼”ç¤ºæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œç”¨æˆ·é€‰æ‹©æŸä¸€æ®µæ–‡æœ¬ï¼ˆä¸‹æ–‡ç§°ä¸ºâ€œç”¨æˆ·é€‰åŒºâ€ï¼‰åï¼Œæˆ‘ä»¬ä¼šç»™è¿™æ®µæ–‡æœ¬åŠ ä¸€ä¸ªé«˜äº®èƒŒæ™¯ã€‚\r\n\r\n![image](http://upload-images.jianshu.io/upload_images/6476654-e8b5bea0afc8d56c?imageMogr2/auto-orient/strip)\r\n\r\nä¾‹å¦‚ç”¨æˆ·é€‰æ‹©äº†ä¸Šå›¾ä¸­çš„æ–‡æœ¬ï¼ˆå³è“è‰²éƒ¨åˆ†ï¼‰ã€‚ä¸ºå…¶åŠ é«˜äº®çš„åŸºæœ¬æ€è·¯å¦‚ä¸‹ï¼š\r\n\r\n1. è·å–é€‰ä¸­çš„æ–‡æœ¬èŠ‚ç‚¹ï¼šé€šè¿‡ç”¨æˆ·é€‰æ‹©çš„åŒºåŸŸä¿¡æ¯ï¼Œè·å–æ‰€æœ‰è¢«é€‰ä¸­çš„æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼›\r\n2. ä¸ºæ–‡æœ¬èŠ‚ç‚¹æ·»åŠ èƒŒæ™¯è‰²ï¼šç»™è¿™äº›æ–‡æœ¬èŠ‚ç‚¹åŒ…è£¹ä¸€å±‚æ–°çš„å…ƒç´ ï¼Œè¯¥å…ƒç´ å…·æœ‰æŒ‡å®šçš„èƒŒæ™¯é¢œè‰²ã€‚\r\n\r\n### 3.1. å¦‚ä½•è·å–é€‰ä¸­çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Ÿ\r\n\r\n#### 1ï¼‰Selection API\r\n\r\néœ€è¦åŸºäºæµè§ˆå™¨ä¸ºæˆ‘ä»¬æä¾›çš„ [Selection API](https://developer.mozilla.org/en-US/docs/Web/API/Selection_API) ã€‚å®ƒçš„[å…¼å®¹æ€§](https://caniuse.com/#search=selection)è¿˜ä¸é”™ã€‚å¦‚æœè¦æ”¯æŒæ›´ä½ç‰ˆæœ¬çš„æµè§ˆå™¨åˆ™éœ€è¦ç”¨ polyfillã€‚\r\n\r\n![image](http://upload-images.jianshu.io/upload_images/6476654-72543d1892c702c8?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\r\n\r\nSelection API å¯ä»¥è¿”å›ä¸€ç³»åˆ—å…³äºç”¨æˆ·é€‰åŒºçš„ä¿¡æ¯ã€‚é‚£ä¹ˆæ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡å®ƒç›´æ¥è·å–é€‰å–ä¸­çš„æ‰€æœ‰ DOM å…ƒç´ å‘¢ï¼Ÿ\r\n\r\nå¾ˆé—æ†¾å¹¶ä¸èƒ½ã€‚ä½†å¥½åœ¨å®ƒå¯ä»¥è¿”å›é€‰åŒºçš„é¦–å°¾èŠ‚ç‚¹ä¿¡æ¯ï¼š\r\n\r\n```JavaScript\r\nconst range = window.getSelection().getRangeAt(0);\r\nconst start = {\r\n    node: range.startContainer,\r\n    offset: range.startOffset\r\n};\r\nconst end = {\r\n    node: range.endContainer,\r\n    offset: range.endOffset\r\n};\r\n```\r\n\r\n`Range` å¯¹è±¡åŒ…å«äº†é€‰åŒºçš„å¼€å§‹ä¸ç»“æŸä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬èŠ‚ç‚¹ï¼ˆnodeï¼‰ä¸æ–‡æœ¬åç§»é‡ï¼ˆoffsetï¼‰ã€‚èŠ‚ç‚¹ä¿¡æ¯ä¸ç”¨å¤šè¯´ï¼Œè¿™é‡Œè§£é‡Šä¸€ä¸‹ offset æ˜¯æŒ‡ä»€ä¹ˆï¼šä¾‹å¦‚ï¼Œæ ‡ç­¾`<p>è¿™æ˜¯ä¸€æ®µæ–‡æœ¬çš„ç¤ºä¾‹</p>`ï¼Œç”¨æˆ·é€‰å–çš„éƒ¨åˆ†æ˜¯â€œä¸€æ®µæ–‡æœ¬â€è¿™å››ä¸ªå­—ï¼Œè¿™æ—¶é¦–å°¾çš„ node å‡ä¸º p å…ƒç´ å†…çš„æ–‡æœ¬èŠ‚ç‚¹ï¼ˆText Nodeï¼‰ï¼Œè€Œ startOffset å’Œ endOffset åˆ†åˆ«ä¸º 2 å’Œ 6ã€‚\r\n\r\n#### 2ï¼‰é¦–å°¾æ–‡æœ¬èŠ‚ç‚¹æ‹†åˆ†\r\n\r\nç†è§£äº† offset çš„æ¦‚å¿µåï¼Œè‡ªç„¶å°±å‘ç°æœ‰ä¸ªé—®é¢˜éœ€è¦è§£å†³ã€‚ç”±äºç”¨æˆ·é€‰åŒºï¼ˆselectionï¼‰å¯èƒ½åªåŒ…å«ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹çš„ä¸€éƒ¨åˆ†ï¼ˆå³ offset ä¸ä¸º 0ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€åå¾—åˆ°çš„ç”¨æˆ·é€‰åŒºæ‰€åŒ…å«çš„èŠ‚ç‚¹é‡Œï¼Œä¹Ÿåªå¸Œæœ›æœ‰é¦–å°¾æ–‡æœ¬èŠ‚ç‚¹çš„è¿™â€œä¸€éƒ¨åˆ†â€ã€‚å¯¹æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [`.splitText()`](https://developer.mozilla.org/en-US/docs/Web/API/Text/splitText) æ‹†åˆ†æ–‡æœ¬èŠ‚ç‚¹ï¼š\r\n\r\n```JavaScript\r\n// é¦–èŠ‚ç‚¹\r\nif (curNode === $startNode) {\r\n    if (curNode.nodeType === 3) {\r\n        curNode.splitText(startOffset);\r\n        const node = curNode.nextSibling;\r\n        selectedNodes.push(node);\r\n    }\r\n}\r\n\r\n// å°¾èŠ‚ç‚¹\r\nif (curNode === $endNode) {\r\n    if (curNode.nodeType === 3) {\r\n        const node = curNode;\r\n        node.splitText(endOffset);\r\n        selectedNodes.push(node);\r\n    }\r\n}\r\n```\r\n\r\nä»¥ä¸Šä»£ç ä¼šä¾æ® offset å¯¹æ–‡æœ¬èŠ‚ç‚¹è¿›è¡Œæ‹†åˆ†ã€‚å¯¹äºå¼€å§‹èŠ‚ç‚¹ï¼Œåªéœ€è¦æ”¶é›†å®ƒçš„ååŠéƒ¨åˆ†ï¼›è€Œå¯¹äºç»“æŸèŠ‚ç‚¹åˆ™æ˜¯å‰åŠéƒ¨åˆ†ã€‚\r\n\r\n#### 3ï¼‰éå† DOM æ ‘\r\n\r\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å‡†ç¡®æ‰¾åˆ°äº†é¦–å°¾èŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥å°±æ˜¯æ‰¾å‡ºâ€œä¸­é—´â€æ‰€æœ‰çš„æ–‡æœ¬èŠ‚ç‚¹ã€‚è¿™å°±éœ€è¦éå† DOM æ ‘ã€‚\r\n\r\nâ€œä¸­é—´â€åŠ ä¸Šå¼•å·æ˜¯å› ä¸ºï¼Œåœ¨è§†è§‰ä¸Šè¿™äº›èŠ‚ç‚¹æ˜¯ä½äºé¦–å°¾ä¹‹é—´çš„ï¼Œä½†ç”±äº DOM ä¸æ˜¯çº¿æ€§ç»“æ„è€Œæ˜¯æ ‘å½¢ç»“æ„ï¼Œæ‰€ä»¥è¿™ä¸ªâ€œä¸­é—´â€æ¢æˆç¨‹åºè¯­è¨€ï¼Œå°±æ˜¯æŒ‡æ·±åº¦ä¼˜å…ˆéå†æ—¶ï¼Œä½äºé¦–å°¾ä¸¤èŠ‚ç‚¹ä¹‹é—´çš„æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹ã€‚DFS çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå¯ä»¥é€’å½’ï¼Œä¹Ÿå¯ä»¥ç”¨æ ˆ+å¾ªç¯ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚\r\n\r\néœ€è¦æä¸€ä¸‹çš„æ˜¯ï¼Œç”±äºæˆ‘ä»¬æ˜¯è¦ä¸ºæ–‡æœ¬èŠ‚ç‚¹æ·»åŠ é«˜äº®èƒŒæ™¯ï¼Œå› æ­¤åœ¨éå†æ—¶åªä¼šæ”¶é›†æ–‡æœ¬èŠ‚ç‚¹ã€‚\r\n\r\n```JavaScript\r\nif (curNode.nodeType === 3) {\r\n    selectedNodes.push(curNode);\r\n}\r\n```\r\n\r\n### 3.2. å¦‚ä½•ä¸ºæ–‡æœ¬èŠ‚ç‚¹æ·»åŠ èƒŒæ™¯è‰²ï¼Ÿ\r\n\r\nè¿™ä¸€æ­¥æœ¬èº«å¹¶ä¸å›°éš¾ã€‚åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å·²ç»é€‰å‡ºäº†æ‰€æœ‰è¢«ç”¨æˆ·é€‰ä¸­çš„ æ–‡æœ¬èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬æ‹†åˆ†åçš„é¦–å°¾èŠ‚ç‚¹ï¼‰ã€‚å¯¹æ­¤ï¼Œä¸€ä¸ªæœ€ç›´æ¥çš„æ–¹æ³•å°±æ˜¯ä¸ºå…¶â€œåŒ…è£¹ä¸Šâ€ä¸€ä¸ªå¸¦èƒŒæ™¯æ ·å¼çš„å…ƒç´ ã€‚\r\n\r\nå…·ä½“çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç»™æ¯ä¸ªæ–‡æœ¬èŠ‚ç‚¹å¤–åŠ ä¸Šä¸€ä¸ª class ä¸º `highlight` çš„ `<span>` å…ƒç´ ï¼›è€ŒèƒŒæ™¯æ ·å¼åˆ™é€šè¿‡ CSS `.highlight` é€‰æ‹©å™¨è®¾ç½®ã€‚\r\n\r\n```JavaScript\r\n// ä½¿ç”¨ä¸Šä¸€æ­¥ä¸­å°è£…çš„æ–¹æ³•è·å–é€‰åŒºå†…çš„æ–‡æœ¬èŠ‚ç‚¹\r\nconst nodes = getSelectedNodes(start, end);\r\n\r\nnodes.forEach(node => {\r\n    const wrap = document.createElement('span');\r\n    wrap.setAttribute('class', 'highlight');\r\n    wrap.appendChild(node.cloneNode(false));\r\n    node.parentNode.replaceChild(wrap);\r\n});\r\n```\r\n\r\n```CSS\r\n.highlight {\r\n    background: #ff9;\r\n}\r\n```\r\n\r\nè¿™æ ·å°±å¯ä»¥ç»™è¢«é€‰ä¸­çš„æ–‡å­—æ·»åŠ ä¸€ä¸ªâ€œæ°¸ä¹…â€çš„é«˜äº®èƒŒæ™¯äº†ã€‚\r\n\r\n#### p.s. é€‰åŒºçš„é‡åˆé—®é¢˜\r\n\r\nç„¶è€Œï¼Œæ–‡æœ¬é«˜äº®é‡Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„éœ€æ±‚ â€”â€” é«˜äº®åŒºåŸŸçš„é‡åˆã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæœ€å¼€å§‹çš„æ¼”ç¤ºå›¾ï¼ˆä¸‹å›¾ï¼‰é‡Œï¼Œç¬¬ä¸€ä¸ªé«˜äº®åŒºåŸŸå’Œç¬¬äºŒä¸ªé«˜äº®åŒºåŸŸä¹‹é—´å­˜åœ¨é‡å éƒ¨åˆ†ï¼Œå³â€œæœ¬åŒºåŸŸé«˜â€å››ä¸ªå­—ã€‚\r\n\r\n![image](http://upload-images.jianshu.io/upload_images/6476654-3599aaf4218cd4c9?imageMogr2/auto-orient/strip)\r\n\r\nè¿™ä¸ªé—®é¢˜ç›®å‰æ¥çœ‹ä¼¼ä¹è¿˜ä¸æ˜¯é—®é¢˜ï¼Œä½†åœ¨ç»“åˆä¸‹é¢è¦æåˆ°çš„ä¸€äº›åŠŸèƒ½ä¸éœ€æ±‚æ—¶ï¼Œå°±ä¼šå˜æˆéå¸¸éº»çƒ¦ï¼Œç”šè‡³æ— æ³•æ­£å¸¸è¿è¡Œï¼ˆä¸€äº›å¼€æºåº“è¿™å—å¤„ç†ä¹Ÿä¸å°½å¦‚äººæ„ï¼Œè¿™ä¹Ÿæ˜¯æ²¡æœ‰é€‰æ‹©å®ƒä»¬çš„ä¸€ä¸ªåŸå› ï¼‰ã€‚è¿™é‡Œç®€å•æä¸€ä¸‹ï¼Œå…·ä½“çš„æƒ…å†µæˆ‘ä¼šæ”¾åˆ°åç»­å¯¹åº”çš„åœ°æ–¹å†è¯¦ç»†è¯´ã€‚\r\n\r\n## 4. å¦‚ä½•å®ç°é«˜äº®é€‰åŒºçš„æŒä¹…åŒ–ä¸è¿˜åŸï¼Ÿ\r\n\r\nåˆ°ç›®å‰æˆ‘ä»¬å·²ç»å¯ä»¥ç»™é€‰ä¸­çš„æ–‡æœ¬æ·»åŠ é«˜äº®èƒŒæ™¯äº†ã€‚ä½†è¿˜æœ‰ä¸€ä¸ªå¤§é—®é¢˜ï¼š\r\n\r\næƒ³è±¡ä¸€ä¸‹ï¼Œç”¨æˆ·è¾›è¾›è‹¦è‹¦åˆ’äº†å¾ˆå¤šé‡ç‚¹ï¼ˆé«˜äº®ï¼‰ï¼Œå¼€å¿ƒåœ°é€€å‡ºé¡µé¢åï¼Œä¸‹æ¬¡è®¿é—®æ—¶å‘ç°è¿™äº›éƒ½ä¸èƒ½ä¿å­˜æ—¶ï¼Œè¯¥æœ‰å¤šä¹ˆå¾—æ²®ä¸§ã€‚å› æ­¤ï¼Œå¦‚æœåªæ˜¯åœ¨é¡µé¢ä¸Šåšâ€œä¸€æ¬¡æ€§â€çš„æ–‡æœ¬é«˜äº®ï¼Œé‚£å®ƒçš„ä½¿ç”¨ä»·å€¼ä¼šå¤§å¤§é™ä½ã€‚è¿™ä¹Ÿå°±ä¿ƒä½¿æˆ‘ä»¬çš„â€œåˆ’è¯é«˜äº®â€åŠŸèƒ½è¦èƒ½å¤Ÿä¿å­˜ï¼ˆæŒä¹…åŒ–ï¼‰è¿™äº›é«˜äº®é€‰åŒºå¹¶æ­£ç¡®è¿˜åŸã€‚\r\n\r\n> æŒä¹…åŒ–é«˜äº®é€‰åŒºçš„æ ¸å¿ƒæ˜¯æ‰¾åˆ°ä¸€ç§åˆé€‚çš„ DOM èŠ‚ç‚¹åºåˆ—åŒ–æ–¹æ³•ã€‚\r\n\r\né€šè¿‡ç¬¬ä¸‰éƒ¨åˆ†å¯ä»¥çŸ¥é“ï¼Œå½“ç¡®å®šäº†é¦–å°¾èŠ‚ç‚¹ä¸æ–‡æœ¬åç§»ï¼ˆoffsetï¼‰ä¿¡æ¯åï¼Œå³å¯ä¸ºå…¶é—´æ–‡æœ¬èŠ‚ç‚¹æ·»åŠ èƒŒæ™¯è‰²ã€‚å…¶ä¸­ï¼Œoffset æ˜¯æ•°å€¼ç±»å‹ï¼Œè¦åœ¨æœåŠ¡å™¨ä¿å­˜å®ƒè‡ªç„¶æ²¡æœ‰é—®é¢˜ï¼›ä½†æ˜¯ DOM èŠ‚ç‚¹ä¸åŒï¼Œåœ¨æµè§ˆå™¨ä¸­ä¿å­˜å®ƒåªéœ€è¦èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œä½†æƒ³åœ¨åç«¯ä¿å­˜æ‰€è°“çš„ DOM åˆ™ä¸é‚£ä¹ˆç›´æ¥äº†ã€‚\r\n\r\n### 4.1 åºåˆ—åŒ– DOM èŠ‚ç‚¹æ ‡è¯†\r\n\r\næ‰€ä»¥è¿™é‡Œçš„æ ¸å¿ƒç‚¹å°±æ˜¯æ‰¾åˆ°ä¸€ç§æ–¹æ³•ï¼Œèƒ½å¤Ÿå®šä½ DOM èŠ‚ç‚¹ï¼ŒåŒæ—¶å¯ä»¥è¢«ä¿å­˜æˆæ™®é€šçš„ JSON Objectï¼Œç”¨ä»¥ä¼ ç»™åç«¯ä¿å­˜ï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨æœ¬æ–‡ä¸­è¢«ç§°ä¸º DOM æ ‡è¯† çš„â€œåºåˆ—åŒ–â€ã€‚è€Œä¸‹æ¬¡ç”¨æˆ·è®¿é—®æ—¶ï¼Œåˆå¯ä»¥ä»åç«¯å–å›ï¼Œç„¶åâ€œååºåˆ—åŒ–â€ä¸ºå¯¹åº”çš„ DOM èŠ‚ç‚¹ã€‚\r\n\r\næœ‰å‡ ç§å¸¸è§çš„æ–¹å¼æ¥æ ‡è¯† DOM èŠ‚ç‚¹ï¼š\r\n\r\n- ä½¿ç”¨ xPath\r\n- ä½¿ç”¨ CSS Selector è¯­æ³•\r\n- ä½¿ç”¨ tagName + index\r\n\r\nè¿™é‡Œé€‰æ‹©äº†ä½¿ç”¨ç¬¬ä¸‰ç§æ–¹å¼æ¥å¿«é€Ÿå®ç°ã€‚éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œæˆ‘ä»¬é€šè¿‡ Selection API å–åˆ°çš„é¦–å°¾èŠ‚ç‚¹ä¸€èˆ¬æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œè€Œè¿™é‡Œè¦è®°å½•çš„ tagName å’Œ index éƒ½æ˜¯è¯¥æ–‡æœ¬èŠ‚ç‚¹çš„çˆ¶å…ƒç´ èŠ‚ç‚¹ï¼ˆElement Nodeï¼‰çš„ï¼Œè€Œ childIndex è¡¨ç¤ºè¯¥æ–‡æœ¬èŠ‚ç‚¹æ˜¯å…¶çˆ¶äº²çš„ç¬¬å‡ ä¸ªå„¿å­ï¼š\r\n\r\n```JavaScript\r\nfunction serialize(textNode, root = document) {\r\n    const node = textNode.parentElement;\r\n    let childIndex = -1;\r\n    for (let i = 0; i < node.childNodes.length; i++) {\r\n        if (textNode === node.childNodes[i]) {\r\n            childIndex = i;\r\n            break;\r\n        }\r\n    }\r\n    \r\n    const tagName = node.tagName;\r\n    const list = root.getElementsByTagName(tagName);\r\n    for (let index = 0; index < list.length; index++) {\r\n        if (node === list[index]) {\r\n            return {tagName, index, childIndex};\r\n        }\r\n    }\r\n    return {tagName, index: -1, childIndex};\r\n}\r\n```\r\n\r\né€šè¿‡è¯¥æ–¹æ³•è¿”å›çš„ä¿¡æ¯ï¼Œå†åŠ ä¸Š offset ä¿¡æ¯ï¼Œå³å®šä½é€‰å–çš„èµ·å§‹ä½ç½®ï¼ŒåŒæ—¶ä¹Ÿå®Œå…¨å¯å‘é€ç»™åç«¯è¿›è¡Œä¿å­˜äº†ã€‚\r\n\r\n### 4.2 ååºåˆ—åŒ– DOM èŠ‚ç‚¹\r\n\r\nåŸºäºä¸Šä¸€èŠ‚çš„åºåˆ—åŒ–æ–¹æ³•ï¼Œä»åç«¯è·å–åˆ°æ•°æ®åï¼Œå¯ä»¥å¾ˆå®¹æ˜“ååºåˆ—åŒ–ä¸º DOM èŠ‚ç‚¹ï¼š\r\n\r\n```JavaScript\r\nfunction deSerialize(meta, root = document) {\r\n    const {tagName, index, childIndex} = meta;\r\n    const parent = root.getElementsByTagName(tagName)[index];\r\n    return parent.childNodes[childIndex];\r\n}\r\n```\r\n\r\nè‡³æ­¤ï¼Œæˆ‘ä»¬å¤§ä½“å·²ç»è§£å†³äº†ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼Œè¿™ä¼¼ä¹å·²ç»æ˜¯ä¸€ä¸ªå¯ç”¨ç‰ˆæœ¬äº†ã€‚ä½†**å…¶å®ä¸ç„¶**ï¼Œæ ¹æ®å®è·µç»éªŒï¼Œå¦‚æœä»…ä»…æ˜¯ä¸Šé¢è¿™äº›å¤„ç†ï¼Œå¾€å¾€æ˜¯æ— æ³•åº”å¯¹å®é™…éœ€æ±‚çš„ï¼Œå­˜åœ¨ä¸€äº›â€œè‡´å‘½é—®é¢˜â€ã€‚\r\n\r\nä½†ä¸ç”¨ç°å¿ƒï¼Œä¸‹é¢ä¼šå…·ä½“æ¥è¯´è¯´æ‰€è°“çš„â€œè‡´å‘½é—®é¢˜â€æ˜¯ä»€ä¹ˆï¼Œè€Œåˆæ˜¯å¦‚ä½•è§£å†³å¹¶å®ç°ä¸€ä¸ªçº¿ä¸Šä¸šåŠ¡å¯ç”¨çš„é€šç”¨â€œåˆ’è¯é«˜äº®â€åŠŸèƒ½çš„ã€‚\r\n\r\n### 5. å¦‚ä½•å®ç°ä¸€ä¸ªç”Ÿäº§ç¯å¢ƒå¯ç”¨çš„â€œåˆ’è¯é«˜äº®â€ï¼Ÿ\r\n\r\n#### 1ï¼‰ä¸Šé¢çš„æ–¹æ¡ˆæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ\r\n\r\né¦–å…ˆæ¥çœ‹çœ‹ä¸Šé¢çš„æ–¹æ¡ˆä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚\r\n\r\nå½“æˆ‘ä»¬éœ€è¦é«˜äº®æ–‡æœ¬æ—¶ï¼Œä¼šä¸ºæ–‡æœ¬èŠ‚ç‚¹åŒ…è£¹`span`å…ƒç´ ï¼Œè¿™å°±æ”¹åŠ¨äº†é¡µé¢çš„ DOM ç»“æ„ã€‚å®ƒå¯èƒ½ä¼šå¯¼è‡´åç»­é«˜äº®çš„é¦–å°¾èŠ‚ç‚¹ä¸å…¶ offset ä¿¡æ¯å…¶å®æ˜¯åŸºäºè¢«æ”¹åŠ¨åçš„ DOM ç»“æ„çš„ã€‚å¸¦æ¥çš„ç»“æœæœ‰ä¸¤ä¸ªï¼š\r\n\r\n- ä¸‹æ¬¡è®¿é—®æ—¶ï¼Œç¨‹åºå¿…é¡»æŒ‰ä¸Šæ¬¡ç”¨æˆ·é«˜äº®çš„é¡ºåºè¿˜åŸã€‚\r\n- ç”¨æˆ·ä¸èƒ½éšæ„å–æ¶ˆï¼ˆåˆ é™¤ï¼‰é«˜äº®åŒºåŸŸï¼Œåªèƒ½æŒ‰æ·»åŠ é¡ºåºä»åå¾€å‰åˆ ã€‚\r\n\r\nå¦åˆ™ï¼Œå°±ä¼šæœ‰éƒ¨åˆ†çš„é«˜äº®é€‰åŒºåœ¨è¿˜åŸæ—¶æ— æ³•å®šä½åˆ°æ­£ç¡®çš„å…ƒç´ ã€‚\r\n\r\næ–‡å­—å¯èƒ½ä¸å¥½ç†è§£ï¼Œä¸‹é¢æˆ‘ä¸¾ä¸ªä¾‹å­æ¥ç›´è§‚è§£é‡Šä¸‹è¿™ä¸ªé—®é¢˜ã€‚\r\n\r\n```HTML\r\n<p>\r\n    éå¸¸é«˜å…´ä»Šå¤©èƒ½å¤Ÿåœ¨è¿™é‡Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹æ–‡æœ¬é«˜äº®ï¼ˆåœ¨çº¿ç¬”è®°ï¼‰çš„å®ç°æ–¹å¼ã€‚\r\n</p>\r\n```\r\n\r\nå¯¹äºä¸Šé¢è¿™æ®µ HTMLï¼Œç”¨æˆ·åˆ†åˆ«æŒ‰é¡ºåºé«˜äº®äº†ä¸¤ä¸ªéƒ¨åˆ†ï¼šâ€œé«˜å…´â€å’Œâ€œæ–‡æœ¬é«˜äº®â€ã€‚é‚£ä¹ˆæŒ‰ç…§ä¸Šé¢çš„å®ç°æ–¹å¼ï¼Œè¿™æ®µ HTML å˜æˆäº†ä¸‹é¢è¿™æ ·ï¼š\r\n\r\n```HTML\r\n<p>\r\n    éå¸¸\r\n    <span class=\"highlight\">é«˜å…´</span>\r\n    ä»Šå¤©èƒ½å¤Ÿåœ¨è¿™é‡Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹\r\n    <span class=\"highlight\">æ–‡æœ¬é«˜äº®</span>\r\n    ï¼ˆåœ¨çº¿ç¬”è®°ï¼‰çš„å®ç°æ–¹å¼ã€‚\r\n</p>\r\n```\r\n\r\nå¯¹åº”çš„ä¸¤ä¸ªåºåˆ—åŒ–æ•°æ®åˆ†åˆ«ä¸ºï¼š\r\n\r\n```JavaScript\r\n// â€œé«˜å…´â€ä¸¤ä¸ªå­—è¢«é«˜äº®æ—¶è·å–çš„åºåˆ—åŒ–ä¿¡æ¯\r\n{\r\n    start: {\r\n        tagName: 'p',\r\n        index: 0,\r\n        childIndex: 0,\r\n        offset: 2\r\n    },\r\n    end: {\r\n        tagName: 'p',\r\n        index: 0,\r\n        childIndex: 0,\r\n        offset: 4\r\n    }\r\n}\r\n```\r\n\r\n```JavaScript\r\n// â€œæ–‡æœ¬é«˜äº®â€å››ä¸ªå­—è¢«é«˜äº®æ—¶è·å–çš„åºåˆ—åŒ–ä¿¡æ¯ã€‚\r\n// è¿™æ—¶å€™ç”±äºpä¸‹é¢å·²ç»å­˜åœ¨äº†ä¸€ä¸ªé«˜äº®ä¿¡æ¯ï¼ˆå³â€œé«˜å…´â€ï¼‰ã€‚\r\n// æ‰€ä»¥å…¶å†…éƒ¨ HTML ç»“æ„å·²è¢«ä¿®æ”¹ï¼Œç›´è§‚æ¥è¯´å°±æ˜¯ childNodes æ”¹å˜äº†ã€‚\r\n// è¿›è€Œï¼ŒchildIndexå±æ€§ç”±äºå‰ä¸€ä¸ª span å…ƒç´ çš„åŠ å…¥ï¼Œå˜ä¸ºäº† 2ã€‚\r\n{\r\n    start: {\r\n        tagName: 'p',\r\n        index: 0,\r\n        childIndex: 2,\r\n        offset: 14\r\n    },\r\n    end: {\r\n        tagName: 'p',\r\n        index: 0,\r\n        childIndex: 2,\r\n        offset: 18\r\n    }\r\n}\r\n```\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œâ€œæ–‡æœ¬é«˜äº®â€è¿™å››ä¸ªå­—çš„é¦–å°¾èŠ‚ç‚¹çš„ `childIndex` éƒ½è¢«è®°ä¸º 2ï¼Œè¿™æ˜¯ç”±äºå‰ä¸€ä¸ªé«˜äº®åŒºåŸŸæ”¹å˜äº†`<p>`å…ƒç´ ä¸‹çš„DOMç»“æ„ã€‚å¦‚æœæ­¤æ—¶â€œé«˜å…´â€é€‰åŒºçš„é«˜äº®è¢«ç”¨æˆ·å–æ¶ˆï¼Œé‚£ä¹ˆä¸‹æ¬¡å†è®¿é—®é¡µé¢å°±æ— æ³•è¿˜åŸé«˜äº®äº† â€”â€” â€œé«˜å…´â€é€‰åŒºçš„é«˜äº®è¢«å–æ¶ˆäº†ï¼Œ`<p>`ä¸‹è‡ªç„¶å°±ä¸ä¼šå‡ºç°ç¬¬ä¸‰ä¸ª childNodeï¼Œé‚£ä¹ˆ childIndex ä¸º 2 å°±æ‰¾ä¸åˆ°å¯¹åº”çš„èŠ‚ç‚¹äº†ã€‚è¿™å°±å¯¼è‡´å­˜å‚¨çš„æ•°æ®åœ¨è¿˜åŸé«˜äº®é€‰åŒºæ—¶å‡ºç°é—®é¢˜ã€‚\r\n\r\næ­¤å¤–ï¼Œè¿˜è®°å¾—åœ¨ç¬¬ä¸‰éƒ¨åˆ†æœ«å°¾æåˆ°çš„é«˜äº®é€‰å–é‡åˆé—®é¢˜ä¹ˆï¼Ÿæ”¯æŒé€‰å–é‡åˆå¾ˆå®¹æ˜“å‡ºç°å¦‚ä¸‹çš„åŒ…è£¹å…ƒç´ åµŒå¥—æƒ…å†µï¼š\r\n\r\n```HTML\r\n<p>\r\n    éå¸¸\r\n    <span class=\"highlight\">é«˜å…´</span>\r\n    ä»Šå¤©èƒ½å¤Ÿåœ¨è¿™é‡Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹\r\n    <span class=\"highlight\">\r\n        æ–‡æœ¬\r\n        <span class=\"highlight\">é«˜äº®</span>\r\n    </span>\r\n    ï¼ˆåœ¨çº¿ç¬”è®°ï¼‰çš„å®ç°æ–¹å¼ã€‚\r\n</p>\r\n```\r\n\r\nè¿™ä¹Ÿä½¿å¾—æŸä¸ªæ–‡æœ¬åŒºåŸŸç»è¿‡å¤šæ¬¡é«˜äº®ã€å–æ¶ˆé«˜äº®åï¼Œä¼šå‡ºç°ä¸åŸ HTML é¡µé¢ä¸åŒçš„å¤æ‚åµŒå¥—ç»“æ„ã€‚å¯ä»¥é¢„è§ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ xpath æˆ– CSS selector ä½œä¸º DOM æ ‡è¯†æ—¶ï¼Œä¸Šé¢æåˆ°çš„é—®é¢˜ä¹Ÿä¼šå‡ºç°ï¼ŒåŒæ—¶ä¹Ÿä½¿å…¶ä»–éœ€æ±‚çš„å®ç°æ›´åŠ å¤æ‚ã€‚\r\n\r\nåˆ°è¿™é‡Œå¯ä»¥æä¸€ä¸‹å…¶ä»–å¼€æºåº“æˆ–äº§å“æ˜¯å¦‚ä½•å¤„ç†é€‰åŒºé‡åˆé—®é¢˜çš„ï¼š\r\n\r\n- å¼€æºåº“ [Rangy](https://github.com/timdown/rangy) æœ‰ä¸€ä¸ª Highlighter æ¨¡å—å¯ä»¥å®ç°æ–‡æœ¬é«˜äº®ï¼Œä½†å…¶å¯¹äºé€‰åŒºé‡åˆçš„æƒ…å†µæ˜¯å°†ä¸¤ä¸ªé€‰åŒºç›´æ¥åˆå¹¶äº†ï¼Œè¿™æ˜¯ä¸åˆç¬¦æˆ‘ä»¬ä¸šåŠ¡éœ€æ±‚çš„ã€‚\r\n- ä»˜è´¹äº§å“ [Diigo](https://chrome.google.com/webstore/detail/pnhplgjpclknigjpccbcnmicgcieojbh) ç›´æ¥ä¸å…è®¸é€‰åŒºçš„é‡åˆã€‚\r\n- Medium.com æ˜¯æ”¯æŒé€‰åŒºé‡åˆçš„ï¼Œä½“éªŒéå¸¸ä¸é”™ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬äº§å“çš„ç›®æ ‡ã€‚ä½†å®ƒé¡µé¢çš„å†…å®¹åŒºç»“æ„ç›¸è¾ƒæˆ‘é¢å¯¹çš„æƒ…å†µä¼šæ›´ç®€å•ä¸æ›´å¯æ§ã€‚\r\n\r\næ‰€ä»¥å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜å‘¢ï¼Ÿ\r\n\r\n#### 2ï¼‰å¦ä¸€ç§åºåˆ—åŒ– / ååºåˆ—åŒ–æ–¹å¼\r\n\r\næˆ‘ä¼šå¯¹ç¬¬å››éƒ¨åˆ†æåˆ°çš„åºåˆ—åŒ–æ–¹å¼è¿›è¡Œæ”¹è¿›ã€‚ä»ç„¶è®°å½•æ–‡æœ¬èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ tagName ä¸ indexï¼Œä½†ä¸å†è®°å½•æ–‡æœ¬èŠ‚ç‚¹åœ¨ childNodes ä¸­çš„ index ä¸ offsetï¼Œè€Œæ˜¯è®°å½•å¼€å§‹ï¼ˆç»“æŸï¼‰ä½ç½®åœ¨æ•´ä¸ªçˆ¶å…ƒç´ èŠ‚ç‚¹ä¸­çš„æ–‡æœ¬åç§»é‡ã€‚\r\n\r\nä¾‹å¦‚ä¸‹é¢è¿™æ®µ HTMLï¼š\r\n\r\n```HTML\r\n<p>\r\n    éå¸¸\r\n    <span class=\"highlight\">é«˜å…´</span>\r\n    ä»Šå¤©èƒ½å¤Ÿåœ¨è¿™é‡Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹\r\n    <span class=\"highlight\">æ–‡æœ¬é«˜äº®</span>\r\n    ï¼ˆåœ¨çº¿ç¬”è®°ï¼‰çš„å®ç°æ–¹å¼ã€‚\r\n</p>\r\n```\r\n\r\nå¯¹äºâ€œæ–‡æœ¬é«˜äº®â€è¿™ä¸ªé«˜äº®é€‰åŒºï¼Œä¹‹å‰ç”¨äºæ ‡è¯†æ–‡æœ¬èµ·å§‹ä½ç½®çš„ä¿¡æ¯ä¸º`childIndex = 2, offset = 14`ã€‚è€Œç°åœ¨å˜ä¸º`offset = 18`ï¼ˆä»`<p>`å…ƒç´ ä¸‹ç¬¬ä¸€ä¸ªæ–‡æœ¬â€œéâ€å¼€å§‹è®¡ç®—ï¼Œç»è¿‡18ä¸ªå­—ç¬¦åæ˜¯â€œæ–‡â€ï¼‰ã€‚å¯ä»¥çœ‹å‡ºï¼Œè¿™æ ·è¡¨ç¤ºçš„ä¼˜ç‚¹æ˜¯ï¼Œä¸ç®¡`<p>`å†…éƒ¨åŸæœ‰çš„æ–‡æœ¬èŠ‚ç‚¹è¢«`<span>`ï¼ˆåŒ…è£¹ï¼‰èŠ‚ç‚¹å¦‚ä½•åˆ†å‰²ï¼Œéƒ½ä¸ä¼šå½±å“é«˜äº®é€‰åŒºè¿˜åŸæ—¶çš„èŠ‚ç‚¹å®šä½ã€‚\r\n\r\næ®æ­¤ï¼Œåœ¨åºåˆ—åŒ–æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–¹æ³•æ¥å°†æ–‡æœ¬èŠ‚ç‚¹å†…åç§»é‡â€œç¿»è¯‘â€ä¸ºå…¶å¯¹åº”çš„çˆ¶èŠ‚ç‚¹å†…éƒ¨çš„æ€»ä½“æ–‡æœ¬åç§»é‡ï¼š\r\n\r\n```JavaScript\r\nfunction getTextPreOffset(root, text) {\r\n    const nodeStack = [root];\r\n    let curNode = null;\r\n    let offset = 0;\r\n    while (curNode = nodeStack.pop()) {\r\n        const children = curNode.childNodes;\r\n        for (let i = children.length - 1; i >= 0; i--) {\r\n            nodeStack.push(children[i]);\r\n        }\r\n\r\n        if (curNode.nodeType === 3 && curNode !== text) {\r\n            offset += curNode.textContent.length;\r\n        }\r\n        else if (curNode.nodeType === 3) {\r\n            break;\r\n        }\r\n    }\r\n\r\n    return offset;\r\n}\r\n```\r\n\r\nè€Œè¿˜åŸé«˜äº®é€‰åŒºæ—¶ï¼Œéœ€è¦ä¸€ä¸ªå¯¹åº”çš„é€†è¿‡ç¨‹ï¼š\r\n\r\n```JavaScript\r\nfunction getTextChildByOffset(parent, offset) {\r\n    const nodeStack = [parent];\r\n    let curNode = null;\r\n    let curOffset = 0;\r\n    let startOffset = 0;\r\n    while (curNode = nodeStack.pop()) {\r\n        const children = curNode.childNodes;\r\n        for (let i = children.length - 1; i >= 0; i--) {\r\n            nodeStack.push(children[i]);\r\n        }\r\n        if (curNode.nodeType === 3) {\r\n            startOffset = offset - curOffset;\r\n            curOffset += curNode.textContent.length;\r\n            if (curOffset >= offset) {\r\n                break;\r\n            }\r\n        }\r\n    }\r\n    if (!curNode) {\r\n        curNode = parent;\r\n    }\r\n    return {node: curNode, offset: startOffset};\r\n}\r\n```\r\n\r\n#### 3ï¼‰æ”¯æŒé«˜äº®é€‰åŒºçš„é‡åˆ\r\n\r\né‡åˆçš„é«˜äº®é€‰åŒºå¸¦æ¥çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯é«˜äº®åŒ…è£¹å…ƒç´ çš„åµŒå¥—ï¼Œä»è€Œä½¿å¾— DOM ç»“æ„ä¼šæœ‰è¾ƒå¤æ‚çš„å˜åŠ¨ï¼Œå¢åŠ äº†å…¶ä»–åŠŸèƒ½ï¼ˆäº¤äº’ï¼‰å®ç°ä¸é—®é¢˜æ’æŸ¥çš„å¤æ‚åº¦ã€‚å› æ­¤ï¼Œæˆ‘åœ¨ 3.2. èŠ‚æåˆ°çš„åŒ…è£¹é«˜äº®å…ƒç´ æ—¶ï¼Œä¼šå†è¿›è¡Œä¸€äº›ç¨å¤æ‚çš„å¤„ç†ï¼ˆå°¤å…¶æ˜¯é‡åˆé€‰åŒºï¼‰ï¼Œä»¥ä¿è¯å°½é‡å¤ç”¨å·²æœ‰çš„åŒ…è£¹å…ƒç´ ï¼Œé¿å…å…ƒç´ çš„åµŒå¥—ã€‚\r\n\r\nåœ¨å¤„ç†æ—¶ï¼Œå°†éœ€è¦åŒ…è£¹çš„å„ä¸ªæ–‡æœ¬ç‰‡æ®µï¼ˆText Nodeï¼‰åˆ†ä¸ºä¸‰ç±»æƒ…å†µï¼š\r\n\r\n1. å®Œå…¨æœªè¢«åŒ…è£¹ï¼Œåˆ™ç›´æ¥åŒ…è£¹è¯¥éƒ¨åˆ†ã€‚\r\n2. å±äºè¢«åŒ…è£¹è¿‡çš„æ–‡æœ¬èŠ‚ç‚¹çš„ä¸€éƒ¨åˆ†ï¼Œåˆ™ä½¿ç”¨`.splitText()`å°†å…¶æ‹†åˆ†ã€‚\r\n3. æ˜¯ä¸€æ®µå®Œå…¨è¢«åŒ…è£¹çš„æ–‡æœ¬æ®µï¼Œä¸éœ€è¦å¯¹èŠ‚ç‚¹è¿›è¡Œå¤„ç†ã€‚\r\n\r\näºæ­¤åŒæ—¶ï¼Œä¸ºæ¯ä¸ªé€‰åŒºç”Ÿæˆå”¯ä¸€ IDï¼Œå°†è¯¥æ®µæ–‡æœ¬å‡ ç‚¹å¤šå¯¹åº”çš„ IDã€ä»¥åŠå…¶ç”±äºé€‰åŒºé‡åˆæ‰€æ¶‰åŠåˆ°çš„å…¶ä»– IDï¼Œéƒ½é™„åŠ åŒ…è£¹å…ƒç´ ä¸Šã€‚å› æ­¤åƒä¸Šé¢çš„ç¬¬ä¸‰ç§æƒ…å†µï¼Œä¸éœ€è¦å˜æ›´ DOM ç»“æ„ï¼Œåªç”¨æ›´æ–°åŒ…è£¹å…ƒç´ ä¸¤ç±» ID æ‰€å¯¹åº”çš„ dataset å±æ€§å³å¯ã€‚\r\n\r\n## 6. å…¶ä»–é—®é¢˜\r\n\r\nè§£å†³ä»¥ä¸Šçš„ä¸€äº›é—®é¢˜åï¼Œâ€œæ–‡æœ¬åˆ’è¯é«˜äº®â€å°±åŸºæœ¬å¯ç”¨äº†ã€‚è¿˜å‰©ä¸‹ä¸€äº›â€œå°ä¿®è¡¥â€ï¼Œç®€å•æä¸€ä¸‹ã€‚\r\n\r\n### 6.1. é«˜äº®é€‰åŒºçš„äº¤äº’äº‹ä»¶ï¼Œä¾‹å¦‚ clickã€hover\r\n\r\né¦–å…ˆï¼Œå¯ä»¥ä¸ºæ¯ä¸ªé«˜äº®é€‰åŒºç”Ÿæˆä¸€ä¸ªå”¯ä¸€ IDï¼Œç„¶ååœ¨è¯¥é€‰åŒºå†…æ‰€æœ‰çš„åŒ…è£¹å…ƒç´ ä¸Šè®°å½•è¯¥ ID ä¿¡æ¯ï¼Œä¾‹å¦‚ç”¨`data-highlight-id`å±æ€§ã€‚è€Œå¯¹äºé€‰å–é‡åˆçš„éƒ¨åˆ†å¯ä»¥åœ¨`data-highlight-extra-id`å±æ€§ä¸­è®°å½•é‡åˆçš„å…¶ä»–é€‰åŒºçš„ IDã€‚\r\n\r\nè€Œç›‘å¬åˆ°åŒ…è£¹å…ƒç´ çš„ clickã€hover åï¼Œåˆ™è§¦å‘ highlighter çš„ç›¸åº”äº‹ä»¶ï¼Œå¹¶å¸¦ä¸Šé«˜äº® IDã€‚\r\n\r\n### 6.2. å–æ¶ˆé«˜äº®ï¼ˆé«˜äº®èƒŒæ™¯çš„åˆ é™¤ï¼‰\r\n\r\nç”±äºåœ¨åŒ…è£¹æ—¶æ”¯æŒé€‰åŒºé‡åˆï¼ˆå¯¹åº”ä¼šæœ‰ä¸Šé¢æåˆ°çš„ä¸‰ç§æƒ…å†µéœ€è¦å¤„ç†ï¼‰ï¼Œå› æ­¤ï¼Œåœ¨åˆ é™¤é€‰å–é«˜äº®æ—¶ï¼Œä¹Ÿä¼šæœ‰ä¸‰ç§æƒ…å†µéœ€è¦åˆ†åˆ«å¤„ç†ï¼š\r\n\r\n- ç›´æ¥åˆ é™¤åŒ…è£¹å…ƒç´ ã€‚å³ä¸å­˜åœ¨é€‰åŒºé‡åˆã€‚\r\n- æ›´æ–°`data-highlight-id`å±æ€§å’Œ`data-highlight-extra-id`å±æ€§ã€‚å³åˆ é™¤çš„é«˜äº® ID ä¸ `data-highlight-id` ç›¸åŒã€‚\r\n- åªæ›´æ–°`data-highlight-extra-id`å±æ€§ã€‚å³åˆ é™¤çš„é«˜äº® ID åªåœ¨ `data-highlight-extra-id` ä¸­ã€‚\r\n\r\n### 6.3. å¯¹äºå‰ç«¯ç”Ÿæˆçš„åŠ¨æ€é¡µé¢æ€ä¹ˆåŠï¼Ÿ\r\n\r\nä¸éš¾å‘ç°ï¼Œè¿™ç§éè€¦åˆçš„æ–‡æœ¬é«˜äº®åŠŸèƒ½å¾ˆä¾èµ–äºé¡µé¢çš„ DOM ç»“æ„ï¼Œéœ€è¦ä¿è¯åšé«˜äº®æ—¶çš„ DOM ç»“æ„å’Œè¿˜åŸæ—¶çš„ä¸€è‡´ï¼Œå¦åˆ™æ— æ³•æ­£ç¡®è¿˜åŸå‡ºé€‰åŒºçš„èµ·å§‹èŠ‚ç‚¹ä½ç½®ã€‚æ®æ­¤ï¼Œå¯¹â€œåˆ’è¯â€é«˜äº®æœ€å‹å¥½çš„åº”è¯¥æ˜¯çº¯åç«¯æ¸²æŸ“çš„é¡µé¢ï¼Œåœ¨`onload`ç›‘å¬ä¸­è§¦å‘é«˜äº®é€‰åŒºè¿˜åŸçš„æ–¹æ³•å³å¯ã€‚ä½†ç›®å‰è¶Šæ¥è¶Šå¤šçš„é¡µé¢ï¼ˆæˆ–é¡µé¢çš„ä¸€éƒ¨åˆ†ï¼‰æ˜¯å‰ç«¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œé’ˆå¯¹è¿™ä¸ªé—®é¢˜è¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ\r\n\r\næˆ‘åœ¨å®é™…å·¥ä½œä¸­ä¹Ÿé‡åˆ°äº†ç±»ä¼¼é—®é¢˜ â€”â€” é¡µé¢çš„å¾ˆå¤šåŒºåŸŸæ˜¯ ajax è¯·æ±‚åå‰ç«¯æ¸²æŸ“çš„ã€‚æˆ‘çš„å¤„ç†æ–¹å¼åŒ…æ‹¬å¦‚ä¸‹ï¼š\r\n\r\n- éš”ç¦»å˜åŒ–èŒƒå›´ã€‚å°†ä¸Šè¿°ä»£ç ä¸­çš„â€œæ ¹èŠ‚ç‚¹â€ä»`documentElement`æ¢ä¸ºå¦ä¸€ä¸ªæ›´å…·ä½“çš„å®¹å™¨å…ƒç´ ã€‚ä¾‹å¦‚æˆ‘é¢å¯¹çš„ä¸šåŠ¡ä¼šåœ¨ id ä¸º `article-container` çš„`<div>`å†…åŠ è½½åŠ¨æ€å†…å®¹ï¼Œé‚£ä¹ˆæˆ‘å°±ä¼šæŒ‡å®šè¿™ä¸ª `article-container` ä¸ºâ€œæ ¹èŠ‚ç‚¹â€ã€‚è¿™æ ·å¯ä»¥æœ€å¤§ç¨‹åº¦é˜²æ­¢å¤–éƒ¨çš„ DOM å˜åŠ¨å½±å“åˆ°é«˜äº®ä½ç½®çš„å®šä½ï¼Œå°¤å…¶æ˜¯é¡µé¢æ”¹ç‰ˆã€‚\r\n- ç¡®å®šé«˜äº®é€‰åŒºçš„è¿˜åŸæ—¶æœºã€‚ç”±äºå†…å®¹å¯èƒ½æ˜¯åŠ¨æ€ç”Ÿæˆï¼Œæ‰€ä»¥éœ€è¦ç­‰åˆ°è¯¥éƒ¨åˆ†çš„ DOM æ¸²æŸ“å®Œæˆåå†è°ƒç”¨è¿˜åŸæ–¹æ³•ã€‚å¦‚æœæœ‰æš´éœ²çš„ç›‘å¬äº‹ä»¶å¯ä»¥åœ¨ç›‘å¬å†…å¤„ç†ï¼›æˆ–è€…é€šè¿‡ MutationObserver ç›‘å¬æ ‡å¿—æ€§å…ƒç´ æ¥åˆ¤æ–­è¯¥éƒ¨åˆ†æ˜¯å¦åŠ è½½å®Œæˆã€‚\r\n- è®°å½•ä¸šåŠ¡å†…å®¹ä¿¡æ¯ï¼Œåº”å¯¹å†…å®¹åŒºæ”¹ç‰ˆã€‚å†…å®¹åŒºçš„ DOM ç»“æ„æ›´æ”¹ç®—æ˜¯â€œæ¯ç­æ€§æ‰“å‡»â€ã€‚å¦‚ä½•ç¡®å®æœ‰è¯¥ç±»æƒ…å†µï¼Œå¯ä»¥å°è¯•è®©ä¸šåŠ¡å†…å®¹å±•ç¤ºæ–¹å°†æ®µè½ä¿¡æ¯ç­‰å…·ä½“çš„å†…å®¹ä¿¡æ¯ç»‘å®šåœ¨ DOM å…ƒç´ ä¸Šï¼Œè€Œæˆ‘åœ¨é«˜äº®æ—¶å–å‡ºè¿™äº›ä¿¡æ¯æ¥å†—ä½™å­˜å‚¨ï¼Œæ”¹ç‰ˆåå¯ä»¥é€šè¿‡è¿™äº›å†…å®¹ä¿¡æ¯â€œåˆ·â€ä¸€éå­˜å‚¨çš„æ•°æ®ã€‚\r\n\r\n### 6.4. å…¶ä»–\r\n\r\nç¯‡å¹…é—®é¢˜ï¼Œè¿˜æœ‰å…¶ä»–ç»†èŠ‚çš„é—®é¢˜å°±ä¸åœ¨è¿™ç¯‡æ–‡ç« é‡Œåˆ†äº«äº†ã€‚è¯¦ç»†å†…å®¹å¯ä»¥å‚è€ƒ [web-highlighter](https://github.com/alienzhou/web-highlighter) è¿™ä¸ªä»“åº“é‡Œçš„å®ç°ã€‚\r\n\r\n## 7. æ€»ç»“\r\n\r\næœ¬æ–‡å…ˆä»â€œåˆ’è¯é«˜äº®â€åŠŸèƒ½çš„ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼ˆå¦‚ä½•é«˜äº®ç”¨æˆ·é€‰åŒºçš„æ–‡æœ¬ã€å¦‚ä½•å°†é«˜äº®é€‰åŒºè¿˜åŸï¼‰åˆ‡å…¥ï¼ŒåŸºäº Selection APIã€æ·±åº¦ä¼˜å…ˆéå†å’Œ DOM èŠ‚ç‚¹æ ‡è¯†çš„åºåˆ—åŒ–è¿™äº›æ‰‹æ®µå®ç°äº†â€œåˆ’è¯é«˜äº®â€çš„æ ¸å¿ƒåŠŸèƒ½ã€‚ç„¶è€Œï¼Œè¯¥æ–¹æ¡ˆä»ç„¶å­˜åœ¨ä¸€äº›å®é™…é—®é¢˜ï¼Œå› æ­¤åœ¨ç¬¬ 5 éƒ¨åˆ†è¿›ä¸€æ­¥ç»™å‡ºäº†ç›¸åº”çš„è§£å†³æ–¹æ¡ˆã€‚\r\n\r\nåŸºäºå®é™…å¼€å‘çš„ç»éªŒï¼Œæˆ‘å‘ç°è§£å†³ä¸Šè¿°å‡ ä¸ªâ€œåˆ’è¯é«˜äº®â€æ ¸å¿ƒé—®é¢˜çš„ä»£ç å…·æœ‰ä¸€å®šé€šç”¨æ€§ï¼Œå› æ­¤æŠŠæ ¸å¿ƒéƒ¨åˆ†çš„æºç å°è£…æˆäº†ç‹¬ç«‹çš„åº“ [web-highlighter](https://github.com/alienzhou/web-highlighter)ï¼Œæ‰˜ç®¡åœ¨ githubï¼Œä¹Ÿå¯ä»¥é€šè¿‡ npm å®‰è£…ã€‚\r\n\r\n[![image](http://upload-images.jianshu.io/upload_images/6476654-65f0a1e101a5d925?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)](https://github.com/alienzhou/web-highlighter)\r\n\r\nå…¶å·²æœåŠ¡äºçº¿ä¸Šäº§å“ä¸šåŠ¡ï¼ŒåŸºæœ¬çš„é«˜äº®åŠŸèƒ½ä¸€è¡Œä»£ç å³å¯å¼€å¯ï¼š\r\n\r\n```JavaScript\r\n(new Highlighter()).run();\r\n```\r\n\r\nå…¼å®¹IE 10/11ã€Edgeã€Firefox 52+ã€Chrome 15+ã€Safari 5.1+ã€Opera 15+ã€‚\r\n\r\næ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥ star ä¸€ä¸‹ã€‚æ„Ÿè°¢æ”¯æŒï¼Œæ¬¢è¿äº¤æµ ğŸ˜Š\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/27","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/27/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/27/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/27/events","html_url":"https://github.com/alienzhou/blog/issues/27","id":427659557,"node_id":"MDU6SXNzdWU0Mjc2NTk1NTc=","number":27,"title":"å‰ç«¯è·¨é¡µé¢é€šä¿¡ï¼Œä½ çŸ¥é“å“ªäº›æ–¹æ³•ï¼Ÿ","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845015,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E6%B5%8F%E8%A7%88%E5%99%A8","name":"æµè§ˆå™¨","color":"cfd3d7","default":false,"description":""},{"id":1159845016,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%BB%BC%E5%90%88","name":"ç»¼åˆ","color":"a2eeef","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-04-01T11:45:29Z","updated_at":"2020-03-27T05:09:53Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## å¼•è¨€\r\n\r\nåœ¨æµè§ˆå™¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åŒæ—¶æ‰“å¼€å¤šä¸ªTabé¡µï¼Œæ¯ä¸ªTabé¡µå¯ä»¥ç²—ç•¥ç†è§£ä¸ºä¸€ä¸ªâ€œç‹¬ç«‹â€çš„è¿è¡Œç¯å¢ƒï¼Œå³ä½¿æ˜¯å…¨å±€å¯¹è±¡ä¹Ÿä¸ä¼šåœ¨å¤šä¸ªTabé—´å…±äº«ã€‚ç„¶è€Œæœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½åœ¨è¿™äº›â€œç‹¬ç«‹â€çš„Tabé¡µé¢ä¹‹é—´åŒæ­¥é¡µé¢çš„æ•°æ®ã€ä¿¡æ¯æˆ–çŠ¶æ€ã€‚\r\n\r\næ­£å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼šæˆ‘åœ¨åˆ—è¡¨é¡µç‚¹å‡»â€œæ”¶è—â€åï¼Œå¯¹åº”çš„è¯¦æƒ…é¡µæŒ‰é’®ä¼šè‡ªåŠ¨æ›´æ–°ä¸ºâ€œå·²æ”¶è—â€çŠ¶æ€ï¼›ç±»ä¼¼çš„ï¼Œåœ¨è¯¦æƒ…é¡µç‚¹å‡»â€œæ”¶è—â€åï¼Œåˆ—è¡¨é¡µä¸­æŒ‰é’®ä¹Ÿä¼šæ›´æ–°ã€‚\r\n\r\n![è·¨é¡µé¢é€šä¿¡å®ä¾‹](https://user-gold-cdn.xitu.io/2019/4/1/169d767c01990c37?w=1364&h=876&f=gif&s=2542093)\r\n\r\nè¿™å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„å‰ç«¯è·¨é¡µé¢é€šä¿¡ã€‚\r\n\r\nä½ çŸ¥é“å“ªäº›è·¨é¡µé¢é€šä¿¡çš„æ–¹å¼å‘¢ï¼Ÿå¦‚æœä¸æ¸…æ¥šï¼Œä¸‹é¢æˆ‘å°±å¸¦å¤§å®¶æ¥çœ‹çœ‹ä¸ƒç§è·¨é¡µé¢é€šä¿¡çš„æ–¹å¼ã€‚\r\n\r\n---\r\n\r\n## ä¸€ã€åŒæºé¡µé¢é—´çš„è·¨é¡µé¢é€šä¿¡\r\n\r\n> ä»¥ä¸‹å„ç§æ–¹å¼çš„ [åœ¨çº¿ Demo å¯ä»¥æˆ³è¿™é‡Œ >>](https://alienzhou.github.io/cross-tab-communication/)\r\n\r\næµè§ˆå™¨çš„[åŒæºç­–ç•¥](https://en.wikipedia.org/wiki/Same-origin_policy)åœ¨ä¸‹è¿°çš„ä¸€äº›è·¨é¡µé¢é€šä¿¡æ–¹æ³•ä¸­ä¾ç„¶å­˜åœ¨é™åˆ¶ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ï¼Œåœ¨æ»¡è¶³åŒæºç­–ç•¥çš„æƒ…å†µä¸‹ï¼Œéƒ½æœ‰å“ªäº›æŠ€æœ¯å¯ä»¥ç”¨æ¥å®ç°è·¨é¡µé¢é€šä¿¡ã€‚\r\n\r\n### 1. BroadCast Channel\r\n\r\n[BroadCast Channel](https://developer.mozilla.org/en-US/docs/Web/API/BroadcastChannel) å¯ä»¥å¸®æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç”¨äºå¹¿æ’­çš„é€šä¿¡é¢‘é“ã€‚å½“æ‰€æœ‰é¡µé¢éƒ½ç›‘å¬åŒä¸€é¢‘é“çš„æ¶ˆæ¯æ—¶ï¼Œå…¶ä¸­æŸä¸€ä¸ªé¡µé¢é€šè¿‡å®ƒå‘é€çš„æ¶ˆæ¯å°±ä¼šè¢«å…¶ä»–æ‰€æœ‰é¡µé¢æ”¶åˆ°ã€‚å®ƒçš„APIå’Œç”¨æ³•éƒ½éå¸¸ç®€å•ã€‚\r\n\r\nä¸‹é¢çš„æ–¹å¼å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªæ ‡è¯†ä¸º`AlienZHOU`çš„é¢‘é“ï¼š\r\n\r\n```JavaScript\r\nconst bc = new BroadcastChannel('AlienZHOU');\r\n```\r\n\r\nå„ä¸ªé¡µé¢å¯ä»¥é€šè¿‡`onmessage`æ¥ç›‘å¬è¢«å¹¿æ’­çš„æ¶ˆæ¯ï¼š\r\n\r\n```JavaScript\r\nbc.onmessage = function (e) {\r\n    const data = e.data;\r\n    const text = '[receive] ' + data.msg + ' â€”â€” tab ' + data.from;\r\n    console.log('[BroadcastChannel] receive message:', text);\r\n};\r\n```\r\n\r\nè¦å‘é€æ¶ˆæ¯æ—¶åªéœ€è¦è°ƒç”¨å®ä¾‹ä¸Šçš„`postMessage`æ–¹æ³•å³å¯ï¼š\r\n\r\n```JavaScript\r\nbc.postMessage(mydata);\r\n```\r\n\r\n> Broadcast Channel çš„å…·ä½“çš„ä½¿ç”¨æ–¹å¼å¯ä»¥çœ‹è¿™ç¯‡[ã€Šã€3åˆ†é’Ÿé€Ÿè§ˆã€‘å‰ç«¯å¹¿æ’­å¼é€šä¿¡ï¼šBroadcast Channelã€‹](https://github.com/alienzhou/blog/issues/26)ã€‚\r\n\r\n### 2. Service Worker\r\n\r\n[Service Worker](https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API) æ˜¯ä¸€ä¸ªå¯ä»¥é•¿æœŸè¿è¡Œåœ¨åå°çš„ Workerï¼Œèƒ½å¤Ÿå®ç°ä¸é¡µé¢çš„åŒå‘é€šä¿¡ã€‚å¤šé¡µé¢å…±äº«é—´çš„ Service Worker å¯ä»¥å…±äº«ï¼Œå°† Service Worker ä½œä¸ºæ¶ˆæ¯çš„å¤„ç†ä¸­å¿ƒï¼ˆä¸­å¤®ç«™ï¼‰å³å¯å®ç°å¹¿æ’­æ•ˆæœã€‚\r\n\r\n> Service Worker ä¹Ÿæ˜¯ PWA ä¸­çš„æ ¸å¿ƒæŠ€æœ¯ä¹‹ä¸€ï¼Œç”±äºæœ¬æ–‡é‡ç‚¹ä¸åœ¨ PWA ï¼Œå› æ­¤å¦‚æœæƒ³è¿›ä¸€æ­¥äº†è§£ Service Workerï¼Œå¯ä»¥é˜…è¯»æˆ‘ä¹‹å‰çš„æ–‡ç« [ã€PWAå­¦ä¹ ä¸å®è·µã€‘(3) è®©ä½ çš„WebAppç¦»çº¿å¯ç”¨](https://github.com/alienzhou/blog/issues/4)ã€‚\r\n\r\né¦–å…ˆï¼Œéœ€è¦åœ¨é¡µé¢æ³¨å†Œ Service Workerï¼š\r\n\r\n```JavaScript\r\n/* é¡µé¢é€»è¾‘ */\r\nnavigator.serviceWorker.register('../util.sw.js').then(function () {\r\n    console.log('Service Worker æ³¨å†ŒæˆåŠŸ');\r\n});\r\n```\r\n\r\nå…¶ä¸­`../util.sw.js`æ˜¯å¯¹åº”çš„ Service Worker è„šæœ¬ã€‚Service Worker æœ¬èº«å¹¶ä¸è‡ªåŠ¨å…·å¤‡â€œå¹¿æ’­é€šä¿¡â€çš„åŠŸèƒ½ï¼Œéœ€è¦æˆ‘ä»¬æ·»åŠ äº›ä»£ç ï¼Œå°†å…¶æ”¹é€ æˆæ¶ˆæ¯ä¸­è½¬ç«™ï¼š\r\n\r\n```JavaScript\r\n/* ../util.sw.js Service Worker é€»è¾‘ */\r\nself.addEventListener('message', function (e) {\r\n    console.log('service worker receive message', e.data);\r\n    e.waitUntil(\r\n        self.clients.matchAll().then(function (clients) {\r\n            if (!clients || clients.length === 0) {\r\n                return;\r\n            }\r\n            clients.forEach(function (client) {\r\n                client.postMessage(e.data);\r\n            });\r\n        })\r\n    );\r\n});\r\n```\r\n\r\næˆ‘ä»¬åœ¨ Service Worker ä¸­ç›‘å¬äº†`message`äº‹ä»¶ï¼Œè·å–é¡µé¢ï¼ˆä» Service Worker çš„è§’åº¦å« clientï¼‰å‘é€çš„ä¿¡æ¯ã€‚ç„¶åé€šè¿‡`self.clients.matchAll()`è·å–å½“å‰æ³¨å†Œäº†è¯¥ Service Worker çš„æ‰€æœ‰é¡µé¢ï¼Œé€šè¿‡è°ƒç”¨æ¯ä¸ªclientï¼ˆå³é¡µé¢ï¼‰çš„`postMessage`æ–¹æ³•ï¼Œå‘é¡µé¢å‘é€æ¶ˆæ¯ã€‚è¿™æ ·å°±æŠŠä»ä¸€å¤„ï¼ˆæŸä¸ªTabé¡µé¢ï¼‰æ”¶åˆ°çš„æ¶ˆæ¯é€šçŸ¥ç»™äº†å…¶ä»–é¡µé¢ã€‚\r\n\r\nå¤„ç†å®Œ Service Workerï¼Œæˆ‘ä»¬éœ€è¦åœ¨é¡µé¢ç›‘å¬ Service Worker å‘é€æ¥çš„æ¶ˆæ¯ï¼š\r\n\r\n```JavaScript\r\n/* é¡µé¢é€»è¾‘ */\r\nnavigator.serviceWorker.addEventListener('message', function (e) {\r\n    const data = e.data;\r\n    const text = '[receive] ' + data.msg + ' â€”â€” tab ' + data.from;\r\n    console.log('[Service Worker] receive message:', text);\r\n});\r\n```\r\n\r\næœ€åï¼Œå½“éœ€è¦åŒæ­¥æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥è°ƒç”¨ Service Worker çš„`postMessage`æ–¹æ³•ï¼š\r\n\r\n```JavaScript\r\n/* é¡µé¢é€»è¾‘ */\r\nnavigator.serviceWorker.controller.postMessage(mydata);\r\n```\r\n\r\n### 3. LocalStorage\r\n\r\nLocalStorage ä½œä¸ºå‰ç«¯æœ€å¸¸ç”¨çš„æœ¬åœ°å­˜å‚¨ï¼Œå¤§å®¶åº”è¯¥å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼›ä½†[`StorageEvent`](https://developer.mozilla.org/en-US/docs/Web/API/StorageEvent)è¿™ä¸ªä¸å®ƒç›¸å…³çš„äº‹ä»¶æœ‰äº›åŒå­¦å¯èƒ½ä¼šæ¯”è¾ƒé™Œç”Ÿã€‚\r\n\r\nå½“ LocalStorage å˜åŒ–æ—¶ï¼Œä¼šè§¦å‘`storage`äº‹ä»¶ã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼ŒæŠŠæ¶ˆæ¯å†™å…¥åˆ°æŸä¸ª LocalStorage ä¸­ï¼›ç„¶ååœ¨å„ä¸ªé¡µé¢å†…ï¼Œé€šè¿‡ç›‘å¬`storage`äº‹ä»¶å³å¯æ”¶åˆ°é€šçŸ¥ã€‚\r\n\r\n```JavaScript\r\nwindow.addEventListener('storage', function (e) {\r\n    if (e.key === 'ctc-msg') {\r\n        const data = JSON.parse(e.newValue);\r\n        const text = '[receive] ' + data.msg + ' â€”â€” tab ' + data.from;\r\n        console.log('[Storage I] receive message:', text);\r\n    }\r\n});\r\n```\r\n\r\nåœ¨å„ä¸ªé¡µé¢æ·»åŠ å¦‚ä¸Šçš„ä»£ç ï¼Œå³å¯ç›‘å¬åˆ° LocalStorage çš„å˜åŒ–ã€‚å½“æŸä¸ªé¡µé¢éœ€è¦å‘é€æ¶ˆæ¯æ—¶ï¼Œåªéœ€è¦ä½¿ç”¨æˆ‘ä»¬ç†Ÿæ‚‰çš„`setItem`æ–¹æ³•å³å¯ï¼š\r\n\r\n```JavaScript\r\nmydata.st = +(new Date);\r\nwindow.localStorage.setItem('ctc-msg', JSON.stringify(mydata));\r\n```\r\n\r\næ³¨æ„ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ï¼šæˆ‘ä»¬åœ¨mydataä¸Šæ·»åŠ äº†ä¸€ä¸ªå–å½“å‰æ¯«ç§’æ—¶é—´æˆ³çš„`.st`å±æ€§ã€‚è¿™æ˜¯å› ä¸ºï¼Œ`storage`äº‹ä»¶åªæœ‰åœ¨å€¼çœŸæ­£æ”¹å˜æ—¶æ‰ä¼šè§¦å‘ã€‚ä¸¾ä¸ªä¾‹å­ï¼š\r\n\r\n```\r\nwindow.localStorage.setItem('test', '123');\r\nwindow.localStorage.setItem('test', '123');\r\n```\r\n\r\nç”±äºç¬¬äºŒæ¬¡çš„å€¼`'123'`ä¸ç¬¬ä¸€æ¬¡çš„å€¼ç›¸åŒï¼Œæ‰€ä»¥ä»¥ä¸Šçš„ä»£ç åªä¼šåœ¨ç¬¬ä¸€æ¬¡`setItem`æ—¶è§¦å‘`storage`äº‹ä»¶ã€‚å› æ­¤æˆ‘ä»¬é€šè¿‡è®¾ç½®`st`æ¥ä¿è¯æ¯æ¬¡è°ƒç”¨æ—¶ä¸€å®šä¼šè§¦å‘`storage`äº‹ä»¶ã€‚\r\n\r\n### å°æ†©ä¸€ä¸‹\r\n\r\nä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº†ä¸‰ç§å®ç°è·¨é¡µé¢é€šä¿¡çš„æ–¹å¼ï¼Œä¸è®ºæ˜¯å»ºç«‹å¹¿æ’­é¢‘é“çš„ Broadcast Channelï¼Œè¿˜æ˜¯ä½¿ç”¨ Service Worker çš„æ¶ˆæ¯ä¸­è½¬ç«™ï¼ŒæŠ‘æˆ–æ˜¯äº› tricky çš„`storage`äº‹ä»¶ï¼Œå…¶éƒ½æ˜¯â€œå¹¿æ’­æ¨¡å¼â€ï¼šä¸€ä¸ªé¡µé¢å°†æ¶ˆæ¯é€šçŸ¥ç»™ä¸€ä¸ªâ€œä¸­å¤®ç«™â€ï¼Œå†ç”±â€œä¸­å¤®ç«™â€é€šçŸ¥ç»™å„ä¸ªé¡µé¢ã€‚\r\n\r\n> åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè¿™ä¸ªâ€œä¸­å¤®ç«™â€å¯ä»¥æ˜¯ä¸€ä¸ª BroadCast Channel å®ä¾‹ã€ä¸€ä¸ª Service Worker æˆ–æ˜¯ LocalStorageã€‚\r\n\r\nä¸‹é¢æˆ‘ä»¬ä¼šçœ‹åˆ°å¦å¤–ä¸¤ç§è·¨é¡µé¢é€šä¿¡æ–¹å¼ï¼Œæˆ‘æŠŠå®ƒç§°ä¸ºâ€œå…±äº«å­˜å‚¨+è½®è¯¢æ¨¡å¼â€ã€‚\r\n\r\n---\r\n\r\n### 4. Shared Worker\r\n\r\n[Shared Worker](https://developer.mozilla.org/en-US/docs/Web/API/SharedWorker) æ˜¯ Worker å®¶æ—çš„å¦ä¸€ä¸ªæˆå‘˜ã€‚æ™®é€šçš„ Worker ä¹‹é—´æ˜¯ç‹¬ç«‹è¿è¡Œã€æ•°æ®äº’ä¸ç›¸é€šï¼›è€Œå¤šä¸ª Tab æ³¨å†Œçš„ Shared Worker åˆ™å¯ä»¥å®ç°æ•°æ®å…±äº«ã€‚\r\n\r\nShared Worker åœ¨å®ç°è·¨é¡µé¢é€šä¿¡æ—¶çš„é—®é¢˜åœ¨äºï¼Œå®ƒæ— æ³•ä¸»åŠ¨é€šçŸ¥æ‰€æœ‰é¡µé¢ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨è½®è¯¢çš„æ–¹å¼ï¼Œæ¥æ‹‰å–æœ€æ–°çš„æ•°æ®ã€‚æ€è·¯å¦‚ä¸‹ï¼š\r\n\r\nè®© Shared Worker æ”¯æŒä¸¤ç§æ¶ˆæ¯ã€‚ä¸€ç§æ˜¯ postï¼ŒShared Worker æ”¶åˆ°åä¼šå°†è¯¥æ•°æ®ä¿å­˜ä¸‹æ¥ï¼›å¦ä¸€ç§æ˜¯ getï¼ŒShared Worker æ”¶åˆ°è¯¥æ¶ˆæ¯åä¼šå°†ä¿å­˜çš„æ•°æ®é€šè¿‡`postMessage`ä¼ ç»™æ³¨å†Œå®ƒçš„é¡µé¢ã€‚ä¹Ÿå°±æ˜¯è®©é¡µé¢é€šè¿‡ get æ¥ä¸»åŠ¨è·å–ï¼ˆåŒæ­¥ï¼‰æœ€æ–°æ¶ˆæ¯ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š\r\n\r\né¦–å…ˆï¼Œæˆ‘ä»¬ä¼šåœ¨é¡µé¢ä¸­å¯åŠ¨ä¸€ä¸ª Shared Workerï¼Œå¯åŠ¨æ–¹å¼éå¸¸ç®€å•ï¼š\r\n\r\n```JavaScript\r\n// æ„é€ å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ Shared Worker åç§°ï¼Œä¹Ÿå¯ä»¥ç•™ç©º\r\nconst sharedWorker = new SharedWorker('../util.shared.js', 'ctc');\r\n```\r\n\r\nç„¶åï¼Œåœ¨è¯¥ Shared Worker ä¸­æ”¯æŒ get ä¸ post å½¢å¼çš„æ¶ˆæ¯ï¼š\r\n\r\n```JavaScript\r\n/* ../util.shared.js: Shared Worker ä»£ç  */\r\nlet data = null;\r\nself.addEventListener('connect', function (e) {\r\n    const port = e.ports[0];\r\n    port.addEventListener('message', function (event) {\r\n        // get æŒ‡ä»¤åˆ™è¿”å›å­˜å‚¨çš„æ¶ˆæ¯æ•°æ®\r\n        if (event.data.get) {\r\n            data && port.postMessage(data);\r\n        }\r\n        // é get æŒ‡ä»¤åˆ™å­˜å‚¨è¯¥æ¶ˆæ¯æ•°æ®\r\n        else {\r\n            data = event.data;\r\n        }\r\n    });\r\n    port.start();\r\n});\r\n```\r\n\r\nä¹‹åï¼Œé¡µé¢å®šæ—¶å‘é€ get æŒ‡ä»¤çš„æ¶ˆæ¯ç»™ Shared Workerï¼Œè½®è¯¢æœ€æ–°çš„æ¶ˆæ¯æ•°æ®ï¼Œå¹¶åœ¨é¡µé¢ç›‘å¬è¿”å›ä¿¡æ¯ï¼š\r\n\r\n```JavaScript\r\n// å®šæ—¶è½®è¯¢ï¼Œå‘é€ get æŒ‡ä»¤çš„æ¶ˆæ¯\r\nsetInterval(function () {\r\n    sharedWorker.port.postMessage({get: true});\r\n}, 1000);\r\n\r\n// ç›‘å¬ get æ¶ˆæ¯çš„è¿”å›æ•°æ®\r\nsharedWorker.port.addEventListener('message', (e) => {\r\n    const data = e.data;\r\n    const text = '[receive] ' + data.msg + ' â€”â€” tab ' + data.from;\r\n    console.log('[Shared Worker] receive message:', text);\r\n}, false);\r\nsharedWorker.port.start();\r\n```\r\n\r\næœ€åï¼Œå½“è¦è·¨é¡µé¢é€šä¿¡æ—¶ï¼Œåªéœ€ç»™ Shared Worker `postMessage`å³å¯ï¼š\r\n\r\n```JavaScript\r\nsharedWorker.port.postMessage(mydata);\r\n```\r\n\r\n> æ³¨æ„ï¼Œå¦‚æœä½¿ç”¨`addEventListener`æ¥æ·»åŠ  Shared Worker çš„æ¶ˆæ¯ç›‘å¬ï¼Œéœ€è¦æ˜¾å¼è°ƒç”¨`MessagePort.start`æ–¹æ³•ï¼Œå³ä¸Šæ–‡ä¸­çš„`sharedWorker.port.start()`ï¼›å¦‚æœä½¿ç”¨`onmessage`ç»‘å®šç›‘å¬åˆ™ä¸éœ€è¦ã€‚\r\n\r\n### 5. IndexedDB\r\n\r\né™¤äº†å¯ä»¥åˆ©ç”¨ Shared Worker æ¥å…±äº«å­˜å‚¨æ•°æ®ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–ä¸€äº›â€œå…¨å±€æ€§â€ï¼ˆæ”¯æŒè·¨é¡µé¢ï¼‰çš„å­˜å‚¨æ–¹æ¡ˆã€‚ä¾‹å¦‚ [IndexedDB](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API) æˆ– cookieã€‚\r\n\r\n> é‰´äºå¤§å®¶å¯¹ cookie å·²ç»å¾ˆç†Ÿæ‚‰ï¼ŒåŠ ä¹‹ä½œä¸ºâ€œäº’è”ç½‘æœ€æ—©æœŸçš„å­˜å‚¨æ–¹æ¡ˆä¹‹ä¸€â€ï¼Œcookie å·²ç»åœ¨å®é™…åº”ç”¨ä¸­æ‰¿å—äº†è¿œå¤šäºå…¶è®¾è®¡ä¹‹åˆçš„è´£ä»»ï¼Œæˆ‘ä»¬ä¸‹é¢ä¼šä½¿ç”¨ IndexedDB æ¥å®ç°ã€‚\r\n\r\nå…¶æ€è·¯å¾ˆç®€å•ï¼šä¸ Shared Worker æ–¹æ¡ˆç±»ä¼¼ï¼Œæ¶ˆæ¯å‘é€æ–¹å°†æ¶ˆæ¯å­˜è‡³ IndexedDB ä¸­ï¼›æ¥æ”¶æ–¹ï¼ˆä¾‹å¦‚æ‰€æœ‰é¡µé¢ï¼‰åˆ™é€šè¿‡è½®è¯¢å»è·å–æœ€æ–°çš„ä¿¡æ¯ã€‚åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç®€å•å°è£…å‡ ä¸ª IndexedDB çš„å·¥å…·æ–¹æ³•ã€‚\r\n\r\n- æ‰“å¼€æ•°æ®åº“è¿æ¥ï¼š\r\n\r\n```JavaScript\r\nfunction openStore() {\r\n    const storeName = 'ctc_aleinzhou';\r\n    return new Promise(function (resolve, reject) {\r\n        if (!('indexedDB' in window)) {\r\n            return reject('don\\'t support indexedDB');\r\n        }\r\n        const request = indexedDB.open('CTC_DB', 1);\r\n        request.onerror = reject;\r\n        request.onsuccess =  e => resolve(e.target.result);\r\n        request.onupgradeneeded = function (e) {\r\n            const db = e.srcElement.result;\r\n            if (e.oldVersion === 0 && !db.objectStoreNames.contains(storeName)) {\r\n                const store = db.createObjectStore(storeName, {keyPath: 'tag'});\r\n                store.createIndex(storeName + 'Index', 'tag', {unique: false});\r\n            }\r\n        }\r\n    });\r\n}\r\n```\r\n\r\n- å­˜å‚¨æ•°æ®\r\n\r\n```JavaScript\r\nfunction saveData(db, data) {\r\n    return new Promise(function (resolve, reject) {\r\n        const STORE_NAME = 'ctc_aleinzhou';\r\n        const tx = db.transaction(STORE_NAME, 'readwrite');\r\n        const store = tx.objectStore(STORE_NAME);\r\n        const request = store.put({tag: 'ctc_data', data});\r\n        request.onsuccess = () => resolve(db);\r\n        request.onerror = reject;\r\n    });\r\n}\r\n```\r\n\r\n- æŸ¥è¯¢/è¯»å–æ•°æ®\r\n\r\n```JavaScript\r\nfunction query(db) {\r\n    const STORE_NAME = 'ctc_aleinzhou';\r\n    return new Promise(function (resolve, reject) {\r\n        try {\r\n            const tx = db.transaction(STORE_NAME, 'readonly');\r\n            const store = tx.objectStore(STORE_NAME);\r\n            const dbRequest = store.get('ctc_data');\r\n            dbRequest.onsuccess = e => resolve(e.target.result);\r\n            dbRequest.onerror = reject;\r\n        }\r\n        catch (err) {\r\n            reject(err);\r\n        }\r\n    });\r\n}\r\n```\r\n\r\nå‰©ä¸‹çš„å·¥ä½œå°±éå¸¸ç®€å•äº†ã€‚é¦–å…ˆæ‰“å¼€æ•°æ®è¿æ¥ï¼Œå¹¶åˆå§‹åŒ–æ•°æ®ï¼š\r\n\r\n```JavaScript\r\nopenStore().then(db => saveData(db, null))\r\n```\r\n\r\nå¯¹äºæ¶ˆæ¯è¯»å–ï¼Œå¯ä»¥åœ¨è¿æ¥ä¸åˆå§‹åŒ–åè½®è¯¢ï¼š\r\n\r\n```JavaScript\r\nopenStore().then(db => saveData(db, null)).then(function (db) {\r\n    setInterval(function () {\r\n        query(db).then(function (res) {\r\n            if (!res || !res.data) {\r\n                return;\r\n            }\r\n            const data = res.data;\r\n            const text = '[receive] ' + data.msg + ' â€”â€” tab ' + data.from;\r\n            console.log('[Storage I] receive message:', text);\r\n        });\r\n    }, 1000);\r\n});\r\n```\r\n\r\næœ€åï¼Œè¦å‘é€æ¶ˆæ¯æ—¶ï¼Œåªéœ€å‘ IndexedDB å­˜å‚¨æ•°æ®å³å¯ï¼š\r\n\r\n```JavaScript\r\nopenStore().then(db => saveData(db, null)).then(function (db) {\r\n    // â€¦â€¦ çœç•¥ä¸Šé¢çš„è½®è¯¢ä»£ç \r\n    // è§¦å‘ saveData çš„æ–¹æ³•å¯ä»¥æ”¾åœ¨ç”¨æˆ·æ“ä½œçš„äº‹ä»¶ç›‘å¬å†…\r\n    saveData(db, mydata);\r\n});\r\n```\r\n\r\n### å°æ†©ä¸€ä¸‹\r\n\r\nåœ¨â€œå¹¿æ’­æ¨¡å¼â€å¤–ï¼Œæˆ‘ä»¬åˆäº†è§£äº†â€œå…±äº«å­˜å‚¨+é•¿è½®è¯¢â€è¿™ç§æ¨¡å¼ã€‚ä¹Ÿè®¸ä½ ä¼šè®¤ä¸ºé•¿è½®è¯¢æ²¡æœ‰ç›‘å¬æ¨¡å¼ä¼˜é›…ï¼Œä½†å®é™…ä¸Šï¼Œæœ‰äº›æ—¶å€™ä½¿ç”¨â€œå…±äº«å­˜å‚¨â€çš„å½¢å¼æ—¶ï¼Œä¸ä¸€å®šè¦æ­é…é•¿è½®è¯¢ã€‚\r\n\r\nä¾‹å¦‚ï¼Œåœ¨å¤š Tab åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç¦»å¼€ Tab A åˆ°å¦ä¸€ä¸ª Tab B ä¸­æ“ä½œï¼›è¿‡äº†ä¸€ä¼šæˆ‘ä»¬ä» Tab B åˆ‡æ¢å› Tab A æ—¶ï¼Œå¸Œæœ›å°†ä¹‹å‰åœ¨ Tab B ä¸­çš„æ“ä½œçš„ä¿¡æ¯åŒæ­¥å›æ¥ã€‚è¿™æ—¶å€™ï¼Œå…¶å®åªç”¨åœ¨ Tab A ä¸­ç›‘å¬`visibilitychange`è¿™æ ·çš„äº‹ä»¶ï¼Œæ¥åšä¸€æ¬¡ä¿¡æ¯åŒæ­¥å³å¯ã€‚\r\n\r\nä¸‹é¢ï¼Œæˆ‘ä¼šå†ä»‹ç»ä¸€ç§é€šä¿¡æ–¹å¼ï¼Œæˆ‘æŠŠå®ƒç§°ä¸ºâ€œå£å£ç›¸ä¼ â€æ¨¡å¼ã€‚\r\n\r\n---\r\n\r\n### 6. window.open + window.opener\r\n\r\nå½“æˆ‘ä»¬ä½¿ç”¨`window.open`æ‰“å¼€é¡µé¢æ—¶ï¼Œæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªè¢«æ‰“å¼€é¡µé¢`window`çš„å¼•ç”¨ã€‚è€Œåœ¨æœªæ˜¾ç¤ºæŒ‡å®š`noopener`æ—¶ï¼Œè¢«æ‰“å¼€çš„é¡µé¢å¯ä»¥é€šè¿‡`window.opener`è·å–åˆ°æ‰“å¼€å®ƒçš„é¡µé¢çš„å¼•ç”¨ â€”â€” é€šè¿‡è¿™ç§æ–¹å¼æˆ‘ä»¬å°±å°†è¿™äº›é¡µé¢å»ºç«‹èµ·äº†è”ç³»ï¼ˆä¸€ç§æ ‘å½¢ç»“æ„ï¼‰ã€‚\r\n\r\né¦–å…ˆï¼Œæˆ‘ä»¬æŠŠ`window.open`æ‰“å¼€çš„é¡µé¢çš„`window`å¯¹è±¡æ”¶é›†èµ·æ¥ï¼š\r\n\r\n```JavaScript\r\nlet childWins = [];\r\ndocument.getElementById('btn').addEventListener('click', function () {\r\n    const win = window.open('./some/sample');\r\n    childWins.push(win);\r\n});\r\n```\r\n\r\nç„¶åï¼Œå½“æˆ‘ä»¬éœ€è¦å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œä½œä¸ºæ¶ˆæ¯çš„å‘èµ·æ–¹ï¼Œä¸€ä¸ªé¡µé¢éœ€è¦åŒæ—¶é€šçŸ¥å®ƒæ‰“å¼€çš„é¡µé¢ä¸æ‰“å¼€å®ƒçš„é¡µé¢ï¼š\r\n\r\n```JavaScript\r\n// è¿‡æ»¤æ‰å·²ç»å…³é—­çš„çª—å£\r\nchildWins = childWins.filter(w => !w.closed);\r\nif (childWins.length > 0) {\r\n    mydata.fromOpenner = false;\r\n    childWins.forEach(w => w.postMessage(mydata));\r\n}\r\nif (window.opener && !window.opener.closed) {\r\n    mydata.fromOpenner = true;\r\n    window.opener.postMessage(mydata);\r\n}\r\n```\r\n\r\næ³¨æ„ï¼Œæˆ‘è¿™é‡Œå…ˆç”¨`.closed`å±æ€§è¿‡æ»¤æ‰å·²ç»è¢«å…³é—­çš„ Tab çª—å£ã€‚è¿™æ ·ï¼Œä½œä¸ºæ¶ˆæ¯å‘é€æ–¹çš„ä»»åŠ¡å°±å®Œæˆäº†ã€‚ä¸‹é¢çœ‹çœ‹ï¼Œä½œä¸ºæ¶ˆæ¯æ¥æ”¶æ–¹ï¼Œå®ƒéœ€è¦åšä»€ä¹ˆã€‚\r\n\r\næ­¤æ—¶ï¼Œä¸€ä¸ªæ”¶åˆ°æ¶ˆæ¯çš„é¡µé¢å°±ä¸èƒ½é‚£ä¹ˆè‡ªç§äº†ï¼Œé™¤äº†å±•ç¤ºæ”¶åˆ°çš„æ¶ˆæ¯ï¼Œå®ƒè¿˜éœ€è¦å°†æ¶ˆæ¯å†ä¼ é€’ç»™å®ƒæ‰€â€œçŸ¥é“çš„äººâ€ï¼ˆæ‰“å¼€ä¸è¢«å®ƒæ‰“å¼€çš„é¡µé¢ï¼‰:\r\n\r\n> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘è¿™é‡Œé€šè¿‡åˆ¤æ–­æ¶ˆæ¯æ¥æºï¼Œé¿å…å°†æ¶ˆæ¯å›ä¼ ç»™å‘é€æ–¹ï¼Œé˜²æ­¢æ¶ˆæ¯åœ¨ä¸¤è€…é—´æ­»å¾ªç¯çš„ä¼ é€’ã€‚ï¼ˆè¯¥æ–¹æ¡ˆä¼šæœ‰äº›å…¶ä»–å°é—®é¢˜ï¼Œå®é™…ä¸­å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼‰\r\n\r\n```JavaScript\r\nwindow.addEventListener('message', function (e) {\r\n    const data = e.data;\r\n    const text = '[receive] ' + data.msg + ' â€”â€” tab ' + data.from;\r\n    console.log('[Cross-document Messaging] receive message:', text);\r\n    // é¿å…æ¶ˆæ¯å›ä¼ \r\n    if (window.opener && !window.opener.closed && data.fromOpenner) {\r\n        window.opener.postMessage(data);\r\n    }\r\n    // è¿‡æ»¤æ‰å·²ç»å…³é—­çš„çª—å£\r\n    childWins = childWins.filter(w => !w.closed);\r\n    // é¿å…æ¶ˆæ¯å›ä¼ \r\n    if (childWins && !data.fromOpenner) {\r\n        childWins.forEach(w => w.postMessage(data));\r\n    }\r\n});\r\n```\r\n\r\nè¿™æ ·ï¼Œæ¯ä¸ªèŠ‚ç‚¹ï¼ˆé¡µé¢ï¼‰éƒ½è‚©è´Ÿèµ·äº†ä¼ é€’æ¶ˆæ¯çš„è´£ä»»ï¼Œä¹Ÿå°±æ˜¯æˆ‘è¯´çš„â€œå£å£ç›¸ä¼ â€ï¼Œè€Œæ¶ˆæ¯å°±åœ¨è¿™ä¸ªæ ‘çŠ¶ç»“æ„ä¸­æµè½¬äº†èµ·æ¥ã€‚\r\n\r\n### å°æ†©ä¸€ä¸‹\r\n\r\næ˜¾ç„¶ï¼Œâ€œå£å£ç›¸ä¼ â€çš„æ¨¡å¼å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœé¡µé¢ä¸æ˜¯é€šè¿‡åœ¨å¦ä¸€ä¸ªé¡µé¢å†…çš„`window.open`æ‰“å¼€çš„ï¼ˆä¾‹å¦‚ç›´æ¥åœ¨åœ°å€æ è¾“å…¥ï¼Œæˆ–ä»å…¶ä»–ç½‘ç«™é“¾æ¥è¿‡æ¥ï¼‰ï¼Œè¿™ä¸ªè”ç³»å°±è¢«æ‰“ç ´äº†ã€‚\r\n\r\né™¤äº†ä¸Šé¢è¿™å…­ä¸ªå¸¸è§æ–¹æ³•ï¼Œå…¶å®è¿˜æœ‰ä¸€ç§ï¼ˆç¬¬ä¸ƒç§ï¼‰åšæ³•æ˜¯é€šè¿‡ WebSocket è¿™ç±»çš„â€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯æ¥è¿›è¡ŒåŒæ­¥ã€‚è¿™å¥½æ¯”å°†æˆ‘ä»¬çš„â€œä¸­å¤®ç«™â€ä»å‰ç«¯ç§»åˆ°äº†åç«¯ã€‚\r\n\r\nå…³äº WebSocket ä¸å…¶ä»–â€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯ï¼Œä¸äº†è§£çš„åŒå­¦å¯ä»¥é˜…è¯»è¿™ç¯‡[ã€Šå„ç±»â€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯åŸç†ä¸å®ä¾‹ï¼ˆPolling/COMET/SSE/WebSocketï¼‰ã€‹](https://juejin.im/post/5b135b78f265da6e420eab7d)\r\n\r\næ­¤å¤–ï¼Œæˆ‘è¿˜é’ˆå¯¹ä»¥ä¸Šå„ç§æ–¹å¼å†™äº†ä¸€ä¸ª [åœ¨çº¿æ¼”ç¤ºçš„ Demo >>](https://alienzhou.github.io/cross-tab-communication/)\r\n\r\n\r\n![Demoé¡µé¢](https://user-gold-cdn.xitu.io/2019/4/1/169d8701f85f9f33?w=1917&h=850&f=gif&s=1480792)\r\n\r\n\r\n## äºŒã€éåŒæºé¡µé¢ä¹‹é—´çš„é€šä¿¡\r\n\r\nä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†ä¸ƒç§å‰ç«¯è·¨é¡µé¢é€šä¿¡çš„æ–¹æ³•ï¼Œä½†å®ƒä»¬å¤§éƒ½å—åˆ°åŒæºç­–ç•¥çš„é™åˆ¶ã€‚ç„¶è€Œæœ‰æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªä¸åŒåŸŸåçš„äº§å“çº¿ï¼Œä¹Ÿå¸Œæœ›å®ƒä»¬ä¸‹é¢çš„æ‰€æœ‰é¡µé¢ä¹‹é—´èƒ½æ— éšœç¢åœ°é€šä¿¡ã€‚é‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ\r\n\r\nè¦å®ç°è¯¥åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªç”¨æˆ·ä¸å¯è§çš„ iframe ä½œä¸ºâ€œæ¡¥â€ã€‚ç”±äº iframe ä¸çˆ¶é¡µé¢é—´å¯ä»¥é€šè¿‡æŒ‡å®š`origin`æ¥å¿½ç•¥åŒæºé™åˆ¶ï¼Œå› æ­¤å¯ä»¥åœ¨æ¯ä¸ªé¡µé¢ä¸­åµŒå…¥ä¸€ä¸ª iframe ï¼ˆä¾‹å¦‚ï¼š`http://sample.com/bridge.html`ï¼‰ï¼Œè€Œè¿™äº› iframe ç”±äºä½¿ç”¨çš„æ˜¯ä¸€ä¸ª urlï¼Œå› æ­¤å±äºåŒæºé¡µé¢ï¼Œå…¶é€šä¿¡æ–¹å¼å¯ä»¥å¤ç”¨ä¸Šé¢ç¬¬ä¸€éƒ¨åˆ†æåˆ°çš„å„ç§æ–¹å¼ã€‚\r\n\r\né¡µé¢ä¸ iframe é€šä¿¡éå¸¸ç®€å•ï¼Œé¦–å…ˆéœ€è¦åœ¨é¡µé¢ä¸­ç›‘å¬ iframe å‘æ¥çš„æ¶ˆæ¯ï¼Œåšç›¸åº”çš„ä¸šåŠ¡å¤„ç†ï¼š\r\n\r\n```JavaScript\r\n/* ä¸šåŠ¡é¡µé¢ä»£ç  */\r\nwindow.addEventListener('message', function (e) {\r\n    // â€¦â€¦ do something\r\n});\r\n```\r\n\r\nç„¶åï¼Œå½“é¡µé¢è¦ä¸å…¶ä»–çš„åŒæºæˆ–éåŒæºé¡µé¢é€šä¿¡æ—¶ï¼Œä¼šå…ˆç»™ iframe å‘é€æ¶ˆæ¯ï¼š\r\n\r\n```JavaScript\r\n/* ä¸šåŠ¡é¡µé¢ä»£ç  */\r\nwindow.frames[0].window.postMessage(mydata, '*');\r\n```\r\n\r\nå…¶ä¸­ä¸ºäº†ç®€ä¾¿æ­¤å¤„å°†`postMessage`çš„ç¬¬äºŒä¸ªå‚æ•°è®¾ä¸ºäº†`'*'`ï¼Œä½ ä¹Ÿå¯ä»¥è®¾ä¸º iframe çš„ URLã€‚iframe æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šä½¿ç”¨æŸç§è·¨é¡µé¢æ¶ˆæ¯é€šä¿¡æŠ€æœ¯åœ¨æ‰€æœ‰ iframe é—´åŒæ­¥æ¶ˆæ¯ï¼Œä¾‹å¦‚ä¸‹é¢ä½¿ç”¨çš„ Broadcast Channelï¼š\r\n\r\n```JavaScript\r\n/* iframe å†…ä»£ç  */\r\nconst bc = new BroadcastChannel('AlienZHOU');\r\n// æ”¶åˆ°æ¥è‡ªé¡µé¢çš„æ¶ˆæ¯åï¼Œåœ¨ iframe é—´è¿›è¡Œå¹¿æ’­\r\nwindow.addEventListener('message', function (e) {\r\n    bc.postMessage(e.data);\r\n});    \r\n```\r\n\r\nå…¶ä»– iframe æ”¶åˆ°é€šçŸ¥åï¼Œåˆ™ä¼šå°†è¯¥æ¶ˆæ¯åŒæ­¥ç»™æ‰€å±çš„é¡µé¢ï¼š\r\n\r\n```JavaScript\r\n/* iframe å†…ä»£ç  */\r\n// å¯¹äºæ”¶åˆ°çš„ï¼ˆiframeï¼‰å¹¿æ’­æ¶ˆæ¯ï¼Œé€šçŸ¥ç»™æ‰€å±çš„ä¸šåŠ¡é¡µé¢\r\nbc.onmessage = function (e) {\r\n    window.parent.postMessage(e.data, '*');\r\n};\r\n```\r\n\r\nä¸‹å›¾å°±æ˜¯ä½¿ç”¨ iframe ä½œä¸ºâ€œæ¡¥â€çš„éåŒæºé¡µé¢é—´é€šä¿¡æ¨¡å¼å›¾ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/3/31/169d468988a6ba8f?w=568&h=277&f=png&s=32299)\r\n\r\nå…¶ä¸­â€œåŒæºè·¨åŸŸé€šä¿¡æ–¹æ¡ˆâ€å¯ä»¥ä½¿ç”¨æ–‡ç« ç¬¬ä¸€éƒ¨åˆ†æåˆ°çš„æŸç§æŠ€æœ¯ã€‚\r\n\r\n---\r\n\r\n## æ€»ç»“\r\n\r\nä»Šå¤©å’Œå¤§å®¶åˆ†äº«äº†ä¸€ä¸‹è·¨é¡µé¢é€šä¿¡çš„å„ç§æ–¹å¼ã€‚\r\n\r\nå¯¹äºåŒæºé¡µé¢ï¼Œå¸¸è§çš„æ–¹å¼åŒ…æ‹¬ï¼š\r\n\r\n- å¹¿æ’­æ¨¡å¼ï¼šBroadcast Channe / Service Worker / LocalStorage + StorageEvent\r\n- å…±äº«å­˜å‚¨æ¨¡å¼ï¼šShared Worker / IndexedDB / cookie\r\n- å£å£ç›¸ä¼ æ¨¡å¼ï¼šwindow.open + window.opener\r\n- åŸºäºæœåŠ¡ç«¯ï¼šWebsocket / Comet / SSE ç­‰\r\n\r\nè€Œå¯¹äºéåŒæºé¡µé¢ï¼Œåˆ™å¯ä»¥é€šè¿‡åµŒå…¥åŒæº iframe ä½œä¸ºâ€œæ¡¥â€ï¼Œå°†éåŒæºé¡µé¢é€šä¿¡è½¬æ¢ä¸ºåŒæºé¡µé¢é€šä¿¡ã€‚\r\n\r\næœ¬æ–‡åœ¨åˆ†äº«çš„åŒæ—¶ï¼Œä¹Ÿæ˜¯ä¸ºäº†æŠ›è½¬å¼•ç‰ã€‚å¦‚æœä½ æœ‰ä»€ä¹ˆå…¶ä»–æƒ³æ³•ï¼Œæ¬¢è¿ä¸€èµ·è®¨è®ºï¼Œæå‡ºä½ çš„è§è§£å’Œæƒ³æ³•~\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/26","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/26/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/26/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/26/events","html_url":"https://github.com/alienzhou/blog/issues/26","id":427657608,"node_id":"MDU6SXNzdWU0Mjc2NTc2MDg=","number":26,"title":"ã€3åˆ†é’Ÿé€Ÿè§ˆã€‘å‰ç«¯å¹¿æ’­å¼é€šä¿¡ï¼šBroadcast Channel","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845015,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E6%B5%8F%E8%A7%88%E5%99%A8","name":"æµè§ˆå™¨","color":"cfd3d7","default":false,"description":""},{"id":1298890220,"node_id":"MDU6TGFiZWwxMjk4ODkwMjIw","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%89%B9%E6%80%A7","name":"ç‰¹æ€§","color":"c2e0c6","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-04-01T11:40:23Z","updated_at":"2019-07-24T04:06:19Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## Broadcast Channel æ˜¯ä»€ä¹ˆï¼Ÿ\r\n\r\nåœ¨å‰ç«¯ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šç”¨`postMessage`æ¥å®ç°é¡µé¢é—´çš„é€šä¿¡ï¼Œä½†è¿™ç§æ–¹å¼æ›´åƒæ˜¯ç‚¹å¯¹ç‚¹çš„é€šä¿¡ã€‚å¯¹äºä¸€äº›éœ€è¦å¹¿æ’­ï¼ˆè®©æ‰€æœ‰é¡µé¢çŸ¥é“ï¼‰çš„æ¶ˆæ¯ï¼Œç”¨`postMessage`ä¸æ˜¯éå¸¸è‡ªç„¶ã€‚Broadcast Channel å°±æ˜¯ç”¨æ¥å¼¥è¡¥è¿™ä¸ªç¼ºé™·çš„ã€‚\r\n\r\né¡¾åæ€ä¹‰ï¼ŒBroadcast Channel ä¼šåˆ›å»ºä¸€ä¸ªæ‰€æœ‰åŒæºé¡µé¢éƒ½å¯ä»¥å…±äº«çš„ï¼ˆå¹¿æ’­ï¼‰é¢‘é“ï¼Œå› æ­¤å…¶ä¸­æŸä¸€ä¸ªé¡µé¢å‘é€çš„æ¶ˆæ¯å¯ä»¥è¢«å…¶ä»–é¡µé¢ç›‘å¬åˆ°ã€‚\r\n\r\nä¸‹é¢å°±æ¥é€Ÿè§ˆä¸€ä¸‹å®ƒçš„ä½¿ç”¨æ–¹æ³•ã€‚\r\n\r\n## å¦‚ä½•ä½¿ç”¨ï¼Ÿ\r\n\r\nBroadcast Channel çš„ API éå¸¸ç®€å•æ˜“ç”¨ã€‚\r\n\r\n### åˆ›å»º\r\n\r\né¦–å…ˆæˆ‘ä»¬ä¼šä½¿ç”¨æ„é€ å‡½æ•°åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼š\r\n\r\n```JavaScript\r\nconst bc = new BroadcastChannel('alienzhou');\r\n```\r\n\r\nå¯ä»¥æ¥å—ä¸€ä¸ª`DOMString`ä½œä¸º nameï¼Œç”¨ä»¥æ ‡è¯†è¿™ä¸ª channelã€‚åœ¨å…¶ä»–é¡µé¢ï¼Œå¯ä»¥é€šè¿‡ä¼ å…¥ç›¸åŒçš„ name æ¥ä½¿ç”¨åŒä¸€ä¸ªå¹¿æ’­é¢‘é“ã€‚ç”¨ MDN ä¸Šçš„è¯æ¥è§£é‡Šå°±æ˜¯ï¼š\r\n\r\n> There is one single channel with this name for all browsing contexts with the same origin.\r\n\r\nè¯¥ name å€¼å¯ä»¥é€šè¿‡å®ä¾‹çš„`.name`å±æ€§è·å¾—\r\n\r\n```JavaScript\r\nconsole.log(bc.name);\r\n// alienzhou\r\n```\r\n\r\n### ç›‘å¬æ¶ˆæ¯\r\n\r\nBroadcast Channel åˆ›å»ºå®Œæˆåï¼Œå°±å¯ä»¥åœ¨é¡µé¢ç›‘å¬å¹¿æ’­çš„æ¶ˆæ¯ï¼š\r\n\r\n```JavaScript\r\nbc.onmessage = function(e) {\r\n    console.log('receive:', e.data);\r\n};\r\n```\r\n\r\nå¯¹äºé”™è¯¯ä¹Ÿå¯ä»¥ç»‘å®šç›‘å¬ï¼š\r\n\r\n```JavaScript\r\nbc.onmessageerror = function(e) {\r\n    console.warn('error:', e);\r\n};\r\n```\r\n\r\n> é™¤äº†ä¸º`.onmessage`èµ‹å€¼è¿™ç§æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`addEventListener`æ¥æ·»åŠ `'message'`ç›‘å¬ã€‚\r\n\r\n### å‘é€æ¶ˆæ¯\r\n\r\nBroadcast Channel å®ä¾‹ä¹Ÿæœ‰ä¸€ä¸ªå¯¹åº”çš„`postMessage`ç”¨äºå‘é€æ¶ˆæ¯ï¼š\r\n\r\n```JavaScript\r\nbc.postMessage('hello')\r\n```\r\n\r\n### å…³é—­\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œä¸Šè¿°çŸ­çŸ­å‡ è¡Œä»£ç å°±å¯ä»¥å®ç°å¤šä¸ªé¡µé¢é—´çš„å¹¿æ’­é€šä¿¡ï¼Œéå¸¸æ–¹ä¾¿ã€‚è€Œæœ‰æ—¶æˆ‘ä»¬å¸Œæœ›å–æ¶ˆå½“å‰é¡µé¢çš„å¹¿æ’­ç›‘å¬ï¼š\r\n- ä¸€ç§æ–¹å¼æ˜¯å–æ¶ˆæˆ–è€…ä¿®æ”¹ç›¸åº”çš„`'message'`äº‹ä»¶ç›‘å¬\r\n- å¦ä¸€ç§ç®€å•çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ Broadcast Channel å®ä¾‹ä¸ºæˆ‘ä»¬æä¾›çš„`close`æ–¹æ³•ã€‚\r\n\r\n```JavaScript\r\nbc.close();\r\n```\r\n\r\nä¸¤è€…æ˜¯æœ‰åŒºåˆ«çš„ï¼š\r\n\r\nå–æ¶ˆ`'message'`ç›‘å¬åªæ˜¯è®©é¡µé¢ä¸å¯¹å¹¿æ’­æ¶ˆæ¯è¿›è¡Œå“åº”ï¼ŒBroadcast Channel ä»ç„¶å­˜åœ¨ï¼›è€Œè°ƒç”¨`close`æ–¹æ³•è¿™ä¼šåˆ‡æ–­ä¸ Broadcast Channel çš„è¿æ¥ï¼Œæµè§ˆå™¨æ‰èƒ½å¤Ÿå°è¯•å›æ”¶è¯¥å¯¹è±¡ï¼Œå› ä¸ºæ­¤æ—¶æµè§ˆå™¨æ‰ä¼šçŸ¥é“ç”¨æˆ·å·²ç»ä¸éœ€è¦ä½¿ç”¨å¹¿æ’­é¢‘é“äº†ã€‚\r\n\r\nåœ¨å…³é—­åè°ƒç”¨`postMessage`ä¼šå‡ºç°å¦‚ä¸‹æŠ¥é”™\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/4/1/169d80b1620cdac9?w=2100&h=74&f=png&s=71151)\r\n\r\nå¦‚æœä¹‹ååˆå†éœ€è¦å¹¿æ’­ï¼Œåˆ™å¯ä»¥é‡æ–°åˆ›å»ºä¸€ä¸ªç›¸åŒ name çš„ Broadcast Channelã€‚\r\n\r\n## Demo æ•ˆæœ\r\n\r\n[å¯ä»¥æˆ³è¿™é‡ŒæŸ¥çœ‹åœ¨çº¿ Demo >>](https://alienzhou.github.io/broadcast-channel/)\r\n\r\nä¸‹é¢æ˜¯ Broadcast Channel Demo çš„æ¼”ç¤ºæ•ˆæœï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/4/1/169d8452cef80241?w=1435&h=875&f=gif&s=523961)\r\n\r\n## å…¼å®¹æ€§å¦‚ä½•ï¼Ÿ\r\n\r\nBroadcast Channel æ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„å¤šé¡µé¢æ¶ˆæ¯åŒæ­¥ APIï¼Œç„¶è€Œå…¼å®¹æ€§å´**ä¸æ˜¯å¾ˆä¹è§‚**ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2019/4/1/169d80efd65b5401?w=2544&h=1186&f=png&s=584864)\r\n\r\n> å¥½åœ¨æˆ‘ä»¬è¿˜æœ‰äº›å…¶ä»–æ–¹æ¡ˆå¯ä»¥ä½œä¸ºè¡¥å……ï¼ˆæˆ–è€…ä½œä¸ºpolyfillï¼‰ï¼Œå…¶ä»–çš„å‰ç«¯è·¨é¡µé¢é€šä¿¡å¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« [ã€Šå‰ç«¯è·¨é¡µé¢é€šä¿¡çš„æ–¹æ³•ã€‹](https://github.com/alienzhou/blog/issues/27)ã€‚","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/25","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/25/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/25/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/25/events","html_url":"https://github.com/alienzhou/blog/issues/25","id":394016721,"node_id":"MDU6SXNzdWUzOTQwMTY3MjE=","number":25,"title":"ã€æ¼«æ¸¸Githubã€‘quicklinkï¼šå®ç°åŸç†ä¸ç»™å‰ç«¯çš„å¯å‘","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845014,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE0","url":"https://api.github.com/repos/alienzhou/blog/labels/JavaScript","name":"JavaScript","color":"d73a4a","default":false,"description":""},{"id":1159845015,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E6%B5%8F%E8%A7%88%E5%99%A8","name":"æµè§ˆå™¨","color":"cfd3d7","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-25T12:45:07Z","updated_at":"2020-01-04T01:18:21Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"è¿‘æ¥ï¼ŒGoogleChromeLabs æ¨å‡ºäº† [quicklink](https://github.com/GoogleChromeLabs/quicklink)ï¼Œç”¨ä»¥å®ç°é“¾æ¥èµ„æºçš„é¢„åŠ è½½ï¼ˆprefetchï¼‰ã€‚æœ¬æ–‡åœ¨ä»‹ç»å…¶å®ç°æ€è·¯çš„åŸºç¡€ä¸Šï¼Œä¼šè¿›ä¸€æ­¥æ¢è®¨åœ¨é¢„åŠ è½½æ–¹é¢å‰ç«¯å·¥ç¨‹å¸ˆè¿˜å¯ä»¥åšä»€ä¹ˆã€‚\r\n\r\n## 1. quicklink æ˜¯ä»€ä¹ˆçš„ï¼Ÿ\r\n\r\nquicklink æ˜¯ä¸€ä¸ªé€šè¿‡é¢„åŠ è½½èµ„æºæ¥æå‡åç»­æ–¹æ¡ˆé€Ÿåº¦çš„è½»é‡çº§å·¥å…·åº“ã€‚æ—¨åœ¨æå‡æµè§ˆè¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·è®¿é—®åç»­é¡µé¢æ—¶çš„åŠ è½½é€Ÿåº¦ã€‚\r\n\r\nå½“æˆ‘ä»¬æåˆ°æ€§èƒ½ä¼˜åŒ–ï¼Œå¾€å¾€éƒ½ä¼šç€çœ¼äºå¯¹å½“å‰ç”¨æˆ·è®¿é—®çš„è¿™ä¸ªé¡µé¢ï¼Œå¦‚ä½•é€šè¿‡å‹ç¼©èµ„æºå¤§å°ã€åˆ å‡ä¸å¿…è¦èµ„æºã€åŠ å¿«é¡µé¢è§£ææ¸²æŸ“ç­‰æ–¹å¼æå‡ç”¨æˆ·çš„è®¿é—®é€Ÿåº¦ï¼›è€Œ quicklink ç”¨äº†å¦ä¸€ç§æ€è·¯ï¼šæˆ‘é¢„å…ˆå¸®ä½ åŠ è½½ï¼ˆè·å–ï¼‰ä½ æ¥ä¸‹æ¥æœ€å¯èƒ½è¦ç”¨çš„èµ„æºï¼Œè¿™æ ·ä¹‹åçš„çœŸæ­£ä½¿ç”¨åˆ°è¯¥èµ„æºï¼ˆé“¾æ¥ï¼‰æ—¶å°±ä¼šæ„Ÿè§‰éå¸¸é¡ºç•…ã€‚\r\n\r\nç…§ç€è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³çš„é—®é¢˜å°±æ˜¯å¦‚ä½•é¢„å…ˆå¸®ç”¨æˆ·åŠ è½½èµ„æºå‘¢ï¼Ÿè¿™é‡Œå…¶å®æ¶‰åŠåˆ°ä¸¤ä¸ªé—®é¢˜ï¼š\r\n\r\n- å¦‚ä½•å»é¢„åŠ è½½ä¸€ä¸ªæŒ‡å®šèµ„æºï¼Ÿï¼ˆé¢„åŠ è½½çš„æ–¹å¼ï¼‰\r\n- å¦‚ä½•ç¡®å®šæŸä¸ªèµ„æºæ˜¯å¦è¦åŠ è½½ï¼Ÿï¼ˆé¢„åŠ è½½çš„ç­–ç•¥ï¼‰\r\n\r\nä¸‹é¢å°±ç»“åˆ quicklink æºç æ¥çœ‹çœ‹å¦‚ä½•è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ã€‚\r\n\r\n> æ³¨ï¼šä¸‹æ–‡æåˆ°çš„â€œé¢„åŠ è½½â€/â€œé¢„è·å–â€å‡æŒ‡ prefetch\r\n\r\n## 2. quicklink å®ç°åŸç†\r\n\r\n## 2.1. å¦‚ä½•å»é¢„åŠ è½½ä¸€ä¸ªæŒ‡å®šèµ„æºï¼Ÿ\r\n\r\né¦–å…ˆè¦è§£å†³çš„æ˜¯ï¼Œé€šè¿‡ä»€ä¹ˆæ–¹å¼æ¥å®ç°èµ„æºçš„é¢„åŠ è½½ã€‚å³é¢„åŠ è½½çš„æ–¹å¼ã€‚\r\n\r\næˆ‘ä»¬è¿™é‡Œçš„é¢„åŠ è½½å¯¹åº”çš„è‹±æ–‡æ˜¯ prefetchã€‚æåˆ° prefetch è‡ªç„¶ä¼šæƒ³åˆ°ä½¿ç”¨æµè§ˆå™¨çš„ Resource Hintsï¼Œé€šè¿‡æç¤ºæµè§ˆå™¨åšä¸€äº›â€œé¢„æ“ä½œâ€ï¼ˆä¾‹å¦‚ DNS è§£æã€èµ„æºä¸‹è½½ç­‰ï¼‰æ¥åŠ å¿«åç»­çš„è®¿é—®ã€‚\r\n\r\n> å¦‚æœå¯¹ prefetch ä¸ Resource Hints ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥çœ‹çœ‹è¿™ç¯‡[ã€Šä½¿ç”¨Resource Hintæå‡é¡µé¢åŠ è½½æ€§èƒ½ä¸ä½“éªŒã€‹](https://juejin.im/post/5b4b66f0f265da0f9155feb6#heading-4)ã€‚\r\n\r\nåªéœ€è¦ä¸‹é¢è¿™æ ·ä¸€è¡Œä»£ç å°±å¯ä»¥å®ç°æµè§ˆå™¨çš„èµ„æºé¢„åŠ è½½ã€‚æ˜¯ä¸æ˜¯éå¸¸ç¾å¦™ï¼Ÿ\r\n\r\n```\r\n<link rel=\"prefetch\" href=\"/my.little.script.js\" as=\"script\">\r\n```\r\n\r\nå› æ­¤ï¼Œè¦é¢„åŠ è½½ä¸€ä¸ªèµ„æºå¯ä»¥é€šè¿‡ä¸‹é¢å››è¡Œä»£ç ï¼š\r\n\r\n```JavaScript\r\nconst link = document.createElement(`link`);\r\nlink.rel = `prefetch`;\r\nlink.href = url;\r\ndocument.head.appendChild(link);\r\n```\r\n\r\nç„¶è€Œï¼Œæˆ‘ä»¬ä¸å¾—ä¸é¢å¯¹å…¼å®¹æ€§çš„é—®é¢˜ï¼Œåœ¨ä½ç‰ˆæœ¬ IE ä¸ç§»åŠ¨ç«¯æ˜¯é‡ç¾åŒºã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/12/25/167e4b2371f81ea0?w=1270&h=484&f=png&s=320597)\r\n\r\nç¾æ¢¦ç ´ç­ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªç±»ä¼¼ prefetch shim çš„æ–¹å¼ï¼šåœ¨ä¸æ”¯æŒ Resource Hints çš„æµè§ˆå™¨ä¸­ï¼Œä½¿ç”¨å…¶ä»–æ–¹å¼æ¥é¢„åŠ è½½èµ„æºã€‚å¯¹æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æµè§ˆå™¨è‡ªèº«çš„ç¼“å­˜ç­–ç•¥ï¼Œâ€œå®å®åœ¨åœ¨â€é¢„å…ˆè¯·æ±‚è¿™ä¸ªèµ„æºï¼Œè¿™ä¹Ÿå½¢æˆäº†ä¸€ç§èµ„æºçš„â€œé¢„è·å–â€ã€‚è€Œè¿™æœ€æ–¹ä¾¿çš„å°±æ˜¯é€šè¿‡ XHRï¼š\r\n\r\n```JavaScript\r\nconst req = new XMLHttpRequest();\r\nreq.open(`GET`, url, req.withCredentials=true);\r\nreq.send();\r\n```\r\n\r\nè¿™æ · shim ä¹Ÿå®Œæˆäº†ã€‚æœ€åï¼Œå¦‚ä½•æ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒ prefetch å‘¢ï¼Ÿ\r\n\r\næˆ‘ä»¬å¯ä»¥é€šè¿‡ `link` å…ƒç´ ä¸Š relList å±æ€§çš„ `support` æ–¹æ³•æ¥æ£€æŸ¥å¯¹ prefetch çš„æ”¯æŒæƒ…å†µï¼š\r\n\r\n```JavaScript\r\nconst link = document.createElement('link');\r\nlink.relList || {}).supports && link.relList.supports('prefetch');\r\n```\r\n\r\nç»“åˆè¿™ä¸‰ä¸ªæ®µä»£ç ï¼Œå°±å½¢æˆäº†ä¸€ä¸ªç®€æ˜“çš„ prefetcherï¼š**åˆ¤æ–­æ˜¯å¦æ”¯æŒ Resource Hints ä¸­çš„ prefetchï¼Œæ”¯æŒåˆ™ä½¿ç”¨å®ƒï¼Œå¦åˆ™å›é€€ä½¿ç”¨ XHR åŠ è½½**ã€‚\r\n\r\nå€¼å¾—ä¸€æçš„æ˜¯ï¼Œä½¿ç”¨ Resource Hints ä¸ä½¿ç”¨ XHR æ¥é¢„åŠ è½½èµ„æºè¿˜æ˜¯æœ‰ä¸€äº›é‡è¦å·®å¼‚çš„ã€‚[è‰æ¡ˆä¸­](https://www.w3.org/TR/resource-hints/#x1-introduction)ä¹Ÿæåˆ°äº†ä¸€äº›ï¼ˆä¸»è¦æ˜¯ä¸æ€§èƒ½ä»¥åŠä¸æµè§ˆå™¨å…¶ä»–è¡Œä¸ºä¹‹é—´çš„å†²çªï¼‰ã€‚å…¶ä¸­è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯ï¼ŒResource Hints ä¸­çš„ prefetch æ˜¯å¦æ‰§è¡Œï¼Œå®Œå…¨æ˜¯ç”±æµè§ˆå™¨å†³å®šçš„ï¼Œè‰æ¡ˆé‡Œæœ‰å¥è¯éå¸¸æ˜æ˜¾ â€”â€” the user agent *SHOULD* fetchã€‚å› æ­¤ï¼Œæ‰€æœ‰ prefetch çš„èµ„æºå¹¶ä¸ä¸€å®šä¼šçœŸæ­£è¢« prefetchã€‚ç›¸è¾ƒä¹‹ä¸‹ï¼ŒXHR çš„æ–¹å¼â€œæˆåŠŸç‡â€åˆ™æ›´é«˜ã€‚è¿™ç‚¹åœ¨ [Netflix å®æ–½çš„æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹](https://medium.com/dev-channel/a-netflix-web-performance-case-study-c0bcde26a9d9#1b0c)ä¸­ä¹Ÿæåˆ°äº†ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/12/25/167e4b291f960c09?w=1600&h=967&f=png&s=393698)\r\n\r\n> é¢˜å¤–è¯ï¼šquicklink ä¸­ä½¿ç”¨ fetch API  å®ç°é«˜ä¼˜å…ˆçº§èµ„æºçš„åŠ è½½ã€‚è¿™æ˜¯å› ä¸ºæµè§ˆå™¨ä¸­ä¼šä¸ºæ‰€æœ‰çš„è¯·æ±‚éƒ½è®¾ç½®ä¸€ä¸ªä¼˜å…ˆçº§ï¼Œé«˜ä¼˜è¯·æ±‚ä¼šè¢«ä¼˜å…ˆæ‰§è¡Œï¼›ç›®å‰ï¼Œ`fetch` åœ¨ Chrome ä¸­å±äºé«˜ä¼˜å…ˆçº§ï¼Œåœ¨ Safari ä¸­å±äºä¸­ç­‰ä¼˜å…ˆçº§ã€‚\r\n\r\n\r\n## 2.2. å¦‚ä½•ç¡®å®šæŸä¸ªèµ„æºæ˜¯å¦è¦é¢„åŠ è½½ï¼Ÿ\r\n\r\næœ‰äº†èµ„æºé¢„åŠ è½½çš„æ–¹å¼ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±éœ€è¦ä¸€ä¸ªé¢„åŠ è½½çš„ç­–ç•¥äº†ã€‚\r\n\r\nè¿™å…¶å®æ˜¯ä¸ªè§ä»è§æ™ºçš„é—®é¢˜ã€‚ä¾‹å¦‚ç›´æ¥ç»™ä½ ä¸€ä¸ªé“¾æ¥ `https://my.test.com/somelink`ï¼Œåœ¨æ²¡æœ‰ä»»ä½•èƒŒæ™¯ä¿¡æ¯çš„æƒ…å†µä¸‹ï¼Œææ€•ä½ å®Œå…¨ä¸çŸ¥é“æ˜¯å¦éœ€è¦é¢„åŠ è½½å®ƒã€‚é‚£å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œquicklink æ˜¯æ€ä¹ˆè§£å†³çš„å‘¢ï¼Ÿæˆ–è€…è¯´ï¼Œquicklink æ˜¯é€šè¿‡ä»€ä¹ˆç­–ç•¥æ¥è¿›è¡Œé¢„åŠ è½½çš„å‘¢ï¼Ÿ\r\n\r\nquicklink ç”¨äº†ä¸€ä¸ªæ¯”è¾ƒç›´è§‚çš„ç­–ç•¥ï¼šåªå¯¹å¤„äºè§†å£å†…çš„èµ„æºè¿›è¡Œé¢„åŠ è½½ã€‚è¿™ä¸€ç‚¹ä¹Ÿæ¯”è¾ƒå¥½ç†è§£ï¼Œç½‘ç»œä¸Šå¤§å¤šçš„èµ„æºåŠ è½½ã€é¡µé¢è·³è½¬éƒ½ä¼´éšç€ç”¨æˆ·ç‚¹å‡»è¿™ç±»è¡Œä¸ºï¼Œè€Œå®ƒè¦æ˜¯ä¸åœ¨ä½ çš„è§†é‡å†…ï¼Œä½ ä¹Ÿå°±æ— ä»ç‚¹å‡»äº†ã€‚è¿™ä¸€å®šç¨‹åº¦ä¸Šç®—æ˜¯ä¸ªå¿…è¦æ¡ä»¶ã€‚\r\n\r\nè¿™ä¹ˆä¸€æ¥ï¼Œæˆ‘ä»¬æ‰€è¦è§£å†³çš„é—®é¢˜å°±æ˜¯ï¼Œå¦‚æœåˆ¤æ–­ä¸€ä¸ªé“¾æ¥æ˜¯å¦å¤„äºå¯è§†åŒºåŸŸå†…ï¼Ÿ\r\n\r\nä»¥å‰ï¼Œå¯¹äºè¿™ç§é—®é¢˜ï¼Œæˆ‘ä»¬åšçš„å°±æ˜¯ç›‘å¬ `scroll` äº‹ä»¶ï¼Œç„¶ååˆ¤æ–­æŸå…ƒç´ çš„ä½ç½®ï¼Œä»è€Œæ¥â€œå¾—çŸ¥â€å…ƒç´ æ˜¯å¦è¿›å…¥äº†è§†åŒºã€‚ä¼ ç»Ÿçš„å›¾ç‰‡æ‡’åŠ è½½åº“ [lazysize](https://github.com/aFarkas/lazysizes) ç­‰ä¹Ÿæ˜¯ç”¨è¿™ç§ç­–ç•¥ã€‚\r\n\r\n```JavaScript\r\ndocument.addEventListener('scroll', function () {\r\n    // â€¦â€¦åˆ¤æ–­å…ƒç´ ä½ç½®\r\n});\r\n```\r\n\r\n> æ³¨ï¼šç›®å‰ lazysize ä¹Ÿæœ‰äº†åŸºäº IntersectionObserver çš„å®ç°\r\n\r\nå½“ç„¶ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„æ»šåŠ¨ç›‘å¬çš„æ€§èƒ½ï¼Œä¾‹å¦‚ä½¿ç”¨æˆªæµã€é¿å…å¼ºåˆ¶åŒæ­¥å¸ƒå±€ã€ `passive: true` ç­‰æ–¹å¼ç¼“è§£æ€§èƒ½é—®é¢˜ã€‚\r\n\r\nä¸è¿‡ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªæ–°çš„æ–¹å¼æ¥å®ç°è¿™ä¸€åŠŸèƒ½ â€”â€” `IntersectionObserver`ï¼š\r\n\r\n```JavaScript\r\nconst observer = new IntersectionObserver(entries => {\r\n  entries.forEach(entry => {\r\n    if (entry.isIntersecting) {\r\n      const link = entry.target;\r\n      // é¢„åŠ è½½é“¾æ¥\r\n    }\r\n  });\r\n});\r\n\r\n// å¯¹æ‰€æœ‰ a æ ‡ç­¾æ·»åŠ è§‚å¯Ÿè€…\r\nArray.from(options.el.querySelectorAll('a'), link => {\r\n    observer.observe(link);\r\n});\r\n```\r\n\r\n`IntersectionObserver` ä¼šåˆ›å»ºä¸€ä¸ªè§‚å¯Ÿè€…ï¼Œä¸“é—¨ç”¨æ¥è§‚å¯Ÿä¸é€šçŸ¥å…ƒç´ è¿›å‡ºè§†å£çš„æƒ…å†µã€‚å¦‚ä¸Šè¿°ä»£ç æ‰€ç¤ºï¼Œ`IntersectionObserver` å¯ä»¥è§‚å¯Ÿæ‰€æœ‰ `a` å…ƒç´ çš„ä½ç½®æƒ…å†µï¼ˆä¸»è¦æ˜¯è¿›å…¥è§†é‡ï¼‰ã€‚\r\n\r\n> å¯¹ `IntersectionObserver` ä¸äº†è§£çš„åŒå­¦å¯ä»¥å‚è€ƒ [Google çš„ `IntersectionObserver` ä»‹ç»æ–‡ç« ](https://developers.google.com/web/updates/2016/04/intersectionobserver)ã€‚\r\n\r\nä½†æ˜¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ `IntersectionObserver` å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼Œå› æ­¤è¦åœ¨ä¸å…¼å®¹çš„æµè§ˆå™¨ä¸­ä½¿ç”¨ quicklinkï¼Œä¼šéœ€è¦ä¸€ä¸ª [polyfill](https://github.com/w3c/IntersectionObserver)ã€‚\r\n\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/12/25/167e54a6cc93bde4?w=2542&h=1068&f=png&s=680398)\r\n\r\nç›®å‰ï¼Œæˆ‘ä»¬å·²ç»æŠŠ quicklink çš„ä¸¤å¤§éƒ¨åˆ†ï¼ˆé¢„åŠ è½½çš„æ–¹å¼å’Œé¢„åŠ è½½çš„ç­–ç•¥ï¼‰çš„åŸç†å’Œç®€å•å®ç°è®²å®Œäº†ã€‚æ•´ä¸ª quicklink éå¸¸ç®€æ´ï¼Œè¿™äº›åŸºæœ¬å°±æ˜¯ quicklink çš„æ ¸å¿ƒã€‚å‰©ä¸‹çš„å°±æ˜¯ä¸€äº›å‚æ•°æ£€æŸ¥ã€é¢å¤–çš„è§„åˆ™ç‰¹æ€§ç­‰ã€‚\r\n\r\n> é¢˜å¤–è¯ï¼šä¸ºäº†è¿›ä¸€æ­¥ä¿è¯æ€§èƒ½ï¼Œquicklink ä½¿ç”¨ `requestIdleCallback` åœ¨ç©ºé—²æ—¶é—´æŸ¥è¯¢é¡µé¢ `a` æ ‡ç­¾å¹¶æŒ‚è½½è§‚å¯Ÿè€…ã€‚å¯¹ `requestIdleCallback` ä¸äº†è§£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ [Google çš„è¿™ç¯‡æ–‡ç« ](https://developers.google.com/web/updates/2015/08/using-requestidlecallback)ã€‚\r\n\r\n\r\n## 3. åˆ°æ­¤ä¸ºæ­¢ï¼Ÿä¸ï¼Œæˆ‘ä»¬è¿˜èƒ½åšæ›´å¤š\r\n\r\nåˆ°è¿™é‡Œï¼Œquicklink çš„å®ç°å°±åŸºæœ¬è®²å®Œäº†ã€‚ä»”ç»†å›æƒ³ä¸€ä¸‹ï¼Œquicklink å…¶å®æä¾›äº†æˆ‘ä»¬ä¸€ç§é€šè¿‡â€œé¢„åŠ è½½â€æ¥å®ç°æ€§èƒ½ä¼˜åŒ–çš„æ€è·¯ï¼ˆç²—ç•¥æ¥è¯´åƒæ˜¯ç”¨æµé‡æ¢ä½“éªŒï¼‰ã€‚è¿™ç§æ–¹å¼æˆ‘åœ¨å‰é¢ä¹Ÿæåˆ°äº†ï¼Œå…¶å®å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š\r\n\r\n- å¦‚ä½•å»é¢„åŠ è½½ä¸€ä¸ªæŒ‡å®šèµ„æºï¼Ÿï¼ˆé¢„åŠ è½½çš„æ–¹å¼ï¼‰\r\n- å¦‚ä½•ç¡®å®šæŸä¸ªèµ„æºæ˜¯å¦è¦åŠ è½½ï¼Ÿï¼ˆé¢„åŠ è½½çš„ç­–ç•¥ï¼‰\r\n\r\nå…¶å®ä¸¤éƒ¨åˆ†ä¼¼ä¹éƒ½æœ‰å¯ä»¥ä½œä¸ºçš„åœ°æ–¹ã€‚ä¾‹å¦‚å¦‚ä½•ä¿è¯ prefetcherï¼ˆèµ„æºé¢„åŠ è½½å™¨ï¼‰çš„æˆåŠŸç‡èƒ½æ›´é«˜ï¼Œä»¥åŠç›®å‰ä½¿ç”¨çš„å›é€€æ–¹æ¡ˆ XHR å…¶å®åœ¨é¢„åŠ è½½æ— æ³•ç¼“å­˜çš„èµ„æºæ—¶æ‰€å—çš„é™åˆ¶ç­‰ã€‚\r\n\r\næ­¤å¤–ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè¿˜å¯ä»¥æ¥èŠä¸€èŠç­–ç•¥è¿™å—ã€‚\r\n\r\nç”±äº quicklink æ˜¯ä¸€ä¸ªä¸šåŠ¡æ— å…³çš„è½»é‡çº§åŠŸèƒ½åº“ï¼Œæ‰€ä»¥å®ƒé‡‡ç”¨äº†ä¸€ä¸ªç®€å•ä½†ä¸€å®šç¨‹åº¦ä¸Šæœ‰æ•ˆçš„ç­–ç•¥ï¼šé¢„åŠ è½½è§†é‡å†…çš„é“¾æ¥èµ„æºã€‚ç„¶è€Œåœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬é¢å¯¹çš„æ˜¯æ›´å¤æ‚çš„ç¯å¢ƒï¼Œæ›´å¤æ‚çš„ä¸šåŠ¡ï¼Œåè€Œä¼šéœ€è¦æ›´ç²¾å‡†çš„é¢„åŠ è½½åˆ¤æ–­ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ä» quicklink ä¸­å‰¥ç¦»å‡º prefetcher æ¥ä½œä¸ºä¸€ä¸ªé¢„åŠ è½½å™¨ï¼›è€Œåœ¨ç­–ç•¥éƒ¨åˆ†ä½¿ç”¨è‡ªå·±çš„å®ç°ï¼Œä¾‹å¦‚ï¼š\r\n\r\n- ç»“åˆè®¿é—®æ—¥å¿—ã€æ‰“ç‚¹è®°å½•çš„æ›´ç²¾å‡†çš„é¢„åŠ è½½ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¿é—®æ—¥å¿—ã€æ‰“ç‚¹è®°å½•ï¼Œæ ¹æ® refer æ¥åˆ¤æ–­ï¼Œä» A é¡µé¢æ¥çš„ Bã€Cã€D é¡µé¢çš„æ¯”ä¾‹ï¼Œä»è€Œè®¾ç½®ä¸€ä¸ªé˜ˆå€¼ï¼Œè¶…è¿‡è¯¥é˜ˆå€¼åˆ™è®¤ä¸ºè®¿é—® A é¡µé¢çš„ç”¨æˆ·æ¥ä¸‹æ¥æ›´å®¹æ˜“è®¿é—®å®ƒï¼Œä»è€Œå¯¹å…¶é¢„åŠ è½½ã€‚\r\n\r\n- ç»“åˆç”¨æˆ·è¡Œä¸ºæ•°æ®æ¥è¿›è¡Œä¸ªæ€§åŒ–çš„é¢„åŠ è½½ã€‚ä¾‹å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªé˜…è¯»ç±»æˆ–å•†å“å±•ç¤ºç±»ç«™ç‚¹ï¼Œä»ç”¨æˆ·è¡Œä¸ºå‘ç°ï¼Œå½“è¯¥é“¾æ¥æš´éœ²åœ¨è¯¥ç”¨æˆ·è§†é‡å†… XX ç§’ï¼ˆç”¨æˆ·é˜…è¯»å†…å®¹ XX ç§’ï¼‰åç‚¹å‡»ç‡è¾¾åˆ° XX%ã€‚è€Œä¸æ˜¯ç®€å•çš„ä¸€åˆ€åˆ‡æˆ–è¿›å…¥è§†é‡å°±é¢„åŠ è½½ã€‚\r\n\r\n- åç½®éå¿…è¦èµ„æºï¼Œç²¾ç®€æŸç±»è½åœ°é¡µã€‚è½åœ°é¡µå°±æ˜¯è¦è®©æ–°ç”¨æˆ·å°½å¿«â€œè½åœ°â€ï¼Œä¸ºæ­¤æˆ‘ä»¬å¯ä»¥åƒ [Netflix](https://medium.com/dev-channel/a-netflix-web-performance-case-study-c0bcde26a9d9#1b0c) ä»‹ç»çš„é‚£æ ·ï¼Œåœ¨å®£è´¯é¡µ/ç™»å½•é¡µç²¾ç®€åŠ è½½å†…å®¹ï¼Œè€Œé¢„åŠ è½½åç»­ä¸»ç«™çš„ä¸»åŒ…ï¼ˆä¸»èµ„æºï¼‰ã€‚ä¾‹å¦‚æœ‰äº›ç«™ç‚¹çš„é¦–é¡µå¤§å¤šåé™æ€ï¼Œå¯ä»¥ç”¨åŸç”Ÿ JavaScript åŠ  å†…è”å…³é”® CSS çš„æ–¹å¼ï¼ŒåŠ å¿«åŠ è½½ï¼Œç”¨æˆ·è®¿é—®åå†é¢„åŠ è½½ Reactã€Vue ç­‰ä¸€ç³»åˆ—ä¸»ç«™èµ„æºã€‚\r\n\r\n- ç­‰ç­‰ã€‚\r\n\r\nä¸Šé¢è¿™äº›åœºæ™¯åªæ˜¯æŠ›ç –å¼•ç‰ï¼Œç›¸ä¿¡å¤§å®¶è¿˜ä¼šæœ‰æ›´å¤šæ›´å¥½çš„åœºæ™¯å¯ä»¥æ¥åŠ©åŠ›æˆ‘ä»¬çš„å‰ç«¯åº”ç”¨â€œèµ·é£â€ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥å€ŸåŠ©ä¸€äº›æ„å»ºå·¥å…·ã€æ•°æ®é‡‡é›†ä¸åˆ†æå¹³å°æ¥å®ç°ç­–ç•¥çš„è‡ªåŠ¨æå–ä¸æ³¨å…¥ï¼Œä¼˜åŒ–æ•´ä¸ªé¢„åŠ è½½çš„æµç¨‹ã€‚\r\n\r\n## å†™åœ¨æœ€å\r\n\r\né¢„åŠ è½½ã€Resource Hintsç­‰ç”±æ¥å·²ä¹…ã€‚quicklink é€šè¿‡æå‡ºäº†ä¸€ç§å¯è¡Œçš„æ–¹æ¡ˆè®©å®ƒåˆè¿›å…¥äº†å¤§å®¶çš„è§†é‡ï¼Œç»™æˆ‘ä»¬å±•ç°äº†æ€§èƒ½ä¼˜åŒ–çš„å¦ä¸€é¢ã€‚å¸Œæœ›å¤§å®¶é€šè¿‡äº†è§£ quicklink çš„å®ç°ï¼Œä¹Ÿèƒ½æœ‰è‡ªå·±çš„æƒ³æ³•ä¸å¯å‘ã€‚\r\n\r\nç›¸ä¿¡éšç€æµè§ˆå™¨çš„ä¸æ–­è¿›åŒ–ï¼Œæ ‡å‡†çš„ä¸æ–­å‰è¡Œï¼Œå‰ç«¯å·¥ç¨‹å¸ˆå¯¹æè‡´ä½“éªŒä¸æ€§èƒ½è¦æ±‚çš„ä¸æ–­æé«˜ï¼Œæˆ‘ä»¬çš„äº§å“å°†ä¼šè¶Šæ¥è¶Šå¥½ã€‚\r\n\r\n---\r\n\r\nå¥½äº†ï¼Œè¿™æœŸçš„ã€Œæ¼«æ¸¸ Githubã€å°±åˆ°è¿™é‡Œäº†ã€‚æœ¬ç³»åˆ—ä¼šä¸å®šæœŸå’Œå¤§å®¶ä¸€èµ·çœ‹ä¸€çœ‹ã€èŠä¸€èŠã€å­¦ä¸€å­¦ github ä¸Šæœ‰è¶£çš„é¡¹ç›®ï¼Œä¸ä»…å­¦ä¹ ä¸€äº›æŠ€æœ¯ç‚¹ï¼Œè¿˜å¯ä»¥äº†è§£ä½œè€…çš„æŠ€æœ¯æ€è€ƒï¼Œæ¬¢è¿æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å…³æ³¨ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/9822789/71757685-7807ac00-2ed2-11ea-97e7-c93eec7b6017.png)\r\n\r\n---","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/24","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/24/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/24/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/24/events","html_url":"https://github.com/alienzhou/blog/issues/24","id":390668810,"node_id":"MDU6SXNzdWUzOTA2Njg4MTA=","number":24,"title":"ã€æ€§èƒ½ä¼˜åŒ–å®è·µã€‘ä¼˜åŒ–æ‰“åŒ…ç­–ç•¥æå‡é¡µé¢åŠ è½½é€Ÿåº¦","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845015,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E6%B5%8F%E8%A7%88%E5%99%A8","name":"æµè§ˆå™¨","color":"cfd3d7","default":false,"description":""},{"id":1159845016,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%BB%BC%E5%90%88","name":"ç»¼åˆ","color":"a2eeef","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T13:01:20Z","updated_at":"2018-12-13T13:01:20Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## TL;DR\r\n- å¯ä»¥è€ƒè™‘åŸºäºHTTP Cacheæ¥å®šä¹‰æ‰“åŒ…ç»´åº¦ï¼Œå°†Cacheå‘¨æœŸç›¸åŒçš„scriptå°½é‡æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œæœ€å¤§é™åº¦åˆ©ç”¨Cacheï¼›\r\n- åˆå¹¶é›¶æ•£çš„å°è„šæœ¬ï¼Œé¿å…è§¦å‘æµè§ˆå™¨å¹¶å‘è¯·æ±‚é™åˆ¶åï¼Œèµ„æºè¯·æ±‚ä¸²è¡Œï¼ŒTTFBå åŠ ç­‰å¾…æ—¶é—´ï¼›\r\n- æ³¨æ„æ‰“åŒ…åçš„èµ„æºä¾èµ–ä¸èµ„æºå¼•å…¥é¡ºåºã€‚\r\n\r\n## 1. å¼•è¨€\r\næ€§èƒ½ä¼˜åŒ–æ¶µç›–çš„èŒƒå›´éå¸¸ä¹‹å¹¿ï¼Œå…¶ä¸­åŒ…å«çš„çŸ¥è¯†ä¹Ÿéå¸¸ç¹æ‚ã€‚ä»åŠ è½½æ€§èƒ½åˆ°æ¸²æŸ“æ€§èƒ½ã€è¿è¡Œæ—¶æ€§èƒ½ï¼Œæ¯ä¸ªç‚¹éƒ½æœ‰éå¸¸å¤šå¯ä»¥å­¦ä¹ ä¸å®è·µçš„çŸ¥è¯†ã€‚\r\n\r\nä¼˜åŒ–é—®é¢˜åŒ…å«æ–¹æ–¹é¢é¢ï¼Œä¼˜åŒ–æ‰‹æ®µä¹Ÿä¾åœºæ™¯å’Œå…·ä½“é—®é¢˜è€Œå®šã€‚å› æ­¤ï¼Œæœ¬æ–‡å¹¶ä¸æ˜¯ä¸€ä¸ªæ³›è€Œå…¨çš„æ¦‚è§ˆæ–‡ç« ï¼Œè€Œæ˜¯ä»¥ä¹‹å‰çš„ä¸€æ¬¡å¯¹äºä¸šåŠ¡äº§å“çš„ç®€å•ä¼˜åŒ–ï¼ˆä¸»è¦æ˜¯DOMContentLoadedæ—¶é—´ï¼‰ä¸ºä¾‹ï¼Œä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Chrome Dev Toolsæ¥åˆ†æé—®é¢˜ï¼Œä½¿ç”¨ä¸€äº›ç­–ç•¥æ¥ç¼©çŸ­DOMContentLoadedçš„æ—¶é—´ï¼Œæé«˜åŠ è½½é€Ÿåº¦ã€‚\r\n\r\n## 2. DOMContentLoadedäº‹ä»¶\r\nW3Cå°†é¡µé¢åŠ è½½åˆ†ä¸ºäº†è®¸å¤šé˜¶æ®µï¼Œ DOMContentLoadedï¼ˆä»¥ä¸‹ç®€ç§°DCLï¼‰ç±»ä¼¼çš„æœ‰ä¸€äº› DOM readState ï¼Œå®ƒä»¬éƒ½ä¼šæ ‡è¯†é¡µé¢çš„åŠ è½½çŠ¶æ€ä¸æ‰€å¤„çš„é˜¶æ®µã€‚æˆ‘ä»¬æ¥è§¦æœ€å¤šçš„ä¹Ÿå°±æ˜¯ readState ä¸­çš„ interactiveã€completeï¼ˆæˆ–loadäº‹ä»¶ï¼‰ä»¥åŠDCLäº‹ä»¶\r\n\r\nç®€å•äº†è§£ä¸€ä¸‹å®ƒä»¬ã€‚æµè§ˆå™¨ä¼šåŸºäºHTMLå†…å®¹æ¥æ„å»ºDOMï¼Œå¹¶åŸºäºCSSæ„å»ºCSSOMã€‚ä¸¤è€…æ„å»ºå®Œæˆåï¼Œä¼šåˆå¹¶ä¸ºRender Treeã€‚å½“DOMæ„å»ºå®Œæ¯•åï¼Œ `document.readyState` çŠ¶æ€ä¼šå˜ä¸º `interactive` ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/5/1632dfee442ac44d?w=626&h=155&f=png&s=17201)\r\n\r\nRender Treeæ„å»ºå®Œæˆå°±ä¼šè¿›å…¥åˆ°æˆ‘ä»¬éå¸¸ç†Ÿæ‚‰çš„ Layout â€“>> Paint â€“>> Composite ç®¡é“ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/5/1632dff994a5f163?w=1093&h=167&f=png&s=95395)\r\n\r\nä½†æ˜¯å½“é¡µé¢åŒ…å«Javascriptæ—¶ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šæœ‰äº›åŒºåˆ«ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/5/1632dfffc7d10f7c?w=626&h=155&f=png&s=20221)\r\n\r\næ ¹æ®[HTML5 spec](https://www.w3.org/TR/html5/syntax.html#the-end)ï¼Œç”±äºåœ¨Javascriptä¸­å¯ä»¥è®¿é—®DOMï¼Œå› æ­¤å½“æµè§ˆå™¨è§£æé¡µé¢é‡åˆ°Javascriptåä¼šé˜»å¡ DOM çš„è§£æï¼›äºæ­¤åŒæ—¶ï¼Œä¸ºé¿å…CSSä¸Javascriptä¹‹é—´çš„ç«æ€ï¼ŒCSSOMçš„æ„å»ºä¼šé˜»å¡ Javascript è„šæœ¬çš„æ‰§è¡Œã€‚ä¸è¿‡æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œå¦‚æœå°†è„šæœ¬è®¾ç½®ä¸ºasyncï¼Œä¼šæœ‰ä¸€ä¸ªåŒºåˆ«ï¼ŒDCLçš„è§¦å‘ä¸éœ€è¦ç­‰å¾…asyncçš„è„šæœ¬è¢«æ‰§è¡Œã€‚\r\n\r\nä¹Ÿå°±æ˜¯ï¼š\r\n\r\n- å½“æµè§ˆå™¨å®Œæˆå¯¹äºdocumentçš„è§£æï¼ˆparseï¼‰æ—¶ï¼Œæ–‡æ¡£çŠ¶æ€å°±ä¼šè¢«æ ‡è®°ä¸º `interactive` ã€‚å³ \"DOM tree is ready\"ã€‚\r\n- å½“æ‰€æœ‰æ™®é€šï¼ˆæ—¢ä¸æ˜¯deferä¹Ÿä¸æ˜¯asyncï¼‰ä¸deferçš„è„šæœ¬è¢«æ‰§è¡Œï¼Œå¹¶ä¸”å·²ç»æ²¡æœ‰ä»»ä½•é˜»å¡è„šæœ¬çš„æ ·å¼æ—¶ï¼Œæµè§ˆå™¨å°±ä¼šè§¦å‘ `DOMContentLoaded` äº‹ä»¶ã€‚å³ \"CSSOM is ready\"ã€‚\r\n\r\næˆ–è€…å°†ä¸Šé¢çš„éƒ¨åˆ†ç²¾ç®€ä¸€ä¸‹ï¼š\r\n\r\n> DOM construction canâ€™t proceed until JavaScript is executed, and JavaScript canâ€™t proceed until CSSOM is available. [[1]](https://calendar.perfplanet.com/2012/deciphering-the-critical-rendering-path/)\r\n\r\n## 3. æ’æŸ¥é—®é¢˜\r\nä¸‹é¢å°±å¯ä»¥é€šè¿‡Chrome Dev Toolsæ¥åˆ†æé—®é¢˜ã€‚ä¸ºäº†å†…å®¹ç²¾ç®€ï¼Œä»¥ä¸‹æˆªå›¾å–äº†åœ¨slow 3G æ— ç¼“å­˜æ¨¡å¼ä¸‹çš„è®¿é—®æƒ…å†µï¼Œä¸ºäº†ä¿æŒå’Œçº¿ä¸Šç¯å¢ƒç±»ä¼¼ï¼ˆè¿˜åŸæµè§ˆå™¨çš„åŒæºæœ€å¤§è¯·æ±‚å¹¶å‘ï¼‰ï¼Œåœ¨æœ¬åœ°æ­å»ºå¯¹åº”çš„æœåŠ¡å™¨æ”¾ç½®é™æ€èµ„æºã€‚wifiæƒ…å†µä¸‹ï¼Œå„ä¸ªæ—¶é—´ç‚¹å¤§è‡´ç­‰æ¯”ç¼©çŸ­8~9å€ã€‚\r\n\r\né¦–å…ˆçœ‹ä¸€ä¸ªæ•´ä½“çš„waterfall\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/5/1632e14e43c51ffb?w=958&h=797&f=png&s=260832)\r\n\r\nåœ¨æœ€ä¸‹é¢å¯ä»¥çœ‹åˆ° DCL ä¸º 17.00sï¼ˆslow 3Gï¼‰ã€‚\r\n\r\n> p.s. é¡µé¢loadæ—¶é—´ä¹Ÿå¾ˆé•¿ã€‚ä¸»è¦å› ä¸ºä¸šåŠ¡è†¨èƒ€åï¼Œé¡µé¢åŒ…å«è¿‡å¤šèµ„æºï¼Œæ²¡æœ‰ä½¿ç”¨ä¸€äº›æ‡’åŠ è½½ä¸å¼‚æ­¥æ¸²æŸ“æŠ€æœ¯ï¼Œè¿™éƒ¨åˆ†ä¹Ÿå­˜åœ¨å¾ˆå¤šä¼˜åŒ–ç©ºé—´ï¼Œä½†ç”±äºç¯‡å¹…ä¸åœ¨æœ¬æ–‡ä¸­è®¨è®ºå†…ã€‚\r\n\r\né¡µé¢é‡Œæœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„è¯·æ±‚blockäº†DCL â€”â€” common.jsã€‚é‚£ä¹ˆcommon.jsæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒå…¶å®å°±æ˜¯é¡¹ç›®ä¸­ä¸€äº›é€šç”¨è„šæœ¬æ–‡ä»¶çš„æ‰“åŒ…åˆå¹¶ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/5/1632e19f6b41592b?w=959&h=772&f=png&s=165591)\r\n\r\nç”±äºcommon.jsä¸ºåŒæ­¥è„šæœ¬ï¼Œå› æ­¤ç­‰åˆ°å®ƒå…¶ä¸‹è½½å¹¶æ‰§è¡Œå®Œæ¯•åï¼Œæ‰ä¼šè§¦å‘DCLã€‚è€Œä¸æ­¤å¯¹åº”çš„ï¼Œå…¶ä»–å„ä¸ªè„šæœ¬çš„æ—¶é—´çº¿ä¸å…¶æœ‰å¾ˆå¤§å·®è·ã€‚å…·ä½“æ¥çœ‹common.jsçš„Timing pharseï¼Œè€—æ—¶11.44sï¼Œå…¶ä¸­downloadèŠ±è´¹ 7.12sã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/5/1632e19f6b55068a?w=390&h=276&f=png&s=28765)\r\n\r\n## 4. åˆ†æè¯Šæ–­\r\n\r\ndownloadè¿‡é•¿æœ€ç›´æ¥çš„åŸå› å°±æ˜¯æ–‡ä»¶å¤ªå¤§ã€‚common.jsçš„æ‰“åŒ…åˆå¹¶åŒ…å«äº†ä¸‹é¢çš„å†…å®¹\r\n\r\n```javascript\r\n'pkg/common.js': [\r\n    'static/js/bridge.js', // ä¸šåŠ¡åŸºç¡€åº“\r\n    'static/js/zepto.min.js', // ç¬¬ä¸‰æ–¹åº“\r\n    'static/js/zepto.touch.min.js', // ç¬¬ä¸‰æ–¹åº“\r\n    'static/js/bluebird.core.min.js', // ç¬¬ä¸‰æ–¹åº“\r\n    'static/js/link.interceptor.js', // ä¸šåŠ¡åŸºç¡€åº“\r\n    'static/js/global.js', // ä¸šåŠ¡åŸºç¡€åº“\r\n    'static/js/felog.js', // ä¸šåŠ¡åŸºç¡€åº“\r\n    'widget/utils/*.js' // ä¸šåŠ¡å·¥å…·ç»„ä»¶\r\n]\r\n```\r\n\r\nè¿™é‡Œï¼Œæˆ‘ä»¬å‘ç°è¿™ä¹ˆæ‰“åŒ…ä¼šå­˜åœ¨ä¸‹é¢å‡ ä¸ªé—®é¢˜ï¼š\r\n\r\n### 4.1. æ–‡ä»¶å¤§å°\r\n\r\ndownloadè¿‡é•¿æœ€ç›´æ¥çš„åŸå› ï¼šæ–‡ä»¶è¿‡å¤§ã€‚\r\n\r\nå°†è¿™äº›èµ„æºå…¨éƒ¨æ‰“åŒ…åœ¨ä¸€èµ·å¯¼è‡´common.jsè¾ƒå¤§ï¼ŒåŸæ–‡ä»¶161KBï¼Œgzip ä¹‹åä¸º52.5KBï¼Œå•ç‚¹é˜»å¡äº†å…³é”®æ¸²æŸ“è·¯å¾„ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨ audits ä¸­çš„Critical Request Chainséƒ¨åˆ†å‘ç°common.jsæ˜¯ç“¶é¢ˆã€‚\r\n\r\n### 4.2. HTTP Cache\r\n\r\nzepto/bluebirdè¿™ç§ç¬¬ä¸‰æ–¹åº“å±äºéå¸¸ç¨³å®šçš„èµ„æºï¼Œå‡ ä¹ä¸ä¼šæ”¹åŠ¨ã€‚è™½ç„¶ä»£ç é‡è¾ƒå¤šï¼Œä½†æ˜¯é€šè¿‡HTTP Cacheå¯ä»¥æœ‰æ•ˆé¿å…é‡å¤ä¸‹è½½ã€‚åŒæ—¶ï¼Œä¸Šçº¿æ–°ç‰ˆåï¼Œä¸ºäº†é¿å…ä¸€äº›æ–‡ä»¶èµ° HTTP Cacheï¼Œæˆ‘ä»¬ä¼šç»™é™æ€èµ„æºåŠ ä¸Š md5ã€‚\r\n\r\nç„¶è€Œï¼Œå½“è¿™äº›ç¨³å®šçš„ç¬¬ä¸‰æ–¹åº“ä¸ä¸€äº›å…¶ä»–æ–‡ä»¶æ‰“åŒ…åï¼Œä¼šå› ä¸ºè¯¥æ‰“åŒ…ä¸­æŸäº›æ–‡ä»¶çš„å±€éƒ¨å˜åŠ¨å¯¼è‡´åˆå¹¶æ‰“åŒ…åçš„hashå˜åŒ–è€Œç¼“å­˜å¤±æ•ˆã€‚\r\n\r\nä¾‹å¦‚ï¼Œå…¶ä¸­bridge.jsä¸/utils/*.jså®¹æ˜“éšç€ç‰ˆæœ¬ä¸Šçº¿è¿­ä»£ï¼Œè¿­ä»£åæ‰“åŒ…å¯¼è‡´commonçš„hashå˜åŒ–ï¼ŒHTTP Cacheå¤±æ•ˆï¼Œzepto/bluebirdç­‰è¾ƒå¤§çš„èµ„æºè™½ç„¶æœªæ›´æ”¹ï¼Œä½†ç”±äºæ‰“åŒ…åœ¨äº†ä¸€èµ·ï¼Œä»éœ€è¦é‡æ–°ä¸‹è½½ã€‚æ¯æ¬¡ä¸Šçº¿æ–°ç‰ˆæœ¬åï¼Œä¸€äº›åŠ è½½çš„æ€§èƒ½æ•°æ®è¡¨ç°éƒ½ä¼šæ˜¾è‘—ä¸‹é™ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†åŸå› åœ¨äºæ­¤ã€‚\r\n\r\n## 5. å®æ–½ä¼˜åŒ–æ‰‹æ®µ\r\n\r\nç»“åˆä¸Šé¢åˆ†æçš„é—®é¢˜ï¼Œå¯ä»¥è¿›è¡Œä¸€äº›ç®€å•è€Œæœ‰æ•ˆçš„ä¼˜åŒ–ã€‚\r\n\r\n### 5.1. æ‹†åŒ…\r\n\r\nè€ƒè™‘å°†æ–‡ä»¶çš„æ‰“åŒ…åˆå¹¶æŒ‰ç…§æ–‡ä»¶çš„æ›´æ–°é¢‘ç‡è¿›è¡Œåˆ’åˆ†ã€‚è¿™æ ·æ—¢å¯ä»¥æœ‰æ•ˆç¼©å‡common.jsçš„å¤§å°ï¼Œä¹Ÿå¯ä»¥åŸºäºä¸åŒç±»å‹çš„èµ„æºï¼Œæ›´å¥½åˆ©ç”¨HTTP Cacheã€‚\r\n\r\nä¾‹å¦‚ï¼š\r\n\r\n- å°†åŸºæœ¬ä¸ä¼šå˜åŠ¨çš„æ–‡ä»¶æ‰“åŒ…ä¸º lib.jsï¼Œä¸»è¦ä¸ºä¸€äº›ç¬¬ä¸‰æ–¹åº“ï¼Œè¿™ç±»æ–‡ä»¶å‡ ä¹ä¸ä¼šæ”¹åŠ¨ï¼Œéå¸¸ç¨³å®šã€‚\r\n\r\n- å°†é¡¹ç›®ä¾èµ–çš„æœ€åŸºç¡€jsæ‰“åŒ…ä¸ºcommon.jsï¼Œä¾‹å¦‚æœ¬æ–‡ä¸­çš„global.jsã€link.interceptor.jsï¼Œé¡¹ç›®ä¸­çš„æ‰€æœ‰éƒ¨åˆ†éƒ½éœ€è¦å®ƒä»¬ï¼ŒåŒæ—¶ä¹Ÿæ˜¯é¡¹ç›®ç‰¹æœ‰çš„ï¼Œç›¸è¾ƒä¸Šä¸€éƒ¨åˆ†çš„libä¼šæœ‰ä¸€å®šé‡çš„å¼€å‘ä¸æ”¹åŠ¨ï¼Œä½†æ˜¯æ›´æ–°é—´éš”å¯èƒ½ä¼šæœ‰å‡ ä¸ªç‰ˆæœ¬ã€‚\r\n\r\n- å°†é¡¹ç›®ä¸­å˜åŠ¨è¾ƒä¸ºé¢‘ç¹çš„å·¥å…·åº“æ‰“åŒ…ä¸ºutil.jsï¼Œç†è®ºä¸Šå…¶ä¸­å·¥å…·ç”±äºä¸ä½œä¸ºåŸºç¡€è¿è¡Œçš„ä¾èµ–ï¼Œæ˜¯å¯ä»¥å¼‚æ­¥åŠ è½½çš„ã€‚è¿™éƒ¨åˆ†ä»£ç æ˜¯ä¸‰è€…ä¹‹ä¸­å˜åŠ¨æœ€ä¸ºé¢‘ç¹çš„ã€‚\r\n\r\n```\r\n'pkg/util.js': [\r\n    'widget/utils/*.js'\r\n],\r\n'pkg/common.js': [\r\n    'static/js/link.interceptor.js',\r\n    'static/js/global.js',\r\n    'static/js/felog.js'\r\n],\r\n'pkg/lib.js': [\r\n    'static/js/zepto.min.js',\r\n    'static/js/zepto.touch.min.js',\r\n    'static/js/bluebird.core.min.js'\r\n]\r\n```\r\n\r\n### 5.2 Quene Delay\r\n\r\nä½†æ˜¯åœ¨æ‹†åˆ†åDCLæ—¶é—´å‡ ä¹æ²¡æœ‰å‡å°‘ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/5/1632e8c6138105fa?w=792&h=799&f=jpeg&s=343283)\r\n\r\nè¿™é‡Œå°±ä¸å¾—ä¸æåˆ°æ‰“åŒ…çš„åˆè¡·ä¹‹ä¸€ï¼šå‡å°‘å¹¶å‘ã€‚æˆ‘ä»¬å°†common.jsæ‹†åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†åï¼Œè§¦ç¢°åˆ°äº†åŒåŸŸTCPè¿æ¥æ•°é™åˆ¶ï¼Œå›¾ä¸­çš„è¿™å››ä¸ªèµ„æºè¢«chromeæ”¾å…¥äº†é˜Ÿåˆ—ï¼ˆå›¾ä¸­ç™½è‰²é•¿æ¡ï¼‰ã€‚\r\n\r\n> Queueing. The browser queues requests when:\r\n> \r\n> - There are higher priority requests.\r\n> - There are already six TCP (Chrome) connections open for this origin, which is the limit. Applies to HTTP/1.0 and HTTP/1.1 only.\r\n> - The browser is briefly allocating space in the disk cache\r\n\r\næˆ‘ä»¬æ‰“åŒ…åˆå¹¶èµ„æºä¸€å®šç¨‹åº¦ä¸Šä¹Ÿæ˜¯ä¸ºäº†å‡å°‘TCP round tripï¼ŒåŒæ—¶å°½é‡è§„é¿åŒåŸŸä¸‹çš„è¯·æ±‚å¹¶å‘æ•°é‡é™åˆ¶ã€‚å› æ­¤åœ¨common.jsæ‹†åˆ†æ—¶ï¼Œä¹Ÿè¦æ³¨æ„ä¸å®œåˆ†å¾—è¿‡ç»†ï¼Œå¦åˆ™è¿‡çŠ¹ä¸åŠï¼Œå¿˜äº†åˆè¡·ã€‚\r\n\r\nä»network waterfallä¸­ä¹Ÿå¾ˆå®¹æ˜“å‘ç°ï¼Œå¤§éƒ¨åˆ†èµ„æºç”±äºsizeè¾ƒå°ï¼Œå…¶ä¸‹è½½æ—¶é—´å…¶å®éå¸¸çŸ­ï¼Œè€—æ—¶ä¸»è¦æ˜¯åœ¨TTFBï¼ˆTime To First Byteï¼‰ï¼Œå¯ä»¥ç²—ç•¥ç†è§£ä¸ºåœ¨ç­‰å¾…æœåŠ¡å™¨è¿”å›æ•°æ®ï¼ˆå›¾ä¸­è¡¨ç°å‡ºæ¥å°±æ˜¯ç»¿è‰²è¾ƒå¤šï¼‰ã€‚æ‰€ä»¥é™¤äº†æ‰“åŒ…é¡¹ç›®ä¾èµ–çš„lib.js/common.js/util.jså¤–ï¼Œè¿˜å¯ä»¥è€ƒè™‘å°†éƒ¨åˆ†ä¾èµ–çš„ç»„ä»¶è„šæœ¬è¿›è¡Œæ‰“åŒ…åˆå¹¶ï¼Œ\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/5/1632e66b1ad70b03?w=649&h=89&f=png&s=24700)\r\n\r\nåƒä¸Šå›¾ä¸­è¿™å››ä¸ªè„šæœ¬çš„è€—æ—¶éƒ½åœ¨åœ¨TTFBä¸Šï¼Œè€Œä¸”åœ¨åŒä¸€ä¸ªCDNä¸Šï¼Œå¯ä»¥é€šè¿‡æ‰“åŒ…å‡å°ä¸å¿…è¦çš„å¹¶å‘ã€‚å°†é¦–å±ä¾èµ–çš„å…³é”®ç»„ä»¶è¿›è¡Œæ‰“åŒ…ï¼š\r\n\r\n```javascript\r\n'pkg/util.js': [\r\n    'widget/utils/*.js'\r\n],\r\n'pkg/common.js': [\r\n    'static/js/bridge.js',\r\n    'static/js/link.interceptor.js',\r\n    'static/js/global.js',\r\n    'static/js/felog.js'\r\n],\r\n'pkg/lib.js': [\r\n    'static/js/zepto.min.js',\r\n    'static/js/zepto.touch.min.js',\r\n    'static/js/bluebird.core.min.js'\r\n],\r\n'pkg/homewgt.js': [\r\n    'widget/home/**.js',\r\n    'widget/player/*.js',\r\n]\r\n```\r\n\r\nä¼˜åŒ–åçš„DCLå˜ä¸ºäº†11.20sã€‚\r\n![](https://user-gold-cdn.xitu.io/2018/5/5/1632e66b1b179577?w=962&h=799&f=png&s=152035)\r\n\r\n### 5.3 èµ„æºå¼•å…¥é¡ºåº\r\næ³¨æ„ï¼Œä¸€äº›æ‰“åŒ…å·¥å…·ä¼šè‡ªåŠ¨åˆ†ææ–‡ä»¶ä¾èµ–å…³ç³»ï¼Œæ–‡ä»¶æ‰“åŒ…åä¼šåŒæ—¶æ›¿æ¢èµ„æºè·¯å¾„ã€‚ä¾‹å¦‚ï¼šåœ¨HTMLä¸­ï¼Œå¼•ç”¨äº† `static/js/zepto.min.js` å’Œ `static/js/bluebird.core.min.js` ä¸¤ä¸ªèµ„æºï¼Œåœ¨æ‰“åŒ…åæ„å»ºå·¥å…·ä¼šå°†HTMLä¸­çš„å¼•ç”¨è‡ªåŠ¨æ›¿æ¢ä¸º `lib.js` ã€‚å› æ­¤éœ€è¦æ³¨æ„æ‰“åŒ…åçš„èµ„æºåŠ è½½é¡ºåºã€‚\r\n\r\nä¾‹å¦‚ï¼ŒåŸHTMLä¸­çš„èµ„æºé¡ºåº\r\n\r\n```HTML\r\n<script type=\"text/javascript\" src=\"//your.cdn.com/static/js/bridge.js\"></script>\r\n<script type=\"text/javascript\" src=\"//your.cdn.com/static/js/zepto.min.js\"></script>\r\n<script type=\"text/javascript\" src=\"//your.cdn.com/static/js/bluebird.core.min.js\"></script>\r\n<script type=\"text/javascript\" src=\"//your.cdn.com/static/js/global.js\"></script>\r\n```\r\n\r\nå…¶ä¸­ `global.js` ä¾èµ–äº `zepto.min.js`ï¼Œè¿™ä¸ªåœ¨ç›®å‰çœ‹æ¥æ²¡æœ‰é—®é¢˜ã€‚ä½†æ˜¯ç”±äºæ‰“åŒ…åˆå¹¶ï¼Œæ„å»ºå·¥å…·ä¼šè‡ªåŠ¨æ›¿æ¢è„šæœ¬æ–‡ä»¶åã€‚ç”±äº `bridge.js` çš„ä½ç½®ï¼Œåœ¨æ‰“åŒ…å`common.js`çš„å¼•å…¥é¡ºåºå…ˆäº`lib.js`ã€‚è¿™å°±å¯¼è‡´ `global.js` å…ˆäº `zepto.min.js` å¼•å…¥ä¸æ‰§è¡Œï¼Œå‡ºç°é”™è¯¯ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/5/1632ea590a6e0088?w=957&h=97&f=jpeg&s=159271)\r\n\r\nå¯¹æ­¤ï¼Œåœ¨ä¸å½±å“åŸæœ‰ä¾èµ–çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è°ƒæ•´è„šæœ¬é¡ºåº\r\n\r\n```HTML\r\n<script type=\"text/javascript\" src=\"//your.cdn.com/static/js/zepto.min.js\"></script>\r\n<script type=\"text/javascript\" src=\"//your.cdn.com/static/js/bluebird.core.min.js\"></script>\r\n<script type=\"text/javascript\" src=\"//your.cdn.com/static/js/bridge.js\"></script>\r\n<script type=\"text/javascript\" src=\"//your.cdn.com/static/js/global.js\"></script>\r\n```\r\n\r\nè¾“å‡ºçš„ç»“æœå¦‚ä¸‹ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/5/1632ea869bad3777?w=959&h=95&f=jpeg&s=161405)\r\n\r\n## 6. éªŒè¯æ•ˆæœ\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/5/1632eaf0bcf7c7b5?w=791&h=798&f=jpeg&s=328293)\r\n\r\næœ€ç»ˆåœ¨æ— ç¼“å­˜çš„slow 3Gä¸‹DCLæ—¶é—´11.19sï¼Œç›¸æ¯”æœ€åˆçš„17.00sï¼Œé™ä½34%ã€‚ï¼ˆwifiæƒ…å†µä¸‹é™æ¯”ä¾‹ç›¸åŒï¼Œæ—¶é—´å¤§è‡´åŒæ¯”ä¸º1/8~1/9ï¼Œæ¥è¿‘1sï¼‰ã€‚åŒæ—¶ï¼Œç›¸è¾ƒäºä¹‹å‰ï¼Œä¸€äº›é™æ€èµ„æºèƒ½å¤Ÿæ›´å¥½åœ°å»åˆ©ç”¨HTTP Cacheï¼ŒèŠ‚çœå¸¦å®½ï¼Œé™ä½æ¯æ¬¡æ–°ç‰ˆä¸Šçº¿åç”¨æˆ·è®¿é—®ç«™ç‚¹çš„é™æ€èµ„æºä¸‹è½½é‡ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/5/1632e66b434d09f4?w=1662&h=901&f=jpeg&s=336048)\r\n\r\n## 7. å†™åœ¨æœ€å\r\néœ€è¦æŒ‡å‡ºï¼Œæ€§èƒ½ä¼˜åŒ–ä¹Ÿè®¸æœ‰ä¸€äº›â€œåŸºæœ¬å‡†åˆ™â€ï¼Œä½†ç»å¯¹æ²¡æœ‰é“¶å¼¹ã€‚æ— è®ºæ˜¯å¤šä¹ˆâ€œåŸºç¡€ä¸é€šç”¨â€çš„ä¼˜åŒ–æ‰‹æ®µï¼Œäº¦æˆ–æ˜¯å¤šä¹ˆâ€œå¤æ‚è€Œæœ‰é’ˆå¯¹æ€§â€çš„ä¼˜åŒ–æ‰‹æ®µï¼Œéƒ½æ˜¯åœ¨è§£å†³ç‰¹å®šçš„å…·ä½“é—®é¢˜ã€‚å› æ­¤ï¼Œè§£å†³æ€§èƒ½é—®é¢˜å¾€å¾€éƒ½æ˜¯ä»å®é™…å‡ºå‘ï¼Œé€šè¿‡â€œæ’æŸ¥é—®é¢˜ --> åˆ†æè¯Šæ–­ --> å®æ–½ä¼˜åŒ– --> éªŒè¯æ•ˆæœâ€è¿™æ ·ä¸€æ¡ä¸æ–­å¾ªç¯çš„è·¯å¾„æ¥å¼€å±•çš„ã€‚\r\n\r\nåŒæ—¶ï¼Œæå‡æ€§èƒ½çš„å…¶ä¸­ä¸€ä¸ªç›®çš„å°±æ˜¯æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚ç”¨æˆ·ä½“éªŒå¾€å¾€æ˜¯ä¸€ä¸ªå®½æ³›çš„æ¦‚å¿µï¼Œæ¶‰åŠæ–¹æ–¹é¢é¢ã€‚ç›¸å¯¹åº”çš„ï¼Œæ€§èƒ½ä¼˜åŒ–ä¹Ÿä¸èƒ½åªæ­»ç›¯ç€æŸä¸ªâ€œæŒ‡æ ‡â€ï¼Œæ›´åº”è¯¥ç†è§£å…¶èƒŒåå¯¹äº§å“ä¸ç”¨æˆ·çš„æ„ä¹‰ã€‚ä»é—®é¢˜å‡ºå‘ï¼Œæ‹¿æ•°æ®é‡åŒ–ï¼Œæ‰¾è§£å†³æ–¹æ¡ˆã€‚\r\n\r\nåœ¨å®é™…ç¯å¢ƒä¸‹ï¼Œé¢å¯¹æœ‰é™çš„èµ„æºå’Œå„ç§é™åˆ¶ï¼Œåˆ›é€ æœ€å¤§çš„ä»·å€¼ã€‚æ€§èƒ½ä¼˜åŒ–æ›´æ˜¯å¦‚æ­¤ã€‚\r\n\r\n\r\n## å‚è€ƒèµ„æ–™\r\n\r\n- [HTML5 spec: parse HTML (the end)](https://www.w3.org/TR/html5/syntax.html#the-end)\r\n- [HTML5 spec: current-document-readiness](https://www.w3.org/TR/html5/dom.html#current-document-readiness)\r\n- [Deciphering the Critical Rendering Path](https://calendar.perfplanet.com/2012/deciphering-the-critical-rendering-path/)\r\n- [Network Analysis Reference](https://developers.google.com/web/tools/chrome-devtools/network-performance/reference)","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/23","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/23/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/23/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/23/events","html_url":"https://github.com/alienzhou/blog/issues/23","id":390660035,"node_id":"MDU6SXNzdWUzOTA2NjAwMzU=","number":23,"title":"Gulp.jså®è·µè¯¦è§£__åŸºäºGulpçš„å¤šé¡µé¢åº”ç”¨å®è·µæŒ‡å—","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1160330255,"node_id":"MDU6TGFiZWwxMTYwMzMwMjU1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7","name":"è‡ªåŠ¨åŒ–å·¥å…·","color":"f9c0d1","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T12:37:20Z","updated_at":"2018-12-13T12:54:54Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"![](http://upload-images.jianshu.io/upload_images/6476654-d582b5c044741c44.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\r\n## 1. ä»€ä¹ˆæ˜¯å¤šé¡µåº”ç”¨\r\nç›¸ä¿¡å¾ˆå¤šäººéƒ½çŸ¥é“å•é¡µé¢åº”ç”¨SPAï¼ˆsingle page web applicationï¼‰ï¼Œé‚£ä¹ˆä¸å…¶ç›¸å¯¹çš„å°±æ˜¯å¤šé¡µé¢åº”ç”¨ï¼Œæˆ–è€…è¯´æ˜¯è¿™ç§æ›´ä¸ºä¼ ç»Ÿçš„ç«™ç‚¹â€”â€”é€šè¿‡åç«¯è·¯ç”±æ§åˆ¶ï¼Œè®¿é—®ä¸åŒurlä¼šç”±æœåŠ¡å™¨åå‡ºä¸åŒçš„é¡µé¢ä¸é¡µé¢èµ„æºã€‚ç”±äºSEOç­‰ä¸€äº›å› ç´ ï¼Œè¿™ç§å¤šé¡µé¢çš„åº”ç”¨ï¼ˆæˆ–è€…è¯´æ˜¯ç«™ç‚¹æ›´åˆé€‚ï¼‰å¦‚ä»Šä»ç„¶æ˜¯ä¸€ç§éå¸¸é‡è¦çš„å½¢å¼ã€‚\r\n\r\nç”±äºè¿‘æœŸçš„é¡¹ç›®å½¢æ€å°±æ˜¯è¿™æ ·çš„ï¼Œè€Œåœ¨é¡¹ç›®ä¸­æœ€åé€‰æ‹©ä½¿ç”¨äº†gulpä½œä¸ºè‡ªåŠ¨åŒ–å·¥å…·ï¼Œä½†æ˜¯ç½‘ä¸Šçš„å„ç±»ç›¸å…³åšæ–‡éƒ½æ¯”è¾ƒé›¶ç¢ï¼Œä¸å¤Ÿç³»ç»Ÿï¼›åŒæ—¶åœ¨å®é™…åº”ç”¨ä¸­å°¤å…¶æ˜¯å¤šé¡µé¢ç«™ç‚¹ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜ä¹Ÿæ²¡æœ‰ç‰¹åˆ«å¥½çš„å®è·µï¼Œå› æ­¤ï¼Œå°†é¡¹ç›®ä¸­é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆæ•´ç†äº†ä¸€ä¸‹ã€‚\r\n\r\nåŒæ—¶ï¼Œå€Ÿç€é¡¹ç›®ä¸­ç¢°åˆ°çš„é—®é¢˜ï¼Œä¹Ÿè¯»äº†gulpåŠå…¶ä¸€äº›ç›¸å…³åº“çš„æºç ï¼Œä¹‹åä¹Ÿä¼šè€ƒè™‘å†™ä¸€äº›çŸ­æ–‡æ¥è¿›è¡Œäº¤æµã€‚\r\n\r\n## 2. ä»€ä¹ˆæ˜¯Gulp\r\n\r\nç›¸ä¿¡å¤§å®¶å¯¹Gulpåº”è¯¥ä¸ä¼šå¤ªé™Œç”Ÿï¼Œç”¨ä¸€å¥Gulpå®˜æ–¹çš„è¯æ¥è¯´ï¼š\r\n\r\n> Gulpå°±æ˜¯åŸºäºæµçš„å‰ç«¯è‡ªåŠ¨åŒ–æ„å»ºå·¥å…·\r\n\r\nå¦‚æœä½ å®Œå…¨ä¸äº†è§£gulpï¼Œå»ºè®®å¯ä»¥å…ˆç®€å•æµè§ˆä¸€ä¸‹[gulpçš„å®˜ç½‘](https://gulpjs.com/)\r\n\r\n> gulpæ˜¯å‰ç«¯å¼€å‘è¿‡ç¨‹ä¸­å¯¹ä»£ç è¿›è¡Œæ„å»ºçš„å·¥å…·ï¼Œæ˜¯è‡ªåŠ¨åŒ–é¡¹ç›®çš„æ„å»ºåˆ©å™¨ï¼›å®ƒä¸ä»…èƒ½å¯¹ç½‘ç«™èµ„æºè¿›è¡Œä¼˜åŒ–ï¼Œè€Œä¸”åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¾ˆå¤šé‡å¤çš„ä»»åŠ¡èƒ½å¤Ÿä½¿ç”¨æ­£ç¡®çš„å·¥å…·è‡ªåŠ¨å®Œæˆï¼›ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥å¾ˆæ„‰å¿«çš„ç¼–å†™ä»£ç ï¼Œè€Œä¸”å¤§å¤§æé«˜æˆ‘ä»¬çš„å·¥ä½œæ•ˆç‡ã€‚\r\n\r\nå¼€å‘è€…å¯ä»¥åœ¨æ–‡ä»¶è¯»å–ä¸è¾“å‡ºä¸­è¿›è¡Œç›¸åº”çš„æ“ä½œä¸å¤„ç†ï¼Œä»è€Œä½¿è¾“å‡ºçš„æ–‡ä»¶æ»¡è¶³ç”Ÿäº§è¦æ±‚ï¼Œå®ç°è‡ªåŠ¨åŒ–ã€‚å…¶æ ¸å¿ƒéƒ¨åˆ†ä¸»è¦æœ‰ä¸¤å—ï¼švinylä¸vinyl-fsç»„æˆçš„åŸºäºæ–‡ä»¶çš„ä¸€ç§objectModeæµåŠå…¶ç›¸å…³æ“ä½œï¼Œä»¥åŠorchestratorè¿™ä¸ªä»»åŠ¡ä»¥æ¥ä¸æ§åˆ¶ç³»ç»Ÿï¼ˆä½†æ˜¯gulp4.0å¥½åƒå·²ç»èˆå¼ƒäº†å®ƒï¼‰ã€‚å½“ç„¶ï¼Œæœ¬æ–‡ä¸ä¼šæ¥ä»‹ç»è¿™ä¸¤éƒ¨åˆ†çš„åŸç†æˆ–è€…å®ç°ï¼ˆè¿™éƒ¨åˆ†å†…å®¹ä¼šæ”¾åœ¨ä¹‹åçš„æ–‡ç« é‡Œï¼‰ï¼Œè€Œæ˜¯èšç„¦äºå…¶å®é™…çš„é¡¹ç›®åº”ç”¨ã€‚\r\n\r\n## 3. åœ¨å¤šé¡µåº”ç”¨å¼€å‘ä¸­ï¼Œæˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜\r\né¦–å…ˆï¼Œåœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬è‚¯å®šä¼šé‡åˆ°å„ç§ä¾èµ–å…³ç³»çš„ç®¡ç†ã€‚ç„¶è€Œå¦‚æœä¸ç”¨ä¸€äº›å‰ç«¯çš„ä¾èµ–ç®¡ç†æ¡†æ¶ï¼Œæµè§ˆå™¨æ˜¯æ— æ³•åŸç”Ÿæ”¯æŒå„ç§æ¨¡å—åŒ–è§„èŒƒçš„ï¼Œè€Œè‡ªåŠ¨åŒ–å·¥å…·çš„ä¸€å¤§ç›®æ ‡å°±æ˜¯å®ç°å®ƒä»¬ï¼ˆæˆ–è€…è¯´è®©ä½ å¼€å‘èµ·æ¥æ„Ÿè§‰åƒæ˜¯å®ç°äº†ï¼‰ã€‚\r\n\r\n![é¡¹ç›®å¼€å‘æ—¶çš„å„ç§ä¾èµ–å…³ç³»](http://upload-images.jianshu.io/upload_images/6476654-c78145e9df14fa47.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\r\n\r\nä¸Šå›¾å°±æ˜¯æˆ‘ä»¬éœ€è¦é¢å¯¹çš„ç¹æ‚çš„ä¾èµ–å…³ç³»ã€‚ä¸åƒå•é¡µï¼ˆSPAï¼‰åº”ç”¨ä¸­æ‰€æœ‰çš„JavaScriptæ¨¡å—éƒ½ä¼šæ‰“åŒ…ä¸ºä¸€ä¸ªæ–‡ä»¶ï¼ˆå½“ç„¶å¯èƒ½ä¼šæœ‰ä¸€äº›ä»£ç æ‹†åˆ†ä¹‹ç±»çš„å·¥ä½œï¼Œä½†å…¶æœ¬è´¨ä¸Šè¿˜æ˜¯å°†æ•´ä¸ªç«™ç‚¹çš„è·¯ç”±ç­‰é¡µé¢æ§åˆ¶çš„é€»è¾‘å‰ç½®åˆ°äº†æµè§ˆå™¨ç«¯ï¼‰ï¼›ä¸ä¹‹å¯¹åº”çš„ï¼Œå¤šé¡µé¢åº”ç”¨åˆ™å¯ä»¥è¯´æ˜¯ä¸€ç§æ›´ä¸ºä¼ ç»Ÿï¼Œé€šè¿‡åç«¯è·¯ç”±æ¥è¿›è¡Œé¡µé¢çš„è·³è½¬ã€‚\r\n\r\nå› æ­¤ä¸å•é¡µåº”ç”¨æœ€å¤§çš„ä¸åŒå°±åœ¨äºï¼Œå…¶æ‰“åŒ…å‡ºçš„æ–‡ä»¶å†³ä¸èƒ½æ˜¯ä¸€ä¸ªå•ä¸€çš„æ–‡ä»¶ï¼ˆä¸€ä¸ªJavaScriptæ–‡ä»¶å’Œä¸€ä¸ªCSSæ–‡ä»¶ï¼‰ã€‚é¡µé¢å¯èƒ½ä¼šåŒ…å«ä¸€äº›å…¬å…±éƒ¨åˆ†ï¼Œä½†æ¯ä¸ªé¡µé¢è‡³å°‘éœ€è¦å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„JavaScriptä¸ä¸€ä¸ªç‹¬ç«‹çš„CSSæ–‡ä»¶ã€‚å› æ­¤ï¼Œåœ¨å„ç§å¤æ‚çš„å¤„ç†åï¼Œå¯¹äºå¤šé¡µé¢åº”ç”¨ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯æ˜¾ç°ä¸‹å›¾çš„æ•ˆæœã€‚\r\n\r\n![image.png](http://upload-images.jianshu.io/upload_images/6476654-071fe32a56dc9b70.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\r\n\r\nå…¶æ¬¡ï¼Œåœ¨ç®¡ç†æ¨¡å—åŒ–ä¾èµ–ä¹‹å¤–ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦é¢„å¤„ç†ä¸€äº›æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼šå°†lessæ–‡ä»¶ç¼–è¯‘ä¸ºcssæ–‡ä»¶ï¼Œé€šè¿‡babelæ¥ä½¿æˆ‘ä»¬çš„es6ä»£ç èƒ½è¿è¡Œåœ¨ä¸æ”¯æŒes6çš„æµè§ˆå™¨ç­‰ç­‰ã€‚\r\n\r\næ­¤å¤–ï¼Œç±»ä¼¼åœ¨å•é¡µåº”ç”¨ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨å¤šé¡µé¢çš„æƒ…å†µä¸‹ä¹Ÿä¼šè¦å¤„ç†ã€‚ä¾‹å¦‚æ›¿æ¢HTMLä¸­çš„ç¯å¢ƒå˜é‡ï¼Œå¤„ç†CSSä¸­çš„é›ªç¢§å›¾ï¼Œç”šè‡³è§„é¿ä¸€äº›ä»£ç æ£€æŸ¥ç­‰ç­‰ã€‚\r\n\r\næœ€ç»ˆï¼Œæˆ‘ä»¬è¦å°†è¿™äº›å¤„ç†åçš„å†…å®¹å‘å¸ƒåˆ°è¿è¡Œç›®å½•ä¸­ï¼Œå®ç°è‡ªåŠ¨åŒ–æµç¨‹ã€‚\r\n\r\n## 4. å¦‚ä½•ç”¨Gulpæ¥è§£å†³è¿™äº›é—®é¢˜ï¼ˆworkflowï¼‰\r\nå¦‚æœç»†ç»†æ¢³ç†ä¸Šä¸€èŠ‚æ‰€è°ˆåŠçš„å„é¡¹ç›®æ ‡ä¸å·¥ä½œï¼Œå¯ä»¥å‘ç°ï¼Œè¿™æ˜¯ä¸€ä¸ªç´§å¯†ç›¸æ¥çš„å·¥ä½œæµç¨‹ï¼ˆworkflowï¼‰ï¼Œè¿™ä¸€èŠ‚ä¼šè¯¦ç»†è®²è§£å„ä¸ªå·¥ä½œæµç¨‹ã€‚\r\n### 4.1. JSéƒ¨åˆ†\r\né¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹JavaScriptéƒ¨åˆ†çš„å·¥ä½œæµç¨‹ï¼š\r\n\r\n\r\n![JavaScriptéƒ¨åˆ†å¤„ç†æµç¨‹](http://upload-images.jianshu.io/upload_images/6476654-a512d598d147d565.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\r\n\r\n#### 4.1.1. æ¨¡å—åŒ–æ‰“åŒ…\r\n\r\né¡¹ç›®ä½¿ç”¨browserifyæ¥å®ç°CommonJSã€‚å¦‚æœç”¨è¿‡browserifyï¼Œåº”è¯¥ä¸ä¼šå¯¹ä¸‹é¢è¿™æ®µä»£ç æ„Ÿåˆ°é™Œç”Ÿï¼š\r\n```javascript\r\nbrowserify({\r\n  entries: $your_entry_arr,\r\n  cache: {},\r\n  packageCache: {},\r\n  plugin: $your_plugin_arr\r\n});\r\n```\r\né€šè¿‡è®¾ç½®ä¸€ä¸ªï¼ˆæˆ–ä¸€äº›ï¼‰å…¥å£æ–‡ä»¶ï¼Œå¯ä»¥å°†å…¥å£æ–‡ä»¶æ‰“åŒ…ä¸ºä¸€ä¸ªæ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œåœ¨å¤šé¡µé¢åº”ç”¨ä¸­ï¼Œæœ€é‡è¦çš„æœ‰ç‚¹å°±æ˜¯ï¼Œå„ä¸ªé¡µé¢ä¼šæœ‰è‡ªå·±çš„JavaScriptè„šæœ¬æ–‡ä»¶ã€‚åœ¨é¡¹ç›®å¼€å‘æ—¶ï¼Œåœ¨æ¯ä¸ªHTMLé¡µé¢ä¸­å¼•å…¥ä¸€ä¸ªè¯¥é¡µé¢ç‰¹æœ‰çš„JavaScriptè„šæœ¬ã€‚ä¾‹å¦‚é¡µé¢list.htmlä¸­é€šè¿‡`<script src=\"../js/list.js\"></script>`å¼•å…¥è„šæœ¬ã€‚è€Œè¯¥è„šæœ¬ä½¿ç”¨CommonJSè§„èŒƒè¿›è¡Œæ¨¡å—åŒ–ã€‚\r\n\r\n```javascript\r\n// ../js/list.js\r\nconst button = require('./common/button');\r\n// ä¸€äº›buttonçš„æ“ä½œ\r\nbutton.render('#button');\r\n// â€¦â€¦\r\n```\r\nå› æ­¤ï¼Œéœ€è¦é’ˆå¯¹ä¸åŒçš„é¡µé¢ï¼Œæ‰“åŒ…å‡ºå¤šä»½çš„JavaScriptæ–‡ä»¶ã€‚é¦–å…ˆä½¿ç”¨`node-glob`è·å–æ¯ä¸ªé¡µé¢çš„å…¥å£æ–‡ä»¶ï¼Œå…¶ä¸­`SRC_JS_PATH`ä¸ºJavaScriptæºç çš„è·¯å¾„\r\n\r\n```javascript\r\n/**\r\n * è·å–jså…¥å£æ–‡ä»¶è·¯å¾„ç»„\r\n * @return {Array} æ–‡ä»¶è·¯å¾„æ•°ç»„\r\n */\r\nconst getEntryJsFiles = () => (\r\n    glob.sync(`${SRC_JS_PATH}/**/*.js`, {\r\n        ignore: [`${SRC_JS_PATH}/*.dist.js`, `${SRC_JS_PATH}/*.mod.js`]\r\n    })\r\n);\r\n```\r\nç„¶åï¼Œå¯¹æ¯ä¸ªå…¥å£æ–‡ä»¶åˆ›å»ºå…¶å¯¹åº”çš„bundleå¯¹è±¡å¹¶è¿”å›ï¼Œä»¥ä¾¿äºåœ¨æ¯ä¸ªbundleå¯¹è±¡ä¸Šè¿›è¡Œåç»­çš„jsä»»åŠ¡å¤„ç†\r\n```javascript\r\nlet files = getEntryJsFiles();\r\n\r\n// éå†æ‰€æœ‰å…¥å£æ–‡ä»¶ï¼Œç”Ÿæˆbrowserifyå¯¹è±¡\r\nbundleTasks = files.map(ele => ({\r\n  bundle: browserify({\r\n  entries: [ele],\r\n  cache: {},\r\n  packageCache: {},\r\n  plugin: [watchify]\r\n  }),\r\n  filename: ele\r\n}));\r\n```\r\nè¿™æ ·ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ª`bundleTasks`ï¼Œé‡Œé¢ä¿å­˜äº†æ‰€æœ‰é¡µé¢å¯¹åº”çš„å„è‡ªçš„å…¥å£æ–‡ä»¶çš„bundleå¯¹è±¡ä¸æ–‡ä»¶åã€‚ä¸‹é¢æˆ‘ä»¬å°±ä¼šå¯¹æ¯ä¸ªbundleå¯¹è±¡éƒ½åº”ç”¨ä¸Šé¢æµç¨‹å›¾ä¸­çš„å·¥åºè¿›è¡Œå¤„ç†ã€‚æˆ‘ä»¬å…ˆä¿ç•™è¿™ä¸ª`bundleTasks`æ•°ç»„ï¼Œæ¥è®²è®²å…¶ä»–çš„å·¥ä½œæµç¨‹ã€‚\r\n\r\n#### 4.1.2. è·¯å¾„ä¿®æ­£\r\nç”±äºä½¿ç”¨`node-glob`è¿›è¡ŒåŒ¹é…ï¼Œæ‰€ä»¥åŒ¹é…åˆ°çš„è·¯å¾„ä¸å•å•åŒ…å«æ–‡ä»¶åï¼Œå¯èƒ½è¿˜ä¼šåŒ…å«æŸäº›ç›®å½•åã€‚ä¾‹å¦‚ï¼Œå¯èƒ½æƒ³è¦åŒ¹é…`list.js`ï¼Œä½†æ˜¯ç”±äºå·¥ä½œè·¯å¾„ç­‰åŸå› ï¼Œå®é™…è¾“å‡ºçš„è·¯å¾„åä¸º`./page/list.js`ã€‚é‚£ä¹ˆä¸è¿›è¡Œå¤„ç†ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ\r\n\r\nå¦‚æœç›´æ¥ä½¿ç”¨`gulp.dest`è¿›è¡Œè¾“å‡ºï¼Œé»˜è®¤ä¼šå¸¦ä¸ŠåŒ¹é…å‡ºæ¥çš„è·¯å¾„é‡Œé¢çš„æ‰€æœ‰ç‰‡æ®µï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯èƒ½åªå¸Œæœ›åœ¨distç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªlist.jsæ–‡ä»¶ï¼Œä½†å®é™…ä¸Šä¼šç”Ÿæˆä¸€ä¸ªpageç›®å½•ï¼Œç›®å½•é‡ŒåŒ…å«list.jsæ–‡ä»¶ã€‚è¿™å°±ä¸ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚äº†ã€‚å› æ­¤ï¼Œä½¿ç”¨`gulp-rename`è¿›è¡Œè·¯å¾„è°ƒæ•´ï¼ˆå½“ç„¶ï¼Œ`gulp-rename`ä¹Ÿå¯ä»¥é‡å‘½åæ–‡ä»¶ï¼‰ã€‚\r\n\r\nåœ¨è¿™é‡Œï¼Œè¿˜è¦æ¨èä¸€ä¸ªgulpå·¥å…·ï¼š`gulp-load-plugins`ã€‚å®ƒå¯ä»¥è‡ªåŠ¨å¸®æˆ‘ä»¬åŠ è½½`gulp-`å¼€å¤´çš„å„ç±»gulpæ’ä»¶ã€‚å› æ­¤ï¼Œå¯ä»¥å¾ˆæ–¹é¢å¾—è¿›è¡Œè·¯å¾„è°ƒæ•´ã€‚\r\n```javascript\r\n.pipe(plugins.rename({\r\n  dirname: ''\r\n}))\r\n```\r\næˆ‘ä»¬éœ€è¦å°†è¯¥æ­¥å¤„ç†ç½®äºæ‰“åŒ…æ“ä½œä¹‹åã€‚è¿™é‡Œæœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œç”±äºbundleçš„streamæ˜¯ä¸€ä¸ªæ™®é€šæ¨¡å¼çš„streamï¼Œè€Œgulpï¼ˆvinylï¼‰çš„streamåˆ™æ˜¯ä¸€ä¸ªobjectModeçš„streamï¼Œå› æ­¤éœ€è¦ä¸€äº›è½¬åŒ–ä¸å¤„ç†ã€‚è¿™é‡Œå°±ç”¨åˆ°äº†`vinyl-source-stream`ä¸`vinyl-buffer`ä¸¤ä¸ªåº“ï¼š\r\n```javascript\r\nconst source = require('vinyl-source-stream');\r\nconst buffer = require('vinyl-buffer');\r\nconst plugins = require('gulp-load-plugins')();\r\n\r\nbundle\r\n  .pipe(source(filename))\r\n  .pipe(buffer())\r\n  .pipe(plugins.rename({ // ä¿®æ­£è·¯å¾„åç§°\r\n    dirname: ''\r\n  }))\r\n```\r\n\r\n#### 4.1.3. è½¬ç \r\nè™½ç„¶éƒ¨åˆ†æµè§ˆå™¨å¯¹äºes6è¯­æ³•å·²ç»æœ‰äº†è¾ƒå¥½çš„åŸç”Ÿæ”¯æŒï¼Œä½†æ˜¯ä¸ºäº†èƒ½æ›´å¥½å¾—ä¿è¯es6ä»£ç åœ¨æµè§ˆå™¨ç«¯çš„æ­£å¸¸è¿è¡Œï¼Œè¿˜æ˜¯æ¨èä½¿ç”¨babelè¿™æ ·çš„å·¥å…·æ¥ä½¿å¾—ç”Ÿäº§ç¯å¢ƒä¸‹çš„ä»£ç å…·æœ‰å¾ˆå¥½çš„æµè§ˆå™¨å…¼å®¹æ€§ï¼ˆè½¬ä¸ºes5ï¼‰ã€‚è€Œåœ¨gulpä¸­åªéœ€ä½¿ç”¨`gulp-babel`æ’ä»¶å°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®ç°ï¼Œåªéœ€ç®€å•å‡ è¡Œä»£ç ï¼š\r\n```javascript\r\n.pipe(plugins.babel({\r\n  presets: ['env']\r\n}))\r\n```\r\næˆ‘ä»¬å°†è¯¥æ­¥æ“ä½œç½®äºç¬¬äºŒæ­¥ä¸­çš„pipeä¹‹åã€‚\r\n```javascript\r\nconst source = require('vinyl-source-stream');\r\nconst buffer = require('vinyl-buffer');\r\nconst plugins = require('gulp-load-plugins')();\r\n\r\nbundle\r\n  .pipe(source(filename))\r\n  .pipe(buffer())\r\n  .pipe(plugins.rename({\r\n    dirname: ''\r\n  }))\r\n  .pipe(plugins.babel({ // babel\r\n    presets: ['env']\r\n  }))\r\n```\r\n\r\n#### 4.1.4. ç¦ç”¨ä»£ç æ£€æŸ¥\r\nç”±äºé¡¹ç›®çš„ä¸€äº›ç‰¹æ®ŠåŸå› ï¼Œéœ€è¦å°†å¼€å‘æ—¶çš„æºç å’Œå‘å¸ƒçš„ç”Ÿäº§ç¯å¢ƒä»£ç ä¸€åŒä¸Šä¼ åˆ°çº¿ä¸Šä»£ç åº“ï¼ŒåŒæ—¶éœ€è¦é€šè¿‡jslintçš„ä¸€äº›ä»£ç æ£€æŸ¥ã€‚ä½†æ˜¯å‘å¸ƒåçš„ä»£ç å¾ˆå¤šæ—¶å€™æ˜¯ä¸ç¬¦åˆä»£ç è§„èŒƒçš„ï¼Œå› æ­¤ï¼Œéœ€è¦é€šè¿‡æ·»åŠ ä¸€äº›æ³¨é‡Šæ¥å–æ¶ˆå¯¹éƒ¨åˆ†å‘å¸ƒåä»£ç çš„æ£€æŸ¥ã€‚\r\n\r\nè¿™ä¸ªæ’ä»¶ä¹Ÿéå¸¸ç®€å•ï¼Œé€šè¿‡åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼Œä¸ºæ–‡ä»¶å¤´éƒ¨åŠ å…¥ç‰¹å®šçš„æ³¨é‡Šæ–‡æœ¬å³å¯ï¼š\r\n```javascript\r\nconst through = require('through2');\r\nconst gutil = require('gulp-util');\r\nconst path = require('path');\r\nconst DIS_LINTER = {\r\n    html: '<!-- htmlcs-disable -->',\r\n    css: '/* csshint-disable */',\r\n    js: '/*eslint-disable */'\r\n};\r\n\r\nconst dislint = preText => {\r\n  let js = new Buffer(`${DIS_LINTER['js']}\\n`);\r\n  let css = new Buffer(`${DIS_LINTER['css']}\\n`);\r\n  let html = new Buffer(`${DIS_LINTER['html']}\\n`);\r\n  let buf = {\r\n    html,\r\n    css,\r\n    js\r\n  };\r\n\r\n  return through.obj((chunk, enc, cb) => {\r\n    let ext = '';\r\n    try {\r\n      ext = path.extname(chunk.path);\r\n    }\r\n    catch (err) {\r\n      console.log(err);\r\n    }\r\n    ext = ext.length > 0 ? ext.slice(1) : 'js';\r\n\r\n    // gutil.log(gutil.colors.magenta('[Disable Linter]'), chunk.path);\r\n    let preBuf = preText && preText.length > 0 ? new Buffer(preText) : buf[ext];\r\n    if (chunk.isNull()) {\r\n      cb(null, chunk);\r\n    }\r\n    if (chunk.isBuffer()) {\r\n      chunk.contents = Buffer.concat([preBuf, chunk.contents]);\r\n    }\r\n    if (chunk.isStream()) {\r\n      let stream = through();\r\n      stream.write(preBuf);\r\n      chunk.contents = chunk.contents.pipe(stream);\r\n    }\r\n    cb(null, chunk);\r\n  });\r\n};\r\n\r\nmodule.exports = dislint;\r\n```\r\n\r\nä½¿ç”¨è¯¥æ’ä»¶ï¼š\r\n\r\n```javascript\r\nconst source = require('vinyl-source-stream');\r\nconst buffer = require('vinyl-buffer');\r\nconst plugins = require('gulp-load-plugins')();\r\nconst dislint = require('./dislint');\r\n\r\nbundle\r\n  .pipe(source(filename))\r\n  .pipe(buffer())\r\n  .pipe(plugins.rename({\r\n    dirname: ''\r\n  }))\r\n  .pipe(plugins.babel({\r\n    presets: ['env']\r\n  }))\r\n  .pipe(dislint()) // å–æ¶ˆä»£ç æ£€æŸ¥\r\n```\r\n\r\n#### 4.1.5. æ·»åŠ md5æˆ³å¹¶è¾“å‡º\r\nä¸ºäº†é˜²æ­¢ç”¨æˆ·æµè§ˆå™¨ç¼“å­˜å½±å“èµ„æºæ›´æ–°ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ md5æˆ³çš„æ–¹å¼ï¼Œæ¥æ”¹å˜æ–‡ä»¶åç§°ã€‚è¿™é‡Œç”¨åˆ°äº†`gulp-md5Plus`è¿™ä¸ªæ’ä»¶ã€‚\r\n\r\næ­¤å¤–ï¼Œåœ¨å¼€å‘é˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç¦ç”¨æµè§ˆå™¨ç¼“å­˜ä¿è¯è·å–æœ€æ–°çš„èµ„æºï¼Œå› æ­¤ï¼Œåœ¨å¼€å‘é˜¶æ®µå¯ä»¥ç¦ç”¨ç”Ÿæˆmd5çš„åŠŸèƒ½ã€‚è¦æ ¹æ®ä¸åŒçš„ç¯å¢ƒè¿›è¡Œä¸åŒçš„æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡è¿›è¡Œæ‰§è¡Œã€‚`gulp-util`æä¾›äº†è¿™ä¸€åŠŸèƒ½ã€‚`gulp-util`æ˜¯gulpå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªgulpçš„å¸¸ç”¨åŠŸèƒ½å·¥å…·ç®±ï¼Œé‡Œé¢åŒ…å«äº†logã€ç±»å‹åˆ¤æ–­ç­‰ä¸€ç³»åˆ—åŠŸèƒ½ã€‚\r\n\r\nè¿™é‡Œï¼Œæˆ‘ä»¬ä¼šåœ¨éç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨`gutil.noop()`ä½œä¸ºä¸€ä¸ªä¸è¿›è¡Œä»»åŠ¡å¤„ç†çš„streamå¯¼å‡ºï¼›è€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ä½¿ç”¨`gulp-md5Plus`æ¥å®ç°md5ã€‚æœ€åï¼Œå°†å¤„ç†åçš„æ–‡ä»¶è¾“å‡ºåˆ°æŒ‡å®šçš„å‘å¸ƒç›®å½•ï¼š\r\n```javascript\r\nconst source = require('vinyl-source-stream');\r\nconst buffer = require('vinyl-buffer');\r\nconst plugins = require('gulp-load-plugins')();\r\nconst dislint = require('./dislint');\r\nconst gutil = require('gulp-util');\r\n\r\nbundle\r\n  .pipe(source(filename))\r\n  .pipe(buffer())\r\n  .pipe(plugins.rename({\r\n    dirname: ''\r\n  }))\r\n  .pipe(plugins.babel({\r\n    presets: ['env']\r\n  }))\r\n  .pipe(dislint())\r\n  .pipe(gutil.env.env === 'production' ? plugins.md5Plus(5, `${DIST_HTML_PATH}/**/*.html`) : gutil.noop())  // md5\r\n  .pipe(gulp.dest(DIST_JS_PATH)) // å‘å¸ƒæ–‡ä»¶\r\n```\r\n\r\n#### 4.1.6. é”™è¯¯å¤„ç†\r\nç”±äºgulpæ˜¯åŸºäºstreamçš„æ“ä½œï¼Œå› æ­¤ä½¿ç”¨tryâ€¦catchâ€¦è¯­æ³•æ˜¾ç„¶æ˜¯æ— æ³•å¤„ç†æŠ›å‡ºçš„å¼‚å¸¸ï¼›å–è€Œä»£ä¹‹å°±éœ€è¦ç›‘å¬streamä¸Šçš„erroräº‹ä»¶ã€‚ä½†æ˜¯ï¼Œåœ¨ä»£ç é‡Œï¼Œæˆ‘ä»¬æ€»ä¸èƒ½åœ¨æ¯ä¸ª`.pipe()`ååŠ ä¸Š`.on('error', function(){}})`è¿™æ ·çš„ä»£ç å§ï¼Œé‚£ä¹Ÿå¤ªè‡ƒè‚¿äº†ã€‚\r\n\r\nä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±å¯ä»¥ä½¿ç”¨`gulp-plumber`æ’ä»¶ã€‚åªéœ€è¦åœ¨streamçš„æœ€å‰é¢åŠ ä¸Šå®ƒï¼Œå°±å¯ä»¥äº†ã€‚\r\n```javascript\r\nbundle\r\n  .pipe(plugins.plumber(err => {\r\n    log(red(`[${err.plugin}]`), red(err.message));\r\n  }))\r\n  .pipe(source(filename))\r\n  .pipe(buffer())\r\n  .pipe(plugins.rename({\r\n    dirname: ''\r\n  }))\r\n  .pipe(plugins.babel({\r\n    presets: ['env']\r\n  }))\r\n  .pipe(dislint())\r\n  .pipe(gutil.env.env === 'production' ? plugins.md5Plus(5, `${DIST_HTML_PATH}/**/*.html`) : gutil.noop())  // md5\r\n  .pipe(gulp.dest(DIST_JS_PATH)) // å‘å¸ƒæ–‡ä»¶\r\n```\r\n\r\n#### 4.1.7. å°è£…ä»»åŠ¡\r\nå¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„ä¸€ç³»åˆ—ä»»åŠ¡æ˜¯æ¯ä¸ªå…¥å£jsæ–‡ä»¶éƒ½ä¼šç»å†çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å°†â€œè·¯å¾„ä¿®æ­£-->è½¬ç -->ç¦ç”¨ä»£ç æ£€æŸ¥-->md5-->è¾“å‡ºâ€è¿™ä¸ªæµç¨‹å°è£…ä¸ºä¸€ä¸ªå«åšjsTaskçš„ä»»åŠ¡ï¼Œå¹¶åº”ç”¨åœ¨æ¯ä¸ªbundleä¸Šã€‚\r\n\r\n```javascript\r\n/**\r\n * jsä»»åŠ¡æµï¼Œå…·ä½“åŒ…æ‹¬ï¼š\r\n * æ¨¡å—æ‰“åŒ… --> è·¯å¾„ä¿®æ­£(é‡å‘½å) --> babel --> å–æ¶ˆä»£ç æ£€æŸ¥ --> md5(productionçŠ¶æ€) --> äº§å‡º\r\n * @param {Object} bundle å„å…¥å£æ–‡ä»¶çš„browserifyå¯¹è±¡\r\n * @param {string} filename å…¥å£æ–‡ä»¶å\r\n * @return {stream} stream å¯¹è±¡\r\n */\r\nconst jsTask = ({bundle, filename}) => (\r\n    bundle.bundle((err, buf) => {\r\n        if (err) {\r\n            // æµè§ˆå™¨æç¤º\r\n            browserSync.notify(`[Browserify Error] ${err.message}`, 10000);\r\n            log(red('[Browserify Error]'), red(err.message));\r\n        }\r\n    })\r\n    .pipe(plugins.plumber(err => {\r\n        log(red(`[${err.plugin}]`), red(err.message));\r\n    }))\r\n    .pipe(source(filename))\r\n    .pipe(buffer())\r\n    .pipe(plugins.rename({\r\n        dirname: ''\r\n    }))\r\n    .pipe(plugins.babel({\r\n        presets: ['env']\r\n    }))\r\n    .pipe(dislint())\r\n    .pipe(gutil.env.env === 'production' ? plugins.md5Plus(5, `${DIST_HTML_PATH}/**/*.html`) : gutil.noop())\r\n    .pipe(gulp.dest(DIST_JS_PATH))\r\n);\r\n```\r\n`jsTask`ä¼šåŒ…è£…å¹¶è¿”å›æ•´ä¸ªjsä»»åŠ¡çš„æµã€‚åŸºäºä»¥ä¸Šä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª`dist:js`ä»»åŠ¡æ¥å‘å¸ƒjsä»£ç ï¼š\r\n\r\n```javascript\r\n/**\r\n * è·å–jså…¥å£æ–‡ä»¶è·¯å¾„ç»„\r\n * @return {Array} æ–‡ä»¶è·¯å¾„æ•°ç»„\r\n */\r\nconst getEntryJsFiles = () => (\r\n  glob.sync(`${SRC_JS_PATH}/**/*.js`, {\r\n    ignore: [`${SRC_JS_PATH}/*.dist.js`, `${SRC_JS_PATH}/*.mod.js`]\r\n  })\r\n);\r\n\r\n// [å‘å¸ƒ]jsä»£ç ï¼Œå…¶ä¸­ä¼šè¿›è¡Œjsç›¸å…³å·¥ä½œæµç¨‹\r\ngulp.task('dist:js', cb => {\r\n  let files = getEntryJsFiles();\r\n\r\n  // éå†æ‰€æœ‰å…¥å£æ–‡ä»¶ï¼Œç”Ÿæˆbrowserifyå¯¹è±¡\r\n  bundleTasks = files.map(ele => ({\r\n    bundle: browserify({\r\n      entries: [ele],\r\n      cache: {},\r\n      packageCache: {},\r\n      plugin: [watchify]\r\n    }),\r\n    filename: ele\r\n  }));\r\n\r\n  // æ˜ å°„ä¸åˆå¹¶jsæµ\r\n  let streams = bundleTasks.map(jsTask);\r\n  return es.merge(streams);\r\n});\r\n\r\n// [åˆ é™¤]å‘å¸ƒç›®å½•ä¸‹çš„jsæ–‡ä»¶\r\ngulp.task('del:js', () => del.sync([`${DIST_JS_PATH}/*`]));\r\n```\r\n#### 4.1.8. è‡ªåŠ¨åˆ·æ–°æµè§ˆå™¨\r\nå‰ç«¯å¼€å‘éœ€è¦é¢‘ç¹ä¿®æ”¹å¹¶å¸Œæœ›èƒ½çœ‹åˆ°æµè§ˆå™¨ä¸­å±•ç°çš„æƒ…å†µï¼Œå› æ­¤ï¼Œè§£æ”¾ä½ çš„F5æ˜¾ç„¶å¾ˆæœ‰å¿…è¦ã€‚åœ¨é¡¹ç›®é‡Œï¼Œå¯ä»¥ä½¿ç”¨`browserSync`æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚\r\n\r\n`browserSync`å¯ä»¥åœ¨ä»£ç æ›´æ–°æ—¶è‡ªåŠ¨åˆ·æ–°æµè§ˆå™¨ï¼ŒåŒæ—¶è¿˜å¯ä»¥å‘æµè§ˆå™¨æ¨é€æ¶ˆæ¯è¿›è¡Œå±•ç¤ºã€‚ä½¿ç”¨`browserSync`ï¼Œå¯ä»¥å»ºç«‹ç›¸åº”çš„gulpä»»åŠ¡ï¼Œåœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œgulpæ—¶å¯åŠ¨browserSyncï¼Œå¹¶åˆ›å»ºreload:browserä»»åŠ¡ï¼Œè¿™æ ·åœ¨éœ€è¦çš„æ—¶å€™å°±èƒ½æ–¹ä¾¿å¾—è§¦å‘æµè§ˆå™¨åˆ·æ–°ã€‚\r\n```javascript\r\nconst browserSync = require('browser-sync').create();\r\n\r\n// [å¯åŠ¨]browserSync\r\ngulp.task('start:browserSync', () => browserSync.init({\r\n  proxy: '192.168.11.23',\r\n  notify: true\r\n}));\r\n\r\n// åˆ·æ–°æµè§ˆå™¨\r\ngulp.task('reload:browser', cb => {\r\n  browserSync.reload();\r\n  cb();\r\n});\r\n```\r\n\r\n#### 4.1.9. å¢é‡å‘å¸ƒ\r\nä¸Šé¢ä»‹ç»äº†å¯¹äºä¸€ä¸ªjså…¥å£æ–‡ä»¶çš„æ•´å¥—å·¥ä½œæµã€‚ç„¶è€Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬åœ¨ä¿®æ”¹äº†æŸä¸€ä¸ªæ–‡ä»¶ä¹‹åï¼Œå¹¶ä¸éœ€è¦å°†æ‰€æœ‰çš„ä»£ç å…¨é‡å†å‘å¸ƒä¸€éï¼Œå¦‚æœèƒ½æ¯æ¬¡åªå¢é‡å¾—å‘å¸ƒä¸ä¿®æ”¹ç›¸å…³çš„jsä»£ç ï¼Œä¼šåœ¨å¼€å‘ä½“éªŒä¸æ•ˆç‡ä¸Šæœ‰è¾ƒå¤§çš„æå‡ã€‚\r\n\r\nåŒæ—¶ï¼Œç»“åˆ`browserSync`å¯ä»¥è®©ä½ çš„å¼€å‘æ•ˆç‡æå¤§è·å¾—æå‡ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦`watchify`æ¥è¿›è¡Œæ–‡ä»¶ç›‘å¬ï¼Œå¹¶å°†å…¶ä½œä¸º`browserify`çš„æ’ä»¶ï¼Œå®ç°æ–‡ä»¶çš„å¢é‡æ‰“åŒ…ç¼–è¯‘ã€‚é€šè¿‡ç›‘å¬æ¯ä¸ªbundleçš„updateäº‹ä»¶ï¼Œå¯ä»¥åœ¨æ–‡ä»¶æ›´æ–°æ—¶é‡æ–°æ‰“åŒ…å¹¶å¤„ç†å‘å¸ƒï¼Œæœ€ååˆ°streamè§¦å‘endäº‹ä»¶ï¼ˆå¤„ç†å®Œæˆï¼‰æ—¶åˆ·æ–°æµè§ˆå™¨ã€‚\r\n\r\n```javascript\r\n/**\r\n * ç›‘å¬å„ä¸ªbrowserifyå¯¹è±¡çš„updateäº‹ä»¶\r\n * åœ¨æ¨¡å—æ›´æ–°æ—¶æŒ‰éœ€æ‰“åŒ…\r\n * @param {Object} bundle å„å…¥å£æ–‡ä»¶çš„browserifyå¯¹è±¡\r\n * @param {string} filename å…¥å£æ–‡ä»¶å\r\n */\r\nconst addBundleTaskListeners = ({bundle, filename}) => {\r\n  bundle.on('update', () => {\r\n    log(blue('[Browserify Update]'), filename);\r\n    let sm = jsTask({bundle, filename});\r\n    // æ‰“åŒ…å®Œæˆååˆ·æ–°æµè§ˆå™¨ï¼ˆé”™è¯¯ä¸åˆ·æ–°ï¼Œä¿ç•™notifyï¼‰\r\n    sm.on('end', () => runSequence('reload:browser'));\r\n  });\r\n};\r\n\r\n// [ç›‘å¬]ä¸ºæ‰€æœ‰å…¥å£æ–‡ä»¶å¯¹åº”çš„browserifyå¯¹è±¡æ·»åŠ updateç›‘å¬\r\ngulp.task('watch:js', () => {\r\n  bundleTasks.forEach(item => {\r\n    addBundleTaskListeners(item);\r\n  });\r\n});\r\n```\r\n\r\n### 4.2. HTMLéƒ¨åˆ†\r\n\r\n![HTMLéƒ¨åˆ†å¤„ç†æµç¨‹](http://upload-images.jianshu.io/upload_images/6476654-826361fea7518d59.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\r\n\r\nHTMLéƒ¨åˆ†ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªå·¥ä½œï¼šæ–‡ä»¶å†…å˜é‡çš„æ›¿æ¢ä¸æ–‡ä»¶è·¯å¾„çš„ä¿®æ­£ã€‚\r\n\r\n#### 4.2.1. æ›¿æ¢æ–‡ä»¶å†…å˜é‡\r\nåœ¨å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šæœ‰ç±»ä¼¼è¿™æ ·çš„éœ€æ±‚ï¼š\r\n- åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ä¼šå¼•ç”¨ä¸€äº›å¼€å‘æœºä¸Šçš„é™æ€èµ„æºï¼›ç„¶è€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåˆ™éœ€è¦æ›¿æ¢æˆçº¿ä¸Šçš„CDNåœ°å€ã€‚\r\n- ååŒå¼€å‘ä¸‹ï¼Œä¸åŒçš„å¼€å‘äººå‘˜å¯èƒ½ä¼šä½¿ç”¨ä¸åŒçš„èµ„æºè·¯å¾„ã€‚\r\n- ä¸ºæ¯ä¸ªHTMLè®¾ç½®titleå†…å®¹ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†ä¸ºç»Ÿä¸€æ–‡å­—ï¼Œä¾‹å¦‚ï¼šæˆ‘çš„ä¸»é¡µâ€”â€”è´¡çŒ®åˆ—è¡¨ã€æˆ‘çš„ä¸»é¡µâ€”â€”ä¸ªäººè®¾ç½®â€¦å°¤å…¶åœ¨å¼€å‘ä¸­ï¼Œâ€œæˆ‘çš„ä¸»é¡µâ€å¯èƒ½çªç„¶è¦è¢«æ¢æˆâ€œä¸ªäººä¸­å¿ƒâ€ä¹‹ç±»çš„â€¦\r\n- HTMLä¸­å…¶ä»–ä¸å¸¸æ›´æ”¹ä½†å¯èƒ½éœ€è¦å„å¤„ç»Ÿä¸€çš„éƒ¨åˆ†â€¦\r\n\r\nä¸Šé¢è¿™äº›éœ€æ±‚æˆ‘ä»¬å½“ç„¶å¯ä»¥é€šè¿‡æ‰‹å·¥æ›¿æ¢çš„æ–¹å¼å¼€è§£å†³ï¼Œå®ƒä»¬æœ¬èº«å¹¶æ— å¤ªå¤šæŠ€æœ¯å«é‡ï¼Œä½†å¾ˆæµªè´¹å¼€å‘äººå‘˜çš„ç²¾åŠ›ï¼Œå¹¶ä¸”è¿˜å¯èƒ½å› ä¸ºç²—å¿ƒå¤§æ„äº§ç”Ÿé”™è¯¯æˆ–é—æ¼ã€‚å› æ­¤å¦‚æœèƒ½åœ¨gulpä¸­è‡ªåŠ¨æ›¿æ¢è¿™äº›å˜é‡ï¼Œå¿…ç„¶ä¼šèŠ‚çœå¾ˆå¤šéº»çƒ¦ã€‚\r\n\r\nå‚è€ƒä¸€äº›å…¶ä»–å·¥å…·æˆ–è„šæ‰‹æ¶é‡Œçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ•ˆæœæ˜¯ï¼šåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å®šä¹‰è¿™äº›å˜é‡ï¼ˆä¾‹å¦‚åœ¨.envæˆ–.env.localæ–‡ä»¶ä¸­ï¼‰\r\n```\r\n$ONE_CDN$=http://cp01-test.XXXX.com\r\n$ONE_TITLE$=æˆ‘çš„ä¸»é¡µ\r\n```\r\nç„¶ååœ¨HTMLä¸­ç›´æ¥ä½¿ç”¨\r\n\r\n```xml\r\n<head>\r\n    <meta charset=\"utf-8\">\r\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\r\n    <title>$ONE_TITLE$â€”â€”è´¡çŒ®åˆ—è¡¨</title>\r\n    <link rel=\"shortcut icon\" href=\"/img/icon.png\" />\r\n\r\n    <script src=\"$ONE_CDN$/vendors/bower_components/jquery/dist/jquery.min.js\"></script>\r\n    <script src=\"$ONE_CDN$/vendors/bower_components/bootstrap/dist/js/bootstrap.min.js\"></script>\r\n    <script src=\"$ONE_CDN$/js/app.min.js\"></script>\r\n    <link href=\"$ONE_CDN$/vendors/bower_components/animate.css/animate.min.css\" rel=\"stylesheet\">\r\n    <link href=\"$ONE_CDN$/vendors/bower_components/bootstrap/dist/js/bootstrap.min.css\" rel=\"stylesheet\">\r\n    â€¦â€¦\r\n</head>\r\n```\r\n\r\nä¸‹é¢ï¼Œå°±è¦éœ€è¦ä¸€ä¸ªæ–¹æ³•èƒ½å¤Ÿè¯»å–å‡º.envå’Œ.env.localæ–‡ä»¶ä¸­çš„æ‰€æœ‰å˜é‡ï¼ˆé»˜è®¤å…ˆä½¿ç”¨.env.localï¼Œå¯ä»¥ç†è§£ä¸º.env.localä¼šè¦†ç›–.envä¸­çš„åŒåå˜é‡ï¼‰\r\n\r\n```javascript\r\n/**\r\n * trim\r\n * @param {string} str å¾…å¤„ç†å­—ç¬¦ä¸²\r\n * @return {string} å¤„ç†åçš„å­—ç¬¦ä¸²\r\n */\r\nconst trim = str => str.replace(/(^\\s*)|(\\s*$)/g, '');\r\n\r\n/**\r\n * è·å–æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡\r\n * @return {Object} ç¯å¢ƒå˜é‡map\r\n */\r\nconst getEnv = () => {\r\n    let prepare = ['.env.local', '.env'];\r\n    let env = {};\r\n\r\n    /**\r\n     * æ£€æŸ¥.envä¸­å˜é‡åæ˜¯å¦åˆæ³•\r\n     * å…¨éƒ¨ä½¿ç”¨å¤§å†™å­—æ¯ï¼Œç”¨_è¿æ¥ï¼Œç¬¬ä¸€ä¸ªå•è¯ä¸ºONEï¼Œé¦–å°¾ä½¿ç”¨$\r\n     * @param {string} key å¾…æ£€æŸ¥çš„å˜é‡å\r\n     * @return {boolean} æ£€æŸ¥ç»“æœï¼Œåˆæ³•trueï¼Œéæ³•false\r\n     */\r\n    function envCheck(key) {\r\n        return /^\\$ONE(_[A-Z]+)+\\$$/.test(key);\r\n    }\r\n\r\n    /**\r\n     * è¯»å–æ–‡ä»¶ä¸­çš„å˜é‡\r\n     * @param {string} filename é…ç½®æ–‡ä»¶\r\n     * @return {Object} é…ç½®å˜é‡\r\n     */\r\n    function readEnvFile(filename) {\r\n        let env = {};\r\n        try {\r\n            let filepath = path.resolve('.', filename);\r\n            if (fs.existsSync(filepath) && fs.statSync(filepath).isFile()) {\r\n                fs.readFileSync(filepath, 'utf-8')\r\n                    .split(/\\r?\\n/)\r\n                    .filter(ele => ele !== '')\r\n                    .forEach(ele => {\r\n                        let pairs = ele.split('=');\r\n                        let key = trim(pairs[0]);\r\n                        let value = trim(pairs[1]);\r\n                        if (envCheck(key)) {\r\n                            env[key] = value;\r\n                        }\r\n                        else {\r\n                            log(red('[env]'), `æ— æ•ˆçš„å˜é‡å: ${key}`, 'tip: å…¨éƒ¨ä½¿ç”¨å¤§å†™å­—æ¯ï¼Œç”¨_è¿æ¥ï¼Œç¬¬ä¸€ä¸ªå•è¯ä¸ºONEï¼Œé¦–å°¾ä½¿ç”¨$');\r\n                        }\r\n                    });\r\n            }\r\n        }\r\n        catch (err) {\r\n            log(red('[env]'), 'è¯»å–envå˜é‡å‡ºé”™', err);\r\n        }\r\n        finally {\r\n            return env;\r\n        }\r\n    }\r\n\r\n    let envArr = [{}];\r\n    // ä¼˜å…ˆå¯»æ‰¾æœ¬åœ°é…ç½®.env.local\r\n    while (prepare.length) {\r\n        // ç”Ÿäº§ç¯å¢ƒä¸‹ä¼˜å…ˆä½¿ç”¨.env\r\n        let filename = gutil.env.env === 'production' ? prepare.shift() : prepare.pop();\r\n        envArr.push(readEnvFile(filename));\r\n    }\r\n\r\n    return Object.assign.apply(null, envArr);\r\n};\r\n```\r\n\r\n`getEnv()`æ–¹æ³•å¯ä»¥è¯»å–æ‰€æœ‰å®šä¹‰çš„ç¯å¢ƒå˜é‡ï¼Œå¹¶ä¿å­˜ä¸ºä¸€ä¸ªé”®å€¼å¯¹å½¢å¼çš„å¯¹è±¡ï¼Œé”®åæ˜¯å˜é‡åï¼Œå€¼åˆ™æ˜¯å˜é‡çš„å€¼\r\n\r\n```javascript\r\n// getEnv()\r\n{\r\n  'ONE_CDN': 'http://cp01-test.XXXX.com',\r\n  'ONE_TITLE': 'æˆ‘çš„ä¸»é¡µ'\r\n}\r\n```\r\n\r\nç”±äºè¦æ›¿æ¢æ–‡ä»¶å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`event-stream`åº“æ¥è¿›è¡Œstreamçš„æ“ä½œã€‚ä½¿ç”¨å…¶ä¸­çš„`.replace()`æ–¹æ³•æ¥æ›¿æ¢æ–‡ä»¶å†…å®¹ï¼Œä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š\r\n\r\n```javascript\r\nconst es = require('event-stream');\r\n\r\nlet pipe = fs.createReadStream(sourceFile);\r\n\r\n// æ·»åŠ ç®¡é“ï¼Œæ›¿æ¢.envä¸­çš„ç¯å¢ƒå˜é‡\r\nfor (let k in envMap) {\r\n  pipe = pipe.pipe(es.replace(k, envMap[k]));\r\n}\r\n```\r\n\r\n#### 4.4.2. ä¿®æ­£æ–‡ä»¶è·¯å¾„\r\nç±»ä¼¼JavaScriptä¸­çš„æ–‡ä»¶è·¯å¾„ä¿®æ­£æ“ä½œï¼Œåœ¨HTMLä¸­åŒæ ·ä½¿ç”¨`gulp-rename`æ¥å®ç°ï¼Œè·¯å¾„ä¿®æ­£éƒ¨åˆ†ä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š\r\n```javascript\r\n// è·¯å¾„æ ¼å¼åŒ–æ­£åˆ™\r\nlet reg = new RegExp(`^${path.relative('.', SRC_HTML_PATH)}`);\r\n\r\nreturn (\r\n  pipe.pipe(source(sourceFile))\r\n    .pipe(dislint())\r\n    .pipe(plugins.rename(p => {\r\n      // æ ¼å¼åŒ–ç›®æ ‡è·¯å¾„\r\n      p.dirname = p.dirname.replace(reg, '');\r\n    }))\r\n    .pipe(gulp.dest(DIST_HTML_PATH))\r\n);\r\n```\r\n\r\n#### 4.2.3. å°è£…ä»»åŠ¡\r\nå°†å˜é‡æ›¿æ¢ä¸æ–‡ä»¶è·¯å¾„ä¿®æ­£ä¸¤éƒ¨åˆ†ä»£ç å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡å‡½æ•°`htmlTask`\r\n\r\n```javascript\r\n/**\r\n * htmlå‘å¸ƒä»»åŠ¡\r\n * @param {string} sourceFile éœ€è¦å‘å¸ƒçš„ç›®æ ‡htmlæ–‡ä»¶\r\n * @return {stream} æ–‡ä»¶æµ\r\n */\r\nconst htmlTask = sourceFile => {\r\n  let pipe = fs.createReadStream(sourceFile);\r\n\r\n  // æ·»åŠ ç®¡é“ï¼Œæ›¿æ¢.envä¸­çš„ç¯å¢ƒå˜é‡\r\n  for (let k in envMap) {\r\n    pipe = pipe.pipe(es.replace(k, envMap[k]));\r\n  }\r\n\r\n  // è·¯å¾„æ ¼å¼åŒ–æ­£åˆ™\r\n  let reg = new RegExp(`^${path.relative('.', SRC_HTML_PATH)}`);\r\n\r\n  return (\r\n    pipe.pipe(source(sourceFile))\r\n      .pipe(dislint())\r\n      .pipe(plugins.rename(p => {\r\n        // æ ¼å¼åŒ–ç›®æ ‡è·¯å¾„\r\n        p.dirname = p.dirname.replace(reg, '');\r\n      }))\r\n      .pipe(gulp.dest(DIST_HTML_PATH))\r\n  );\r\n};\r\n```\r\nåœ¨æ­¤åŸºç¡€ä¸Šï¼Œåˆ›å»ºä¸€ä¸ªgulpä»»åŠ¡ç”¨äºHTMLæ–‡ä»¶çš„å‘å¸ƒ\r\n```javascript\r\n// [å‘å¸ƒ]htmlé¡µé¢\r\ngulp.task('dist:html', () => {\r\n  let files = glob.sync(`${SRC_HTML_PATH}/**/*.html`);\r\n  let streams = files.map(htmlTask);\r\n  return es.merge(streams);\r\n});\r\n```\r\nåŒæ—¶ï¼Œè¿˜éœ€è¦æŠŠå·²æœ‰çš„æ–‡ä»¶åˆ é™¤ï¼Œè¿™é‡Œç”¨åˆ°äº†`del`è¿™ä¸ªåŒ…\r\n```javascript\r\nconst del = require('del');\r\n\r\n// [åˆ é™¤]å‘å¸ƒç›®å½•é¢ä¸‹çš„htmlæ–‡ä»¶\r\ngulp.task('del:html', () => del.sync([`${DIST_HTML_PATH}/*`]));\r\n```\r\n\r\n### 4.3. CSSéƒ¨åˆ†\r\n\r\n![CSSéƒ¨åˆ†å¤„ç†æµç¨‹](http://upload-images.jianshu.io/upload_images/6476654-ff7268e61e149d78.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)\r\n\r\nCSSéƒ¨åˆ†çš„å¤„ç†æµç¨‹ä¸­å¤§éƒ¨åˆ†ä¸ä¹‹å‰çš„æ“ä½œå¤§åŒå°å¼‚ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„åŒºåˆ«æ˜¯åœ¨CSSä¸­ä½¿ç”¨åˆ°`gulp-less`æ’ä»¶ä¸`gulp-minify-css`æ’ä»¶åˆ†åˆ«å¯¹lessæ–‡ä»¶è¿›è¡Œé¢„å¤„ç†ä¸å‹ç¼©\r\n```javascript\r\ngulp.src(`${SRC_CSS_PATH}/**/*.less`) //å¤šä¸ªæ–‡ä»¶ä»¥æ•°ç»„å½¢å¼ä¼ å…¥\r\n  .pipe(less())\r\n  .pipe(minifyCss())\r\n  .pipe(gulp.dest('dist/css')); \r\n```\r\n\r\næœ€ç»ˆCSSéƒ¨åˆ†çš„å¤„ç†ä»»åŠ¡å¦‚ä¸‹ï¼š\r\n```javascript\r\n// [åˆ é™¤]å‘å¸ƒç›®å½•ä¸‹çš„cssæ–‡ä»¶\r\ngulp.task('del:css', () => del.sync([`${DIST_CSS_PATH}/*`]));\r\n\r\n// [å‘å¸ƒ]cssæ–‡ä»¶\r\ngulp.task('dist:css', function () {\r\n  gulp.src(`${SRC_CSS_PATH}/**/*.less`) \r\n    .pipe(plugins.rename({\r\n        dirname: ''\r\n    }))\r\n    .pipe(less())\r\n    .pipe(minifyCss())\r\n    .pipe(gulp.dest('dist/css')); \r\n});\r\n```\r\n\r\n## 4.4. ç»„åˆä¸ç®¡ç†è¿™äº›ä»»åŠ¡\r\næˆ‘ä»¬å®šä¹‰ä¸Šé¢ä¸€ç³»åˆ—çš„ä»»åŠ¡ï¼Œä½†æœ€ç»ˆçš„ç›®æ ‡æ˜¯å°†è¿™äº›ä»»åŠ¡ç»„åˆèµ·æ¥ï¼Œè®©ä»–ä»¬å˜æˆä¸€æ¡æŒ‡ä»¤ï¼ˆæˆ–æŸå‡ æ¡æŒ‡ä»¤ï¼‰ã€‚ä¸ºäº†æ›´å¥½å¾—ç»„ç»‡ä»»åŠ¡ä¾èµ–ï¼Œæ§åˆ¶ä»»åŠ¡æµç¨‹ï¼Œæˆ‘ä»¬ä½¿ç”¨`run-sequence`æ¥æ§åˆ¶è¿™äº›ä»»åŠ¡çš„æ‰§è¡Œã€‚\r\n\r\næœ€å¸¸è§çš„ï¼Œé¦–å…ˆæ˜¯åœ¨å¼€å‘æ—¶ï¼Œå¸Œæœ›è¾“å…¥`gulp`å°±å¯ä»¥è¿›å…¥å¼€å‘æ¨¡å¼ï¼Œèƒ½å¤Ÿç›‘å¬å˜åŒ–å¹¶è‡ªåŠ¨åˆ·æ–°æµè§ˆå™¨ã€‚\r\n\r\n```javascript\r\n// [ç›‘å¬]ä¸ºæ‰€æœ‰å…¥å£æ–‡ä»¶å¯¹åº”çš„browserifyå¯¹è±¡æ·»åŠ updateç›‘å¬\r\ngulp.task('watch:js', () => {\r\n  bundleTasks.forEach(item => {\r\n    addBundleTaskListeners(item);\r\n  });\r\n});\r\n\r\n// [ç›‘å¬]æ›´æ–°CSS\r\ngulp.task('watch:css', () => {\r\n  gulp.watch(['!**/gulpfile.js', 'src/**/*.css'], () => {\r\n    runSequence(\r\n      'del:css',\r\n      'dist:css',\r\n      'reload:browser'\r\n    );\r\n  });\r\n  cb();\r\n});\r\n\r\n// [å¯åŠ¨]browserSync\r\ngulp.task('start:browserSync', () => browserSync.init({\r\n  proxy: '192.168.11.23',\r\n  notify: true\r\n}));\r\n\r\n// åˆ·æ–°æµè§ˆå™¨\r\ngulp.task('reload:browser', cb => {\r\n  browserSync.reload();\r\n  cb();\r\n});\r\n\r\n// [ç›‘å¬]htmlæ–‡ä»¶å˜åŒ–\r\ngulp.task('watch:html', cb => {\r\n  // ç›‘å¬htmlå˜åŒ–ï¼Œå…¨é‡å‘å¸ƒæ–°html\r\n  gulp.watch(['!**/gulpfile.js', 'src/**/*.html'], () => {\r\n    runSequence(\r\n      'del:html',\r\n       'dist:html',\r\n      'reload:browser'\r\n    );\r\n  });\r\n  cb();\r\n});\r\n\r\n// å‘å¸ƒæ¨¡å¼\r\n// buildä»»åŠ¡ï¼Œè¿›è¡Œé¡¹ç›®èµ„æºå‘å¸ƒ\r\ngulp.task('build', cb => {\r\n  runSequence(\r\n    ['del:html', 'del:js'],\r\n    'dist:html',\r\n    'dist:js',\r\n    cb\r\n  );\r\n});\r\n\r\n// å¼€å‘æ¨¡å¼\r\n// æ‰§è¡Œå‘å¸ƒï¼Œå¹¶è¿›è¡Œç›‘å¬\r\ngulp.task('default', cb => {\r\n  runSequence(\r\n    'build',\r\n    'start:browserSync',\r\n    ['watch:js', 'watch:html', 'watch:css'],\r\n    cb\r\n  );\r\n});\r\n```\r\n\r\nå½“ç„¶ï¼Œå¸¸ç”¨çš„è¿˜æœ‰å‘å¸ƒä»»åŠ¡\r\n```javascript\r\n// å‘å¸ƒæ¨¡å¼\r\n// æ„å»ºèµ„æºå‘å¸ƒï¼Œå¹¶é€€å‡ºgulpè¿›ç¨‹\r\ngulp.task('dist', cb => {\r\n  gutil.env.env = gutil.env.env === undefined ? 'production' : gutil.env.env;\r\n  runSequence(\r\n    'build',\r\n    () => {\r\n      cb();\r\n      process.nextTick(process.exit);\r\n    }\r\n  );\r\n});\r\n```\r\n## æ€»ç»“\r\næ–‡ç« é‡Œä¸»è¦æ•´ç†äº†æˆ‘åœ¨é¡¹ç›®ä¸­ç”¨åˆ°çš„ä¸€äº›è§£å†³æ–¹æ¡ˆä¸å®è·µæ–¹æ³•ã€‚å…¶ä¸­ä¹Ÿè¿˜å­˜åœ¨ä¸€äº›ä¸è¶³ï¼Œä¾‹å¦‚HTMLä¸CSSçš„å¢é‡å‘å¸ƒç­‰ï¼Œè¿™äº›éƒ½æ˜¯ä¹‹åå¯ä»¥å†è¿›è¡Œä¼˜åŒ–çš„åœ°æ–¹ã€‚\r\n\r\nå®Œã€‚\r\n\r\n----\r\nHappy Codingï¼\r\n----\r\n----","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/22","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/22/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/22/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/22/events","html_url":"https://github.com/alienzhou/blog/issues/22","id":390659811,"node_id":"MDU6SXNzdWUzOTA2NTk4MTE=","number":22,"title":"å¹´ç»ˆå›é¡¾ï¼Œä¸ºä½ æ±‡æ€»ä¸€ä»½ã€Œå‰ç«¯æŠ€æœ¯æ¸…å•ã€","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845016,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%BB%BC%E5%90%88","name":"ç»¼åˆ","color":"a2eeef","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T12:36:39Z","updated_at":"2018-12-13T12:36:39Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> 2018 çœ¼çœ‹å°±è¦è¿‡å»äº†ï¼Œä»Šå¹´çš„ä½ ç›¸è¾ƒå»å¹´æŠ€æœ¯ä¸Šæœ‰æ€æ ·çš„æ”¶è·å‘¢ï¼Ÿ\r\n\r\nè®°å¾—å¹´åˆçš„æ—¶å€™æˆ‘ç»™è‡ªå·±åˆ¶å®šäº†ä¸€ä¸ªå­¦ä¹ è®¡åˆ’ï¼Œç°åœ¨å›é¡¾æ¥çœ‹å®Œæˆåº¦è¿˜ä¸é”™ã€‚ä½†ä»æœ‰äº›é—æ†¾ï¼Œä¸€äº›æŠ€æœ¯ç‚¹æ²¡æœ‰æ—¶é—´å»å¥½å¥½å­¦ä¹ ã€‚\r\n\r\nåœ¨å­¦ä¹ ä¸­æˆ‘å‘ç°ï¼Œåƒæ–‡ç« è¿™æ ·çš„çŸ¥è¯†å¾€å¾€æ˜¯ç¢ç‰‡åŒ–çš„ï¼Œè€Œå‰ç«¯æ¶‰åŠåˆ°çš„é¢å¾ˆå¤šï¼Œå¦‚æœä¸å°†è¿™äº›çŸ¥è¯†æœ‰æ•ˆæ¢³ç†ï¼Œåˆ™æ— æ³•å½¢æˆä½“ç³»ã€ç›¸äº’ä¸²è”ã€‚æœ€åæœ‰ä¸€ç§ä¸œæ‡‚ä¸€å—ï¼Œè¥¿äº†è§£ä¸€ç‚¹çš„æ„Ÿè§‰ã€‚å› æ­¤ï¼Œæˆ‘ç»“åˆå·¥ä½œä½“ä¼šæŠ½è±¡å‡ºäº†ä¸€äº›å‰ç«¯åŸºç¡€æŠ€æœ¯èƒ½åŠ›ï¼Œå¹¶å°†è¿™æ®µæ—¶é—´å­¦ä¹ æˆ–äº§å‡ºçš„ä¸€äº›ä¸é”™çš„å†…å®¹æ ¹æ®è¿™äº›èƒ½åŠ›è¿›è¡Œæ•´ç†ï¼Œå½¢æˆäº†ä¸€ä»½å‰ç«¯æŠ€æœ¯æ¸…å•ï¼ˆ[github åœ°å€](https://github.com/alienzhou/frontend-tech-list)ï¼‰ã€‚\r\n\r\nä¸è®ºä½ æ˜¯æ­£åœ¨è‡ªå­¦å‰ç«¯é‡åˆ°äº†ç“¶é¢ˆï¼Œè¿˜æ˜¯å¯¹æŸäº›æŠ€æœ¯ç†Ÿç»ƒæŒæ¡ä½†æŸäº›è¿˜æœªæ¶‰è¶³ï¼Œéƒ½å¸Œæœ›è¿™ä»½æ¸…å•èƒ½å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚\r\n\r\n> ç”±äºä¸ªäººç²¾åŠ›æœ‰é™ï¼Œä¸€äº›æŠ€æœ¯ç‚¹çš„å½’çº³å¯èƒ½æœ‰å¤±åé¢‡ï¼Œæˆ–è€…ç›®å‰å¹¶æœªçº³å…¥è¿›æ¥ï¼Œå› æ­¤ [github ä¸Šçš„æ¸…å•å†…å®¹](https://github.com/alienzhou/frontend-tech-list) ä¹Ÿä¼šä¸æ–­æ›´æ–°ã€‚ç›®å‰åªåŒ…å«çº¯å‰ç«¯åŸºç¡€å†…å®¹ï¼ŒNodeJS ã€å®¢æˆ·ç«¯æ³›å‰ç«¯ã€å°ç¨‹åºã€å¯è§†åŒ–ç­‰å†…å®¹å…ˆç•™ç€å‘å§ã€‚\r\n\r\næ¸…å•å†…å®¹â†“â†“â†“\r\n\r\n## 0. å¹´åº¦æŠ¥å‘Š\r\n\r\n- [2018 å‰ç«¯å·¥å…·è°ƒæŸ¥æŠ¥å‘Š](https://ashleynolan.co.uk/blog/frontend-tooling-survey-2018-results)\r\n- [2018 JavaScript è°ƒæŸ¥æŠ¥å‘Š](https://2018.stateofjs.com/)\r\n\r\n## 1. åŸºç¡€æ‹¾é—\r\n\r\n> æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œä¸çŸ¥åˆ™ä¹ ä¹‹ï¼Œæ˜¯ä»¥ç‰¢å›ºæ ¹åŸºã€‚\r\n\r\n### 1.1. JavaScript\r\n\r\n- [You-Dont-Know-JS \\[è‹±\\]](https://github.com/getify/You-Dont-Know-JS)\r\n- JavaScript åŸºç¡€è¿è¡Œæœºåˆ¶ï¼š\r\n    - [JS å¼•æ“ã€è¿è¡Œæ—¶ä¸è°ƒç”¨æ ˆæ¦‚è¿° \\[è‹±\\]](https://blog.sessionstack.com/how-does-javascript-actually-work-part-1-b0bacc073cf)\r\n    - [V8 å¼•æ“ç®€ä»‹ \\[è‹±\\]](https://blog.sessionstack.com/how-javascript-works-inside-the-v8-engine-5-tips-on-how-to-write-optimized-code-ac089e62b12e)\r\n    - [å†…å­˜ç®¡ç†ä¸4ä¸­å¸¸è§çš„æ³„æ¼ \\[è‹±\\]](https://blog.sessionstack.com/how-javascript-works-memory-management-how-to-handle-4-common-memory-leaks-3f28b94cfbec)\r\n- Event Loopï¼ˆé¢è¯•é‡Œæ€»ä¼šæœ‰ä¸€é¢˜ Event Loopâ€¦ï¼‰ï¼š\r\n    - [ä» Event Loop è§„èŒƒæ¢ç©¶ JavaScript å¼‚æ­¥åŠæµè§ˆå™¨æ›´æ–°æ¸²æŸ“æ—¶æœº](https://github.com/aooy/blog/issues/5)\r\n    - [å¼‚æ­¥ä¹‹ Event Loop \\[è‹±\\]](https://blog.sessionstack.com/how-javascript-works-event-loop-and-the-rise-of-async-programming-5-ways-to-better-coding-with-2f077c4438b5)\r\n    - [NodeJS ä¸­çš„ Event Loopã€Timers ä¸ `process.nextTick()` \\[è‹±\\]](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)\r\n    - [Tasksã€Microtasksã€Queues ä¸Schedules \\[è‹±\\]](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)\r\n- [Web Workers åŠå…¶5ä¸ªå¸¸è§ä½¿ç”¨åœºæ™¯ \\[è‹±\\]](https://blog.sessionstack.com/how-javascript-works-the-building-blocks-of-web-workers-5-cases-when-you-should-use-them-a547c0757f6a)\r\n- [å¦‚ä½•é¿å… async/await åœ°ç‹± \\[è‹±\\]](https://medium.freecodecamp.org/avoiding-the-async-await-hell-c77a0fb71c4c)\r\n- [â€œå›è°ƒåœ°ç‹±â€çš„è§£å†³æ€è·¯æ±‡æ€»](https://www.jianshu.com/p/bc7b8d542dcd)\r\n\r\n### 1.2. CSS\r\n\r\n- [You-Need-to-Know-CSS](https://lhammer.cn/You-need-to-know-css/#/)\r\n- [CSSå¸ƒå±€æŒ‡å—](https://juejin.im/post/5b3b56a1e51d4519646204bb)\r\n- [CSS ä¸­çš„å„ç±»æ¢è¡Œå¤„ç†æ–¹å¼ \\[è‹±\\]](https://css-tricks.com/where-lines-break-is-complicated-heres-all-the-related-css-and-html/)ï¼šå¤„ç†ç»å…¸çš„æ¢è¡Œé—®é¢˜\r\n- [æµè§ˆå™¨å°†remè½¬æˆpxæ—¶æœ‰ç²¾åº¦è¯¯å·®æ€ä¹ˆåŠï¼Ÿ](https://www.zhihu.com/question/264372456)\r\n- [ç²¾å‡†æ“æ§çš„æ»šåŠ¨ä½“éªŒï¼Œæµ…è°ˆæ–°æ ‡å‡† Scroll Snap](https://juejin.im/post/5ba079e86fb9a05d1227fddb)\r\n- [å¦‚ä½•å®Œç¾å®ç°ä¸€ä¸ªé`button`å…ƒç´ çš„æŒ‰é’® \\[è‹±\\]](https://www.scottohara.me/blog/2018/10/03/unbutton-buttons.html)\r\n- [å·§ç”¨ CSS Grid æ¥åˆ›å»ºæ¨ªå‘æ»šåŠ¨å®¹å™¨ \\[è‹±\\]](https://uxdesign.cc/creating-horizontal-scrolling-containers-the-right-way-css-grid-c256f64fc585)\r\n- [å¦‚ä½•å¤„ç†å†…è”å…ƒç´ ä¸­çš„ç©ºéš™ \\[è‹±\\]](https://css-tricks.com/fighting-the-space-between-inline-block-elements/)\r\n- [CSS Stacking Context é‡Œé‚£äº›é²œä¸ºäººçŸ¥çš„å‘](https://segmentfault.com/a/1190000002783265)\r\n\r\n### 1.3. æµè§ˆå™¨\r\n\r\n- [æµè§ˆå™¨çš„å·¥ä½œåŸç†](https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/)\r\n- ç°ä»£æµè§ˆå™¨å†…éƒ¨æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼š\r\n    - [Chromeæµè§ˆå™¨æ¦‚è§ˆ](https://developers.google.com/web/updates/2018/09/inside-browser-part1)\r\n    - [æµè§ˆæ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ](https://developers.google.com/web/updates/2018/09/inside-browser-part2)\r\n    - [æ¸²æŸ“è¿›ç¨‹çš„å†…éƒ¨å·¥ä½œåŸç†](https://developers.google.com/web/updates/2018/09/inside-browser-part3)\r\n    - [compositoræ˜¯å¦‚ä½•æ¥æé«˜äº¤äº’æ€§èƒ½çš„ï¼Ÿ](https://developers.google.com/web/updates/2018/09/inside-browser-part4)\r\n- [å®Œæ•´çš„é¡µé¢ç”Ÿå‘½å‘¨æœŸ API ä»‹ç» \\[è‹±\\]](https://developers.google.com/web/updates/2018/07/page-lifecycle-api)\r\n- [å››ä¸ªæ–°çš„è§‚å¯Ÿè€…ï¼šIntersection / Mutation / Resize / Performance (Observer)](https://www.zeolearn.com/magazine/different-types-of-observers-supported-by-modern-browsers)\r\n- [æ¸²æŸ“å¼•æ“å·¥ä½œæ–¹å¼åŠä¼˜åŒ–å»ºè®® \\[è‹±\\]](https://blog.sessionstack.com/how-javascript-works-the-rendering-engine-and-tips-to-optimize-its-performance-7b95553baeda)\r\n- [æµè§ˆå™¨å†…æ ¸æ¸²æŸ“ï¼šé‡å»ºå¼•æ“](https://juejin.im/post/5bbaa7da6fb9a05d3761aafe)\r\n- [è·¨åŸŸè§£å†³æ–¹æ¡ˆæ±‡æ€»](https://www.jianshu.com/p/438183ddcea8)\r\n\r\n## 2. å·¥ç¨‹åŒ–ä¸å·¥å…·\r\n\r\n> è½¯ä»¶è§„æ¨¡çš„æ‰©å¤§å¸¦æ¥äº†å·¥ç¨‹åŒ–çš„éœ€æ±‚ï¼Œå‰ç«¯ä¹Ÿä¸ä¾‹å¤–ã€‚éšç€ NodeJS çš„å‡ºç°ï¼Œå‰ç«¯å·¥ç¨‹å¸ˆå¯ä»¥ä½¿ç”¨ç†Ÿæ‚‰çš„ JS å¿«é€Ÿå¼€å‘æ‰€éœ€çš„å·¥å…·ã€‚å·¥å…·é“¾ç”Ÿæ€çš„ç¹è£ä¹Ÿæ˜¯å‰ç«¯åœˆç¹è£çš„ä¸€ä¸ªå†™ç…§ã€‚\r\n\r\n### 2.1. webpack\r\n\r\n- [webpack ä¸­çš„ Chunk å…³ç³»å›¾ç®—æ³• \\[è‹±\\]](https://medium.com/webpack/the-chunk-graph-algorithm-week-26-29-7c88aa5e4b4e)\r\n- [webpack è¿›é˜¶ç³»åˆ—æ–‡ç« ](https://juejin.im/post/5bc1a73df265da0a8d36b74f#heading-13)\r\n- ç¼–è¯‘ä¼˜åŒ–ï¼š\r\n    - [å¦‚ä½•æå‡å¤§å‹é¡¹ç›®ä¸­ webpack çš„æ€§èƒ½ ğŸ¥ \\[è‹±\\]](https://www.youtube.com/watch?v=AifDI71uqF0)\r\n    - [è¿è¡Œæ—¶ä¼˜åŒ–ï¼šSeparating a Manifest \\[è‹±\\]](https://survivejs.com/webpack/optimizing/separating-manifest)\r\n    - [åœ¨ webpack ä¸­ä½¿ç”¨ \\<link rel=â€prefetch/preloadâ€> \\[è‹±\\]](https://medium.com/webpack/link-rel-prefetch-preload-in-webpack-51a52358f84c)\r\n    - [å¦‚ä½•æ›´å¥½ä½¿ç”¨ webpack tree-shaking](https://juejin.im/post/5b8ce49df265da438151b468)\r\n- å…³äº webpack ç¼–è¯‘ç¼“å­˜çš„è®¨è®ºï¼š\r\n    - [mzgoddard's comment](https://github.com/webpack/webpack/issues/250#issuecomment-240643985)\r\n    - [\\[spec: webpack 5\\] - A module disk cache between build processes](https://github.com/webpack/webpack/issues/6527)\r\n\r\n### 2.2. Gulp\r\n\r\n- [Gulp 4 ç®€ä»‹ \\[è‹±\\]](https://fettblog.eu/gulp-4-parallel-and-series/)\r\n- [åŸºäºGulpçš„å¤šé¡µé¢åº”ç”¨å®è·µæŒ‡å—](https://www.jianshu.com/p/35571124770f)\r\n\r\n### 2.3. Linter\r\n\r\n- [JS Linter è¿›åŒ–å²](https://zhuanlan.zhihu.com/p/34656263)\r\n- [ä¸ºä½•è¦åœ¨é¡¹ç›®æ±‡æ€»ä½¿ç”¨ ESLint \\[è‹±\\]](https://medium.com/the-node-js-collection/why-and-how-to-use-eslint-in-your-project-742d0bc61ed7)\r\n\r\n### 2.4. é™æ€ç±»å‹ï¼ˆTypescript/Flowï¼‰\r\n\r\n- [Typescript æ€»ä½“æ¶æ„ \\[è‹±\\]](https://github.com/Microsoft/TypeScript/wiki/Architectural-Overview)\r\n- ä¸ºä»€ä¹ˆè¦åœ¨ JavaScript ä¸­è¿›è¡Œé™æ€ç±»å‹æ£€æŸ¥ï¼š\r\n    - [ç¬¬ä¸€éƒ¨åˆ†](https://www.jianshu.com/p/bda750e2d15e)\r\n    - [ç¬¬äºŒã€ä¸‰éƒ¨åˆ†](https://www.jianshu.com/p/289b3c734a9f)\r\n    - [ç¬¬å››éƒ¨åˆ†](https://www.jianshu.com/p/d23f93be8821)\r\n\r\n### 2.5. Babel\r\n\r\n- [Babel ç”¨æˆ·æ‰‹å†Œ](https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/user-handbook.md)\r\n- [Babel æ’ä»¶æ‰‹å†Œ](https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md)\r\n\r\n### 2.6. CSSé¢„å¤„ç†ä¸æ¨¡å—åŒ–\r\n\r\n- [CSS è¿›åŒ–å² \\[è‹±\\]](https://medium.com/@perezpriego7/css-evolution-from-css-sass-bem-css-modules-to-styled-components-d4c1da3a659b)\r\n- [CSS æ¨¡å—åŒ–æ–¹æ¡ˆç³»åˆ—](https://juejin.im/post/5b20e8e0e51d4506c60e47f5)\r\n\r\n## 3. æ€§èƒ½ä¼˜åŒ–\r\n\r\n> æ€§èƒ½ä¼˜åŒ–å…¶å®å°±æ˜¯åœ¨ç†è§£æµè§ˆå™¨çš„åŸºç¡€ä¸Šâ€œå› åœ°åˆ¶å®œâ€ï¼Œå› æ­¤å¯ä»¥é…åˆ1.3èŠ‚â€œæµè§ˆå™¨â€éƒ¨åˆ†è¿›è¡Œç†è§£ã€‚\r\n\r\nå¼ºçƒˆæ¨èæŠŠ [Google Web ä¸Šæ€§èƒ½ä¼˜åŒ–](https://developers.google.com/web/fundamentals/performance/why-performance-matters/) Tab ä¸­çš„æ–‡ç« éƒ½é€šè¯»ä¸€éï¼Œå…¶åŸºæœ¬æ¶µç›–äº†ç°ä»£æµè§ˆå™¨ä¸­æ€§èƒ½ä¼˜åŒ–çš„æ‰€æœ‰ç‚¹ï¼Œéå¸¸ç³»ç»Ÿã€‚ä¸‹é¢ä¹Ÿæ‘˜å½•äº†å…¶ä¸­ä¸€äº›ä¸ªäººè®¤ä¸ºéå¸¸ä¸é”™çš„ç¯‡å¹…ã€‚\r\n\r\n### 3.1. åŠ è½½æ€§èƒ½\r\n\r\n- [PRPL æ¨¡å¼ \\[è‹±\\]](https://developers.google.com/web/fundamentals/performance/prpl-pattern/)\r\n- [å›¾ç‰‡æ‡’åŠ è½½å®Œå…¨æŒ‡å— \\[è‹±\\]](https://css-tricks.com/the-complete-guide-to-lazy-loading-images)\r\n- [ä½¿ç”¨ Intersection Observer æ¥æ‡’åŠ è½½å›¾ç‰‡ \\[è‹±\\]](http://deanhume.com/lazy-loading-images-using-intersection-observer/)\r\n- [å›¾ç‰‡ä¸è§†é¢‘æ‡’åŠ è½½çš„è¯¦ç»†æŒ‡å— \\[è‹±\\]](https://developers.google.com/web/fundamentals/performance/lazy-loading-guidance/images-and-video/)\r\n- [ä½¿ç”¨ Application Shell æ¶æ„æ¥å®ç°ç§’å¼€åº”ç”¨ \\[è‹±\\]](https://developers.google.com/web/updates/2015/11/app-shell)\r\n\r\n### 3.2. è¿è¡Œæ—¶æ€§èƒ½\r\n\r\n- [é¿å…å¤§å‹ã€å¤æ‚çš„å¸ƒå±€å’Œå¸ƒå±€æŠ–åŠ¨ \\[è‹±\\]](https://developers.google.com/web/fundamentals/performance/rendering/avoid-large-complex-layouts-and-layout-thrashing?hl=zh-cn#avoid-forced-synchronous-layouts)\r\n- [ä»€ä¹ˆå¯¼è‡´å¼ºåˆ¶åŒæ­¥å¸ƒå±€ï¼ˆreflowï¼‰ï¼Ÿ \\[è‹±\\]](https://gist.github.com/paulirish/5d52fb081b3570c81e3a)\r\n- [å¦‚ä½•è¯Šæ–­å¼ºåˆ¶åŒæ­¥å¸ƒå±€ \\[è‹±\\]](https://developers.google.com/web/tools/chrome-devtools/rendering-tools/forced-synchronous-layouts?hl=zh-cn)\r\n- [æ— çº¿æ€§èƒ½ä¼˜åŒ–ï¼šComposite](http://taobaofed.org/blog/2016/04/25/performance-composite/)\r\n- [å¦‚ä½•ä¸æ‹©æ‰‹æ®µæå‡scrolläº‹ä»¶çš„æ€§èƒ½](https://zhuanlan.zhihu.com/p/30078937)\r\n- [ä½¿ç”¨ passive event listener æ¥æé«˜æ»šåŠ¨æµç•…æ€§ \\[è‹±\\]](https://github.com/WICG/EventListenerOptions/blob/gh-pages/explainer.md)\r\n- èŠ‚æµå’Œå»æŠ–ï¼ˆthrottle & debounceï¼‰ï¼š\r\n    - [JavaScript å‡½æ•°èŠ‚æµå’Œå‡½æ•°å»æŠ–åº”ç”¨åœºæ™¯è¾¨æ](https://github.com/hanzichi/underscore-analysis/issues/20)\r\n    - [underscore å‡½æ•°å»æŠ–çš„å®ç°](https://github.com/hanzichi/underscore-analysis/issues/21)\r\n- requestIdleCallback - ä¸€ä¸ªå¼ºå¤§è€Œç¥å™¨çš„ APIï¼š\r\n    - [requestIdleCallbackä½¿ç”¨å…¥é—¨ \\[è‹±\\]](https://developers.google.com/web/updates/2015/08/using-requestidlecallback)\r\n    - [Idle Until Urgent \\[è‹±\\]](https://philipwalton.com/articles/idle-until-urgent)ï¼šrequestIdleCallbackçš„å¦™ç”¨\r\n\r\n### 3.3. å‰ç«¯ç¼“å­˜\r\n\r\n- [Web ç¼“å­˜ç®€ä»‹ï¼šä»¥è´­ä¹°ç‰›å¥¶çš„ä¸ºä¾‹ \\[è‹±\\]](https://dev.to/kbk0125/web-caching-explained-by-buying-milk-at-the-supermarket-9k4)\r\n- [å¤§è¯å‰ç«¯ç¼“å­˜ \\[è‹±\\]](https://calendar.perfplanet.com/2016/a-tale-of-four-caches/)\r\n- [ç¼“å­˜ï¼ˆä¸€ï¼‰â€”â€” ç¼“å­˜æ€»è§ˆï¼šä»æ€§èƒ½ä¼˜åŒ–çš„è§’åº¦çœ‹ç¼“å­˜](https://github.com/amandakelake/blog/issues/43)\r\n- [ç¼“å­˜ï¼ˆäºŒï¼‰â€”â€” æµè§ˆå™¨ç¼“å­˜æœºåˆ¶ï¼šå¼ºç¼“å­˜ã€åå•†ç¼“å­˜](https://github.com/amandakelake/blog/issues/41)\r\n- [ç¼“å­˜ï¼ˆä¸‰ï¼‰â€”â€” æ•°æ®å­˜å‚¨ï¼šcookieã€Storageã€indexedDB](https://github.com/amandakelake/blog/issues/13)\r\n\r\n### 3.4. æ€§èƒ½è°ƒè¯•ä¸å®è·µ\r\n\r\n- [ä½¿ç”¨ Chrome DevTools æå‡é¡µé¢é€Ÿåº¦ \\[è‹±\\]](https://developers.google.com/web/tools/chrome-devtools/speed/get-started)ï¼šChrome DevToolså®æ“è®²è§£\r\n- [äº†è§£ DevTools ä¸­çš„ Resource Timing](https://developers.google.com/web/tools/chrome-devtools/network-performance/understanding-resource-timing)\r\n- [æ·˜å®æ–°åŠ¿åŠ›å‘¨H5æ€§èƒ½ä¼˜åŒ–å®æˆ˜](https://segmentfault.com/a/1190000014359615)\r\n- [ä¼˜åŒ–æ‰“åŒ…ç­–ç•¥æ¥æå‡é¡µé¢åŠ è½½é€Ÿåº¦](https://juejin.im/post/5aed037b6fb9a07aa047e1e1)\r\n- [Chrome DevTools ä¸­ä½ å¯èƒ½ä¸çŸ¥é“çš„è°ƒè¯•æŠ€å·§](https://zhuanlan.zhihu.com/p/42059158)\r\n- [å‰ç«¯æ€§èƒ½æµ‹é‡ \\[è‹±\\]](https://speedcurve.com/blog/user-timing-and-custom-metrics/)\r\n\r\n### 3.5. æ€§èƒ½æŒ‡æ ‡\r\n\r\n- [ä»¥ç”¨æˆ·ä¸ºä¸­å¿ƒçš„å‰ç«¯æ€§èƒ½æŒ‡æ ‡ \\[è‹±\\]](https://developers.google.com/web/fundamentals/performance/user-centric-performance-metrics)ï¼šå‰ç«¯æ€§èƒ½æŒ‡æ ‡çš„æ¥é¾™å»è„‰\r\n- DOMContentLoaded:\r\n    - [ä½ ä¸çŸ¥é“çš„ DOMContentLoaded](https://zhuanlan.zhihu.com/p/25876048)\r\n    - [Deciphering the Critical Rendering Path \\[è‹±\\]](https://calendar.perfplanet.com/2012/deciphering-the-critical-rendering-path/)\r\n- FP (First Paint)ï¼š\r\n    - [Chromeçš„First Paint](http://eux.baidu.com/blog/fe/Chrome%E7%9A%84First%20Paint)\r\n- FCP (First Contentful Paint)ï¼š\r\n    - [First Contentful Paint Explained \\[è‹±\\]](https://gtmetrix.com/blog/first-contentful-paint-explained/)\r\n    - [First Contentful Paint \\[è‹±\\]](https://developers.google.com/web/tools/lighthouse/audits/first-contentful-paint)\r\n- FMP (First Meaningful Paint)ï¼š\r\n    - [Chrome ä¸­çš„ First Meaningful Paint](https://juejin.im/entry/598080226fb9a03c5d535cd5)\r\n    - [Time to First Meaningful Paint](https://docs.google.com/document/d/1BR94tJdZLsin5poeet0XoTW60M0SjvOJQttKT-JK8HI/view?hl=zh-cn#heading=h.k50nnyhtptq0)\r\n- TTI (Time to interactive)ï¼š\r\n    - [Time to Interactive Explainer](https://github.com/WICG/time-to-interactive)\r\n    - [è¡¡é‡ç”¨æˆ·ä½“éªŒçš„æ–°æ ‡å‡†](https://calendar.perfplanet.com/2017/time-to-interactive-measuring-more-of-the-user-experience/)\r\n- TTFB (Time To First Byte)ï¼š\r\n    - [TTFBï¼Œä»¥åŠé¡µé¢åŠ è½½çš„æ—¶é—´èŠ‚ç‚¹](https://zhuanlan.zhihu.com/p/23588780)\r\n- FID (First Input Delay)ï¼š\r\n    - [First Input Delay](https://developers.google.com/web/updates/2018/05/first-input-delay)\r\n- Speed Indexï¼š\r\n    - [WebPagetest: Speed Index](https://sites.google.com/a/webpagetest.org/docs/using-webpagetest/metrics/speed-index)\r\n\r\n## 4. å®‰å…¨\r\n\r\n> å¾ˆå¤šå®‰å…¨é£é™©è€ç”Ÿå¸¸è°ˆï¼Œä½†æ˜¯å¾€å¾€åˆ°å‡ºç°é—®é¢˜æ—¶ï¼Œæ‰ä¼šè¢«é‡è§†æˆ–è€…æ„è¯†åˆ°ã€‚\r\n\r\n- [8å¤§å‰ç«¯å®‰å…¨é—®é¢˜ä¸Šç¯‡](https://insights.thoughtworks.cn/eight-security-problems-in-front-end/)\r\n- [8å¤§å‰ç«¯å®‰å…¨é—®é¢˜ä¸‹ç¯‡](http://insights.thoughtworks.cn/eight-security-problems-in-front-end-2/)\r\n- [æ¦‚å¿µè®²è§£ï¼šç¼–ç ã€åŠ å¯†ã€å“ˆå¸Œä¸æ··æ·† \\[è‹±\\]](https://danielmiessler.com/study/encoding-encryption-hashing-obfuscation)\r\n- [å¸¸è§ Web å®‰å…¨æ”»é˜²æ€»ç»“](https://zoumiaojiang.com/article/common-web-security/)\r\n\r\n### 4.1. XSS\r\n\r\n- [å¦‚ä½•é˜²æ­¢XSSæ”»å‡»ï¼Ÿ](https://tech.meituan.com/fe_security.html)\r\n\r\n### 4.2. CSRF\r\n\r\n- [å¦‚ä½•é˜²æ­¢CSRFæ”»å‡»ï¼Ÿ](https://juejin.im/post/5bc009996fb9a05d0a055192)\r\n- [Site Isolation \\[è‹±\\]](https://developers.google.com/web/updates/2018/07/site-isolation)ï¼šChromeçš„æ–°ç‰¹æ€§\r\n\r\n### 4.3. CSP\r\n\r\n- [Content Security Policy å…¥é—¨æ•™ç¨‹](http://www.ruanyifeng.com/blog/2016/09/csp.html)\r\n- [Content Security Policy (CSP) \\[è‹±\\]](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)\r\n\r\n### 4.4. HTTPS\r\n\r\n- [å›¾æ–‡è¿˜åŸ HTTPS åŸç†](https://mp.weixin.qq.com/s/3NKOCOeIUF2SGJnY7II9hA)\r\n- [æµ…è°ˆæœ‰èµå…¨ç«™ HTTPS æ¨è¿›](https://segmentfault.com/a/1190000013635363)\r\n\r\n### 4.5. å®‰å…¨å®å½•\r\n\r\n- [About `rel=noopener` \\[è‹±\\]](https://mathiasbynens.github.io/rel-noopener/)ï¼šæ‰“å¼€ä¸€ä¸ªæ–°é¡µé¢æ˜¯å¦‚ä½•å¸¦æ¥å®‰å…¨éšæ‚£çš„\r\n- [ä¸€ç§æ–°å‹çš„â€œé’“é±¼â€æ–¹å¼ \\[è‹±\\]](http://www.azarask.in/blog/post/a-new-type-of-phishing-attack/)\r\n- [ä¸€ä¸ªåª’ä½“æ–‡ä»¶è¯·æ±‚å¼•å‘çš„è·¨ç«™é£é™© \\[è‹±\\]](https://jakearchibald.com/2018/i-discovered-a-browser-bug)\r\n- [Mitigating Spectre \\[è‹±\\]](https://security.googleblog.com/2018/07/mitigating-spectre-with-site-isolation.html)ï¼š Chrome ä¸­çš„è·¨ç«™å®‰å…¨é—®é¢˜\r\n\r\n## 5. è‡ªåŠ¨åŒ–æµ‹è¯•\r\n\r\n> è‡ªåŠ¨åŒ–æµ‹è¯•æ˜¯è½¯ä»¶å·¥ç¨‹çš„é‡è¦éƒ¨åˆ†ä¹‹ä¸€ï¼Œä½†å´æå®¹æ˜“è¢«å¿½è§†ã€‚\r\n\r\n- [2018 å‰ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•ç»¼è¿° \\[è‹±\\]](https://medium.com/welldone-software/an-overview-of-javascript-testing-in-2018-f68950900bc3)\r\n- [æµ‹è¯•ä½ çš„å‰ç«¯ä»£ç ï¼ˆä»‹ç»ç¯‡ï¼‰\\[è‹±\\]](https://hackernoon.com/testing-your-frontend-code-part-i-introduction-7e307eac4446)\r\n\r\n### 5.1. å•å…ƒæµ‹è¯•\r\n\r\n- [æµ‹è¯•ä½ çš„å‰ç«¯ä»£ç ï¼ˆå•å…ƒæµ‹è¯•ç¯‡ï¼‰\\[è‹±\\]](https://hackernoon.com/testing-your-frontend-code-part-ii-unit-testing-1d05f8d50859)\r\n- [Fakesã€Mocks ä»¥åŠ Stubs æ¦‚å¿µæ˜æ™°](https://zhuanlan.zhihu.com/p/26942686)\r\n- [æµ‹è¯•è¦†ç›–ï¼ˆç‡ï¼‰åˆ°åº•æœ‰ä»€ä¹ˆç”¨ï¼Ÿ](http://www.infoq.com/cn/articles/test-coverage-rate-role)\r\n\r\n### 5.2. ç«¯åˆ°ç«¯æµ‹è¯• (E2E)\r\n\r\n- [æµ‹è¯•ä½ çš„å‰ç«¯ä»£ç ï¼ˆE2E æµ‹è¯•ç¯‡ï¼‰\\[è‹±\\]](https://hackernoon.com/testing-your-frontend-code-part-iii-e2e-testing-e9261b56475)\r\n- [ä»€ä¹ˆæ˜¯ä¸€ä¸ªå¥½çš„ E2E æµ‹è¯•ï¼Ÿ\\[è‹±\\]](https://testing.googleblog.com/2016/09/testing-on-toilet-what-makes-good-end.html)\r\n- [å¹³è¡¡å•å…ƒæµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•](http://www.infoq.com/cn/articles/balancing-unit-and-end-to-end-tests)\r\n- [å¯¹è¿‡å¤šçš„ E2E æµ‹è¯•è¯´â€œä¸â€ \\[è‹±\\]](https://testing.googleblog.com/2015/04/just-say-no-to-more-end-to-end-tests.html)\r\n\r\n### 5.3. å…¶ä»–\r\n\r\n- [æµ‹è¯•ä½ çš„å‰ç«¯ä»£ç ï¼ˆé›†æˆæµ‹è¯•ç¯‡ï¼‰\\[è‹±\\]](https://hackernoon.com/testing-your-frontend-code-part-iv-integration-testing-f1f4609dc4d9)\r\n- [æµ‹è¯•ä½ çš„å‰ç«¯ä»£ç ï¼ˆå¯è§†åŒ–æµ‹è¯•ç¯‡ï¼‰\\[è‹±\\]](https://medium.com/@giltayar/testing-your-frontend-code-part-v-visual-testing-935864cfb5c7)\r\n\r\n## 6. æ¡†æ¶ä¸ç±»åº“\r\n\r\n> å¦‚æœè¯´åŸºç¡€çŸ¥è¯†æ˜¯é“ï¼Œé‚£æ¡†æ¶ä¸å·¥å…·å¯èƒ½å°±æ˜¯æœ¯ï¼›å­¦ä¹ ä¸ç†è§£å®ƒä»¬ï¼Œä½†åƒä¸‡ä¸è¦æˆä¸ºå®ƒä»¬çš„å¥´éš¶ã€‚\r\n\r\n### 6.1. React\r\n\r\n- [React åº•å±‚æ­ç§˜ \\[è‹±\\]](https://bogdan-lyashenko.github.io/Under-the-hood-ReactJS/)\r\n- [ä½ æ‰€éœ€è¦çŸ¥é“çš„ React ç»†èŠ‚](https://github.com/hateonion/react-bits-CN)\r\n- [React Fiber æ¶æ„](https://zhuanlan.zhihu.com/p/37095662)\r\n- [React 16 Fiber æºç é€Ÿè§ˆ](http://zxc0328.github.io/2017/09/28/react-16-source/)\r\n- [React æ˜¯æ€æ ·ç‚¼æˆçš„](https://segmentfault.com/a/1190000013365426)ï¼šReactæ—©æœŸçš„è¿›åŒ–ä¹‹è·¯\r\n- ä»é›¶å¼€å§‹å®ç°ä¸€ä¸ªReactï¼š\r\n    - [1. JSXå’Œè™šæ‹ŸDOM](https://github.com/hujiulong/blog/issues/4)\r\n    - [2. ç»„ä»¶å’Œç”Ÿå‘½å‘¨æœŸ](https://github.com/hujiulong/blog/issues/5)\r\n    - [3. diffç®—æ³•](https://github.com/hujiulong/blog/issues/6)\r\n    - [4. å¼‚æ­¥çš„setState](https://github.com/hujiulong/blog/issues/7)\r\n- [ã€ŒreactæŠ€æœ¯æ ˆã€å•é¡µåº”ç”¨å®è·µå¿«é€Ÿå…¥é—¨](https://www.jianshu.com/p/0b2acb50f321)\r\n\r\n### 6.2. Vue\r\n\r\n- [æ·±å…¥æµ…å‡º - vueå˜åŒ–ä¾¦æµ‹åŸç†](https://github.com/berwin/Blog/issues/17)\r\n- [Vue æ¨¡æ¿ç¼–è¯‘åŸç†](https://github.com/berwin/Blog/issues/18)\r\n\r\n### 6.3. Redux\r\n\r\n- [é‡æ–°è®¾è®¡ Redux \\[è‹±\\]](https://hackernoon.com/redesigning-redux-b2baee8b8a38)ï¼šRematch\r\n- [å¦‚ä½•ç”¨ GraphQL æ¥æ›¿ä»£ Redux \\[è‹±\\]](https://hackernoon.com/how-graphql-replaces-redux-3fff8289221d)\r\n- [è§£è¯» Redux çš„è®¾è®¡æ€è·¯ä¸ç”¨æ³•](https://div.io/topic/1309)\r\n- [(Redux)åº”ç”¨æ„å»ºçš„ä¸‰ä¸ªåŸåˆ™ \\[è‹±\\]](https://jaysoo.ca/2016/02/28/organizing-redux-application/#rule-1-organize-by-feature)\r\n\r\n### 6.4. RxJS\r\n\r\n- [ReactiveX å®˜ç½‘](http://reactivex.io/)ï¼šå®çŸ³å›¾çœŸçš„éå¸¸å½¢è±¡æ˜“è¯»\r\n- [å“åº”å¼ç¼–ç¨‹ï¼Œæ˜¯æ˜æ™ºçš„é€‰æ‹©](https://www.cnblogs.com/android-blogs/p/5586395.html)\r\n- [å›¾è§£RxJS \\[è‹±\\]](https://blog.angularindepth.com/learn-to-combine-rxjs-sequences-with-super-intuitive-interactive-diagrams-20fce8e6511)\r\n- [è°ƒè¯•RxJSï¼šTooling \\[è‹±\\]](https://blog.angularindepth.com/debugging-rxjs-4f0340286dd3)\r\n- [è°ƒè¯•RxJSï¼šLogging \\[è‹±\\]](https://blog.angularindepth.com/debugging-rxjs-part-2-logging-56904459f144)\r\n\r\n\r\n## 7. æ–°æŠ€æœ¯/æ–¹å‘\r\n\r\n> å‰ç«¯é¢†åŸŸæ–°æŠ€æœ¯ã€æ–°æ–¹å‘å±‚å‡ºä¸ç©·ï¼Œè¿™é‡Œæ±‡æ€»ä¸€äº›æ–°æŠ€æœ¯æ–¹å‘ï¼›ä½œä¸ºå¼€å‘è€…éœ€è¦å¤šäº†è§£ä½†æ˜¯ä¸è¦ç›²ä»\r\n\r\n### 7.1. PWA\r\n\r\n- [PWA å­¦ä¹ ä¸å®è·µç³»åˆ—](https://juejin.im/post/5ac8a67c5188255c5668b0b8#heading-3)\r\n- [Service Worker å…¥é—¨ç®€ä»‹ \\[è‹±\\]](https://medium.freecodecamp.org/service-workers-the-little-heroes-behind-progressive-web-apps-431cc22d0f16)\r\n- [PWA åœ¨ iOS å¹³å°ä¸Šçš„ç‰¹æ®Šé—®é¢˜ \\[è‹±\\]](https://medium.com/@firt/pwas-are-coming-to-ios-11-3-cupertino-we-have-a-problem-2ff49fd7d6ea)\r\n- [åœ¨ä½ çš„ PWA ä¸­å°å¿ƒä½¿ç”¨ iOS çš„ meta æ ‡ç­¾ \\[è‹±\\]](https://medium.com/@firt/dont-use-ios-web-app-meta-tag-irresponsibly-in-your-progressive-web-apps-85d70f4438cb)\r\n- [é¥¿äº†ä¹ˆçš„ PWA å‡çº§å®è·µ](https://medium.com/elemefe/upgrading-ele-me-to-progressive-web-app-2a446832e509)\r\n- [ç¦»çº¿æŒ‡å—](https://developers.google.com/web/fundamentals/instant-and-offline/offline-cookbook/)\r\n- [Android ä¸­çš„ WebAPKs \\[è‹±\\]](https://developers.google.cn/web/fundamentals/integration/webapks?hl=zh-cn)\r\n- [Pinterest çš„ PWA å®è·µ \\[è‹±\\]](https://medium.com/@Pinterest_Engineering/a-one-year-pwa-retrospective-f4a2f4129e05)\r\n- [å¼‚æ­¥ HTTP Cookies API \\[è‹±\\]](https://developers.google.com/web/updates/2018/09/asynchronous-access-to-http-cookies)ï¼šèµ‹èƒ½Service Worker\r\n\r\n### 7.2. CSS Houdini\r\n\r\n- [è®¤è¯† Houdini ä¸ CSS Paint API \\[è‹±\\]](https://codersblock.com/blog/say-hello-to-houdini-and-the-css-paint-api/)\r\n- [ç”¨ Houdini æ¥æ‹¯æ•‘ CSS Polyfill \\[è‹±\\]](https://philipwalton.com/articles/the-dark-side-of-polyfilling-css/)\r\n\r\n### 7.3. Web Components\r\n\r\n- [Web Components åŸºæœ¬æ¦‚å¿µå’Œç”¨æ³•](https://developer.mozilla.org/zh-CN/docs/Web/Web_Components)\r\n- [Web Components æŒ‡å— \\[è‹±\\]](https://css-tricks.com/modular-future-web-components/)\r\n- [Shadow DOM ä½¿ç”¨ç®€ä»‹](http://web.jobbole.com/87088/)\r\n- [HTMLUnknownElement ä¸ HTML5 è‡ªå®šä¹‰å…ƒç´ çš„æ•…äº‹](http://www.zhangxinxu.com/wordpress/2018/03/htmlunknownelement-html5-custom-elements/)\r\n\r\n### 7.4. å¾®å‰ç«¯ï¼ˆMicro Frontendsï¼‰\r\n\r\n- [å¾®å‰ç«¯ä¸»é¡µ \\[è‹±\\]](https://micro-frontends.org/)\r\n- [å¾®å‰ç«¯çš„é‚£äº›äº‹å„¿](https://microfrontend.cn/)\r\n- [æŠ€æœ¯é›·è¾¾ä¹‹ã€Œå¾®å‰ç«¯ã€- å°†å¾®æœåŠ¡ç†å¿µæ‰©å±•åˆ°å‰ç«¯å¼€å‘](https://zhuanlan.zhihu.com/p/32378432)\r\n\r\n### 7.5. HTTP/2\r\n\r\n- [HTTP/2 å¹•ååŸç†](https://www.ibm.com/developerworks/cn/web/wa-http2-under-the-hood/index.html)\r\n- [å…¨é¢ä»‹ç»çš„ HTTP/2 \\[è‹±\\]](https://hpbn.co/http2/)\r\n- [HTTP/2 ä¸»é¡µ](https://http2.github.io/):\r\n    - [HTTP/2 åè®® \\[è‹±\\]](https://httpwg.org/specs/rfc7540.html)\r\n    - [HPACK: HTTP/2 Headerå‹ç¼© \\[è‹±\\]](https://httpwg.org/specs/rfc7541.html)\r\n\r\n### 7.6. WebAssembly\r\n\r\n- [WebAssembly å®˜ç½‘](https://webassembly.org/)\r\n- [WebAssembly ç°çŠ¶ä¸å®æˆ˜](https://www.ibm.com/developerworks/cn/web/wa-lo-webassembly-status-and-reality/index.html)\r\n- WebAssembly ç³»åˆ—ï¼š\r\n    - [ä¸€ã€ç”ŸåŠ¨å½¢è±¡åœ°ä»‹ç» WebAssembly](https://segmentfault.com/a/1190000008714589)\r\n    - [äºŒã€JavaScript Just-in-time (JIT) å·¥ä½œåŸç†](https://segmentfault.com/a/1190000008632441)\r\n    - [ä¸‰ã€ç¼–è¯‘å™¨å¦‚ä½•ç”Ÿæˆæ±‡ç¼–](https://segmentfault.com/a/1190000008664761)\r\n    - [å››ã€WebAssembly å·¥ä½œåŸç†](https://segmentfault.com/a/1190000008686643)\r\n    - [äº”ã€ä¸ºä»€ä¹ˆ WebAssembly æ›´å¿«ï¼Ÿ](https://segmentfault.com/a/1190000008699213)\r\n    - [å…­ã€WebAssembly çš„ç°åœ¨ä¸æœªæ¥](https://segmentfault.com/a/1190000008714515)\r\n\r\n## 8. ä¸šåŠ¡ç›¸å…³\r\n\r\n> åœ¨ä¸šåŠ¡ä¸­å¾€å¾€è¿˜æœ‰ä¸€äº›ä¸â€œä¸šåŠ¡æ— å…³â€çš„åœºæ™¯éœ€æ±‚ï¼Œä¸è®ºæ˜¯ä»€ä¹ˆä¸šåŠ¡å‡ ä¹éƒ½ä¼šé‡åˆ°ï¼›å› æ­¤ï¼Œåœ¨å˜ä¸ä¸å˜ä¸­ï¼Œæˆ‘ä»¬æ›´éœ€è¦å»æŠ½è±¡å‡ºè¿™äº›é—®é¢˜ã€‚\r\n\r\n### 8.1. æ•°æ®æ‰“ç‚¹ä¸ŠæŠ¥\r\n\r\n- [å¦‚ä½•ç²¾ç¡®ç»Ÿè®¡é¡µé¢åœç•™æ—¶é•¿](https://techblog.toutiao.com/2018/06/05/ru-he-jing-que-tong-ji-ye-mian-ting-liu-shi-chang/)\r\n- [æ­å¼€JSæ— åŸ‹ç‚¹æŠ€æœ¯çš„ç¥ç§˜é¢çº±](http://unclechen.github.io/2018/06/24/%E6%8F%AD%E5%BC%80JS%E6%97%A0%E5%9F%8B%E7%82%B9%E6%8A%80%E6%9C%AF%E7%9A%84%E7%A5%9E%E7%A7%98%E9%9D%A2%E7%BA%B1/)\r\n\r\n### 8.2. å‰ç«¯ç›‘æ§\r\n\r\n- [å‰ç«¯å¼‚å¸¸ç›‘æ§è§£å†³æ–¹æ¡ˆç ”ç©¶](https://cdc.tencent.com/2018/09/13/frontend-exception-monitor-research/)\r\n- [ç›‘æ§å¹³å°å‰ç«¯SDKå¼€å‘å®è·µ](https://tech.meituan.com/hunt_sdk_practice.html)\r\n- [æŠŠå‰ç«¯ç›‘æ§åšåˆ°æè‡´](https://zhuanlan.zhihu.com/p/32262716)\r\n- [å‰ç«¯ç›‘æ§ç³»ç»Ÿæ¢ç´¢æ€»ç»“](https://juejin.im/post/5a3e121451882533f01ec66d)\r\n\r\n### 8.3. A/Bæµ‹è¯•\r\n\r\n- Twitterçš„A/Bæµ‹è¯•å®è·µï¼š\r\n    - [ä¸€ã€ä¸ºä»€ä¹ˆè¦æµ‹è¯•ä»¥åŠæµ‹è¯•çš„æ„ä¹‰](http://www.infoq.com/cn/articles/twitter-ab-test-practise-part01)\r\n    - [äºŒã€æŠ€æœ¯æ¦‚è¿°](http://www.infoq.com/cn/articles/twitter-ab-test-practise-part02)\r\n    - [ä¸‰ã€æ£€æµ‹å’Œé¿å… A/B Testä¸­ bucketä¸å¹³è¡¡é—®é¢˜](http://www.infoq.com/cn/articles/twitter-ab-test-practise-part03)\r\n    - [å››ã€A/B Testä¸­ä½¿ç”¨å¤šä¸ªæ§åˆ¶çš„å¯ç¤º](http://www.infoq.com/cn/articles/twitter-ab-test-practise-part04)\r\n- [Netflix A/B Test å®éªŒå¹³å°å®è·µ \\[è‹±\\]](https://medium.com/netflix-techblog/its-all-a-bout-testing-the-netflix-experimentation-platform-4e1ca458c15)\r\n- æŒ‡å¯¼æ–¹æ³•\r\n    - [å®éªŒä¸­å®¹æ˜“é‡åˆ°çš„ä¸ƒç§é—®é¢˜ \\[è‹±\\]](https://www.exp-platform.com/Documents/2009-ExPpitfalls.pdf)\r\n    - [å®éªŒçš„ä¸ƒä¸ªå‡†åˆ™ \\[è‹±\\]](https://www.exp-platform.com/Documents/2014%20experimentersRulesOfThumb.pdf)\r\n    - [å°æµé‡å¦‚ä½•è¿›è¡ŒABæµ‹è¯•](https://www.jianshu.com/p/3ab537f16b81)\r\n- æ¡ˆä¾‹åˆ†äº«\r\n    - [å¤§ä¼—ç‚¹è¯„ABæµ‹è¯•æ¡†æ¶Gemini](https://www.csdn.net/article/2015-03-24/2824303)\r\n    - [æ–°æµªæ–°é—»å®¢æˆ·ç«¯ABæµ‹è¯•ä¸ç°åº¦å‘å¸ƒ](https://segmentfault.com/a/1190000012377139)\r\n    - [å¤©çŒ«App A/Bæµ‹è¯•å®è·µ](http://www.infoq.com/cn/articles/tmall-app-ab-test)\r\n- å·¥å…·\r\n    - [ABæµ‹è¯•æ ·æœ¬æ•°é‡è®¡ç®—å™¨](https://www.eyeofcloud.com/124.html)\r\n    - [ABæµ‹è¯•ç»“æœæœ‰æ•ˆæ€§åˆ†æå·¥å…·](https://www.eyeofcloud.com/126.html)\r\n\r\n### 8.4. â€œæœåŠ¡ç«¯æ¨â€\r\n\r\n- [å„ç±»â€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯åŸç†ä¸å®ä¾‹](https://juejin.im/post/5b135b78f265da6e420eab7d)\r\n- [é•¿è¿æ¥/websocket/SSEç­‰ä¸»æµæœåŠ¡å™¨æ¨é€æŠ€æœ¯æ¯”è¾ƒ](https://zhuanlan.zhihu.com/p/31297574)\r\n- [Cometï¼šåŸºäº HTTP é•¿è¿æ¥çš„â€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯](https://www.ibm.com/developerworks/cn/web/wa-lo-comet/)\r\n- [æ·±å…¥ WebSocketsã€HTTP/2 SSE \\[è‹±\\]](https://blog.sessionstack.com/how-javascript-works-deep-dive-into-websockets-and-http-2-with-sse-how-to-pick-the-right-path-584e6b8e3bf7)\r\n- [WebSocket åº”ç”¨å®‰å…¨é—®é¢˜åˆ†æ](https://security.tencent.com/index.php/blog/msg/119)\r\n\r\n### 8.5. åŠ¨æ•ˆ\r\n\r\n- [åŠ¨ç”»è®¾è®¡çš„12ä¸ªåŸåˆ™ğŸ¥ \\[è‹±\\]](https://www.youtube.com/watch?v=uDqjIdI4bF4)\r\n- [è´å¡å°”æ›²çº¿æ‰«ç›²](http://www.html-js.com/article/1628)\r\n- [åŠ¨ç”»ï¼šä» AE åˆ° Web](https://aotu.io/notes/2018/03/06/ae2web/)\r\n- æœ€å…¨æœ€å¥½ç”¨çš„åŠ¨æ•ˆè½åœ°æ–¹æ³•ï¼š\r\n    - [åŸºç¡€çŸ¥è¯†](https://zhuanlan.zhihu.com/p/34501702)\r\n    - [è½åœ°æ–¹å¼](https://zhuanlan.zhihu.com/p/34815524)\r\n\r\n## 9. ä¸å½’ç±»çš„å¥½æ–‡\r\n\r\n> å¼€å·æœ‰ç›Šã€‚\r\n\r\n- [Recursion? We don't need no stinking recursion!](http://raganwald.com/2018/05/20/we-dont-need-no-stinking-recursion.html)ï¼šå¦‚ä½•å°†ä¸€äº›é€’å½’æ”¹ä¸ºå¾ªç¯ï¼ˆå°¾é€’å½’ä¼˜åŒ–ï¼‰\r\n- [Turning your web traffic into a Super Computer](https://ben.akrin.com/?p=5997)ï¼šé€šè¿‡ Web Worker å’Œ WebSocket æ¥å°†å…¨ä¸–ç•Œçš„ç”µè„‘è¿æ¥æˆè¶…çº§è®¡ç®—æœº\r\n- [Designing very large (JavaScript) applications](https://medium.com/@cramforce/designing-very-large-javascript-applications-6e013a3291a3)ï¼šé«˜å±‹å»ºç“´ï¼Œé€‚åˆé˜…è¯»ä¸æ€è€ƒ\r\n\r\n> æ³¨ï¼šå…¶ä¸­éƒ¨åˆ†å¤–æ–‡æ–‡ç« å¯èƒ½éœ€è¦â€œç§‘å­¦ä¸Šç½‘â€","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/21","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/21/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/21/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/21/events","html_url":"https://github.com/alienzhou/blog/issues/21","id":390659405,"node_id":"MDU6SXNzdWUzOTA2NTk0MDU=","number":21,"title":"ã€webpackè¿›é˜¶ã€‘ä½ çœŸçš„æŒæ¡äº†loaderä¹ˆï¼Ÿ- loaderåé—®","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845019,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE5","url":"https://api.github.com/repos/alienzhou/blog/labels/Webpack","name":"Webpack","color":"e4e669","default":false,"description":""},{"id":1160330255,"node_id":"MDU6TGFiZWwxMTYwMzMwMjU1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7","name":"è‡ªåŠ¨åŒ–å·¥å…·","color":"f9c0d1","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T12:35:34Z","updated_at":"2018-12-13T12:55:06Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> å¾€æœŸæ–‡ç« ï¼š\r\n> - [ã€webpackè¿›é˜¶ã€‘å‰ç«¯è¿è¡Œæ—¶çš„æ¨¡å—åŒ–è®¾è®¡ä¸å®ç°](https://github.com/alienzhou/blog/issues/19)\r\n> - [ã€webpackè¿›é˜¶ã€‘ä½¿ç”¨babelé¿å…webpackç¼–è¯‘è¿è¡Œæ—¶æ¨¡å—ä¾èµ–](https://github.com/alienzhou/blog/issues/18)\r\n> - [ã€webpackè¿›é˜¶ã€‘å¯è§†åŒ–å±•ç¤ºwebpackå†…éƒ¨æ’ä»¶ä¸é’©å­å…³ç³»ğŸ“ˆ](https://github.com/alienzhou/blog/issues/20)\r\n\r\n## 1. loader åé—®\r\n\r\nåœ¨æˆ‘å­¦ä¹ webpack loaderçš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿé˜…è¯»äº†ç½‘ä¸Šå¾ˆå¤šç›¸å…³æ–‡ç« ï¼Œæ”¶è·ä¸å°‘ã€‚ä½†æ˜¯å¤§å¤šéƒ½åªä»‹ç»äº†loaderçš„é…ç½®æ–¹å¼æˆ–è€…loaderçš„ç¼–å†™æ–¹å¼ï¼Œå¯¹å…¶ä¸­å‚æ•°ã€apiåŠå…¶ä»–ç»†èŠ‚çš„ä»‹ç»å¹¶ä¸æ¸…æ™°ã€‚\r\n\r\nè¿™é‡Œæœ‰ä¸€ä¸ªã€Œloaderåé—®ã€ï¼Œæ˜¯æˆ‘åœ¨é˜…è¯»loaderæºç å‰å¿ƒä¸­çš„éƒ¨åˆ†ç–‘é—®ï¼š\r\n\r\n1. webpacké»˜è®¤é…ç½®æ˜¯åœ¨å“ªå¤„ç†çš„ï¼Œloaderæœ‰ä»€ä¹ˆé»˜è®¤é…ç½®ä¹ˆï¼Ÿ\r\n2. webpackä¸­æœ‰ä¸€ä¸ªresolverçš„æ¦‚å¿µï¼Œç”¨äºè§£ææ¨¡å—æ–‡ä»¶çš„çœŸå®ç»å¯¹è·¯å¾„ï¼Œé‚£ä¹ˆloaderå’Œæ™®é€šæ¨¡å—çš„resolverä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªä¹ˆï¼Ÿ\r\n3. æˆ‘ä»¬çŸ¥é“ï¼Œé™¤äº†configä¸­çš„loaderï¼Œè¿˜å¯ä»¥å†™inlineçš„loaderï¼Œé‚£ä¹ˆinline loaderå’Œnormal config loaderæ‰§è¡Œçš„å…ˆåé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ\r\n4. é…ç½®ä¸­çš„`module.rules`åœ¨webpackä¸­æ˜¯å¦‚ä½•ç”Ÿæ•ˆä¸å®ç°çš„ï¼Ÿ\r\n5. webpackç¼–è¯‘æµç¨‹ä¸­loaderæ˜¯å¦‚ä½•ä»¥åŠåœ¨ä½•æ—¶å‘æŒ¥ä½œç”¨çš„ï¼Ÿ\r\n6. loaderä¸ºä»€ä¹ˆæ˜¯è‡ªå³å‘å·¦æ‰§è¡Œçš„ï¼Ÿ\r\n7. å¦‚æœåœ¨æŸä¸ªpitchä¸­è¿”å›å€¼ï¼Œå…·ä½“ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ\r\n8. å¦‚æœä½ å†™è¿‡loaderï¼Œé‚£ä¹ˆå¯èƒ½åœ¨loader functionä¸­ç”¨åˆ°äº†`this`ï¼Œè¿™é‡Œçš„`this`ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Œæ˜¯webpackå®ä¾‹ä¹ˆï¼Ÿ\r\n9. loader functionä¸­çš„`this.data`æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ\r\n10. å¦‚ä½•å†™ä¸€ä¸ªå¼‚æ­¥loaderï¼Œwebpackåˆæ˜¯å¦‚ä½•å®ç°loaderçš„å¼‚æ­¥åŒ–çš„ï¼Ÿ\r\n\r\nä¹Ÿè®¸ä½ ä¹Ÿä¼šæœ‰ç±»ä¼¼çš„ç–‘é—®ã€‚ä¸‹é¢æˆ‘ä¼šç»“åˆloaderç›¸å…³çš„éƒ¨åˆ†æºç ï¼Œä¸ºå¤§å®¶è¿˜åŸloaderçš„è®¾è®¡ä¸å®ç°åŸç†ï¼Œè§£ç­”è¿™äº›ç–‘æƒ‘ã€‚\r\n\r\n## 2. loaderè¿è¡Œçš„æ€»ä½“æµç¨‹\r\n\r\nwebpackç¼–è¯‘æµç¨‹éå¸¸å¤æ‚ï¼Œä½†å…¶ä¸­æ¶‰åŠloaderçš„éƒ¨åˆ†ä¸»è¦åŒ…æ‹¬äº†ï¼š\r\n\r\n- loaderï¼ˆwebpackï¼‰çš„é»˜è®¤é…ç½®\r\n- ä½¿ç”¨loaderResolverè§£æloaderæ¨¡å—è·¯å¾„\r\n- æ ¹æ®`rule.modules`åˆ›å»ºRulesSetè§„åˆ™é›†\r\n- ä½¿ç”¨loader-runnerè¿è¡Œloader\r\n\r\nå…¶å¯¹åº”çš„å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/10/14/166713f3741bc389?w=365&h=606&f=png&s=44142)\r\n\r\né¦–å…ˆï¼Œåœ¨`Compiler.js`ä¸­ä¼šä¸ºå°†ç”¨æˆ·é…ç½®ä¸é»˜è®¤é…ç½®åˆå¹¶ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†loaderéƒ¨åˆ†ã€‚\r\n\r\nç„¶åï¼Œwebpackå°±ä¼šæ ¹æ®é…ç½®åˆ›å»ºä¸¤ä¸ªå…³é”®çš„å¯¹è±¡â€”â€”`NormalModuleFactory`å’Œ`ContextModuleFactory`ã€‚å®ƒä»¬ç›¸å½“äºæ˜¯ä¸¤ä¸ªç±»å·¥å‚ï¼Œé€šè¿‡å…¶å¯ä»¥åˆ›å»ºç›¸åº”çš„`NormalModule`å’Œ`ContextModule`ã€‚å…¶ä¸­`NormalModule`ç±»æ˜¯è¿™ç¯‡æ–‡ç« ä¸»è¦å…³æ³¨çš„ï¼Œwebpackä¼šä¸ºæºç ä¸­çš„æ¨¡å—æ–‡ä»¶å¯¹åº”ç”Ÿæˆä¸€ä¸ª`NormalModule`å®ä¾‹ã€‚\r\n\r\nåœ¨å·¥å‚åˆ›å»º`NormalModule`å®ä¾‹ä¹‹å‰è¿˜æœ‰ä¸€äº›å¿…è¦æ­¥éª¤ï¼Œå…¶ä¸­ä¸loaderæœ€ç›¸å…³çš„å°±æ˜¯é€šè¿‡loaderçš„resolveræ¥è§£æloaderè·¯å¾„ã€‚\r\n\r\nåœ¨`NormalModule`å®ä¾‹åˆ›å»ºä¹‹åï¼Œåˆ™ä¼šé€šè¿‡å…¶`.build()`æ–¹æ³•æ¥è¿›è¡Œæ¨¡å—çš„æ„å»ºã€‚æ„å»ºæ¨¡å—çš„ç¬¬ä¸€æ­¥å°±æ˜¯ä½¿ç”¨loaderæ¥åŠ è½½å¹¶å¤„ç†æ¨¡å—å†…å®¹ã€‚è€Œloader-runnerè¿™ä¸ªåº“å°±æ˜¯webpackä¸­loaderçš„è¿è¡Œå™¨ã€‚\r\n\r\næœ€åï¼Œå°†loaderå¤„ç†å®Œçš„æ¨¡å—å†…å®¹è¾“å‡ºï¼Œè¿›å…¥åç»­çš„ç¼–è¯‘æµç¨‹ã€‚\r\n\r\nä¸Šé¢å°±æ˜¯webpackä¸­loaderæ¶‰åŠåˆ°çš„å¤§è‡´æµç¨‹ã€‚ä¸‹é¢ä¼šç»“åˆæºç å¯¹å…¶è¿›è¡Œå…·ä½“çš„åˆ†æï¼Œè€Œåœ¨æºç é˜…è¯»åˆ†æè¿‡ç¨‹ä¸­ï¼Œå°±ä¼šæ‰¾åˆ°ã€Œloaderåé—®ã€çš„è§£ç­”ã€‚\r\n\r\n## 3. loaderè¿è¡Œéƒ¨åˆ†çš„å…·ä½“åˆ†æ\r\n\r\n### 3.1. webpacké»˜è®¤é…ç½®\r\n\r\n> Qï¼š1. webpacké»˜è®¤é…ç½®æ˜¯åœ¨å“ªå¤„ç†çš„ï¼Œloaderæœ‰ä»€ä¹ˆé»˜è®¤é…ç½®ä¹ˆï¼Ÿ\r\n\r\nwebpackå’Œå…¶ä»–å·¥å…·ä¸€æ ·ï¼Œéƒ½æ˜¯é€šè¿‡é…ç½®çš„æ–¹å¼æ¥å·¥ä½œçš„ã€‚éšç€webpackçš„ä¸æ–­è¿›åŒ–ï¼Œå…¶é»˜è®¤é…ç½®ä¹Ÿåœ¨ä¸æ–­å˜åŠ¨ï¼›è€Œæ›¾ç»ç‰ˆæœ¬ä¸­çš„æŸäº›æœ€ä½³å®è·µï¼Œä¹Ÿéšç€ç‰ˆæœ¬çš„å‡çº§è¿›å…¥äº†webpackçš„é»˜è®¤é…ç½®ã€‚\r\n\r\nwebpackçš„å…¥å£æ–‡ä»¶æ˜¯`lib/webpack.js`ï¼Œä¼šæ ¹æ®é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®ç¼–è¯‘æ—¶çš„é…ç½®options [(source code)](https://github.com/webpack/webpack/blob/master/lib/webpack.js#L37-L40)ï¼ˆä¸Šä¸€ç¯‡[ã€Šå¯è§†åŒ–å±•ç¤ºwebpackå†…éƒ¨æ’ä»¶ä¸é’©å­å…³ç³»ğŸ“ˆã€‹](https://github.com/alienzhou/blog/issues/20)æåˆ°çš„pluginä¹Ÿæ˜¯åœ¨è¿™é‡Œè§¦å‘çš„ï¼‰\r\n\r\n```javascript\r\noptions = new WebpackOptionsDefaulter().process(options);\r\ncompiler = new Compiler(options.context);\r\ncompiler.options = options;\r\n```\r\n\r\nç”±æ­¤å¯è§ï¼Œé»˜è®¤é…ç½®æ˜¯æ”¾åœ¨`WebpackOptionsDefaulter`é‡Œçš„ã€‚å› æ­¤ï¼Œå¦‚æœä½ æƒ³è¦æŸ¥çœ‹å½“å‰webpacké»˜è®¤é…ç½®é¡¹å…·ä½“å†…å®¹ï¼Œå¯ä»¥åœ¨[è¯¥æ¨¡å—](https://github.com/webpack/webpack/blob/master/lib/WebpackOptionsDefaulter.js)é‡ŒæŸ¥çœ‹ã€‚\r\n\r\nä¾‹å¦‚ï¼Œåœ¨`module.rules`è¿™éƒ¨åˆ†çš„é»˜è®¤å€¼ä¸º`[]`ï¼›ä½†æ˜¯æ­¤å¤–è¿˜æœ‰ä¸€ä¸ª`module.defaultRules`é…ç½®é¡¹ï¼Œè™½ç„¶ä¸å¼€æ”¾ç»™å¼€å‘è€…ä½¿ç”¨ï¼Œä½†æ˜¯åŒ…å«äº†loaderçš„é»˜è®¤é…ç½® [(source code)](https://github.com/webpack/webpack/blob/master/lib/WebpackOptionsDefaulter.js#L61-L87)ï¼š\r\n\r\n```javascript\r\nthis.set(\"module.rules\", []);\r\nthis.set(\"module.defaultRules\", \"make\", options => [\r\n    {\r\n        type: \"javascript/auto\",\r\n        resolve: {}\r\n    },\r\n    {\r\n        test: /\\.mjs$/i,\r\n        type: \"javascript/esm\",\r\n        resolve: {\r\n            mainFields:\r\n                options.target === \"web\" ||\r\n                options.target === \"webworker\" ||\r\n                options.target === \"electron-renderer\"\r\n                    ? [\"browser\", \"main\"]\r\n                    : [\"main\"]\r\n        }\r\n    },\r\n    {\r\n        test: /\\.json$/i,\r\n        type: \"json\"\r\n    },\r\n    {\r\n        test: /\\.wasm$/i,\r\n        type: \"webassembly/experimental\"\r\n    }\r\n]);\r\n```\r\n\r\n> æ­¤å¤–å€¼å¾—ä¸€æçš„æ˜¯ï¼Œ`WebpackOptionsDefaulter`ç»§æ‰¿è‡ª`OptionsDefaulter`ï¼Œè€Œ`OptionsDefaulter`åˆ™æ˜¯ä¸€ä¸ªå°è£…çš„é…ç½®é¡¹å­˜å–å™¨ï¼Œå°è£…äº†ä¸€äº›ç‰¹æ®Šçš„æ–¹æ³•æ¥æ“ä½œé…ç½®å¯¹è±¡ã€‚\r\n\r\n### 3.2. åˆ›å»º`NormalModuleFactory`\r\n\r\n`NormalModule`æ˜¯webpackä¸­ä¸å¾—ä¸æçš„ä¸€ä¸ªç±»å‡½æ•°ã€‚æºç ä¸­çš„æ¨¡å—åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šç”Ÿæˆå¯¹åº”çš„`NormalModule`å®ä¾‹ã€‚\r\n\r\n`NormalModuleFactory`æ˜¯`NormalModule`çš„å·¥å‚ç±»ã€‚å…¶åˆ›å»ºæ˜¯åœ¨`Compiler.js`ä¸­è¿›è¡Œçš„ï¼Œ`Compiler.js`æ˜¯webpackåŸºæœ¬ç¼–è¯‘æµç¨‹çš„æ§åˆ¶ç±»ã€‚`compiler.run()`æ–¹æ³•ä¸­çš„ä¸»ä½“ï¼ˆé’©å­ï¼‰æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/10/14/166715d115c84870?w=574&h=1716&f=png&s=153704)\r\n\r\n`.run()`åœ¨è§¦å‘äº†ä¸€ç³»åˆ—`beforeRun`ã€`run`ç­‰é’©å­åï¼Œä¼šè°ƒç”¨`.compile()`æ–¹æ³•ï¼Œå…¶ä¸­çš„ç¬¬ä¸€æ­¥å°±æ˜¯è°ƒç”¨`this.newCompilationParams()`åˆ›å»º`NormalModuleFactory`å®ä¾‹ã€‚\r\n\r\n```javascript\r\nnewCompilationParams() {\r\n    const params = {\r\n        normalModuleFactory: this.createNormalModuleFactory(),\r\n        contextModuleFactory: this.createContextModuleFactory(),\r\n        compilationDependencies: new Set()\r\n    };\r\n    return params;\r\n}\r\n```\r\n\r\n### 3.3. è§£æï¼ˆresolveï¼‰loaderçš„çœŸå®ç»å¯¹è·¯å¾„\r\n\r\n> Qï¼š2. webpackä¸­æœ‰ä¸€ä¸ªresolverçš„æ¦‚å¿µï¼Œç”¨äºè§£ææ¨¡å—æ–‡ä»¶çš„çœŸå®ç»å¯¹è·¯å¾„ï¼Œé‚£ä¹ˆloaderæ¨¡å—ä¸normal moduleï¼ˆæºç æ¨¡å—ï¼‰çš„resolverä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªä¹ˆï¼Ÿ\r\n\r\nåœ¨`NormalModuleFactory`ä¸­ï¼Œåˆ›å»ºå‡º`NormalModule`å®ä¾‹ä¹‹å‰ä¼šæ¶‰åŠåˆ°å››ä¸ªé’©å­ï¼š\r\n\r\n- beforeResolve\r\n- resolve\r\n- factory\r\n- afterResolve\r\n\r\nå…¶ä¸­è¾ƒä¸ºé‡è¦çš„æœ‰ä¸¤ä¸ªï¼š\r\n\r\n- resolveéƒ¨åˆ†è´Ÿè´£è§£æloaderæ¨¡å—çš„è·¯å¾„ï¼ˆä¾‹å¦‚css-loaderè¿™ä¸ªloaderçš„æ¨¡å—è·¯å¾„æ˜¯ä»€ä¹ˆï¼‰ï¼›\r\n- factoryè´Ÿè´£æ¥åŸºäºresolveé’©å­çš„è¿”å›å€¼æ¥åˆ›å»º`NormalModule`å®ä¾‹ã€‚\r\n\r\n`resolve`é’©å­ä¸Šæ³¨å†Œçš„æ–¹æ³•è¾ƒé•¿ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬äº†æ¨¡å—èµ„æºæœ¬èº«çš„è·¯å¾„è§£æã€‚`resolver`æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯loaderResolverå’ŒnormalResolverã€‚\r\n\r\n```javascript\r\nconst loaderResolver = this.getResolver(\"loader\");\r\nconst normalResolver = this.getResolver(\"normal\", data.resolveOptions);\r\n```\r\n\r\nç”±äºé™¤äº†configæ–‡ä»¶ä¸­å¯ä»¥é…ç½®loaderå¤–ï¼Œè¿˜æœ‰inline loaderçš„å†™æ³•ï¼Œå› æ­¤ï¼Œå¯¹loaderæ–‡ä»¶çš„è·¯å¾„è§£æä¹Ÿåˆ†ä¸ºä¸¤ç§ï¼šinline loaderå’Œconfigæ–‡ä»¶ä¸­çš„loaderã€‚resolveré’©å­ä¸­ä¼šå…ˆå¤„ç†inline loaderã€‚\r\n\r\n#### 3.3.1. inline loader \r\n\r\n```\r\nimport Styles from 'style-loader!css-loader?modules!./styles.css';\r\n```\r\n\r\nä¸Šé¢æ˜¯ä¸€ä¸ªinline loaderçš„ä¾‹å­ã€‚å…¶ä¸­çš„requestä¸º`style-loader!css-loader?modules!./styles.css`ã€‚\r\n\r\né¦–å…ˆwebpackä¼šä»requestä¸­è§£æå‡ºæ‰€éœ€çš„loader [(source code)](https://github.com/webpack/webpack/blob/master/lib/NormalModuleFactory.js#L184-L187):\r\n\r\n```javascript\r\nlet elements = requestWithoutMatchResource\r\n    .replace(/^-?!+/, \"\")\r\n    .replace(/!!+/g, \"!\")\r\n    .split(\"!\");\r\n```\r\n\r\nå› æ­¤ï¼Œä»`style-loader!css-loader?modules!./styles.css`ä¸­å¯ä»¥å–å‡ºä¸¤ä¸ªloaderï¼š`style-loader`å’Œ`css-loader`ã€‚\r\n\r\nç„¶åä¼šå°†â€œè§£ææ¨¡å—çš„loaderæ•°ç»„â€ä¸â€œè§£ææ¨¡å—æœ¬èº«â€ä¸€èµ·å¹¶è¡Œæ‰§è¡Œï¼Œè¿™é‡Œç”¨åˆ°äº†[`neo-async`](https://github.com/suguru03/neo-async)è¿™ä¸ªåº“ã€‚\r\n\r\n> `neo-async`åº“å’Œ`async`åº“ç±»ä¼¼ï¼Œéƒ½æ˜¯ä¸ºå¼‚æ­¥ç¼–ç¨‹æä¾›ä¸€äº›å·¥å…·æ–¹æ³•ï¼Œä½†æ˜¯ä¼šæ¯”`async`åº“æ›´å¿«ã€‚\r\n\r\nè§£æè¿”å›çš„ç»“æœæ ¼å¼å¤§è‡´å¦‚ä¸‹ï¼š\r\n\r\n```javascript\r\n[ \r\n    // ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªloaderæ•°ç»„\r\n    [ { \r\n        loader:\r\n            '/workspace/basic-demo/home/node_modules/html-webpack-plugin/lib/loader.js',\r\n        options: undefined\r\n    } ],\r\n    // ç¬¬äºŒä¸ªå…ƒç´ æ˜¯æ¨¡å—æœ¬èº«çš„ä¸€äº›ä¿¡æ¯\r\n    {\r\n        resourceResolveData: {\r\n            context: [Object],\r\n            path: '/workspace/basic-demo/home/public/index.html',\r\n            request: undefined,\r\n            query: '',\r\n            module: false,\r\n            file: false,\r\n            descriptionFilePath: '/workspace/basic-demo/home/package.json',\r\n            descriptionFileData: [Object],\r\n            descriptionFileRoot: '/workspace/basic-demo/home',\r\n            relativePath: './public/index.html',\r\n            __innerRequest_request: undefined,\r\n            __innerRequest_relativePath: './public/index.html',\r\n            __innerRequest: './public/index.html'\r\n        },\r\n\tresource: '/workspace/basic-demo/home/public/index.html'\r\n    }\r\n]\r\n```\r\n\r\nå…¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯è¯¥æ¨¡å—è¢«å¼•ç”¨æ—¶æ‰€æ¶‰åŠçš„æ‰€æœ‰inline loaderï¼ŒåŒ…å«loaderæ–‡ä»¶çš„ç»å¯¹è·¯å¾„å’Œé…ç½®é¡¹ã€‚\r\n\r\n#### 3.3.2. config loader\r\n\r\n> Qï¼š3. æˆ‘ä»¬çŸ¥é“ï¼Œé™¤äº†configä¸­çš„loaderï¼Œè¿˜å¯ä»¥å†™inlineçš„loaderï¼Œé‚£ä¹ˆinline loaderå’Œnormal config loaderæ‰§è¡Œçš„å…ˆåé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ\r\n\r\nä¸Šé¢ä¸€èŠ‚ä¸­ï¼Œwebpacké¦–å…ˆè§£æäº†inline loaderçš„ç»å¯¹è·¯å¾„ä¸é…ç½®ã€‚æ¥ä¸‹æ¥åˆ™æ˜¯è§£æconfigæ–‡ä»¶ä¸­çš„loader [(source code)](https://github.com/webpack/webpack/blob/master/lib/NormalModuleFactory.js#L270-L279)ï¼Œå³`module.rules`éƒ¨åˆ†çš„é…ç½®ï¼š\r\n\r\n```javascript\r\nconst result = this.ruleSet.exec({\r\n    resource: resourcePath,\r\n    realResource:\r\n        matchResource !== undefined\r\n            ? resource.replace(/\\?.*/, \"\")\r\n            : resourcePath,\r\n    resourceQuery,\r\n    issuer: contextInfo.issuer,\r\n    compiler: contextInfo.compiler\r\n});\r\n```\r\n\r\n`NormalModuleFactory`ä¸­æœ‰ä¸€ä¸ª`ruleSet`çš„å±æ€§ï¼Œè¿™é‡Œä½ å¯ä»¥ç®€å•ç†è§£ä¸ºï¼šå®ƒå¯ä»¥æ ¹æ®æ¨¡å—è·¯å¾„åï¼ŒåŒ¹é…å‡ºæ¨¡å—æ‰€éœ€çš„loaderã€‚`RuleSet`ç»†èŠ‚æ­¤å¤„å…ˆæŒ‰ä¸‹ä¸è¡¨ï¼Œå…¶å…·ä½“å†…å®¹æˆ‘ä¼šåœ¨ä¸‹ä¸€èŠ‚ä»‹ç»ã€‚\r\n\r\nè¿™é‡Œå‘`this.ruleSet.exec()`ä¸­ä¼ å…¥æºç æ¨¡å—è·¯å¾„ï¼Œè¿”å›çš„`result`å°±æ˜¯å½“å‰æ¨¡å—åŒ¹é…å‡ºçš„configä¸­çš„loaderã€‚å¦‚æœä½ ç†Ÿæ‚‰webpacké…ç½®ï¼Œä¼šçŸ¥é“`module.rules`ä¸­æœ‰ä¸€ä¸ª`enforce`å­—æ®µã€‚åŸºäºè¯¥å­—æ®µï¼Œwebpackä¼šå°†loaderåˆ†ä¸ºpreLoaderã€postLoaderå’Œloaderä¸‰ç§ [(source code)](https://github.com/webpack/webpack/blob/master/lib/NormalModuleFactory.js#L284-L311)ï¼š\r\n\r\n```javascript\r\nfor (const r of result) {\r\n    if (r.type === \"use\") {\r\n        // postç±»å‹\r\n        if (r.enforce === \"post\" && !noPrePostAutoLoaders) {\r\n            useLoadersPost.push(r.value);\r\n        // preç±»å‹\r\n        } else if (\r\n            r.enforce === \"pre\" &&\r\n            !noPreAutoLoaders &&\r\n            !noPrePostAutoLoaders\r\n        ) {\r\n            useLoadersPre.push(r.value);\r\n        } else if (\r\n            !r.enforce &&\r\n            !noAutoLoaders &&\r\n            !noPrePostAutoLoaders\r\n        ) {\r\n            useLoaders.push(r.value);\r\n        }\r\n    }\r\n    // â€¦â€¦\r\n}\r\n```\r\n\r\næœ€åï¼Œä½¿ç”¨neo-aysncæ¥å¹¶è¡Œè§£æä¸‰ç±»loaderæ•°ç»„ [(source code)](https://github.com/webpack/webpack/blob/master/lib/NormalModuleFactory.js#L312-L335)ï¼š\r\n\r\n```javascript\r\nasyncLib.parallel(\r\n    [\r\n        this.resolveRequestArray.bind(\r\n            this,\r\n            contextInfo,\r\n            this.context,\r\n            useLoadersPost, // postLoader\r\n            loaderResolver\r\n        ),\r\n        this.resolveRequestArray.bind(\r\n            this,\r\n            contextInfo,\r\n            this.context,\r\n            useLoaders, // loader\r\n            loaderResolver\r\n        ),\r\n        this.resolveRequestArray.bind(\r\n            this,\r\n            contextInfo,\r\n            this.context,\r\n            useLoadersPre, // preLoader\r\n            loaderResolver\r\n        )\r\n    ]\r\n    // â€¦â€¦\r\n}\r\n```\r\n\r\né‚£ä¹ˆæœ€ç»ˆloaderçš„é¡ºåºç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢è¿™ä¸€è¡Œä»£ç å¯ä»¥è§£é‡Šï¼š\r\n\r\n```javascript\r\nloaders = results[0].concat(loaders, results[1], results[2]);\r\n```\r\n\r\nå…¶ä¸­`results[0]`ã€`results[1]`ã€`results[2]`ã€`loader`åˆ†åˆ«æ˜¯postLoaderã€loaderï¼ˆnormal config loaderï¼‰ã€preLoaderå’ŒinlineLoaderã€‚å› æ­¤åˆå¹¶åçš„loaderé¡ºåºæ˜¯ï¼špostã€inlineã€normalå’Œpreã€‚\r\n\r\nç„¶è€Œloaderæ˜¯ä»å³è‡³å·¦æ‰§è¡Œçš„ï¼ŒçœŸå®çš„loaderæ‰§è¡Œé¡ºåºæ˜¯å€’è¿‡æ¥çš„ï¼Œå› æ­¤inlineLoaderæ˜¯æ•´ä½“åäºconfigä¸­normal loaderæ‰§è¡Œçš„ã€‚\r\n\r\n### 3.3.3. RuleSet\r\n\r\n> Qï¼š4. é…ç½®ä¸­çš„`module.rules`åœ¨webpackä¸­æ˜¯å¦‚ä½•ç”Ÿæ•ˆä¸å®ç°çš„ï¼Ÿ\r\n\r\nwebpackä½¿ç”¨`RuleSet`å¯¹è±¡æ¥åŒ¹é…æ¨¡å—æ‰€éœ€çš„loaderã€‚`RuleSet`ç›¸å½“äºä¸€ä¸ªè§„åˆ™è¿‡æ»¤å™¨ï¼Œä¼šå°†resourcePathåº”ç”¨äºæ‰€æœ‰çš„`module.rules`è§„åˆ™ï¼Œä»è€Œç­›é€‰å‡ºæ‰€éœ€çš„loaderã€‚å…¶ä¸­æœ€é‡è¦çš„ä¸¤ä¸ªæ–¹æ³•æ˜¯ï¼š\r\n\r\n- ç±»é™æ€æ–¹æ³•`.normalizeRule()`\r\n- å®ä¾‹æ–¹æ³•`.exec()`\r\n\r\nwebpackç¼–è¯‘ä¼šæ ¹æ®ç”¨æˆ·é…ç½®ä¸é»˜è®¤é…ç½®ï¼Œå®ä¾‹åŒ–ä¸€ä¸ª`RuleSet`ã€‚é¦–å…ˆï¼Œé€šè¿‡å…¶ä¸Šçš„é™æ€æ–¹æ³•`.normalizeRule()`å°†é…ç½®å€¼è½¬æ¢ä¸ºæ ‡å‡†åŒ–çš„testå¯¹è±¡ï¼›å…¶ä¸Šè¿˜ä¼šå­˜å‚¨ä¸€ä¸ª`this.references`å±æ€§ï¼Œæ˜¯ä¸€ä¸ªmapç±»å‹çš„å­˜å‚¨ï¼Œkeyæ˜¯loaderåœ¨é…ç½®ä¸­çš„ç±»å‹å’Œä½ç½®ï¼Œä¾‹å¦‚ï¼Œ`ref-2`è¡¨ç¤ºloaderé…ç½®æ•°ç»„ä¸­çš„ç¬¬ä¸‰ä¸ªã€‚\r\n\r\n> p.s. å¦‚æœä½ åœ¨.compilationä¸­æŸä¸ªé’©å­ä¸Šæ‰“å°å‡ºä¸€äº›NormalModuleä¸Šrequestç›¸å…³å­—æ®µï¼Œé‚£äº›ç”¨åˆ°loaderçš„æ¨¡å—ä¼šå‡ºç°ç±»ä¼¼`ref-`çš„å€¼ã€‚ä»è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºä¸€ä¸ªæ¨¡å—æ˜¯å¦ä½¿ç”¨äº†loaderï¼Œå‘½ä¸­äº†å“ªä¸ªé…ç½®è§„åˆ™ã€‚\r\n\r\nå®ä¾‹åŒ–åçš„`RuleSet`å°±å¯ä»¥ç”¨äºä¸ºæ¯ä¸ªæ¨¡å—è·å–å¯¹åº”çš„loaderã€‚è¿™ä¸ªå®ä¾‹åŒ–çš„`RuleSet`å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„`NormalModuleFactory`å®ä¾‹ä¸Šçš„`this.ruleSet`å±æ€§ã€‚å·¥å‚æ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„`NormalModule`æ—¶éƒ½ä¼šè°ƒç”¨`RuleSet`å®ä¾‹çš„`.exec()`æ–¹æ³•ï¼Œåªæœ‰å½“é€šè¿‡äº†å„ç±»æµ‹è¯•æ¡ä»¶ï¼Œæ‰ä¼šå°†è¯¥loader pushåˆ°ç»“æœæ•°ç»„ä¸­ã€‚\r\n\r\n### 3.4. è¿è¡Œloader\r\n\r\n#### 3.4.1. loaderçš„è¿è¡Œæ—¶æœº\r\n\r\n> Qï¼š5. webpackç¼–è¯‘æµç¨‹ä¸­loaderæ˜¯å¦‚ä½•ä»¥åŠåœ¨ä½•æ—¶å‘æŒ¥ä½œç”¨çš„ï¼Ÿ\r\n\r\nloaderçš„ç»å¯¹è·¯å¾„è§£æå®Œæ¯•åï¼Œåœ¨`NormalModuleFactory`çš„`factory`é’©å­ä¸­ä¼šåˆ›å»ºå½“å‰æ¨¡å—çš„`NormalModule`å¯¹è±¡ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œloaderçš„å‰åºå·¥ä½œå·²ç»å·®ä¸å¤šç»“æŸäº†ï¼Œä¸‹é¢å°±æ˜¯çœŸæ­£å»è¿è¡Œå„ä¸ªloaderã€‚\r\n\r\næˆ‘ä»¬éƒ½çŸ¥é“ï¼Œè¿è¡Œloaderè¯»å–ä¸å¤„ç†æ¨¡å—æ˜¯webpackæ¨¡å—å¤„ç†çš„ç¬¬ä¸€æ­¥ã€‚ä½†å¦‚æœè¯´åˆ°è¯¦ç»†çš„è¿è¡Œæ—¶æœºï¼Œå°±æ¶‰åŠåˆ°webpackç¼–è¯‘ä¸­`compilation`è¿™ä¸ªéå¸¸é‡è¦çš„å¯¹è±¡ã€‚\r\n\r\nwebpackæ˜¯ä»¥å…¥å£ç»´åº¦è¿›è¡Œç¼–è¯‘çš„ï¼Œ`compilation`ä¸­æœ‰ä¸€ä¸ªé‡è¦æ–¹æ³•â€”â€”`.addEntry()`ï¼Œä¼šåŸºäºå…¥å£è¿›è¡Œæ¨¡å—æ„å»ºã€‚`.addEntry()`æ–¹æ³•ä¸­è°ƒç”¨çš„`._addModuleChain()`ä¼šæ‰§è¡Œä¸€ç³»åˆ—çš„æ¨¡å—æ–¹æ³• [(source code)](https://github.com/webpack/webpack/blob/master/lib/Compilation.js#L996-L1010)\r\n\r\n```javascript\r\nthis.semaphore.acquire(() => {\r\n    moduleFactory.create(\r\n        {\r\n            // â€¦â€¦\r\n        },\r\n        (err, module) => {\r\n            if (err) {\r\n                this.semaphore.release();\r\n                return errorAndCallback(new EntryModuleNotFoundError(err));\r\n            }\r\n            // â€¦â€¦\r\n            if (addModuleResult.build) {\r\n                // æ¨¡å—æ„å»º\r\n                this.buildModule(module, false, null, null, err => {\r\n                    if (err) {\r\n                        this.semaphore.release();\r\n                        return errorAndCallback(err);\r\n                    }\r\n\r\n                    if (currentProfile) {\r\n                        const afterBuilding = Date.now();\r\n                        currentProfile.building = afterBuilding - afterFactory;\r\n                    }\r\n\r\n                    this.semaphore.release();\r\n                    afterBuild();\r\n                });\r\n            }\r\n        }\r\n    )\r\n}\r\n```\r\n\r\nå…¶ä¸­ï¼Œå¯¹äºæœªbuildè¿‡çš„æ¨¡å—ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°`NormalModule`å¯¹è±¡çš„[`.doBuild()`æ–¹æ³•](https://github.com/webpack/webpack/blob/master/lib/NormalModule.js#L257)ã€‚è€Œæ„å»ºæ¨¡å—(`.doBuild()`)çš„ç¬¬ä¸€æ­¥å°±æ˜¯[è¿è¡Œæ‰€æœ‰çš„loader](https://github.com/webpack/webpack/blob/master/lib/NormalModule.js#L265)ã€‚\r\n\r\nè¿™æ—¶å€™ï¼Œloader-runnerå°±ç™»åœºäº†ã€‚\r\n\r\n#### 3.4.2. loader-runner â€”â€” loaderçš„æ‰§è¡Œåº“\r\n\r\n> Qï¼š6. loaderä¸ºä»€ä¹ˆæ˜¯è‡ªå³å‘å·¦æ‰§è¡Œçš„ï¼Ÿ\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/10/14/166726229bc58100?w=2010&h=198&f=png&s=50665)\r\n\r\nwebpackå°†loaderçš„è¿è¡Œå·¥å…·å‰¥ç¦»å‡ºæ¥ï¼Œç‹¬ç«‹æˆäº†[loader-runneråº“](https://github.com/webpack/loader-runner)ã€‚å› æ­¤ï¼Œä½ å¯ä»¥ç¼–å†™ä¸€ä¸ªloaderï¼Œå¹¶ç”¨ç‹¬ç«‹çš„loader-runneræ¥æµ‹è¯•loaderçš„æ•ˆæœã€‚\r\n\r\nloader-runneråˆ†ä¸ºäº†ä¸¤ä¸ªéƒ¨åˆ†ï¼šloadLoader.jsä¸LoaderRunner.jsã€‚\r\n\r\nloadLoader.jsæ˜¯ä¸€ä¸ªå…¼å®¹æ€§çš„æ¨¡å—åŠ è½½å™¨ï¼Œå¯ä»¥åŠ è½½ä¾‹å¦‚cjsã€esmæˆ–SystemJSè¿™ç§çš„æ¨¡å—å®šä¹‰ã€‚è€ŒLoaderRunner.jsåˆ™æ˜¯loaderæ¨¡å—è¿è¡Œçš„æ ¸å¿ƒéƒ¨åˆ†ã€‚å…¶ä¸­æš´éœ²å‡ºæ¥çš„`.runLoaders()`æ–¹æ³•åˆ™æ˜¯loaderè¿è¡Œçš„å¯åŠ¨æ–¹æ³•ã€‚\r\n\r\nå¦‚æœä½ å†™è¿‡æˆ–äº†è§£å¦‚ä½•ç¼–å†™ä¸€ä¸ªloaderï¼Œé‚£ä¹ˆè‚¯å®šçŸ¥é“ï¼Œæ¯ä¸ªloaderæ¨¡å—éƒ½æ”¯æŒä¸€ä¸ª`.pitch`å±æ€§ï¼Œä¸Šé¢çš„æ–¹æ³•ä¼šä¼˜å…ˆäºloaderçš„å®é™…æ–¹æ³•æ‰§è¡Œã€‚å®é™…ä¸Šï¼Œwebpackå®˜æ–¹ä¹Ÿç»™å‡ºäº†pitchä¸loaderæœ¬èº«æ–¹æ³•çš„æ‰§è¡Œé¡ºåºå›¾ï¼š\r\n\r\n```\r\n|- a-loader `pitch`\r\n  |- b-loader `pitch`\r\n    |- c-loader `pitch`\r\n      |- requested module is picked up as a dependency\r\n    |- c-loader normal execution\r\n  |- b-loader normal execution\r\n|- a-loader normal execution\r\n```\r\n\r\nè¿™ä¸¤ä¸ªé˜¶æ®µï¼ˆpitchå’Œnormalï¼‰å°±æ˜¯loader-runnerä¸­å¯¹åº”çš„`iteratePitchingLoaders()`å’Œ`iterateNormalLoaders()`ä¸¤ä¸ªæ–¹æ³•ã€‚\r\n\r\n`iteratePitchingLoaders()`ä¼šé€’å½’æ‰§è¡Œï¼Œå¹¶è®°å½•loaderçš„`pitch`çŠ¶æ€ä¸å½“å‰æ‰§è¡Œåˆ°çš„`loaderIndex`ï¼ˆ`loaderIndex++`ï¼‰ã€‚å½“è¾¾åˆ°æœ€å¤§çš„loaderåºå·æ—¶ï¼Œæ‰ä¼šå¤„ç†å®é™…çš„moduleï¼š\r\n\r\n```javascript\r\nif(loaderContext.loaderIndex >= loaderContext.loaders.length)\r\n    return processResource(options, loaderContext, callback);\r\n```\r\n\r\nå½“`loaderContext.loaderIndex`å€¼è¾¾åˆ°æ•´ä½“loaderæ•°ç»„é•¿åº¦æ—¶ï¼Œè¡¨æ˜æ‰€æœ‰pitchéƒ½è¢«æ‰§è¡Œå®Œæ¯•ï¼ˆæ‰§è¡Œåˆ°äº†æœ€åçš„loaderï¼‰ï¼Œè¿™æ—¶ä¼šè°ƒç”¨`processResource()`æ¥å¤„ç†æ¨¡å—èµ„æºã€‚ä¸»è¦åŒ…æ‹¬ï¼šæ·»åŠ è¯¥æ¨¡å—ä¸ºä¾èµ–å’Œè¯»å–æ¨¡å—å†…å®¹ã€‚ç„¶åä¼šé€’å½’æ‰§è¡Œ`iterateNormalLoaders()`å¹¶è¿›è¡Œ`loaderIndex--`æ“ä½œï¼Œå› æ­¤loaderä¼šâ€œåå‘â€æ‰§è¡Œã€‚\r\n\r\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®¨è®ºå‡ ä¸ªloader-runnerçš„ç»†èŠ‚ç‚¹ï¼š\r\n\r\n> Qï¼š7. å¦‚æœåœ¨æŸä¸ªpitchä¸­è¿”å›å€¼ï¼Œå…·ä½“ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ\r\n\r\nå®˜ç½‘ä¸Šè¯´ï¼š\r\n\r\n> if a loader delivers a result in the pitch method the process turns around and skips the remaining loaders\r\n\r\nè¿™æ®µè¯´æ˜è¡¨ç¤ºï¼Œåœ¨pitchä¸­è¿”å›å€¼ä¼šè·³è¿‡ä½™ä¸‹çš„loaderã€‚è¿™ä¸ªè¡¨è¿°æ¯”è¾ƒç²—ç•¥ï¼Œå…¶ä¸­æœ‰å‡ ä¸ªç»†èŠ‚ç‚¹éœ€è¦è¯´æ˜ï¼š\r\n\r\né¦–å…ˆï¼Œåªæœ‰å½“`loaderIndex`è¾¾åˆ°æœ€å¤§æ•°ç»„é•¿åº¦ï¼Œå³pitchè¿‡æ‰€æœ‰loaderåï¼Œæ‰ä¼šæ‰§è¡Œ`processResource()`ã€‚\r\n\r\n```javascript\r\nif(loaderContext.loaderIndex >= loaderContext.loaders.length)\r\n    return processResource(options, loaderContext, callback);\r\n```\r\n\r\nå› æ­¤ï¼Œåœ¨pitchä¸­è¿”å›å€¼é™¤äº†è·³è¿‡ä½™ä¸‹loaderå¤–ï¼Œä¸ä»…ä¼šä½¿`.addDependency()`ä¸è§¦å‘ï¼ˆä¸å°†è¯¥æ¨¡å—èµ„æºæ·»åŠ è¿›ä¾èµ–ï¼‰ï¼Œè€Œä¸”æ— æ³•è¯»å–æ¨¡å—çš„æ–‡ä»¶å†…å®¹ã€‚loaderä¼šå°†pitchè¿”å›çš„å€¼ä½œä¸ºâ€œæ–‡ä»¶å†…å®¹â€æ¥å¤„ç†ï¼Œå¹¶è¿”å›ç»™webpackã€‚\r\n\r\n---\r\n\r\n> Qï¼š8. å¦‚æœä½ å†™è¿‡loaderï¼Œé‚£ä¹ˆå¯èƒ½åœ¨loader functionä¸­ç”¨åˆ°äº†`this`ï¼Œè¿™é‡Œçš„`this`ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Œæ˜¯webpackå®ä¾‹ä¹ˆï¼Ÿ\r\n\r\nå…¶å®è¿™é‡Œçš„`this`æ—¢ä¸æ˜¯webpackå®ä¾‹ï¼Œä¹Ÿä¸æ˜¯compilerã€compilationã€normalModuleç­‰è¿™äº›å®ä¾‹ã€‚è€Œæ˜¯ä¸€ä¸ª[å«`loaderContext`çš„loader-runnerç‰¹æœ‰å¯¹è±¡](https://github.com/webpack/loader-runner/blob/master/lib/LoaderRunner.js#L263-L291)ã€‚\r\n\r\næ¯æ¬¡è°ƒç”¨`runLoaders()`æ–¹æ³•æ—¶ï¼Œå¦‚æœä¸æ˜¾å¼ä¼ å…¥contextï¼Œåˆ™ä¼šé»˜è®¤åˆ›å»ºä¸€ä¸ªæ–°çš„`loaderContext`ã€‚æ‰€ä»¥åœ¨å®˜ç½‘ä¸Šæåˆ°çš„å„ç§loader APIï¼ˆcallbackã€dataã€loaderIndexã€addContextDependencyç­‰ï¼‰éƒ½æ˜¯è¯¥å¯¹è±¡ä¸Šçš„å±æ€§ã€‚\r\n\r\n---\r\n\r\n> Qï¼š9. loader functionä¸­çš„`this.data`æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ\r\n\r\nçŸ¥é“äº†loaderä¸­çš„`this`å…¶å®æ˜¯ä¸€ä¸ªå«`loaderContext`çš„å¯¹è±¡ï¼Œé‚£ä¹ˆ`this.data`çš„å®ç°å…¶å®å°±æ˜¯`loaderContext.data`çš„å®ç° [(source code)](https://github.com/webpack/loader-runner/blob/master/lib/LoaderRunner.js#L346-L351)ï¼š\r\n\r\n```javascript\r\nObject.defineProperty(loaderContext, \"data\", {\r\n    enumerable: true,\r\n    get: function() {\r\n        return loaderContext.loaders[loaderContext.loaderIndex].data;\r\n    }\r\n});\r\n```\r\n\r\nè¿™é‡Œå®šä¹‰äº†ä¸€ä¸ª`.data`çš„ï¼ˆå­˜ï¼‰å–å™¨ã€‚å¯ä»¥çœ‹å‡ºï¼Œè°ƒç”¨`this.data`æ—¶ï¼Œä¸åŒçš„normal loaderç”±äº`loaderIndex`ä¸åŒï¼Œä¼šå¾—åˆ°ä¸åŒçš„å€¼ï¼›è€Œpitchæ–¹æ³•çš„å½¢å‚`data`ä¹Ÿæ˜¯ä¸åŒçš„loaderä¸‹çš„data [(source code)](https://github.com/webpack/loader-runner/blob/master/lib/LoaderRunner.js#L177)ã€‚\r\n\r\n```javascript\r\nrunSyncOrAsync(\r\n    fn,\r\n    loaderContext,\r\n    [loaderContext.remainingRequest, loaderContext.previousRequest, currentLoaderObject.data = {}],\r\n    function(err) {\r\n        // â€¦â€¦\r\n    }\r\n);\r\n```\r\n\r\n`runSyncOrAsync()`ä¸­çš„æ•°ç»„`[loaderContext.remainingRequest, loaderContext.previousRequest, currentLoaderObject.data = {}]`å°±æ˜¯pitchæ–¹æ³•çš„å…¥å‚ï¼Œè€Œ`currentLoaderObject`å°±æ˜¯å½“å‰`loaderIndex`æ‰€æŒ‡çš„loaderå¯¹è±¡ã€‚\r\n\r\nå› æ­¤ï¼Œå¦‚æœä½ æƒ³è¦ä¿å­˜ä¸€ä¸ªâ€œè´¯ç©¿å§‹ç»ˆâ€çš„æ•°æ®ï¼Œå¯ä»¥è€ƒè™‘ä¿å­˜åœ¨`this`çš„å…¶ä»–å±æ€§ä¸Šï¼Œæˆ–è€…é€šè¿‡ä¿®æ”¹loaderIndexï¼Œæ¥å–åˆ°å…¶ä»–loaderä¸Šçš„æ•°æ®ï¼ˆæ¯”è¾ƒhackï¼‰ã€‚\r\n\r\n--- \r\n\r\n> Qï¼š10. å¦‚ä½•å†™ä¸€ä¸ªå¼‚æ­¥loaderï¼Œwebpackåˆæ˜¯å¦‚ä½•å®ç°loaderçš„å¼‚æ­¥åŒ–çš„ï¼Ÿ\r\n\r\npitchä¸normal loaderçš„å®é™…æ‰§è¡Œï¼Œéƒ½æ˜¯åœ¨[`runSyncOrAsync()`](https://github.com/webpack/loader-runner/blob/master/lib/LoaderRunner.js#L90)è¿™ä¸ªæ–¹æ³•ä¸­ã€‚\r\n\r\næ ¹æ®webpackæ–‡æ¡£ï¼Œå½“æˆ‘ä»¬è°ƒç”¨`this.async()`æ—¶ï¼Œä¼šå°†loaderå˜ä¸ºä¸€ä¸ªå¼‚æ­¥çš„loaderï¼Œå¹¶è¿”å›ä¸€ä¸ªå¼‚æ­¥å›è°ƒã€‚\r\n\r\nåœ¨å…·ä½“å®ç°ä¸Šï¼Œ`runSyncOrAsync()`å†…éƒ¨æœ‰ä¸€ä¸ª`isSync`å˜é‡ï¼Œé»˜è®¤ä¸º`true`ï¼›å½“æˆ‘ä»¬è°ƒç”¨`this.async()`æ—¶ï¼Œå®ƒä¼šè¢«ç½®ä¸º`false`ï¼Œå¹¶è¿”å›ä¸€ä¸ª`innerCallback`ä½œä¸ºå¼‚æ­¥æ‰§è¡Œå®Œåçš„å›è°ƒé€šçŸ¥ï¼š\r\n\r\n```javascript\r\ncontext.async = function async() {\r\n    if(isDone) {\r\n        if(reportedError) return; // ignore\r\n        throw new Error(\"async(): The callback was already called.\");\r\n    }\r\n    isSync = false;\r\n    return innerCallback;\r\n};\r\n```\r\n\r\næˆ‘ä»¬ä¸€èˆ¬éƒ½ä½¿ç”¨`this.async()`è¿”å›çš„callbackæ¥é€šçŸ¥å¼‚æ­¥å®Œæˆï¼Œä½†å®é™…ä¸Šï¼Œæ‰§è¡Œ`this.callback()`ä¹Ÿæ˜¯ä¸€æ ·çš„æ•ˆæœï¼š\r\n\r\n```javascript\r\nvar innerCallback = context.callback = function() {\r\n    // â€¦â€¦\r\n}\r\n```\r\n\r\nåŒæ—¶ï¼Œåœ¨`runSyncOrAsync()`ä¸­ï¼Œåªæœ‰`isSync`æ ‡è¯†ä¸º`true`æ—¶ï¼Œæ‰ä¼šåœ¨loader functionæ‰§è¡Œå®Œæ¯•åç«‹å³ï¼ˆåŒæ­¥ï¼‰å›è°ƒcallbackæ¥ç»§ç»­loader-runnerã€‚\r\n\r\n```javascript\r\nif(isSync) {\r\n    isDone = true;\r\n    if(result === undefined)\r\n        return callback();\r\n    if(result && typeof result === \"object\" && typeof result.then === \"function\") {\r\n        return result.catch(callback).then(function(r) {\r\n            callback(null, r);\r\n        });\r\n    }\r\n    return callback(null, result);\r\n}\r\n```\r\n\r\nçœ‹åˆ°è¿™é‡Œä½ ä¼šå‘ç°ï¼Œä»£ç é‡Œæœ‰ä¸€å¤„ä¼šåˆ¤æ–­è¿”å›å€¼æ˜¯å¦æ˜¯Promiseï¼ˆ`typeof result.then === \"function\"`ï¼‰ï¼Œå¦‚æœæ˜¯Promiseåˆ™ä¼šå¼‚æ­¥è°ƒç”¨callbackã€‚å› æ­¤ï¼Œæƒ³è¦è·å¾—ä¸€ä¸ªå¼‚æ­¥çš„loaderï¼Œé™¤äº†webpackæ–‡æ¡£é‡Œæåˆ°çš„`this.async()`æ–¹æ³•ï¼Œè¿˜å¯ä»¥ç›´æ¥è¿”å›ä¸€ä¸ªPromiseã€‚\r\n\r\n## 4. å°¾å£°\r\n\r\nä»¥ä¸Šå°±æ˜¯webapck loaderç›¸å…³éƒ¨åˆ†çš„æºç åˆ†æã€‚ç›¸ä¿¡åˆ°è¿™é‡Œï¼Œä½ å·²ç»å¯¹æœ€å¼€å§‹çš„ã€Œloaderåé—®ã€æœ‰äº†ç­”æ¡ˆã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿè®©ä½ åœ¨å­¦ä¼šé…ç½®loaderä¸ç¼–å†™ä¸€ä¸ªç®€å•çš„loaderä¹‹å¤–ï¼Œèƒ½è¿›ä¸€æ­¥äº†è§£loaderçš„å®ç°ã€‚\r\n\r\né˜…è¯»æºç çš„è¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨ä¸€äº›çº°æ¼ï¼Œæ¬¢è¿å¤§å®¶æ¥ä¸€èµ·äº¤æµã€‚\r\n\r\n## å‘Šåˆ«ã€Œwebpacké…ç½®å·¥ç¨‹å¸ˆã€\r\n\r\nwebpackæ˜¯ä¸€ä¸ªå¼ºå¤§è€Œå¤æ‚çš„å‰ç«¯è‡ªåŠ¨åŒ–å·¥å…·ã€‚å…¶ä¸­ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯é…ç½®å¤æ‚ï¼Œè¿™ä¹Ÿä½¿å¾—ã€Œwebpacké…ç½®å·¥ç¨‹å¸ˆã€è¿™ç§æˆè°‘çš„ç§°å‘¼å¼€å§‹æµè¡ŒğŸ¤·ä½†æ˜¯ï¼Œéš¾é“ä½ çœŸçš„åªæ»¡è¶³äºç©è½¬webpacké…ç½®ä¹ˆï¼Ÿ\r\n\r\næ˜¾ç„¶ä¸æ˜¯ã€‚åœ¨å­¦ä¹ å¦‚ä½•ä½¿ç”¨webpackä¹‹å¤–ï¼Œæˆ‘ä»¬æ›´éœ€è¦æ·±å…¥webpackå†…éƒ¨ï¼Œæ¢ç´¢å„éƒ¨åˆ†çš„è®¾è®¡ä¸å®ç°ã€‚ä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œå³ä½¿æœ‰ä¸€å¤©webpackâ€œè¿‡æ°”â€äº†ï¼Œä½†å®ƒçš„æŸäº›è®¾è®¡ä¸å®ç°å´ä»ä¼šæœ‰å­¦ä¹ ä»·å€¼ä¸å€Ÿé‰´æ„ä¹‰ã€‚å› æ­¤ï¼Œåœ¨å­¦ä¹ webpackè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¼šæ€»ç»“ä¸€ç³»åˆ—ã€webpackè¿›é˜¶ã€‘çš„æ–‡ç« å’Œå¤§å®¶åˆ†äº«ã€‚\r\n\r\næ¬¢è¿æ„Ÿå…´è¶£çš„åŒå­¦å¤šå¤šäº¤æµä¸å…³æ³¨ï¼\r\n\r\n> å¾€æœŸæ–‡ç« ï¼š\r\n> - [ã€webpackè¿›é˜¶ã€‘å‰ç«¯è¿è¡Œæ—¶çš„æ¨¡å—åŒ–è®¾è®¡ä¸å®ç°](https://github.com/alienzhou/blog/issues/19)\r\n> - [ã€webpackè¿›é˜¶ã€‘ä½¿ç”¨babelé¿å…webpackç¼–è¯‘è¿è¡Œæ—¶æ¨¡å—ä¾èµ–](https://github.com/alienzhou/blog/issues/18)\r\n> - [ã€webpackè¿›é˜¶ã€‘å¯è§†åŒ–å±•ç¤ºwebpackå†…éƒ¨æ’ä»¶ä¸é’©å­å…³ç³»ğŸ“ˆ](https://github.com/alienzhou/blog/issues/20)\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/20","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/20/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/20/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/20/events","html_url":"https://github.com/alienzhou/blog/issues/20","id":390658747,"node_id":"MDU6SXNzdWUzOTA2NTg3NDc=","number":20,"title":"ã€webpackè¿›é˜¶ã€‘å¯è§†åŒ–å±•ç¤ºwebpackå†…éƒ¨æ’ä»¶ä¸é’©å­å…³ç³»ğŸ“ˆ","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845019,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE5","url":"https://api.github.com/repos/alienzhou/blog/labels/Webpack","name":"Webpack","color":"e4e669","default":false,"description":""},{"id":1160330255,"node_id":"MDU6TGFiZWwxMTYwMzMwMjU1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7","name":"è‡ªåŠ¨åŒ–å·¥å…·","color":"f9c0d1","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-12-13T12:33:41Z","updated_at":"2019-06-15T02:27:31Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> å¾€æœŸæ–‡ç« ï¼š\r\n> - [ã€webpackè¿›é˜¶ã€‘å‰ç«¯è¿è¡Œæ—¶çš„æ¨¡å—åŒ–è®¾è®¡ä¸å®ç°](https://github.com/alienzhou/blog/issues/19)\r\n> - [ã€webpackè¿›é˜¶ã€‘ä½¿ç”¨babelé¿å…webpackç¼–è¯‘è¿è¡Œæ—¶æ¨¡å—ä¾èµ–](https://github.com/alienzhou/blog/issues/18)\r\n\r\n## å¼•è¨€\r\n\r\nwebpackçš„æˆåŠŸä¹‹å¤„ï¼Œä¸ä»…åœ¨äºå¼ºå¤§çš„æ‰“åŒ…æ„å»ºèƒ½åŠ›ï¼Œä¹Ÿåœ¨äºå®ƒçµæ´»çš„æ’ä»¶æœºåˆ¶ã€‚\r\n\r\nä¹Ÿè®¸ä½ äº†è§£è¿‡webpackçš„æ’ä»¶ä¸é’©å­æœºåˆ¶ï¼›ä½†ä½ æˆ–è®¸ä¸çŸ¥é“ï¼Œwebpackå†…éƒ¨æ‹¥æœ‰è¶…è¿‡180ä¸ªé’©å­ï¼Œè¿™äº›é’©å­ä¸æ¨¡å—ï¼ˆå†…ç½®æ’ä»¶ï¼‰ä¹‹é—´çš„ã€Œåˆ›å»ºã€ã€Œæ³¨å†Œã€ã€Œè°ƒç”¨ã€å…³ç³»éå¸¸å¤æ‚ã€‚å› æ­¤ï¼ŒæŒæ¡webpackå†…éƒ¨æ’ä»¶ä¸é’©å­é—´çš„å…³ç³»ä¼šå¸®åŠ©æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ç†è§£webpackçš„å†…éƒ¨æ‰§è¡Œæ–¹å¼ã€‚\r\n\r\nã€Œwebpackæ¨¡å—/å†…ç½®æ’ä»¶ä¸é’©å­å…³ç³»å›¾ğŸ“ˆã€ï¼šå¤æ‚æ€§ä¹Ÿå¯çª¥è§ä¸€æ–‘ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/9/29/16625513129661c2?w=2874&h=1636&f=png&s=2002331)\r\n\r\n---\r\n\r\næœ¬æ–‡çš„ç¬¬ä¸€éƒ¨åˆ†ä¼šå…ˆä»‹ç»é’©å­ï¼ˆhookï¼‰è¿™ä¸ªé‡è¦çš„æ¦‚å¿µä¸webpackæ’ä»¶çš„å·¥ä½œæ–¹å¼ã€‚ç„¶è€Œï¼Œç†Ÿæ‚‰çš„æœ‹å‹ä¼šå‘ç°ï¼Œè¿™ç§çµæ´»çš„æœºåˆ¶ä½¿å¾—webpackæ¨¡å—ä¹‹é—´çš„è”ç³»æ›´åŠ æ¾æ•£ä¸éè€¦åˆçš„åŒæ—¶ï¼Œè®©æƒ³è¦ç†æ¸…webpackå†…éƒ¨æºç ç»“æ„ä¸è”ç³»å˜å¾—æ›´å›°éš¾ã€‚\r\n\r\næ‰€ä»¥ï¼Œç¬¬äºŒéƒ¨åˆ†å°†ä¼šä»‹ç»webpackå†…éƒ¨æ’ä»¶ä¸é’©å­å…³ç³»çš„å¯è§†åŒ–å±•ç¤ºå·¥å…·ğŸ“ˆï¼Œç”¨ä¸€å¼ å›¾ç†æ¸…webpackå†…éƒ¨è¿™ç§é”™ç»¼å¤æ‚çš„å…³ç³»ã€‚\r\n\r\n**å¯è§†åŒ–å·¥å…·ä½¿ç”¨æ•ˆæœå›¾ï¼š**\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/9/29/16625b730faf4a62?w=800&h=511&f=gif&s=3405680)\r\n\r\n## 1. webpackçš„æ’ä»¶æœºåˆ¶\r\n\r\nåœ¨å…·ä½“ä»‹ç»webpackå†…ç½®æ’ä»¶ä¸é’©å­å¯è§†åŒ–å·¥å…·ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹webpackä¸­çš„æ’ä»¶æœºåˆ¶ã€‚\r\n\r\nwebpackå®ç°æ’ä»¶æœºåˆ¶çš„å¤§ä½“æ–¹å¼æ˜¯ï¼š\r\n\r\n- ã€Œåˆ›å»ºã€â€”â€” webpackåœ¨å…¶å†…éƒ¨å¯¹è±¡ä¸Šåˆ›å»ºå„ç§é’©å­ï¼›\r\n- ã€Œæ³¨å†Œã€â€”â€” æ’ä»¶å°†è‡ªå·±çš„æ–¹æ³•æ³¨å†Œåˆ°å¯¹åº”é’©å­ä¸Šï¼Œäº¤ç»™webpackï¼›\r\n- ã€Œè°ƒç”¨ã€â€”â€” webpackç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œä¼šé€‚æ—¶åœ°è§¦å‘ç›¸åº”é’©å­ï¼Œå› æ­¤ä¹Ÿå°±è§¦å‘äº†æ’ä»¶çš„æ–¹æ³•ã€‚\r\n\r\n\r\n## 1.1. Tapable\r\n\r\n[Tapable](https://github.com/webpack/tapable)å°±æ˜¯webpackç”¨æ¥åˆ›å»ºé’©å­çš„åº“ã€‚\r\n\r\n> The tapable packages exposes many Hook classes, which can be used to create hooks for plugins.\r\n\r\né€šè¿‡Tapableï¼Œå¯ä»¥å¿«é€Ÿåˆ›å»ºå„ç±»é’©å­ã€‚ä»¥ä¸‹æ˜¯å„ç§é’©å­çš„ç±»å‡½æ•°ï¼š\r\n\r\n```javascript\r\nconst {\r\n\tSyncHook,\r\n\tSyncBailHook,\r\n\tSyncWaterfallHook,\r\n\tSyncLoopHook,\r\n\tAsyncParallelHook,\r\n\tAsyncParallelBailHook,\r\n\tAsyncSeriesHook,\r\n\tAsyncSeriesBailHook,\r\n\tAsyncSeriesWaterfallHook\r\n} = require(\"tapable\");\r\n```\r\n\r\nä»¥æœ€ç®€å•çš„`SyncHook`ä¸ºä¾‹ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŒæ­¥çš„é’©å­ã€‚ä¸ºäº†å¸®åŠ©ç†è§£Tapableåˆ›å»ºé’©å­çš„ä½¿ç”¨æ–¹å¼ï¼Œæˆ‘ä»¬ä»¥ä¸€ä¸ªâ€œä¸‹ç­å›å®¶è¿›é—¨â€çš„æ¨¡æ‹Ÿåœºæ™¯æ¥ä»‹ç»Tapableæ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚\r\n\r\nç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ª`welcome.js`æ¨¡å—ï¼Œå®ƒè®¾å®šäº†æˆ‘ä»¬â€œè¿›é—¨å›å®¶â€çš„ä¸€ç³»åˆ—è¡Œä¸ºï¼ˆå¼€é—¨ã€è„±é‹â€¦ï¼‰ï¼š\r\n\r\n```javascript\r\n// welcome.js\r\nconst {SyncHook} = require('tapable');\r\n\r\nmodule.exports = class Welcome {\r\n    constructor(words) {\r\n        this.words = words;\r\n        this.sayHook = new SyncHook(['words']);\r\n    }\r\n\r\n    // è¿›é—¨å›å®¶çš„ä¸€ç³»åˆ—è¡Œä¸º\r\n    begin() {\r\n        console.log('å¼€é—¨');\r\n        console.log('è„±é‹');\r\n        console.log('è„±å¤–å¥—');\r\n        // æ‰“æ‹›å‘¼\r\n        this.sayHook.call(this.words);\r\n        console.log('å…³é—¨');\r\n    }\r\n}\r\n```\r\n\r\né¦–å…ˆï¼Œæˆ‘ä»¬åœ¨æ„é€ å‡½æ•°é‡Œåˆ›å»ºäº†ä¸€ä¸ªåŒæ­¥é’©å­`sayHook`ï¼Œå®ƒç”¨æ¥è¿›è¡Œä¹‹åçš„æ‰“æ‹›å‘¼ã€‚\r\n\r\nç„¶åï¼Œ`begin()`æ–¹æ³•æè¿°äº†æˆ‘ä»¬åˆšå›å®¶è¿›é—¨çš„ä¸€ç³»åˆ—åŠ¨ä½œï¼šå¼€é—¨ã€è„±é‹ã€è„±å¤–å¥—ã€å…³é—¨ã€‚å…¶ä¸­ï¼Œåœ¨ã€Œè„±å¤–å¥—ã€ä¸ã€Œå…³é—¨ã€ä¹‹é—´æ˜¯ä¸€ä¸ªæ‰“æ‹›å‘¼çš„è¡Œä¸ºï¼Œæˆ‘ä»¬åœ¨æ­¤è§¦å‘äº†`sayHook`é’©å­ï¼Œå¹¶å°†wordsä½œä¸ºå‚æ•°ä¼ å…¥å…¶ä¸­ã€‚\r\n\r\n> æ³¨æ„ï¼Œè¿™é‡Œçš„`.call()`çš„æ–¹æ³•æ˜¯Tapableæä¾›çš„è§¦å‘é’©å­çš„æ–¹æ³•ï¼Œä¸æ˜¯jsä¸­åŸç”Ÿçš„callæ–¹æ³•ã€‚\r\n\r\nè§¦å‘è¿™ä¸€ç³»åˆ—æµç¨‹ä¹Ÿéå¸¸ç®€å•ï¼š\r\n\r\n```JavaScript\r\n// run.js\r\nconst Welcome = require('./welcome');\r\nconst welcome = new Welcome('æˆ‘å›æ¥å•¦ï¼');\r\nwelcome.begin();\r\n\r\n/* output:\r\n * å¼€é—¨\r\n * è„±é‹\r\n * è„±å¤–å¥—\r\n * å…³é—¨\r\n * /\r\n```\r\n\r\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰ä¸åŒçš„æ‰“æ‹›å‘¼æ–¹å¼ â€”â€” â€œæ™®é€šåœ°æ‰“æ‹›å‘¼â€å’Œâ€œå¤§å–Šä¸€å£°â€ã€‚\r\n\r\nå¯¹åº”çš„æˆ‘ä»¬ä¼šæœ‰ä¸¤ä¸ªæ¨¡å—`say.js`å’Œ`shout.js`ï¼Œé€šè¿‡`.tap()`æ–¹æ³•åœ¨`sayHook`é’©å­ä¸Šæ³¨å†Œç›¸åº”æ–¹æ³•ã€‚\r\n\r\n```JavaScript\r\n// say.js\r\nmodule.exports = function (welcome) {\r\n    welcome.sayHook.tap('say', words => {\r\n        console.log('è½»å£°è¯´:', words);\r\n    });\r\n};\r\n\r\n// shout.js\r\nmodule.exports = function (welcome) {\r\n    welcome.sayHook.tap('shout', words => {\r\n        console.log('å‡ºå…¶ä¸æ„çš„å¤§å–Šä¸€å£°:', words);\r\n    });\r\n};\r\n```\r\n\r\næœ€åï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹`run.js`ï¼Œç»™`welcome`åº”ç”¨`shout.js`è¿™ä¸ªæ¨¡å—ã€‚\r\n\r\n```JavaScript\r\n// run.js\r\nconst Welcome = require('./welcome');\r\nconst applyShoutPlugin = require('./shout');\r\nconst welcome = new Welcome('æˆ‘å›æ¥å•¦ï¼');\r\napplyShoutPlugin(welcome);\r\nwelcome.begin();\r\n\r\n/* output:\r\n * å¼€é—¨\r\n * è„±é‹\r\n * è„±å¤–å¥—\r\n * å‡ºå…¶ä¸æ„çš„å¤§å–Šä¸€å£°: æˆ‘å›æ¥å•¦ï¼\r\n * å…³é—¨\r\n * /\r\n```\r\n\r\nè¿™æ ·ï¼Œæˆ‘ä»¬å°±æŠŠæ‰“æ‹›å‘¼çš„å®ç°æ–¹å¼ä¸welcomeè§£è€¦äº†ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨`say.js`æ¨¡å—ï¼Œç”šè‡³å’Œ`shout.js`ä¸¤è€…åŒæ—¶ä½¿ç”¨ã€‚è¿™å°±å¥½æ¯”åˆ›å»ºäº†ä¸€ä¸ªâ€œå¯æ’æ‹”â€çš„ç³»ç»Ÿæœºåˆ¶ â€”â€” æˆ‘å¯ä»¥æ ¹æ®éœ€æ±‚è‡ªä¸»é€‰æ‹©è¦ä¸è¦æ‰“æ‹›å‘¼ï¼Œè¦ç”¨ä»€ä¹ˆæ–¹å¼æ‰“æ‹›å‘¼ã€‚\r\n\r\nè™½ç„¶ä¸Šé¢çš„ä¾‹å­éå¸¸ç®€å•ï¼Œä½†æ˜¯å·²ç»å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç†è§£tapableçš„ä½¿ç”¨ä»¥åŠæ’ä»¶çš„æ€æƒ³ã€‚\r\n\r\n## 1.2. webpackä¸­çš„æ’ä»¶\r\n\r\nåœ¨ä»‹ç»webpackçš„æ’ä»¶æœºåˆ¶å‰ï¼Œå…ˆç®€å•å›é¡¾ä¸‹ä¸Šé¢â€œè¿›é—¨å›å®¶â€ä¾‹å­ï¼š\r\n\r\n- æˆ‘ä»¬çš„`Welcome`ç±»æ˜¯ä¸»è¦çš„åŠŸèƒ½ç±»ï¼Œå…¶ä¸­åŒ…å«å…·ä½“çš„åŠŸèƒ½å‡½æ•°`begin()`ä¸é’©å­`sayHook`ï¼›\r\n- `run.js`æ¨¡å—è´Ÿè´£æ‰§è¡Œæµç¨‹ï¼Œæ§åˆ¶ä»£ç æµï¼›\r\n- æœ€åï¼Œ`say.js`å’Œ`shout.js`æ˜¯ç‹¬ç«‹çš„â€œå¯æ’å…¥â€æ¨¡å—ã€‚æ ¹æ®éœ€è¦ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªä¸»é™„åŠ åˆ°ä¸»æµç¨‹ä¸­ã€‚\r\n\r\nç†è§£äº†ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œå°±å¯ä»¥å¾ˆå¥½åœ°ç±»æ¯”åˆ°webpackä¸­ï¼š\r\n\r\nä¾‹å¦‚ï¼Œwebpackä¸­æœ‰ä¸€ä¸ªé‡è¦çš„ç±» â€”â€” `Compiler`ï¼Œå®ƒåˆ›å»ºäº†éå¸¸å¤šçš„é’©å­ï¼Œè¿™äº›é’©å­å°†ä¼šæ•£è½åœ¨â€œå„åœ°â€è¢«è°ƒç”¨ï¼ˆcallï¼‰ã€‚å®ƒå°±ç±»ä¼¼äºæˆ‘ä»¬çš„`Welcome`ç±»ã€‚\r\n\r\n```JavaScript\r\n// Compilerç±»ä¸­çš„éƒ¨åˆ†é’©å­\r\n\r\nthis.hooks = {\r\n    /** @type {SyncBailHook<Compilation>} */\r\n    shouldEmit: new SyncBailHook([\"compilation\"]),\r\n    /** @type {AsyncSeriesHook<Stats>} */\r\n    done: new AsyncSeriesHook([\"stats\"]),\r\n    /** @type {AsyncSeriesHook<>} */\r\n    additionalPass: new AsyncSeriesHook([]),\r\n    /** @type {AsyncSeriesHook<Compiler>} */\r\n    beforeRun: new AsyncSeriesHook([\"compiler\"]),\r\n    /** @type {AsyncSeriesHook<Compiler>} */\r\n    run: new AsyncSeriesHook([\"compiler\"]),\r\n    /** @type {AsyncSeriesHook<Compilation>} */\r\n    emit: new AsyncSeriesHook([\"compilation\"]),\r\n    â€¦â€¦\r\n}\r\n```\r\n\r\nç„¶åï¼Œwebpackä¸­çš„æ’ä»¶ä¼šå°†æ‰€éœ€æ‰§è¡Œçš„å‡½æ•°é€šè¿‡ `.tap()` / `.tapAsync()` / `.tapPromise()` ç­‰æ–¹æ³•æ³¨å†Œåˆ°å¯¹åº”é’©å­ä¸Šã€‚è¿™æ ·ï¼Œwebpackè°ƒç”¨ç›¸åº”é’©å­æ—¶ï¼Œæ’ä»¶ä¸­çš„å‡½æ•°å°±ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚\r\n\r\né‚£ä¹ˆï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šwebpackæ˜¯å¦‚ä½•è°ƒç”¨æ’ä»¶ï¼Œå°†æ’ä»¶ä¸­çš„æ–¹æ³•åœ¨ç¼–è¯‘é˜¶æ®µæ³¨å†Œåˆ°é’©å­ä¸Šçš„å‘¢ï¼Ÿ\r\n\r\nå¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œwebpackè§„å®šæ¯ä¸ªæ’ä»¶çš„å®ä¾‹ï¼Œå¿…é¡»æœ‰ä¸€ä¸ª`.apply()`æ–¹æ³•ï¼Œwebpackæ‰“åŒ…å‰ä¼šè°ƒç”¨æ‰€æœ‰æ’ä»¶çš„`.apply()`æ–¹æ³•ï¼Œæ’ä»¶å¯ä»¥åœ¨è¯¥æ–¹æ³•ä¸­è¿›è¡Œé’©å­çš„æ³¨å†Œã€‚\r\n\r\nåœ¨webpackçš„[`lib/webpack.js`](https://github.com/webpack/webpack/blob/master/lib/webpack.js#L42-L50)ä¸­ï¼Œæœ‰å¦‚ä¸‹ä»£ç ï¼š\r\n\r\n```JavaScript\r\nif (options.plugins && Array.isArray(options.plugins)) {\r\n    for (const plugin of options.plugins) {\r\n        plugin.apply(compiler);\r\n    }\r\n}\r\n```\r\n\r\nä¸Šé¢è¿™æ®µä»£ç ä¼šä»webpacké…ç½®çš„`plugins`å­—æ®µä¸­å–å‡ºæ‰€æœ‰æ’ä»¶çš„å®ä¾‹ï¼Œç„¶åè°ƒç”¨å…¶`.apply()`æ–¹æ³•ï¼Œå¹¶å°†`Compiler`çš„å®ä¾‹ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆwebpackè¦æ±‚æˆ‘ä»¬æ‰€æœ‰æ’ä»¶éƒ½éœ€è¦æä¾›`.apply()`æ–¹æ³•ï¼Œå¹¶åœ¨å…¶ä¸­è¿›è¡Œé’©å­çš„æ³¨å†Œã€‚\r\n\r\n> æ³¨æ„ï¼Œå’Œ`.call()`ä¸€æ ·ï¼Œè¿™é‡Œçš„`.apply()`ä¹Ÿä¸æ˜¯jsçš„åŸç”Ÿæ–¹æ³•ã€‚ä½ ä¼šåœ¨æºç ä¸­çœ‹åˆ°è®¸å¤š`.call()`ä¸`.apply()`ï¼Œä½†å®ƒä»¬åŸºæœ¬éƒ½ä¸æ˜¯ä½ è®¤è¯†çš„é‚£ä¸ªæ–¹æ³•ã€‚\r\n\r\n## 2. ç¼–è¯‘æœŸï¼ˆCompilerä¸­ï¼‰é’©å­çš„è§¦å‘æµç¨‹\r\n\r\nç›®å‰ï¼Œç½‘ä¸Šå·²ç»æœ‰äº†ä¸€äº›è§£æwebpackçš„ä¼˜è´¨æ–‡ç« ã€‚å…¶ä¸­ä¹Ÿä¸ä¹å¯¹webpackç¼–è¯‘æµç¨‹æ•´ç†ä¸ä»‹ç»çš„æ–‡ç« ã€‚\r\n\r\nä½†æ˜¯ï¼Œç”±äºæˆ‘è¿‘æœŸçš„å·¥ä½œä¸å…´è¶£åŸå› ï¼Œéœ€è¦å¯¹webpackå†…éƒ¨çš„æ‰§è¡Œæ­¥éª¤ä¸ç»†èŠ‚åšä¸€äº›è¾ƒä¸ºæ·±å…¥çš„è°ƒç ”ï¼ŒåŒ…æ‹¬å„ç§é’©å­ä¸æ–¹æ³•çš„æ³¨å†Œã€è§¦å‘æ—¶æœºã€æ¡ä»¶ç­‰ç­‰ã€‚ç›®å‰çš„ä¸€äº›æ–‡ç« å†…å®¹å¯èƒ½ä¸è¶³ä»¥æ”¯æŒï¼Œæ®æ­¤åšäº†ä¸€å®šçš„æ•´ç†å·¥ä½œã€‚\r\n\r\n### 2.1. ä¸€å¼ å¾…å®Œå–„çš„å›¾\r\n\r\nä¸‹é¢æ˜¯æˆ‘ä¹‹å‰æ¢³ç†çš„`Compiler`ä¸­`.run()`æ–¹æ³•ï¼ˆç¼–è¯‘çš„å¯åŠ¨æ–¹æ³•ï¼‰çš„æ‰§è¡Œæµç¨‹åŠé’©å­è§¦å‘æƒ…å†µï¼ˆå›¾ä¸­åªæ¶‰åŠäº†ä¸€éƒ¨åˆ†compilationçš„ç›¸å…³é’©å­ï¼Œå®Œæ•´ç‰ˆè¿˜éœ€è¿›ä¸€æ­¥æ•´ç†ï¼‰ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/9/29/166255f64585604f?w=7913&h=9314&f=png&s=2967412)\r\n\r\nä½†æ˜¯æ¢³ç†è¿‡ç¨‹ä¸­å…¶å®å‡ºç°äº†ä¸€äº›å›°éš¾ã€‚å¦‚æœä½ ä¹Ÿæ›¾ç»æƒ³è¦ä»”ç»†é˜…è¯»webpackæºç å¹¶æ¢³ç†å†…éƒ¨å„ä¸ªæ¨¡å—ä¸æ’ä»¶æ‰§è¡Œæµç¨‹ä¸å…³ç³»ï¼Œå¯èƒ½ä¹Ÿä¼šç¢°åˆ°å’Œæˆ‘ä¸€æ ·çš„éº»çƒ¦ã€‚ä¸‹é¢å°±æ¥è¯´ä¸€ä¸‹ï¼š\r\n\r\n### 2.2. æ’ä»¶ä¸é’©å­æœºåˆ¶å¸¦æ¥çš„é—®é¢˜\r\n\r\né¦–å…ˆï¼Œå¯ä»¥çœ‹åˆ°ç”±äºå›¾æ¯”è¾ƒç»†ï¼Œæ‰€ä»¥å®ƒä¼šæ¯”ç½‘ä¸Šå¸¸è§çš„æ•´ä½“æµç¨‹å›¾è¦å¤æ‚ï¼›ä½†æ˜¯ï¼Œå³ä½¿åªç®—ä¸Šwebpackå¸¸ç”¨æ’ä»¶ã€`compiler`é’©å­ä¸`compilation`é’©å­ï¼Œè¿™å¼ å›¾ä¹Ÿåªç®—æ˜¯å…¶ä¸­ä¸€å°éƒ¨åˆ†ã€‚æ›´ä¸ç”¨è¯´å¦å¤–ä¸Šç™¾ä¸ªä½ å¯èƒ½ä»æœªæ¥è§¦è¿‡çš„é’©å­ã€‚è¿™äº›æ¨¡å—ä¸é’©å­äº¤ç»‡å‡ºäº†ä¸€ä¸ªå¤æ‚çš„webpackç³»ç»Ÿã€‚\r\n\r\nå…¶æ¬¡ï¼Œåœ¨æºç é˜…è¯»ä¸æ•´ç†çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜ä¼šé‡åˆ°å‡ ä¸ªé—®é¢˜ï¼š\r\n\r\n- **è”ç³»æ¾æ•£**ã€‚æ ¹æ®ä»¥ä¸Šçš„ä¾‹å­ï¼Œä½ å¯ä»¥å‘ç°ï¼šä½¿ç”¨tapableé’©å­ç±»ä¼¼äº‹ä»¶ç›‘å¬æ¨¡å¼ï¼Œè™½ç„¶èƒ½æœ‰æ•ˆè§£è€¦ï¼Œä½†é’©å­çš„æ³¨å†Œä¸è°ƒç”¨å‡ ä¹å®Œå…¨æ— å…³ï¼Œå¾ˆéš¾å°†ä¸€ä¸ªé’©å­çš„â€œåˆ›å»º - æ³¨å†Œ - è°ƒç”¨â€è¿‡ç¨‹æœ‰æ•ˆè”ç³»èµ·æ¥ã€‚\r\n\r\n- **æ¨¡å—äº¤äº’åŸºäºé’©å­**ã€‚webpackå†…éƒ¨æ¨¡å—ä¸æ’ä»¶åœ¨å¾ˆå¤šæ—¶å€™ï¼Œæ˜¯é€šè¿‡é’©å­æœºåˆ¶æ¥è¿›è¡Œè”ç³»ä¸è°ƒç”¨çš„ã€‚ä½†æ˜¯ï¼ŒåŸºäºé’©å­çš„æ¨¡å¼æ˜¯æ¾æ•£çš„ã€‚ä¾‹å¦‚ä½ çœ‹åˆ°æºç é‡Œä¸€ä¸ªæ¨¡å—æä¾›äº†å‡ ä¸ªé’©å­ï¼Œä½†ä½ å¹¶ä¸çŸ¥é“ï¼Œåœ¨ä½•æ—¶ã€ä½•åœ°è¯¥é’©å­ä¼šè¢«è°ƒç”¨ï¼Œåˆåœ¨ä½•æ—¶ã€ä½•åœ°é’©å­ä¸Šè¢«æ³¨å†Œäº†å“ªäº›æ–¹æ³•ã€‚è¿™äº›ä»¥å¾€éƒ½æ˜¯éœ€è¦æˆ‘ä»¬é€šè¿‡åœ¨ä»£ç åº“ä¸­æœç´¢å…³é”®è¯æ¥è§£å†³ã€‚\r\n\r\n- **é’©å­æ•°é‡ä¼—å¤š**ã€‚webpackå†…éƒ¨çš„é’©å­éå¸¸å¤šï¼Œæ•°é‡è¾¾åˆ°äº†180+ï¼Œç±»å‹ä¹Ÿäº”èŠ±å…«é—¨ã€‚é™¤äº†å®˜ç½‘åˆ—å‡ºçš„`compiler`ä¸`compilation`ä¸­é‚£äº›å¸¸ç”¨çš„é’©å­ï¼Œè¿˜å­˜åœ¨ç€ä¼—å¤šå…¶ä»–å¯ä»¥ä½¿ç”¨çš„é’©å­ã€‚æœ‰äº›æœ‰ç”¨çš„é’©å­ä½ å¯èƒ½æ— ä»çŸ¥æ™“ï¼Œä¾‹å¦‚æˆ‘æœ€è¿‘ç”¨åˆ°çš„`localVars`ã€`requireExtensions`ç­‰é’©å­ã€‚\r\n\r\n- **å†…ç½®æ’ä»¶ä¼—å¤š**ã€‚webpack v4+ æœ¬èº«å†…ç½®äº†è®¸å¤šæ’ä»¶ã€‚å³ä½¿éæ’ä»¶ï¼Œwebpackçš„æ¨¡å—è‡ªèº«ä¹Ÿç»å¸¸ä½¿ç”¨tapableé’©å­æ¥äº¤äº’ã€‚ç”šè‡³å¯ä»¥è®¤ä¸ºï¼Œwebpacké¡¹ç›®ä¸­çš„å„ä¸ªæ¨¡å—éƒ½æ˜¯â€œæ’ä»¶åŒ–â€çš„ã€‚è¿™ä¹Ÿä½¿å¾—å‡ ä¹æ¯ä¸ªæ¨¡å—éƒ½ä¼šå’Œå„ç§é’©å­â€œæ‰“äº¤é“â€ã€‚\r\n\r\n\r\nè¿™äº›é—®é¢˜å¯¼è‡´äº†æƒ³è¦å…¨é¢äº†è§£webpackä¸­æ¨¡å—/æ’ä»¶é—´ä½œç”¨å…³ç³»ï¼ˆæ ¸å¿ƒæ˜¯ä¸é’©å­çš„å…³ç³»ï¼‰å…·æœ‰ä¸€å®šçš„å›°éš¾ã€‚ä¸ºäº†å¸®åŠ©ç†è§£ä¸é˜…è¯»webpackæºç ã€ç†æ¸…å…³ç³»ï¼Œæˆ‘åˆ¶ä½œäº†ä¸€ä¸ªå°å·¥å…·æ¥å¯è§†åŒ–å±•ç¤ºå†…ç½®æ’ä»¶ä¸é’©å­ä¹‹é—´çš„å…³ç³»ï¼Œå¹¶æ”¯æŒé€šè¿‡äº¤äº’æ“ä½œè¿›ä¸€æ­¥è·å–æºç ä¿¡æ¯ã€‚\r\n\r\n## 3. Webpack Internal Plugin Relation\r\n\r\n[Webpack-Internal-Plugin-Relation](https://github.com/alienzhou/webpack-internal-plugin-relation)æ˜¯ä¸€ä¸ªå¯ä»¥å±•ç°webpackå†…éƒ¨æ¨¡å—ï¼ˆæ’ä»¶ï¼‰ä¸é’©å­é—´å…³ç³»çš„å·¥å…·ã€‚æ–‡ç« å¼€å¤´å±•ç¤ºçš„åŠ¨å›¾å°±æ˜¯å…¶åŠŸèƒ½ä¸ä½¿ç”¨æ•ˆæœã€‚\r\n\r\n> githubä»“åº“åœ°å€ï¼š[https://github.com/alienzhou/webpack-internal-plugin-relation](https://github.com/alienzhou/webpack-internal-plugin-relation)\r\n> å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ [åœ¨çº¿æ¼”ç¤º](https://alienzhou.github.io/webpack-internal-plugin-relation/) \r\n\r\n### 3.1. å…³ç³»ç±»å‹\r\n\r\næ¨¡å—/æ’ä»¶ä¸é’©å­çš„å…³ç³»ä¸»è¦åˆ†ä¸ºä¸‰ç±»ï¼š\r\n\r\n- æ¨¡å—/æ’ä»¶ã€Œåˆ›å»ºã€é’©å­ï¼Œå¦‚`this.hooks.say = new SyncHook()`ï¼›\r\n- æ¨¡å—/æ’ä»¶å°†æ–¹æ³•ã€Œæ³¨å†Œã€åˆ°é’©å­ä¸Šï¼Œå¦‚`obj.hooks.say.tap('one', () => {...})`;\r\n- æ¨¡å—/æ’ä»¶é€šè¿‡ã€Œè°ƒç”¨ã€æ¥è§¦å‘é’©å­äº‹ä»¶ï¼Œå¦‚`obj.hooks.say.call()`ã€‚\r\n\r\n### 3.2. æ•ˆæœæ¼”ç¤º\r\n\r\nå¯ä»¥è¿›è¡Œæ¨¡å—/æ’ä»¶ä¸é’©å­ä¹‹é—´çš„å…³ç³»å±•ç¤ºï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/9/29/16625b6e741edc52?w=800&h=511&f=gif&s=2956252)\r\n\r\nå¯ä»¥é€šè¿‡ç‚¹å‡»ç­‰äº¤äº’ï¼Œå±•ç¤ºæ¨¡å—å†…é’©å­ä¿¡æ¯ï¼ŒåŒå‡»ç›´æ¥è·³è½¬è‡³webpackç›¸åº”æºç å¤„ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/9/29/16625b730faf4a62?w=800&h=511&f=gif&s=3405680)\r\n\r\nç”±äºå…³ç³»éå¸¸å¤æ‚ï¼ˆ600+å…³ç³»ï¼‰ï¼Œå¯ä»¥å¯¹å…³ç³»ç±»å‹è¿›è¡Œç­›é€‰ï¼Œåªå±•ç¤ºå…³å¿ƒçš„å†…å®¹ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/9/30/16628a3932c5b50b?w=800&h=511&f=gif&s=3368092)\r\n\r\n### 3.3. å·¥å…·åŒ…å«çš„åŠŸèƒ½\r\n\r\nå…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªå·¥å…·åŒ…å«çš„åŠŸèƒ½ä¸»è¦åŒ…æ‹¬ï¼š\r\n\r\n- **å…³ç³»æ”¶é›†**ï¼š\r\n    - æ”¶é›†æ¨¡å—ä¸­hookçš„åˆ›å»ºä¿¡æ¯ï¼Œå³é’©å­çš„åˆ›å»ºä¿¡æ¯ï¼›\r\n    - æ”¶é›†æ¨¡å—ä¸­hookçš„æ³¨å†Œä¿¡æ¯ï¼Œè®°å½•å“ªäº›æ¨¡å—å¯¹å“ªäº›é’©å­è¿›è¡Œäº†æ³¨å†Œï¼›\r\n    - æ”¶é›†æ¨¡å—ä¸­hookçš„è°ƒç”¨ä¿¡æ¯ï¼Œå³é’©å­æ˜¯åœ¨ä»£ç ä¸­çš„å“ªä¸€è¡Œè§¦å‘çš„ï¼›\r\n    - ç”ŸæˆåŒ…å«ã€Œæ¨¡å—ä¿¡æ¯ã€ã€ã€Œé’©å­ä¿¡æ¯ã€ã€ã€Œæºç ä½ç½®ä¿¡æ¯ã€ç­‰åŸå§‹æ•°æ®çš„æ–‡ä»¶ã€‚\r\n\r\n- **å¯è§†åŒ–å±•ç¤º**ï¼š\r\n    - ä½¿ç”¨åŠ›å¯¼å‘å›¾å¯è§†åŒ–å±•ç¤ºæ’ä»¶ã€é’©å­é—´å…³ç³»ã€‚å¯ä»¥çœ‹åˆ°ç›®å‰webpack v4ä¸­æœ‰è¶…è¿‡180ä¸ªé’©å­ä¸è¶…è¿‡130ä¸ªæ¨¡å—ï¼›\r\n    - å±•ç¤ºæ‰€æœ‰æ¨¡å—ä¸é’©å­åˆ—è¡¨ã€‚\r\n\r\n- **äº¤äº’ä¿¡æ¯**ï¼š\r\n    - æ”¯æŒå¯¹åŠ›å¯¼å‘å›¾ä¸­èŠ‚ç‚¹çš„å±•ç°è¿›è¡Œç­›é€‰ï¼›\r\n    - é€šè¿‡å•å‡»javascript moduleç±»èŠ‚ç‚¹ï¼Œå¯åœ¨å·¦ä¸‹è§’æŸ¥çœ‹æ¨¡å—çš„è¯¦ç»†ä¿¡æ¯ï¼›\r\n    - åŒå‡»javascript moduleç±»èŠ‚ç‚¹ï¼Œå¯ç›´æ¥æ‰“å¼€webpackå¯¹åº”æºç æŸ¥çœ‹ï¼›\r\n    - åŒå‡»èŠ‚ç‚¹é—´å…³ç³»ï¼Œå¯ç›´æ¥æ‰“å¼€å¹¶å®šä½æºç å…·ä½“è¡Œæ•°ï¼Œè¿›è¡ŒæŸ¥çœ‹ï¼›\r\n    - å¯ä»¥é€‰æ‹©è¦æŸ¥çœ‹çš„å…³ç³»ï¼šåˆ›å»º-contain / æ³¨å†Œ-register / è°ƒç”¨-callã€‚\r\n\r\n### 3.4. åŸºäºåŸå§‹æ•°æ®å®šåˆ¶è‡ªå·±çš„åŠŸèƒ½\r\n\r\nç›®å‰ï¼Œå·¥å…·ä¼šå°†åŸå§‹çš„é‡‡é›†ç»“æœéƒ½ä¿ç•™ä¸‹æ¥ã€‚å› æ­¤ï¼Œå¦‚æœä½ å¹¶ä¸éœ€è¦å¯è§†åŒ–å±•ç¤ºï¼Œæˆ–è€…æœ‰è‡ªå·±çš„å®šåˆ¶åŒ–éœ€æ±‚ï¼Œé‚£ä¹ˆå®Œå…¨å¯ä»¥åŸºäºè¿™äº›ä¿¡æ¯è¿›è¡Œå¤„ç†ï¼Œç”¨äºä½ æ‰€éœ€çš„åœ°æ–¹ã€‚æ¨¡å—çš„åŸå§‹ä¿¡æ¯ç»“æ„å¦‚ä¸‹ï¼š\r\n\r\n```javascript\r\n\"lib/MultiCompiler.js\": {\r\n  \"hooks\": [\r\n    {\r\n      \"name\": \"done\",\r\n      \"line\": 17\r\n    },\r\n    {\r\n      \"name\": \"invalid\",\r\n      \"line\": 18\r\n    },\r\n    {\r\n      \"name\": \"run\",\r\n      \"line\": 19\r\n    },\r\n    {\r\n      \"name\": \"watchClose\",\r\n      \"line\": 20\r\n    },\r\n    {\r\n      \"name\": \"watchRun\",\r\n      \"line\": 21\r\n    }\r\n  ],\r\n  \"taps\": [\r\n    {\r\n      \"hook\": \"done\",\r\n      \"type\": \"tap\",\r\n      \"plugin\": \"MultiCompiler\",\r\n      \"line\": 37\r\n    },\r\n    {\r\n      \"hook\": \"invalid\",\r\n      \"type\": \"tap\",\r\n      \"plugin\": \"MultiCompiler\",\r\n      \"line\": 48\r\n    }\r\n  ],\r\n  \"calls\": [\r\n    {\r\n      \"hook\": \"done\",\r\n      \"type\": \"call\",\r\n      \"line\": 44\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n## 4. å°¾å£°\r\n\r\nè¿™ä¸ª[Webpack-Internal-Plugin-Relation](https://github.com/alienzhou/webpack-internal-plugin-relation)çš„å°å·¥å…·ä¸»è¦é€šè¿‡ï¼š\r\n\r\n1. éå†webpackæºç æ¨¡å—æ–‡ä»¶\r\n2. è¯­æ³•åˆ†æè·å–é’©å­ç›¸å…³ä¿¡æ¯\r\n3. åŠ å·¥åŸå§‹é‡‡é›†ä¿¡æ¯ï¼Œè½¬æ¢ä¸ºåŠ›å¯¼å‘å›¾æ‰€éœ€æ ¼å¼\r\n4. åŸºäºåŠ›å¯¼å‘å›¾æ•°æ®æ„å»ºå‰ç«¯webå¯è§†åŒ–æœåŠ¡\r\n5. æœ€åå†è¾…ä»¥ä¸€äº›äº¤äº’åŠŸèƒ½\r\n\r\nç›®å‰æˆ‘åœ¨ä½¿ç”¨å®ƒå¸®åŠ©é˜…è¯»ä¸æ•´ç†webapckæºç ä¸ç¼–è¯‘æµç¨‹ã€‚ä¹Ÿè®¸æœ‰äº›æœ‹å‹ä¹Ÿç¢°åˆ°äº†ç±»ä¼¼é—®é¢˜ï¼Œåˆ†äº«å‡ºæ¥å¸Œæœ›å®ƒä¹Ÿèƒ½åœ¨æŸäº›æ–¹é¢å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚å¦‚æœä½ ä¹Ÿå¯¹webpackæˆ–è€…è¿™ä¸ªå·¥å…·æ„Ÿå…´è¶£ï¼Œå¸Œæœ›èƒ½å¤šå¤šæ”¯æŒæˆ‘çš„æ–‡ç« å’Œå·¥å…·ï¼Œä¸€åŒäº¤æµå­¦ä¹ ï½ğŸ˜Š\r\n\r\n\r\n## å‘Šåˆ«ã€Œwebpacké…ç½®å·¥ç¨‹å¸ˆã€\r\n\r\n> å†™åœ¨æœ€åã€‚\r\n\r\nwebpackæ˜¯ä¸€ä¸ªå¼ºå¤§è€Œå¤æ‚çš„å‰ç«¯è‡ªåŠ¨åŒ–å·¥å…·ã€‚å…¶ä¸­ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯é…ç½®å¤æ‚ï¼Œè¿™ä¹Ÿä½¿å¾—ã€Œwebpacké…ç½®å·¥ç¨‹å¸ˆã€è¿™ç§æˆè°‘çš„ç§°å‘¼å¼€å§‹æµè¡ŒğŸ¤·ä½†æ˜¯ï¼Œéš¾é“ä½ çœŸçš„åªæ»¡è¶³äºç©è½¬webpacké…ç½®ä¹ˆï¼Ÿ\r\n\r\næ˜¾ç„¶ä¸æ˜¯ã€‚åœ¨å­¦ä¹ å¦‚ä½•ä½¿ç”¨webpackä¹‹å¤–ï¼Œæˆ‘ä»¬æ›´éœ€è¦æ·±å…¥webpackå†…éƒ¨ï¼Œæ¢ç´¢å„éƒ¨åˆ†çš„è®¾è®¡ä¸å®ç°ã€‚ä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œå³ä½¿æœ‰ä¸€å¤©webpackâ€œè¿‡æ°”â€äº†ï¼Œä½†å®ƒçš„æŸäº›è®¾è®¡ä¸å®ç°å´ä»ä¼šæœ‰å­¦ä¹ ä»·å€¼ä¸å€Ÿé‰´æ„ä¹‰ã€‚å› æ­¤ï¼Œåœ¨å­¦ä¹ webpackè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¼šæ€»ç»“ä¸€ç³»åˆ—ã€webpackè¿›é˜¶ã€‘çš„æ–‡ç« å’Œå¤§å®¶åˆ†äº«ã€‚\r\n\r\næ¬¢è¿æ„Ÿå…´è¶£çš„åŒå­¦å¤šå¤šäº¤æµä¸å…³æ³¨ï¼\r\n\r\n> å¾€æœŸæ–‡ç« ï¼š\r\n> - [ã€webpackè¿›é˜¶ã€‘å‰ç«¯è¿è¡Œæ—¶çš„æ¨¡å—åŒ–è®¾è®¡ä¸å®ç°](https://github.com/alienzhou/blog/issues/19)\r\n> - [ã€webpackè¿›é˜¶ã€‘ä½¿ç”¨babelé¿å…webpackç¼–è¯‘è¿è¡Œæ—¶æ¨¡å—ä¾èµ–](https://github.com/alienzhou/blog/issues/18)","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/19","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/19/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/19/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/19/events","html_url":"https://github.com/alienzhou/blog/issues/19","id":390658016,"node_id":"MDU6SXNzdWUzOTA2NTgwMTY=","number":19,"title":"ã€webpackè¿›é˜¶ã€‘å‰ç«¯è¿è¡Œæ—¶çš„æ¨¡å—åŒ–è®¾è®¡ä¸å®ç°","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845019,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE5","url":"https://api.github.com/repos/alienzhou/blog/labels/Webpack","name":"Webpack","color":"e4e669","default":false,"description":""},{"id":1160330255,"node_id":"MDU6TGFiZWwxMTYwMzMwMjU1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7","name":"è‡ªåŠ¨åŒ–å·¥å…·","color":"f9c0d1","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T12:31:36Z","updated_at":"2018-12-13T12:55:34Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> ä½ çœŸçš„äº†è§£å‰ç«¯æ¨¡å—åŒ–ä¹ˆï¼Ÿ\r\n\r\n## å‘Šåˆ«ã€Œwebpacké…ç½®å·¥ç¨‹å¸ˆã€\r\nwebpackæ˜¯ä¸€ä¸ªå¼ºå¤§è€Œå¤æ‚çš„å‰ç«¯è‡ªåŠ¨åŒ–å·¥å…·ã€‚å…¶ä¸­ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯é…ç½®å¤æ‚ï¼Œè¿™ä¹Ÿä½¿å¾—ã€Œwebpacké…ç½®å·¥ç¨‹å¸ˆã€è¿™ç§æˆè°‘çš„ç§°å‘¼å¼€å§‹æµè¡ŒğŸ¤·ä½†æ˜¯ï¼Œéš¾é“ä½ çœŸçš„åªæ»¡è¶³äºç©è½¬webpacké…ç½®ä¹ˆï¼Ÿ\r\n\r\næ˜¾ç„¶ä¸æ˜¯ã€‚åœ¨å­¦ä¹ å¦‚ä½•ä½¿ç”¨webpackä¹‹å¤–ï¼Œæˆ‘ä»¬æ›´éœ€è¦æ·±å…¥webpackå†…éƒ¨ï¼Œæ¢ç´¢å„éƒ¨åˆ†çš„è®¾è®¡ä¸å®ç°ã€‚ä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œå³ä½¿æœ‰ä¸€å¤©webpackâ€œè¿‡æ°”â€äº†ï¼Œä½†å®ƒçš„æŸäº›è®¾è®¡ä¸å®ç°å´ä»ä¼šæœ‰å­¦ä¹ ä»·å€¼ä¸å€Ÿé‰´æ„ä¹‰ã€‚å› æ­¤ï¼Œåœ¨å­¦ä¹ webpackè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¼šæ€»ç»“ä¸€ç³»åˆ—ã€webpackè¿›é˜¶ã€‘çš„æ–‡ç« å’Œå¤§å®¶åˆ†äº«ã€‚\r\n\r\næ¬¢è¿æ„Ÿå…´è¶£çš„åŒå­¦å¤šå¤šäº¤æµä¸å…³æ³¨ï¼\r\n\r\n## 1. å¼•è¨€\r\n\r\nä¸‹é¢è¿›å…¥æ­£é¢˜ã€‚ä¸€ç›´ä»¥æ¥ï¼Œåœ¨å‰ç«¯é¢†åŸŸï¼Œå¼€å‘äººå‘˜æ—¥ç›Šå¢é•¿çš„è¯­è¨€èƒ½åŠ›éœ€æ±‚å’Œè½åçš„JavaScriptè§„èŒƒå½¢æˆäº†ä¸€å¤§çŸ›ç›¾ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä¼šç”¨babelæ¥è¿›è¡ŒES6åˆ°ES5çš„è¯­æ³•è½¬æ¢ï¼Œä¼šä½¿ç”¨å„ç§polyfillæ¥å…¼å®¹è€å¼ä¸Šçš„æ–°ç‰¹æ€§â€¦â€¦è€Œæˆ‘ä»¬æœ¬æ–‡çš„ä¸»è§’ â€”â€” æ¨¡å—åŒ–ä¹Ÿæ˜¯å¦‚æ­¤ã€‚\r\n\r\nç”±äºJavaScriptåœ¨è®¾è®¡ä¹‹åˆå°±æ²¡æœ‰è€ƒè™‘è¿™ä¸€ç‚¹ï¼ŒåŠ ä¹‹æ¨¡å—åŒ–è§„èŒƒçš„è¿Ÿåˆ°ï¼Œå¯¼è‡´ç¤¾åŒºä¸­æ¶Œç°å‡ºä¸€ç³»åˆ—å‰ç«¯è¿è¡Œæ—¶çš„æ¨¡å—åŒ–æ–¹æ¡ˆï¼Œä¾‹å¦‚RequireJSã€seaJSç­‰ã€‚ä»¥åŠä¸ä¹‹å¯¹åº”çš„ç¼–è¯‘æœŸæ¨¡å—ä¾èµ–è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚browserifyã€rollupå’Œæœ¬æ–‡çš„ä¸»è§’webpackã€‚\r\n\r\nä½†æ˜¯æˆ‘ä»¬è¦çŸ¥é“ï¼Œ`<script type=\"module\">`è¿˜å­˜åœ¨ä¸€å®šçš„å…¼å®¹æ€§ä¸ä½¿ç”¨é—®é¢˜ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/8/27/1657be864c854472?w=2348&h=1252&f=png&s=273693)\r\n\r\nåœ¨æ›´é€šç”¨çš„èŒƒå›´å†…æ¥è®²ï¼Œæµè§ˆå™¨åŸç”Ÿå®é™…æ˜¯ä¸æ”¯æŒæ‰€è°“çš„CommonJSæˆ–ESMæ¨¡å—åŒ–è§„èŒƒçš„ã€‚é‚£ä¹ˆwebpackæ˜¯å¦‚ä½•åœ¨æ‰“åŒ…å‡ºçš„ä»£ç ä¸­å®ç°æ¨¡å—åŒ–çš„å‘¢ï¼Ÿ\r\n\r\n\r\n## 2. NodeJSä¸­çš„æ¨¡å—åŒ–\r\n\r\nåœ¨æ¢ç©¶webpackæ‰“åŒ…åä»£ç çš„æ¨¡å—åŒ–å®ç°å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹Nodeä¸­çš„æ¨¡å—åŒ–ã€‚\r\n\r\nNodeJSï¼ˆä»¥ä¸‹ç®€ç§°ä¸ºNodeï¼‰åœ¨æ¨¡å—åŒ–ä¸ŠåŸºæœ¬æ˜¯éµå¾ªçš„CommonJSè§„èŒƒï¼Œè€Œwebpackæ‰“åŒ…å‡ºæ¥çš„ä»£ç æ‰€å®ç°æ¨¡å—åŒ–çš„æ–¹å¼ï¼Œä¹Ÿç±»ä¼¼äºCommonJSã€‚å› æ­¤ï¼Œæˆ‘ä»¬å…ˆä»¥ç†Ÿæ‚‰çš„Nodeï¼ˆè¿™é‡Œä¸»è¦å‚è€ƒNode v10ï¼‰ä½œä¸ºå¼•å­ï¼Œç®€å•ä»‹ç»å®ƒçš„æ¨¡å—åŒ–å®ç°ï¼Œå¸®åŠ©æˆ‘ä»¬æ¥ä¸‹æ¥ç†è§£webpackçš„å®ç°ã€‚\r\n\r\nNodeä¸­çš„æ¨¡å—å¼•å…¥ä¼šç»å†ä¸‹é¢å‡ ä¸ªæ­¥éª¤ï¼š\r\n\r\n1. è·¯å¾„åˆ†æ\r\n2. æ–‡ä»¶å®šä½\r\n3. ç¼–è¯‘æ‰§è¡Œ\r\n\r\nåœ¨Nodeä¸­ï¼Œæ¨¡å—ä»¥æ–‡ä»¶ç»´åº¦å­˜åœ¨ï¼Œå¹¶ä¸”åœ¨ç¼–è¯‘åç¼“å­˜äºå†…å­˜ä¸­ï¼Œé€šè¿‡`require.cache`å¯ä»¥æŸ¥çœ‹æ¨¡å—ç¼“å­˜æƒ…å†µã€‚åœ¨æ¨¡å—ä¸­æ·»åŠ `console.log(require.cache)`æŸ¥çœ‹è¾“å‡ºå¦‚ä¸‹ï¼š\r\n\r\n```JavaScript\r\n{ '/Users/alienzhou/programming/gitrepo/test.js':\r\n   Module {\r\n     id: '.',\r\n     exports: {},\r\n     parent: null,\r\n     filename: '/Users/alienzhou/programming/gitrepo/test.js',\r\n     loaded: false,\r\n     children: [],\r\n     paths:\r\n      [ '/Users/alienzhou/programming/gitrepo/node_modules',\r\n        '/Users/alienzhou/programming/node_modules',\r\n        '/Users/alienzhou/node_modules',\r\n        '/Users/node_modules',\r\n        '/node_modules' ] } }\r\n```\r\n\r\nä¸Šé¢å°±æ˜¯æ¨¡å—å¯¹è±¡çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå¯ä»¥åœ¨[Nodeæºç ](https://github.com/nodejs/node/blob/master/lib/internal/modules/cjs/loader.js#L102-L110)ä¸­æ‰¾åˆ°Moduleç±»çš„æ„é€ æ–¹æ³•ã€‚å…¶ä¸­`exports`å±æ€§éå¸¸é‡è¦ï¼Œå®ƒå°±æ˜¯æ¨¡å—çš„å¯¼å‡ºå¯¹è±¡ã€‚å› æ­¤ï¼Œä¸‹é¢è¿™è¡Œè¯­å¥\r\n\r\n```JavaScript\r\nvar test = require('./test.js');\r\n```\r\n\r\nå…¶å®å°±æ˜¯æŠŠ`test.js`æ¨¡å—çš„`exports`å±æ€§èµ‹å€¼ç»™`test`å˜é‡ã€‚\r\n\r\nä¹Ÿè®¸ä½ è¿˜ä¼šå¥½å¥‡ï¼Œå½“æˆ‘ä»¬å†™ä¸€ä¸ªNode(JavaScript)æ¨¡å—æ—¶ï¼Œæ¨¡å—é‡Œçš„`module`ã€`require`ã€`__filename`ç­‰è¿™äº›å˜é‡æ˜¯å“ªæ¥çš„ï¼Ÿå¦‚æœä½ çœ‹è¿‡[Node loader.js éƒ¨åˆ†æºç ](https://github.com/nodejs/node/blob/master/lib/internal/modules/cjs/loader.js#L124-L131)ï¼Œåº”è¯¥å°±å¤§è‡´èƒ½ç†è§£ï¼š\r\n\r\n```JavaScript\r\nModule.wrap = function(script) {\r\n  return Module.wrapper[0] + script + Module.wrapper[1];\r\n};\r\n\r\nModule.wrapper = [\r\n  '(function (exports, require, module, __filename, __dirname) { ',\r\n  '\\n});'\r\n];\r\n```\r\n\r\nNodeä¼šè‡ªåŠ¨å°†æ¯ä¸ªæ¨¡å—è¿›è¡ŒåŒ…è£…ï¼ˆwrapï¼‰ï¼Œå°†å…¶å˜ä¸ºä¸€ä¸ªfunctionã€‚ä¾‹å¦‚æ¨¡å—test.jsåŸæœ¬ä¸ºï¼š\r\n\r\n```JavaScript\r\nconsole.log(require.cache);\r\nmodule.exports = 'test';\r\n```\r\n\r\nåŒ…è£…åå¤§è‡´ä¼šå˜ä¸ºï¼š\r\n\r\n```JavaScript\r\n(function (exports, require, module, __filename, __dirname) {\r\n    console.log(require.cache);\r\n    module.exports = 'test';\r\n});\r\n```\r\n\r\nè¿™ä¸‹ä½ åº”è¯¥æ˜ç™½`module`ã€`require`ã€`__filename`è¿™äº›å˜é‡éƒ½æ˜¯å“ªæ¥çš„äº†å§ â€”â€” å®ƒä»¬ä¼šè¢«ä½œä¸ºfunctionçš„å‚æ•°åœ¨æ¨¡å—ç¼–è¯‘æ‰§è¡Œæ—¶æ³¨å…¥è¿›æ¥ã€‚ä»¥ä¸€ä¸ªæ‰©å±•åä¸º`.js`çš„æ¨¡å—ä¸ºä¾‹ï¼Œå½“ä½ `require`å®ƒæ—¶ï¼Œä¸€ä¸ªå®Œæ•´çš„æ–¹æ³•è°ƒç”¨å¤§è‡´åŒ…æ‹¬ä¸‹é¢å‡ ä¸ªè¿‡ç¨‹ï¼š\r\n\r\n```flow\r\nst=>start: require()å¼•å…¥æ¨¡å—\r\nop1=>operation: è°ƒç”¨._load()åŠ è½½æ¨¡å—\r\nop2=>operation: new Module(filename, parent)åˆ›å»ºæ¨¡å—å¯¹è±¡\r\nop3=>operation: å°†æ¨¡å—å¯¹è±¡å­˜å…¥ç¼“å­˜\r\nop4=>operation: æ ¹æ®æ–‡ä»¶ç±»å‹è°ƒç”¨Module._extensions\r\nop5=>operation: è°ƒç”¨.compile()ç¼–è¯‘æ‰§è¡Œjsæ¨¡å—\r\ncond=>condition: Module._cacheæ˜¯å¦æ— ç¼“å­˜\r\ne=>end: è¿”å›module.exportsç»“æœ\r\nst->op1->cond\r\ncond(yes)->op2->op3->op4->op5->e\r\ncond(no)->e\r\n```\r\n\r\nåœ¨[Nodeæºç ](https://github.com/nodejs/node/blob/master/lib/internal/modules/cjs/loader.js#L685-L691)ä¸­èƒ½çœ‹åˆ°ï¼Œæ¨¡å—æ‰§è¡Œæ—¶ï¼ŒåŒ…è£…å®šä¹‰çš„å‡ ä¸ªå˜é‡è¢«æ³¨å…¥äº†ï¼š\r\n\r\n```JavaScript\r\nif (inspectorWrapper) {\r\n    result = inspectorWrapper(compiledWrapper, this.exports, this.exports,\r\n                              require, this, filename, dirname);\r\n\r\n} else {\r\n    result = compiledWrapper.call(this.exports, this.exports, require, this,\r\n                                  filename, dirname);\r\n}\r\n\r\n```\r\n\r\n> é¢˜å¤–è¯ï¼Œä»è¿™é‡Œä½ ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œåœ¨æ¨¡å—å†…ä½¿ç”¨`module.exports`ä¸`exports`çš„åŒºåˆ«\r\n\r\n## 3. webpackå®ç°çš„å‰ç«¯æ¨¡å—åŒ–\r\n\r\nä¹‹æ‰€ä»¥åœ¨ä»‹ç»ã€Œwebpackæ˜¯å¦‚ä½•åœ¨æ‰“åŒ…å‡ºçš„ä»£ç ä¸­å®ç°æ¨¡å—åŒ–ã€ä¹‹å‰ï¼Œå…ˆç”¨ä¸€å®šç¯‡å¹…ä»‹ç»äº†Nodeä¸­çš„æ¨¡å—åŒ–ï¼Œæ˜¯å› ä¸ºä¸¤è€…åœ¨åŒæ­¥ä¾èµ–çš„è®¾è®¡ä¸å®ç°ä¸Šæœ‰å¼‚æ›²åŒå·¥ä¹‹å¤„ã€‚ç†è§£Nodeçš„æ¨¡å—åŒ–å¯¹å­¦ä¹ webpackå¾ˆæœ‰å¸®åŠ©ã€‚å½“ç„¶ï¼Œç”±äºè¿è¡Œç¯å¢ƒçš„ä¸åŒï¼ˆwebpackæ‰“åŒ…å‡ºçš„ä»£ç è¿è¡Œåœ¨å®¢æˆ·ç«¯ï¼Œè€ŒNodeæ˜¯åœ¨æœåŠ¡ç«¯ï¼‰ï¼Œå®ç°ä¸Šä¹Ÿæœ‰ä¸€å®šçš„å·®å¼‚ã€‚\r\n\r\nä¸‹é¢å°±æ¥çœ‹ä¸€ä¸‹ï¼Œwebpackæ˜¯å¦‚ä½•åœ¨æ‰“åŒ…å‡ºçš„ä»£ç ä¸­å®ç°å‰ç«¯ï¼ˆå®¢æˆ·ç«¯ï¼‰æ¨¡å—åŒ–çš„ã€‚\r\n\r\n### 3.1. æ¨¡å—å¯¹è±¡\r\nå’ŒNodeçš„æ¨¡å—åŒ–å®ç°ç±»ä¼¼ï¼Œåœ¨webpackæ‰“åŒ…å‡ºçš„ä»£ç ä¸­ï¼Œæ¯ä¸ªæ¨¡å—ä¹Ÿæœ‰ä¸€ä¸ªå¯¹åº”çš„æ¨¡å—å¯¹è±¡ã€‚åœ¨`__webpack_require__()`æ–¹æ³•ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š\r\n\r\n```javascript\r\nfunction __webpack_require__(moduleId) {\r\n    // â€¦â€¦ other code\r\n    \r\n    var module = installedModules[moduleId] = {\r\n        i: moduleId,\r\n        l: false,\r\n        exports: {},\r\n        parents: null,\r\n        children: []\r\n    };\r\n    \r\n    // â€¦â€¦ other code\r\n}\r\n```\r\n\r\nç±»ä¼¼äºNodeï¼Œåœ¨webpackä¸­å„ä¸ªæ¨¡å—çš„ä¹Ÿæœ‰å¯¹åº”çš„æ¨¡å—å¯¹è±¡ï¼Œå…¶æ•°æ®ç»“æ„åŸºæœ¬éµå¾ªCommonJSè§„èŒƒï¼›å…¶ä¸­`installedModules`åˆ™æ˜¯æ¨¡å—ç¼“å­˜å¯¹è±¡ï¼Œç±»ä¼¼äºNodeä¸­çš„`require.cache`/`Module._cache`ã€‚\r\n\r\n### 2.2. æ¨¡å—çš„requireï¼š`__webpack_require__`\r\n`__webpack_require__`æ˜¯webpackå‰ç«¯è¿è¡Œæ—¶æ¨¡å—åŒ–ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç›¸å½“äºCommonJSè§„èŒƒä¸­çš„`require`ã€‚\r\n\r\næ ¹æ®ç¬¬ä¸€éƒ¨åˆ†çš„æµç¨‹å›¾ï¼šåœ¨Nodeä¸­ï¼Œå½“æˆ‘ä»¬`require`ä¸€ä¸ªæ¨¡å—æ—¶ï¼Œä¼šå…ˆåˆ¤æ–­è¯¥æ¨¡å—æ˜¯å¦åœ¨ç¼“å­˜ä¹‹ä¸­ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥è¿”å›è¯¥æ¨¡å—çš„`exports`å±æ€§ï¼›å¦åˆ™ä¼šåŠ è½½å¹¶æ‰§è¡Œè¯¥æ¨¡å—ã€‚webpackä¸­çš„å®ç°ä¹Ÿç±»ä¼¼ï¼š\r\n\r\n```javascript\r\nfunction __webpack_require__(moduleId) {\r\n    // 1.é¦–å…ˆä¼šæ£€æŸ¥æ¨¡å—ç¼“å­˜\r\n    if(installedModules[moduleId]) {\r\n        return installedModules[moduleId].exports;\r\n    }\r\n    \r\n    // 2. ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œåˆ›å»ºå¹¶ç¼“å­˜ä¸€ä¸ªæ–°çš„æ¨¡å—å¯¹è±¡ï¼Œç±»ä¼¼Nodeä¸­çš„new Moduleæ“ä½œ\r\n    var module = installedModules[moduleId] = {\r\n        i: moduleId,\r\n        l: false,\r\n        exports: {},\r\n        children: []\r\n    };\r\n\r\n    // 3. æ‰§è¡Œæ¨¡å—ï¼Œç±»ä¼¼äºNodeä¸­çš„ï¼š\r\n    // result = compiledWrapper.call(this.exports, this.exports, require, this, filename, dirname);\r\n    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\r\n\r\n    module.l = true;\r\n\r\n    // 4. è¿”å›è¯¥moduleçš„è¾“å‡º\r\n    return module.exports;\r\n}\r\n```\r\n\r\nå¦‚æœä½ ä»”ç»†å¯¹æ¯”webpackä¸Nodeï¼Œä½ ä¼šå‘ç°åœ¨`__webpack_require__`ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„åŒºåˆ«ï¼š\r\n\r\nåœ¨webpackä¸­ä¸å­˜åœ¨åƒNodeä¸€æ ·è°ƒç”¨`._compile()`è¿™ç§æ–¹æ³•çš„è¿‡ç¨‹ã€‚å³ä¸ä¼šåƒNodeé‚£æ ·ï¼Œå¯¹ä¸€ä¸ªæœªè½½å…¥ç¼“å­˜çš„æ¨¡å—ï¼Œé€šè¿‡ã€Œè¯»å–æ¨¡å—è·¯å¾„ -> ç¼–è¯‘æ¨¡å—ä»£ç  -> æ‰§è¡Œæ¨¡å—ã€æ¥è½½å…¥æ¨¡å—ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ\r\n\r\nè¿™æ˜¯å› ä¸ºï¼ŒNodeä½œä¸ºæœåŠ¡ç«¯è¯­è¨€ï¼Œæ¨¡å—éƒ½æ˜¯æœ¬åœ°æ–‡ä»¶ï¼ŒåŠ è½½æ—¶å»¶ä½ï¼Œå¯åŒæ­¥é˜»å¡è¿›è¡Œæ¨¡å—æ–‡ä»¶å¯»å€ã€è¯»å–ã€ç¼–è¯‘å’Œæ‰§è¡Œï¼Œè¿™äº›è¿‡ç¨‹åœ¨æ¨¡å—requireçš„æ—¶å€™å†â€œæŒ‰éœ€â€æ‰§è¡Œå³å¯ï¼›è€Œwebpackè¿è¡Œåœ¨å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ï¼Œæ˜¾ç„¶ä¸èƒ½åœ¨éœ€è¦æ—¶ï¼ˆå³æ‰§è¡Œ`__webpack_require__`æ—¶ï¼‰å†é€šè¿‡ç½‘ç»œåŠ è½½jsæ–‡ä»¶ï¼Œå¹¶åŒæ­¥åœ°ç­‰å¾…åŠ è½½å®Œæˆåå†è¿”å›`__webpack_require__`ã€‚è¿™ç§ç½‘ç»œæ—¶å»¶ï¼Œæ˜¾ç„¶ä¸èƒ½æ»¡è¶³â€œåŒæ­¥ä¾èµ–â€çš„è¦æ±‚ã€‚\r\n\r\né‚£ä¹ˆwebpackæ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿ\r\n\r\n\r\n### 3.2. å¦‚ä½•è§£å†³å‰ç«¯çš„åŒæ­¥ä¾èµ–\r\n\r\næˆ‘ä»¬è¿˜æ˜¯å›æ¥çœ‹ä¸‹Nodeï¼š\r\n\r\nNodeï¼ˆv10ï¼‰ä¸­åŠ è½½ã€ç¼–è¯‘ä¸æ‰§è¡Œï¼ˆjsï¼‰æ¨¡å—çš„ä»£ç ä¸»è¦é›†ä¸­åœ¨`Module._extensions['.js']`å’Œ`Module.prototype._compile`ä¸­ã€‚é¦–å…ˆä¼šé€šè¿‡`fs.readFileSync`è¯»å–æ–‡ä»¶å†…å®¹ï¼Œç„¶åé€šè¿‡`vm.runInThisContext`æ¥ç¼–è¯‘å’Œæ‰§è¡ŒJavaScriptä»£ç ã€‚\r\n\r\n> The vm module provides APIs for compiling and running code within V8 Virtual Machine contexts.\r\n\r\nä½†æ˜¯ï¼Œæ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œåœ¨å‰ç«¯runtimeä¸­è‚¯å®šä¸èƒ½é€šè¿‡ç½‘ç»œå»åŒæ­¥è·å–JavaScriptè„šæœ¬æ–‡ä»¶ï¼›é‚£ä¹ˆå°±éœ€è¦æˆ‘ä»¬æ¢ä¸€ä¸ªæ€è·¯ï¼šæœ‰æ²¡æœ‰ä»€ä¹ˆåœ°æ–¹èƒ½å¤Ÿé¢„å…ˆæ”¾ç½®æˆ‘ä»¬â€œä¹‹åâ€å¯èƒ½ä¼šéœ€è¦çš„æ¨¡å—ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿåœ¨requireæ—¶ä¸éœ€è¦åŒæ­¥ç­‰å¾…è¿‡é•¿çš„æ—¶é—´ï¼ˆå½“ç„¶ï¼Œè¿™é‡Œçš„â€œä¹‹åâ€å¯èƒ½æ˜¯å‡ ç§’ã€å‡ åˆ†é’Ÿåï¼Œä¹Ÿå¯èƒ½æ˜¯è¿™æ¬¡äº‹ä»¶å¾ªç¯taskçš„ä¸‹å‡ è¡Œä»£ç ï¼‰ã€‚\r\n\r\nå†…å­˜å°±æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚æˆ‘ä»¬å¯ä»¥æŠŠåŒæ­¥ä¾èµ–çš„æ¨¡å—å…ˆâ€œæ³¨å†Œâ€åˆ°å†…å­˜ä¸­ï¼ˆæ¨¡å—æš‚å­˜ï¼‰ï¼Œç­‰åˆ°requireæ—¶ï¼Œå†æ‰§è¡Œè¯¥æ¨¡å—ã€ç¼“å­˜æ¨¡å—å¯¹è±¡ã€è¿”å›å¯¹åº”çš„`exports`ã€‚è€Œwebpackä¸­ï¼Œè¿™ä¸ªæ‰€è°“çš„å†…å­˜å°±æ˜¯`modules`å¯¹è±¡ã€‚\r\n\r\n> æ³¨æ„è¿™é‡ŒæŒ‡çš„æ¨¡å—æš‚å­˜å’Œæ¨¡å—ç¼“å­˜æ¦‚å¿µå®Œå…¨ä¸åŒã€‚æš‚å­˜å¯ä»¥ç²—ç•¥ç±»æ¯”ä¸ºå°†ç¼–è¯‘å¥½çš„æ¨¡å—ä»£ç å…ˆæ”¾åˆ°å†…å­˜ä¸­ï¼Œå®é™…å¹¶æ²¡æœ‰å¼•å…¥è¯¥æ¨¡å—ã€‚åŸºäºè¿™ä¸ªç›®çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠâ€œæ¨¡å—æš‚å­˜â€ç†è§£ä¸ºâ€œæ¨¡å—æ³¨å†Œâ€ï¼Œå› æ­¤åæ–‡ä¸­â€œæ¨¡å—æš‚å­˜â€ä¸â€œæ¨¡å—æ³¨å†Œâ€å…·æœ‰ç›¸ç­‰çš„æ¦‚å¿µã€‚\r\n\r\næ‰€ä»¥ï¼Œè¿‡ç¨‹å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š\r\n\r\nå½“æˆ‘ä»¬å·²ç»è·å–äº†æ¨¡å—å†…å®¹åï¼ˆä½†æ¨¡å—è¿˜æœªæ‰§è¡Œï¼‰ï¼Œæˆ‘ä»¬å°±å°†å…¶æš‚å­˜åœ¨`modules`å¯¹è±¡ä¸­ï¼Œé”®å°±æ˜¯webpackçš„moduleIdï¼›ç­‰åˆ°éœ€è¦ä½¿ç”¨`__webpack_require__`å¼•ç”¨æ¨¡å—æ—¶ï¼Œå‘ç°ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™ä»`modules`å¯¹è±¡ä¸­å–å‡ºæš‚å­˜çš„æ¨¡å—å¹¶æ‰§è¡Œã€‚\r\n\r\n### 3.3. å¦‚ä½•â€æš‚å­˜â€œæ¨¡å—\r\n\r\næ€è·¯å·²ç»æ¸…æ™°äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹çœ‹ï¼Œwebpackæ˜¯å¦‚ä½•å°†æ¨¡å—â€œæš‚å­˜â€åœ¨`modules`å¯¹è±¡ä¸Šçš„ã€‚åœ¨å®é™…ä¸Šï¼Œwebpackæ‰“åŒ…å‡ºæ¥çš„ä»£ç å¯ä»¥ç®€å•åˆ†ä¸ºä¸¤ç±»ï¼š\r\n\r\n- ä¸€ç±»æ˜¯webpackæ¨¡å—åŒ–çš„å‰ç«¯runtimeï¼Œä½ å¯ä»¥ç®€å•ç±»æ¯”ä¸ºRequireJSè¿™æ ·çš„å‰ç«¯æ¨¡å—åŒ–ç±»åº“æ‰€å®ç°çš„åŠŸèƒ½ã€‚å®ƒä¼šæ§åˆ¶æ¨¡å—çš„åŠ è½½ã€ç¼“å­˜ï¼Œæä¾›è¯¸å¦‚`__webpack_require__`è¿™æ ·çš„requireæ–¹æ³•ç­‰ã€‚\r\n- å¦ä¸€ç±»åˆ™æ˜¯æ¨¡å—æ³¨å†Œä¸è¿è¡Œçš„ä»£ç ï¼ŒåŒ…å«äº†æºç ä¸­çš„æ¨¡å—ä»£ç ã€‚ä¸ºäº†è¿›ä¸€æ­¥ç†è§£ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™éƒ¨åˆ†çš„ä»£ç æ˜¯æ€æ ·çš„ã€‚\r\n\r\n> ä¸ºäº†ä¾¿äºå­¦ä¹ ä¸ä»£ç é˜…è¯»ï¼Œå»ºè®®ä½ å¯ä»¥åœ¨webpackï¼ˆv4ï¼‰é…ç½®ä¸­åŠ å…¥`optimization:{runtimeChunk: {name: 'runtime'}}`ï¼Œè¿™æ ·ä¼šè®©webpackå°†runtimeä¸æ¨¡å—æ³¨å†Œä»£ç åˆ†å¼€æ‰“åŒ…ã€‚\r\n\r\n```JavaScript\r\n// webpack module chunk\r\n(window[\"webpackJsonp\"] = window[\"webpackJsonp\"] || []).push([[\"home-0\"],{\r\n\r\n/***/ \"module-home-0\":\r\n/***/ (function(module, exports, __webpack_require__) {\r\n\r\nconst myalert = __webpack_require__(\"module-home-1\");\r\n\r\nmyalert('test');\r\n\r\n/***/ }),\r\n\r\n/***/ \"module-home-1\":\r\n/***/ (function(module, exports) {\r\n\r\nmodule.exports = function (a) {\r\n    alert('hi:' + a);\r\n};\r\n\r\n/***/ })\r\n\r\n},[[\"module-home-0\",\"home-1\"]]]);\r\n```\r\n\r\nä¸Šé¢è¿™æ˜¯ä¸€ä¸ªä¸åŒ…å«runtimeçš„chunkï¼Œæˆ‘ä»¬ä¸å¦¨å°†å…¶ç§°ä¸ºmodule chunkï¼ˆä¸‹é¢ä¼šæ²¿ç”¨è¿™ä¸ªå«æ³•ï¼‰ã€‚ç®€åŒ–ä¸€ä¸‹è¿™éƒ¨åˆ†ä»£ç ï¼Œå¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š\r\n\r\n```JavaScript\r\n// webpack module chunk\r\nwindow[\"webpackJsonp\"].push([\r\n    [\"home-0\"], // chunkIds\r\n    {\r\n        \"module-home-0\": (function(module, exports, __webpack_require__){ /* some logic */ }),\r\n        \"module-home-1\": (function(module, exports, __webpack_require__){ /* some logic */ })\r\n    },\r\n    [[\"module-home-0\",\"home-1\"]]\r\n])\r\n```\r\n\r\nè¿™é‡Œï¼Œ`.push()`æ–¹æ³•å‚æ•°ä¸ºä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«ä¸‰ä¸ªå…ƒç´ ï¼š\r\n\r\n- ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œ`[\"home-0\"]`è¡¨ç¤ºè¯¥jsæ–‡ä»¶æ‰€åŒ…å«çš„æ‰€æœ‰chunkçš„idï¼ˆå¯ä»¥ç²—ç•¥ç†è§£ä¸ºï¼Œwebpackä¸­moduleç»„æˆchunkï¼Œchunkåˆç»„æˆfileï¼‰ï¼›\r\n- ç¬¬äºŒä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé”®æ˜¯å„ä¸ªæ¨¡å—çš„idï¼Œå€¼åˆ™æ˜¯ä¸€ä¸ªè¢«functionåŒ…è£…åçš„æ¨¡å—ï¼›\r\n- ç¬¬ä¸‰ä¸ªå…ƒç´ ä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå…¶åˆæ˜¯ç”±å¤šä¸ªæ•°ç»„ç»„æˆã€‚å…·ä½“ä½œç”¨æˆ‘ä»¬å…ˆæŒ‰ä¸‹ä¸è¡¨ï¼Œæœ€åå†è¯´ã€‚\r\n\r\næ¥çœ‹ä¸‹å‚æ•°æ•°ç»„çš„ç¬¬äºŒä¸ªå…ƒç´  â€”â€” åŒ…å«æ¨¡å—ä»£ç çš„å¯¹è±¡ï¼Œä½ ä¼šå‘ç°è¿™é‡Œæ–¹æ³•ç­¾åæ˜¯ä¸æ˜¯å¾ˆåƒNodeä¸­çš„é€šè¿‡`Module.wrap()`è¿›è¡Œçš„æ¨¡å—ä»£ç åŒ…è£…ï¼Ÿæ²¡é”™ï¼Œ[webpackæºç ](https://github.com/webpack/webpack/blob/master/lib/FunctionModuleTemplatePlugin.js#L16-L31)ä¸­ä¹Ÿæœ‰ç±»ä¼¼ï¼Œä¼šåƒNodeé‚£æ ·ï¼Œå°†æ¯ä¸ªæ¨¡å—çš„ä»£ç ç”¨ä¸€ä¸ªfunctionåŒ…è£…èµ·æ¥ã€‚\r\n\r\nè€Œå½“webpacké…ç½®äº†runtimeåˆ†ç¦»åï¼Œæ‰“åŒ…å‡ºçš„æ–‡ä»¶ä¸­ä¼šå‡ºç°ä¸€ä¸ªâ€œçº¯å‡€â€çš„ã€ä¸åŒ…å«ä»»ä½•æ¨¡å—ä»£ç çš„runtimeï¼Œå…¶ä¸»è¦æ˜¯ä¸€ä¸ªè‡ªæ‰§è¡Œæ–¹æ³•ï¼Œå…¶ä¸­æš´éœ²äº†ä¸€ä¸ªå…¨å±€å˜é‡`webpackJsonp`ï¼š\r\n\r\n```JavaScript\r\n// webpack runtime chunk\r\nvar jsonpArray = window[\"webpackJsonp\"] = window[\"webpackJsonp\"] || [];\r\nvar oldJsonpFunction = jsonpArray.push.bind(jsonpArray);\r\njsonpArray.push = webpackJsonpCallback;\r\n```\r\n\r\n> `webpackJsonp`å˜é‡åå¯ä»¥é€šè¿‡`output.jsonpFunction`è¿›è¡Œé…ç½®\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œ`window[\"webpackJsonp\"]`ä¸Šçš„`.push()`æ–¹æ³•å·²ç»è¢«ä¿®æ”¹ä¸ºäº†`webpackJsonpCallback()`æ–¹æ³•ã€‚è¯¥æ–¹æ³•å¦‚ä¸‹ï¼š\r\n\r\n```javascript\r\n// webpack runtime chunk\r\nfunction webpackJsonpCallback(data) {\r\n    var chunkIds = data[0];\r\n    var moreModules = data[1];\r\n    var executeModules = data[2];\r\n\r\n    var moduleId, chunkId, i = 0, resolves = [];\r\n    // webpackä¼šåœ¨installChunksä¸­å­˜å‚¨chunkçš„è½½å…¥çŠ¶æ€ï¼Œæ®æ­¤åˆ¤æ–­chunkæ˜¯å¦åŠ è½½å®Œæ¯•\r\n    for(;i < chunkIds.length; i++) {\r\n        chunkId = chunkIds[i];\r\n        if(installedChunks[chunkId]) {\r\n            resolves.push(installedChunks[chunkId][0]);\r\n        }\r\n        installedChunks[chunkId] = 0;\r\n    }\r\n    \r\n    // æ³¨æ„ï¼Œè¿™é‡Œä¼šè¿›è¡Œâ€œæ³¨å†Œâ€ï¼Œå°†æ¨¡å—æš‚å­˜å…¥å†…å­˜ä¸­\r\n    // å°†module chunkä¸­ç¬¬äºŒä¸ªæ•°ç»„å…ƒç´ åŒ…å«çš„ module æ–¹æ³•æ³¨å†Œåˆ° modules å¯¹è±¡é‡Œ\r\n    for(moduleId in moreModules) {\r\n        if(Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {\r\n            modules[moduleId] = moreModules[moduleId];\r\n        }\r\n    }\r\n\r\n    if(parentJsonpFunction) parentJsonpFunction(data);\r\n\r\n    while(resolves.length) {\r\n        resolves.shift()();\r\n    }\r\n\r\n    deferredModules.push.apply(deferredModules, executeModules || []);\r\n\r\n    return checkDeferredModules();\r\n};\r\n```\r\n\r\næ³¨æ„ä»¥ä¸Šæ–¹æ³•çš„è¿™å‡ è¡Œï¼Œå°±æ˜¯æˆ‘ä»¬ä¹‹å‰æ‰€è¯´çš„ã€Œå°†æ¨¡å—â€œæš‚å­˜â€åœ¨moduleså¯¹è±¡ä¸Šã€\r\n\r\n```JavaScript\r\n// webpackJsonpCallback\r\nfor(moduleId in moreModules) {\r\n    if(Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {\r\n    modules[moduleId] = moreModules[moduleId];\r\n    }\r\n}\r\n```\r\n\r\né…åˆ`__webpack_require__()`ä¸­ä¸‹é¢è¿™ä¸€è¡Œä»£ç ï¼Œå°±å®ç°äº†åœ¨éœ€è¦å¼•å…¥æ¨¡å—æ—¶ï¼ŒåŒæ­¥åœ°å°†æ¨¡å—ä»æš‚å­˜åŒºå–å‡ºæ¥æ‰§è¡Œï¼Œé¿å…ä½¿ç”¨ç½‘ç»œè¯·æ±‚å¯¼è‡´è¿‡é•¿çš„åŒæ­¥ç­‰å¾…æ—¶é—´ã€‚\r\n\r\n```JavaScript\r\n// __webpack_require__\r\nmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\r\n```\r\n\r\n### 3.4. æ¨¡å—çš„è‡ªåŠ¨æ‰§è¡Œ\r\n\r\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œå¯¹äºwebpackçš„åŒæ­¥ä¾èµ–å®ç°å·²ç»ä»‹ç»çš„å·®ä¸å¤šäº†ï¼Œä½†è¿˜é—ç•™ä¸€ä¸ªå°é—®é¢˜ï¼šwebpackä¸­çš„æ‰€æœ‰jsæºæ–‡ä»¶éƒ½æ˜¯æ¨¡å—ï¼Œä½†å¦‚æœéƒ½æ˜¯ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œçš„æ¨¡å—ï¼Œé‚£æˆ‘ä»¬åªæ˜¯åœ¨å‰ç«¯å¼•å…¥äº†ä¸€å †â€œæ­»â€ä»£ç ï¼Œæ€ä¹ˆè®©ä»£ç â€œæ´»â€èµ·æ¥å‘¢ï¼Ÿ\r\n\r\nå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬å¼•å…¥ä¸€ä¸ªscriptæ ‡ç­¾åŠ è½½è„šæœ¬æ–‡ä»¶ï¼Œè‡³å°‘å¸Œæœ›å…¶ä¸­ä¸€ä¸ªæ¨¡å—çš„ä»£ç ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œè€Œä¸ä»…ä»…æ˜¯æ³¨å†Œåœ¨`modules`å¯¹è±¡ä¸Šã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™å°±æ˜¯webpackä¸­æ‰€è°“çš„å…¥å£æ¨¡å—ã€‚\r\n\r\nwebpackæ˜¯å¦‚ä½•è®©è¿™äº›å…¥å£æ¨¡å—è‡ªåŠ¨æ‰§è¡Œçš„å‘¢ï¼Ÿä¸çŸ¥é“ä½ æ˜¯å¦è¿˜è®°å¾—module chunkä¸­é‚£ä¸ªæŒ‰ä¸‹ä¸è¡¨çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šè¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè€Œæ•°ç»„é‡Œé¢æ¯ä¸ªå…ƒç´ åˆæ˜¯ä¸€ä¸ªæ•°ç»„\r\n\r\n```javascript\r\n[[\"module-home-0\",\"home-1\"], [\"module-home-2\",\"home-3\",\"home-5\"]]\r\n```\r\n\r\nå¯¹ç…§ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å…·ä½“è§£é‡Šä¸‹å‚æ•°çš„å«ä¹‰ã€‚ç¬¬ä¸€ä¸ªå…ƒç´ `[\"module-home-0\",\"home-1\"]`è¡¨ç¤ºï¼Œæˆ‘å¸Œæœ›è‡ªåŠ¨æ‰§è¡ŒmoduleIdä¸º`module-home-0`çš„è¿™ä¸ªæ¨¡å—ï¼Œä½†æ˜¯è¯¥æ¨¡å—éœ€è¦chunkIdä¸º`home-1`çš„chunkå·²ç»åŠ è½½åæ‰èƒ½æ‰§è¡Œï¼›åŒç†ï¼Œ`[\"module-home-2\",\"home-3\",\"home-5\"]`è¡¨ç¤ºè‡ªåŠ¨æ‰§è¡Œ`module-home-2`æ¨¡å—ï¼Œä½†æ˜¯éœ€è¦æ£€æŸ¥chunk`home-3`å’Œ`home-5`å·²ç»åŠ è½½ã€‚\r\n\r\næ‰§è¡ŒæŸäº›æ¨¡å—éœ€è¦ä¿è¯ä¸€äº›chunkå·²ç»åŠ è½½æ˜¯å› ä¸ºï¼Œè¯¥æ¨¡å—æ‰€ä¾èµ–çš„å…¶ä»–æ¨¡å—å¯èƒ½å¹¶ä¸åœ¨å½“å‰chunkä¸­ï¼Œè€Œwebpackåœ¨ç¼–è¯‘æœŸä¼šé€šè¿‡ä¾èµ–åˆ†æè‡ªåŠ¨å°†ä¾èµ–æ¨¡å—çš„æ‰€å±chunkIdæ³¨å…¥åˆ°æ­¤å¤„ã€‚\r\n\r\nè¿™ä¸ªæ¨¡å—â€œè‡ªåŠ¨â€æ‰§è¡Œçš„åŠŸèƒ½åœ¨runtime chunkçš„ä»£ç ä¸­ä¸»è¦æ˜¯ç”±`checkDeferredModules()`æ–¹æ³•å®ç°ï¼š\r\n\r\n```JavaScript\r\nfunction checkDeferredModules() {\r\n    var result;\r\n    for(var i = 0; i < deferredModules.length; i++) {\r\n        var deferredModule = deferredModules[i];\r\n        var fulfilled = true;\r\n        // ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ¨¡å—idï¼Œåé¢æ˜¯å…¶æ‰€éœ€çš„chunk\r\n        for(var j = 1; j < deferredModule.length; j++) {\r\n            var depId = deferredModule[j];\r\n            // è¿™é‡Œä¼šé¦–å…ˆåˆ¤æ–­æ¨¡å—æ‰€éœ€chunkæ˜¯å¦å·²ç»åŠ è½½å®Œæ¯•\r\n            if(installedChunks[depId] !== 0) fulfilled = false;\r\n        }\r\n        // åªæœ‰æ¨¡å—æ‰€éœ€çš„chunkéƒ½åŠ è½½å®Œæ¯•ï¼Œè¯¥æ¨¡å—æ‰ä¼šè¢«æ‰§è¡Œï¼ˆ__webpack_require__ï¼‰\r\n        if(fulfilled) {\r\n            deferredModules.splice(i--, 1);\r\n            result = __webpack_require__(__webpack_require__.s = deferredModule[0]);\r\n        }\r\n    }\r\n    return result;\r\n}\r\n```\r\n\r\n## 4. å¼‚æ­¥ä¾èµ–\r\n\r\nå¦‚æœä½ åªæ˜¯æƒ³å­¦ä¹ webpackå‰ç«¯runtimeä¸­åŒæ­¥ä¾èµ–çš„è®¾è®¡ä¸å®ç°ï¼Œé‚£ä¹ˆåˆ°è¿™é‡Œä¸»è¦å†…å®¹åŸºæœ¬å·²ç»ç»“æŸäº†ã€‚ä¸è¿‡æˆ‘ä»¬çŸ¥é“ï¼Œwebpackæ”¯æŒä½¿ç”¨åŠ¨æ€æ¨¡å—å¼•å…¥çš„è¯­æ³•ï¼ˆä»£ç æ‹†åˆ†ï¼‰ï¼Œä¾‹å¦‚ï¼š`dynamic import`å’Œæ—©æœŸçš„`require.ensure`ï¼Œè¿™ç§æ–¹å¼ä¸ä½¿ç”¨CommonJSçš„`require`å’ŒESMçš„`import`æœ€é‡è¦çš„åŒºåˆ«åœ¨äºï¼Œè¯¥ç±»æ–¹æ³•ä¼šå¼‚æ­¥ï¼ˆæˆ–è€…è¯´æŒ‰éœ€ï¼‰åŠ è½½ä¾èµ–ã€‚\r\n\r\n### 4.1. ä»£ç è½¬æ¢\r\n\r\nå°±åƒåœ¨æºç ä¸­ä½¿ç”¨`require`ä¼šåœ¨webpackæ‰“åŒ…æ—¶è¢«æ›¿æ¢ä¸º`__webpack_require__`ä¸€æ ·ï¼Œåœ¨æºç ä¸­ä½¿ç”¨çš„å¼‚æ­¥ä¾èµ–è¯­æ³•ä¹Ÿä¼šè¢«webpackä¿®æ”¹ã€‚ä»¥`dynamic import`ä¸ºä¾‹ï¼Œä¸‹é¢çš„ä»£ç \r\n\r\n```JavaScript\r\nimport('./test.js').then(mod => {\r\n    console.log(mod);\r\n});\r\n```\r\n\r\nåœ¨äº§å‡ºåä¼šè¢«è½¬æ¢ä¸º\r\n\r\n```JavaScript\r\n__webpack_require__.e(/* import() */ \"home-1\")\r\n    .then(__webpack_require__.bind(null, \"module-home-3\"))\r\n    .then(mod => {\r\n        console.log(mod);\r\n    });\r\n```\r\n\r\nä¸Šé¢ä»£ç æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œwebpackæ‰“åŒ…åä¼šå°†ä¸€äº›moduleåˆå¹¶ä¸ºä¸€ä¸ªchunkï¼Œå› æ­¤ä¸Šé¢çš„`\"home-1\"`å°±è¡¨ç¤ºï¼šåŒ…å«`./test.js`æ¨¡å—çš„chunkçš„chunkIdä¸º`\"home-1\"`ã€‚\r\n\r\nwebpacké¦–å…ˆé€šè¿‡`__webpack_require__.e`åŠ è½½æŒ‡å®šchunkçš„scriptæ–‡ä»¶ï¼ˆmodule chunkï¼‰ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªpromiseï¼Œå½“scriptåŠ è½½å¹¶æ‰§è¡Œå®Œæˆåresolveè¯¥promiseã€‚webpackæ‰“åŒ…æ—¶ä¼šä¿è¯å¼‚æ­¥ä¾èµ–çš„æ‰€æœ‰æ¨¡å—éƒ½å·²åŒ…å«åœ¨è¯¥module chunkæˆ–å½“å‰ä¸Šä¸‹æ–‡ä¸­ã€‚\r\n\r\næ—¢ç„¶module chunkå·²ç»æ‰§è¡Œï¼Œé‚£ä¹ˆè¡¨æ˜å¼‚æ­¥ä¾èµ–å·²ç»å°±ç»ªï¼Œäºæ˜¯åœ¨thenæ–¹æ³•ä¸­æ‰§è¡Œ`__webpack_require__`å¼•ç”¨`test.js`æ¨¡å—ï¼ˆwebpackç¼–è¯‘åmoduleIdä¸ºmodule-home-3ï¼‰å¹¶è¿”å›ã€‚è¿™æ ·åœ¨ç¬¬äºŒä¸ªthenæ–¹æ³•ä¸­å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨è¯¥æ¨¡å—äº†ã€‚\r\n\r\n### 4.2. `__webpack_require__.e`\r\n\r\nå¼‚æ­¥ä¾èµ–çš„æ ¸å¿ƒæ–¹æ³•å°±æ˜¯`__webpack_require__.e`ã€‚ä¸‹é¢æ¥åˆ†æä¸€ä¸‹è¯¥æ–¹æ³•ï¼š\r\n\r\n```JavaScript\r\n__webpack_require__.e = function requireEnsure(chunkId) {\r\n    var promises = [];\r\n    var installedChunkData = installedChunks[chunkId];\r\n    \r\n    // åˆ¤æ–­è¯¥chunkæ˜¯å¦å·²ç»è¢«åŠ è½½ï¼Œ0è¡¨ç¤ºå·²åŠ è½½ã€‚installChunkä¸­çš„çŠ¶æ€ï¼š\r\n    // undefinedï¼šchunkæœªè¿›è¡ŒåŠ è½½,\r\n    // nullï¼šchunk preloaded/prefetched\r\n    // Promiseï¼šchunkæ­£åœ¨åŠ è½½ä¸­\r\n    // 0ï¼šchunkåŠ è½½å®Œæ¯•\r\n    if(installedChunkData !== 0) {\r\n        // chunkä¸ä¸ºnullå’Œundefinedï¼Œåˆ™ä¸ºPromiseï¼Œè¡¨ç¤ºåŠ è½½ä¸­ï¼Œç»§ç»­ç­‰å¾…\r\n        if(installedChunkData) {\r\n            promises.push(installedChunkData[2]);\r\n        } else {\r\n            // æ³¨æ„è¿™é‡ŒinstallChunkçš„æ•°æ®æ ¼å¼\r\n            // ä»å·¦åˆ°å³ä¸‰ä¸ªå…ƒç´ åˆ†åˆ«ä¸ºresolveã€rejectã€promise\r\n            var promise = new Promise(function(resolve, reject) {\r\n                installedChunkData = installedChunks[chunkId] = [resolve, reject];\r\n            });\r\n            promises.push(installedChunkData[2] = promise);\r\n\r\n            // ä¸‹é¢ä»£ç ä¸»è¦æ˜¯æ ¹æ®chunkIdåŠ è½½å¯¹åº”çš„scriptè„šæœ¬\r\n            var head = document.getElementsByTagName('head')[0];\r\n            var script = document.createElement('script');\r\n            var onScriptComplete;\r\n\r\n            script.charset = 'utf-8';\r\n            script.timeout = 120;\r\n            if (__webpack_require__.nc) {\r\n                script.setAttribute(\"nonce\", __webpack_require__.nc);\r\n            }\r\n            \r\n            // jsonpScriptSrcæ–¹æ³•ä¼šæ ¹æ®ä¼ å…¥çš„chunkIdè¿”å›å¯¹åº”çš„æ–‡ä»¶è·¯å¾„\r\n            script.src = jsonpScriptSrc(chunkId);\r\n\r\n            onScriptComplete = function (event) {\r\n                script.onerror = script.onload = null;\r\n                clearTimeout(timeout);\r\n                var chunk = installedChunks[chunkId];\r\n                if(chunk !== 0) {\r\n                    if(chunk) {\r\n                        var errorType = event && (event.type === 'load' ? 'missing' : event.type);\r\n                        var realSrc = event && event.target && event.target.src;\r\n                        var error = new Error('Loading chunk ' + chunkId + ' failed.\\n(' + errorType + ': ' + realSrc + ')');\r\n                        error.type = errorType;\r\n                        error.request = realSrc;\r\n                        chunk[1](error);\r\n                    }\r\n                    installedChunks[chunkId] = undefined;\r\n                }\r\n            };\r\n            var timeout = setTimeout(function(){\r\n                onScriptComplete({ type: 'timeout', target: script });\r\n            }, 120000);\r\n            script.onerror = script.onload = onScriptComplete;\r\n            head.appendChild(script);\r\n        }\r\n    }\r\n    return Promise.all(promises);\r\n};\r\n```\r\n\r\nè¯¥æ–¹æ³•é¦–å…ˆä¼šæ ¹æ®chunkIdåœ¨installChunksä¸­åˆ¤æ–­è¯¥chunkæ˜¯å¦æ­£åœ¨åŠ è½½æˆ–å·²ç»è¢«åŠ è½½ï¼›å¦‚æœæ²¡æœ‰åˆ™ä¼šåˆ›å»ºä¸€ä¸ªpromiseï¼Œå°†å…¶ä¿å­˜åœ¨installChunksä¸­ï¼Œå¹¶é€šè¿‡`jsonpScriptSrc()`æ–¹æ³•è·å–æ–‡ä»¶è·¯å¾„ï¼Œé€šè¿‡sciriptæ ‡ç­¾åŠ è½½ï¼Œæœ€åè¿”å›è¯¥promiseã€‚\r\n\r\n`jsonpScriptSrc()`åˆ™å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªåŒ…å«chunk mapçš„æ–¹æ³•ï¼Œä¾‹å¦‚è¿™ä¸ªä¾‹å­ä¸­ï¼š\r\n\r\n```JavaScript\r\nfunction jsonpScriptSrc(chunkId) {\r\n    return __webpack_require__.p + \"\" + ({}[chunkId]||chunkId) + \".\" + {\"home-1\":\"0b49ae3b\"}[chunkId] + \".js\"\r\n}\r\n```\r\n\r\nå…¶ä¸­åŒ…å«ä¸€ä¸ªmap â€”â€” `{\"home-1\":\"0b49ae3b\"}`ï¼Œä¼šæ ¹æ®home-1è¿™ä¸ªchunkIdè¿”å›home-1.0b49ae3b.jsè¿™ä¸ªæ–‡ä»¶åã€‚\r\n\r\n### 4.3. æ›´æ–°chunkåŠ è½½çŠ¶æ€\r\n\r\næœ€åï¼Œä½ ä¼šå‘ç°ï¼Œåœ¨onloadä¸­ï¼Œå¹¶æ²¡æœ‰è°ƒç”¨promiseçš„resolveæ–¹æ³•ã€‚é‚£ä¹ˆæ˜¯ä½•æ—¶resolveçš„å‘¢ï¼Ÿ\r\n\r\nä½ è¿˜è®°å¾—åœ¨ä»‹ç»åŒæ­¥requireæ—¶ç”¨äºæ³¨å†Œmoduleçš„`webpackJsonpCallback()`æ–¹æ³•ä¹ˆï¼Ÿæˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œè¯¥æ–¹æ³•å‚æ•°æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªchunkIdçš„æ•°ç»„ï¼Œä»£è¡¨äº†è¯¥è„šæœ¬æ‰€åŒ…å«çš„chunkã€‚\r\n\r\n> p.s. å½“ä¸€ä¸ªæ™®é€šçš„è„šæœ¬è¢«æµè§ˆå™¨ä¸‹è½½å®Œæ¯•åï¼Œä¼šå…ˆæ‰§è¡Œè¯¥è„šæœ¬ï¼Œç„¶åè§¦å‘onloadäº‹ä»¶ã€‚\r\n\r\nå› æ­¤ï¼Œåœ¨`webpackJsonpCallback()`æ–¹æ³•ä¸­ï¼Œæœ‰ä¸€æ®µä»£ç å°±æ˜¯æ ¹æ®chunkIdsçš„æ•°ç»„ï¼Œæ£€æŸ¥å¹¶æ›´æ–°chunkçš„åŠ è½½çŠ¶æ€ï¼š\r\n\r\n```JavaScript\r\n// webpackJsonpCallback()\r\nvar moduleId, chunkId, i = 0, resolves = [];\r\nfor(;i < chunkIds.length; i++) {\r\n    chunkId = chunkIds[i];\r\n    if(installedChunks[chunkId]) {\r\n        resolves.push(installedChunks[chunkId][0]);\r\n    }\r\n    installedChunks[chunkId] = 0;\r\n}\r\n\r\n// â€¦â€¦\r\n\r\nwhile(resolves.length) {\r\n    resolves.shift()();\r\n}\r\n```\r\n\r\nä¸Šé¢çš„ä»£ç å…ˆæ ¹æ®æ¨¡å—æ³¨å†Œæ—¶çš„chunkIdï¼Œå–å‡ºinstalledChunkså¯¹åº”çš„æ‰€æœ‰loadingä¸­çš„chunkï¼Œæœ€åå°†è¿™äº›chunkçš„promiseè¿›è¡Œresolveæ“ä½œã€‚\r\n\r\n## 5. å†™åœ¨æœ€å\r\n\r\nè‡³æ­¤ï¼Œå¯¹äºã€Œwebpackæ‰“åŒ…åæ˜¯å¦‚ä½•å®ç°å‰ç«¯æ¨¡å—åŒ–ã€è¿™ä¸ªé—®é¢˜å°±å·®ä¸å¤šç»“æŸäº†ã€‚æœ¬æ–‡é€šè¿‡Nodeä¸­çš„æ¨¡å—åŒ–ä¸ºå¼•å­ï¼Œä»‹ç»äº†webpackä¸­çš„åŒæ­¥ä¸å¼‚æ­¥æ¨¡å—åŠ è½½çš„è®¾è®¡ä¸å®ç°ã€‚\r\n\r\nä¸ºäº†æ–¹ä¾¿å¤§å®¶å¯¹ç…§æ–‡ä¸­å†…å®¹æŸ¥çœ‹webpackè¿è¡Œæ—¶æºç ï¼Œæˆ‘æŠŠåŸºç¡€çš„webpack runtime chunkå’Œmodule chunkæ”¾åœ¨äº†[è¿™é‡Œ](https://gitee.com/alienzhou/codes/o431yhewq8kimbtdnjpcl12)ï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥å¯¹ç…§ç€çœ‹ã€‚\r\n\r\næœ€åè¿˜æ˜¯æ¬¢è¿å¯¹webpackæ„Ÿå…´è¶£çš„æœ‹å‹èƒ½å¤Ÿç›¸äº’äº¤æµï¼Œå…³æ³¨æˆ‘çš„ç³»åˆ—æ–‡ç« ã€‚\r\n\r\n## å‚è€ƒèµ„æ–™\r\n\r\n- [NodeJS internal - cjs module loader](https://github.com/nodejs/node/blob/master/lib/internal/modules/cjs/loader.js)\r\n- [webpack MainTemplate](https://github.com/webpack/webpack/blob/master/lib/MainTemplate.js)\r\n- [webpack FunctionModuleTemplatePlugin](https://github.com/webpack/webpack/blob/master/lib/FunctionModuleTemplatePlugin.js)\r\n- [webpack RuntimeTemplate](https://github.com/webpack/webpack/blob/master/lib/RuntimeTemplate.js)\r\n- [webpack runtime chunkç¤ºä¾‹](https://gitee.com/alienzhou/codes/o431yhewq8kimbtdnjpcl12)","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/18","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/18/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/18/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/18/events","html_url":"https://github.com/alienzhou/blog/issues/18","id":390657717,"node_id":"MDU6SXNzdWUzOTA2NTc3MTc=","number":18,"title":"ã€webpackè¿›é˜¶ã€‘ä½¿ç”¨babelé¿å…webpackç¼–è¯‘è¿è¡Œæ—¶æ¨¡å—ä¾èµ–","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845019,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE5","url":"https://api.github.com/repos/alienzhou/blog/labels/Webpack","name":"Webpack","color":"e4e669","default":false,"description":""},{"id":1160330255,"node_id":"MDU6TGFiZWwxMTYwMzMwMjU1","url":"https://api.github.com/repos/alienzhou/blog/labels/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7","name":"è‡ªåŠ¨åŒ–å·¥å…·","color":"f9c0d1","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T12:30:46Z","updated_at":"2018-12-13T12:55:45Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## å¼•è¨€\r\n\r\nbabelæ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å·¥å…·ï¼Œä½œç”¨è¿œä¸æ­¢æˆ‘ä»¬å¹³æ—¶çš„ES6 -> ES5è¯­æ³•è½¬æ¢è¿™ä¹ˆå•ä¸€ã€‚åœ¨å‰ç«¯è¿›é˜¶çš„é“è·¯ä¸Šï¼Œäº†è§£ä¸å­¦ä¹ babelåŠå…¶çµæ´»çš„æ’ä»¶æ¨¡å¼å°†ä¼šä¸ºå‰ç«¯èµ‹äºˆæ›´å¤šçš„å¯èƒ½æ€§ã€‚\r\n\r\næœ¬æ–‡å°±æ˜¯è¿ç”¨babelï¼Œé€šè¿‡ç¼–å†™babelæ’ä»¶è§£å†³äº†ä¸€ä¸ªå®é™…é¡¹ç›®ä¸­çš„é—®é¢˜ã€‚\r\n\r\n> æœ¬æ–‡ç›¸å…³ä»£ç å·²æ‰˜ç®¡è‡³github: [babel-plugin-import-customized-require](https://github.com/alienzhou/babel-plugin-import-customized-require)\r\n\r\n## 1. é‡åˆ°çš„é—®é¢˜ \r\n\r\næœ€è¿‘åœ¨é¡¹ç›®ä¸­é‡åˆ°è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬çŸ¥é“ï¼Œä½¿ç”¨webpackä½œä¸ºæ„å»ºå·¥å…·æ˜¯ä¼šé»˜è®¤è‡ªåŠ¨å¸®æˆ‘ä»¬è¿›è¡Œä¾èµ–æ„å»ºï¼›ä½†æ˜¯åœ¨é¡¹ç›®ä»£ç ä¸­ï¼Œæœ‰ä¸€éƒ¨åˆ†çš„ä¾èµ–æ˜¯è¿è¡Œæ—¶ä¾èµ–/éç¼–è¯‘æœŸä¾èµ–ï¼ˆå¯ä»¥ç†è§£ä¸ºåƒrequirejsã€seajsé‚£æ ·çš„çº¯å‰ç«¯æ¨¡å—åŒ–ï¼‰ï¼Œå¯¹äºè¿™ç§ä¾èµ–ä¸åšå¤„ç†ä¼šå¯¼è‡´webpackç¼–è¯‘å‡ºé”™ã€‚\r\n\r\nä¸ºä»€ä¹ˆéœ€è¦éç¼–è¯‘æœŸä¾èµ–å‘¢ï¼Ÿä¾‹å¦‚ï¼Œåœ¨å½“å‰çš„ä¸šåŠ¡æ¨¡å—ï¼ˆä¸€ä¸ªç‹¬ç«‹çš„webpackä»£ç ä»“åº“ï¼‰é‡Œï¼Œæˆ‘ä¾èµ–äº†ä¸€ä¸ªå…¬å…±ä¸šåŠ¡æ¨¡å—çš„æ‰“ç‚¹ä»£ç \r\n\r\n```javascript\r\n// è¿™æ˜¯homeä¸šåŠ¡æ¨¡å—ä»£ç \r\n// ä¾èµ–äº†commonä¸šåŠ¡æ¨¡å—çš„ä»£ç \r\nimport log from 'common:util/log.js'\r\n\r\nlog('act-1');\r\n```\r\n\r\nç„¶è€Œï¼Œå¯èƒ½æ˜¯ç”±äºæŠ€æœ¯æ ˆä¸ç»Ÿä¸€ï¼Œæˆ–æ˜¯å› ä¸ºcommonä¸šåŠ¡ä»£ç é—ç•™é—®é¢˜æ— æ³•é‡æ„ï¼Œæˆ–è€…ä»…ä»…æ˜¯ä¸ºäº†ä¸šåŠ¡æ¨¡å—çš„åˆ†æ²»â€¦â€¦æ€»ä¹‹ï¼Œæ— æ³•åœ¨webpackç¼–è¯‘æœŸè§£å†³è¿™éƒ¨åˆ†æ¨¡å—ä¾èµ–ï¼Œè€Œæ˜¯éœ€è¦æ”¾åœ¨å‰ç«¯è¿è¡Œæ—¶æ¡†æ¶è§£å†³ã€‚\r\n\r\nä¸ºäº†è§£å†³webpackç¼–è¯‘æœŸæ— æ³•è§£æè¿™ç§æ¨¡å—ä¾èµ–çš„é—®é¢˜ï¼Œå¯ä»¥ç»™è¿™ç§éç¼–è¯‘æœŸä¾èµ–å¼•å…¥æ–°çš„è¯­æ³•ï¼Œä¾‹å¦‚ä¸‹é¢è¿™æ ·ï¼š\r\n\r\n```javascript\r\n// __my_require__æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„å‰ç«¯requireæ–¹æ³•\r\nvar log = __my_require__('common:util/log.js')\r\n\r\nlog('act-1');\r\n```\r\n\r\nä½†è¿™æ ·å°±å¯¼è‡´äº†æˆ‘ä»¬ä»£ç å½¢å¼çš„åˆ†è£‚ï¼Œæ‹¥æŠ±è§„èŒƒè®©æˆ‘ä»¬å¸Œæœ›è¿˜æ˜¯èƒ½å¤Ÿç”¨ESMçš„æ ‡å‡†è¯­æ³•æ¥ä¸€è§†åŒä»ã€‚\r\n\r\næˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›èƒ½åƒä¸‹é¢è¿™æ ·å†™ä»£ç ï¼š\r\n\r\n```javascript\r\n// æ ‡å‡†çš„ESMè¯­æ³•\r\nimport * as log from 'common:util/log.js';\r\n\r\nlog('act-1');\r\n```\r\n\r\næ­¤å¤–ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨webpackæä¾›äº†externalsé…ç½®æ¥é¿å…æŸäº›æ¨¡å—è¢«webpackæ‰“åŒ…ã€‚ç„¶è€Œï¼Œä¸€ä¸ªé‡è¦çš„é—®é¢˜æ˜¯ï¼Œåœ¨å·²æœ‰çš„commonä»£ç ä¸­æœ‰ä¸€å¥—å‰ç«¯æ¨¡å—åŒ–è¯­æ³•ï¼Œè¦å°†webpackç¼–è¯‘å‡ºæ¥çš„ä»£ç ä¸å·²æœ‰æ¨¡å¼èåˆå­˜åœ¨ä¸€äº›é—®é¢˜ã€‚å› æ­¤è¯¥æ–¹å¼ä¹Ÿå­˜åœ¨ä¸è¶³ã€‚\r\n\r\né’ˆå¯¹ä¸Šé¢çš„æè¿°ï¼Œæ€»ç»“æ¥è¯´ï¼Œæˆ‘ä»¬çš„ç›®çš„å°±æ˜¯ï¼š\r\n\r\n- èƒ½å¤Ÿåœ¨ä»£ç ä¸­ä½¿ç”¨ESMè¯­æ³•ï¼Œæ¥è¿›è¡Œéç¼–è¯‘æœŸåˆ†æçš„æ¨¡å—å¼•ç”¨\r\n- ç”±äºwebpackä¼šå°è¯•æ‰“åŒ…è¯¥ä¾èµ–ï¼Œéœ€è¦ä¸ä¼šåœ¨ç¼–è¯‘æœŸå‡ºé”™\r\n\r\n## 2. è§£å†³æ€è·¯\r\n\r\nåŸºäºä¸Šé¢çš„ç›®æ ‡ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æœ‰ä¸€ç§æ–¹å¼èƒ½å¤Ÿæ ‡è¯†ä¸éœ€è¦ç¼–è¯‘çš„è¿è¡ŒæœŸä¾èµ–ã€‚ä¾‹å¦‚`util/record`è¿™ä¸ªæ¨¡å—ï¼Œå¦‚æœæ˜¯è¿è¡Œæ—¶ä¾èµ–ï¼Œå¯ä»¥å‚è€ƒæ ‡å‡†è¯­æ³•ï¼Œä¸ºæ¨¡å—åæ·»åŠ æ ‡è¯†ï¼š`runtime:util/record`ã€‚æ•ˆæœå¦‚ä¸‹ï¼š\r\n\r\n```javascript\r\n// ä¸‹é¢è¿™ä¸¤è¡Œæ˜¯æ­£å¸¸çš„ç¼–è¯‘æœŸä¾èµ–\r\nimport React from 'react';\r\nimport Nav from './component/nav';\r\n\r\n// ä¸‹é¢è¿™ä¸¤ä¸ªæ¨¡å—ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›webpackåœ¨ç¼–è¯‘æœŸè¿›è¡Œå¤„ç†\r\nimport record from 'runtime:util/record';\r\nimport {Banner, List} from 'runtime:ui/layout/component';\r\n```\r\n\r\nå…¶æ¬¡ï¼Œè™½ç„¶æ ‡è¯†å·²ç»å¯ä»¥è®©å¼€å‘äººå‘˜çŸ¥é“ä»£ç é‡Œå“ªäº›æ¨¡å—æ˜¯webpackéœ€è¦æ‰“åŒ…çš„ä¾èµ–ï¼Œå“ªäº›æ˜¯éç¼–è¯‘æœŸä¾èµ–ï¼›ä½†webpackä¸çŸ¥é“ï¼Œå®ƒåªä¼šæ‹¿åˆ°æ¨¡å—æºç ï¼Œåˆ†æimportè¯­æ³•æ‹¿åˆ°ä¾èµ–ï¼Œç„¶åå°è¯•åŠ è½½ä¾èµ–æ¨¡å—ã€‚ä½†è¿™æ—¶webpackå‚»çœ¼äº†ï¼Œå› ä¸ºåƒ`runtime:util/record`è¿™æ ·çš„æ¨¡å—æ˜¯è¿è¡Œæ—¶ä¾èµ–ï¼Œç¼–è¯‘æœŸæ‰¾ä¸åˆ°è¯¥æ¨¡å—ã€‚é‚£ä¹ˆï¼Œå°±éœ€è¦é€šè¿‡ä¸€ç§æ–¹å¼ï¼Œè®©webpackâ€œçœ‹ä¸è§â€éç¼–è¯‘æœŸçš„ä¾èµ–ã€‚\r\n\r\næœ€åï¼Œæ‹¿åˆ°éç¼–è¯‘æœŸä¾èµ–ï¼Œç”±äºæµè§ˆå™¨ç°åœ¨è¿˜ä¸æ”¯æŒESMçš„importè¯­æ³•ï¼Œå› æ­¤éœ€è¦å°†å®ƒå˜ä¸ºåœ¨å‰ç«¯è¿è¡Œæ—¶æˆ‘ä»¬è‡ªå®šä¹‰çš„æ¨¡å—ä¾èµ–è¯­æ³•ã€‚\r\n\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/8/18/1654c154b3778163?w=626&h=1454&f=png&s=70125)\r\n\r\n## 3. ä½¿ç”¨babelå¯¹æºç è¿›è¡Œåˆ†æ\r\n\r\n### 3.1. babelç›¸å…³å·¥å…·ä»‹ç»\r\n\r\n> å¯¹babelä»¥åŠæ’ä»¶æœºåˆ¶ä¸å¤ªäº†è§£çš„åŒå­¦ï¼Œå¯ä»¥å…ˆçœ‹è¿™ä¸€éƒ¨åˆ†åšä¸€ä¸ªç®€å•çš„äº†è§£ã€‚\r\n\r\nbabelæ˜¯ä¸€ä¸ªå¼ºå¤§çš„javascript compilerï¼Œå¯ä»¥å°†æºç é€šè¿‡è¯æ³•åˆ†æä¸è¯­æ³•åˆ†æè½¬æ¢ä¸ºASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼Œé€šè¿‡å¯¹ASTè¿›è¡Œè½¬æ¢ï¼Œå¯ä»¥ä¿®æ”¹æºç ï¼Œæœ€åå†å°†ä¿®æ”¹åçš„ASTè½¬æ¢ä¼šç›®æ ‡ä»£ç ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/8/17/1654852a672a4d8e?w=2004&h=362&f=png&s=107940)\r\n\r\nç”±äºç¯‡å¹…é™åˆ¶ï¼Œæœ¬æ–‡ä¸ä¼šå¯¹compileræˆ–è€…ASTè¿›è¡Œè¿‡å¤šä»‹ç»ï¼Œä½†æ˜¯å¦‚æœä½ å­¦è¿‡ç¼–è¯‘åŸç†ï¼Œé‚£ä¹ˆå¯¹è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€tokenã€ASTåº”è¯¥éƒ½ä¸ä¼šé™Œç”Ÿã€‚å³ä½¿æ²¡äº†è§£è¿‡ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œä½ å¯ä»¥ç²—ç•¥çš„ç†è§£ä¸ºï¼šbabelæ˜¯ä¸€ä¸ªcompilerï¼Œå®ƒå¯ä»¥å°†javascriptæºç è½¬åŒ–ä¸ºä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œè¿™ç§æ•°æ®ç»“æ„å°±æ˜¯æ ‘ï¼Œä¹Ÿå°±æ˜¯ASTï¼Œå®ƒæ˜¯ä¸€ç§èƒ½å¤Ÿå¾ˆå¥½è¡¨ç¤ºæºç çš„ç»“æ„ã€‚babelçš„ASTæ˜¯åŸºäº[ESTree](https://github.com/estree/estree)çš„ã€‚\r\n\r\nä¾‹å¦‚ï¼Œ`var alienzhou = 'happy'`è¿™æ¡è¯­å¥ï¼Œç»è¿‡babelå¤„ç†åå®ƒçš„ASTå¤§æ¦‚æ˜¯ä¸‹é¢è¿™æ ·çš„\r\n\r\n```javascript\r\n{\r\n    type: 'VariableDeclaration',\r\n    kind: 'var',\r\n    // ...å…¶ä»–å±æ€§\r\n    decolarations: [{\r\n        type: 'VariableDeclarator',\r\n        id: {\r\n            type: 'Identifier',\r\n            name: 'alienzhou',\r\n            // ...å…¶ä»–å±æ€§\r\n        },\r\n        init: {\r\n            type: 'StringLiteral',\r\n            value: 'happy',\r\n            // ...å…¶ä»–å±æ€§\r\n        }\r\n    }],\r\n}\r\n```\r\n\r\nè¿™éƒ¨åˆ†AST nodeè¡¨ç¤ºï¼Œè¿™æ˜¯ä¸€æ¡å˜é‡å£°æ˜çš„è¯­å¥ï¼Œä½¿ç”¨`var`å…³é”®å­—ï¼Œå…¶ä¸­idå’Œinitå±æ€§åˆæ˜¯ä¸¤ä¸ªAST nodeï¼Œåˆ†åˆ«æ˜¯åç§°ä¸ºalienzhouçš„æ ‡è¯†ç¬¦ï¼ˆIdentifierï¼‰å’Œå€¼ä¸ºhappyçš„å­—ç¬¦ä¸²å­—é¢é‡ï¼ˆStringLiteralï¼‰ã€‚\r\n\r\nè¿™é‡Œï¼Œç®€å•ä»‹ç»ä¸€äº›å¦‚ä½•ä½¿ç”¨babelåŠå…¶æä¾›çš„ä¸€äº›åº“æ¥è¿›è¡ŒASTçš„åˆ†æå’Œä¿®æ”¹ã€‚ç”ŸæˆASTå¯ä»¥é€šè¿‡`babel-core`é‡Œçš„æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š\r\n\r\n```javascript\r\nconst babel = require('babel-core');\r\nconst {ast} = babel.transform(`var alienzhou = 'happy'`);\r\n```\r\n\r\nç„¶åéå†ASTï¼Œæ‰¾åˆ°ç‰¹å®šçš„èŠ‚ç‚¹è¿›è¡Œä¿®æ”¹å³å¯ã€‚babelä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†traverseæ–¹æ³•æ¥éå†ASTï¼š\r\n\r\n```javascript\r\nconst traverse = require('babel-traverse').default;\r\n```\r\n\r\nåœ¨babelä¸­è®¿é—®AST nodeä½¿ç”¨çš„æ˜¯[vistoræ¨¡å¼](https://en.wikipedia.org/wiki/Visitor_pattern)ï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·æŒ‡å®šAST node typeæ¥è®¿é—®æ‰€éœ€çš„AST nodeï¼š\r\n\r\n```javascript\r\ntraverse(ast, {\r\n    StringLiteral(path) {\r\n        console.log(path.node.value)\r\n        // ...\r\n    }\r\n})\r\n```\r\n\r\nè¿™æ ·å°±å¯ä»¥å¾—åˆ°æ‰€æœ‰çš„å­—ç¬¦ä¸²å­—é¢é‡ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥æ›¿æ¢è¿™ä¸ªèŠ‚ç‚¹çš„å†…å®¹ï¼š\r\n\r\n```javascript\r\nlet visitor = {\r\n    StringLiteral(path) {\r\n        console.log(path.node.value)\r\n        path.replaceWith(\r\n            t.stringLiteral('excited');\r\n        )\r\n    }\r\n};\r\ntraverse(ast, visitor);\r\n```\r\n\r\n> æ³¨æ„ï¼ŒASTæ˜¯ä¸€ä¸ªmutableå¯¹è±¡ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹æ“ä½œéƒ½ä¼šåœ¨åŸASTä¸Šè¿›è¡Œä¿®æ”¹ã€‚\r\n\r\nè¿™ç¯‡æ–‡ç« ä¸ä¼šè¯¦ç»†ä»‹ç»babel-coreã€babel-traverseçš„APIï¼Œè€Œæ˜¯å¸®åŠ©æ²¡æœ‰æ¥è§¦è¿‡çš„æœ‹å‹å¿«é€Ÿç†è§£å®ƒä»¬ï¼Œå…·ä½“çš„ä½¿ç”¨æ–¹å¼å¯ä»¥å‚è€ƒç›¸å…³æ–‡æ¡£ã€‚\r\n\r\nç”±äºå¤§éƒ¨åˆ†çš„webpacké¡¹ç›®éƒ½ä¼šåœ¨loaderä¸­ä½¿ç”¨babelï¼Œå› æ­¤åªéœ€è¦æä¾›ä¸€ä¸ªbabelçš„æ’ä»¶æ¥å¤„ç†éç¼–è¯‘æœŸä¾èµ–è¯­æ³•å³å¯ã€‚è€Œbabelæ’ä»¶å…¶å®å°±æ˜¯å¯¼å‡ºä¸€ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›æˆ‘ä»¬ä¸Šé¢æåˆ°çš„visitorå¯¹è±¡ã€‚\r\n\r\né‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬ä¸“æ³¨äºvisitorçš„ç¼–å†™å³å¯ã€‚\r\n\r\n### 3.2 ç¼–å†™ä¸€ä¸ªbabelæ’ä»¶æ¥è§£å†³éç¼–è¯‘æœŸä¾èµ–\r\n\r\nESMçš„importè¯­æ³•åœ¨AST node typeä¸­æ˜¯[ImportDeclaration](https://github.com/babel/babel/blob/master/packages/babel-parser/ast/spec.md#importdeclaration)ï¼š\r\n\r\n```javascript\r\nexport default function () {\r\n    return {\r\n        ImportDeclaration: {\r\n            enter(path) {\r\n                // ...\r\n            }\r\n            exit(path) {\r\n                let source = path.node.source;\r\n                if (t.isStringLiteral(source) && /^runtime:/.test(source.value)) {\r\n                    // ...\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nåœ¨enteræ–¹æ³•é‡Œï¼Œéœ€è¦æ”¶é›†ImportDeclarationè¯­æ³•çš„ç›¸å…³ä¿¡æ¯ï¼›åœ¨exitæ–¹æ³•é‡Œï¼Œåˆ¤æ–­å½“å‰ImportDeclarationæ˜¯å¦ä¸ºéç¼–è¯‘æœŸä¾èµ–ï¼Œå¦‚æœæ˜¯åˆ™è¿›è¡Œè¯­æ³•è½¬æ¢ã€‚\r\n\r\næ”¶é›†ImportDeclarationè¯­æ³•ç›¸å…³ä¿¡æ¯éœ€è¦æ³¨æ„ï¼Œå¯¹äºä¸åŒçš„import specifierç±»å‹ï¼Œéœ€è¦ä¸åŒçš„åˆ†ææ–¹å¼ï¼Œä¸‹é¢åˆ—ä¸¾äº†è¿™äº”ç§importï¼š\r\n\r\n```javascript\r\nimport util from 'runtime:util';\r\nimport * as util from 'runtime:util';\r\nimport {util} from 'runtime:util';\r\nimport {util as u} from 'runtime:util';\r\nimport 'runtime:util';\r\n```\r\n\r\nå¯¹åº”äº†ä¸‰ç±»specifierï¼š\r\n\r\n- ImportSpecifierï¼š`import {util} from 'runtime:util'`,`import {util as u} from 'runtime:util';`\r\n- ImportDefaultSpecifierï¼š`import util from 'runtime:util'`\r\n- ImportNamespaceSpecifierï¼š`import * as util from 'runtime:util'`\r\n\r\n> `import 'runtime:util'`ä¸­æ²¡æœ‰specifier\r\n\r\nå¯ä»¥åœ¨ImportDeclarationçš„åŸºç¡€ä¸Šï¼Œå¯¹å­èŠ‚ç‚¹è¿›è¡Œtraverseï¼Œè¿™é‡Œæ–°å»ºäº†ä¸€ä¸ªvisitorç”¨æ¥è®¿é—®Specifierï¼Œé’ˆå¯¹ä¸åŒè¯­æ³•è¿›è¡Œæ”¶é›†ï¼š\r\n\r\n```javascript\r\nconst specifierVisitor = {\r\n    ImportNamespaceSpecifier(_path) {\r\n        let data = {\r\n            type: 'NAMESPACE',\r\n            local: _path.node.local.name\r\n        };\r\n\r\n        this.specifiers.push(data);\r\n    },\r\n\r\n    ImportSpecifier(_path) {\r\n        let data = {\r\n            type: 'COMMON',\r\n            local: _path.node.local.name,\r\n            imported: _path.node.imported ? _path.node.imported.name : null\r\n        };\r\n\r\n        this.specifiers.push(data);\r\n    },\r\n\r\n    ImportDefaultSpecifier(_path) {\r\n        let data = {\r\n            type: 'DEFAULT',\r\n            local: _path.node.local.name\r\n        };\r\n\r\n        this.specifiers.push(data);\r\n    }\r\n}\r\n```\r\n\r\nåœ¨ImportDeclarationä¸­ä½¿ç”¨specifierVisitorè¿›è¡Œéå†ï¼š\r\n\r\n```javascript\r\nexport default function () {\r\n    // store the specifiers in one importDeclaration\r\n    let specifiers = [];\r\n    return {\r\n        ImportDeclaration: {\r\n            enter(path) {\r\n                path.traverse(specifierVisitor, { specifiers });\r\n            }\r\n            exit(path) {\r\n                let source = path.node.source;\r\n                if (t.isStringLiteral(source) && /^runtime:/.test(source.value)) {\r\n                    // ...\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åœ¨è¿›å…¥ImportDeclarationèŠ‚ç‚¹æ—¶ï¼Œæ”¶é›†äº†importè¯­å¥ç›¸å…³ä¿¡æ¯ï¼Œåœ¨é€€å‡ºèŠ‚ç‚¹æ—¶ï¼Œé€šè¿‡åˆ¤æ–­å¯ä»¥çŸ¥é“ç›®å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯éç¼–è¯‘æœŸä¾èµ–ã€‚å› æ­¤ï¼Œå¦‚æœæ˜¯éç¼–è¯‘æœŸä¾èµ–ï¼Œåªéœ€è¦æ ¹æ®æ”¶é›†åˆ°çš„ä¿¡æ¯æ›¿æ¢èŠ‚ç‚¹è¯­æ³•å³å¯ã€‚\r\n\r\nç”Ÿæˆæ–°èŠ‚ç‚¹å¯ä»¥ä½¿ç”¨babel-typesã€‚ä¸è¿‡æ¨èä½¿ç”¨babel-templateï¼Œä¼šä»¤ä»£ç æ›´ç®€ä¾¿ä¸æ¸…æ™°ã€‚ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼Œä¼šæ ¹æ®ä¸åŒçš„importä¿¡æ¯ï¼Œç”Ÿæˆä¸åŒçš„è¿è¡Œæ—¶ä»£ç ï¼Œå…¶ä¸­å‡å®š__my_require__æ–¹æ³•å°±æ˜¯è‡ªå®šä¹‰çš„å‰ç«¯æ¨¡å—requireæ–¹æ³•ã€‚\r\n\r\n```javascript\r\nconst template = require('babel-template');\r\n\r\nfunction constructRequireModule({\r\n    local,\r\n    type,\r\n    imported,\r\n    moduleName\r\n}) {\r\n\r\n    /* using template instead of origin type functions */\r\n    const namespaceTemplate = template(`\r\n        var LOCAL = __my_require__(MODULE_NAME);\r\n    `);\r\n\r\n    const commonTemplate = template(`\r\n        var LOCAL = __my_require__(MODULE_NAME)[IMPORTED];\r\n    `);\r\n\r\n    const defaultTemplate = template(`\r\n        var LOCAL = __my_require__(MODULE_NAME)['default'];\r\n    `);\r\n\r\n    const sideTemplate = template(`\r\n        __my_require__(MODULE_NAME);\r\n    `);\r\n    /* ********************************************** */\r\n\r\n    let declaration;\r\n    switch (type) {\r\n        case 'NAMESPACE':\r\n            declaration = namespaceTemplate({\r\n                LOCAL: t.identifier(local),\r\n                MODULE_NAME: t.stringLiteral(moduleName)\r\n            });\r\n            break;\r\n\r\n        case 'COMMON':\r\n            imported = imported || local;\r\n            declaration = commonTemplate({\r\n                LOCAL: t.identifier(local),\r\n                MODULE_NAME: t.stringLiteral(moduleName),\r\n                IMPORTED: t.stringLiteral(imported)\r\n            });\r\n            break;\r\n\r\n        case 'DEFAULT':\r\n            declaration = defaultTemplate({\r\n                LOCAL: t.identifier(local),\r\n                MODULE_NAME: t.stringLiteral(moduleName)\r\n            });\r\n            break;\r\n\r\n        case 'SIDE':\r\n            declaration = sideTemplate({\r\n                MODULE_NAME: t.stringLiteral(moduleName)\r\n            })\r\n\r\n        default:\r\n            break;\r\n    }\r\n\r\n    return declaration;\r\n}\r\n```\r\n\r\næœ€åæ•´åˆåˆ°ä¸€å¼€å§‹çš„visitorä¸­ï¼š\r\n\r\n```javascript\r\nexport default function () {\r\n    // store the specifiers in one importDeclaration\r\n    let specifiers = [];\r\n    return {\r\n        ImportDeclaration: {\r\n            enter(path) {\r\n                path.traverse(specifierVisitor, { specifiers });\r\n            }\r\n            exit(path) {\r\n                let source = path.node.source;\r\n                let moduleName = path.node.source.value;\r\n                if (t.isStringLiteral(source) && /^runtime:/.test(source.value)) {\r\n                    let nodes;\r\n                    if (specifiers.length === 0) {\r\n                        nodes = constructRequireModule({\r\n                            moduleName,\r\n                            type: 'SIDE'\r\n                        });\r\n                        nodes = [nodes]\r\n                    }\r\n                    else {\r\n                        nodes = specifiers.map(constructRequireModule);\r\n                    }\r\n                    path.replaceWithMultiple(nodes);\r\n                }\r\n                specifiers = [];\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\né‚£ä¹ˆï¼Œå¯¹äºä¸€æ®µ`import util from 'runtime:util'`çš„æºç ï¼Œåœ¨è¯¥babelæ’ä»¶ä¿®æ”¹åå˜ä¸ºäº†`var util = require('runtime:util')['default']`ï¼Œè¯¥ä»£ç ä¹Ÿä¼šè¢«webpackç›´æ¥è¾“å‡ºã€‚\r\n\r\nè¿™æ ·ï¼Œé€šè¿‡babelæ’ä»¶ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†æ–‡ç« æœ€ä¸€å¼€å§‹çš„ç›®æ ‡ã€‚\r\n\r\n## 4. å¤„ç†dynamic import\r\n\r\nç»†å¿ƒçš„è¯»è€…è‚¯å®šä¼šå‘ç°äº†ï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢åªè§£å†³äº†é™æ€importçš„é—®é¢˜ï¼Œé‚£ä¹ˆåƒä¸‹é¢è¿™æ ·çš„åŠ¨æ€importä¸æ˜¯ä»ç„¶ä¼šæœ‰ä»¥ä¸Šçš„é—®é¢˜ä¹ˆï¼Ÿ\r\n\r\n```javascript\r\nimport('runtime:util').then(u => {\r\n    u.record(1);\r\n});\r\n```\r\næ˜¯çš„ï¼Œä»ç„¶ä¼šæœ‰é—®é¢˜ã€‚å› æ­¤ï¼Œè¿›ä¸€æ­¥æˆ‘ä»¬è¿˜éœ€è¦å¤„ç†åŠ¨æ€importçš„è¯­æ³•ã€‚è¦åšçš„å°±æ˜¯åœ¨visitorä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„node typeï¼š\r\n\r\n```javascript\r\n{\r\n    Import: {\r\n        enter(path) {\r\n            let callNode = path.parentPath.node;\r\n            let nameNode = callNode.arguments && callNode.arguments[0] ? callNode.arguments[0] : null;\r\n\r\n            if (t.isCallExpression(callNode)\r\n                && t.isStringLiteral(nameNode)\r\n                && /^runtime:/.test(nameNode.value)\r\n            ) {\r\n                let args = callNode.arguments;\r\n                path.parentPath.replaceWith(\r\n                    t.callExpression(\r\n                        t.memberExpression(\r\n                            t.identifier('__my_require__'), t.identifier('async'), false),\r\n                            args\r\n                ));\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nè¿™æ—¶ï¼Œä¸Šé¢çš„åŠ¨æ€importä»£ç å°±ä¼šè¢«æ›¿æ¢ä¸ºï¼š\r\n\r\n```javascript\r\n__my_require__.async('runtime:util').then(u => {\r\n    u.record(1);\r\n});\r\n```\r\n\r\néå¸¸æ–¹ä¾¿å§ã€‚\r\n\r\n## 5. å†™åœ¨æœ€å\r\n\r\n> æœ¬æ–‡ç›¸å…³ä»£ç å·²æ‰˜ç®¡è‡³github: [babel-plugin-import-customized-require](https://github.com/alienzhou/babel-plugin-import-customized-require)\r\n\r\næœ¬æ–‡æ˜¯ä»ä¸€ä¸ªå…³äºwebpackç¼–è¯‘æœŸçš„éœ€æ±‚å‡ºå‘ï¼Œåº”ç”¨babelæ¥ä½¿ä»£ç ä¸­éƒ¨åˆ†æ¨¡å—ä¾èµ–ä¸åœ¨webpackç¼–è¯‘æœŸè¿›è¡Œå¤„ç†ã€‚å…¶å®ä»ä¸­å¯ä»¥çœ‹å‡ºï¼Œbabelç»™æˆ‘ä»¬èµ‹äºˆäº†æå¤§çš„å¯èƒ½æ€§ã€‚\r\n\r\næ–‡ä¸­è§£å†³çš„é—®é¢˜åªæ˜¯ä¸€ä¸ªå°éœ€æ±‚ï¼Œä¹Ÿè®¸ä½ ä¼šæœ‰æ›´ä¸é”™çš„è§£å†³æ–¹æ¡ˆï¼›ç„¶è€Œè¿™é‡Œæ›´å¤šçš„æ˜¯å±•ç¤ºäº†babelçš„çµæ´»ã€å¼ºå¤§ï¼Œå®ƒç»™å‰ç«¯å¸¦æ¥çš„æ›´å¤šçš„ç©ºé—´ä¸å¯èƒ½æ€§ï¼Œåœ¨è®¸å¤šè¡ç”Ÿçš„é¢†åŸŸä¹Ÿéƒ½èƒ½å‘ç°å®ƒçš„èº«å½±ã€‚å¸Œæœ›æœ¬æ–‡èƒ½æˆä¸ºä¸€ä¸ªå¼•å­ï¼Œä¸ºä½ æ‹“å±•è§£å†³é—®é¢˜çš„å¦ä¸€æ¡æ€è·¯ã€‚\r\n\r\n## å‚è€ƒèµ„æ–™\r\n\r\n- [Babel AST spec](https://github.com/babel/babel/blob/master/packages/babel-parser/ast/spec.md)\r\n- [visitor pattern](https://en.wikipedia.org/wiki/Visitor_pattern)\r\n- [Babel Plugin Handbook](https://github.com/jamiebuilds/babel-handbook/blob/master/translations/en/plugin-handbook.md)\r\n- [AST Explorer](http://astexplorer.net/)","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/17","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/17/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/17/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/17/events","html_url":"https://github.com/alienzhou/blog/issues/17","id":390638597,"node_id":"MDU6SXNzdWUzOTA2Mzg1OTc=","number":17,"title":"å„ç±»â€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯åŸç†ä¸å®ä¾‹ï¼ˆPolling/COMET/SSE/WebSocketï¼‰","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845016,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E7%BB%BC%E5%90%88","name":"ç»¼åˆ","color":"a2eeef","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T11:36:30Z","updated_at":"2018-12-13T11:36:30Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## å‰è¨€\r\n\r\næœåŠ¡å™¨æ¨ï¼ˆServer Pushï¼‰æ˜¯ä¸€ç±»ç‰¹å®šæŠ€æœ¯çš„æ€»ç§°ã€‚ä¸€èˆ¬æƒ…å†µï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„äº¤äº’æ–¹å¼æ˜¯ï¼šå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚è¿”å›å“åº”ç»“æœï¼Œå®¢æˆ·ç«¯æ¥æ”¶å“åº”ç»“æœè¿›è¡Œå¤„ç†ã€‚ä»ä¸Šè¿°çš„äº¤äº’è¿‡ç¨‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œå®¢æˆ·ç«¯æƒ³è¦è·å–æ•°æ®ï¼Œéœ€è¦è‡ªä¸»åœ°å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚ï¼Œè·å–ç›¸å…³æ•°æ®ã€‚\r\n\r\nåœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹ï¼Œå®¢æˆ·ç«¯çš„â€œä¸»åŠ¨å¼â€è¡Œä¸ºå·²ç»å¯ä»¥æ»¡è¶³éœ€æ±‚äº†ã€‚ç„¶è€Œï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œéœ€è¦æœåŠ¡å™¨â€œä¸»åŠ¨â€å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ã€‚ä¾‹å¦‚ï¼š\r\n\r\n- èŠå¤©å®¤æˆ–è€…å¯¹è¯ç±»åº”ç”¨\r\n- å®æ—¶çš„æ•°æ®ç›‘æ§ä¸ç»Ÿè®¡\r\n- è‚¡ç¥¨è´¢ç»ç±»çœ‹æ¿ç­‰ç­‰\r\n\r\nè¿™ç±»åº”ç”¨æœ‰å‡ ä¸ªé‡è¦ç‰¹ç‚¹ï¼šè¦æ±‚è¾ƒé«˜çš„å®æ—¶æ€§ï¼ŒåŒæ—¶å®¢æˆ·ç«¯æ— æ³•é¢„æœŸæ•°æ®æ›´æ–°å‘¨æœŸï¼Œåœ¨æœåŠ¡ç«¯è·å–æœ€æ–°æ•°æ®æ—¶ï¼Œéœ€è¦å°†ä¿¡æ¯åŒæ­¥ç»™å®¢æˆ·ç«¯ã€‚è¿™ç±»åº”ç”¨åœºæ™¯è¢«ç§°ä¸ºâ€œæœåŠ¡å™¨æ¨â€ï¼ˆServer Pushï¼‰ã€‚\r\n\r\nâ€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯ç”±æ¥å·²ä¹…ï¼Œä»æœ€åˆçš„ç®€å•è½®è¯¢ï¼Œåˆ°åæ¥åŸºäºé•¿è½®è¯¢çš„COMETï¼Œåˆ°HTML5è§„èŒƒçš„SSEï¼Œä»¥åŠå®ç°å…¨åŒå·¥çš„WebSocketåè®®ï¼Œâ€œæœåŠ¡å™¨æ¨â€çš„æŠ€æœ¯ä¸æ–­å‘å±•ã€‚æœ¬æ–‡ä¼šä»‹ç»è¿™äº›æŠ€æœ¯çš„åŸºæœ¬åŸç†ä»¥åŠå®ç°æ–¹å¼ï¼Œæ¥å¸®åŠ©å¤§å®¶è¿…é€Ÿäº†è§£ä¸æŒæ¡â€œæœåŠ¡å™¨æ¨â€å„ç±»æŠ€æœ¯çš„åŸºæœ¬åŸç†ã€‚æ–‡æœ«ä¼šé™„ä¸Šå®Œæ•´çš„demoåœ°å€ã€‚\r\n\r\n## 1. ç®€æ˜“è½®è¯¢\r\n\r\nç®€æ˜“è½®è¯¢æ˜¯â€œè§£å†³â€è¯¥é—®é¢˜æœ€ç®€é™‹çš„ä¸€ä¸ªæŠ€æœ¯æ–¹å¼ã€‚\r\n\r\nç®€æ˜“è½®è¯¢æœ¬è´¨ä¸Šå°±æ˜¯åœ¨å‰ç«¯åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯éš”ä¸€å®šçš„æ—¶é—´å»æŸ¥è¯¢åç«¯æœåŠ¡ï¼Œå¦‚æœæœ‰æ•°æ®åˆ™è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚\r\n\r\n```javascript\r\nfunction polling() {\r\n    fetch(url).then(data => {\r\n        process(data);\r\n        return;\r\n    }).catch(err => {\r\n        return;\r\n    }).then(() => {\r\n        setTimeout(polling, 5000);\r\n    });\r\n}\r\n\r\npolling();\r\n```\r\n\r\nè½®è¯¢å¼€å§‹æ—¶ï¼Œå‘åç«¯å‘é€è¯·æ±‚ï¼Œå¾…å“åº”ç»“æŸåï¼Œé—´éš”ä¸€å®šæ—¶é—´å†å»è¯·æ±‚æ•°æ®ï¼Œå¦‚æ­¤å¾ªç¯å¾€å¤ã€‚æ•ˆæœå¦‚ä¸‹ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/8/163db06dae676193?w=1257&h=365&f=gif&s=315178)\r\n\r\nè¿™ç§åšæ³•çš„ä¼˜ç‚¹å°±æ˜¯éå¸¸ç®€å•ï¼Œå‡ ä¹ä¸éœ€è¦è¿›è¡Œä»»ä½•é¢å¤–çš„é…ç½®æˆ–å¼€å‘ã€‚\r\n\r\nè€Œä¸æ­¤åŒæ—¶ï¼Œç¼ºç‚¹ä¹Ÿååˆ†æ˜æ˜¾ã€‚é¦–å…ˆï¼Œè¿™ç§ç›¸å½“äºå®šæ—¶è½®è¯¢çš„æ–¹å¼åœ¨è·å–æ•°æ®ä¸Šå­˜åœ¨æ˜¾è€Œæ˜“è§çš„å»¶è¿Ÿï¼Œè¦æƒ³é™ä½å»¶è¿Ÿï¼Œåªèƒ½ç¼©çŸ­è½®è¯¢é—´éš”ï¼›è€Œå¦ä¸€æ–¹é¢ï¼Œæ¯æ¬¡è½®è¯¢éƒ½ä¼šè¿›è¡Œä¸€æ¬¡å®Œæ•´çš„HTTPè¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®æ›´æ–°ï¼Œç›¸å½“äºæ˜¯ä¸€æ¬¡â€œæµªè´¹â€çš„è¯·æ±‚ï¼Œå¯¹æœåŠ¡ç«¯èµ„æºä¹Ÿæ˜¯ä¸€ç§æµªè´¹ã€‚\r\n\r\nå› æ­¤ï¼Œè½®è¯¢çš„æ—¶é—´é—´éš”éœ€è¦è¿›è¡Œä»”ç»†è€ƒè™‘ã€‚è½®è¯¢çš„é—´éš”è¿‡é•¿ï¼Œä¼šå¯¼è‡´ç”¨æˆ·ä¸èƒ½åŠæ—¶æ¥æ”¶åˆ°æ›´æ–°çš„æ•°æ®ï¼›è½®è¯¢çš„é—´éš”è¿‡çŸ­ï¼Œä¼šå¯¼è‡´æŸ¥è¯¢è¯·æ±‚è¿‡å¤šï¼Œå¢åŠ æœåŠ¡å™¨ç«¯çš„è´Ÿæ‹…ã€‚\r\n\r\n### 2. COMET\r\n\r\néšç€webåº”ç”¨çš„å‘å±•ï¼Œå°¤å…¶æ˜¯åŸºäºajaxçš„web2.0æ—¶ä»£ä¸­webåº”ç”¨éœ€æ±‚ä¸æŠ€æœ¯çš„å‘å±•ï¼ŒåŸºäºçº¯æµè§ˆå™¨çš„â€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯å¼€å§‹å—åˆ°è¾ƒå¤šå…³æ³¨ï¼ŒAlex Russellï¼ˆDojo Toolkit çš„é¡¹ç›® Leadï¼‰ç§°è¿™ç§åŸºäºHTTPé•¿è¿æ¥ã€æ— é¡»åœ¨æµè§ˆå™¨ç«¯å®‰è£…æ’ä»¶çš„â€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯ä¸ºâ€œCometâ€ã€‚\r\n\r\nå¸¸ç”¨çš„COMETåˆ†ä¸ºä¸¤ç§ï¼šåŸºäºHTTPçš„é•¿è½®è¯¢ï¼ˆlong-pollingï¼‰æŠ€æœ¯ï¼Œä»¥åŠåŸºäºiframeçš„é•¿è¿æ¥æµï¼ˆstreamï¼‰æ¨¡å¼ã€‚\r\n\r\n#### 2.1 åŸºäºHTTPçš„é•¿è½®è¯¢ï¼ˆlong-pollingï¼‰\r\n\r\nåœ¨ç®€å•è½®è¯¢ä¸­ï¼Œæˆ‘ä»¬ä¼šæ¯éš”ä¸€å®šçš„æ—¶é—´å‘åç«¯è¯·æ±‚ã€‚è¿™ç§æ–¹å¼æœ€å¤§çš„é—®é¢˜ä¹‹ä¸€å°±æ˜¯ï¼Œæ•°æ®çš„è·å–å»¶è¿Ÿå—é™äºè½®è¯¢é—´éš”ï¼Œæ— æ³•ç¬¬ä¸€æ—¶é—´è·å–æœåŠ¡æƒ³è¦æ¨é€æ•°æ®ã€‚\r\n\r\né•¿è½®è¯¢æ˜¯å†æ­¤åŸºç¡€ä¸Šçš„ä¸€ç§æ”¹è¿›ã€‚å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚åï¼ŒæœåŠ¡ç«¯ä¼šä¿æŒä½è¯¥è¿æ¥ï¼Œç›´åˆ°åç«¯æœ‰æ•°æ®æ›´æ–°åï¼Œæ‰ä¼šå°†æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ï¼›å®¢æˆ·ç«¯åœ¨æ”¶åˆ°å“åº”ç»“æœåå†æ¬¡å‘é€è¯·æ±‚ï¼Œå¦‚æ­¤å¾ªç¯å¾€å¤ã€‚å…³äºç®€å•è½®è¯¢ä¸é•¿è½®è¯¢çš„åŒºåˆ«ï¼Œä¸€å›¾èƒœåƒè¨€ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/7/163dabc8440e4ece?w=665&h=391&f=png&s=33101)\r\n\r\nè¿™æ ·ï¼ŒæœåŠ¡ç«¯ä¸€æ—¦æœ‰æ•°æ®æƒ³è¦æ¨é€ï¼Œå¯ä»¥åŠæ—¶é€è¾¾åˆ°å®¢æˆ·ç«¯ã€‚\r\n\r\n```javascript\r\n\r\nfunction query() {\r\n    fetchMsg('/longpolling')\r\n        .then(function(data) {\r\n            // è¯·æ±‚ç»“æŸï¼Œè§¦å‘äº‹ä»¶é€šçŸ¥eventbus\r\n            eventbus.trigger('fetch-end', {data, status: 0});\r\n        });\r\n}\r\n\r\neventbus.on('fetch-end', function (result) {\r\n    // å¤„ç†æœåŠ¡ç«¯è¿”å›çš„æ•°æ®\r\n    process(result);\r\n    // å†æ¬¡å‘èµ·è¯·æ±‚\r\n    query();\r\n});\r\n```\r\n\r\nä»¥ä¸Šæ˜¯ä¸€æ®µç®€ç•¥ç‰ˆçš„å‰ç«¯ä»£ç ï¼Œé€šè¿‡eventbusæ¥é€šçŸ¥è¯·æ±‚ç»“æŸï¼Œæ”¶åˆ°ç»“æŸæ¶ˆæ¯åï¼Œ`process(result)`å¤„ç†æ‰€éœ€æ•°æ®ï¼ŒåŒæ—¶å†æ¬¡è°ƒç”¨`query()`å‘èµ·è¯·æ±‚ã€‚\r\n\r\nè€Œåœ¨æœåŠ¡ç«¯ï¼Œä»¥nodeä¸ºä¾‹ï¼ŒæœåŠ¡ç«¯åªéœ€è¦åœ¨ç›‘å¬åˆ°æœ‰æ¶ˆæ¯/æ•°æ®æ›´æ–°æ—¶ï¼Œå†è¿›è¡Œè¿”å›å³å¯ã€‚\r\n\r\n```javascript\r\nconst app = http.createServer((req, res) => {\r\n    // è¿”å›æ•°æ®çš„æ–¹æ³•\r\n    const longPollingSend = data => {\r\n        res.end(data);\r\n    };\r\n\r\n    // å½“æœ‰æ•°æ®æ›´æ–°æ—¶ï¼ŒæœåŠ¡ç«¯â€œæ¨é€â€æ•°æ®ç»™å®¢æˆ·ç«¯\r\n    EVENT.addListener(MSG_POST, longPollingSend);\r\n\r\n    req.socket.on('close', () => {\r\n        console.log('long polling socket close');\r\n        // æ³¨æ„åœ¨è¿æ¥å…³é—­æ—¶ç§»é™¤ç›‘å¬ï¼Œé¿å…å†…å­˜æ³„éœ²\r\n        EVENT.removeListener(MSG_POST, longPollingSend);\r\n    });\r\n});\r\n```\r\n\r\næ•ˆæœå¦‚ä¸‹ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/8/163db08447932e5e?w=1200&h=311&f=gif&s=505612)\r\n\r\n### 2.2 åŸºäºiframeçš„é•¿è¿æ¥æµï¼ˆstreamï¼‰æ¨¡å¼\r\n\r\nå½“æˆ‘ä»¬åœ¨é¡µé¢ä¸­åµŒå…¥ä¸€ä¸ªiframeå¹¶è®¾ç½®å…¶srcæ—¶ï¼ŒæœåŠ¡ç«¯å°±å¯ä»¥é€šè¿‡é•¿è¿æ¥â€œæºæºä¸æ–­â€åœ°å‘å®¢æˆ·ç«¯è¾“å‡ºå†…å®¹ã€‚\r\n\r\nä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å‘å®¢æˆ·ç«¯è¿”å›ä¸€æ®µscriptæ ‡ç­¾åŒ…è£¹çš„javascriptä»£ç ï¼Œè¯¥ä»£ç å°±ä¼šåœ¨iframeä¸­æ‰§è¡Œã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬é¢„å…ˆåœ¨iframeçš„çˆ¶é¡µé¢ä¸­å®šä¹‰ä¸€ä¸ªå¤„ç†å‡½æ•°`process()`ï¼Œè€Œåœ¨æ¯æ¬¡æœ‰æ–°æ•°æ®éœ€è¦æ¨é€æ—¶ï¼Œåœ¨è¯¥è¿æ¥å“åº”ä¸­å†™å…¥`<script>parent.process(${your_data})</script>`ã€‚é‚£ä¹ˆiframeä¸­çš„è¿™æ®µä»£ç å°±ä¼šè°ƒç”¨çˆ¶é¡µé¢ä¸­é¢„å…ˆå®šä¹‰çš„`process()`å‡½æ•°ã€‚ï¼ˆæ˜¯ä¸æ˜¯æœ‰ç‚¹åƒJSONPä¼ è¾“æ•°æ®çš„æ–¹å¼ï¼Ÿï¼‰\r\n\r\n```javascript\r\n// åœ¨çˆ¶é¡µé¢ä¸­å®šä¹‰çš„æ•°æ®å¤„ç†æ–¹æ³•\r\nfunction process(data) {\r\n    // do something\r\n}\r\n\r\n// åˆ›å»ºä¸å¯è§çš„iframe\r\nvar iframe = document.createElement('iframe');\r\niframe.style = 'display: none';\r\n// srcæŒ‡å‘åç«¯æ¥å£\r\niframe.src = '/long_iframe';\r\ndocument.body.appendChild(iframe);\r\n```\r\n\r\nåç«¯è¿˜æ˜¯ä»¥nodeä¸ºä¾‹\r\n\r\n```javascript\r\nconst app = http.createServer((req, res) => {\r\n    // è¿”å›æ•°æ®çš„æ–¹æ³•ï¼Œå°†æ•°æ®æ‹¼è£…æˆscriptè„šæœ¬è¿”å›ç»™iframe\r\n    const iframeSend = data => {\r\n        let script = `<script type=\"text/javascript\">\r\n                        parent.process(${JSON.stringify(data)})\r\n                    </script>`;\r\n        res.write(script);\r\n    };\r\n\r\n    res.setHeader('connection', 'keep-alive');\r\n    // æ³¨æ„è®¾ç½®ç›¸åº”å¤´çš„content-type\r\n    res.setHeader('content-type', 'text/html; charset=utf-8');        \r\n    // å½“æœ‰æ•°æ®æ›´æ–°æ—¶ï¼ŒæœåŠ¡ç«¯â€œæ¨é€â€æ•°æ®ç»™å®¢æˆ·ç«¯\r\n    EVENT.addListener(MSG_POST, iframeSend);\r\n\r\n    req.socket.on('close', () => {\r\n        console.log('iframe socket close');\r\n        // æ³¨æ„åœ¨è¿æ¥å…³é—­æ—¶ç§»é™¤ç›‘å¬ï¼Œé¿å…å†…å­˜æ³„éœ²\r\n        EVENT.removeListener(MSG_POST, iframeSend);\r\n    });\r\n});\r\n```\r\n\r\næ•ˆæœå¦‚ä¸‹ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/8/163db0aba564b278?w=1206&h=334&f=gif&s=3632784)\r\n\r\nä¸è¿‡ä½¿ç”¨iframeæœ‰ä¸ªå°ç‘•ç–µï¼Œå› æ­¤è¿™ä¸ªiframeç›¸å½“äºæ°¸è¿œä¹Ÿä¸ä¼šåŠ è½½å®Œæˆï¼Œæ‰€ä»¥æµè§ˆå™¨ä¸Šä¼šä¸€ç›´æœ‰ä¸€ä¸ªloadingæ ‡å¿—ã€‚\r\n\r\næ€»å¾—æ¥è¯´ï¼Œé•¿è½®è¯¢å’Œiframeæµè¿™ä¸¤ç§COMMETæŠ€æœ¯ï¼Œå…·æœ‰äº†ä¸é”™çš„å®ç”¨ä»·å€¼ï¼Œå…¶ç‰¹ç‚¹åœ¨äºå…¼å®¹æ€§éå¸¸å¼ºï¼Œä¸éœ€è¦å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯æ”¯æŒæŸäº›æ–°çš„ç‰¹æ€§ã€‚ä¸è¿‡ï¼Œä¸ºäº†ä¾¿äºå¤„ç†COMETä½¿ç”¨æ—¶çš„ä¸€äº›é—®é¢˜ï¼Œè¿˜æ˜¯æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­è€ƒè™‘ä¸€äº›æˆç†Ÿçš„ç¬¬ä¸‰æ–¹åº“ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒSocket.ioåœ¨ä¸å…¼å®¹WebSocketï¼ˆæˆ‘ä»¬åé¢ä¼šæåˆ°ï¼‰çš„æµè§ˆå™¨ä¸­ä¹Ÿä¼šå›é€€åˆ°é•¿è½®è¯¢æ¨¡å¼ã€‚\r\n\r\nç„¶è€Œï¼ŒCOMETæŠ€æœ¯å¹¶ä¸æ˜¯HTML5æ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œä»å…¼å®¹æ ‡å‡†çš„è§’åº¦å‡ºå‘çš„è¯ï¼Œå¹¶ä¸æ¨èä½¿ç”¨ã€‚ï¼ˆå°¤å…¶åœ¨æˆ‘ä»¬æœ‰äº†ä¸€äº›å…¶ä»–æŠ€æœ¯ä¹‹åï¼‰\r\n\r\n### 3. SSE (Server-Sent Events)\r\n\r\nSSE (Server-Sent Events) æ˜¯HTML5æ ‡å‡†ä¸­çš„ä¸€éƒ¨åˆ†ã€‚å…¶å®ç°åŸç†ç±»ä¼¼äºæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­æåˆ°çš„åŸºäºiframeçš„é•¿è¿æ¥æ¨¡å¼ã€‚\r\n\r\nHTTPå“åº”å†…å®¹æœ‰ä¸€ç§ç‰¹æ®Šçš„content-type â€”â€” text/event-streamï¼Œè¯¥å“åº”å¤´æ ‡è¯†äº†å“åº”å†…å®¹ä¸ºäº‹ä»¶æµï¼Œå®¢æˆ·ç«¯ä¸ä¼šå…³é—­è¿æ¥ï¼Œè€Œæ˜¯ç­‰å¾…æœåŠ¡ç«¯ä¸æ–­å¾—å‘é€å“åº”ç»“æœã€‚\r\n\r\nSSEè§„èŒƒæ¯”è¾ƒç®€å•ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šæµè§ˆå™¨ä¸­çš„`EventSource`å¯¹è±¡ï¼Œä»¥åŠæœåŠ¡å™¨ç«¯ä¸æµè§ˆå™¨ç«¯ä¹‹é—´çš„é€šè®¯åè®®ã€‚\r\n\r\nåœ¨æµè§ˆå™¨ä¸­å¯ä»¥é€šè¿‡`EventSource`æ„é€ å‡½æ•°æ¥åˆ›å»ºè¯¥å¯¹è±¡\r\n\r\n```javascript\r\nvar source = new EventSource('/sse');\r\n```\r\n\r\nè€ŒSSEçš„å“åº”å†…å®¹å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªäº‹ä»¶æµï¼Œç”±ä¸åŒçš„äº‹ä»¶æ‰€ç»„æˆã€‚è¿™äº›äº‹ä»¶ä¼šè§¦å‘å‰ç«¯`EventSource`å¯¹è±¡ä¸Šçš„æ–¹æ³•ã€‚\r\n\r\n```javascript\r\n// é»˜è®¤çš„äº‹ä»¶\r\nsource.addEventListener('message', function (e) {\r\n    console.log(e.data);\r\n}, false);\r\n\r\n// ç”¨æˆ·è‡ªå®šä¹‰çš„äº‹ä»¶å\r\nsource.addEventListener('my_msg', function (e) {\r\n    process(e.data);\r\n}, false);\r\n\r\n// ç›‘å¬è¿æ¥æ‰“å¼€\r\nsource.addEventListener('open', function (e) {\r\n    console.log('open sse');\r\n}, false);\r\n\r\n// ç›‘å¬é”™è¯¯\r\nsource.addEventListener('error', function (e) {\r\n    console.log('error');\r\n});\r\n\r\n```\r\n\r\n`EventSource`é€šè¿‡äº‹ä»¶ç›‘å¬çš„æ–¹å¼æ¥å·¥ä½œã€‚æ³¨æ„ä¸Šé¢çš„ä»£ç ç›‘å¬äº†`my_msg`äº‹ä»¶ï¼ŒSSEæ”¯æŒè‡ªå®šä¹‰äº‹ä»¶ï¼Œé»˜è®¤äº‹ä»¶é€šè¿‡ç›‘å¬`message`æ¥è·å–æ•°æ®ã€‚\r\n\r\nSSEä¸­ï¼Œæ¯ä¸ªäº‹ä»¶ç”±ç±»å‹å’Œæ•°æ®ä¸¤éƒ¨åˆ†ç»„æˆï¼ŒåŒæ—¶æ¯ä¸ªäº‹ä»¶å¯ä»¥æœ‰ä¸€ä¸ªå¯é€‰çš„æ ‡è¯†ç¬¦ã€‚ä¸åŒäº‹ä»¶çš„å†…å®¹ä¹‹é—´é€šè¿‡ä»…åŒ…å«å›è½¦ç¬¦å’Œæ¢è¡Œç¬¦çš„ç©ºè¡Œï¼ˆ\"\\r\\n\"ï¼‰æ¥åˆ†éš”ã€‚æ¯ä¸ªäº‹ä»¶çš„æ•°æ®å¯èƒ½ç”±å¤šè¡Œç»„æˆã€‚\r\n\r\n- ç±»å‹ä¸ºç©ºç™½ï¼Œè¡¨ç¤ºè¯¥è¡Œæ˜¯æ³¨é‡Šï¼Œä¼šåœ¨å¤„ç†æ—¶è¢«å¿½ç•¥ã€‚\r\n- ç±»å‹ä¸º dataï¼Œè¡¨ç¤ºè¯¥è¡ŒåŒ…å«çš„æ˜¯æ•°æ®ã€‚ä»¥ data å¼€å¤´çš„è¡Œå¯ä»¥å‡ºç°å¤šæ¬¡ã€‚æ‰€æœ‰è¿™äº›è¡Œéƒ½æ˜¯è¯¥äº‹ä»¶çš„æ•°æ®ã€‚\r\n- ç±»å‹ä¸º eventï¼Œè¡¨ç¤ºè¯¥è¡Œç”¨æ¥å£°æ˜äº‹ä»¶çš„ç±»å‹ã€‚æµè§ˆå™¨åœ¨æ”¶åˆ°æ•°æ®æ—¶ï¼Œä¼šäº§ç”Ÿå¯¹åº”ç±»å‹çš„äº‹ä»¶ã€‚ä¾‹å¦‚æˆ‘åœ¨ä¸Šé¢è‡ªå®šä¹‰çš„`my_msg`äº‹ä»¶ã€‚\r\n- ç±»å‹ä¸º idï¼Œè¡¨ç¤ºè¯¥è¡Œç”¨æ¥å£°æ˜äº‹ä»¶çš„æ ‡è¯†ç¬¦ã€‚\r\n- ç±»å‹ä¸º retryï¼Œè¡¨ç¤ºè¯¥è¡Œç”¨æ¥å£°æ˜æµè§ˆå™¨åœ¨è¿æ¥æ–­å¼€ä¹‹åè¿›è¡Œå†æ¬¡è¿æ¥ä¹‹å‰çš„ç­‰å¾…æ—¶é—´ã€‚\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼ŒSSEç¡®å®æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„åè®®è§„èŒƒï¼ŒæœåŠ¡ç«¯å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼š\r\n\r\n```javascript\r\nconst app = http.createServer((req, res) => {\r\n    const sseSend = data => {\r\n        res.write('retry:10000\\n');            \r\n        res.write('event:my_msg\\n');\r\n        // æ³¨æ„æ–‡æœ¬æ•°æ®ä¼ è¾“\r\n        res.write(`data:${JSON.stringify(data)}\\n\\n`);\r\n    };\r\n\r\n    // æ³¨æ„è®¾ç½®å“åº”å¤´çš„content-type\r\n    res.setHeader('content-type', 'text/event-stream');\r\n    // ä¸€èˆ¬ä¸ä¼šç¼“å­˜SSEæ•°æ®\r\n    res.setHeader('cache-control', 'no-cache');\r\n    res.setHeader('connection', 'keep-alive');\r\n    res.statusCode = 200;\r\n\r\n    res.write('retry:10000\\n');\r\n    res.write('event:my_msg\\n\\n');\r\n\r\n    EVENT.addListener(MSG_POST, sseSend);\r\n\r\n    req.socket.on('close', () => {\r\n        console.log('sse socket close');\r\n        EVENT.removeListener(MSG_POST, sseSend);\r\n    });\r\n});\r\n```\r\n\r\næ•ˆæœå¦‚ä¸‹ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/8/163db0c9519f6a53?w=1191&h=450&f=gif&s=405289)\r\n\r\næ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è€ƒè™‘ç»“åˆHTTP/2çš„ä¼˜åŠ¿æ¥ä½¿ç”¨SSEã€‚ç„¶è€Œï¼Œä¸€ä¸ªå¯èƒ½ä¸å¤ªå¥½çš„æ¶ˆæ¯æ˜¯ï¼ŒIE/Edgeå¹¶ä¸å…¼å®¹ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/7/163daf0d02eb1e6c?w=2352&h=1146&f=png&s=253828)\r\n\r\nå½“ç„¶ï¼Œä½ å¯ä»¥é€šè¿‡ä¸€äº›æ‰‹æ®µæ¥å†™ä¸€ä¸ªå…¼å®¹IEçš„polyfillã€‚ä¸è¿‡ï¼Œç”±äºIEä¸Šçš„XMLHttpRequestå¯¹è±¡å¹¶ä¸æ”¯æŒè·å–éƒ¨åˆ†çš„å“åº”å†…å®¹ï¼Œå› æ­¤åªèƒ½ä½¿ç”¨XDomainRequestæ¥æ›¿ä»£ï¼Œå½“ç„¶ï¼Œè¿™ä¹Ÿå¯¼è‡´äº†ä¸€äº›å°é—®é¢˜ã€‚å¦‚æœå¤§å®¶å¯¹å…·ä½“çš„å®ç°ç»†èŠ‚æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªpolyfillåº“[Yaffle/EventSource](https://github.com/Yaffle/EventSource)ã€‚\r\n\r\n### WebSocket\r\n\r\nWebSocketä¸httpåè®®ä¸€æ ·éƒ½æ˜¯åŸºäºTCPçš„ã€‚WebSocketå…¶å®ä¸ä»…ä»…é™äºâ€œæœåŠ¡å™¨æ¨â€äº†ï¼Œå®ƒæ˜¯ä¸€ä¸ªå…¨åŒå·¥çš„åè®®ï¼Œé€‚ç”¨äºéœ€è¦è¿›è¡Œå¤æ‚åŒå‘æ•°æ®é€šè®¯çš„åœºæ™¯ã€‚å› æ­¤ä¹Ÿæœ‰ç€æ›´å¤æ‚çš„è§„èŒƒã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/8/163db3d3dd408fcb?w=540&h=231&f=png&s=9923)\r\n\r\nå½“å®¢æˆ·ç«¯è¦å’ŒæœåŠ¡ç«¯å»ºç«‹WebSocketè¿æ¥æ—¶ï¼Œåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„æ¡æ‰‹è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯é¦–å…ˆä¼šå‘æœåŠ¡ç«¯å‘é€ä¸€ä¸ªHTTPè¯·æ±‚ï¼ŒåŒ…å«ä¸€ä¸ª`Upgrade`è¯·æ±‚å¤´æ¥å‘ŠçŸ¥æœåŠ¡ç«¯å®¢æˆ·ç«¯æƒ³è¦å»ºç«‹ä¸€ä¸ªWebSocketè¿æ¥ã€‚\r\n\r\nåœ¨å®¢æˆ·ç«¯å»ºç«‹ä¸€ä¸ªWebSocketè¿æ¥éå¸¸ç®€å•ï¼š\r\n\r\n```javascript\r\nvar ws = new WebSocket('ws://127.0.0.1:8080');\r\n```\r\nå½“ç„¶ï¼Œç±»ä¼¼äº`HTTP`å’Œ`HTTPS`ï¼Œ`ws`ç›¸å¯¹åº”çš„ä¹Ÿæœ‰`wss`ç”¨ä»¥å»ºç«‹å®‰å…¨è¿æ¥ã€‚\r\n\r\nè¿™æ—¶çš„è¯·æ±‚å¤´å¦‚ä¸‹ï¼šï¼ˆæ³¨æ„å…¶ä¸­çš„Upgradeå­—æ®µï¼‰\r\n\r\n```\r\nAccept-Encoding: gzip, deflate, br\r\nAccept-Language: zh-CN,zh;q=0.9,en;q=0.8\r\nCache-Control: no-cache\r\nConnection: Upgrade\r\nCookie: Hm_lvt_4e63388c959125038aabaceb227cea91=1527001174\r\nHost: 127.0.0.1:8080\r\nOrigin: http://127.0.0.1:8080\r\nPragma: no-cache\r\nSec-WebSocket-Extensions: permessage-deflate; client_max_window_bits\r\nSec-WebSocket-Key: 0lUPSzKT2YoUlxtmXvdp+w==\r\nSec-WebSocket-Version: 13\r\nUpgrade: websocket\r\n```\r\n\r\nè€ŒæœåŠ¡å™¨åœ¨æ”¶åˆ°è¯·æ±‚åè¿›è¡Œå¤„ç†ï¼Œå“åº”å¤´å¦‚ä¸‹\r\n\r\n```\r\nConnection: Upgrade\r\nOrigin: http://127.0.0.1:8080\r\nSec-WebSocket-Accept: 3NOOJEzyscVfEf0q14gkMrpV20Q=\r\nUpgrade: websocket\r\n```\r\n\r\nè¡¨ç¤ºå‡çº§åˆ°äº†WebSocketåè®®ã€‚\r\n\r\næ³¨æ„ï¼Œä¸Šé¢çš„è¯·æ±‚å¤´ä¸­æœ‰ä¸€ä¸ª`Sec-WebSocket-Key`ï¼Œè¿™å…¶å®å’ŒåŠ å¯†ã€å®‰å…¨æ€§å…³ç³»ä¸å¤§ï¼Œæœ€ä¸»è¦çš„ä½œç”¨æ˜¯æ¥éªŒè¯æœåŠ¡å™¨æ˜¯å¦çœŸçš„æ­£ç¡®â€œç†è§£â€äº†WebSocketã€è¯¥WebSocketè¿æ¥æ˜¯å¦æœ‰æ•ˆã€‚æœåŠ¡å™¨ä¼šä½¿ç”¨`Sec-WebSocket-Key`ï¼Œå¹¶æ ¹æ®ä¸€ä¸ªå›ºå®šçš„ç®—æ³•\r\n\r\n```javascript\r\nmask = \"258EAFA5-E914-47DA-95CA-C5AB0DC85B11\";  // ä¸€ä¸ªè§„å®šçš„å­—ç¬¦ä¸²\r\naccept = base64(sha1(key + mask));\r\n```\r\n\r\nç”Ÿæˆ`Sec-WebSocket-Accept`å“åº”å¤´å­—æ®µï¼Œäº¤ç”±æµè§ˆå™¨éªŒè¯ã€‚\r\n\r\næ¥ä¸‹æ¥ï¼Œæµè§ˆå™¨ä¸æœåŠ¡å™¨ä¹‹é—´å°±å¯ä»¥æ„‰å¿«åœ°è¿›è¡ŒåŒå‘é€šä¿¡äº†ã€‚\r\n\r\né‰´äºç¯‡å¹…ï¼Œå…³äºWebSocketåè®®çš„å…·ä½“è§„èŒƒä¸ç»†èŠ‚ï¼ˆä¾‹å¦‚æ•°æ®å¸§æ ¼å¼ã€å¿ƒè·³æ£€æŸ¥ç­‰ï¼‰å°±ä¸åœ¨è¿™é‡Œæ·±å…¥äº†ï¼Œç½‘ç»œä¸Šä¹Ÿæœ‰å¾ˆå¤šè¿™ç±»çš„ä¸é”™çš„æ–‡ç« å¯ä»¥é˜…è¯»ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…ä¹Ÿå¯ä»¥é˜…è¯»æœ¬æ–‡æœ€åçš„å‚è€ƒèµ„æ–™ã€‚\r\n\r\nä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹WebSocketçš„ä½¿ç”¨ã€‚\r\n\r\nåœ¨æµè§ˆå™¨ç«¯ï¼Œå»ºç«‹WebSocketè¿æ¥åï¼Œå¯ä»¥é€šè¿‡`onmessage`æ¥ç›‘å¬æ•°æ®ä¿¡æ¯ã€‚\r\n\r\n```javascript\r\nvar ws = new WebSocket('ws://127.0.0.1:8080');\r\n\r\nws.onopen = function () {\r\n    console.log('open websocket');\r\n};\r\n\r\nws.onmessage = function (e) {\r\n    var data = JSON.parse(e.data);\r\n    process(data);\r\n};\r\n```\r\n\r\nåœ¨æœåŠ¡å™¨ç«¯ï¼Œç”±äºWebSocketåè®®å…·æœ‰è¾ƒå¤šçš„è§„èŒƒä¸ç»†èŠ‚éœ€è¦å¤„ç†ï¼Œå› æ­¤å»ºè®®ä½¿ç”¨ä¸€äº›å°è£…è¾ƒå®Œå¤‡çš„ç¬¬ä¸‰æ–¹åº“ã€‚ä¾‹å¦‚nodeä¸­çš„[websocket-node](https://github.com/theturtle32/WebSocket-Node)å’Œè‘—åçš„[socket.io](https://github.com/socketio/socket.io)ã€‚å½“ç„¶ï¼Œå…¶ä»–è¯­è¨€ä¹Ÿæœ‰è®¸å¤š[å¼€æºå®ç°](https://github.com/search?q=websocket)ã€‚nodeéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š\r\n\r\n```javascript\r\nconst http = require('http');\r\nconst WebSocketServer = require('websocket').server;\r\n\r\nconst app = http.createServer((req, res) => {\r\n    // ...\r\n});\r\napp.listen(process.env.PORT || 8080);\r\n\r\nconst ws = new WebSocketServer({\r\n    httpServer: app\r\n});\r\n\r\nws.on('request', req => {\r\n    let connection = req.accept(null, req.origin);\r\n    let wsSend = data => {\r\n        connection.send(JSON.stringify(data));\r\n    };\r\n    // æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®\r\n    connection.on('message', msg => {\r\n        console.log(msg);\r\n    });\r\n    connection.on('close', con => {\r\n        console.log('websocket close');\r\n        EVENT.removeListener(MSG_POST, wsSend);\r\n    });\r\n    // å½“æœ‰æ•°æ®æ›´æ–°æ—¶ï¼Œä½¿ç”¨WebSocketè¿æ¥æ¥å‘å®¢æˆ·ç«¯å‘é€æ•°æ®\r\n    EVENT.addListener(MSG_POST, wsSend);\r\n});\r\n```\r\n\r\næ•ˆæœå¦‚ä¸‹ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/8/163db4bae3a5ec95?w=1229&h=679&f=gif&s=752411)\r\n\r\n## å†™åœ¨æœ€å\r\n\r\næœåŠ¡å™¨æ¨ï¼ˆServer Pushï¼‰ä½œä¸ºä¸€ç±»ç‰¹å®šçš„æŠ€æœ¯ï¼Œåœ¨ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸­èµ·åˆ°äº†é‡è¦çš„ä½œç”¨ï¼Œäº†è§£å„ç±»æŠ€æœ¯å®ç°çš„åŸç†ä¸ç‰¹ç‚¹ï¼Œæœ‰åˆ©äºåœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­å¸®åŠ©æˆ‘ä»¬åšå‡ºä¸€å®šçš„é€‰æ‹©ä¸åˆ¤æ–­ã€‚\r\n\r\nä¸ºäº†ä¾¿äºç†è§£æ–‡ä¸­çš„å†…å®¹ï¼Œæˆ‘æŠŠæ‰€æœ‰ä»£ç æ•´ç†åœ¨äº†ä¸€ä¸ªdemoé‡Œï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/alienzhou/server_push_demo)ä¸‹è½½ï¼Œå¹¶åœ¨æœ¬åœ°è¿è¡ŒæŸ¥çœ‹ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/8/163db4e9e1cf80b1?w=1806&h=650&f=gif&s=2564909)\r\n\r\n## å‚è€ƒèµ„æ–™\r\n\r\n- [w3c: Server-Sent Events](https://www.w3.org/TR/2015/REC-eventsource-20150203/)\r\n- [w3c: The WebSocket API](https://www.w3.org/TR/resource-hints/)\r\n- [Cometï¼šåŸºäº HTTP é•¿è¿æ¥çš„â€œæœåŠ¡å™¨æ¨â€æŠ€æœ¯](https://www.ibm.com/developerworks/cn/web/wa-lo-comet/)\r\n- [HTML5 æœåŠ¡å™¨æ¨é€äº‹ä»¶ï¼ˆServer-sent Eventsï¼‰å®æˆ˜å¼€å‘](https://www.ibm.com/developerworks/cn/web/1307_chengfu_serversentevent/)\r\n- [What is Sec-WebSocket-Key for?\r\n](https://stackoverflow.com/questions/18265128/what-is-sec-websocket-key-for)\r\n- [Deep dive into WebSockets and HTTP/2 with SSE + how to pick the right path](https://blog.sessionstack.com/how-javascript-works-deep-dive-into-websockets-and-http-2-with-sse-how-to-pick-the-right-path-584e6b8e3bf7)\r\n- [MDN: Server Sent Event](https://developer.mozilla.org/zh-CN/docs/Server-sent_events/Using_server-sent_events)\r\n- [The WebSocket Protocol](https://tools.ietf.org/html/rfc6455)","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/16","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/16/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/16/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/16/events","html_url":"https://github.com/alienzhou/blog/issues/16","id":390634798,"node_id":"MDU6SXNzdWUzOTA2MzQ3OTg=","number":16,"title":"ã€CSSæ¨¡å—åŒ–ä¹‹è·¯3ã€‘ ä½¿ç”¨ğŸ’…styled-componentsæ¥è¿›è¡Œreactå¼€å‘","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845018,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE4","url":"https://api.github.com/repos/alienzhou/blog/labels/CSS","name":"CSS","color":"7057ff","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T11:25:40Z","updated_at":"2018-12-13T11:25:40Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"CSSæ˜¯ä¸€é—¨å‡ ååˆ†é’Ÿå°±èƒ½å…¥é—¨ï¼Œä½†æ˜¯å´éœ€è¦å¾ˆé•¿çš„æ—¶é—´æ‰èƒ½æŒæ¡å¥½çš„è¯­è¨€ã€‚å®ƒæœ‰ç€å®ƒè‡ªèº«çš„ä¸€äº›å¤æ‚æ€§ä¸å±€é™æ€§ã€‚å…¶ä¸­éå¸¸é‡è¦çš„ä¸€ç‚¹å°±æ˜¯ï¼Œæœ¬èº«ä¸å…·å¤‡çœŸæ­£çš„æ¨¡å—åŒ–èƒ½åŠ›ã€‚\r\n\r\n> ç³»åˆ—æ–‡ç« é“¾æ¥ â†“ â†“\r\n> - [ã€CSSæ¨¡å—åŒ–ä¹‹è·¯1ã€‘ä½¿ç”¨BEMä¸å‘½åç©ºé—´æ¥è§„èŒƒCSS](https://github.com/alienzhou/blog/issues/14)\r\n> - [ã€CSSæ¨¡å—åŒ–ä¹‹è·¯2ã€‘webpackä¸­çš„Local Scope](https://github.com/alienzhou/blog/issues/15)\r\n> - [ã€CSSæ¨¡å—åŒ–ä¹‹è·¯3ã€‘ ä½¿ç”¨ğŸ’…styled-componentsæ¥è¿›è¡Œreactå¼€å‘](https://github.com/alienzhou/blog/issues/16)\r\n\r\n## 1. é¢ä¸´çš„é—®é¢˜\r\nCSSä¸­è™½ç„¶æœ‰`@import`åŠŸèƒ½ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œè¿™é‡Œçš„`@import`ä»…ä»…æ˜¯è¡¨ç¤ºå¼•å…¥ç›¸åº”çš„CSSæ–‡ä»¶ï¼Œä½†å…¶æ¨¡å—åŒ–æ ¸å¿ƒé—®é¢˜å¹¶æœªè§£å†³â€”â€”CSSæ–‡ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ªé€‰æ‹©å™¨éƒ½ä¼šä½œç”¨åœ¨æ•´ä¸ªæ–‡æ¡£èŒƒå›´é‡Œã€‚\r\n\r\nè€Œå¦‚ä»Šçš„å‰ç«¯é¡¹ç›®è§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼Œå·²ç»ä¸æ˜¯è¿‡å»éšä¾¿å‡ ä¸ªcssã€jsæ–‡ä»¶å°±å¯ä»¥æå®šçš„æ—¶ä»£ã€‚ä¸æ­¤åŒæ—¶çš„ï¼Œå¯¹äºä¸€ä¸ªå¤§å‹çš„åº”ç”¨ï¼Œå‰ç«¯å¼€å‘å›¢é˜Ÿå¾€å¾€ä¹Ÿä¸å†æ˜¯ä¸€ä¸¤ä¸ªäººã€‚éšç€é¡¹ç›®ä¸å›¢é˜Ÿè§„æ¨¡çš„æ‰©å¤§ï¼Œç”šè‡³æ˜¯é¡¹ç›®è¿‡ç¨‹ä¸­äººå‘˜çš„å˜åŠ¨ï¼Œå¦‚ä½•æ›´å¥½è¿›è¡Œä»£ç å¼€å‘çš„ç®¡ç†å·²ç»æˆä¸ºäº†ä¸€ä¸ªé‡è¦é—®é¢˜ã€‚ç”¨CSSå®ç°ä¸€äº›æ ·å¼å¾€å¾€å¹¶ä¸æ˜¯æœ€å›°éš¾çš„æ‰€åœ¨ï¼Œéš¾çš„æ˜¯ä½¿ç”¨ä¸€å¥—åˆç†çš„CSSæ¶æ„æ¥æ”¯æŒå›¢é˜Ÿçš„åˆä½œä¸åç»­çš„ç»´æŠ¤ã€‚\r\n\r\n> What we want is to be able to write code that is as transparent and self-documenting as possible. \r\n\r\næœ¬ç³»åˆ—æ–‡ç« ä¼šä»‹ç»ä¸€äº›ä¸šç•Œåœ¨æ¢ç´¢CSSæ¨¡å—åŒ–è¿›ç¨‹ä¸­æå‡ºçš„æ–¹æ¡ˆã€‚åœ¨å‰ä¸¤ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»‹ç»äº†[å¦‚æœä½¿ç”¨BEMä¸å‘½åç©ºé—´æ¥è§„èŒƒä¸æ¶æ„ä½ çš„CSS](https://juejin.im/editor/posts/5b20e8e0e51d4506c60e47f5)ä»¥åŠ[å¦‚ä½•ä½¿ç”¨Webpackä¸­çš„CSS modules](https://juejin.im/post/5b234e25e51d45588016caa0)ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¼šä»‹ç»styled-componentsè¿™ç§CSS in JSæ–¹æ¡ˆï¼Œä»¥åŠå¦‚ä½•åœ¨Reactä¸­ä½¿ç”¨ã€‚\r\n\r\n## 2. styled-componentsæ˜¯ä»€ä¹ˆ\r\néšç€Reactç­‰å‰ç«¯æŠ€æœ¯çš„ä¸æ–­æµè¡Œï¼Œç»„ä»¶åŒ–çš„æ€æƒ³å¼€å§‹å—åˆ°è¶Šæ¥è¶Šå¤šçš„äººé‡è§†ã€‚ä»¥ç»„ä»¶ä¸ºä¸­å¿ƒçš„å¼€å‘æ€è·¯ä½¿å¾—å„ç§ css-in-js å®è·µå‡ºç°ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/15/16401f75d0bed9f5?w=1240&h=443&f=png&s=159913)![](https://user-gold-cdn.xitu.io/2018/6/15/16401f75d0f08cdb?w=1240&h=59&f=png&s=30399)\r\n\r\nğŸ’…styled-componentsï¼Œå°±æ˜¯è¿™äº›æ–¹æ¡ˆä¸­çš„ä¸€ç§ã€‚å®ƒæ—¢å…·å¤‡äº† css-in-js çš„æ¨¡å—åŒ–ä¸å‚æ•°åŒ–çš„ä¼˜ç‚¹ï¼Œåˆå®Œå…¨ä½¿ç”¨CSSçš„ä¹¦å†™ä¹ æƒ¯ï¼Œä¸ä¼šå¼•èµ·é¢å¤–çš„å­¦ä¹ æˆæœ¬ã€‚è¿™äº›ä¼˜ç‚¹éƒ½æ˜¯å®ƒæ¸æ¸æµè¡Œçš„åŸå› ã€‚\r\n\r\nå¦‚æœä½ æ­£åœ¨å­¦ä¹ æˆ–ä½¿ç”¨ReactæŠ€æœ¯æ ˆï¼Œå°±éå¸¸æœ‰å¿…è¦äº†è§£ä¸€ä¸‹ğŸ’…styled-componentsäº†ã€‚æ¥ä¸‹æ¥çš„éƒ¨åˆ†ï¼Œå°±ä¼šå¸¦ç€ä½ è¿…é€Ÿäº†è§£styled-componentsåœ¨Reactä¸­çš„ä¸€äº›åŸºæœ¬ä½¿ç”¨æ–¹å¼ä¸ä½¿ç”¨åœºæ™¯ã€‚\r\n\r\n> P.S. æœ€æ–°ç‰ˆ (v3.1.0) çš„styled-componentsåœ¨SSRä¸Šæœ‰äº†æå¤§çš„æ€§èƒ½æå‡: you can now use streaming server-side rendering with styled-components -- [v3.1.0: A massive performance boost and streaming server-side rendering support](https://medium.com/styled-components/v3-1-0-such-perf-wow-many-streams-c45c434dbd03)\r\n\r\n## 3. åœ¨reactä¸­ä½¿ç”¨styled-components\r\n### 3.1. åŸºæœ¬ç”¨æ³•\r\né‚£ä¹ˆï¼Œå¦‚ä½•åœ¨æˆ‘ä»¬çš„reacté¡¹ç›®ä¸­ä½¿ç”¨styled-componentså‘¢ï¼Ÿ\r\nå®˜ç½‘ä¸Šæœ‰ä¸€å¥è¯éå¸¸å½¢è±¡ï¼š\r\n> It removes the mapping between components and styles. This means that **when you're defining your styles, you're actually creating a normal React component**, that has your styles attached to it.\r\n\r\nç®€å•æ¥è¯´ï¼Œå°±æ˜¯åœ¨ä½ ä½¿ç”¨styled-componentsè¿›è¡Œæ ·å¼å®šä¹‰çš„åŒæ—¶ï¼Œä½ ä¹Ÿå°±åˆ›å»ºäº†ä¸€ä¸ªReactç»„ä»¶ã€‚æ¥å…ˆçœ‹ä¸€ä¸‹å®ƒåŸºæœ¬è¯­æ³•ï¼š\r\n\r\n```javascript\r\nimport styled from 'styled-components';\r\n\r\nconst ListWrap = styled.ul`\r\n    margin: 0;\r\n    padding: 0;\r\n`;\r\n\r\nconst Item = styled.li`\r\n    margin: 10px 0;\r\n    padding: 5px 15px;\r\n    border-left: 3px solid #333;\r\n    font-size: 16px;\r\n    list-style: none;\r\n    font-weight: bold;\r\n`;\r\n```\r\n\r\nä¸Šé¢è¿™æ®µä»£ç ï¼Œå…¶å®å°±æ˜¯å®šä¹‰äº†ä¸€ä¸ª`li`å…ƒç´ çš„å„ç§æ ·å¼ä¿¡æ¯ï¼ˆè¾¹è·ã€è¾¹æ¡†ã€å­—ä½“ç­‰ç­‰ï¼‰ã€‚æ˜¯ä¸æ˜¯å’Œç›´æ¥åœ¨`.css`æ–‡ä»¶ä¸­ç›´æ¥å†™csså¾ˆåƒï¼Ÿ\r\n\r\næ³¨æ„ï¼Œå½“æˆ‘ä»¬å°†è¿™ä¸ª`styled`çš„`li`å…ƒç´ èµ‹ç»™äº†`Item`è¿™ä¸ªå˜é‡æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå°±åˆ›å»ºäº†ä¸€ä¸ªå«`Item`çš„Reactç»„ä»¶ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨JSXä¸­ç›´æ¥ä½¿ç”¨`Item`\r\n\r\n```javascript\r\nimport React, {Component} from 'react';\r\n\r\nexport default class List extends Component {\r\n    render() {\r\n        return (\r\n            <ListWrap>\r\n                <Item>è¿™æ˜¯ä¸€æ¡æ™®é€šçš„è®°å½•</Item>\r\n                <Item>è¿™ä¹Ÿæ˜¯ä¸€æ¡æ™®é€šçš„è®°å½•</Item>\r\n            </ListWrap>\r\n        )\r\n    }\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/15/16401f75d1061a6b?w=887&h=102&f=png&s=10712)\r\n\r\næ˜¯ä¸æ˜¯éå¸¸æ–¹ä¾¿ï¼Ÿ\r\n\r\nå¦‚æœä½ å¯¹ES6ç†Ÿæ‚‰çš„è¯ï¼Œä¹Ÿè®¸å·²ç»å‘ç°äº†ï¼Œåœ¨ä½¿ç”¨`styled`è®¾ç½®cssæ ·å¼çš„è¯­æ³•é‡Œï¼Œç”¨åˆ°äº†æ¨¡æ¿å­—ç¬¦ä¸²ã€‚å› æ­¤ï¼Œå¯¹äºæ ·å¼ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥åŠ å…¥å˜é‡è®¡ç®—ã€‚æ›´è¿›ä¸€æ­¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è·å–Reactç»„ä»¶çš„`props`æ¥æ›´æ”¹ç›¸åº”çš„csså±æ€§ï¼š\r\n\r\n```javascript\r\nconst Item = styled.li`\r\n    margin: 10px 0;\r\n    padding: 5px 15px;\r\n    border-left: 3px solid #333;\r\n    font-size: 16px;\r\n    list-style: none;\r\n    font-weight: bold;\r\n    text-decoration: ${props => props.underline ? 'underline' : 'none'};\r\n`;\r\n\r\nexport default class List extends Component {\r\n    render() {\r\n        return (\r\n            <ListWrap>\r\n                <Item>è¿™æ˜¯ä¸€æ¡æ™®é€šçš„è®°å½•</Item>\r\n                <Item>è¿™ä¹Ÿæ˜¯ä¸€æ¡æ™®é€šçš„è®°å½•</Item>\r\n                <Item underline>è¿™æ¡è®°å½•æœ‰ä¸€æ¡ä¸‹åˆ’çº¿</Item>\r\n            </ListWrap>\r\n        )\r\n    }\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/15/16401f75d150a951?w=882&h=143&f=png&s=15112)\r\n\r\n\r\nè¿™ä¸€è¯­æ³•ä¹Ÿæ˜¯styled-componentså·¥ä½œçš„æ ¸å¿ƒä¹‹ä¸€ã€‚åŸå› åœ¨äºï¼Œä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²æ—¶ï¼Œä¸‹é¢è¿™ä¸¤è¡Œä»£ç æ˜¯ç­‰ä»·çš„ï¼š\r\n\r\n```javascript\r\nfunc`I love ${some_lib} & styled-component`\r\nfunc(['I love ',  '  & styled-component'], some_lib)\r\n```\r\n\r\nå¦‚æœæƒ³å…·ä½“äº†è§£ï¼Œå¯ä»¥çœ‹æ–‡æœ«çš„å‚è€ƒé“¾æ¥ã€‚\r\n\r\n### 3.2. æ‰©å±•å·²æœ‰æ ·å¼\r\næœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬æƒ³è¦åœ¨å·²æœ‰çš„ç»„ä»¶æ ·å¼åŸºç¡€ä¸Šï¼Œæ·»åŠ ä¸€äº›å…¶ä»–çš„æ ·å¼å±æ€§ï¼Œä»è€Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç»„ä»¶ã€‚\r\n\r\nä¾‹å¦‚ï¼Œå¯¹äºä¸Šä¸€èŠ‚ä¸­çš„`Item`ç»„ä»¶ï¼Œæˆ‘ä»¬æƒ³è¦åœ¨æ­¤åŸºç¡€ä¸Šï¼Œåˆ›å»ºä¸€ä¸ªçº¢åº•ç™½å­—çš„æ–°Itemæ ·å¼ï¼Œä½†æ˜¯å…¶ä»–å±æ€§ï¼ˆå­—ä½“ã€è¾¹è·ç­‰ï¼‰ä¿æŒä¸€è‡´ã€‚ä½¿ç”¨styled-componentsçš„`styled`æ–¹æ³•å¯ä»¥å¾ˆå®¹æ˜“å®ç°ï¼š\r\n\r\n```javascript\r\nconst RedItem = styled(Item)`\r\n    color: #fff;\r\n    background: #991302;\r\n`;\r\n\r\nexport default class List extends Component {\r\n    render() {\r\n        return (\r\n            <ListWrap>\r\n                <Item>è¿™æ˜¯ä¸€æ¡æ™®é€šçš„è®°å½•</Item>\r\n                <Item>è¿™ä¹Ÿæ˜¯ä¸€æ¡æ™®é€šçš„è®°å½•</Item>\r\n                <Item underline>è¿™æ¡è®°å½•æœ‰ä¸€æ¡ä¸‹åˆ’çº¿</Item>\r\n                <RedItem>è¿™æ˜¯ä¸€æ¡çº¢è‰²çš„è®°å½•</RedItem>\r\n            </ListWrap>\r\n        )\r\n    }\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/15/16401f75d1469309?w=917&h=186&f=png&s=19708)\r\n\r\næ˜¯ä¸æ˜¯éå¸¸ç®€å•ï¼Ÿè¿™é‡Œéœ€è¦ä¸€æçš„æ˜¯ï¼Œå¯¹äº`styled.li`è¿™ç§ä¹¦å†™æ¨¡å¼ï¼Œå®é™…ä¸Šå’Œ`styled('li')`æ˜¯ç­‰ä»·çš„ï¼Œåªæ˜¯ä¸€ç§æ–¹æ³•çš„åˆ«åè€Œå·²ã€‚\r\n\r\n### 3.3. æ ·å¼ç»§æ‰¿\r\nå®é™…ä¸Šï¼Œåœ¨styled-componentsä¸­ï¼Œå¯¹äºç»„ä»¶çš„æ ·å¼ç»§æ‰¿å¯ä»¥ä½¿ç”¨`extend`æ–¹æ³•ã€‚å› æ­¤ï¼Œå¯¹äºä¸Šä¸€å°èŠ‚ä¸­çš„`RedItem`ç»„ä»¶ï¼Œæˆ‘ä»¬ä¹Ÿå®Œå…¨å¯ä»¥ä½¿ç”¨`extend`æ–¹æ³•æ¥å®ç°ï¼š\r\n\r\n```javascript\r\nconst RedItem = Item.extend`\r\n    color: #fff;\r\n    background: #991302;\r\n`;\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/15/16401f75d1374bb6?w=669&h=228&f=png&s=27091)\r\n\r\nåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œåœ¨csséƒ¨åˆ†çš„ä»£ç æ˜¯ä¸€æ ·çš„ã€‚é‚£ä¹ˆ`extend`å’Œ`styled`ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿå®˜ç½‘ä¸Šæœ‰ä¸€å¥è¯è§£é‡Šçš„éå¸¸æ¸…æ¥šï¼š\r\n> The styled() factory **generates new component styles with a new class**. Calling extend creates new component styles by extending the old one, and thus **doesn't generate two classes for a single component**. (styled() factory does that)\r\n\r\næ€ä¹ˆç†è§£è¿™å¥è¯å‘¢ï¼Ÿæˆ‘ä»¬å¦‚æœå»å®¡æŸ¥é¡µé¢å…ƒç´ ï¼Œå°±ä¼šå‘ç°åŒºåˆ«ï¼š\r\n`styled`æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç±»`.iVuaxi`æ¥åº”ç”¨è¿™ä¸¤è¡Œæ ·å¼ï¼Œè€ŒItemæœ¬èº«çš„æ ·å¼ä¾æ—§å­˜åœ¨äº`.bWdYgn`ç±»ä¸­ï¼›\r\nè€Œä½¿ç”¨`extend`æ–¹æ³•ååˆ™ä¼šåœ¨`.fYpJfw`ç±»ä¸­å®ç°æ‰€æœ‰çš„æ ·å¼ï¼Œå¹¶ä¸ä¼šåˆ›å»ºä¸¤ä¸ªcssç±»ã€‚\r\n![](https://user-gold-cdn.xitu.io/2018/6/15/16401f7659bb8714?w=540&h=124&f=png&s=46342)\r\n\r\né‚£ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨`extend`æ–¹å¼ï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨`styled`æ–¹å¼å‘¢ï¼Ÿstyled-componentså®˜æ–¹æ¨èå°½é‡å»ä½¿ç”¨`extend`æ–¹å¼ã€‚å½“è¯¥reactç»„ä»¶ä¸æ˜¯ä¸€ä¸ªstyled-componentsç»„ä»¶æ—¶ï¼Œä½¿ç”¨`styled`æ–¹å¼ã€‚\r\n\r\n### 3.4.ä¿®æ”¹æ ‡ç­¾ç±»å‹\r\né™¤äº†éœ€è¦ç»§æ‰¿ç»„ä»¶æ ·å¼å¤–ï¼Œæœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½æƒ³è¦æ›´æ¢è¯¥ç»„ä»¶çš„HTMLæ ‡ç­¾ã€‚ä¾‹å¦‚æŒ‰é’®ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªbuttonç»„ä»¶çš„æ ·å¼ï¼Œæƒ³è¦å†åˆ›é€ ä¸€ä¸ªä¸€æ ·çš„aæ ‡ç­¾æŒ‰é’®ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨`withComponent`æ–¹æ³•ï¼š\r\n\r\n```javascript\r\n// ä½¿ç”¨withComponentæ–¹æ³•ä¿®æ”¹æ ‡ç­¾ç±»å‹\r\nconst DivItem = Item.withComponent('div');\r\n\r\nexport default class List extends Component {\r\n    render() {\r\n        return (\r\n            <ListWrap>\r\n                <Item>è¿™æ˜¯ä¸€æ¡æ™®é€šçš„è®°å½•</Item>\r\n                <Item>è¿™ä¹Ÿæ˜¯ä¸€æ¡æ™®é€šçš„è®°å½•</Item>\r\n                <Item underline>è¿™æ¡è®°å½•æœ‰ä¸€æ¡ä¸‹åˆ’çº¿</Item>\r\n                <RedItem>è¿™æ˜¯ä¸€æ¡çº¢è‰²çš„è®°å½•</RedItem>\r\n                <ExtendedItem>è¿™æ¡è®°å½•ä½¿ç”¨äº†â€˜extendâ€™</ExtendedItem>\r\n                <DivItem>è¿™å®é™…ä¸Šæ˜¯ä¸ªdiv </DivItem>\r\n            </ListWrap>\r\n        )\r\n    }\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/15/16401f765fcc94dc?w=909&h=279&f=png&s=31427)\r\n\r\n### 3.5. æ·»åŠ åŠ¨ç”»keyframes\r\nå½“ç„¶ï¼Œstyled-componentsä½œä¸ºä¸€ä¸ªç»„ä»¶æ ·å¼æ–¹é¢çš„å·¥å…·ï¼Œè‚¯å®šä¸ä¼šæ¼æ‰css3ä¸­çš„é‡è¦åŠŸèƒ½â€”â€”åŠ¨ç”»ã€‚æˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨ä½¿ç”¨styled-componentsåˆ›å»ºçš„ç»„ä»¶ä¸­ï¼Œè®¾ç½®ç›¸åº”çš„css3åŠ¨ç”»ã€‚ä¸è¿‡å’Œä¹‹å‰ç¨æœ‰ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä»styled-componentsåº“ä¸­å¯¼å‡ºä¸€ä¸ª`keyframes`æ–¹æ³•ã€‚\r\n\r\nä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥åˆ›å»ºä¸€ä¸ªå¸¦æœ‰åŠ¨ç”»çš„Itemã€‚é¦–å…ˆï¼Œä½¿ç”¨keyframesæ–¹æ³•åˆ›å»ºcss3åŠ¨ç”»\r\n\r\n```javascript\r\nimport styled, {keyframes} from 'styled-components';\r\n\r\nconst MyAnimation = keyframes`\r\n    from {\r\n        padding-left: 0;\r\n        background: #991302;\r\n    }\r\n\r\n    to {\r\n        padding-left: 50px;\r\n        background: #009317;\r\n    }\r\n`;\r\n```\r\n\r\nç„¶åï¼Œä½¿ç”¨ç»§æ‰¿çš„æ–¹å¼ï¼Œåˆ›å»ºä¸€ä¸ªå¸¦åŠ¨ç”»çš„ç»„ä»¶\r\n\r\n```javascript\r\nconst AnimateItem = RedItem.extend`\r\n    animation: ${MyAnimation} 2s linear infinite alternate;\r\n`;\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/15/16401f7659c340eb?w=909&h=308&f=gif&s=53736)\r\n\r\n### 3.6. å…¨å±€æ ·å¼\r\næœ‰äº›æ—¶å€™ï¼Œåœ¨å¼€å‘ä¸­éœ€è¦è®¾ç½®ä¸€äº›å…¨å±€çš„æ ·å¼ï¼Œè¿™ä¸ªè¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿå…¸å‹çš„ï¼Œå½“æˆ‘ä»¬æƒ³è¦ä¸º`body`å…ƒç´ è®¾ç½®ä¸€äº›å±æ€§æ—¶ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ\r\n\r\nåˆ«æ‹…å¿ƒï¼Œstyled-componentsæä¾›äº†`injectGlobal`æ–¹æ³•æ¥å®ç°å®ƒã€‚è°ƒç”¨`injectGlobal`å¹¶ä¸ä¼šè¿”å›ä¸€ä¸ªç»„ä»¶ï¼Œè€Œæ˜¯ä¼šå°†`injectGlobal`ä¸­çš„cssç›¸å…³æ ·å¼ç›´æ¥æ·»åŠ åˆ°`<style>`æ ‡ç­¾å†…éƒ¨ã€‚åŒæ ·çš„ï¼Œéœ€è¦å¯¼å‡º`injectGlobal`æ–¹æ³•ï¼š\r\n\r\n```javascript\r\nimport styled, {keyframes, injectGlobal} from 'styled-components';\r\n\r\ninjectGlobal`\r\n    body {\r\n        border: 5px solid #991302;\r\n        background: #ddd;\r\n    }\r\n`;\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/6/15/16401f766fa6d723?w=911&h=374&f=png&s=37539)\r\n\r\nå¦‚æœæˆ‘ä»¬å»çœ‹é¡µé¢è¾“å‡ºçš„è¯ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸€æ®µæ ·å¼ï¼š![](https://user-gold-cdn.xitu.io/2018/6/15/16401f767381a83f?w=679&h=66&f=png&s=22877)è¿™å°±æ˜¯æˆ‘ä»¬è®¾ç½®å…¨å±€æ ·å¼åçš„è¾“å‡ºã€‚\r\n\r\n## 4. ä½¿ç”¨styled-componentsçš„ä¸€äº›ä¼˜ç‚¹\r\n\r\nä½¿ç”¨styled-componentsæ¥è¿›è¡ŒReactæŠ€æœ¯æ ˆçš„å¼€å‘æœ‰è®¸å¤šä¼˜åŠ¿ï¼Œè¿™é‡Œæ€»ç»“äº†ä¸€ç¯‡[post](https://medium.com/@jamiedixon/styled-components-production-patterns-c22e24b1d896)é‡Œçš„ä¸€äº›è§‚ç‚¹ï¼š\r\n1. å‹ç¼©ä½ çš„æ ·å¼ä»£ç ï¼ˆCompressed Stylesï¼‰ã€‚ä½¿ç”¨styled-componentså¯ä»¥æœ‰æ•ˆç®€åŒ–éƒ¨åˆ†æ ·å¼çš„ç¼–å†™ã€‚\r\n1. å†™å‡ºæ›´æ¸…çˆ½çš„JSXä»£ç ï¼ˆClearer JSXï¼‰ã€‚![åŸå…ˆçš„JSX](https://user-gold-cdn.xitu.io/2018/6/15/16401f767ed1bf08?w=1240&h=521&f=png&s=179379)![ä½¿ç”¨styled-componentsåçš„JSX](https://user-gold-cdn.xitu.io/2018/6/15/16401f76734dc323?w=1240&h=587&f=png&s=160107)\r\n1. å®ç°æ ·å¼çš„ç»„åˆä¸ç»§æ‰¿ï¼ˆComposing Stylesï¼‰\r\n1. å±æ€§è¿‡æ»¤ï¼ˆProp filteringï¼‰ã€‚styled-componentsä¼šé€šè¿‡ç™½åå•çš„æ–¹å¼è¿‡æ»¤æ— æ•ˆçš„å±æ€§ã€‚\r\n\r\n## 5. å®Œå–„ä½ çš„styled-componentså¼€å‘ç¯å¢ƒ\r\n### 5.1. vs codeæ’ä»¶\r\nå·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚å¦‚æœä½ ä½¿ç”¨vs codeè¿›è¡Œå¼€å‘ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®‰è£…styled-componentsæ’ä»¶ï¼švscode-styled-componentsã€‚è¯¥æ’ä»¶ä¼šè¿›è¡Œè¯­æ³•ä¸æ™ºèƒ½æç¤ºï¼Œæé«˜æˆ‘ä»¬çš„å¼€å‘æ•ˆç‡ã€‚![ä½¿ç”¨vscode-styled-componentsæ’ä»¶å‰](https://user-gold-cdn.xitu.io/2018/6/15/16401f76848f1d65?w=580&h=161&f=png&s=25835)![ä½¿ç”¨vscode-styled-componentsæ’ä»¶å](https://user-gold-cdn.xitu.io/2018/6/15/16401f76a42d5ecd?w=583&h=160&f=png&s=27394)\r\n\r\n### 5.2. stylelint\r\nå¦‚æœä½ åœ¨ä½¿ç”¨styled-componentsçš„åŒæ—¶ï¼Œä¹Ÿä½¿ç”¨äº†stylelintæ¥è¿›è¡Œcssæ£€æŸ¥ï¼Œé‚£ä¹ˆä½ å¾ˆå¯èƒ½ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ã€‚å› ä¸ºstyled-componentsä¼šå¯¼è‡´ä»£ç ä¸ç¬¦åˆæŸäº›æ£€æŸ¥è§„åˆ™ã€‚\r\n\r\nä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œstyled-componentsæä¾›äº†ä¸€ä¸ªå«stylelint-config-styled-componentsçš„åŒ…æ¥è°ƒæ•´stylelintä¸­çš„æŸäº›è§„åˆ™æ£€æŸ¥ã€‚ä½ å¯ä»¥åœ¨ä½ çš„`.stylelintrc`æ–‡ä»¶ä¸­æ·»åŠ é…ç½®ï¼š`\"processors\": [\"stylelint-processor-styled-components\"]`ã€‚è¿™æ ·ä½ å°±å¯ä»¥ç»§ç»­ä½¿ç”¨stylelintäº†ã€‚å…·ä½“é…ç½®æ–¹å¼å¯ä»¥å‚è€ƒ[è¿™é‡Œ](https://www.styled-components.com/docs/tooling#stylelint)ã€‚\r\n\r\n## å‚è€ƒèµ„æ–™\r\n\r\n> æƒ³äº†è§£CSSæ¨¡å—åŒ–ç›¸å…³å†…å®¹ï¼Œå¯ä»¥çœ‹çœ‹\r\n> - [ã€CSSæ¨¡å—åŒ–ä¹‹è·¯1ã€‘ä½¿ç”¨BEMä¸å‘½åç©ºé—´æ¥è§„èŒƒCSS](https://github.com/alienzhou/blog/issues/14)\r\n> - [ã€CSSæ¨¡å—åŒ–ä¹‹è·¯2ã€‘webpackä¸­çš„Local Scope](https://github.com/alienzhou/blog/issues/15)\r\n\r\nå¦‚æœä½ å¯¹æ–‡ä¸­æåˆ°ä¸€äº›ç‚¹æ„Ÿå…´è¶£ï¼Œä¹Ÿå¯ä»¥åœ¨è¿™é‡Œè¿›ä¸€æ­¥é˜…è¯»ç›¸å…³èµ„æ–™ã€‚\r\n- [The magic behind ğŸ’… styled-components](https://mxstbr.blog/2016/11/styled-components-magic-explained/): ä»‹ç»äº†æ¨¡æ¿å­—ç¬¦ä¸²å¯¹styled-componentsçš„é‡è¦ä½œç”¨\r\n- [ğŸ’… styled components ğŸ’…â€Šâ€”â€ŠProduction Patterns](https://medium.com/@jamiedixon/styled-components-production-patterns-c22e24b1d896): ä½¿ç”¨styled componentsçš„ä¸€äº›ä¼˜ç‚¹\r\n- [A 5-minute Intro to Styled Components](https://medium.freecodecamp.org/a-5-minute-intro-to-styled-components-41f40eb7cd55)\r\n- [vs codeä¸‹çš„ğŸ’…styled-componentsæ’ä»¶](https://marketplace.visualstudio.com/items?itemName=jpoissonnier.vscode-styled-components)\r\n- [v3.1.0: A massive performance boost and streaming server-side rendering support](https://medium.com/styled-components/v3-1-0-such-perf-wow-many-streams-c45c434dbd03)","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/15","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/15/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/15/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/15/events","html_url":"https://github.com/alienzhou/blog/issues/15","id":390634233,"node_id":"MDU6SXNzdWUzOTA2MzQyMzM=","number":15,"title":"ã€CSSæ¨¡å—åŒ–ä¹‹è·¯2ã€‘webpackä¸­çš„Local Scope","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845018,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE4","url":"https://api.github.com/repos/alienzhou/blog/labels/CSS","name":"CSS","color":"7057ff","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T11:23:57Z","updated_at":"2018-12-13T11:23:57Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"CSSæ˜¯ä¸€é—¨å‡ ååˆ†é’Ÿå°±èƒ½å…¥é—¨ï¼Œä½†æ˜¯å´éœ€è¦å¾ˆé•¿çš„æ—¶é—´æ‰èƒ½æŒæ¡å¥½çš„è¯­è¨€ã€‚å®ƒæœ‰ç€å®ƒè‡ªèº«çš„ä¸€äº›å¤æ‚æ€§ä¸å±€é™æ€§ã€‚å…¶ä¸­éå¸¸é‡è¦çš„ä¸€ç‚¹å°±æ˜¯ï¼Œæœ¬èº«ä¸å…·å¤‡çœŸæ­£çš„æ¨¡å—åŒ–èƒ½åŠ›ã€‚\r\n\r\n## 1. é¢ä¸´çš„é—®é¢˜\r\nä½ å¯èƒ½ä¼šè¯´ï¼ŒCSSæœ‰`@import`åŠŸèƒ½ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œè¿™é‡Œçš„`@import`ä»…ä»…æ˜¯è¡¨ç¤ºå¼•å…¥ç›¸åº”çš„CSSæ–‡ä»¶ï¼Œä½†å…¶æ¨¡å—åŒ–æ ¸å¿ƒé—®é¢˜å¹¶æœªè§£å†³â€”â€”CSSæ–‡ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ªé€‰æ‹©å™¨éƒ½ä¼šä½œç”¨åœ¨æ•´ä¸ªæ–‡æ¡£èŒƒå›´é‡Œã€‚\r\n\r\nå› æ­¤ï¼Œå…¶å®æˆ‘ä»¬é¢ä¸´çš„æœ€å¤§é—®é¢˜å°±æ˜¯â€”â€”æ‰€æœ‰çš„é€‰æ‹©å™¨éƒ½æ˜¯åœ¨ä¸€ä¸ªå…¨å±€ä½œç”¨åŸŸå†…çš„ã€‚ä¸€æ—¦å¼•å…¥ä¸€ä¸ªæ–°çš„CSSæ–‡ä»¶ï¼Œå°±æœ‰ç€ä¸é¢„æœŸä¸ç¬¦çš„æ ·å¼è¡¨ç°çš„é£é™©ï¼ˆå› ä¸ºä¸€äº›ä¸å¯é¢„æµ‹çš„é€‰æ‹©å™¨ï¼‰ã€‚\r\n\r\nè€Œå¦‚ä»Šçš„å‰ç«¯é¡¹ç›®è§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼Œå·²ç»ä¸æ˜¯è¿‡å»éšä¾¿å‡ ä¸ªcssã€jsæ–‡ä»¶å°±å¯ä»¥æå®šçš„æ—¶ä»£ã€‚ä¸æ­¤åŒæ—¶çš„ï¼Œå¯¹äºä¸€ä¸ªå¤§å‹çš„åº”ç”¨ï¼Œå‰ç«¯å¼€å‘å›¢é˜Ÿå¾€å¾€ä¹Ÿä¸å†æ˜¯ä¸€ä¸¤ä¸ªäººã€‚éšç€é¡¹ç›®ä¸å›¢é˜Ÿè§„æ¨¡çš„æ‰©å¤§ï¼Œç”šè‡³æ˜¯é¡¹ç›®è¿‡ç¨‹ä¸­äººå‘˜çš„å˜åŠ¨ï¼Œå¦‚ä½•æ›´å¥½è¿›è¡Œä»£ç å¼€å‘çš„ç®¡ç†å·²ç»æˆä¸ºäº†ä¸€ä¸ªé‡è¦é—®é¢˜ã€‚\r\n\r\nå›æƒ³ä¸€ä¸‹ï¼Œæœ‰å¤šå°‘æ¬¡ï¼š\r\n- æˆ‘ä»¬è®¨è®ºç€å¦‚ä½•å¯¹classè¿›è¡Œæœ‰æ•ˆçš„å‘½åï¼Œä»¥é¿å…åä½œå¼€å‘æ—¶çš„å†²çªï¼›\r\n- æˆ‘ä»¬é¢å¯¹ä¸€æ®µåˆ«äººå†™çš„cssã€htmlä»£ç ï¼Œæƒ³è¦å»ä¿®æ”¹ï¼Œç„¶åç–¯ç‹‚æŸ¥æ‰¾ã€çŒœæµ‹æ¯ä¸ªç±»éƒ½æ˜¯ä»€ä¹ˆä½œç”¨ï¼Œå“ªäº›æ˜¯å¯ä»¥å»æ‰çš„ï¼Œå“ªäº›æ˜¯å¯ä»¥ä¿®æ”¹çš„â€”â€”åˆ°æœ€åæˆ‘ä»¬é€‰æ‹©é‡æ–°æ·»åŠ ä¸€ä¸ªæ–°çš„classï¼›\r\n- æˆ‘ä»¬å‡†å¤‡é‡æ„ä»£ç æ—¶ï¼Œé‡æ„ä¹Ÿå°±æˆäº†é‡å†™\r\n- â€¦â€¦\r\n\r\nç”¨CSSå®ç°ä¸€äº›æ ·å¼å¾€å¾€å¹¶ä¸æ˜¯æœ€å›°éš¾çš„æ‰€åœ¨ï¼Œéš¾çš„æ˜¯ä½¿ç”¨ä¸€å¥—åˆç†çš„CSSæ¶æ„æ¥æ”¯æŒå›¢é˜Ÿçš„åˆä½œä¸åç»­çš„ç»´æŠ¤ã€‚\r\n\r\n> What we want is to be able to write code that is as transparent and self-documenting as possible. \r\n\r\næœ¬ç³»åˆ—æ–‡ç« ä¼šä»‹ç»ä¸€äº›ä¸šç•Œåœ¨æ¢ç´¢CSSæ¨¡å—åŒ–è¿›ç¨‹ä¸­æå‡ºçš„æ–¹æ¡ˆã€‚å†ä¸Šä¸€ç¯‡æ–‡ç« é‡Œæˆ‘ä»¬ä»‹ç»äº†[å¦‚ä½•ä½¿ç”¨BEMå’Œå‘½åç©ºé—´æ¥è§„èŒƒä¸æ¶æ„æˆ‘ä»¬çš„CSS](https://juejin.im/post/5b20e8e0e51d4506c60e47f5)ã€‚è¿™ä¸€ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†ï¼Œå¦‚ä½•åœ¨webpackä¸­ä½¿ç”¨ä¸€ç§ç±»ä¼¼â€œCSSæ¨¡å—åŒ–â€çš„è§£å†³æ–¹æ¡ˆâ€”â€”â€”Local Scopeï¼Œæ¥è§„é¿ä¸€äº›å¼€å‘ä¸­çš„é—®é¢˜ã€‚\r\n\r\n## 2. ä»€ä¹ˆæ˜¯Local Scope\r\né€šå¸¸æ¥è¯´ï¼ŒCSSä¸­çš„æ‰€æœ‰é€‰æ‹©å™¨å¯ä»¥ç®—æ˜¯â€œå…¨å±€ä½œç”¨åŸŸâ€ã€‚è€Œâ€œLocal Scopeâ€é¡¾åæ€ä¹‰ï¼Œä½¿CSSå…·æœ‰ç±»ä¼¼äºå±€éƒ¨ä½œç”¨åŸŸçš„èƒ½åŠ›ï¼ŒåŒæ—¶æ­é…ç±»ä¼¼JavaScriptä¸­æ¨¡å—åŒ–çš„å†™æ³•ï¼Œåˆ°è¾¾CSSæ¨¡å—åŒ–çš„æ•ˆæœã€‚\r\n\r\nè¿™ä¹ˆè¯´å¯èƒ½æœ‰äº›æŠ½è±¡ï¼Œæˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚\r\n\r\nåœ¨webpackä¸­å¼•å…¥csså¾€å¾€æ˜¯è¿™æ ·çš„ï¼š\r\n\r\n```\r\n// index.css\r\n.title {\r\n    font-size: 30px;\r\n    color: #333;\r\n}\r\n\r\n// index.js\r\nimport './index.css';\r\n\r\nfunciont createTitle(str) {\r\n    var title = document.createElement('h1');\r\n    title.appendChild(document.createTextNode(str));\r\n    title.setAttribute('class', 'title');\r\n    document.body.appendChild(title);\r\n}\r\n\r\ncreateTitle('Hi!');\r\n```\r\n\r\nç”±äºï¼Œwebpackä¸­å°†jsã€cssã€pngç­‰è¿™äº›èµ„æºéƒ½è§†ä¸ºæ¨¡å—ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡importå¯¼å…¥ã€‚ä½†æ˜¯ï¼Œå®é™…ä¸Šï¼Œå¯¹äºå¯¼å…¥çš„æ‰€æœ‰cssï¼Œå…¶â€œåœ°ä½â€éƒ½æ˜¯å¹³ç­‰çš„ï¼Œéƒ½æ˜¯åœ¨å…¨å±€æœ‰æ•ˆçš„ã€‚ä¾‹å¦‚ï¼š\r\n\r\n```\r\n// index.css\r\n.title {\r\n    font-size: 30px;\r\n    color: #333;\r\n}\r\n\r\n// other.css\r\n.title {\r\n    font-size: 15px;\r\n    color: #999;\r\n}\r\n\r\n// index.js\r\nimport './index.css';\r\nimport './other.css';\r\n\r\nfunciont createTitle(str) {\r\n    var title = document.createElement('h1');\r\n    title.appendChild(document.createTextNode(str));\r\n    title.setAttribute('class', 'title');\r\n    document.body.appendChild(title);\r\n}\r\n\r\ncreateTitle('Hi!');\r\n```\r\n\r\nå½“æˆ‘ä»¬å¼•å…¥äº†æ–°çš„CSSæ–‡ä»¶other.cssåï¼Œå…¶ä¸­çš„`.title`å’Œindex.cssä¸­çš„`.title`æœ‰ç€åŒæ ·çš„â€œä½œç”¨åŸŸâ€â€”â€”å…¨å±€ã€‚\r\n\r\nå›æƒ³ä¸€ä¸‹åœ¨JavaScriptä¸­ï¼š\r\n\r\n```\r\n// a.js\r\nvar a = 1;\r\n\r\n// other.js\r\nvar a = 2;\r\n\r\n// index.html\r\n<script src=\"./a.js\"></script>\r\n<script src=\"./other.js\"></script>\r\n<script>\r\n    console.log(a); // 2\r\n</script>\r\n```\r\n\r\nå¦‚æœæŸä¸ªhtmlé¡µé¢é€šè¿‡`script`æ ‡ç­¾å¼•å…¥è¿™ä¸¤jsæ–‡ä»¶ï¼Œé‚£ä¹ˆaçš„å€¼å¿…å®šä¼šæœ‰å†²çªï¼Œå…¶ä¸­ä¸€ä¸ªä¼šè¢«è¦†ç›–ã€‚å¦‚æœä½¿ç”¨æ¨¡å—åŒ–çš„æ–¹å¼ï¼Œå¯ä»¥å˜æˆï¼š\r\n\r\n```javascript\r\n// a.js\r\nexport var a = 1;\r\n\r\n// other.js\r\nexport var a = 2;\r\n\r\n// app.js\r\nimport {a} from './a';\r\nimport {a as other} from './other';\r\n\r\nconsole.log(a); // 1\r\nconsole.log(a); // 2\r\n```\r\n\r\nè€Œæ‰€è°“çš„Local Scopeå°±æ˜¯webpackä¸­åœ¨CSSä¸Šé’ˆå¯¹è¿™ç§é—®é¢˜çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚ç±»ä¼¼JavaScriptçš„æ¨¡å—åŒ–ï¼Œé€šè¿‡å¯¹CSSæ–‡ä»¶è¿›è¡Œæ¨¡å—å¼•ç”¨ä¸å¯¼å‡ºçš„æ–¹å¼ï¼Œèƒ½å¤Ÿåœ¨å¼€å‘æ—¶ï¼Œæ›´æœ‰æ•ˆå¾—æ§åˆ¶å„ä¸ªclassçš„ä½œç”¨èŒƒå›´ã€‚\r\n\r\n## 3. ä½¿ç”¨æ–¹æ³•\r\né¦–å…ˆï¼Œéœ€è¦åœ¨webpackä¸­å¯¹`css-loader`è¿›è¡Œä¸€å®šçš„é…ç½®ã€‚\r\n\r\n```javascript\r\n// loader: 'css-loader',\r\n// options: {\r\n//     modules: true,\r\n//     localIdentName: '[local]__[name]--[hash:base64:5]'\r\n// }\r\nconst config = {\r\n    entry: './src/index.js',\r\n    output: {\r\n        path: path.resolve(__dirname, 'dist'),\r\n        filename: 'bundle.js'\r\n    },\r\n    module: {\r\n        rules: [{\r\n            test: /\\.css$/,\r\n            use: [{\r\n                loader: 'style-loader'\r\n            }, {\r\n                loader: 'css-loader',\r\n                options: {\r\n                    modules: true,\r\n                    localIdentName: '[local]__[name]--[hash:base64:5]'\r\n                }\r\n            }]\r\n        }]\r\n    }\r\n};\r\n```\r\n\r\nç„¶åï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨å‰ä¸€èŠ‚ä¾‹å­ä¸­çš„é‚£ä¸ªåœºæ™¯ï¼š\r\n\r\n```\r\n// index.css\r\n:local .title {\r\n    font-size: 30px;\r\n    color: #333;\r\n}\r\n\r\n// other.css\r\n:local .title {\r\n    font-size: 15px;\r\n    color: #999;\r\n}\r\n\r\n// index.js\r\nimport styles from './index.css';\r\nimport others from './other.css';\r\n\r\nfunciont createTitle(str) {\r\n    var title = document.createElement('h1');\r\n    title.appendChild(document.createTextNode(str));\r\n    // styles.title  font-size: 30px;color: #333;\r\n    title.setAttribute('class', styles.title);\r\n    document.body.appendChild(title);\r\n}\r\n\r\ncreateTitle('Hi!');\r\n```\r\n\r\nå…¶ä¸­éœ€è¦æ³¨æ„çš„æœ‰ä¸‰ä¸ªåœ°æ–¹ï¼š\r\n- ç¬¬ä¸€ä¸ªæ˜¯åœ¨CSSæ–‡ä»¶ä¸­çš„ï¼Œç±»é€‰æ‹©å™¨å‰å¤šäº†`:local`è¿™ä¸ªè¯­æ³•ã€‚é€šè¿‡æ·»åŠ `:local`å°±å¯ä»¥æŒ‡ç¤ºwebpackï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªâ€œå…¨å±€â€çš„é€‰æ‹©å™¨ï¼ˆå½“ç„¶ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯å…¨å±€çš„ï¼Œåé¢ä¼šç®€å•è§£é‡Šï¼‰ã€‚\r\n- ç¬¬äºŒä¸ªåœ°æ–¹æ˜¯åœ¨jsæ–‡ä»¶ä¸­ï¼Œå°†`import 'index.css'`å˜ä¸ºäº†`import styles from './index.css'`ã€‚æ˜¯ä¸æ˜¯çœ‹ç€å¾ˆç†Ÿæ‚‰ï¼Œæ²¡é”™ï¼Œå’ŒJavaScriptä¸­çš„æ¨¡å—åŒ–æ–¹æ¡ˆç”¨æ³•ä¸€æ ·ã€‚\r\n- ç¬¬ä¸‰ä¸ªåœ°æ–¹ï¼Œåœ¨ä½¿ç”¨åˆ°è¯¥classçš„åœ°æ–¹ï¼Œç”±åŸæ¥çš„`title.setAttribute('class', â€˜titleâ€™)`å˜ä¸ºäº†`title.setAttribute('class', styles.title)`ã€‚è¿™æ ·æˆ‘ä»¬å¯ä»¥é€‰æ‹©åœ¨ä¸€éƒ¨åˆ†domå…ƒç´ ä¸Šä½¿ç”¨`styles.title`ï¼Œå³`index.css`çš„æ ·å¼ï¼›åœ¨å¦ä¸€éƒ¨åˆ†domå…ƒç´ ä¸Šä½¿ç”¨`other.css`çš„æ ·å¼ã€‚\r\n\r\nè¿™æ ·å°±è§£å†³äº†æˆ‘ä»¬ä¹‹å‰æåˆ°çš„é—®é¢˜ã€‚\r\n\r\nå½“ç„¶ï¼Œæœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›ç±»é€‰æ‹©å™¨ä¸­çš„æŸä¸€éƒ¨åˆ†ä»ç„¶æ˜¯â€œå…¨å±€â€çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆå†™ï¼š\r\n\r\n```css\r\n:local .title :global(.sub-title) { color: #666; }\r\n```\r\n\r\n## 4. å…³äºLocal Scope\r\nè™½ç„¶æˆ‘ä»¬ä¸Šé¢è¯´äº†è¿™ä¹ˆå¤šæ¬¡çš„â€œæ¨¡å—åŒ–â€ã€â€œä½œç”¨åŸŸâ€ã€â€œå…¨å±€â€ï¼Œç„¶è€Œï¼Œå®é™…ä¸Šï¼Œå¯¹äºCSSè¿™é—¨è¯­è¨€æ¥è¯´ï¼Œå®ƒåœ¨è‡ªå·±æœ¬èº«çš„é€»è¾‘ä¸Šæ˜¯ä¸å…·å¤‡è¿™äº›ç‰¹ç‚¹çš„ã€‚è€Œwebpackä¸­Local Scopeçš„ç›¸å…³æ–¹æ¡ˆï¼Œå…¶å®ä¹Ÿå¹¶ä¸æ˜¯ï¼ˆCSSæœ¬èº«é€»è¾‘æ”¯æŒçš„ï¼‰çœŸæ­£æ„ä¹‰ä¸Šæ‰€è°“çš„æ¨¡å—åŒ–ã€‚æ‰€ä»¥å¾ˆå¤šåœ°æ–¹æˆ‘éƒ½æ‰“ä¸Šäº†å¼•å·ã€‚\r\n\r\nå¦‚æœå¯¹ç€æ‰“åŒ…åçš„é¡µé¢ï¼Œæ‰“å¼€chromeæ§åˆ¶å°ï¼Œä¼šå‘ç°ï¼Œæˆ‘ä»¬çš„htmlæ˜¯è¿™ä¸ªæ ·å­çš„\r\n\r\n```\r\n<body>\r\n    <h1 class=\"title__index--330EV\">Hi!</h1>\r\n</body>\r\n```\r\n\r\n`h1`æ ‡ç­¾çš„`class`å¹¶ä¸æ˜¯æˆ‘ä»¬åœ¨CSSä¸­æ‰€å†™çš„`title`ï¼Œè€Œæ˜¯ä¸€ä¸²å¥‡æ€ªçš„å­—ç¬¦ä¸²`title__index--330EV`ã€‚\r\n\r\nå½“ä½¿ç”¨webpackè¿›è¡Œæ‰“åŒ…æ—¶ï¼Œç”±äºæ£€æŸ¥åˆ°`:local`è¿™ä¸ªè¯­æ³•ï¼Œå› æ­¤ä¼šä¸º`.title`è¿™ä¸ªclassç”Ÿæˆä¸€ä¸ªæ–°çš„classåç§°ï¼Œè€Œæˆ‘ä»¬åœ¨jsæ–‡ä»¶ä¸­æ‰€ä½¿ç”¨çš„`styles.title`å¯¹åº”çš„å°±æ˜¯è¿™ä¸ªæ–°çš„classnameã€‚\r\n\r\næ‰€ä»¥å¯ä»¥ç†è§£ï¼Œå…¶å®å½“å‰çš„CSSè¯­æ³•é€»è¾‘ä¸­ä¸­å¹¶æ²¡æœ‰å®é™…æ„ä¹‰ä¸Šæ‰€è°“çš„local scopeï¼Œä½†æ˜¯ï¼Œé€šè¿‡webpackæ‰“åŒ…æ—¶çš„æ“ä½œï¼Œæˆ‘ä»¬ä¼šä¸ºæ¯ä¸ª`:local`çš„classç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„åç§°ï¼Œè€Œæˆ‘ä»¬ä½¿ç”¨æ ·å¼å®é™…æ˜¯æŒ‡å‘äº†è¿™ä¸ªclassnameã€‚è¿™å°±å®ç°äº†ä¸¤ä¸ªCSSæ–‡ä»¶ä¸­ï¼Œç›¸åŒåç§°çš„classåœ¨ä½¿ç”¨æ—¶å°±ä¸ä¼šæœ‰å†²çªäº†ï¼Œç›¸å½“äºé¿å¼€äº†â€œå…¨å±€ä½œç”¨åŸŸâ€ã€‚\r\n\r\nå¦‚æœæ‰“å¼€æ‰“åŒ…åçš„`bundle.js`,æˆ‘ä»¬å¯ä»¥å‘ç°ä¸€æ®µå¾ˆæœ‰è¶£çš„ä»£ç \r\n\r\n```javascript\r\n// â€¦â€¦å…¶ä½™çœç•¥\r\n// exports\r\nexports.locals = {\r\n    \"title\": \"title__index--330EV\"\r\n};\r\n\r\n// â€¦â€¦å…¶ä½™çœç•¥\r\n// exports\r\nexports.locals = {\r\n    \"title\": \"title__other--3vRzX\"\r\n};\r\n```\r\n\r\nè¿™æ˜¯åœ¨ä¸¤ä¸ªä¸åŒçš„æ¨¡å—å†…çš„éƒ¨åˆ†ã€‚ä¸Šé¢ä¸€ä¸ªå°±æ˜¯å¯¼å‡ºçš„`index.css`ä¸­å¯¹åº”çš„classnameï¼Œä¸‹é¢ä¸€ä¸ªå°±æ˜¯`other.css`çš„ã€‚é€šè¿‡`styles.title`å°±å¯ä»¥å¼•ç”¨åˆ°`title__index--330EV`è¿™ä¸ªå®é™…å€¼ã€‚\r\n\r\næœ€åï¼Œå†æ¥è¯´ä¸€ä¸‹`title__index--330EV`è¿™ä¸ªå€¼å¾—ç”±æ¥ã€‚åœ¨ä¸Šä¸€èŠ‚çš„ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å¯¹webpackè¿›è¡Œäº†é…ç½®ï¼Œå…¶ä¸­æœ‰ä¸€è¡Œ\r\n\r\n```javascript\r\nlocalIdentName: '[local]__[name]--[hash:base64:5]'\r\n```\r\n\r\nå…¶å®å°±æ˜¯æŒ‡ç¤ºäº†å”¯ä¸€æ ‡è¯†çš„å‘½åæ–¹å¼ï¼š`local`æ˜¯classçš„åç§°ï¼Œ`name`æ˜¯æ–‡ä»¶çš„åç§°ï¼Œè€Œæœ€ååŠ ä¸Š`hash`å€¼ã€‚å½“ç„¶ï¼Œä½ å®Œå…¨å¯ä»¥ä½¿ç”¨å…¶ä»–ä½ å–œæ¬¢çš„æ–¹å¼ã€‚é»˜è®¤æ˜¯ä½¿ç”¨`[hash:base64]`ã€‚\r\n\r\n## 5. å†™åœ¨æœ€å\r\nå…¶å®webpackä¸­çš„CSSæ¨¡å—åŒ–æ–¹æ¡ˆLocal Scopeï¼Œç²—æµ…çš„æ¥è¯´ä¹Ÿæ˜¯é€šè¿‡ç”Ÿæˆå”¯ä¸€çš„classnameæ¥é¿å…å†²çªï¼Œæ§åˆ¶ä½œç”¨èŒƒå›´ã€‚åªæ˜¯å’ŒBEMä¸åŒï¼ŒBEMæ˜¯ä¸€ä¸ªå»ºè®®æ ‡å‡†ï¼Œæ›´å¤šçš„è¿˜æ˜¯äººä¸ºçš„æ“æ§ï¼Œè€Œwebpackä¸­çš„Local Scopeåˆ™æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„æ¨¡å—åŒ–ä¸æ‰“åŒ…æ–¹æ¡ˆã€‚åœ¨ä¸€å®šç¨‹åº¦ä¸Šæé«˜äº†å¼€å‘çš„æ•ˆç‡ï¼Œé™ä½äº†é”™è¯¯ç‡ã€‚","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/14","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/14/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/14/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/14/events","html_url":"https://github.com/alienzhou/blog/issues/14","id":390633994,"node_id":"MDU6SXNzdWUzOTA2MzM5OTQ=","number":14,"title":"ã€CSSæ¨¡å—åŒ–ä¹‹è·¯1ã€‘ä½¿ç”¨BEMä¸å‘½åç©ºé—´æ¥è§„èŒƒCSS","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845018,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE4","url":"https://api.github.com/repos/alienzhou/blog/labels/CSS","name":"CSS","color":"7057ff","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T11:23:17Z","updated_at":"2018-12-13T11:23:17Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"CSSæ˜¯ä¸€é—¨å‡ ååˆ†é’Ÿå°±èƒ½å…¥é—¨ï¼Œä½†æ˜¯å´éœ€è¦å¾ˆé•¿çš„æ—¶é—´æ‰èƒ½æŒæ¡å¥½çš„è¯­è¨€ã€‚å®ƒæœ‰ç€å®ƒè‡ªèº«çš„ä¸€äº›å¤æ‚æ€§ä¸å±€é™æ€§ã€‚å…¶ä¸­éå¸¸é‡è¦çš„ä¸€ç‚¹å°±æ˜¯ï¼Œæœ¬èº«ä¸å…·å¤‡çœŸæ­£çš„æ¨¡å—åŒ–èƒ½åŠ›ã€‚\r\n\r\n## 1. é¢ä¸´çš„é—®é¢˜\r\nCSSä¸­è™½ç„¶æœ‰`@import`åŠŸèƒ½ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œè¿™é‡Œçš„`@import`ä»…ä»…æ˜¯è¡¨ç¤ºå¼•å…¥ç›¸åº”çš„CSSæ–‡ä»¶ï¼Œä½†å…¶æ¨¡å—åŒ–æ ¸å¿ƒé—®é¢˜å¹¶æœªè§£å†³â€”â€”CSSæ–‡ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ªé€‰æ‹©å™¨éƒ½ä¼šä½œç”¨åœ¨æ•´ä¸ªæ–‡æ¡£èŒƒå›´é‡Œã€‚\r\n\r\nå› æ­¤ï¼Œå…¶å®æˆ‘ä»¬é¢ä¸´çš„æœ€å¤§é—®é¢˜å°±æ˜¯â€”â€”æ‰€æœ‰çš„é€‰æ‹©å™¨éƒ½æ˜¯åœ¨ä¸€ä¸ªå…¨å±€ä½œç”¨åŸŸå†…çš„ã€‚ä¸€æ—¦å¼•å…¥ä¸€ä¸ªæ–°çš„CSSæ–‡ä»¶ï¼Œå°±æœ‰ç€ä¸é¢„æœŸä¸ç¬¦çš„æ ·å¼è¡¨ç°çš„é£é™©ï¼ˆå› ä¸ºä¸€äº›ä¸å¯é¢„æµ‹çš„é€‰æ‹©å™¨ï¼‰ã€‚\r\n\r\nè€Œå¦‚ä»Šçš„å‰ç«¯é¡¹ç›®è§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼Œå·²ç»ä¸æ˜¯è¿‡å»éšä¾¿å‡ ä¸ªcssã€jsæ–‡ä»¶å°±å¯ä»¥æå®šçš„æ—¶ä»£ã€‚ä¸æ­¤åŒæ—¶çš„ï¼Œå¯¹äºä¸€ä¸ªå¤§å‹çš„åº”ç”¨ï¼Œå‰ç«¯å¼€å‘å›¢é˜Ÿå¾€å¾€ä¹Ÿä¸å†æ˜¯ä¸€ä¸¤ä¸ªäººã€‚éšç€é¡¹ç›®ä¸å›¢é˜Ÿè§„æ¨¡çš„æ‰©å¤§ï¼Œç”šè‡³æ˜¯é¡¹ç›®è¿‡ç¨‹ä¸­äººå‘˜çš„å˜åŠ¨ï¼Œå¦‚ä½•æ›´å¥½è¿›è¡Œä»£ç å¼€å‘çš„ç®¡ç†å·²ç»æˆä¸ºäº†ä¸€ä¸ªé‡è¦é—®é¢˜ã€‚\r\n\r\nå›æƒ³ä¸€ä¸‹ï¼Œæœ‰å¤šå°‘æ¬¡ï¼š\r\n- æˆ‘ä»¬è®¨è®ºç€å¦‚ä½•å¯¹classè¿›è¡Œæœ‰æ•ˆçš„å‘½åï¼Œä»¥é¿å…åä½œå¼€å‘æ—¶çš„å†²çªï¼›\r\n- æˆ‘ä»¬é¢å¯¹ä¸€æ®µåˆ«äººå†™çš„cssã€htmlä»£ç ï¼Œæƒ³è¦å»ä¿®æ”¹ï¼Œç„¶åç–¯ç‹‚æŸ¥æ‰¾ã€çŒœæµ‹æ¯ä¸ªç±»éƒ½æ˜¯ä»€ä¹ˆä½œç”¨ï¼Œå“ªäº›æ˜¯å¯ä»¥å»æ‰çš„ï¼Œå“ªäº›æ˜¯å¯ä»¥ä¿®æ”¹çš„â€”â€”åˆ°æœ€åæˆ‘ä»¬é€‰æ‹©é‡æ–°æ·»åŠ ä¸€ä¸ªæ–°çš„classï¼›\r\n- æˆ‘ä»¬å‡†å¤‡é‡æ„ä»£ç æ—¶ï¼Œé‡æ„ä¹Ÿå°±æˆäº†é‡å†™\r\n- â€¦â€¦\r\n\r\nç”¨CSSå®ç°ä¸€äº›æ ·å¼å¾€å¾€å¹¶ä¸æ˜¯æœ€å›°éš¾çš„æ‰€åœ¨ï¼Œéš¾çš„æ˜¯ä½¿ç”¨ä¸€å¥—åˆç†çš„CSSæ¶æ„æ¥æ”¯æŒå›¢é˜Ÿçš„åˆä½œä¸åç»­çš„ç»´æŠ¤ã€‚\r\n\r\n> What we want is to be able to write code that is as transparent and self-documenting as possible. \r\n\r\næœ¬ç³»åˆ—æ–‡ç« ä¼šä»‹ç»ä¸€äº›ä¸šç•Œåœ¨æ¢ç´¢CSSæ¨¡å—åŒ–è¿›ç¨‹ä¸­æå‡ºçš„æ–¹æ¡ˆã€‚æœ¬ç¯‡ä¸»è¦ä¼šè®²è§£BEMæ–¹æ³•è®ºï¼Œå¹¶å°†å…¶ä¸CSSå‘½åç©ºé—´ç»“åˆã€‚\r\n\r\n## 2. BEMå‘½åæ–¹æ³•è®º\r\n\r\nBEMå…¶å®æ˜¯ä¸€ç§å‘½åçš„è§„èŒƒã€‚æˆ–è€…è¯´æ˜¯ä¸€ç§classä¹¦å†™æ–¹å¼çš„æ–¹æ³•è®ºï¼ˆmethodologyï¼‰ã€‚BEMçš„æ„æ€å°±æ˜¯å—ï¼ˆblockï¼‰ã€å…ƒç´ ï¼ˆelementï¼‰ã€ä¿®é¥°ç¬¦ï¼ˆmodifierï¼‰,æ˜¯ç”±[Yandex](http://yandex.ru/)å›¢é˜Ÿæå‡ºçš„ä¸€ç§å‰ç«¯å‘½åæ–¹æ³•è®ºã€‚åœ¨å…·ä½“CSSç±»é€‰æ‹©å™¨ä¸Šçš„è¡¨ç°å°±åƒä¸‹é¢è¿™æ ·\r\n\r\n```css\r\n.block {}\r\n.block__element {}\r\n.block--modifier {}\r\n.block__element--modifier {}\r\n```\r\n\r\nå…¶ä¸­ï¼Œblockè¡¨ç¤ºçš„æ˜¯ç‹¬ç«‹çš„åˆ†å—æˆ–ç»„ä»¶ï¼›elementè¡¨ç¤ºæ¯ä¸ªblockä¸­æ›´ç»†ç²’åº¦çš„å…ƒç´ ï¼›modifieråˆ™é€šå¸¸ä¼šç”¨æ¥è¡¨ç¤ºè¯¥blockæˆ–è€…elementä¸åŒçš„ç±»å‹å’ŒçŠ¶æ€ã€‚\r\n\r\nä¸¾ä¸ªä¾‹å­ï¼Œä¾‹å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªåˆ—è¡¨\r\n\r\n```html\r\n<ul class=\"list\">\r\n  <li class=\"item\">learn html</li>\r\n  <li class=\"item underline\">learn css</li>\r\n  <li class=\"item\">learn js</li>\r\n</ul>\r\n```\r\n\r\nåˆ—è¡¨å®¹å™¨çš„classä¸º`.list`ï¼Œåˆ—è¡¨å†…æ¯æ¡è®°å½•çš„classä¸º`.item`ï¼Œå…¶ä¸­ï¼Œè¿˜ä¸ºç¬¬äºŒä¸ªæ¡è®°å½•æ·»åŠ äº†ä¸€ä¸ªä¸‹åˆ’çº¿`.underline`ã€‚ç®€å•çš„csså¦‚ä¸‹\r\n\r\n```css\r\n.list {\r\n  margin: 15px;\r\n  padding: 0;\r\n}\r\n.list .item {\r\n  margin: 10px 0;\r\n  border-left: 3px solid #333;\r\n  font-size: 15px;\r\n  color: #333;\r\n  list-style: none;\r\n}\r\n.list .underline {\r\n  color: #111;\r\n  text-decoration: underline;\r\n}\r\n```\r\n\r\nè¿™æ ·çš„å‘½åæ–¹å¼ï¼Œæˆ‘ä»¬åœ¨é˜…è¯»htmlæ—¶å¹¶ä¸èƒ½è¿…é€Ÿäº†è§£ï¼š`.item`æ˜¯åªèƒ½åœ¨`.list`ä¸­ä½¿ç”¨ä¹ˆï¼Œå®ƒæ˜¯ä»…ä»…å®šä¹‰åœ¨è¿™ä¸ªç»„ä»¶å†…çš„ä¸€éƒ¨åˆ†ä¹ˆï¼Ÿ`.underline`æ˜¯ä¸€ä¸ªé€šç”¨æ ·å¼ä¹ˆï¼Œæˆ‘æƒ³ä¿®æ”¹åˆ—è¡¨çš„ä¸­underlineçš„è®°å½•ä¸ºçº¢è‰²ï¼Œè¿™ä¼šå½±å“åˆ°é¡¹ç›®å…¶ä»–åœ°æ–¹ä¹ˆï¼Ÿ\r\n\r\nè¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨BEMæ–¹å¼æ¥å‘½åæˆ‘ä»¬çš„class\r\n\r\n```css\r\n.list {\r\n  margin: 15px;\r\n  padding: 0;\r\n}\r\n.list__item {\r\n  margin: 10px 0;\r\n  border-left: 3px solid #333;\r\n  font-size: 15px;\r\n  color: #333;\r\n  list-style: none;\r\n}\r\n.list__item--underline {\r\n  color: #111;\r\n  text-decoration: underline;\r\n}\r\n```\r\n\r\n```html\r\n<ul class=\"list\">\r\n  <li class=\"list__item\">learn html</li>\r\n  <li class=\"list__item list__item--underline\">learn css</li>\r\n  <li class=\"list__item\">learn js</li>\r\n</ul>\r\n```\r\n\r\nè¿™æ®µä»£ç çš„ä¸€å¤§ä¼˜åŠ¿å°±æ˜¯å¢åŠ äº†å®ƒçš„è‡ªè§£é‡Šæ€§ï¼šä¸€å®šç¨‹åº¦ä¸Šï¼Œå®ƒçš„classåæœ¬èº«å°±æ˜¯ä¸€ä¸ªç®€æ˜“çš„æ–‡æ¡£ã€‚\r\n\r\nè¿™é‡Œè¿˜éœ€è¦é¿å…ä¸€ä¸ªè¯¯åŒºï¼ŒBEMå‘½åè§„èŒƒé‡Œï¼Œæˆ‘ä»¬çš„CSSå¹¶ä¸ä¼šå…³å¿ƒHTMLä¸­domå…ƒç´ çš„å±‚çº§ç»“æ„ã€‚å®ƒçš„æ ¸å¿ƒç€çœ¼ç‚¹è¿˜æ˜¯æˆ‘ä»¬å®šä¹‰çš„å—ï¼ˆblockï¼‰ã€å…ƒç´ ï¼ˆelementï¼‰ã€ä¿®é¥°ç¬¦ï¼ˆmodifierï¼‰è¿™ä¸‰éƒ¨åˆ†ã€‚å› ä¸ºå…³æ³¨ç‚¹ä¸åŒï¼Œæ‰€ä»¥ä¸€ä¸ªblockå†…çš„æ‰€æœ‰elementï¼Œåœ¨CSSä¸­å¹¶ä¸ä¼šè€ƒè™‘å±‚çº§ï¼Œå› æ­¤ä¹Ÿå°±æ²¡æœ‰`.list__item__avatar`è¿™ç§å†™æ³•\r\n\r\n```html\r\n<ul class=\"list\">\r\n  <li class=\"list__item\">\r\n    ![](avatar.png)\r\n    learn html\r\n  </li>\r\n  <li class=\"list__item list__item--underline\">learn css</li>\r\n  <li class=\"list__item\">learn js</li>\r\n</ul>\r\n```\r\n\r\nè€Œæ˜¯æŠŠè¿™ä¸ª`img`ä¹Ÿçœ‹ä½œblockä¸­çš„å…ƒç´ `.list__avatar`\r\n\r\n```html\r\n<ul class=\"list\">\r\n  <li class=\"list__item\">\r\n    ![](avatar.png)\r\n    learn html\r\n  </li>\r\n  <li class=\"list__item list__item--underline\">learn css</li>\r\n  <li class=\"list__item\">learn js</li>\r\n</ul>\r\n```\r\n\r\nä»è¿™ä¸ªä¾‹å­çœ‹ä¸€çœ‹å‡ºï¼ŒCSSéƒ¨åˆ†å¹¶ä¸å…³å¿ƒdomå±‚çº§ç»“æ„ï¼Œè€Œæ˜¯åœ¨blockä¸‹é¢æœ‰å“ªäº›elementï¼Œè¿™äº›elementåˆæœ‰å“ªäº›modifierã€‚\r\n\r\nåŸºäºè¿™ä¸ªæ€æƒ³ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¦‚æœä¸€ä¸ªblocké‡Œé¢å«æœ‰å…¶ä»–blockå¹¶ä¸ä¼šè¿åBEMçš„åŸåˆ™ã€‚ä¾‹å¦‚ä¸Šé¢è¿™ä¸ªåˆ—è¡¨çš„ä¾‹å­ï¼Œå…¶ä¸­å¤´åƒavataråŸæœ¬åªæ˜¯ä¸€ä¸ªç®€å•çš„elementï¼Œç°åœ¨å¦‚æœå˜æˆäº†ä¸€ä¸ªå¾ˆå¤æ‚çš„ç»„ä»¶â€”â€”åŒ…æ‹¬å›¾ç‰‡ã€å§“åå’Œæ ‡ç­¾ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šæœ‰è¿™ä¹ˆä¸€ä¸ªblock\r\n\r\n```html\r\n<ul class=\"list\">\r\n  <li class=\"list__item\">\r\n    <div class=\"list__avatar\">\r\n      <img class=\"list__head list__head--female\" />\r\n      <span class=\"list__name\"></span>\r\n      <span class=\"list__tag\"></span>\r\n    </div>\r\n    learn html\r\n  </li>\r\n  <li class=\"list__item list__item--underline\">learn css</li>\r\n  <li class=\"list__item\">learn js</li>\r\n</ul>\r\n```\r\n\r\næˆ‘ä»¬å¯ä»¥ä¸ºavataråˆ›å»ºä¸€ä¸ªæ–°çš„block\r\n\r\n```html\r\n<ul class=\"list\">\r\n  <li class=\"list__item\">\r\n    <div class=\"avatar\">\r\n      <img class=\"avatar__head avatar__head--female\" />\r\n      <span class=\"avatar__name\"></span>\r\n      <span class=\"avatar__tag\"></span>\r\n    </div>\r\n    learn html\r\n  </li>\r\n  <li class=\"list__item list__item--underline\">learn css</li>\r\n  <li class=\"list__item\">learn js</li>\r\n</ul>\r\n```\r\n\r\né‚£ä¹ˆä½ å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦åœ¨å°†ä¸€ä¸ªelmenté‡æ–°æŠ½è±¡ä¸ºæ–°çš„blockå‘¢ï¼Ÿä»…ä»…å½“æˆ‘ä»¬çš„domå…ƒç´ å˜å¾—å¾ˆå¤šçš„æ—¶å€™ä¹ˆï¼Ÿ\r\n\r\nå…¶å®ï¼ŒBEMä¸­çš„blockä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªâ€œç‹¬ç«‹çš„å—â€ã€‚ç‹¬ç«‹å°±æ„å‘³ç€ï¼ŒæŠŠè¿™ä¸€éƒ¨åˆ†æ”¾åˆ°å…¶ä»–éƒ¨åˆ†ä¹Ÿå¯ä»¥æ­£å¸¸å±•ç¤ºä¸ä½¿ç”¨ï¼Œå®ƒä¸ä¼šä¾èµ–å…¶çˆ¶å…ƒç´ æˆ–å…„å¼Ÿå…ƒç´ ã€‚è€Œåœ¨å¦ä¸€ä¸ªç»´åº¦ä¸Šé¢æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯è§†è§‰è®¾è®¡çš„ç»´åº¦ï¼Œå½“UIè®¾è®¡å¸ˆç»™å‡ºUIç¨¿åï¼Œå…¶ä¸­çš„ä¸€äº›è®¾è®¡å…ƒç´ æˆ–ç»„ä»¶ä¼šé‡å¤å‡ºç°ï¼Œè¿™äº›éƒ¨åˆ†ä¹Ÿæ˜¯å¯ä»¥è€ƒè™‘çš„ã€‚æ‰€ä»¥ç†è§£UIè®¾è®¡ç¨¿å¹¶ä¸æ˜¯æŒ‡ç®€å•çš„è¿˜åŸï¼Œå…¶ä¸­çš„è®¾è®¡åŸåˆ™ä¸è§„èŒƒä¹Ÿå€¼å¾—æ£æ‘©ã€‚\r\n\r\nä»ä¸Šé¢çš„ç®€å•ä»‹ç»å¯ä»¥çœ‹å‡ºï¼ŒBEMæœ‰ç€ä¸€äº›ä¼˜ç‚¹\r\n\r\n- classçš„å•ä¸€èŒè´£åŸåˆ™ã€å¼€é—­åŸåˆ™\r\n- æ¨¡å—åŒ–æ€æƒ³ï¼Œä¸€èˆ¬æ¥è¯´éµå¾ªè¿™ä¸ªæ–¹æ³•çš„ç»„ä»¶å¯ä»¥è¿ç§»ç¯å¢ƒ\r\n- ä¸€å®šç¨‹åº¦ä¸Šï¼Œé¿å…å‘½åçš„æ±¡æŸ“\r\n- è‡ªè§£é‡Šæ€§ã€‚å¯ä»¥ç›´è§‚çœ‹å‡ºå„ä¸ªclassä¹‹é—´çš„ä¾èµ–å…³ç³»ä»¥åŠå®ƒä»¬çš„ä½œç”¨èŒƒå›´ï¼ˆ`.list__item`å’Œ`.list__item--underline`éƒ½æ˜¯ä¾èµ–äº`.list`çš„ï¼Œå› æ­¤å®ƒä»¬ä¸èƒ½è„±ç¦»äº`.list`å­˜åœ¨ï¼‰\r\n\r\nå½“ç„¶ï¼ŒBEMä»…ä»…æ˜¯ä¸€ç§å‘½åè§„èŒƒæˆ–å»ºè®®ã€‚åœ¨æ²¡æœ‰çº¦æŸçš„æƒ…å†µä¸‹ï¼Œä½ éšæ—¶éƒ½å¯ä»¥è¿åã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å€ŸåŠ©ç±»ä¼¼BEM-constructorçš„å·¥å…·ï¼Œæ—¢å¸®æˆ‘ä»¬è¿›è¡Œä¸€å®šçš„çº¦æŸï¼ŒåŒæ—¶ä¹Ÿçœå»ä¸€äº›ç¹ççš„é‡å¤å·¥ä½œã€‚åœ¨ä»‹ç»BEM-constructorä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç®€å•äº†è§£ä¸€ä¸‹BEM-constructorä¸­å‘½åç©ºé—´ï¼ˆnamespacesï¼‰çš„åŸºæœ¬æ¦‚å¿µã€‚\r\n\r\n## 3. çº¦å®šé¡¹ç›®çš„å‘½åç©ºé—´ï¼ˆnamespacesï¼‰\r\n\r\nå‘½åç©ºé—´ï¼ˆnamespacesï¼‰ä¹Ÿæ˜¯ä¸€ç§å…³äºCSSä¸­classå‘½åæ–¹å¼çš„è§„èŒƒã€‚[ã€ŠMore Transparent UI Code with Namespacesã€‹](https://csswizardry.com/2015/03/more-transparent-ui-code-with-namespaces/)æä¾›äº†ä¸€ç§å‘½åç©ºé—´çš„è§„èŒƒã€‚åœ¨BEMçš„åŸºç¡€ä¸Šï¼Œå»ºç«‹å‘½åç©ºé—´ä¸»è¦æ˜¯ä¸ºäº†è¿›ä¸€æ­¥å¸®åŠ©æˆ‘ä»¬ï¼š\r\n- è®©ä»£ç èƒ½å¤Ÿè‡ªè§£é‡Š\r\n- åœ¨ä¸€ä¸ªå…¨å±€çš„contextä¸­å®‰å…¨åœ°åŠ å…¥ä¸€ä¸ªæ–°çš„class\r\n- ç¡®ä¿ä¸€ä¸ªä¿®æ”¹ä¸ä¼šäº§ç”Ÿé¢å¤–çš„å‰¯ä½œç”¨\r\n- åœ¨åæœŸç»´æŠ¤æ—¶èƒ½å¤Ÿè¿…é€Ÿå®šä½é—®é¢˜\r\n\r\nå‘½åç©ºé—´åˆ†ä¸ºä»¥ä¸‹å‡ ç§ã€‚\r\n\r\n### Object: o-\r\n\r\nå½“ä½ ä½¿ç”¨é¢å‘å¯¹è±¡çš„CSSï¼ˆObject-Oriented CSSï¼‰æ—¶ï¼Œ`o-`è¿™ä¸ªnamespaceå°†ä¼šéå¸¸æœ‰ç”¨ã€‚\r\n\r\n- å¯¹è±¡æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µã€‚\r\n- å°½é‡é¿å…ä¿®æ”¹å®ƒä»¬çš„æ ·å¼ã€‚\r\n- å¦‚æœè¦ä½¿ç”¨`o-`æ—¶è¯·æ…é‡è€ƒè™‘ã€‚\r\n\r\n### Component: c-\r\n\r\n`c-`åº”è¯¥æ˜¯ä¸€ä¸ªæ›´ä¸ºå¸¸è§çš„namespaceï¼Œè¡¨ç¤ºComponentsï¼ˆç»„ä»¶ï¼‰ã€‚\r\n```css\r\n.c-list {}\r\n.c-avatar {}\r\n```\r\nä»å‘½åä¸­æˆ‘ä»¬å°±èƒ½çŸ¥é“ï¼šè¿™æ˜¯ä¸€ä¸ªlistç»„ä»¶ï¼›æˆ–è€…è¿™æ˜¯ä¸€ä¸ªavatarç»„ä»¶ã€‚\r\n\r\n- Componentsåº”è¯¥æ˜¯ä¸€ç»„å…·ä½“çš„UIã€‚`c-`ä»£è¡¨ä¸€ä¸ªå…·ä½“çš„ç»„ä»¶ã€‚\r\n- ä¿®æ”¹å®ƒä»¬éå¸¸å®‰å…¨ï¼Œåªä¼šå¯¹ç»„ä»¶äº§ç”Ÿå½±å“ã€‚\r\n\r\n### Utility: u-\r\n\r\nUtilitiesç¬¦åˆå•ä¸€èŒè´£åŸåˆ™ï¼Œå®ç°ä¸€ä¸ªå…·ä½“çš„åŠŸèƒ½æˆ–æ•ˆæœã€‚å…¶æ¦‚å¿µæœ‰äº›ç±»ä¼¼JavaScriptä¸­çš„é€šç”¨å·¥å…·æ–¹æ³•ã€‚ä¾‹å¦‚ä¸€ä¸ªæ¸…é™¤æµ®åŠ¨çš„Utilityï¼Œæˆ–è€…ä¸€ä¸ªæ–‡å­—å±…ä¸­çš„Utilityã€‚\r\n```css\r\n.u-clearfix {}\r\n.u-textCenter {}\r\n```\r\nç”±äºUtilitiesä½œä¸ºä¸€ç»„å·¥å…·é›†ï¼Œåœ¨æ ·å¼ä¸Šå…·æœ‰æ›´å¼ºçš„â€œè¯è¯­æƒâ€ï¼Œæ‰€ä»¥`!important`åœ¨Utilitiesä¸­ä¼šæ›´ä¸ºå¸¸è§ã€‚å½“æˆ‘ä»¬çœ‹åˆ°ä¸‹é¢è¿™æ®µHTMLï¼Œæˆ‘ä»¬ä¼šæ›´åŠ ç¡®ä¿¡ï¼Œè¿™ä¸ªå¤§å·çš„å­—ä½“æ˜¯`.u-largeFont`è¿™ä¸ªæ ·å¼å¼•èµ·çš„ã€‚\r\n```java\r\n<h1 class=\"title u-largeFont\">namespace</h1>\r\n```\r\n\r\n- Utilitiesä¸­çš„æ ·å¼ä¸€èˆ¬å…·æœ‰æ›´é«˜çš„æƒé‡.\r\n- ä¸è¦æ»¥ç”¨`u-`å‰ç¼€ï¼Œåªç”¨åœ¨ä¸€äº›é€šç”¨çš„å·¥å…·æ–¹æ³•ä¸Š.\r\n\r\n### Theme: t-\r\n\r\nå½“æˆ‘ä»¬ä½¿ç”¨Stateful Themesè¿™ç§å®šä¹‰ä¸»é¢˜çš„æ–¹å¼æ—¶ï¼ˆåç»­æœ‰æœºä¼šä¼šä»‹ç»ä¸€äº›â€œè‡ªå®šä¹‰ä¸»é¢˜â€çš„æ–¹å¼ï¼‰ï¼Œå¾€å¾€æˆ‘ä»¬ä¼šåœ¨æœ€å¤–å±‚å®¹å™¨å…ƒç´ ä¸­åŠ å…¥ä¸€ä¸ªä»£è¡¨ä¸åŒä¸»é¢˜çš„classã€‚è¿™é‡Œå°±ä¼šç”¨åˆ°`t-`ã€‚\r\n\r\n- ä¸»é¢˜`t-`æ˜¯ä¸€ä¸ªé«˜å±‚çº§çš„å‘½åç©ºé—´ã€‚\r\n- ä¸€å®šç¨‹åº¦ä¸Šå®ƒå’Œä¸‹é¢çš„Scopeä¸€æ ·ï¼Œä¹Ÿä¸ºå…¶å†…éƒ¨çš„è§„åˆ™æä¾›äº†ä¸€ä¸ªä½œç”¨ç©ºé—´ã€‚\r\n- å¯ä»¥å¾ˆæ˜æ˜¾åœ°æ ‡è¯†å½“å‰UIçš„æ€»ä½“çŠ¶æ€ï¼ˆä¸»é¢˜ï¼‰ã€‚\r\n\r\n### Scope: s-\r\n\r\n`s-`å¯èƒ½ä¸æ˜¯è¿™ä¹ˆå¥½ç†è§£ï¼Œå› ä¸ºCSSä¸­å¹¶æ²¡æœ‰Scopeè¿™ä¸ªæ¦‚å¿µï¼ˆæˆ–è€…è¯´åªæœ‰ä¸€ä¸ªå…¨å±€çš„Scopeï¼‰ã€‚è€Œ`s-`æ­£æ˜¯å¸Œæœ›é€šè¿‡å‘½åçš„æ–¹å¼æ¥å»ºç«‹ä¸€ä¸ªæ–°çš„Scopeã€‚\r\n\r\nä½†æ˜¯è¯·å‹¿æ»¥ç”¨å®ƒï¼Œåªæœ‰åœ¨ä½ ç¡®å®éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„â€œä½œç”¨åŸŸâ€çš„æ—¶å€™å†ä½¿ç”¨å®ƒã€‚ä¾‹å¦‚ä¸€ä¸ªç®€å•åœºæ™¯ï¼šCMSã€‚å¦‚æœä½ æ¥è§¦è¿‡CMSä½ å°±ä¼šçŸ¥é“ï¼Œå®ƒä¸€å®šæœ‰ä¸€ä¸ªç”Ÿæˆæˆ–ç¼–è¾‘å†…å®¹çš„åŠŸèƒ½ã€‚è€Œé€šå¸¸çš„ï¼Œæˆ‘ä»¬ä¼šå°†è¿™éƒ¨åˆ†ç¼–è¾‘çš„å†…å®¹è¾“å‡ºåˆ°é¡µé¢ä¸­ï¼Œå¹¶åœ¨å¤–éƒ¨èµ‹äºˆä¸€ä¸ªæ–°çš„Scopeï¼Œç”¨ä»¥éš”ç¦»è¯¥éƒ¨åˆ†ä¸å¤–éƒ¨æ•´ä¸ªç«™ç‚¹çš„æ ·å¼ã€‚\r\n\r\n```html\r\n<nav class=\"c-nav-primary\">\r\n  ...\r\n</nav>\r\n\r\n<section class=\"s-cms-content\">\r\n  <h1>...</h1>\r\n  <p>...</p>\r\n  <ul>\r\n    ...\r\n  </ul>\r\n  <p>...</p>\r\n</section>\r\n\r\n<ul class=\"c-share-links\">\r\n  ...\r\n</ul>\r\n```\r\n\r\n```css\r\n.s-cms-content {\r\n  font: 16px/1.5 serif; /* [1] */\r\n  h1, h2, h3, h4, h5, h6 {\r\n    font: bold 100%/1.5 sans-serif; /* [2] */\r\n  }\r\n  a {\r\n    text-decoration: underline; /* [3] */\r\n  }\r\n}\r\n```\r\n\r\n`section`éƒ¨åˆ†å°±æ˜¯å±•ç¤ºCMSä¸­çš„contentï¼ˆå†…å®¹ï¼‰ã€‚\r\n\r\n- é¦–å…ˆï¼Œç”¨åˆ°Scopesçš„åœºæ™¯ç¡®å®éå¸¸çš„å°‘ï¼Œå› æ­¤ä½ å‡†å¤‡ä½¿ç”¨æ—¶ä¸€å®šè¦ä»”ç»†è€ƒè™‘\r\n- å®ƒçš„å®ç°æ˜¯è¦ä¾èµ–äºåµŒå¥—æ–¹å¼çš„ï¼ˆSASS/LESSä¸­ï¼‰ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯CSSåä»£é€‰æ‹©å™¨\r\n\r\næ…ç”¨ï¼Œéœ€è¦ä¸‡åˆ†å°å¿ƒã€‚\r\n\r\n## 4. åœ¨SASSä¸­ä½¿ç”¨BEM-constructor\r\n\r\nBEM-constructoræ˜¯åŸºäºSASSçš„ä¸€ä¸ªå·¥å…·ã€‚ä½¿ç”¨BEM-constructorå¯ä»¥å¸®åŠ©è§„èŒƒå¹¶å¿«é€Ÿåœ°åˆ›å»ºç¬¦åˆBEMä¸namespaceè§„èŒƒçš„classã€‚BEM-constructorçš„è¯­æ³•éå¸¸ç®€å•ã€‚\r\n\r\n```shell\r\nnpm install sass-bem-constructor --save-dev\r\n```\r\n\r\né¦–å…ˆåœ¨SASSå¼•å…¥`@import 'bem-constructor';`ï¼Œç„¶åä½¿ç”¨`@include block($name, $type) { ... }`åˆ›å»ºblockï¼Œå…¶ä¸­`$name`æ˜¯blockçš„åå­—ï¼Œ`$type`æ˜¯namespaceçš„ç±»å‹ï¼ˆ`'object'`, `'component'`å’Œ`'utility'`ï¼‰ã€‚ç±»ä¼¼å¾—ï¼Œä½¿ç”¨`element($name...)`å’Œ`modifier($name...)`å¯ä»¥å¿«é€Ÿç”Ÿæˆblockä¸­çš„å…¶ä»–éƒ¨åˆ†ã€‚\r\n\r\nå°†æœ€åˆçš„ä¾‹å­è¿›è¡Œæ”¹å†™\r\n\r\n```css\r\n@import 'sass-bem-constructor/dist/_sass-bem-constructor.scss';\r\n\r\n@include block('list', 'component') {\r\n    margin: 15px;\r\n    padding: 0;\r\n    @include element('item') {\r\n        margin: 10px 0;\r\n        border-left: 3px solid #333;\r\n        font-size: 15px;\r\n        color: #333;\r\n        list-style: none;\r\n        @include modifier('underline') {\r\n            color: #111;\r\n            text-decoration: underline;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nç”Ÿæˆçš„å†…å®¹å¦‚ä¸‹\r\n\r\n```css\r\n.c-list {\r\n  margin: 15px;\r\n  padding: 0;\r\n}\r\n.c-list__item {\r\n  margin: 10px 0;\r\n  border-left: 3px solid #333;\r\n  font-size: 15px;\r\n  color: #333;\r\n  list-style: none;\r\n}\r\n.c-list__item--underline {\r\n  color: #111;\r\n  text-decoration: underline;\r\n}\r\n```\r\n\r\nBEM-constructoræ”¯æŒæˆ‘ä»¬ä¹‹å‰æåˆ°çš„å„ç§å‘½åç©ºé—´ã€‚ä¾‹å¦‚`theme($themes...)`ï¼Œ`scope($name)`ç­‰ç­‰ã€‚è¯­æ³•æ ¼å¼åŸºæœ¬ç±»ä¼¼ã€‚\r\n\r\næ­¤å¤–ï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨namespaceï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨å…³é—­\r\n\r\n```css\r\n$bem-use-namespaces: false; // defaults to true\r\n```\r\n\r\nåŒæ—¶ä¹Ÿæ”¯æŒæ›´æ”¹å‘½åç©ºé—´çš„å‰ç¼€å\r\n\r\n```css\r\n$bem-block-namespaces: (\r\n    'object': 'obj',     // defaults to 'o'\r\n    'component': 'comp', // defaults to 'c'\r\n    'utility': 'helper', // defaults to 'u'\r\n);\r\n```\r\n\r\nå½“ç„¶ï¼Œå¦‚æœä½ ä¸å–œæ¬¢BEMä¸­çš„`__`ï¼Œ`--`çš„è¿æ¥çº¿ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰\r\n\r\n```css\r\n$bem-element-separator: '-'; // Defaults to '__'\r\n$bem-modifier-separator: '-_-_'; // Defaults to '--'\r\n```\r\n\r\n## 5. å†™åœ¨æœ€å\r\n\r\nBEMå’Œnamespaceæ˜¯ä¸€ç§å‘½åè§„èŒƒï¼Œæˆ–è€…è¯´æ˜¯ä¸€ç§ä½¿ç”¨å»ºè®®ã€‚ä»–çš„ç›®çš„æ˜¯å¸®åŠ©æˆ‘ä»¬å†™å‡ºæ›´æ˜“ç»´æŠ¤ä¸åä½œçš„ä»£ç ï¼Œæ›´å¤šçš„æ˜¯åœ¨ä»£ç è§„èŒƒçš„å±‚é¢ä¸Šå¸®åŠ©æˆ‘ä»¬è§£å†³CSSæ¨¡å—åŒ–ä¸­çš„é—®é¢˜ã€‚ç„¶è€Œï¼Œä¹Ÿä¸å¾—ä¸æ‰¿è®¤ï¼Œå®ƒè·ç¦»æˆ‘ä»¬æ¢¦æƒ³ä¸­çš„CSSæ¨¡å—åŒ–è¿˜æœ‰è¿™å¾ˆé•¿çš„è·ç¦»ã€‚ä½†æ˜¯æ— è®ºå¦‚ä½•ï¼Œå…¶ä¸­è•´å«çš„ä¸€äº›ç»„ä»¶åŒ–ä¸CSSç»“æ„ç»„ç»‡æ–¹å¼çš„æƒ³æ³•ä¹Ÿæ˜¯å€¼å¾—æˆ‘ä»¬å»æ€è€ƒçš„ã€‚\r\n\r\n## å‚è€ƒèµ„æ–™\r\n\r\n- [More Transparent UI Code with Namespaces](https://csswizardry.com/2015/03/more-transparent-ui-code-with-namespaces/)\r\n- [BEM I (finally) understand](https://m.alphasights.com/bem-i-finally-understand-b0c74815d5b0)\r\n- [BEMIT: Taking the BEM Naming Convention a Step Further](https://csswizardry.com/2015/08/bemit-taking-the-bem-naming-convention-a-step-further/)\r\n- [Immutable CSS](https://csswizardry.com/2015/03/immutable-css/)\r\n- [bem-constructor](https://github.com/danielguillan/bem-constructor)\r\n- [Battling BEM â€“ 5 common problems and how to avoid them](https://medium.com/fed-or-dead/battling-bem-5-common-problems-and-how-to-avoid-them-5bbd23dee319)\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/13","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/13/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/13/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/13/events","html_url":"https://github.com/alienzhou/blog/issues/13","id":390633497,"node_id":"MDU6SXNzdWUzOTA2MzM0OTc=","number":13,"title":"ä¸€ç¯‡å…¨é¢çš„CSSå¸ƒå±€å­¦ä¹ æŒ‡å— [è¯‘]","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845018,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE4","url":"https://api.github.com/repos/alienzhou/blog/labels/CSS","name":"CSS","color":"7057ff","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T11:21:53Z","updated_at":"2018-12-13T11:22:14Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> æœ¬æ–‡æ¥è‡ªSmashingMagazineä¸Šä¸€ç¯‡éå¸¸ä¸é”™çš„CSSå¸ƒå±€ç»¼è¿°ç±»æ–‡ç« ï¼Œæ±‡æ€»äº†å„ç±»CSSå¸ƒå±€æŠ€æœ¯ï¼Œå¹¶æä¾›äº†è¿™äº›æŠ€æœ¯æ·±åº¦é˜…è¯»çš„é“¾æ¥ã€‚æ•…è€Œç¿»è¯‘è¿‡æ¥å’Œå¤§å®¶åˆ†äº«ï¼ŒåŸæ–‡é“¾æ¥åœ¨æ–‡æœ«ï¼Œæ„Ÿè°¢ä½œè€…Rachel Andrewã€‚\r\n\r\n## å¼•è¨€\r\n\r\næ— è®ºä½ æ˜¯ä¸€ä¸ªæƒ³è¦å­¦ä¹ CSSå¸ƒå±€çš„æ–°æ‰‹ï¼Œè¿˜æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰ç»éªŒä½†æƒ³è¦è¿›ä¸€æ­¥å·©å›ºä¸äº†è§£æœ€æ–°CSSå¸ƒå±€çŸ¥è¯†çš„å‰ç«¯å¼€å‘è€…ï¼Œè¿™ç¯‡æŒ‡å—éƒ½èƒ½å¸®ä½ å…¨é¢äº†è§£å¦‚ä»ŠCSSå¸ƒå±€å‘å±•çš„ç°çŠ¶ã€‚\r\n\r\nåœ¨è¿‡å»çš„è®¸å¤šå¹´ä¸­ï¼Œæ­£å¦‚ç¿»å¤©è¦†åœ°çš„å‰ç«¯å¼€å‘ä¸€èˆ¬ï¼ŒCSSå¸ƒå±€ä¹Ÿäº§ç”Ÿäº†å·¨å¤§çš„å˜åŒ–ã€‚ç°åœ¨æˆ‘ä»¬æœ‰éœ€è¦å¯é€‰çš„CSSå¸ƒå±€æ–¹å¼æ¥å¼€å‘æˆ‘ä»¬çš„ç½‘ç«™ï¼Œè¿™ä¹Ÿå°±è¦æ±‚æˆ‘ä»¬å¯¹è¿™äº›æ–¹å¼ä½œå‡ºé€‰æ‹©ã€‚åœ¨è¿™ç‰‡æ–‡ç« é‡Œï¼Œæˆ‘ä¼šä»‹ç»å„ç§CSSå¸ƒå±€çš„åŸºæœ¬ä½¿ç”¨æ–¹å¼ä»¥åŠä½¿ç”¨çš„ç›®çš„ã€‚\r\n\r\nå¦‚æœä½ è¿˜æ˜¯CSSæ–¹é¢çš„æ–°æ‰‹å¹¶ä¸”æƒ³è¦äº†è§£ä»€ä¹ˆæ˜¯æœ€å¥½çš„å¸ƒå±€æ–¹æ³•ï¼Œè¿™ç¯‡æ–‡ç« æ­£å¼ä½ æ‰€éœ€è¦çš„ï¼›å½“ç„¶ï¼Œå¦‚æœä½ æ˜¯ä¸€ä½æ¯”è¾ƒæœ‰ç»éªŒçš„å¼€å‘è€…ï¼Œæƒ³è¦äº†è§£ä¸€äº›å…³äºCSSå¸ƒå±€çš„æœ€æ–°çŸ¥è¯†ï¼Œè¿™ç¯‡æ–‡ç« ä¹Ÿä¸å®¹é”™è¿‡ã€‚å½“ç„¶ï¼Œæˆ‘ä¸ä¼šå°†å„ç±»æŠ€æœ¯çš„ç»†ææœ«èŠ‚éƒ½æ”¾åˆ°è¿™ç¯‡æ–‡ç« é‡Œï¼ˆå¦åˆ™å¯ä»¥å†™ä¸€æœ¬ä¹¦äº†ï¼‰ï¼Œè€Œæ˜¯å¯¹å„ç±»æŠ€æœ¯åšä¸€ä¸ªåŸºæœ¬çš„æ¦‚è¿°ï¼ŒåŒæ—¶ä¼šç»™å¤§å®¶æä¾›ç›¸å…³é“¾æ¥æ¥è¿›ä¸€æ­¥å­¦ä¹ ã€‚\r\n\r\n---\r\n\r\n## 1. æ­£å¸¸æ–‡æ¡£æµï¼ˆNormal Flowï¼‰\r\n\r\nå¦‚æœä½ æ‰“å¼€ä¸€ä¸ªæ²¡æœ‰ç”¨ä»»ä½•CSSæ¥æ”¹å˜é¡µé¢å¸ƒå±€çš„ç½‘é¡µï¼Œé‚£ä¹ˆç½‘é¡µå…ƒç´ å°±ä¼šæ’åˆ—åœ¨ä¸€ä¸ªæ­£å¸¸æµï¼ˆnormal flowï¼‰ä¹‹ä¸­ã€‚åœ¨æ­£å¸¸æµä¸­ï¼Œå…ƒç´ ç›’å­ï¼ˆboxesï¼‰ä¼šåŸºäºæ–‡æ¡£çš„å†™ä½œæ¨¡å¼ï¼ˆwriting modeï¼‰ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æ’åˆ—ã€‚è¿™å°±æ„å‘³ç€ï¼Œå¦‚æœä½ çš„å†™ä½œæ¨¡å¼æ˜¯æ°´å¹³æ–¹å‘çš„ï¼ˆå¥å­æ˜¯ä»å·¦åˆ°å³æˆ–ä»å³åˆ°å·¦ä¹¦å†™ï¼‰ï¼Œæ­£å¸¸æµä¼šå‚ç›´åœ°ä¸€ä¸ªæ¥ä¸€ä¸ªæ’åˆ—é¡µé¢çš„å—çº§å…ƒç´ ã€‚\r\n\r\nå½“ç„¶ï¼Œå¦‚æœä½ æ˜¯åœ¨ä¸€ä¸ªå‚ç›´æ–¹å‘çš„å†™ä½œæ¨¡å¼ä¸‹ï¼Œå¥å­æ˜¯å‚ç›´æ–¹å‘ä¹¦å†™çš„ï¼Œæ‰€ä»¥å—çº§å…ƒç´ ä¼šæ°´å¹³æ–¹æ³•æ’åˆ—ã€‚\r\n\r\n![Block and Inline Directions change with Writing Mode](https://user-gold-cdn.xitu.io/2018/7/3/1645fd10965531f9?w=918&h=356&f=png&s=7810)\r\n\r\næ­£å¸¸æµæ˜¯ä¸€ç§æœ€åŸºç¡€çš„å¸ƒå±€ï¼šå½“ä½ ä¸ºæ–‡æ¡£åº”ç”¨äº†CSSã€åˆ›å»ºäº†æŸäº›CSSå¸ƒå±€ï¼Œä½ å…¶å®æ˜¯è®©è¿™äº›å—åšäº†ä¸€ä¸ªæ­£å¸¸æ–‡æ¡£æµä¹‹å¤–çš„â€œäº‹â€ã€‚\r\n\r\n### 1.1. é€šè¿‡é¡µé¢ç»“æ„æ¥å‘æŒ¥æ­£å¸¸æ–‡æ¡£æµçš„ä¼˜åŠ¿\r\n\r\né€šè¿‡ç¡®ä¿ä½ ä¹¦å†™çš„é¡µé¢å…·æœ‰è‰¯å¥½çš„é¡µé¢ç»“æ„ï¼ˆwell-structured mannerï¼‰ï¼Œä½ å¯ä»¥æœ€å¤§ç¨‹åº¦åˆ©ç”¨æ­£å¸¸æµæ‰€å¸¦æ¥çš„ä¼˜åŠ¿ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæµè§ˆå™¨ä¸­æ²¡æœ‰æ­£å¸¸æµï¼Œé‚£ä¹ˆä½ åˆ›å»ºçš„å…ƒç´ éƒ½ä¼šå †ç§¯åœ¨æµè§ˆå™¨çš„å³ä¸Šè§’ã€‚è¿™å°±æ„å‘³ç€ä½ å¿…é¡»æŒ‡å®šæ‰€æœ‰çš„å…ƒç´ çš„å¸ƒå±€æ–¹å¼ã€‚\r\n\r\næœ‰äº†æ­£å¸¸æµï¼Œå³ä½¿CSSåŠ è½½å¤±è´¥äº†ï¼Œç”¨æˆ·ä»ç„¶èƒ½é˜…è¯»ä½ çš„é¡µé¢å†…å®¹ï¼›åŒæ—¶ï¼Œä¸€äº›ä¸ä½¿ç”¨CSSçš„å·¥å…·ï¼ˆä¾‹å¦‚ä¸€äº›é˜…è¯»å™¨ï¼‰ä¼šæŒ‰ç…§å…ƒç´ åœ¨æ–‡æ¡£ä¸­çš„ä½ç½®æ¥è¯»å–é¡µé¢å†…å®¹ã€‚ä» å¯ç”¨æ€§ï¼ˆaccessibilityï¼‰ è§’åº¦æ¥çœ‹ï¼Œè¿™æ— ç–‘æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ï¼ŒåŒæ—¶ä¹Ÿè®©å¼€å‘è€…è½»æ¾äº†ä¸€äº›ã€‚å¦‚æœä½ çš„å†…å®¹é¡ºåºå’Œç”¨æˆ·é¢„æœŸçš„é˜…è¯»é¡ºåºä¸€è‡´ï¼Œä½ å°±ä¸éœ€è¦ä¸ºäº†å°†å…ƒç´ è°ƒæ•´åˆ°æ­£ç¡®çš„ä½ç½®è€Œè¿›è¡Œå¤§é‡çš„å¸ƒå±€è°ƒæ•´ã€‚å½“ä½ ç»§ç»­è¯»ä¸‹å»ä¼šå‘ç°ï¼Œä½¿ç”¨æ–°çš„å¸ƒå±€æ–¹å¼æ˜¯å¦‚ä½•è®©é¡µé¢å¸ƒå±€äº‹åŠåŠŸå€çš„ã€‚\r\n\r\nå› æ­¤ï¼Œåœ¨æ€è€ƒå¦‚ä½•å¸ƒå±€ä¹‹å‰ï¼Œä½ éœ€è¦è®¤çœŸæ€è€ƒä½ çš„æ–‡æ¡£ç»“æ„ï¼Œä»¥åŠä½ å¸Œæœ›ç”¨æˆ·ä»¥ä½•ç§é¡ºåºæ¥é˜…è¯»æ–‡æ¡£ä¸­çš„å†…å®¹ã€‚\r\n\r\n### 1.2. è„±ç¦»æ­£å¸¸æ–‡æ¡£æµ\r\n\r\nä¸€æ—¦ä½ æœ‰äº†ä¸€ä¸ªç»“æ„è‰¯å¥½çš„é¡µé¢ï¼Œä½ å°±éœ€è¦å»å†³å®šå¦‚ä½•åˆ©ç”¨å®ƒå¹¶å°†å®ƒå˜ä¸ºæˆ‘ä»¬éœ€è¦çš„å¸ƒå±€ç»“æ„ã€‚è¿™ä¼šæ¶‰åŠåˆ° è„±ç¦»æ­£å¸¸æ–‡æ¡£æµï¼ˆmoving away from normal flowï¼‰ï¼Œå³æœ¬æ–‡åç»­çš„éƒ¨åˆ†å†…å®¹ã€‚æˆ‘ä»¬æœ‰è®¸å¤šå¸ƒå±€â€œåˆ©å™¨â€å¯ä»¥ä½¿ç”¨ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå°±æ˜¯`float`ï¼Œå®ƒæ˜¯ä¸€ä¸ªæè¿°ä»€ä¹ˆæ˜¯è„±ç¦»æ­£å¸¸æ–‡æ¡£æµçš„éå¸¸å¥½çš„ä¾‹å­ã€‚\r\n\r\n---\r\n\r\n## 2. æµ®åŠ¨ï¼ˆFloatï¼‰\r\n\r\næµ®åŠ¨è¢«ç”¨æ¥å°†ç›’å­ï¼ˆboxï¼‰ç½®äºå·¦ä¾§æˆ–å³ä¾§ï¼ŒåŒæ—¶è®©å†…å®¹ç¯ç»•å…¶å±•ç¤ºã€‚\r\n\r\nè¦è®©ä¸€ä¸ªå…ƒç´ è¿›è¡Œæµ®åŠ¨ï¼Œéœ€è¦ä¸ºè¯¥å…ƒç´ è®¾ç½®ä¸€ä¸ªå€¼ä¸º`left`æˆ–`right`çš„`float`å±æ€§ã€‚é»˜è®¤å€¼ä¸º`none`ã€‚\r\n\r\n```css\r\n.item {\r\n    float: left\r\n}\r\n```\r\n\r\nå€¼å¾—å¼ºè°ƒçš„æ˜¯ï¼Œå½“ä½ ä½¿æŸä¸ªå…ƒç´ æµ®åŠ¨å¹¶è®©æ–‡å­—ç¯ç»•å®ƒæ—¶ï¼Œå†…å®¹çš„line boxè¢«æˆªæ–­äº†ã€‚å¦‚æœä½ è®©ä¸€ä¸ªå…ƒç´ æµ®åŠ¨ï¼ŒåŒæ—¶ä¸ºç´§è·Ÿç€çš„åŒ…å«æ–‡æœ¬çš„å…ƒç´ è®¾ç½®ä¸€ä¸ªèƒŒæ™¯è‰²ï¼Œä½ ä¼šå‘ç°èƒŒæ™¯è‰²ä¼šå‡ºç°åœ¨æµ®åŠ¨å…ƒç´ ä¸‹æ–¹ã€‚\r\n\r\n![The background color on the content runs under the float](https://user-gold-cdn.xitu.io/2018/7/3/1645fd10966db934?w=1196&h=682&f=png&s=129387)\r\n\r\nå¦‚æœä½ æƒ³è¦åœ¨æµ®åŠ¨å…ƒç´ å’Œç¯ç»•çš„æ–‡æœ¬ä¹‹é—´åˆ›å»ºè¾¹è·ï¼Œä½ éœ€è¦ç»™æµ®åŠ¨å…ƒç´ è®¾ç½®å¤–è¾¹è·ã€‚åœ¨æ–‡æœ¬å…ƒç´ ä¸Šè®¾ç½®å¤–è¾¹è·åªä¼šè®©å…¶ç›¸å¯¹äºå®¹å™¨ç¼©è¿›ã€‚ä¾‹å¦‚åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½ å°±éœ€è¦ä¸ºå·¦ä¾§æµ®åŠ¨çš„å›¾ç‰‡è®¾ç½®å³è¾¹è·å’Œä¸‹è¾¹è·ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/3/1645fd10966e8ee5?w=1134&h=628&f=png&s=281065)\r\n\r\n```html\r\n<div class=\"container\">\r\n  <div class=\"item\"></div>\r\n  <p>Pea horseradish azuki bean lettuce avocado asparagus okra. Kohlrabi radish okra azuki bean corn fava bean mustard tigernut jÃ­cama green bean celtuce. </p>\r\n  <p>Grape silver beet  collard greens avocado quandong fennel gumbo black-eyed pea watercress potato tigernut corn groundnut. Chickweed okra pea winter purslane coriander yarrow sweet pepper radish garlic brussels sprout groundnut summer purslane earthnut pea tomato spring onion azuki bean gourd. Gumbo kakadu plum komatsuna black-eyed pea green bean zucchini gourd winter purslane silver beet rock melon radish asparagus spinach.</p>\r\n</div>\r\n```\r\n\r\n```CSS\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n}\r\n\r\n.item {\r\n  width: 100px;\r\n  height: 100px;\r\n  float: left;\r\n  margin: 0 20px 20px 0;\r\n  background-color: rgba(111,41,97,.3);\r\n}\r\n```\r\n\r\n### 2.1. æ¸…é™¤æµ®åŠ¨\r\n\r\nä¸€æ—¦ä½ å¯¹ä¸€ä¸ªå…ƒç´ åº”ç”¨äº†æµ®åŠ¨ï¼Œæ‰€æœ‰æ¥ä¸‹æ¥çš„å…ƒç´ éƒ½ä¼šç¯ç»•å®ƒç›´åˆ°å†…å®¹å¤„äºå®ƒä¸‹æ–¹ä¸”å¼€å§‹åº”ç”¨æ­£å¸¸æ–‡æ¡£æµã€‚å¦‚æœä½ æƒ³è¦é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥æ‰‹åŠ¨å»æ¸…é™¤æµ®åŠ¨ã€‚\r\n\r\nå½“ä½ ä¸æƒ³è¦æŸä¸ªå…ƒç´ å—åˆ°å…¶ä¹‹å‰çš„æµ®åŠ¨å…ƒç´ å½±å“æ—¶ï¼Œä¸ºå…¶æ·»åŠ `clear`å±æ€§å³å¯ã€‚ä½¿ç”¨`left`å€¼å¯ä»¥æ¸…é™¤å·¦æµ®åŠ¨æ•ˆæœï¼Œ`right`å€¼ä¸ºå³æµ®åŠ¨ï¼Œ`both`åˆ™ä¼šæ¸…é™¤å·¦å³æµ®åŠ¨ã€‚\r\n\r\n```css\r\n.clear {\r\n    clear: both;\r\n}\r\n```\r\n\r\nä½†æ˜¯ï¼Œå½“ä½ å‘ç°åœ¨å®¹å™¨å†…æœ‰äº†ä¸€ä¸ªæµ®åŠ¨å…ƒç´ ï¼ŒåŒæ—¶å®¹å™¨æ–‡æœ¬å†…å®¹è¿‡çŸ­æ—¶å°±ä¼šå‡ºç°é—®é¢˜ã€‚æ–‡æœ¬ç›’å­ä¼šè¢«ç»˜åˆ¶åœ¨æµ®åŠ¨å…ƒç´ ä¸‹ï¼Œç„¶åæ¥ä¸‹æ¥çš„éƒ¨åˆ†ä¼šä»¥æ­£å¸¸æµç»˜åˆ¶åœ¨å…¶åã€‚\r\n\r\n![The box around the text does not clear the float](https://user-gold-cdn.xitu.io/2018/7/3/1645fd10967f2208?w=1174&h=336&f=png&s=19626)\r\n\r\n\r\nä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå®¹å™¨ä¸­æŸä¸ªå…ƒç´ åº”ç”¨`clear`å±æ€§ã€‚æˆ‘ä»¬å¯ä»¥åœ¨å®¹å™¨æœ€åæ·»åŠ ä¸€ä¸ªç©ºå…ƒç´ å¹¶è®¾ç½®`clear`å±æ€§ã€‚ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½æ— æ³•ä½¿ç”¨è¿™ç§æ–¹å¼ï¼ˆä¾‹å¦‚ä¸€äº›CMSç³»ç»Ÿç”Ÿæˆçš„é¡µé¢ï¼‰ã€‚å› æ­¤ï¼Œæœ€å¸¸è§çš„æ¸…é™¤æµ®åŠ¨çš„hackæ–¹æ¡ˆæ˜¯ï¼šåœ¨å®¹å™¨å†…æ·»åŠ ä¸€ä¸ªCSSä¼ªå…ƒç´ ï¼Œå¹¶å°†å…¶`clear`å±æ€§è®¾ç½®ä¸ºbothã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <div class=\"item\"></div>\r\n  <p>Pea horseradish azuki bean lettuce avocado asparagus okra.</p>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n}\r\n\r\n.item {\r\n  width: 100px;\r\n  height: 100px;\r\n  float: left;\r\n  margin: 0 20px 20px 0;\r\n  background-color: rgba(111,41,97,.3);\r\n}\r\n\r\n.container::after {\r\n  content: \"\";\r\n  display: table;\r\n  clear: both;\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/3/1645fd10968de015?w=1128&h=358&f=png&s=41211)\r\n\r\n> example: [Smashing Guide to Layout: clearfix](https://codepen.io/rachelandrew/pen/jxJjje) on Codepen\r\n\r\n### 2.2. å—çº§æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼ˆBlock Formatting Contextï¼‰\r\n\r\næ¸…é™¤æµ®åŠ¨çš„å¦ä¸€ä¸ªæ–¹æ³•æ˜¯åœ¨å®¹å™¨å†…åˆ›å»ºBFCã€‚ä¸€ä¸ªBFCå…ƒç´ å®Œå…¨åŒ…è£¹ä½äº†å®ƒå†…éƒ¨çš„æ‰€æœ‰å…ƒç´ ï¼ŒåŒ…æ‹¬å†…éƒ¨çš„æµ®åŠ¨å…ƒç´ ï¼Œä¿è¯æµ®åŠ¨å…ƒç´ ä¸ä¼šè¶…å‡ºå…¶åº•éƒ¨ã€‚åˆ›å»ºBFCçš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„ä¸€ç§æ¸…é™¤æµ®åŠ¨çš„æ–¹å¼æ˜¯ä¸ºå…ƒç´ è®¾ç½®é™¤visibleï¼ˆé»˜è®¤ï¼‰ä¹‹å¤–çš„`overflow`å±æ€§å€¼ã€‚\r\n\r\n```css\r\n.container {\r\n    overflow: auto;\r\n}\r\n```\r\n\r\nåƒä¸Šé¢è¿™æ ·ä½¿ç”¨`overflow`ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æœ‰æ•ˆçš„ã€‚ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™å¯èƒ½ä¼šå¸¦æ¥ä¸€äº›é˜´å½±çš„æˆªæ–­æˆ–æ˜¯éé¢„æœŸçš„æ»šåŠ¨æ¡ã€‚åŒæ—¶å®ƒä¹Ÿä½¿ä½ çš„CSSå˜å¾—ä¸é‚£ä¹ˆç›´è§‚ï¼šè®¾ç½®`overflow`æ˜¯å› ä¸ºä½ æƒ³è¦å±•ç¤ºæ»šåŠ¨æ¡è¿˜æ˜¯ä»…ä»…ä¸ºäº†è·å–æ¸…é™¤æµ®åŠ¨çš„èƒ½åŠ›å‘¢ï¼Ÿ\r\n\r\nä¸ºäº†ä½¿æ¸…é™¤æµ®åŠ¨çš„æ„å›¾æ›´åŠ ç›´è§‚ï¼Œå¹¶ä¸”é¿å…BFCçš„è´Ÿé¢å½±å“ï¼Œä½ å¯ä»¥ä½¿ç”¨`flow-root`ä½œä¸º`display`å±æ€§çš„å€¼ã€‚`display: flow-root`åšçš„å”¯ä¸€çš„ä¸€ä»¶äº‹å°±æ˜¯å»åˆ›å»ºä¸€ä¸ªBFCï¼Œå› æ­¤å¯ä»¥é¿å…å…¶ä»–åˆ›å»ºBFCæ–¹æ³•å¸¦æ¥çš„é—®é¢˜ã€‚\r\n\r\n```css\r\n.container {\r\n    display: flow-root;\r\n}\r\n```\r\n\r\n### 2.3. æµ®åŠ¨çš„ä¸€äº›é—ç•™ç”¨æ³•\r\n\r\nåœ¨æ–°çš„å¸ƒå±€æ–¹å¼å‡ºç°ä»¥å‰ï¼Œ`float`ç»å¸¸ä¼šè¢«ç”¨æ¥åˆ›å»ºå¤šæ å¸ƒå±€ã€‚æˆ‘ä»¬ä¼šç»™ä¸€ç³»åˆ—å…ƒç´ è®¾ç½®å®½åº¦å¹¶ä¸”å°†å®ƒä»¬ä¸€ä¸ªæ¥ä¸€ä¸ªè¿›è¡Œæµ®åŠ¨ã€‚é€šè¿‡ä¸ºæµ®åŠ¨å…ƒç´ è®¾ç½®ä¸€äº›ç²¾ç»†çš„ç™¾åˆ†æ¯”å¤§å°å¯ä»¥åˆ›å»ºç±»ä¼¼ç½‘æ ¼çš„æ•ˆæœã€‚\r\n\r\næˆ‘ä¸å»ºè®®åœ¨å½“ä¸‹ä»ç„¶è¿‡åº¦åœ°ä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œåœ¨ç°æœ‰çš„ç½‘ç«™ä¸­ï¼Œè¿™ç§æ–¹å¼ä»ç„¶ä¼šå­˜åœ¨è®¸å¤šå¹´ã€‚å› æ­¤ï¼Œå½“ä½ ç¢°åˆ°ä¸€ä¸ªé¡µé¢é‡Œé¢åˆ°å¤„æ˜¯`float`çš„åº”ç”¨ï¼Œå¯ä»¥ç¡®å®šå®ƒå°±æ˜¯ç”¨çš„è¿™ç§æŠ€æœ¯ã€‚\r\n\r\n### 2.4. å…³äºæµ®åŠ¨ä¸æ¸…é™¤æµ®åŠ¨çš„å…¶ä»–é˜…è¯»èµ„æ–™\r\n\r\n- â€œ[The Clearfix: Force an Element To Self-Clear its Children](https://css-tricks.com/snippets/css/clear-fix/),â€ Chris Coyier, CSS-Tricks\r\n- â€œ[float](https://developer.mozilla.org/en-US/docs/Web/CSS/float),â€ CSS: Cascading Style Sheets, MDN web docs\r\n- â€œ[clear](https://developer.mozilla.org/en-US/docs/Web/CSS/clear),â€ CSS: Cascading Style Sheets, MDN web docs\r\n- â€œ[Understanding CSS Layout And The Block Formatting Context](https://www.smashingmagazine.com/2017/12/understanding-css-layout-block-formatting-context/),â€ Rachel Andrew, Smashing Magazine\r\n\r\n---\r\n\r\n## 3. å®šä½ï¼ˆPositioningï¼‰\r\n\r\næƒ³è¦æŠŠä¸€ä¸ªå…ƒç´ ä»æ­£å¸¸æµä¸­ç§»é™¤ï¼Œæˆ–è€…æ”¹å˜å…¶åœ¨æ­£å¸¸æ–‡æ¡£æµä¸­çš„ä½ç½®ï¼Œå¯ä»¥ä½¿ç”¨CSSä¸­çš„`position`å±æ€§ã€‚å½“å¤„äºæ­£å¸¸æ–‡æ¡£æµæ—¶ï¼Œå…ƒç´ çš„`position`å±æ€§ä¸º`static`ã€‚åœ¨å—çº§ç»´åº¦ä¸Šå…ƒç´ ä¼šä¸€ä¸ªæ¥ä¸€ä¸ªæ’åˆ—ä¸‹å»ï¼Œå½“ä½ æ»šåŠ¨é¡µé¢æ—¶å…ƒç´ ä¹Ÿä¼šéšç€æ»šåŠ¨ã€‚\r\n\r\nå½“ä½ æ”¹å˜å…ƒç´ çš„positionå±æ€§æ—¶ï¼Œé€šå¸¸æƒ…å†µä¸‹ä½ ä¹Ÿä¼šè®¾ç½®ä¸€äº›åç§»é‡æ¥ä½¿å…ƒç´ ç›¸å¯¹äºå‚ç…§ç‚¹è¿›è¡Œä¸€å®šçš„ç§»åŠ¨ã€‚ä¸åŒçš„positionå€¼ä¼šäº§ç”Ÿä¸åŒçš„å‚ç…§ç‚¹ã€‚\r\n\r\n### 3.1. ç›¸å¯¹å®šä½ï¼ˆrelative postioningï¼‰\r\n\r\nå¦‚æœä¸€ä¸ªå…ƒç´ å…·æœ‰å±æ€§`position: relative`ï¼Œé‚£ä¹ˆå®ƒåç§»çš„å‚ç…§ä½æ˜¯å…¶åŸå…ˆåœ¨æ­£å¸¸æ–‡æ¡£æµä¸­çš„ä½ç½®ã€‚ä½ å¯ä»¥ä½¿ç”¨topã€leftã€bottomå’Œrightå±æ€§æ¥ç›¸å¯¹å…¶æ­£å¸¸æµä½ç½®è¿›è¡Œç§»åŠ¨ã€‚\r\n\r\n```css\r\n.item {\r\n    position: relative;\r\n    bottom: 50px;\r\n}\r\n```\r\n\r\næ³¨æ„ï¼Œé¡µé¢ä¸Šçš„å…¶ä»–å…ƒç´ å¹¶ä¸ä¼šå› è¯¥å…ƒç´ çš„ä½ç½®å˜åŒ–è€Œå—åˆ°å½±å“ã€‚è¯¥å…ƒç´ åœ¨æ­£å¸¸æµä¸­çš„ä½ç½®ä¼šè¢«ä¿ç•™ï¼Œå› æ­¤ä½ éœ€è¦è‡ªå·±å»å¤„ç†ä¸€äº›å…ƒç´ å†…å®¹è¦†ç›–çš„æƒ…å†µã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  \r\n  <p>Pea horseradish azuki bean lettuce avocado asparagus okra. Kohlrabi radish okra azuki bean corn fava bean mustard tigernut jÃ­cama green bean celtuce. </p>\r\n  \r\n  <div class=\"item\"></div>\r\n  <p>Grape silver beet  collard greens avocado quandong fennel gumbo black-eyed pea watercress potato tigernut corn groundnut. Chickweed okra pea winter purslane coriander yarrow sweet pepper radish garlic brussels sprout groundnut summer purslane earthnut pea tomato spring onion azuki bean gourd. Gumbo kakadu plum komatsuna black-eyed pea green bean zucchini gourd winter purslane silver beet rock melon radish asparagus spinach.</p>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n}\r\n\r\n.item {\r\n  width: 100px;\r\n  height: 100px;\r\n  background-color: rgba(111,41,97,.3);\r\n  position: relative;\r\n  bottom: 50px;\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/3/1645fd1096a5574e?w=1118&h=740&f=png&s=267164)\r\n\r\n> example: [Smashing Guide to Layout: position: relative](https://codepen.io/rachelandrew/pen/MGxNwd) on Codepen\r\n\r\n### 3.2. ç»å¯¹å®šä½ï¼ˆabsolute postioningï¼‰\r\n\r\nç»™ä¸€ä¸ªå…ƒç´ è®¾ç½®`position: absolute`å±æ€§å¯ä»¥å°†å…¶å®Œå…¨ä»æ­£å¸¸æµä¸­ç§»é™¤ã€‚å…¶åŸæœ¬å æ®çš„ç©ºé—´ä¹Ÿä¼šè¢«ç§»é™¤ã€‚è¯¥å…ƒç´ ä¼šå®šä½ä¼šç›¸å¯¹äºè§†å£å®¹å™¨ï¼Œé™¤éå…¶æŸä¸ªç¥–å…ˆå…ƒç´ ä¹Ÿæ˜¯å®šä½å…ƒç´ ï¼ˆpositionå€¼ä¸ä¸ºstaticï¼‰ã€‚\r\n\r\nå› æ­¤ï¼Œå½“ä½ ä¸ºæŸä¸ªå…ƒç´ è®¾ç½®`position: absolute`æ—¶ï¼Œé¦–å…ˆå‘ç”Ÿçš„å˜åŒ–æ˜¯è¯¥å…ƒç´ ä¼šå®šä½åœ¨è§†å£çš„å·¦ä¸Šè§’ã€‚ä½ å¯ä»¥é€šè¿‡è®¾ç½®`top`ã€`left`ã€`bottom`å’Œ`right`åç§»é‡å±æ€§æ¥å°†å…ƒç´ ç§»åŠ¨åˆ°ä½ æƒ³è¦çš„ä½ç½®ã€‚\r\n\r\n```css\r\n.item {\r\n    position: absolute;\r\n    top: 20px;\r\n    right: 20px;\r\n}\r\n```\r\n\r\né€šå¸¸æƒ…å†µä¸‹ä½ å¹¶ä¸å¸Œæœ›å…ƒç´ ç›¸å¯¹äºè§†å£è¿›è¡Œå®šä½ï¼Œè€Œæ˜¯ç›¸å¯¹äºå®¹å™¨å…ƒç´ ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ éœ€è¦ä¸ºå®¹å™¨å…ƒç´ è®¾ç½®ä¸€ä¸ªé™¤äº†é»˜è®¤`static`ä¹‹å¤–çš„å€¼ã€‚\r\n\r\nç”±äºç»™ä¸€ä¸ªå…ƒç´ è®¾ç½®`position: relative`å¹¶ä¸ä¼šå°†å…¶ä»æ­£å¸¸æµä¸­ç§»é™¤ï¼Œæ‰€ä»¥é€šå¸¸è¿™æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ç»™ä½ æƒ³è¦ç›¸å¯¹çš„å®¹å™¨å…ƒç´ è®¾ç½®`position\r\n: relative`ï¼Œå°±å¯ä»¥è®©ç»å¯¹å®šä½çš„å…ƒç´ ç›¸å¯¹å…¶è¿›è¡Œåç§»ã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  \r\n  <p>Pea horseradish azuki bean lettuce avocado asparagus okra. Kohlrabi radish okra azuki bean corn fava bean mustard tigernut jÃ­cama green bean celtuce. </p>\r\n  \r\n  <div class=\"item\"></div>\r\n  <p>Grape silver beet  collard greens avocado quandong fennel gumbo black-eyed pea watercress potato tigernut corn groundnut. Chickweed okra pea winter purslane coriander yarrow sweet pepper radish garlic brussels sprout groundnut summer purslane earthnut pea tomato spring onion azuki bean gourd. Gumbo kakadu plum komatsuna black-eyed pea green bean zucchini gourd winter purslane silver beet rock melon radish asparagus spinach.</p>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  position: relative;\r\n}\r\n\r\n.item {\r\n  width: 100px;\r\n  height: 100px;\r\n  background-color: rgba(111,41,97,.3);\r\n  position: absolute;\r\n  top: 20px;\r\n  left: 20px;\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/3/1645fd10c4022eb6?w=1124&h=546&f=png&s=273461)\r\n\r\n> example: [Smashing Guide to Layout: position: absolute](https://codepen.io/rachelandrew/pen/zjbgvx) on Codepen\r\n\r\n### 3.3. å›ºå®šå®šä½ï¼ˆfixed positioningï¼‰\r\n\r\nå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ`position: fixed`çš„å…ƒç´ ä¼šç›¸å¯¹äºè§†å£å®šä½ï¼Œå¹¶ä¸”ä¼šä»æ­£å¸¸æ–‡æ¡£æµä¸­è¢«ç§»é™¤ï¼Œä¸ä¼šä¿ç•™å®ƒæ‰€å æ®çš„ç©ºé—´ã€‚å½“é¡µé¢æ»šåŠ¨æ—¶ï¼Œå›ºå®šçš„å…ƒç´ ä¼šç•™åœ¨ç›¸å¯¹äºè§†å£çš„ä½ç½®ï¼Œè€Œå…¶ä»–æ­£å¸¸æµä¸­çš„å†…å®¹åˆ™å’Œé€šå¸¸ä¸€æ ·æ»šåŠ¨ã€‚\r\n\r\n```css\r\n.item {\r\n    position: fixed;\r\n    top: 20px;\r\n    left: 100px;\r\n}\r\n```\r\n\r\nå½“ä½ æƒ³è¦ä¸€ä¸ªå›ºå®šå¯¼èˆªæ ä¸€ç›´åœç•™åœ¨å±å¹•ä¸Šæ—¶è¿™ä¼šéå¸¸æœ‰æ•ˆã€‚å’Œå…¶ä»–çš„positionå€¼ä¸€æ ·ï¼Œè¿™ä¹Ÿå¯èƒ½ä¼šé€ æˆä¸€äº›å…ƒç´ è¢«é®æŒ¡ï¼Œéœ€è¦å°å¿ƒä¿è¯é¡µé¢å†…å®¹çš„å¯è¯»è€Œä¸ä¼šè¢«å›ºå®šå…ƒç´ é®æŒ¡ã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  \r\n  <p>Pea horseradish azuki bean lettuce avocado asparagus okra. Kohlrabi radish okra azuki bean corn fava bean mustard tigernut jÃ­cama green bean celtuce. </p>\r\n  \r\n  <div class=\"item\"></div>\r\n  <p>Grape silver beet  collard greens avocado quandong fennel gumbo black-eyed pea watercress potato tigernut corn groundnut. Chickweed okra pea winter purslane coriander yarrow sweet pepper radish garlic brussels sprout groundnut summer purslane earthnut pea tomato spring onion azuki bean gourd. Gumbo kakadu plum komatsuna black-eyed pea green bean zucchini gourd winter purslane silver beet rock melon radish asparagus spinach.</p>\r\n  \r\n   <p>Grape silver beet  collard greens avocado quandong fennel gumbo black-eyed pea watercress potato tigernut corn groundnut. Chickweed okra pea winter purslane coriander yarrow sweet pepper radish garlic brussels sprout groundnut summer purslane earthnut pea tomato spring onion azuki bean gourd. Gumbo kakadu plum komatsuna black-eyed pea green bean zucchini gourd winter purslane silver beet rock melon radish asparagus spinach.</p>\r\n  \r\n   <p>Grape silver beet  collard greens avocado quandong fennel gumbo black-eyed pea watercress potato tigernut corn groundnut. Chickweed okra pea winter purslane coriander yarrow sweet pepper radish garlic brussels sprout groundnut summer purslane earthnut pea tomato spring onion azuki bean gourd. Gumbo kakadu plum komatsuna black-eyed pea green bean zucchini gourd winter purslane silver beet rock melon radish asparagus spinach.</p>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  position: relative;\r\n}\r\n\r\n.item {\r\n  width: 100px;\r\n  height: 100px;\r\n  background-color: rgba(111,41,97,.3);\r\n  position: fixed;\r\n  top: 20px;\r\n  left: 20px;\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/3/1645fd10c42778cd?w=1126&h=768&f=png&s=461323)\r\n\r\n> example: [Smashing Guide to Layout: position: fixed](https://codepen.io/rachelandrew/pen/xjBvLE) on Codepen\r\n\r\n\r\nä¸ºäº†ä½¿ä¸€ä¸ªå›ºå®šå®šä½çš„å…ƒç´ ä¸ç›¸å¯¹äºè§†å£è¿›è¡Œå®šä½ï¼Œä½ éœ€è¦ä¸ºå®¹å™¨å…ƒç´ è®¾ç½®`transform`ã€`perspective`ã€`filter`ä¸‰ä¸ªå±æ€§ä¹‹ä¸€ï¼ˆä¸ä¸ºé»˜è®¤å€¼noneï¼‰ã€‚è¿™æ ·å›ºå®šçš„å…ƒç´ å°±ä¼šç›¸å¯¹äºè¯¥å—çº§å…ƒç´ åç§»ï¼Œè€Œéè§†å£ã€‚\r\n\r\n### 3.4. STICKY å®šä½\r\n\r\nè®¾ç½®`position: sticky`ä¼šè®©å…ƒç´ åœ¨é¡µé¢æ»šåŠ¨æ—¶å¦‚åŒåœ¨æ­£å¸¸æµä¸­ï¼Œä½†å½“å…¶æ»šåŠ¨åˆ°ç›¸å¯¹äºè§†å£çš„æŸä¸ªç‰¹å®šä½ç½®æ—¶å°±ä¼šå›ºå®šåœ¨å±å¹•ä¸Šï¼Œå¦‚åŒfixedä¸€èˆ¬ã€‚è¿™ä¸ªå±æ€§å€¼æ˜¯ä¸€ä¸ªè¾ƒæ–°çš„CSSå±æ€§ï¼Œåœ¨æµè§ˆå™¨å…¼å®¹æ€§ä¸Šä¼šå·®ä¸€äº›ï¼Œä½†åœ¨ä¸å…¼å®¹çš„æµè§ˆå™¨ä¸­ä¼šè¢«å¿½ç•¥å¹¶ä¼šé€€åˆ°æ­£å¸¸çš„æ»šåŠ¨æƒ…å†µã€‚\r\n\r\n```css\r\n.item {\r\n    position: sticky;\r\n    top: 0;\r\n}\r\n```\r\n\r\nä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªéå¸¸æµè¡Œå¯¼èˆªæ æ•ˆæœï¼šå¯¼èˆªæ ä¼šéšç€é¡µé¢æ»šåŠ¨ï¼Œè€Œå½“å¯¼èˆªæ æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨æ—¶åˆ™ä¼šå›ºå®šåœ¨é¡¶éƒ¨ä½ç½®ã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  \r\n  <p>Pea horseradish azuki bean lettuce avocado asparagus okra. Kohlrabi radish okra azuki bean corn fava bean mustard tigernut jÃ­cama green bean celtuce. </p>\r\n  \r\n  <div class=\"item\"></div>\r\n  <p>Grape silver beet  collard greens avocado quandong fennel gumbo black-eyed pea watercress potato tigernut corn groundnut. Chickweed okra pea winter purslane coriander yarrow sweet pepper radish garlic brussels sprout groundnut summer purslane earthnut pea tomato spring onion azuki bean gourd. Gumbo kakadu plum komatsuna black-eyed pea green bean zucchini gourd winter purslane silver beet rock melon radish asparagus spinach.</p>\r\n  \r\n   <p>Grape silver beet  collard greens avocado quandong fennel gumbo black-eyed pea watercress potato tigernut corn groundnut. Chickweed okra pea winter purslane coriander yarrow sweet pepper radish garlic brussels sprout groundnut summer purslane earthnut pea tomato spring onion azuki bean gourd. Gumbo kakadu plum komatsuna black-eyed pea green bean zucchini gourd winter purslane silver beet rock melon radish asparagus spinach.</p>\r\n  \r\n   <p>Grape silver beet  collard greens avocado quandong fennel gumbo black-eyed pea watercress potato tigernut corn groundnut. Chickweed okra pea winter purslane coriander yarrow sweet pepper radish garlic brussels sprout groundnut summer purslane earthnut pea tomato spring onion azuki bean gourd. Gumbo kakadu plum komatsuna black-eyed pea green bean zucchini gourd winter purslane silver beet rock melon radish asparagus spinach.</p>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  position: relative;\r\n}\r\n\r\n.item {\r\n  width: 100px;\r\n  height: 30px;\r\n  background-color: rgba(111,41,97,.3);\r\n  position: sticky;\r\n  top: 0;\r\n  width: 100%;\r\n}\r\n```\r\n\r\n> example: [Smashing Guide to Layout: position: sticky](https://codepen.io/rachelandrew/pen/LmawOy) on Codepen\r\n\r\n### 3.5. å…³äºå®šä½ï¼ˆpositioningï¼‰çš„å…¶ä»–é˜…è¯»èµ„æ–™\r\n\r\n- â€œ[Positioning](https://developer.mozilla.org/en-US/docs/Learn/CSS/CSS_layout/Positioning),â€ MDN Learning Area, MDN web docs, Mozilla\r\n- â€œ[position: sticky](https://css-tricks.com/position-sticky-2/);,â€ Chris Coyier, CSS-Tricks\r\n- â€œ[CSS position:sticky](https://caniuse.com/#feat=css-sticky),â€ Browser support information for sticky positioning, caniuse\r\n\r\n---\r\n\r\n## 4. å¼¹æ€§å¸ƒå±€ï¼ˆFlex Layoutï¼‰\r\n\r\nå¼¹æ€§ç›’å­ï¼ˆFlexboxï¼‰å¸ƒå±€æ˜¯ä¸€ç§ä¸ºä¸€ç»´å¸ƒå±€è€Œè®¾è®¡çš„å¸ƒå±€æ–¹æ³•ã€‚ä¸€ç»´çš„æ„æ€æ˜¯ä½ å¸Œæœ›å†…å®¹æ˜¯æŒ‰è¡Œæˆ–è€…åˆ—æ¥å¸ƒå±€ã€‚ä½ å¯ä»¥ä½¿ç”¨`display: flex`æ¥å°†å…ƒç´ å˜ä¸ºå¼¹æ€§å¸ƒå±€ã€‚\r\n\r\n```css\r\n.container {\r\n    display: flex;\r\n}\r\n```\r\n\r\nè¯¥å®¹å™¨çš„ç›´æ¥å­å…ƒç´ ä¼šå˜ä¸ºå¼¹æ€§é¡¹ï¼ˆflex itemï¼‰ï¼Œå¹¶æŒ‰è¡Œæ’åˆ—ã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <div class=\"item\">1</div>\r\n  <div class=\"item\">2</div>\r\n  <div class=\"item\">3</div>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n* {box-sizing: border-box;}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  display: flex;\r\n}\r\n\r\n.item {\r\n  width: 100px;\r\n  height: 100px;\r\n  padding: 10px;\r\n  background-color: rgba(111,41,97,.3);\r\n  border: 2px solid rgba(111,41,97,.5);\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/3/1645fd10c4105b96?w=1062&h=310&f=png&s=15494)\r\n\r\n> example: [Smashing Guide to Layout: flex](https://codepen.io/rachelandrew/pen/RyObov) on Codepen\r\n\r\n### 4.1. å¼¹æ€§ç›’å­çš„è½´ï¼ˆaxesï¼‰\r\n\r\nåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¼šç§°å¼¹æ€§é¡¹åœ¨è¡Œå†…æ˜¯ä»èµ·å§‹ä½ç½®å¼€å§‹æ’åˆ—ï¼Œè€Œä¸æ˜¯è¯´å®ƒä»¬æ˜¯å·¦å¯¹é½ã€‚è¿™äº›å…ƒç´ ä¼šæŒ‰è¡Œæ’åˆ—æ˜¯å› ä¸ºé»˜è®¤çš„`flex-direction`å€¼ä¸º`row`ï¼Œ`row`ä»£è¡¨äº†æ–‡æœ¬çš„è¡Œæ–‡æ–¹å‘ã€‚ç”±äºæˆ‘ä»¬å·¥ä½œçš„ç¯å¢ƒæ˜¯è‹±æ–‡ï¼ˆä¸­æ–‡ä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ï¼Œä¸€ç§è‡ªå·¦å‘å³çš„è¯­è¨€ï¼Œè¡Œçš„å¼€å§‹ä½ç½®å°±æ˜¯åœ¨å·¦è¾¹ï¼Œå› æ­¤æˆ‘ä»¬çš„å¼¹æ€§é¡¹ä¹Ÿæ˜¯ä»å·¦è¾¹å¼€å§‹çš„ã€‚å› æ­¤`flex-direction`çš„å€¼è¢«å®šä¹‰ä¸ºå¼¹æ€§ç›’å­çš„ä¸»è½´ï¼ˆmain axisï¼‰ã€‚\r\n\r\näº¤å‰è½´ï¼ˆcross axisï¼‰åˆ™æ˜¯å’Œä¸»è½´å‚ç›´çš„ä¸€æ¡è½´ã€‚å¦‚æœä½ çš„`flex-direction`æ˜¯`row`å¹¶ä¸”å¼¹æ€§é¡¹æ˜¯æŒ‰ç…§è¡Œå†…æ–¹å‘æ’åˆ—çš„ï¼Œé‚£ä¹ˆäº¤å‰è½´å°±æ˜¯å—çº§å…ƒç´ çš„æ’åˆ—æ–¹å‘ã€‚å¦‚æœ`flex-direction`æ˜¯`column`é‚£ä¹ˆå¼¹æ€§é¡¹å°±ä¼šä»¥å—çº§å…ƒç´ æ’åˆ—çš„æ–¹å‘æ’å¸ƒï¼Œç„¶åäº¤å‰è½´å°±ä¼šå˜ä¸º`row`ã€‚\r\n\r\nå¦‚æœä½ ä¹ æƒ¯äºä»ä¸»è½´ä¸äº¤å‰è½´çš„è§’åº¦æ¥ä½¿ç”¨å¼¹æ€§ç›’å­ï¼Œé‚£ä¹ˆä¸€åˆ‡ä¼šå˜å¾—éå¸¸ç®€å•ã€‚\r\n\r\n### 4.2. æ–¹å‘å’Œæ¬¡åº\r\n\r\nå¼¹æ€§ç›’å­æ¨¡å‹è®©æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸º`flex-direction`å±æ€§è®¾ç½®`row-reverse`æˆ–`column-reverse`å€¼æ¥æ”¹å˜ä¸»è½´ä¸Šå¼¹æ€§é¡¹çš„æ–¹å‘ã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <div class=\"item\">1</div>\r\n  <div class=\"item\">2</div>\r\n  <div class=\"item\">3</div>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n* {box-sizing: border-box;}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  display: flex;\r\n  flex-direction: row-reverse;\r\n}\r\n\r\n.item {\r\n  width: 100px;\r\n  height: 100px;\r\n  padding: 10px;\r\n  background-color: rgba(111,41,97,.3);\r\n  border: 2px solid rgba(111,41,97,.5);\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/3/1645fd10ce900086?w=1054&h=312&f=png&s=14797)\r\n\r\n> example: [Smashing Guide to Layout: flex-direction](https://codepen.io/rachelandrew/pen/zjXONE) on Codepen\r\n\r\nå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡`order`å±æ€§æ¥æ”¹å˜æŸä¸€ä¸ªå¼¹æ€§é¡¹çš„é¡ºåºã€‚ä½†æ˜¯è¦ç‰¹åˆ«æ³¨æ„ï¼Œè¿™å¯èƒ½ä¼šç»™é‚£äº›é€šè¿‡é”®ç›˜ï¼ˆè€Œéé¼ æ ‡æˆ–è§¦å±ï¼‰è®¿é—®ä½ çš„ç½‘ç«™çš„ç”¨æˆ·å¸¦æ¥ä¸€äº›éº»çƒ¦ï¼Œå› ä¸ºtabçš„é¡ºåºæ˜¯é¡µé¢å†…å…ƒç´ åœ¨æºç ä¸­çš„é¡ºåºè€Œéæ˜¾ç¤ºé¡ºåºã€‚ä½ å¯ä»¥é˜…è¯»ä¹‹åçš„â€œæ˜¾ç¤ºå’Œæ–‡æ¡£é¡ºåºâ€éƒ¨åˆ†æ¥äº†è§£æ›´å¤šç›¸å…³å†…å®¹ã€‚\r\n\r\n### 4.3. ä¸€äº›Flexçš„å±æ€§\r\n\r\nè¿™äº›flexçš„å±æ€§æ˜¯ç”¨æ¥æ§åˆ¶å¼¹æ€§é¡¹åœ¨ä¸»è½´ä¸Šç©ºé—´å¤§å°çš„ã€‚è¿™ä¸‰ä¸ªå±æ€§æ˜¯ï¼š\r\n\r\n- flex-grow\r\n- flex-shrink\r\n- flex-basis\r\n\r\né€šå¸¸å¯ä»¥ä½¿ç”¨å®ƒä»¬çš„ç®€å†™å½¢å¼ï¼š`flex`ã€‚ç¬¬ä¸€ä¸ªå€¼ä»£è¡¨`flex-grow`ï¼Œç¬¬äºŒä¸ªæ˜¯`flex-shrink`ï¼Œè€Œç¬¬ä¸‰ä¸ªåˆ™æ˜¯`flex-basis`ã€‚\r\n\r\n```css\r\n.item {\r\n    flex: 1 1 200px;\r\n}\r\n```\r\n\r\n`flex-basis`ä¼šä¸ºå¼¹æ€§é¡¹è®¾ç½®æœªæ‹‰ä¼¸å’Œå‹ç¼©æ—¶çš„åˆå§‹å¤§å°ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¤§å°æ˜¯200pxï¼Œå› æ­¤æˆ‘ä»¬ä¼šç»™æ¯ä¸ªé¡¹200pxçš„ç©ºé—´å¤§å°ã€‚ä½†æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹å®¹å™¨å…ƒç´ å¤§å°ä¸ä¼šæ­£å¥½è¢«åˆ†ä¸ºè®¸å¤š200pxå¤§å°çš„é¡¹ï¼Œè€Œæ˜¯å¯èƒ½æœ‰ä¸€äº›ä¸è¶³æˆ–å‰©ä½™ç©ºé—´ã€‚`flex-grow`å’Œ`flow-shrink`å±æ€§å…è®¸æˆ‘ä»¬åœ¨å®¹å™¨å¤§å°ä¸è¶³æˆ–æœ‰ç©ºä½™æ—¶æ§åˆ¶å„ä¸ªå¼¹æ€§é¡¹çš„å¤§å°ã€‚\r\n\r\nå¦‚æœ`flex-grow`çš„å€¼æ˜¯ä»»æ„çš„æ­£æ•°ï¼Œé‚£ä¹ˆå¼¹æ€§é¡¹ä¼šè¢«å…è®¸æ‹‰ä¼¸æ¥å æ®æ›´å¤šçš„ç©ºé—´ã€‚å› æ­¤ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå½“å„é¡¹è¢«è®¾ä¸º200pxåï¼Œæ‰€æœ‰å¤šä½™çš„ç©ºé—´ä¼šè¢«æ¯ä¸ªå¼¹æ€§é¡¹å¹³åˆ†å¹¶å¡«æ»¡ã€‚\r\n\r\nå¦‚æœ`flex-shrink`çš„å€¼ä¸ºä»»æ„çš„æ­£æ•°ï¼Œé‚£ä¹ˆå½“å¼¹æ€§é¡¹è¢«è®¾ç½®äº†`flex-basis`åï¼Œå…ƒç´ æº¢å‡ºå®¹å™¨æ—¶ä¼šè¿›è¡Œæ”¶ç¼©ã€‚åœ¨ä¸Šé¢è¿™ä¸ªCSSçš„ä¾‹å­ä¸­ï¼Œå¦‚æœå®¹å™¨ç©ºé—´ä¸è¶³ï¼Œæ¯ä¸ªå¼¹æ€§é¡¹ä¼šç­‰æ¯”ä¾‹ç¼©æ”¾ä»¥é€‚åº”å®¹å™¨çš„å¤§å°ã€‚\r\n\r\n`flex-grow`å’Œ`flex-shrink`çš„å€¼å¯ä»¥æ˜¯ä»»æ„çš„æ­£æ•°ã€‚ä¸€ä¸ªå…·æœ‰è¾ƒå¤§`flex-grow`å€¼çš„å¼¹æ€§é¡¹ä¼šåœ¨å®¹å™¨æœ‰å‰©ä½™ç©ºé—´æ—¶æ‹‰ä¼¸æ›´å¤§çš„æ¯”ä¾‹ï¼›è€Œä¸€ä¸ªå…·æœ‰æ›´å¤§`flex-shrink`å€¼çš„é¡¹åˆ™ä¼šåœ¨å®¹å™¨ç©ºé—´ä¸è¶³æ—¶è¢«å‹ç¼©çš„æ›´å¤šã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <div class=\"item\">1</div>\r\n  <div class=\"item\">2</div>\r\n  <div class=\"item\">3</div>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n* {box-sizing: border-box;}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  display: flex;\r\n}\r\n\r\n.item {\r\n  flex: 1 1 0;\r\n  width: 100px;\r\n  height: 100px;\r\n  padding: 10px;\r\n  background-color: rgba(111,41,97,.3);\r\n  border: 2px solid rgba(111,41,97,.5);\r\n}\r\n\r\n.container :first-child {\r\n  flex: 2 1 0; \r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/3/1645fd10d55eab80?w=1054&h=324&f=png&s=16745)\r\n\r\n> example: [Smashing Guide to Layout: flex properties](https://codepen.io/rachelandrew/pen/rvbaRM) on Codepen\r\n\r\nç†è§£è¿™äº›å±æ€§æ˜¯ç†è§£å¦‚ä½•ä½¿ç”¨å¼¹æ€§å¸ƒå±€çš„å…³é”®ï¼Œä¸‹é¢åˆ—å‡ºçš„ä¸€äº›èµ„æºä¼šå¸®åŠ©æˆ‘ä»¬è¿›ä¸€æ­¥å­¦ä¹ å…¶ä¸­çš„ç»†èŠ‚ã€‚å½“ä½ éœ€è¦åœ¨å®¹å™¨çš„ä¸€ä¸ªç»´åº¦ä¸Šæ‹‰ä¼¸æˆ–è€…å‹ç¼©ä¸€äº›å…ƒç´ æ—¶ï¼Œä½ å¯ä»¥è€ƒè™‘ä½¿ç”¨å¼¹æ€§ç›’å­æ¨¡å‹ã€‚å¦‚æœä½ å‘ç°ä½ æ­£å°è¯•åœ¨è¡Œå’Œåˆ—ä¸¤ä¸ªç»´åº¦ä¸Šæ’åˆ—ä½ çš„å†…å®¹ï¼Œä½ éœ€è¦çš„æ˜¯ç½‘æ ¼æ¨¡å‹ï¼ˆgridï¼‰ï¼Œè¿™æ—¶å¼¹æ€§ç›’å­æ¨¡å‹å¾ˆå¯èƒ½ä¸æ˜¯æœ€åˆé€‚çš„å·¥å…·äº†ã€‚\r\n\r\n### 4.4. å…³äºå¼¹æ€§ç›’å­å¸ƒå±€çš„å…¶ä»–é˜…è¯»èµ„æ–™\r\n\r\n- â€œ[CSS Flexible Box Layout](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Flexible_Box_Layout),â€ A complete guide to the specification, MDN web docs, Mozilla\r\n- â€œ[A Complete Guide to Flexbox](https://css-tricks.com/snippets/css/a-guide-to-flexbox/),â€ Chris Coyier, CSS-Tricks\r\n- â€œ[Flexbox Froggy](https://flexboxfroggy.com/),â€ A game for learning Flexbox\r\n- â€œ[Flexbugs](https://github.com/philipwalton/flexbugs),â€ A community curated list of browser bugs relating to Flexbox\r\n- [Learn Flexbox for free - 12 interactive screencasts to take you from beginner to advanced](https://scrimba.com/g/gflexbox) from scrimbaï¼ˆè¯‘è€…èï¼‰\r\n\r\n---\r\n\r\n## 5. ç½‘æ ¼å¸ƒå±€ï¼ˆgrid layoutï¼‰\r\n\r\nCSSç½‘æ ¼å¸ƒå±€ï¼ˆgrid layoutï¼‰æ˜¯ä¸€ç§ç”¨æ¥è¿›è¡ŒäºŒç»´å¸ƒå±€çš„æŠ€æœ¯ã€‚äºŒç»´ï¼ˆtwo-dimesionalï¼‰æ„å‘³ç€ä½ å¸Œæœ›æŒ‰ç…§è¡Œå’Œåˆ—æ¥æ’å¸ƒä½ çš„å†…å®¹ã€‚å’Œå¼¹æ€§ç›’å­ç±»ä¼¼ï¼Œç½‘æ ¼å¸ƒå±€ä¹Ÿéœ€è¦è®¾ç½®ä¸€ä¸ª`display`å€¼ã€‚ä½ å¯ä»¥ä¸ºå®¹å™¨å…ƒç´ è®¾ç½®`display: grid`ï¼Œå¹¶ä¸”ä½¿ç”¨`grid-template-columns`å’Œ`grid-template-rows`å±æ€§æ¥æ§åˆ¶ç½‘æ ¼ä¸­çš„è¡Œä¸åˆ—ã€‚\r\n\r\n```css\r\n.container {\r\n    display: grid;\r\n    grid-template-columns: 200px 200px 200px;\r\n    grid-template-rows: 200px 200px;\r\n}\r\n```\r\n\r\nä¸Šé¢è¿™æ®µCSSä¼šåˆ›å»ºä¸€ä¸ªè¡Œåˆ—å…ƒç´ å¤§å°å›ºå®šçš„ç½‘æ ¼ã€‚ä¸è¿‡è¿™ä¹Ÿè®¸å¹¶ä¸æ˜¯ä½ å¸Œæœ›çš„ã€‚é»˜è®¤å€¼ä¸º`auto`ï¼Œä½ å¯ä»¥è®¤ä¸ºè¿™ä»£è¡¨äº†â€œè®©æ ¼å­å°½å¯èƒ½çš„å¤§â€ã€‚å¦‚æœä½ æ¯æ²¡æœ‰æŒ‡å®šè¡Œï¼ˆrow trackï¼‰çš„å¤§å°ï¼Œæ‰€æœ‰æ·»åŠ è¿›æ¥çš„è¡Œå†…å®¹å¤§å°éƒ½ä¼šè¢«ç½®ä¸º`auto`ã€‚ä¸€ç§å¸¸ç”¨çš„æ¨¡å¼æ˜¯ä¸ºç½‘æ ¼åˆ¶å®šåˆ—å®½åº¦ï¼Œä½†æ˜¯å…è®¸ç½‘æ ¼æŒ‰éœ€æ·»åŠ è¡Œã€‚\r\n\r\nä½ å¯ä»¥ä½¿ç”¨ä»»æ„çš„é•¿åº¦å•ä½æˆ–æ—¶ç™¾åˆ†æ¯”æ¥è®¾ç½®è¡Œä¸åˆ—ï¼ŒåŒæ—¶ä½ å¯ä»¥ä½¿ç”¨ä¸ºç½‘æ ¼ç³»ç»Ÿæ‰€åˆ›é€ çš„æ–°çš„å•ä½â€”â€”`fr`ã€‚`fr`æ˜¯ä¸€ç§å¼¹æ€§å•ä½ï¼Œå®ƒå¯ä»¥æŒ‡å®šç½‘æ ¼å®¹å™¨å†…çš„ç©ºé—´è¢«å¦‚ä½•åˆ’åˆ†ã€‚\r\n\r\nç½‘æ ¼ä¼šæ›¿ä½ è®¡ç®—ä¸åˆ†é…ç©ºé—´ï¼Œä½ ä¸éœ€è¦å»è®¡ç®—å…ƒç´ çš„ç™¾åˆ†æ¯”å»é€‚åº”å®¹å™¨å¤§å°ã€‚åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`fr`æ¥åˆ›å»ºç½‘æ ¼çš„åˆ—ï¼Œè¿™ä½¿å¾—ç½‘æ ¼çš„åˆ—å¯ä»¥è‡ªé€‚åº”ã€‚åŒæ—¶æˆ‘ä»¬è¿˜ä½¿ç”¨äº†`grid-gap`æ¥ä¿è¯å…ƒç´ é—´çš„é—´è·ï¼ˆå…³äºç½‘æ ¼å†…å…ƒç´ ä¸çš„é—´è·ä¼šåœ¨â€œå¯¹é½â€è¿™ä¸€éƒ¨åˆ†è¯¦ç»†ä»‹ç»ï¼‰ã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <div>1</div>\r\n  <div>2</div>\r\n  <div>3</div>\r\n  <div>4</div>\r\n  <div>5<br>has more content.</div>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n* {box-sizing: border-box;}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  display: grid;\r\n  grid-template-columns: 1fr 1fr 1fr;\r\n  grid-gap: 20px;\r\n}\r\n\r\n.container > div {\r\n  padding: 10px;\r\n  background-color: rgba(111,41,97,.3);\r\n  border: 2px solid rgba(111,41,97,.5);\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/3/1645fd10d760b18f?w=1056&h=390&f=png&s=38583)\r\n\r\n> example: [Smashing Guide to Layout: a simple grid](https://codepen.io/rachelandrew/pen/erorKm) on Codepen\r\n\r\n\r\n### 5.1. å…³äºç½‘æ ¼çš„ä¸€äº›æœ¯è¯­\r\n\r\nç½‘æ ¼ç³»ç»Ÿæ€»æ˜¯æœ‰ä¸¤ä¸ªè½´ï¼šinline axisè¡¨ç¤ºé¡µé¢ä¸­æ–‡å­—çš„æ–‡å­—æ’åˆ—çš„æ–¹å‘ï¼Œblock axisè¡¨ç¤ºé¡µé¢ä¸­å—çº§å…ƒç´ çš„æ’åˆ—æ–¹å‘ã€‚\r\n\r\nä¸€ä¸ªè¢«è®¾ç½®ä¸º`display: grid`çš„å…ƒç´ å°±æ˜¯æ‰€è°“çš„ç½‘æ ¼å®¹å™¨ã€‚åœ¨ç½‘æ ¼å®¹å™¨ä¸­ä¼šæœ‰ç½‘æ ¼çº¿ï¼ˆgrid lineï¼‰ï¼Œç½‘æ ¼çº¿å°±æ˜¯ä½ åœ¨æŒ‡å®š`grid-template-columns`å’Œ`grid-template-rows`æ—¶ç½‘æ ¼ä¸­è¡Œåˆ—æ‰€ç”Ÿæˆçš„ã€‚ç½‘æ ¼ä¸­çš„æœ€å°å•ä½ï¼ˆä¹Ÿå°±æ˜¯è¢«å››æ¡ç½‘æ ¼çº¿æˆªå–ç”Ÿæˆçš„åŒºåŸŸï¼‰è¢«æˆä¸ºç½‘æ ¼å•å…ƒæ ¼ï¼ˆgrid cellï¼‰ï¼Œè¿›ä¸€æ­¥çš„ï¼Œç”±è‹¥å¹²ä¸ªå•å…ƒæ ¼ç»„æˆçš„çŸ©å½¢åŒºåŸŸè¢«æˆä¸ºç½‘æ ¼åŒºåŸŸï¼ˆgrid areaï¼‰ã€‚\r\n\r\n![Grid Lines run between each track of the grid.](https://user-gold-cdn.xitu.io/2018/7/3/1645fdc7e2d360d1?w=514&h=238&f=png&s=6379)\r\n\r\n![Grid Tracks are between any two lines](https://user-gold-cdn.xitu.io/2018/7/3/1645fdcc9dec47b3?w=514&h=238&f=png&s=6030)\r\n\r\n![Grid cells are the smallest unit on the grid, a Grid Area is one or more cells together making a rectangular area](https://user-gold-cdn.xitu.io/2018/7/3/1645fdd0fdacbfb7?w=515&h=237&f=png&s=5354)\r\n\r\n### 5.2. ç½‘æ ¼çš„è‡ªåŠ¨æ’åˆ—è§„åˆ™\r\n\r\nä¸€æ—¦ä½ åˆ›å»ºäº†ç½‘æ ¼ï¼Œé‚£ä¹ˆç½‘æ ¼å®¹å™¨çš„ç›´æ¥å­å…ƒç´ å°±ä¼šå¼€å§‹å°†å®ƒä»¬è‡ªå·±ä¸€ä¸ªä¸€ä¸ªåœ°æ”¾ç½®åœ¨ç½‘æ ¼çš„å•å…ƒæ ¼ä¸­ã€‚å­å…ƒç´ çš„æ”¾ç½®æ˜¯ä¾æ®ç½‘æ ¼çš„è‡ªåŠ¨æ’åˆ—è§„åˆ™ï¼ˆauto-placement ruleï¼‰ã€‚è¿™äº›è§„åˆ™ç¡®ä¿äº†ç½‘æ ¼å†…å…ƒç´ æ˜¯è¢«å®‰æ’åœ¨å„ä¸ªç©ºçš„å•å…ƒæ ¼ä¸­ï¼Œè€Œä¸ä¼šå½¼æ­¤é®ç›–ã€‚\r\n\r\nç½‘æ ¼ä¸­ä»»ä½•æ²¡æœ‰è¢«è¿›è¡Œå®šä½çš„ç›´æ¥å­å…ƒç´ éƒ½ä¼šæ ¹æ®è‡ªåŠ¨æ’åˆ—è§„åˆ™è¿›è¡Œæ”¾ç½®ã€‚åœ¨ä¸‹é¢è¿™ä¸ªåˆ—å­ä¸­ï¼Œæˆ‘è®©æ¯ä¸‰ä¸ªå…ƒç´ ä¸­çš„ç¬¬ä¸€ä¸ªå æ®ä¸¤è¡Œï¼Œä½†ä»ç„¶ä»èµ·å§‹è¡Œå¼€å§‹å»è‡ªåŠ¨æ’åˆ—ã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <div>1</div>\r\n  <div>2</div>\r\n  <div>3</div>\r\n  <div>4</div>\r\n  <div>5</div>\r\n  <div>6</div>\r\n  <div>7</div>\r\n  <div>8</div>\r\n  <div>9</div>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n* {box-sizing: border-box;}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  display: grid;\r\n  grid-template-columns: 1fr 1fr 1fr;\r\n  grid-gap: 20px;\r\n}\r\n\r\n.container > div {\r\n  padding: 10px;\r\n  background-color: rgba(111,41,97,.3);\r\n  border: 2px solid rgba(111,41,97,.5);\r\n}\r\n\r\n.container > div:nth-child(3n+1) {\r\n  grid-row-end: span 2;\r\n  background-color: rgba(193,225,237,.3);\r\n  border: 2px solid rgba(193,225,237,.5);\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/3/1645fe43135e298f?w=531&h=285&f=png&s=1586)\r\n\r\n> example: [Smashing Guide to Layout: auto-placement](https://codepen.io/rachelandrew/pen/ZoZoqY) on Codepen\r\n\r\n### 5.3. åŸºäºè¡Œ/åˆ—çš„åŸºæœ¬å®šä½æ–¹æ³•\r\n\r\nå®šä½ç½‘æ ¼å…ƒç´ æœ€ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨åŸºäºè¡Œ/åˆ—ï¼ˆlineï¼‰çš„å®šä½æ–¹æ³•ï¼Œåªéœ€å‘Šè¯‰æµè§ˆå™¨ä»å“ªä¸€æ’åˆ°å“ªä¸€æ’æ¥è¿›è¡Œåˆå¹¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ éœ€è¦ä¸€ä¸ª2*2çš„ç½‘æ ¼åŒºåŸŸï¼Œä½ å¯ä»¥å°†æŒ‡å®šå…ƒç´ ä»ç¬¬ä¸€è¡Œå¼€å§‹åˆ°ç¬¬ä¸‰è¡Œã€ä»ç¬¬ä¸€åˆ—å¼€å§‹åˆ°ç¬¬ä¸‰åˆ—ï¼Œè¿™æ ·å°±å¯ä»¥è¦†ç›–åˆ°å››ä¸ªå•å…ƒæ ¼ã€‚\r\n\r\n```css\r\n.item {\r\n    grid-column-start: 1;\r\n    grid-column-end: 3;\r\n    grid-row-start: 1;\r\n    grid-row-end: 3;\r\n}\r\n```\r\n\r\nè¿™äº›å±æ€§å¯ä»¥ç”¨ç¼©å†™æ¥è¡¨ç¤ºï¼š`grid-column`å’Œ`grid-row`ï¼Œå…¶ä¸­èµ·ä¸€ä¸ªå€¼ä»£è¡¨èµ·å§‹å€¼ï¼Œç¬¬äºŒä¸ªå€¼ä»£è¡¨ç»“æŸå€¼ã€‚\r\n\r\n```css\r\n.item {\r\n    grid-column: 1 / 3;\r\n    grid-row: 1 / 3;\r\n}\r\n```\r\n\r\nä½ ä¹Ÿå¯ä»¥è®©ç½‘æ ¼é¡¹ï¼ˆgrid itemï¼‰å æ®åŒä¸€ä¸ªå•å…ƒæ ¼ã€‚æ”¯æŒä¸€äº›å†…å®¹é—´ä¼šè¦†ç›–çš„è®¾è®¡ã€‚ç½‘æ ¼é¡¹ä¼šåƒé€šå¸¸ç½‘é¡µä¸­çš„å…ƒç´ é‚£æ ·å èµ·æ¥ï¼Œåœ¨htmlæºç ä¸­ä¸‹é¢çš„ç½‘æ ¼é¡¹ä¼šå åœ¨å…¶ä»–å…ƒç´ ä¸Šé¢ã€‚ä½ ä»ç„¶å¯ä»¥ç”¨`z-index`æ¥æ§åˆ¶å®ƒçš„å †å é¡ºåºã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <div class=\"one\">1</div>\r\n  <div class=\"two\">2</div>\r\n  <div class=\"three\">3</div>\r\n  <div class=\"four\">4</div>\r\n  <div class=\"five\">5</div>\r\n\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n* {box-sizing: border-box;}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  display: grid;\r\n  grid-template-columns: 1fr 1fr 1fr;\r\n  grid-gap: 20px;\r\n}\r\n\r\n.container > div {\r\n  padding: 10px;\r\n}\r\n\r\n.one {\r\n  grid-column: 1 / 4;\r\n  grid-row: 1;\r\n  background-color: rgba(111,41,97,.3);\r\n  border: 2px solid rgba(111,41,97,.5);\r\n}\r\n\r\n.two {\r\n  grid-column: 1 / 3;\r\n  grid-row: 2;\r\n  background-color: rgba(111,41,97,.3);\r\n  border: 2px solid rgba(111,41,97,.5);\r\n}\r\n\r\n.three {\r\n  grid-column: 2 / 4;\r\n  grid-row: 2 / 5;\r\n  background-color: rgba(193,225,237,.3);\r\n  border: 2px solid rgba(193,225,237,.5);\r\n}\r\n\r\n.four {\r\n  grid-column: 1;\r\n  grid-row: 4 ;\r\n  background-color: rgba(193,225,237,.3);\r\n  border: 2px solid rgba(193,225,237,.5);\r\n}\r\n\r\n.five {\r\n  grid-column: 3 ;\r\n  grid-row: 4 / 5;\r\n  background-color: rgba(111,41,97,.3);\r\n  border: 2px solid rgba(111,41,97,.5);\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/3/1645ff2d0ec568f3?w=539&h=242&f=png&s=1187)\r\n\r\n> example: [Smashing Guide to Layout: line-based placement](https://codepen.io/rachelandrew/pen/mLgLZj) on Codepen\r\n\r\n### 5.4. é€šè¿‡å‘½ååŒºåŸŸæ¥å®šä½å…ƒç´ \r\n\r\nä½ å¯ä»¥é€šè¿‡å‘½ååŒºåŸŸï¼ˆnamed areasï¼‰æ¥å®šä½ç½‘æ ¼ä¸­çš„å…ƒç´ ã€‚è¦æ˜¯ç”¨è¿™ç§æ–¹å¼ï¼Œä½ éœ€è¦ç»™æ¯ä¸ªå…ƒç´ ä¸€ä¸ªåå­—ï¼Œç„¶åé€šè¿‡`grid-template-areas`å±æ€§çš„å€¼æ¥æè¿°å¸ƒå±€æ–¹å¼ã€‚\r\n\r\n```css\r\n.item1 {\r\n    grid-area: a;\r\n}\r\n\r\n.item2 {\r\n    grid-area: b;\r\n}\r\n\r\n.item3 {\r\n    grid-area: c;\r\n}\r\n\r\n.container {\r\n    display: grid;\r\n    grid-template-columns: 1fr 1fr 1fr 1fr;\r\n    grid-template-areas: \r\n     \"a a b b\"\r\n     \"a a c c\";\r\n}\r\n```\r\n\r\nä½¿ç”¨è¿™ç§æ–¹å¼æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ã€‚å¦‚æœä½ æƒ³è¦åˆå¹¶ä¸€äº›å•å…ƒæ ¼ä½œä¸ºä½ çš„ç½‘æ ¼é¡¹ï¼Œä½ éœ€è¦é‡å¤å…ƒç´ çš„åå­—ã€‚ç½‘æ ¼åŒºåŸŸéœ€è¦èƒ½å½¢æˆä¸€ä¸ªå®Œæ•´çš„çŸ©å½¢ â€”â€” æ¯ä¸ªå•å…ƒæ ¼éƒ½éœ€è¦è¢«å¡«å…¥ä¸€ä¸ªå€¼ã€‚å¦‚æœä½ æƒ³è¦ç©ºå‡ºæŸäº›å•å…ƒæ ¼ï¼Œé‚£å°±éœ€è¦ä½¿ç”¨`.`è¿™ä¸ªå€¼ã€‚ä¾‹å¦‚åœ¨ä¸‹é¢çš„CSSé‡Œæˆ‘å°†æœ€å³ä¸‹è§’çš„å•å…ƒæ ¼ç•™ç©ºã€‚\r\n\r\n```css\r\n.container {\r\n    display: grid;\r\n    grid-template-columns: 1fr 1fr 1fr 1fr;\r\n    grid-template-areas: \r\n     \"a a b b\"\r\n     \"a a c .\";\r\n}\r\n```\r\n\r\nä½ ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢è¿™ä¸ªdemoçš„ä»£ç æ¥çœ‹çœ‹å®é™…çš„å¸ƒå±€æ•ˆæœã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <div class=\"one\">1</div>\r\n  <div class=\"two\">2</div>\r\n  <div class=\"three\">3</div>\r\n  <div class=\"four\">4</div>\r\n  <div class=\"five\">5</div>\r\n\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n* {box-sizing: border-box;}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  display: grid;\r\n  grid-template-columns: 1fr 1fr 1fr;\r\n  grid-auto-rows: minmax(50px, auto);\r\n  grid-gap: 20px;\r\n  grid-template-areas: \r\n    \"a a a\"\r\n    \"b c c\"\r\n    \". . d\"\r\n    \"e e d\"\r\n}\r\n\r\n.container > div {\r\n  padding: 10px;\r\n  background-color: rgba(111,41,97,.3);\r\n  border: 2px solid rgba(111,41,97,.5);\r\n}\r\n\r\n.one {\r\n  grid-area: a;\r\n}\r\n\r\n.two {\r\n  grid-area: b;\r\n}\r\n\r\n.three {\r\n  grid-area: c;\r\n}\r\n\r\n.four {\r\n  grid-area: d;\r\n}\r\n\r\n.five {\r\n  grid-area: e;\r\n}\r\n\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/3/1645ffbcc1e79e99?w=535&h=312&f=png&s=1250)\r\n\r\n> example: [Smashing Guide to Layout: grid-template-areas](https://codepen.io/rachelandrew/pen/bMJKeX) on Codepen\r\n\r\n\r\n### 5.5. å…³äºç½‘æ ¼å¸ƒå±€çš„å…¶ä»–é˜…è¯»èµ„æ–™\r\n\r\nè¿™ç‰‡æ–‡ç« åªåŒ…æ‹¬äº†CSSç½‘æ ¼å¸ƒå±€çš„ä¸€äº›åˆæ­¥å†…å®¹ï¼Œå…¶ä¸­è¿˜æœ‰éå¸¸å¤šçš„å†…å®¹å€¼å¾—å­¦ä¹ ï¼Œä¸‹é¢çš„ä¸€äº›èµ„æ–™å¯ä»¥å¸®åŠ©ä½ è¿›ä¸€æ­¥å­¦ä¹ ã€‚ä¸€äº›ç»„ä»¶æˆ–æ•´ä¸ªé¡µé¢çš„å¸ƒå±€éƒ½å¯ä»¥ä½¿ç”¨ç½‘æ ¼ã€‚å¦‚æœä½ éœ€è¦åœ¨ä¸¤ä¸ªç»´åº¦è¿›è¡Œå¸ƒå±€ï¼Œç½‘æ ¼å¸ƒå±€æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹© â€”â€” ä¸è®ºéœ€è¦å¸ƒå±€çš„åŒºåŸŸçš„å¤§å°ã€‚\r\n\r\n- â€œ[CSS Grid Layout](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Grid_Layout),â€ Web technology for developers, MDN web docs, Mozilla\r\n- â€œ[Grid by Example](https://gridbyexample.com/),â€ Everything you need to learn CSS Grid Layout, Rachel Andrew\r\n- â€œ[Grid Garden](https://cssgridgarden.com/),â€ A fun interactive game to test and improve your CSS skills\r\n- â€œ[Layout Land](https://www.youtube.com/channel/UC7TizprGknbDalbHplROtag),â€ Jen Simmons, YouTube\r\n- [Learn CSS Grid for free - 14 interactive screencasts to take you from beginner to advanced](https://scrimba.com/g/gR8PTE) from scrimbaï¼ˆè¯‘è€…èï¼‰\r\n\r\næˆ‘ï¼ˆä½œè€…ï¼‰åœ¨Smashing Magazineä¹Ÿå†™ä¸€äº›æ–‡ç« æ¥å¸®åŠ©ä½ æ·±å…¥ç†è§£å„ç§ç½‘æ ¼çš„æ¦‚å¿µï¼š\r\n\r\n- â€œ[Best Practices With CSS Grid Layout](https://www.smashingmagazine.com/2018/04/best-practices-grid-layout/)â€\r\n- â€œ[Styling Empty Cells With Generated Content And CSS Grid Layout](https://www.smashingmagazine.com/2018/02/generated-content-grid-layout/)â€\r\n- â€œ[Using CSS Grid: Supporting Browsers Without Grid](https://www.smashingmagazine.com/2017/11/css-grid-supporting-browsers-without-grid/)â€\r\n- â€œ[CSS Grid Gotchas And Stumbling Blocks](https://www.smashingmagazine.com/2017/09/css-grid-gotchas-stumbling-blocks/)â€\r\n- â€œ[Naming Things In CSS Grid Layout](https://www.smashingmagazine.com/2017/10/naming-things-css-grid-layout/)â€\r\n\r\n---\r\n\r\n## 6. æ˜¾ç¤ºé¡ºåºå’Œæ–‡æ¡£é¡ºåºï¼ˆvisual and document orderï¼‰\r\n\r\nåœ¨æ–‡ç« çš„æœ€å¼€å§‹ï¼Œæˆ‘å»ºè®®ä½ ä»¥ä»ä¸Šåˆ°ä¸‹çš„é˜…è¯»é¡ºåºæ¥ç»„ç»‡ä½ çš„æ–‡æ¡£é¡ºåºï¼Œè¿™æ ·ä¼šæœ‰åŠ©äºå¯è¯»æ€§å’ŒCSSçš„å¸ƒå±€æ–¹å¼ã€‚ä»æˆ‘ä»¬å…³äºå¼¹æ€§ç›’å­å’ŒCSSç½‘æ ¼çš„ç®€çŸ­ä»‹ç»æ¥çœ‹ï¼Œä½ å¯ä»¥å‘ç°ç”¨è¿™äº›å¸ƒå±€æ–¹æ³•å¯èƒ½ä¼šæå¤§åœ°æ”¹å˜é¡µé¢å±•ç¤ºçš„å…ƒç´ åœ¨æ–‡æ¡£ä¸­çš„é¡ºåºã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€ä¸ªéšå«çš„é—®é¢˜ã€‚\r\n\r\nåœ¨ä¸€äº›éå¯è§†åŒ–çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œæµè§ˆå™¨ä¼šéµå¾ªæ–‡æ¡£æºç æ¥è¿›è¡Œä½¿ç”¨ã€‚å› æ­¤ï¼Œå±å¹•é˜…è¯»å™¨ä¼šè¯»å–æ–‡æ¡£çš„é¡ºåºï¼Œæ­¤å¤–ä½¿ç”¨é”®ç›˜tabé”®æ¥æµè§ˆçš„ç”¨æˆ·è®¿é—®æ–‡æ¡£çš„é¡ºåºæ˜¯åŸºäºæºç çš„é¡ºåºï¼Œè€Œä¸æ˜¯å…ƒç´ å±•ç¤ºçš„é¡ºåºã€‚è®¸å¤šå±å¹•é˜…è¯»å™¨çš„ç”¨æˆ·å¹¶éå®Œå…¨å¤±æ˜ï¼Œä»–ä»¬å¯èƒ½åœ¨ä½¿ç”¨å±å¹•é˜…è¯»å™¨çš„åŒæ—¶ä¹Ÿèƒ½å¤Ÿçœ‹åˆ°è¿™äº›å…ƒç´ åœ¨æ–‡æ¡£çš„å“ªä¸ªéƒ¨åˆ†ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œå½“ä¸æºç è¿›è¡Œå¯¹æ¯”æ—¶ï¼Œè¿™ç§æ··ä¹±çš„é¡µé¢å±•ç°å¯èƒ½ä¼šä»¤äººå……æ»¡è¿·æƒ‘ã€‚\r\n\r\nå½“ä½ æ”¹å˜äº†å…ƒç´ åœ¨æ–‡æ¡£ä¸­åŸæ¥çš„é¡ºåºæ—¶ï¼Œä¸€å®šç¡®ä¿çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆã€‚å¦‚æœä½ å‘ç°ä½ è‡ªå·±æ­£åœ¨CSSä¸­é‡æ–°æ’åºä½ çš„å…ƒç´ ï¼Œä½ åº”è¯¥å»å›å¤´çœ‹çœ‹æ˜¯å¦è¦é‡æ–°ç»„ç»‡ä½ çš„é¡µé¢å…ƒç´ ã€‚ä½ å¯ä»¥é€šè¿‡ä½¿ç”¨tabè®¿é—®æ¥æµ‹è¯•ä¸€ä¸‹ä½ çš„é¡µé¢ã€‚\r\n\r\n### 6.1. å…³äºæ˜¾ç¤ºé¡ºåºå’Œæ–‡æ¡£é¡ºåºçš„å…¶ä»–é˜…è¯»èµ„æ–™\r\n\r\n- â€œ[CSS Grid Layout and Accessibility](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Grid_Layout/CSS_Grid_Layout_and_Accessibility),â€ Web technology for developers, MDN web docs, Mozilla\r\n- â€œ[HTML Source Order vs CSS Display Order](http://adrianroselli.com/2015/10/html-source-order-vs-css-display-order.html),â€ Adrian Roselli\r\n- â€œ[Flexbox And The Keyboard Navigation Disconnect](https://tink.uk/flexbox-the-keyboard-navigation-disconnect/),â€ Code Things, Tink\r\n- â€œ[The Responsive Order Conflict For Keyboard Focus](https://alastairc.ac/2017/06/the-responsive-order-conflict/),â€ Alastair Campbell\r\n\r\n---\r\n\r\n## 7. ç›’æ¨¡å‹çš„ç”Ÿæˆï¼ˆbox generationï¼‰\r\n\r\nä½ å†™åœ¨ç½‘é¡µé‡Œçš„ä»»ä½•ä¸œè¥¿éƒ½ä¼šç”Ÿæˆä¸€ä¸ªç›’å­ï¼ˆboxï¼‰ï¼Œè¿™ç¯‡æ–‡ç« è®¨è®ºçš„æ‰€æœ‰ä¸œè¥¿å…¶å®éƒ½æ˜¯å¦‚ä½•èƒ½å¤Ÿä½¿ç”¨CSSæ¥æŒ‰ç…§ä½ çš„è®¾è®¡å¸ƒå±€è¿™äº›ç›’å­ã€‚ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½æ ¹æœ¬ä¸æƒ³åˆ›å»ºä¸€ä¸ªç›’å­ã€‚æœ‰ä¸¤ä¸ª`display`çš„å±æ€§å€¼ä¼šå¸®ä½ å¤„ç†è¿™ç§æƒ…å†µã€‚\r\n\r\n### 7.1. ä¸ç”Ÿæˆç›’å­æˆ–å†…å®¹ï¼ˆ`display: none`ï¼‰\r\n\r\nå¦‚æœä½ å¸Œæœ›å…ƒç´ ä»¥åŠå®ƒæ‰€æœ‰çš„å†…å®¹ï¼ˆåŒ…æ‹¬æ‰€æœ‰å­å…ƒç´ ï¼‰éƒ½ä¸ä¼šç”Ÿæˆï¼Œä½ å¯ä»¥ä½¿ç”¨`display: none`ã€‚è¿™æ ·å…ƒç´ å°±ä¸ä¼šè¢«å±•ç¤ºï¼Œå¹¶ä¸”ä¸ä¼šä¿ç•™å…¶æœ¬è¯¥å æœ‰çš„ç©ºé—´ã€‚\r\n\r\n```css\r\n.item {\r\n    display: none;\r\n}\r\n```\r\n\r\n### 7.2 ä¸ç”Ÿæˆè¯¥å…ƒç´ ï¼Œä½†æ˜¯ç”Ÿæˆå…¶æ‰€æœ‰å­å…ƒç´ ï¼ˆ`display: contents`ï¼‰\r\n\r\n`display: content`æ˜¯`display`çš„ä¸€ä¸ªæ–°çš„å±æ€§å€¼ã€‚ä¸ºä¸€ä¸ªå…ƒç´ åº”ç”¨`display: content`å±æ€§ä¼šå¯¼è‡´å…¶è‡ªèº«çš„ç›’å­ä¸ç”Ÿæˆä½†æ‰€æœ‰çš„å­å…ƒç´ éƒ½ä¼šç…§å¸¸ç”Ÿæˆã€‚è¿™æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿè¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä½ å¸Œæœ›ä¸€ä¸ªå¼¹æ€§å¸ƒå±€æˆ–ç½‘æ ¼å¸ƒå±€ä¸­çš„éç›´æ¥å­å…ƒç´ èƒ½åº”ç”¨è¿™äº›å¸ƒå±€ï¼Œè¿™å°±ä¼šéå¸¸æœ‰ç”¨ã€‚\r\n\r\nåœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­é‡Œï¼Œç¬¬ä¸€ä¸ªå¼¹æ€§é¡¹åŒ…å«äº†ä¸¤ä¸ªå­å…ƒç´ ï¼Œç”±äºå®ƒè¢«è®¾ä¸º`display: contents`ï¼Œå®ƒçš„ç›’å­ä¸ä¼šç”Ÿæˆå¹¶ä¸”å®ƒçš„ä¸¤ä¸ªå­å…ƒç´ ä¼šæˆä¸ºå¼¹æ€§é¡¹ï¼Œå¹¶è¢«å½“ä½œå¼¹æ€§ç›’å­å®¹å™¨çš„ç›´æ¥å­å…ƒç´ æ¥å¸ƒå±€ã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <div class=\"item\">\r\n    <div class=\"subitem\">A</div>\r\n    <div class=\"subitem\">B</div>\r\n  </div>\r\n  <div class=\"item\">2</div>\r\n  <div class=\"item\">3</div>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n* {box-sizing: border-box;}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  display: flex;\r\n}\r\n\r\n.item {\r\n  flex: 1 1 200px;\r\n  padding: 10px;\r\n  background-color: rgba(111,41,97,.3);\r\n  border: 2px solid rgba(111,41,97,.5);\r\n}\r\n\r\n.subitem {\r\n  padding: 10px;\r\n  background-color: rgba(193,225,237,.3);\r\n  border: 2px solid rgba(193,225,237,.5);\r\n}\r\n\r\n.container .item:first-child {\r\n  display: contents;\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/3/1646049946695d35?w=535&h=101&f=png&s=791)\r\n\r\n> example: [Smashing Guide to Layout: display: contents](https://codepen.io/rachelandrew/pen/GdLBRR) on Codepen\r\n\r\n### 7.3. å…³äºbox generationçš„å…¶ä»–é˜…è¯»èµ„æ–™\r\n\r\n- â€œ[Vanishing Boxes With display: contents](https://rachelandrew.co.uk/archives/2016/01/29/vanishing-boxes-with-display-contents/),â€ Rachel Andrew\r\n- [How display: contents; Works](https://bitsofco.de/how-display-contents-works/),â€ Ire Aderinokun,\r\n- [CSS display: contents](https://caniuse.com/#feat=css-display-contents),â€ Browser support information, caniuse\r\n\r\n---\r\n\r\n## 8. å¯¹é½\r\n\r\nåœ¨ä»¥å‰ï¼Œè¦å®ç°å¯¹é½å¾€å¾€ä¼šç”¨åˆ°ä¸€äº›å¾ˆ\"tricky\"çš„æ–¹å¼ï¼Œå¹¶ä¸”èƒ½å¤Ÿä½¿ç”¨çš„æ–¹æ³•ä¹Ÿéå¸¸æœ‰é™ã€‚éšç€CSSç›’æ¨¡å‹å¯¹é½ï¼ˆbox alignment moduleï¼‰çš„å‡ºç°ï¼Œè¿™ä¸€åˆ‡éƒ½å‘ç”Ÿäº†å˜åŒ–ã€‚ä½ å°†ä¼šä½¿ç”¨å®ƒæ¥æ§åˆ¶ç½‘æ ¼å®¹å™¨ä¸å¼¹æ€§ç›’å­å®¹å™¨ä¸­çš„å¯¹é½ã€‚æœªæ¥å…¶ä»–çš„å„ç§å¸ƒå±€æ–¹æ³•éƒ½ä¼šåº”ç”¨è¿™äº›å¯¹é½å±æ€§ã€‚ç›’æ¨¡å‹å¯¹é½ï¼ˆbox alignment specificationï¼‰è§„èŒƒä¸­çš„ä¸€ç³»åˆ—è¯¦ç»†å±æ€§å¦‚ä¸‹ï¼š\r\n\r\n- `justify-content`\r\n- `align-content`\r\n- `place-content`\r\n- `justify-items`\r\n- `align-items`\r\n- `place-items`\r\n- `justify-self`\r\n- `align-self`\r\n- `place-self`\r\n- `row-gap`\r\n- `column-gap`\r\n- `gap`\r\n\r\nç”±äºä¸åŒçš„å¸ƒå±€æ¨¡å‹æœ‰ä¸åŒçš„ç‰¹æ€§ï¼Œå› æ­¤ç”¨äºä¸åŒå¸ƒå±€æ¨¡å‹çš„å¯¹é½å±æ€§ä¼šæœ‰ä¸€äº›è¡¨ç°ä¸Šçš„å·®å¼‚ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹åœ¨ä¸€äº›ç®€å•çš„ç½‘æ ¼ä¸å¼¹æ€§å¸ƒå±€ä¸­å¯¹é½æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚\r\n\r\n`align-items`å’Œ`justify-items`å±æ€§ç›¸å¯¹æ˜¯`align-self`å’Œ`justify-self`å±æ€§çš„ä¸€ç§æ‰¹é‡å½¢å¼ã€‚è¿™äº›å±æ€§ä¼šæ§åˆ¶ä¸å…ƒç´ åœ¨å…¶ç½‘æ ¼åŒºåŸŸï¼ˆgrid areaï¼‰ä¸­çš„å¯¹é½æƒ…å†µã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <div>1</div>\r\n  <div>2</div>\r\n  <div>3</div>\r\n  <div>4</div>\r\n  <div class=\"special\">5</div>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n* {box-sizing: border-box;}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  display: grid;\r\n  grid-template-columns: 1fr 1fr 1fr;\r\n  grid-auto-rows: minmax(100px, auto);\r\n  grid-gap: 20px;\r\n  align-items: center;\r\n  justify-items: start;\r\n}\r\n\r\n.special {\r\n  grid-column: 2 / 4;\r\n  align-self: end;\r\n  justify-self: end;\r\n}\r\n\r\n.container > div {\r\n  padding: 10px;\r\n  background-color: rgba(111,41,97,.3);\r\n  border: 2px solid rgba(111,41,97,.5);\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/4/164653c5e7a035d4?w=530&h=275&f=png&s=1063)\r\n\r\n> example: [Smashing Guide to Layout: Grid align-items, justify-items, align-self, justify-self](https://codepen.io/rachelandrew/pen/WJWKgd) on Codepen\r\n\r\n`align-content`å’Œ`justify-content`å±æ€§åˆ™ä¼šå¯¹ç½‘æ ¼ä¸­çš„è¡Œ/åˆ—ï¼ˆtracksï¼‰è¿›è¡Œå¯¹é½æ§åˆ¶ï¼ˆç½‘æ ¼å®¹å™¨ä¸­éœ€è¦åœ¨æ’åˆ—å®Œè¡Œ/åˆ—å…ƒç´ åæœ‰å¤šä½™çš„ç©ºé—´ï¼‰ã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <div>1</div>\r\n  <div>2</div>\r\n  <div>3</div>\r\n  <div>4</div>\r\n  <div>5</div>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n* {box-sizing: border-box;}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  height: 300px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  display: grid;\r\n  grid-template-columns: 100px 100px 100px;\r\n  grid-auto-rows: minmax(100px, auto);\r\n  grid-gap: 20px;\r\n  align-content: space-between;\r\n  justify-content: end;\r\n}\r\n\r\n.container > div {\r\n  padding: 10px;\r\n  background-color: rgba(111,41,97,.3);\r\n  border: 2px solid rgba(111,41,97,.5);\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/4/1646547a0ff1dacb?w=527&h=323&f=png&s=1229)\r\n\r\n> example: [Smashing Guide to Layout: Grid align-content, justify-content](https://codepen.io/rachelandrew/pen/mLgGym) on Codepen\r\n\r\nåœ¨å¼¹æ€§ç›’å­ä¸­ï¼Œ`align-items`å’Œ`align-self`ç”¨æ¥è§£å†³äº¤å‰è½´ä¸Šçš„å¯¹é½é—®é¢˜ï¼Œè€Œ`justify-content`åˆ™ç”¨äºè§£å†³ä¸»è½´ä¸Šç©ºé—´çš„åˆ†é…ã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <div>1</div>\r\n  <div>2</div>\r\n  <div class=\"special\">3</div>\r\n  <div>4</div>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n* {box-sizing: border-box;}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  height: 300px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: flex-end;\r\n}\r\n\r\n.special {\r\n  align-self: stretch;\r\n}\r\n\r\n.container > div {\r\n  padding: 10px;\r\n  background-color: rgba(111,41,97,.3);\r\n  border: 2px solid rgba(111,41,97,.5);\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/4/1646549cd671d30a?w=529&h=325&f=png&s=1157)\r\n\r\n> example: [Smashing Guide to Layout: Flex justify-content, align-items, align-self](https://codepen.io/rachelandrew/pen/ZoZMQZ) on Codepen\r\n\r\nåœ¨äº¤å‰è½´ä¸Šï¼ŒæŠŠå¼¹æ€§è¡Œï¼ˆflex lineï¼‰å’Œé¢å¤–ç©ºé—´åŒ…è£¹åœ¨å¼¹æ€§å®¹å™¨ä¸­ä¹‹åï¼Œä½ å°±å¯ä»¥ä½¿ç”¨`align-content`äº†ã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <div>1</div>\r\n  <div>2</div>\r\n  <div>3</div>\r\n  <div>4</div>\r\n  <div>5</div>\r\n</div>\r\n```\r\n\r\n```css\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  height: 300px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  display: flex;\r\n  flex-wrap: wrap;\r\n  align-content: space-between;\r\n}\r\n\r\n.container > div {\r\n  flex: 1 1 200px;\r\n  padding: 10px;\r\n  background-color: rgba(111,41,97,.3);\r\n  border: 2px solid rgba(111,41,97,.5);\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/4/1646550a7f945c10?w=521&h=324&f=png&s=1158)\r\n\r\n> example: [Smashing Guide to Layout: Flex align-content](https://codepen.io/rachelandrew/pen/QrPVjB) on Codepen\r\n\r\nä¸‹é¢çš„ä¸€äº›é“¾æ¥æ›´ç»†èŠ‚åœ°è®¨è®ºäº†å„ç±»å¸ƒå±€æ–¹æ³•ä¸­çš„ç›’æ¨¡å‹å¯¹é½ã€‚èŠ±äº›æ—¶é—´å»ç†è§£å¯¹é½çš„å·¥ä½œåŸç†æ˜¯éå¸¸å€¼å¾—çš„ï¼Œå®ƒå¯¹ç†è§£å¼¹æ€§ç›’å­ã€ç½‘æ ¼å¸ƒå±€ä»¥åŠæœªæ¥çš„ä¸€äº›å¸ƒå±€æ–¹æ³•éƒ½ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚\r\n\r\n### 8.1. è¡Œ/åˆ—çš„é—´éš”\r\nä¸€ä¸ªå¤šæ å¸ƒå±€å…·æœ‰`column-gap`å±æ€§ï¼Œåˆ°ç›®å‰ä½ç½®ï¼Œç½‘æ ¼å¸ƒå±€å…·æœ‰`grid-column-gao`ã€`grid-row-gap`å’Œ`grid-grid`ã€‚è¿™äº›ç°åœ¨éƒ½è¢«ä»gridæ ‡å‡†ä¸­åˆ é™¤è€Œè¢«æ·»åŠ è¿›ç›’æ¨¡å‹å¯¹é½ä¸­äº†ã€‚ä¸æ­¤åŒæ—¶ï¼Œ`grid-`çš„å‰ç¼€å±æ€§è¢«é‡å‘½åä¸º`column-gap`ã€`row-gap`å’Œ`gap`ã€‚æµè§ˆå™¨ä¼šå°†å¸¦æœ‰å‰ç¼€çš„å±æ€§æ¢ä¸ºæ–°çš„é‡å‘½åå±æ€§ï¼Œæ‰€ä»¥å¦‚æœä½ åœ¨ç›®å‰çš„ä»£ç ä¸­ä½¿ç”¨å…¼å®¹æ€§æ›´å¥½çš„è€åå­—ä¹Ÿä¸ç”¨æ‹…å¿ƒã€‚\r\n\r\né‡å‘½åæ„å‘³ç€è¿™äº›å±æ€§ä¹Ÿèƒ½è¢«åº”ç”¨äºå…¶ä»–å¸ƒå±€æ–¹æ³•ï¼Œä¸€ä¸ªæ˜æ˜¾çš„å¤‡é€‰å°±æ˜¯å¼¹æ€§ç›’å­ã€‚è™½ç„¶ç›®å‰æ²¡æœ‰æµè§ˆå™¨æ”¯æŒç›’å­æ¨¡å‹ä¸­çš„gapå±æ€§ï¼Œä½†æ˜¯åœ¨æœªæ¥æˆ‘ä»¬åº”è¯¥å¯ä»¥ä½¿ç”¨`column-gap`å’Œ`row-gap`æ¥åˆ›å»ºå¼¹æ€§é¡¹ç›®å…ƒç´ é—´çš„é—´è·ã€‚\r\n\r\n### 8.2. å…³äºbox generationçš„å…¶ä»–é˜…è¯»èµ„æ–™\r\n\r\n- â€œ[CSS Box Alignment](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Box_Alignment),â€ CSS: Cascading Style Sheets, MDN web docs, Mozilla\r\n- â€œ[Box Alignment in Flexbox](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Flexible_Box_Layout/Box_Alignment_in_Flexbox),â€ CSS Flexible Box Layout, MDN web docs, Mozilla\r\n- â€œ[Box Alignment in CSS Grid Layout](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Grid_Layout/Box_Alignment_in_CSS_Grid_Layout),â€ CSS Grid Layout, MDN web docs, Mozilla\r\n- â€œ[The New Layout Standard For The Web: CSS Grid, Flexbox And Box Alignment](https://www.smashingmagazine.com/2016/11/css-grids-flexbox-box-alignment-new-layout-standard/),â€ Rachel Andrew, Smashing Magazine\r\n- â€œ[Box Alignment Cheatsheet](https://rachelandrew.co.uk/css/cheatsheets/box-alignment),â€ Rachel Andrew\r\n\r\n---\r\n\r\n## 9. å¤šæ å¸ƒå±€ï¼ˆå¤šåˆ—å¸ƒå±€ï¼‰\r\n\r\nå¤šæ å¸ƒå±€ï¼ˆmulti-column layoutï¼‰æ˜¯ä¸€ç§æ”¯æŒåˆ›å»ºå¤šæ çš„å¸ƒå±€ç±»å‹ï¼Œå¦‚åŒæŠ¥çº¸ä¸Šé‚£æ ·ã€‚æ¯ä¸€å—éƒ½è¢«åˆ†å‰²æˆæ ï¼ˆcolumnï¼‰ï¼Œä½ ä¼šæŒ‰ç…§å—æ–¹å‘åœ¨æ ä¸­å¾€ä¸‹è¯»ç„¶åä¼šåœ¨å›åˆ°ä¸‹ä¸€æ çš„é¡¶éƒ¨ã€‚ç„¶è€Œç”¨è¿™ç§æ–¹å¼é˜…è¯»åœ¨ç½‘é¡µå†…å®¹ä¸­å¹¶ä¸æ€»æ˜¯æœ‰æ•ˆï¼Œå› ä¸ºäººä»¬å¹¶ä¸æƒ³å»è®©æ»šåŠ¨æ¡æ»šåŠ¨æ¥ã€æ»šåŠ¨å»åœ°å»é˜…è¯»ã€‚å½“éœ€è¦å±•ç¤ºå°‘éƒ¨åˆ†å†…å®¹ã€æŠ˜å ä¸€ç»„å¤é€‰æ¡†æˆ–è€…å…¶ä»–ä¸€äº›å°çš„UIç»„ä»¶æ—¶ä¼šéå¸¸æœ‰ç”¨ã€‚\r\n\r\nå½“å±•ç¤ºä¸€ç»„é«˜åº¦ä¸åŒçš„å¡ç‰‡æˆ–äº§å“æ—¶å¤šæ å¸ƒå±€ä¹Ÿéå¸¸æœ‰ç”¨ã€‚\r\n\r\n### 9.1. è®¾ç½®æ çš„å®½åº¦\r\n\r\nè¦è®¾ç½®ä¸€ä¸ªæœ€æœ‰çš„æ å®½ï¼Œå¹¶é€šçŸ¥æµè§ˆå™¨ä¾æ­¤å®½åº¦å±•ç¤ºå°½å¯èƒ½å¤šçš„æ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„CSSï¼š\r\n\r\n```css\r\n.container {\r\n    column-width: 300px;\r\n}\r\n```\r\n\r\nè¿™ä¼šåˆ›å»ºå°½å¯èƒ½å¤šçš„300pxçš„æ ï¼Œæ‰€æœ‰å‰©ä¸‹çš„ç©ºé—´ä¼šè¢«æ‰€æœ‰æ å…±äº«ã€‚å› æ­¤ï¼Œé™¤éç©ºé—´è¢«åˆ’åˆ†ä¸º300pxæ—¶æ²¡æœ‰å‰©ä½™ï¼Œå¦åˆ™ä½ çš„æ ä¼šæ¯”300pxç¨å¤šä¸€äº›ã€‚\r\n\r\n### 9.2. è®¾ç½®æ çš„æ•°ç›®\r\n\r\né™¤äº†è®¾ç½®å®½åº¦ï¼Œä½ å¯ä»¥ä½¿ç”¨`column-count`æ¥è®¾ç½®æ çš„æ•°ç›®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨ä¼šå°†ç©ºé—´å‡åˆ†ç»™ä½ éœ€è¦çš„æ•°ç›®çš„æ ã€‚\r\n\r\n```css\r\n.container {\r\n    column-count: 3;\r\n}\r\n```\r\n\r\nå¦‚æœä½ åŒæ—¶æ·»åŠ äº†`column-width`å’Œ`column-count`ï¼Œé‚£ä¹ˆ`column-count`å±æ€§ä¼šä½œä¸ºä¸€ä¸ªæœ€å¤§å€¼é™åˆ¶ã€‚åœ¨ä¸‹é¢çš„ä»£ç é‡Œï¼Œæ ä¼šè¢«æ·»åŠ ç›´åˆ°è¾¾åˆ°ä¸‰ä¸ªï¼Œæ­¤æ—¶ä»»ä½•é¢å¤–çš„ç©ºé—´éƒ½ä¼šè¢«åˆ†ç»™ä¸‰æ ï¼Œå³ä½¿ç©ºé—´è¶³å¤Ÿæˆä¸ºä¸€ä¸ªé¢å¤–çš„æ–°æ ã€‚\r\n\r\n```css\r\n.container {\r\n    column-width: 300px;\r\n    column-count: 3;\r\n}\r\n```\r\n\r\n### 9.3. é—´è·å’Œæ è§„åˆ™\r\n\r\nä½ æ— æ³•ä¸ºå•ä¸ªæ ç›’å­æ·»åŠ å¤–è¾¹è·å’Œå†…è¾¹è·ï¼Œéœ€è¦ç”¨`column-gap`å±æ€§æ¥è®¾ç½®é—´è·ã€‚å¦‚æœä½ ä¸å…·ä½“æŒ‡å®š`column-gap`çš„å€¼ï¼Œå®ƒä¼šé»˜è®¤ä¸º1emæ¥é˜²æ­¢æ é—´ç¢°æ’ã€‚è¿™å’Œå…¶ä»–å¸ƒå±€æ–¹æ³•ä¸­`column-gap`çš„è¡Œä¸ºä¸ä¸€æ ·ï¼Œå…¶ä»–å¸ƒå±€ä¸­é»˜è®¤ä¸º0ã€‚ä½ å¯ä»¥åœ¨é—´è·ä¸Šä½¿ç”¨ä»»æ„çš„é•¿åº¦å•å…ƒï¼ŒåŒ…æ‹¬0ï¼ˆå¦‚æœä½ ä¸å¸Œæœ›æœ‰æ é—´è·ï¼‰ã€‚\r\n\r\n`column-rule`å±æ€§è®©ä½ æœ‰èƒ½åŠ›å‘ä¸¤æ é—´æ·»åŠ è§„åˆ™ã€‚å®ƒæ˜¯`column-rule-width`ã€`column-rule-color`å’Œ`column-rule-style`çš„ç®€å†™å½¢å¼ï¼Œå¯borderè¡Œä¸ºç±»ä¼¼ã€‚æ³¨æ„ï¼Œä¸€ä¸ªè§„åˆ™è‡ªèº«ä¸ä¼šå ç”¨ä»»ä½•ç©ºé—´ã€‚å®ƒä¼šå æ®åœ¨é—´è·çš„é¡¶éƒ¨ï¼Œä»è€Œå¢åŠ æˆ–å‡å°‘é‚£äº›ä½ è®¾ç½®`column-gap`çš„è§„åˆ™ä¸å†…å®¹é—´çš„ç©ºé—´ã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <p>Pea horseradish azuki bean lettuce avocado asparagus okra. Kohlrabi radish okra azuki bean corn fava bean mustard tigernut jÃ­cama green bean celtuce. </p>\r\n  <p>Grape silver beet  collard greens avocado quandong fennel gumbo black-eyed pea watercress potato tigernut corn groundnut. Chickweed okra pea winter purslane coriander yarrow sweet pepper radish garlic brussels sprout groundnut summer purslane earthnut pea tomato spring onion azuki bean gourd. Gumbo kakadu plum komatsuna black-eyed pea green bean zucchini gourd winter purslane silver beet rock melon radish asparagus spinach.</p>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n* {box-sizing: border-box;}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  column-width: 120px;\r\n  column-gap: 20px;\r\n  column-rule: 4px dotted #000;\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/7/164723a815c7d001?w=1048&h=570&f=png&s=144889)\r\n\r\n> example: [Smashing Guide to Layout: multicol](https://codepen.io/rachelandrew/pen/ELJdOQ) on Codepen\r\n\r\n### 9.4. å…è®¸å…ƒç´ æ¨ªè·¨å¤šæ \r\n\r\nä½ å¯ä»¥ä½¿ç”¨`column-span`å±æ€§è®©å¤šæ å®¹å™¨å†…çš„å…ƒç´ æ¨ªè·¨å¤šæ ï¼Œç±»ä¼¼é€šæ ã€‚\r\n\r\n```css\r\nh3 {\r\n    column-span: all;\r\n}\r\n```\r\n\r\nå½“`column-span`å‡ºç°æ—¶ï¼Œå¤šæ å®¹å™¨åˆ†æ ä¼šåœ¨è¿™ä¸ªå…ƒç´ ä¸Šæ”¾åœä¸‹ï¼Œå› æ­¤ï¼Œå®¹å™¨é‡Œçš„å†…å®¹ä¼šåœ¨å…ƒç´ ä¸Šæ–¹å½¢æˆå¤šæ æ ·å¼ï¼Œç„¶ååœ¨æ¨ªè·¨å…ƒç´ ï¼ˆspanning elementï¼‰çš„ä¸‹æ–¹å½¢æˆä¸€ç»„æ–°çš„æ ç›’å­ï¼ˆcolumn boxï¼‰ã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <p>Pea horseradish azuki bean lettuce avocado asparagus okra. Kohlrabi radish okra azuki bean corn fava bean mustard tigernut jÃ­cama green bean celtuce. </p>\r\n  <h2>Veggies!</h2>\r\n  <p>Grape silver beet  collard greens avocado quandong fennel gumbo black-eyed pea watercress potato tigernut corn groundnut. Chickweed okra pea winter purslane coriander yarrow sweet pepper radish garlic brussels sprout groundnut summer purslane earthnut pea tomato spring onion azuki bean gourd. </p>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n* {box-sizing: border-box;}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  column-width: 120px;\r\n  column-gap: 20px;\r\n  column-rule: 4px dotted #000;\r\n}\r\n\r\n.container h2 {\r\n  column-span: all;\r\n  background-color: rgba(193,225,237,.6);\r\n  border:2px solid rgba(193,225,237,.6);\r\n  margin: 1em 0;\r\n  padding: .5em;\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/7/16472418608ef0d4?w=1048&h=708&f=png&s=122703)\r\n\r\n> example: [Smashing Guide to Layout: multicol span](https://codepen.io/rachelandrew/pen/gzyBQV) on Codepen\r\n\r\nä½ åªå¯ä»¥ä½¿ç”¨`column-span: all`æˆ–`column-span: none`ï¼Œå¹¶ä¸èƒ½è®©å…ƒç´ æ¨ªè·¨æŸå‡ ä¸ªæ ï¼ˆéé€šæ ï¼‰ã€‚åœ¨æ–‡ç« å†™ä½œæ—¶ï¼ŒFirefoxè¿˜ä¸æ”¯æŒ`column-span`å±æ€§ã€‚\r\n\r\n### 9.5. å…³äºå¤šæ å¸ƒå±€çš„å…¶ä»–é˜…è¯»èµ„æ–™\r\n\r\n- â€œ[Using Multi-Column Layouts](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Columns/Using_multi-column_layouts),â€ CSS Multi-column Layout, MDN web docs, Mozilla\r\n\r\n---\r\n\r\n## 10. ç¢ç‰‡åŒ–ï¼ˆFragmentationï¼‰\r\n\r\nå¤šæ å¸ƒå±€æ˜¯ç¢ç‰‡åŒ–ï¼ˆfragmentationï¼‰çš„ä¸€ä¸ªä¾‹å­ï¼Œé¡µé¢å†…å®¹ä¼šè¢«æ‹†åˆ†æˆæ ã€‚è¿™å’Œæ‰“å°æ—¶å†…å®¹è¢«åˆ†åˆ°ä¸åŒé¡µéå¸¸ç±»ä¼¼ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯ç¢ç‰‡åŒ–è§„èŒƒï¼ˆFragmentation specificationï¼‰å¤„ç†çš„ã€‚è¿™ä¸ªè§„èŒƒåŒ…æ‹¬äº†ä¸€äº›å¸®åŠ©æ§åˆ¶å†…å®¹åˆ‡åˆ†çš„å±æ€§ã€‚\r\n\r\nä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ç»„ç½®äºå¤šæ ä¸­çš„å¡ç‰‡ï¼Œå¹¶ä¸”ä½ æƒ³ç¡®ä¿å¡ç‰‡ä¸ä¼šè¢«æˆªä¸ºä¸¤åŠåˆ†åˆ°ä¸åŒçš„æ ï¼Œä½ å¯ä»¥ä½¿ç”¨`break-inside`å±æ€§çš„`avoid`å€¼ã€‚è€ƒè™‘æµè§ˆå™¨å…¼å®¹æ€§çš„å› ç´ ï¼Œä½ ä¹Ÿå¯èƒ½ä¼šæƒ³ä½¿ç”¨é—ç•™çš„`page-break-inside`å±æ€§ã€‚\r\n\r\n```css\r\n.card {\r\n    page-break-inside: avoid;\r\n    break-inside: avoid;\r\n}\r\n```\r\n\r\nå¦‚æœä½ æƒ³åœ¨headingå…ƒç´ åç¦æ­¢æ–­è¡Œï¼Œä½ å¯ä»¥ä½¿ç”¨`break-after`å±æ€§ã€‚\r\n\r\n```css\r\n.container h2 {\r\n    page-break-after: avoid;\r\n    break-after: avoid;\r\n}\r\n```\r\n\r\nè¿™äº›å±æ€§å¯ä»¥è¢«ç”¨åœ¨æ‰“å°æ ·å¼æˆ–å¤šæ æ ·å¼ä¸­ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­é‡Œï¼Œåœ¨å¤šæ å®¹å™¨ä¸­çš„ä¸‰ä¸ªæ®µè½è¢«æ‹†åˆ†åˆ°äº†ä¸‰æ ä¹‹ä¸­ã€‚æˆ‘ä¸º`p`å…ƒç´ è®¾ç½®äº†`break-inside: avoid`ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªå¤šæ ä¼šåœ¨è‡ªå·±çš„æ ä¸­ç»“æŸï¼ˆå³ä½¿è¿™ä¼šä½¿å„æ é•¿åº¦ä¸åŒï¼‰ã€‚\r\n\r\n```html\r\n<div class=\"container\">\r\n  <p>Pea horseradish azuki bean lettuce avocado asparagus okra. Kohlrabi radish okra azuki bean corn fava bean mustard tigernut jÃ­cama green bean celtuce. </p>\r\n  <p>Grape silver beet  collard greens avocado quandong fennel gumbo black-eyed pea watercress potato tigernut corn groundnut. Chickweed okra pea winter purslane coriander yarrow sweet pepper radish garlic brussels sprout</p>\r\n  \r\n  <p>Groundnut summer purslane earthnut pea tomato spring onion azuki bean gourd. Gumbo kakadu plum komatsuna black-eyed pea green bean zucchini gourd winter purslane silver beet rock melon radish asparagus spinach.</p>\r\n</div>\r\n```\r\n\r\n```css\r\nbody {\r\n  padding: 20px;\r\n  font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n* {box-sizing: border-box;}\r\n\r\np {\r\n  margin: 0 0 1em 0;\r\n}\r\n\r\n.container {\r\n  width: 500px;\r\n  border: 5px solid rgb(111,41,97);\r\n  border-radius: .5em;\r\n  padding: 10px;\r\n  column-width: 120px;\r\n  column-gap: 20px;\r\n  column-rule: 4px dotted #000;\r\n}\r\n\r\n.container p {\r\n  page-break-inside: avoid;\r\n  break-inside: avoid;\r\n}\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/7/164725a874c0a4bd?w=1048&h=612&f=png&s=147592)\r\n\r\n> example: [Smashing Guide to Layout: multicol fragmentation](https://codepen.io/rachelandrew/pen/wjZYOK) on Codepen\r\n\r\n### 10.1. å…³äºç¢ç‰‡åŒ–çš„å…¶ä»–é˜…è¯»èµ„æ–™\r\n\r\n- â€œ[A Guide To The State Of Print Stylesheets In 2018](https://www.smashingmagazine.com/2018/05/print-stylesheets-in-2018/),â€ Rachel Andrew, Smashing Magazine\r\n- â€œ[Column Breaks](https://www.quirksmode.org/css/columns/breaks.html),â€ QuirksMode.org\r\n\r\n---\r\n\r\n## 11. å¦‚ä½•é€‰æ‹©å¸ƒå±€ç±»å‹ï¼Ÿ\r\n\r\nå¤§å¤šæ•°çš„ç½‘é¡µä¼šæ··åˆä½¿ç”¨å¤šç§å¸ƒå±€ç±»å‹ã€‚å„å¸ƒå±€è§„èŒƒéƒ½å‡†ç¡®å®šä¹‰äº†å®ƒä»¬ä¹‹é—´æ˜¯å¦‚ä½•ç›¸äº’ä½œç”¨çš„ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½ä¼šåœ¨ç½‘æ ¼å¸ƒå±€çš„ç½‘æ ¼é¡¹ä¸­ä½¿ç”¨å¼¹æ€§å¸ƒå±€ã€‚ä¸€äº›å¼¹æ€§å®¹å™¨å¯èƒ½å…·æœ‰å®šä½å±æ€§æˆ–æµ®åŠ¨ã€‚è¿™äº›è§„èŒƒæ ¹æ®æœ€ä¼˜çš„å¸ƒå±€æ–¹å¼å·²ç»åŒ…å«äº†å¸ƒå±€æ¨¡å‹çš„æ··åˆä½¿ç”¨ã€‚åœ¨è¿™ç¯‡æŒ‡å—ä¸­ï¼Œæˆ‘å°è¯•æ¦‚è¿°äº†è¿™ç§å¸ƒå±€ç±»å‹çš„åŸºæœ¬ä½¿ç”¨æ–¹å¼ï¼Œæ¥å¸®åŠ©ä½ äº†è§£å®ç°ä¸€ä¸ªæ•ˆæœå¯èƒ½çš„æœ€å¥½æ–¹æ³•ã€‚\r\n\r\nç„¶è€Œï¼Œåˆ«å®³æ€•å»è¿ç”¨å¤šç§æ–¹å¼æ¥å®ç°å¸ƒå±€è®¾è®¡ã€‚æ‹…å¿ƒä½ çš„é€‰æ‹©ä¼šä¸ä¼šé€ æˆå®é™…é—®é¢˜çš„æƒ…å†µæ¯”ä½ æƒ³è±¡ä¸­è¦å°‘å¾ˆå¤šã€‚æ‰€ä»¥è¯·åœ¨å¼€å§‹å°±ç»„ç»‡å¥½ä½ çš„æ–‡æ¡£ç»“æ„ï¼Œå¹¶ä¸”æ³¨æ„ä½ æ–‡æ¡£å†…å®¹çš„å¯è§†å±•ç¤ºé¡ºåºã€‚å‰©ä¸‹çš„å¤§éƒ¨åˆ†å·¥ä½œå°±æ˜¯åœ¨æµè§ˆå™¨ä¸­è¯•è¯•ä½ çš„å¸ƒå±€æ–¹å¼æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚\r\n\r\n---\r\n\r\nåŸæ–‡ï¼š[Getting Started With CSS Layout](https://www.smashingmagazine.com/2018/05/guide-css-layout/?utm_source=mybridge&utm_medium=blog&utm_campaign=read_more)ï¼Œæ„Ÿè°¢ä½œè€…Rachel Andrewã€‚","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/12","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/12/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/12/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/12/events","html_url":"https://github.com/alienzhou/blog/issues/12","id":390624888,"node_id":"MDU6SXNzdWUzOTA2MjQ4ODg=","number":12,"title":"MongoDBé«˜å¯ç”¨__ä½¿ç”¨Replica Set","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159855196,"node_id":"MDU6TGFiZWwxMTU5ODU1MTk2","url":"https://api.github.com/repos/alienzhou/blog/labels/%E6%9C%8D%E5%8A%A1%E7%AB%AF","name":"æœåŠ¡ç«¯","color":"0bbaae","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T10:58:08Z","updated_at":"2018-12-13T10:58:08Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## 1. å¼•è¨€\r\nä½¿ç”¨MongoDBï¼Œå¯ä»¥ä»¥å•æœºæ¨¡å¼æä¾›æœåŠ¡ã€‚ä½†åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå•æœºæ¨¡å¼å°†é¢ä¸´å¾ˆå¤§çš„é£é™©ï¼Œä¸€æ—¦å•ç‚¹æ•°æ®åº“æœåŠ¡å‡ºç°æ•…éšœï¼Œå°±ä¼šå¯¼è‡´æœåŠ¡è°ƒç”¨å‡ºç°é”™è¯¯ç”šè‡³å´©æºƒã€‚å› æ­¤ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œéœ€è¦å¯¹MongoDBåšç›¸åº”çš„ä¸»å¤‡å¤„ç†ï¼Œæé«˜æ•°æ®åº“æœåŠ¡çš„å¯ç”¨æ€§ã€‚\r\n\r\nå¯¹äºæé«˜å¯ç”¨æ€§ï¼Œä¸€äº›åšæ–‡é‡Œæåˆ°äº†ä½¿ç”¨[ä¸»ä»æ¨¡å¼ï¼ˆmaster-slaverï¼‰](https://docs.mongodb.com/manual/core/master-slave/)ã€‚\r\n\r\n> WARNING:\r\nDeprecated since version 3.2: MongoDB 3.2 deprecates the use of master-slave replication for components of sharded clusters.\r\n\r\nä¸»ä»æ¨¡å¼æ˜¯é«˜å¯ç”¨çš„ä¸€ç§æ–¹æ¡ˆã€‚**ç„¶è€Œä¸Šé¢è¿™æ®µè­¦å‘Šé‡Œæåˆ°ï¼Œåœ¨é«˜ç‰ˆæœ¬çš„MongoDBï¼ˆ3.2ä»¥ä¸Šï¼‰çš„ä¸€äº›åœºæ™¯ä¸­ï¼Œå®˜æ–¹å·²ç»ä¸æ¨èä½¿ç”¨ä¸»ä»æ¨¡å¼ï¼Œå–è€Œä»£ä¹‹çš„ï¼Œæ˜¯ä½¿ç”¨å¤åˆ¶é›†ï¼ˆReplica Setï¼‰çš„æ–¹å¼åšä¸»å¤‡å¤„ç†ã€‚**\r\n\r\n> IMPORTANT:\r\nReplica sets replace master-slave replication for most use cases. If possible, use replica sets rather than master-slave replication for all new production deployments. This documentation remains to support legacy deployments and for archival purposes only.\r\n\r\nå› æ­¤ï¼Œæœ¬æ–‡å°†ä»‹ç»å¦‚ä½•å°†å•æœºMongoDBæ•°æ®åº“æ‹“å±•ä¸ºä¸»å¤‡æ¨¡å¼çš„å¤åˆ¶é›†ï¼Œä»¥æé«˜å¯ç”¨æ€§ã€‚\r\n\r\n## 2. å¤åˆ¶é›† Replica Set\r\nåœ¨å¤åˆ¶é›†ä¸­ï¼Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹(primary)ï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªä»èŠ‚ç‚¹(secondary)ï¼Œä¸»ä»èŠ‚ç‚¹é€šè¿‡å¿ƒè·³æ£€æµ‹æ¥ç¡®å®šèŠ‚ç‚¹æ˜¯å¦å¥åº·æˆ–å­˜æ´»ã€‚æ‰€æœ‰çš„è¯»å†™æ“ä½œéƒ½æ˜¯åœ¨ä¸»èŠ‚ç‚¹ä¸Šè¿›è¡Œçš„ï¼Œå¦‚æœè¦å®ç°è¯»å†™åˆ†ç¦»ï¼Œéœ€è¦è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚ä»èŠ‚ç‚¹ä¼šæ ¹æ®oplogæ¥å¤åˆ¶ä¸»èŠ‚ç‚¹çš„æ•°æ®ã€‚\r\n\r\n![MongoDBå¤åˆ¶é›†](https://user-gold-cdn.xitu.io/2018/5/3/163266184cbe4acd?w=740&h=280&f=png&s=27146)\r\n\r\né™¤äº†ä¸»ä»èŠ‚ç‚¹å¤–ï¼ŒMongoDBçš„å¤åˆ¶é›†ä¸­è¿˜å­˜åœ¨ç€ä¸€ç§å«ä»²è£è€…(Arbiter)çš„è§’è‰²ã€‚ä¸€ä¸ªä»²è£è€…èŠ‚ç‚¹æ˜¯æ¯”è¾ƒè½»é‡çº§çš„ï¼Œå®ƒä¸ä¼šå»å¤åˆ¶ä¸»åº“çš„æ•°æ®ï¼Œå› æ­¤ä¹Ÿå°±ä¸ä¼šæˆä¸ºä¸»èŠ‚ç‚¹ï¼›å®ƒæ˜¯åœ¨æŠ•ç¥¨é€‰ä¸¾é˜¶æ®µèµ·ä½œç”¨çš„â€”â€”å½“ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œä»²è£è€…å¯ä»¥è¿›è¡ŒæŠ•ç¥¨ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¸å»ºè®®ä¸€ä¸ªå¤åˆ¶é›†ä¸­åŒ…å«è¶…è¿‡ä¸€ä¸ªä»²è£è€…ã€‚\r\n\r\nå½“ä¸»èŠ‚ç‚¹çªç„¶æ•…éšœåï¼ŒMongoDBæœ‰è‡ªå·±çš„æœºåˆ¶ï¼Œä¼šè‡ªåŠ¨åˆ‡æ¢ï¼Œé€šè¿‡é€‰ä¸¾ï¼Œåœ¨ä»èŠ‚ç‚¹ä¸­é€‰å‡ºä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚\r\n\r\n![MongoDBå¤åˆ¶é›†æ•…éšœå¤„ç†](https://user-gold-cdn.xitu.io/2018/5/3/163266184cd3012c?w=660&h=500&f=png&s=38665)\r\n\r\n\r\n## 3. å¦‚ä½•ä½¿ç”¨å¤åˆ¶é›†\r\n### 3.1. åˆ›å»ºå¤åˆ¶é›†\r\né¦–å…ˆï¼Œéœ€è¦åœ¨MongoDBå®ä¾‹çš„å¯åŠ¨å‚æ•°ä¸­åŠ å…¥replSetï¼ŒæŒ‡å®šå¤åˆ¶é›†çš„åç§°ã€‚\r\n\r\n```bash\r\nmongod --port 8017 --dbpath /home/work/data/db1 --replSet rstest\r\n```\r\n\r\nå¯¹äºå·²æœ‰çš„å•æœºå®ä¾‹ï¼Œä¹Ÿå¯ä»¥åŠ å…¥è¯¥å‚æ•°å¹¶è¿›è¡Œé‡å¯ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¦å¤–å¯åŠ¨ä¸¤ä¸ªMongoDBå®ä¾‹ä½œä¸ºä»èŠ‚ç‚¹ï¼Œæ³¨æ„replSetå‚æ•°æŒ‡å®šçš„åç§°éœ€è¦ç›¸åŒã€‚\r\n\r\n```bash\r\nmongod --port 8016 --dbpath /home/work/data/db2 --replSet rstest\r\nmongod --port 8015 --dbpath /home/work/data/db2 --replSet rstest\r\n```\r\n\r\nç„¶åï¼Œå¯ä»¥é€šè¿‡mongoå‘½ä»¤è¿æ¥MongoDBæœåŠ¡ï¼Œè¿›å…¥ä¸»èŠ‚ç‚¹è¿›è¡Œåˆå§‹åŒ–ã€‚\r\n\r\n```bash\r\nmongo 127.0.0.1:8017\r\n```\r\n\r\n```javascript\r\nrs.initiate({\r\n  _id:\"rstest\", // replSetæŒ‡å®šçš„åç§°\r\n  members:[{\r\n    _id:0,\r\n    host:\"127.0.0.1:8017\" // ä¸»èŠ‚ç‚¹ipä¸ç«¯å£\r\n  }]\r\n})\r\n```\r\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ˜¯å°†å·²æœ‰å•æœºæ‹“å±•ä¸ºå¤åˆ¶é›†ï¼Œè¦åœ¨è¿æ¥åŸå•æœºçš„å®ä¾‹å¹¶åœ¨å…¶ä¸­è¿è¡Œä½¿å…¶ä½œä¸ºä¸»èŠ‚ç‚¹ã€‚\r\n\r\næœ€åï¼Œå†å°†å…¶ä»–ä¸¤ä¸ªä»èŠ‚ç‚¹åŠ å…¥åˆ°è¯¥å¤åˆ¶é›†ä¸­ã€‚\r\n\r\n```javascript\r\nrs.add(\"127.0.0.1:8016\")\r\nrs.add(\"127.0.0.1:8015\")\r\n```\r\n\r\né€šè¿‡`rs.status()`æŸ¥çœ‹æ•ˆæœï¼Œå¯ä»¥çœ‹åˆ°`rstest`è¿™ä¸ªå¤åˆ¶é›†ä¸­å·²ç»æœ‰äº†ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œ`stateStr `æŒ‡æ˜äº†èŠ‚ç‚¹çš„ç±»å‹ï¼Œ`health`ä¸º1è¡¨æ˜è¯¥èŠ‚ç‚¹æ˜¯å¥åº·çš„ã€‚\r\n\r\n```javascript\r\n{\r\n    \"set\" : \"rstest\",\r\n    \"date\" : ISODate(\"2017-10-31T13:04:16.704Z\"),\r\n    \"myState\" : 1,\r\n    \"members\" : [\r\n        {\r\n            \"_id\" : 0,\r\n            \"name\" : \"127.0.0.1:8017\",\r\n            \"health\" : 1,\r\n            \"state\" : 1,\r\n            \"stateStr\" : \"PRIMARY\", // èŠ‚ç‚¹çš„ç±»å‹ï¼Œä¸»èŠ‚ç‚¹\r\n            \"uptime\" : 1508,\r\n            \"optime\" : Timestamp(1509455043, 1),\r\n            \"optimeDate\" : ISODate(\"2017-10-31T13:04:03Z\"),\r\n            \"electionTime\" : Timestamp(1509454568, 2),\r\n            \"electionDate\" : ISODate(\"2017-10-31T12:56:08Z\"),\r\n            \"configVersion\" : 3,\r\n            \"self\" : true\r\n        },\r\n        {\r\n            \"_id\" : 1,\r\n            \"name\" : \"127.0.0.1:8016\",\r\n            \"health\" : 1,\r\n            \"state\" : 2,\r\n            \"stateStr\" : \"SECONDARY\",\r\n            \"uptime\" : 25,\r\n            \"optime\" : Timestamp(1509455043, 1),\r\n            \"optimeDate\" : ISODate(\"2017-10-31T13:04:03Z\"),\r\n            \"lastHeartbeat\" : ISODate(\"2017-10-31T13:04:15.657Z\"),\r\n            \"lastHeartbeatRecv\" : ISODate(\"2017-10-31T13:04:15.108Z\"),\r\n            \"pingMs\" : 0,\r\n            \"syncingTo\" : \"127.0.0.1:8017\",\r\n            \"configVersion\" : 3\r\n        },\r\n        {\r\n            \"_id\" : 2,\r\n            \"name\" : \"127.0.0.1:8015\",\r\n            \"health\" : 1,\r\n            \"state\" : 2,\r\n            \"stateStr\" : \"SECONDARY\",\r\n            \"uptime\" : 13,\r\n            \"optime\" : Timestamp(1509455043, 1),\r\n            \"optimeDate\" : ISODate(\"2017-10-31T13:04:03Z\"),\r\n            \"lastHeartbeat\" : ISODate(\"2017-10-31T13:04:15.657Z\"),\r\n            \"lastHeartbeatRecv\" : ISODate(\"2017-10-31T13:04:15.661Z\"),\r\n            \"pingMs\" : 0,\r\n            \"configVersion\" : 3\r\n        }\r\n    ],\r\n    \"ok\" : 1\r\n}\r\n```\r\n\r\n### 3.2. è¿æ¥å¤åˆ¶é›†\r\nç”±äºå¤åˆ¶é›†å­˜åœ¨ç¾å¤‡æ—¶ä¸­çš„åˆ‡æ¢æœºåˆ¶ï¼Œåœ¨ä¸»èŠ‚ç‚¹æ•…éšœçš„æƒ…å†µä¸‹ï¼Œé›†ç¾¤å†…å…¶ä»–ä»èŠ‚ç‚¹ä¼šé€šè¿‡æŠ•ç¥¨æ–¹å¼äº§ç”Ÿæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå› æ­¤ï¼Œä¸èƒ½åƒå•æœºæƒ…å†µä¸‹é‚£æ ·ï¼Œç›´æ¥è¿æ¥ä¸»èŠ‚ç‚¹ã€‚å¦åˆ™ï¼Œåœ¨MongoDBå¤åˆ¶é›†ä¸­ä¸»èŠ‚ç‚¹æ•…éšœï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸»èŠ‚ç‚¹æ—¶ï¼Œæ•°æ®åº“è®¿é—®å°±ä¼šå‡ºé—®é¢˜ã€‚å› æ­¤è¿æ¥å¤åˆ¶é›†éœ€è¦ç‰¹å®šçš„è¿æ¥æ–¹å¼ã€‚\r\n\r\nåœ¨MongoDBçš„è¿æ¥å­—ç¬¦ä¸²(connection url)ä¸­å¯ä»¥è¿›è¡ŒæŒ‡å®šã€‚\r\n\r\n```\r\nmongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]\r\n```\r\n\r\nå…¶ä¸­å¯ä»¥æŒ‡å®šå¤šä¸ªhost:portï¼Œç”¨è‹±æ–‡é€—å·è¿æ¥ï¼Œå¹¶åœ¨æœ€åçš„optionä¸­æ”¯æŒreplicaSetå‚æ•°ï¼Œç”¨äºæŒ‡å®šè¿æ¥çš„å¤åˆ¶é›†ã€‚ä¾‹å¦‚ï¼š\r\n\r\n```\r\nmongodb://127.0.0.1:8017,127.0.0.1:8016,127.0.0.1:8015/books?replicaSet=rstest\r\n```\r\n\r\nè¿™æ ·å°±å¯ä»¥è¿æ¥ä¸Šå¤åˆ¶é›†ä¸­çš„booksè¿™ä¸ªæ•°æ®åº“ã€‚\r\n\r\n## 4. æ€»ç»“\r\nMongoDBå¤åˆ¶é›†çš„æ•…éšœæœºåˆ¶åˆ‡æ¢æ˜¯å®ƒè‡ªèº«æ¥ä¿éšœï¼Œåœ¨éƒ¨ç½²å¥½ä¸Šé¢ä¸€ç³»åˆ—çš„æœåŠ¡åï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹å½“ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œé›†ç¾¤ä¸­çš„èŠ‚ç‚¹çŠ¶æ€ä¸æœåŠ¡å¯ç”¨æ€§ã€‚\r\n\r\né€šè¿‡killä¸»èŠ‚ç‚¹MongoDBè¿›ç¨‹ï¼Œä½¿ç”¨`rs.status()`å¯ä»¥å‘ç°ï¼Œå…¶ä¸­ä¸€ä¸ªä»èŠ‚ç‚¹å·²ç»å‡çº§ä¸ºäº†ä¸»èŠ‚ç‚¹ï¼ˆè¿™éƒ¨åˆ†åœ¨ä»èŠ‚ç‚¹çš„æ—¥å¿—ä¸­ä¹Ÿæœ‰ä½“ç°ï¼‰ã€‚æ­¤å¤–ï¼Œæ•°æ®æŸ¥è¯¢ä¾ç„¶å¯ä»¥è¿›è¡Œï¼Œä¸ä¼šå› ä¸ºä¸»èŠ‚ç‚¹çš„å®•æœºè€Œå¯¼è‡´æ•°æ®æœåŠ¡ä¸å¯ç”¨ã€‚","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/11","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/11/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/11/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/11/events","html_url":"https://github.com/alienzhou/blog/issues/11","id":390624209,"node_id":"MDU6SXNzdWUzOTA2MjQyMDk=","number":11,"title":"ã€PWAå­¦ä¹ ä¸å®è·µã€‘(10)ä½¿ç”¨Resource Hintæå‡é¡µé¢åŠ è½½æ€§èƒ½ä¸ä½“éªŒ","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845017,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE3","url":"https://api.github.com/repos/alienzhou/blog/labels/PWA","name":"PWA","color":"008672","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T10:56:24Z","updated_at":"2018-12-13T10:56:33Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« å·²æ•´ç†è‡³[gitbook - PWAå­¦ä¹ æ‰‹å†Œ](https://alienzhou.gitbook.io/learning-pwa/)ï¼Œæ–‡å­—å†…å®¹å·²åŒæ­¥è‡³[learning-pwa-ebook](https://github.com/alienzhou/learning-pwa-ebook)ã€‚è½¬è½½è¯·æ³¨æ˜ä½œè€…ä¸å‡ºå¤„ã€‚\r\n\r\næœ¬æ–‡æ˜¯ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—çš„ç¬¬åç¯‡æ–‡ç« ã€‚ä¹Ÿè®¸ä½ è¿˜æ²¡æœ‰å¬è¯´è¿‡æˆ–ä¸äº†è§£Resource Hintï¼Œä½†æ˜¯é€šè¿‡æœ¬æ–‡ï¼Œä½ ä¼šå¿«é€Ÿå­¦ä¹ åˆ°è¿™ä¸€ä»¶**é¡µé¢åŠ è½½æ€§èƒ½åˆ©å™¨**ã€‚æœ¬ç³»åˆ—ç›¸å…³demoçš„ä»£ç éƒ½å¯ä»¥åœ¨[github repo](https://github.com/alienzhou/learning-pwa)ä¸­æ‰¾åˆ°ã€‚\r\n\r\nPWAä½œä¸ºæ—¶ä¸‹æœ€ç«çƒ­çš„æŠ€æœ¯æ¦‚å¿µä¹‹ä¸€ï¼Œå¯¹æå‡Webåº”ç”¨çš„å®‰å…¨ã€æ€§èƒ½å’Œä½“éªŒæœ‰ç€å¾ˆå¤§çš„æ„ä¹‰ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å»äº†è§£ä¸å­¦ä¹ ã€‚å¯¹PWAæ„Ÿå…´è¶£çš„æœ‹å‹æ¬¢è¿å…³æ³¨ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« ã€‚\r\n\r\n---\r\n\r\n> å¯¹ä¹‹å‰çš„æ–‡ç« æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥ä»è¿™é‡Œæ‰¾åˆ°ï¼š\r\n> - [ç¬¬ä¸€ç¯‡ï¼š2018ï¼Œå¼€å§‹ä½ çš„PWAå­¦ä¹ ä¹‹æ—…](https://github.com/alienzhou/blog/issues/2)\r\n> - [ç¬¬äºŒç¯‡ï¼š10åˆ†é’Ÿå­¦ä¼šä½¿ç”¨Manifestï¼Œè®©ä½ çš„WebAppæ›´â€œNativeâ€](https://github.com/alienzhou/blog/issues/3)\r\n> - [ç¬¬ä¸‰ç¯‡ï¼šä»ä»Šå¤©èµ·ï¼Œè®©ä½ çš„WebAppç¦»çº¿å¯ç”¨](https://github.com/alienzhou/blog/issues/4)\r\n> - [ç¬¬å››ç¯‡ï¼šTroubleShooting: è§£å†³FireBase loginéªŒè¯å¤±è´¥é—®é¢˜](https://github.com/alienzhou/blog/issues/5)\r\n> - [ç¬¬äº”ç¯‡ï¼šä¸ä½ çš„ç”¨æˆ·ä¿æŒè”ç³»: Web PushåŠŸèƒ½](https://github.com/alienzhou/blog/issues/6)\r\n> - [ç¬¬å…­ç¯‡ï¼šHow to Debug? åœ¨chromeä¸­è°ƒè¯•ä½ çš„PWA](https://github.com/alienzhou/blog/issues/7)\r\n> - [ç¬¬ä¸ƒç¯‡ï¼šå¢å¼ºäº¤äº’ï¼šä½¿ç”¨Notification APIæ¥è¿›è¡Œæé†’](https://github.com/alienzhou/blog/issues/8)\r\n> - [ç¬¬å…«ç¯‡ï¼šä½¿ç”¨Service Workerè¿›è¡Œåå°æ•°æ®åŒæ­¥](https://github.com/alienzhou/blog/issues/9)\r\n> - [ç¬¬ä¹ç¯‡ï¼šPWAå®è·µä¸­çš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](https://github.com/alienzhou/blog/issues/10)\r\n\r\n---\r\n\r\n## å¼•è¨€\r\n\r\næˆ‘ä»¬çŸ¥é“ï¼Œåœ¨æ²¡æœ‰ç¼“å­˜çš„æƒ…å†µä¸‹ï¼Œæ— è®ºæ˜¯HTMLã€javascriptè¿˜æ˜¯ä¸€äº›APIæ•°æ®ï¼Œé¡µé¢çš„æ¯ä¸€ä¸ªè¯·æ±‚éƒ½éœ€è¦ä»å®¢æˆ·ç«¯å‘èµ·åç»ç”±æœåŠ¡ç«¯è¿”å›ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ¯ä¸€æ¬¡æ¶‰åŠè¿œç¨‹è¯·æ±‚çš„äº¤äº’ï¼ˆæ‰“å¼€ä¸€ä¸ªé¡µé¢ã€æŸ¥è¯¢åˆ—è¡¨æ•°æ®ã€åŠ¨æ€åŠ è½½jsè„šæœ¬ç­‰ï¼‰éƒ½ä¼šæœ‰ç½‘ç»œå»¶è¿Ÿã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿé¢„æµ‹æˆ–æŒ‡å®šé¡µé¢é¢„å…ˆè¿›è¡Œä¸€äº›ç½‘ç»œæ“ä½œï¼Œä¾‹å¦‚DNSè§£ææˆ–è€…é¢„åŠ è½½èµ„æºï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬åœ¨ä¹‹åçš„æ“ä½œä¸­æ¶‰åŠåˆ°è¿™éƒ¨åˆ†èµ„æºæ—¶ï¼ŒåŠ è½½ä¼šæ›´è¿…é€Ÿï¼Œäº¤äº’ä¹Ÿä¼šæ›´åŠ æµç•…ã€‚\r\n\r\nå½“ç„¶ï¼Œç›®å‰å·²ç»æœ‰ä¸€äº›æŠ€æœ¯æ‰‹æ®µæ¥å¸®åŠ©æˆ‘ä»¬å®ç°èµ„æºçš„é¢„åŠ è½½ï¼Œä¾‹å¦‚å¸¸è§çš„ä½¿ç”¨XMLHttpRequestæ¥è·å–èµ„æºå¹¶è¿›è¡Œç¼“å­˜ã€‚ç„¶è€Œï¼Œè¿™äº›æŠ€æœ¯éƒ½æ˜¯åº”ç”¨å±‚é¢çš„ï¼Œå¹¶éWebæ ‡å‡†ï¼ŒæŸäº›éœ€æ±‚ä¹Ÿæ— æ³•å‡†ç¡®å®ç°ã€‚åŒæ—¶ï¼Œåœ¨æ€§èƒ½æ–¹é¢ä¹Ÿå­˜åœ¨ç€é—®é¢˜ã€‚å¥½åœ¨ç›®å‰å·²æœ‰ç›¸å…³çš„Webæ ‡å‡†ï¼ˆResource Hintï¼‰æ¶‰åŠåˆ°è¿™ä¸€éƒ¨åˆ†ï¼Œé€šè¿‡å®ƒï¼Œå¯ä»¥åœ¨æµè§ˆå™¨åŸç”Ÿå±‚é¢å®ç°è¿™äº›åŠŸèƒ½ï¼ŒåŒæ—¶æä¾›æ€§èƒ½ä¿è¯ã€‚ä¸‹é¢æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹Resource Hintç›¸å…³æŠ€æœ¯ã€‚\r\n\r\n## 1. Resource Hint\r\n\r\nResource Hintæ˜¯ä¸€ç³»åˆ—ç›¸å…³æ ‡å‡†ï¼Œæ¥å‘Šè¯‰æµè§ˆå™¨å“ªäº›æºï¼ˆoriginï¼‰ä¸‹çš„èµ„æºæˆ‘ä»¬çš„Web Appæƒ³è¦è·å–ï¼Œå“ªäº›èµ„æºåœ¨ä¹‹åçš„æ“ä½œæˆ–æµè§ˆæ—¶éœ€è¦è¢«ä½¿ç”¨ï¼Œä»¥ä¾¿è®©æµè§ˆå™¨èƒ½å¤Ÿè¿›è¡Œä¸€äº›é¢„å…ˆè¿æ¥æˆ–é¢„å…ˆåŠ è½½ç­‰æ“ä½œã€‚Resource Hintæœ‰DNS Prefetchã€Preconnectã€Prefetchå’ŒPrerenderè¿™å››ç§ã€‚\r\n\r\n### 1.1. DNS Prefetch\r\nå½“æˆ‘ä»¬åœ¨æ³¨é‡å‰ç«¯æ€§èƒ½ä¼˜åŒ–æ—¶ï¼Œå¯èƒ½ä¼šå¿½ç•¥äº†DNSè§£æã€‚ç„¶è€ŒDNSçš„è§£æä¹Ÿæ˜¯æœ‰è€—æ—¶çš„ã€‚åœ¨Chromeçš„Timing Breakdown Phaseä¸­ï¼Œç¬¬ä¸‰é˜¶æ®µå°±æ˜¯DNSæŸ¥è¯¢ã€‚DNS Prefetchå°±æ˜¯å¸®åŠ©æˆ‘ä»¬å‘ŠçŸ¥æµè§ˆå™¨ï¼ŒæŸä¸ªæºä¸‹çš„èµ„æºåœ¨ä¹‹åä¼šè¦è¢«è·å–ï¼Œè¿™æ ·æµè§ˆå™¨å°±ä¼šï¼ˆShouldï¼‰å°½æ—©è§£æå®ƒã€‚\r\n\r\nResource Hintä¸»è¦é€šè¿‡ä½¿ç”¨`link`æ ‡ç­¾ã€‚`rel`å±æ€§ç¡®å®šç±»å‹ï¼Œ`href`å±æ€§åˆ™æŒ‡å®šç›¸åº”çš„æºæˆ–èµ„æºURLã€‚DNS Prefetchå¯ä»¥åƒä¸‹é¢è¿™æ ·ä½¿ç”¨ï¼š\r\n\r\n```html\r\n<link rel=\"dns-prefetch\" href=\"//yourwebsite.com\">\r\n```\r\n\r\n### 1.2. Preconnect\r\næˆ‘ä»¬çŸ¥é“ï¼Œå»ºç«‹è¿æ¥ä¸ä»…éœ€è¦DNSæŸ¥è¯¢ï¼Œè¿˜éœ€è¦è¿›è¡ŒTCPåè®®æ¡æ‰‹ï¼Œæœ‰äº›è¿˜ä¼šæœ‰TLS/SSLåè®®ï¼Œè¿™äº›éƒ½ä¼šå¯¼è‡´è¿æ¥çš„è€—æ—¶ã€‚å› æ­¤ï¼Œä½¿ç”¨Preconnectå¯ä»¥å¸®åŠ©ä½ å‘Šè¯‰æµè§ˆå™¨ï¼šâ€œæˆ‘æœ‰ä¸€äº›èµ„æºä¼šç”¨åˆ°æŸä¸ªæºï¼Œå¯ä»¥å¸®æˆ‘é¢„å…ˆå»ºç«‹è¿æ¥ã€‚â€\r\n\r\næ ¹æ®è§„èŒƒï¼Œå½“ä½ ä½¿ç”¨Preconnectæ—¶ï¼Œæµè§ˆå™¨å¤§è‡´åšäº†å¦‚ä¸‹å¤„ç†ï¼š\r\n\r\n- é¦–å…ˆï¼Œè§£æPreconnectçš„URL\r\n- å…¶æ¬¡ï¼Œæ ¹æ®å½“å‰linkå…ƒç´ ä¸­çš„å±æ€§è¿›è¡Œcorsçš„è®¾ç½®\r\n- é»˜è®¤å…ˆå°†credentialè®¾ä¸ºtrueï¼›å¦‚æœcorsä¸ºAnonymouså¹¶ä¸”å­˜åœ¨è·¨åŸŸï¼Œåˆ™å°†credentialç½®ä¸ºfalse\r\n- æœ€åè¿›è¡Œè¿æ¥\r\n\r\nä½¿ç”¨Preconnectåªéœ€è¦å°†`rel`å±æ€§è®¾ä¸º`preconnect`å³å¯ï¼š\r\n\r\n```html\r\n<link rel=\"preconnect\" href=\"//yourwebsite.com\">\r\n```\r\n\r\nå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥è®¾ç½®CORS\r\n\r\n```html\r\n<link rel=\"preconnect\" href=\"//yourwebsite.com\" crossorigin>\r\n```\r\n\r\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ ‡å‡†å¹¶æ²¡æœ‰ç¡¬æ€§è§„å®šæµè§ˆå™¨ä¸€å®šè¦ï¼ˆè€Œæ˜¯SHOULDï¼‰å®Œæˆæ•´ä¸ªè¿æ¥è¿‡ç¨‹ï¼Œæµè§ˆå™¨å¯ä»¥è§†æƒ…å†µå®Œæˆéƒ¨åˆ†å·¥ä½œã€‚\r\n\r\n### 1.3. Prefetch\r\n\r\nä½ å¯ä»¥æŠŠPrefetchç†è§£ä¸ºèµ„æºé¢„è·å–ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¯ä»¥ç”¨Prefetchæ¥æŒ‡å®šåœ¨ç´§æ¥ç€ä¹‹åçš„æ“ä½œæˆ–æµè§ˆä¸­éœ€è¦ä½¿ç”¨åˆ°çš„èµ„æºï¼Œè®©æµè§ˆå™¨æå‰è·å–ã€‚ç”±äºä»…ä»…æ˜¯æå‰è·å–èµ„æºï¼Œå› æ­¤æµè§ˆå™¨ä¸ä¼šå¯¹èµ„æºè¿›è¡Œé¢„å¤„ç†ï¼Œå¹¶ä¸”åƒCSSæ ·å¼è¡¨ã€JavaScriptè„šæœ¬è¿™æ ·çš„èµ„æºæ˜¯ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œå¹¶åº”ç”¨äºå½“å‰æ–‡æ¡£çš„ã€‚\r\n\r\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå’ŒDNS Prefetchã€Preconnectä½¿ç”¨ä¸å¤ªä¸€æ ·çš„åœ°æ–¹æ˜¯ï¼ŒPrefetchæœ‰ä¸€ä¸ª`as`çš„å¯é€‰å±æ€§ï¼Œç”¨æ¥æŒ‡å®šè·å–èµ„æºçš„ç±»å‹ã€‚ç”±äºä¸åŒçš„èµ„æºç±»å‹ä¼šå…·æœ‰ä¸åŒçš„ä¼˜å…ˆçº§ã€[CSP](https://www.w3.org/TR/CSP3/)ã€è¯·æ±‚å¤´ç­‰ï¼Œå› æ­¤è¯¥å±æ€§å¾ˆé‡è¦ã€‚ä¸‹è¡¨åˆ—å‡ºäº†ä¸€äº›å¸¸ç”¨èµ„æºçš„`as`å±æ€§å€¼ï¼š\r\n\r\n| èµ„æºä½¿ç”¨è€… | å†™æ³• |\r\n|---|---|\r\n| `<audio>` | `<link rel=preload as=audio href=...>` |\r\n| `<video>` | `<link rel=preload as=video href=...>` |\r\n| `<track>` | `<link rel=preload as=track href=...>` |\r\n| `<script>`, Worker's importScripts | `<link rel=preload as=script href=...>` |\r\n|` <link rel=stylesheet>`, CSS @import | `<link rel=preload as=style href=...>` |\r\n| CSS @font-face | `<link rel=preload as=font href=...>` |\r\n| `<img>`, `<picture>`, srcset, imageset | `<link rel=preload as=image href=...>` |\r\n| SVG's `<image>`, CSS *-image | `<link rel=preload as=image href=...>` |\r\n| XHR, fetch | `<link rel=preload as=fetch crossorigin href=...>` |\r\n| Worker, SharedWorker | `<link rel=preload as=worker href=...>` |\r\n| `<embed>` | `<link rel=preload as=embed href=...>` |\r\n| `<object>` | `<link rel=preload as=object href=...>` |\r\n| `<iframe>`, `<frame>` | `<link rel=preload as=document href=...>` |\r\n| HTML | `<link rel=preload as=html href=...>` |\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼ŒPrefetchçš„å¯é€‰èµ„æºç±»å‹éå¸¸ä¸°å¯Œï¼Œé™¤äº†æˆ‘ä»¬å¸¸ç”¨çš„`script`å’Œ`style`ï¼Œç”šè‡³è¿˜åŒ…æ‹¬XHRã€videoã€imgç­‰ï¼ŒåŸºæœ¬æ¶µç›–äº†Webä¸­çš„å„ç±»èµ„æºã€‚ä¸ºäº†è§£å†³Prefetchä¸­æŸäº›èµ„æºï¼ˆä¾‹å¦‚XHRï¼‰çš„è·¨åŸŸé—®é¢˜ï¼Œå¯ä»¥ä¸ºå…¶åº”ç”¨CORSå±æ€§ã€‚ä¸€ä¸ªåŸºæœ¬çš„Prefetchå†™æ³•ä¹Ÿå¾ˆç®€å•ï¼š\r\n\r\n```html\r\n<link rel=\"prefetch\" href=\"/my.little.script.js\" as=\"script\">\r\n```\r\n\r\n### 1.4. Prerender\r\n\r\nä¸Šä¸€éƒ¨åˆ†æˆ‘ä»¬è®²äº†Prefetchï¼Œè€ŒPrerenderåˆ™æ˜¯Prefetchçš„æ›´è¿›ä¸€æ­¥ã€‚å¯ä»¥ç²—ç•¥åœ°ç†è§£ä¸ºâ€œé¢„å¤„ç†â€ï¼ˆé¢„æ‰§è¡Œï¼‰ã€‚\r\n\r\né€šè¿‡Prerenderâ€œé¢„å¤„ç†â€çš„èµ„æºï¼Œæµè§ˆå™¨éƒ½ä¼šä½œä¸ºHTMLè¿›è¡Œå¤„ç†ã€‚æµè§ˆå™¨é™¤äº†ä¼šå»è·å–èµ„æºï¼Œè¿˜å¯èƒ½ä¼šé¢„å¤„ç†ï¼ˆMAY preprocessï¼‰è¯¥èµ„æºï¼Œè€Œè¯¥HTMLé¡µé¢ä¾èµ–çš„å…¶ä»–èµ„æºï¼Œåƒ`<script>`ã€`<style>`ç­‰é¡µé¢æ‰€éœ€èµ„æºä¹Ÿå¯èƒ½ä¼šè¢«å¤„ç†ã€‚ä½†æ˜¯é¢„å¤„ç†ä¼šç”±äºæµè§ˆå™¨æˆ–å½“å‰æœºå™¨ã€ç½‘ç»œæƒ…å†µçš„ä¸åŒè€Œè¢«ä¸åŒç¨‹åº¦åœ°æ¨è¿Ÿã€‚ä¾‹å¦‚ï¼Œä¼šæ ¹æ®CPUã€GPUå’Œå†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠè¯·æ±‚æ“ä½œçš„å¹‚ç­‰æ€§è€Œé€‰æ‹©ä¸åŒçš„ç­–ç•¥æˆ–é˜»æ­¢è¯¥æ“ä½œã€‚\r\n\r\næ³¨æ„ï¼Œç”±äºè¿™äº›é¢„å¤„ç†æ“ä½œçš„ä¸å¯æ§æ€§ï¼Œå½“ä½ åªæ˜¯éœ€è¦èƒ½å¤Ÿé¢„å…ˆè·å–éƒ¨åˆ†èµ„æºæ¥åŠ é€Ÿåç»­å¯èƒ½å‡ºç°çš„ç½‘ç»œè¯·æ±‚æ—¶ï¼Œå»ºè®®ä½¿ç”¨Prefetchã€‚å½“ä½¿ç”¨Prerenderæ—¶ï¼Œä¸ºäº†ä¿è¯å…¼å®¹æ€§ï¼Œç›®æ ‡é¡µé¢å¯ä»¥ç›‘å¬`visibilitychange`äº‹ä»¶å¹¶ä½¿ç”¨`document.visibilityState`æ¥åˆ¤æ–­é¡µé¢çŠ¶æ€ã€‚\r\n\r\n> When prerendering a document the user agent MUST set the document's visibilityState value to prerender. â€”â€” W3C Working Draft\r\n\r\nPrerenderçš„ä½¿ç”¨æ–¹å¼éå¸¸ç®€å•ï¼Œä¸DNS Prefetchå’ŒPreconnectç±»ä¼¼ï¼ŒæŒ‡å®š`rel`å±æ€§ä¸º`prerender`ï¼š\r\n\r\n```html\r\n<link rel=\"prerender\" href=\"//yourwebsite.com/nextpage.html\">\r\n```\r\n## 2. Resource Hintçš„å…·ä½“ä½¿ç”¨æ–¹å¼\r\n\r\nåœ¨ä¸Šé¢çš„éƒ¨åˆ†é‡Œï¼Œæˆ‘ä¸»è¦ä»‹ç»äº†DNS Prefetchã€Preconnectã€Prefetchå’ŒPrerenderè¿™å››ç§RHLï¼ˆResource Hint Linkï¼‰ï¼Œå¹¶ä¸”ç®€å•ä»‹ç»äº†å¦‚ä½•åœ¨`link`ä¸­ä½¿ç”¨å®ƒä»¬ã€‚ç„¶è€Œé™¤äº†ç›´æ¥åœ¨HTMLä¸­åŠ å…¥å¯¹åº”`link`æ ‡ç­¾å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡å…¶ä»–å‡ ç§æ–¹å¼è§¦å‘æµè§ˆå™¨çš„Resource Hintã€‚ä¸ºäº†æ›´åŠ ç›´è§‚ï¼Œä¸‹é¢æˆ‘ä»¬è¿˜æ˜¯ä»¥[å›¾ä¹¦æœç´¢è¿™ä¸ªdemo](https://github.com/alienzhou/learning-pwa/tree/resource-hint)ä¸ºä¾‹æ¥çœ‹çœ‹å¯ä»¥é€šè¿‡å“ªäº›æ–¹æ³•æ¥ä½¿ç”¨Resource Hintã€‚\r\n\r\n> å‡è®¾å·²ç»ä¸ºè¯¥demoæ·»åŠ è¯¦æƒ…é¡µ`nextpage.html`åŠå…¶ä¾èµ–çš„`nextpage.js`ï¼Œå½“ç‚¹å‡»åˆ—è¡¨ä¸­çš„å›¾ä¹¦æ—¶ä¼šè¿›è¡Œè·³è½¬ã€‚\r\n\r\n### 2.1. æ–‡æ¡£headä¸­çš„linkå…ƒç´ \r\n\r\nè¿™æ˜¯Resource Hintæœ€å¸¸ç”¨çš„ä¸€ç§æ–¹å¼ï¼Œæˆ‘ä»¬ä¸Šé¢ä»‹ç»çš„å„ç§ç¤ºä¾‹ä¹Ÿå°±æ˜¯ä½¿ç”¨çš„è¿™ç§æ–¹å¼ã€‚ä¾‹å¦‚æƒ³è¦æŒ‡å®šPrefetch `nextpage.js`è„šæœ¬å¯ä»¥è¿™ä¹ˆå†™ï¼š\r\n\r\n```html\r\n<link rel=\"prefetch\" href=\"./nextpage.js\" as=\"script\">\r\n```\r\n\r\n### 2.2. HTTP Linkå¤´å­—æ®µ\r\n\r\nå¯ä»¥é€šè¿‡[Link HTTP header](https://tools.ietf.org/html/rfc5988)æ¥ä½¿ç”¨Resource Hintã€‚Link HTTP headerå’Œ`link`å…ƒç´ æ˜¯ç­‰ä»·çš„ã€‚\r\n \r\n> The Link entity-header field provides a means for serialising one or more links in HTTP headers. It is semantically equivalent to the <LINK> element in HTML, as well as the atom:link feed-level element in Atom. â€”â€” RFC5988\r\n\r\n[`Link`ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆ](https://tools.ietf.org/html/rfc5988#page-7)â€”â€”`URI-Reference`å’Œ`link-param`ã€‚`URI-Reference`ç›¸å½“äº`link`å…ƒç´ ä¸­çš„`href`å±æ€§ï¼›`link-param`åˆ™åŒ…æ‹¬äº†`rel`ã€`title`ã€`type`ç­‰ä¸€ç³»åˆ—å…ƒç´ å±æ€§ï¼Œä½¿ç”¨`;`åˆ†å‰²ã€‚å› æ­¤å¯ä»¥åœ¨å“åº”å¤´ä¸­æ·»åŠ ä»¥ä¸‹éƒ¨åˆ†ï¼š\r\n\r\n```text\r\nLink: </nextpage.js>; rel=\"prefetch\"; as=\"script\"\r\n```\r\n\r\n[æˆ‘ä»¬çš„demo](https://github.com/alienzhou/learning-pwa/tree/resource-hint)ä½¿ç”¨äº†koa-staticè¿™ä¸ªä¸­é—´ä»¶ï¼Œåªè¦åšå¦‚ä¸‹ä¿®æ”¹å³å¯ï¼š\r\n\r\n```javascript\r\n// app.js\r\napp.use(serve(__dirname + '/public', {\r\n    maxage: 1000 * 60 * 60,\r\n    setHeaders: (res, path, stats) => {\r\n        if (/index.html/.test(path)) {\r\n            res.setHeader('Link', '</nextpage.js>; rel=\"prefetch\"; as=\"script\"');\r\n        }\r\n    }\r\n}));\r\n```\r\n\r\nä½ ä¼šå‘ç°ï¼Œåœ¨è®¿é—®`index.html`æ—¶ï¼Œæµè§ˆå™¨å°±ä¼šå‘æœåŠ¡å™¨è¯·æ±‚`nextpage.js`è¿™ä¸ªé¡µé¢æœ¬èº«å¹¶â€œä¸éœ€è¦â€ç”¨åˆ°çš„èµ„æºã€‚\r\n\r\n\r\n### 2.3. å‘æ–‡æ¡£åŠ¨æ€æ·»åŠ linkå…ƒç´ \r\n\r\n`link`å…ƒç´ ä¹Ÿæ”¯æŒæˆ‘ä»¬é€šè¿‡jsåŠ¨æ€å‘æ–‡æ¡£æ·»åŠ ã€‚å¯¹äºåŠ¨æ€æ·»åŠ çš„RHLï¼Œæµè§ˆå™¨ä¹Ÿä¼šå¯¹å…¶åº”ç”¨Resource Hintç­–ç•¥ã€‚æ·»åŠ `link`çš„æ–¹å¼å’Œæ·»åŠ æ™®é€šdomå…ƒç´ ä¸€è‡´ã€‚\r\n\r\n```js\r\nvar hint = document.createElement('link');\r\nhint.rel = 'prefetch';\r\nhint.as = 'script';\r\nhint.href = '/nextpage.js';\r\ndocument.head.appendChild(hint);\r\n```\r\n\r\n### 2.4. æ”¹å˜å·²æœ‰linkå…ƒç´ çš„hrefå±æ€§\r\n\r\nå½“ä½ æ”¹å˜é¡µé¢ä¸­åŸæœ‰RHLçš„`href`å±æ€§ï¼ˆæˆ–è€…prefetchæ—¶çš„`as`å±æ€§ï¼‰æ—¶ï¼Œä¼šç«‹å³è§¦å‘å¯¹æ–°èµ„æºçš„Resource Hintã€‚ä¾‹å¦‚åœ¨å¦‚ä¸‹ä»£ç æ‰§è¡Œå\r\n\r\n```js\r\nvar hint = document.querySelector('[rel=\"prefetch\"]');\r\nhint.href = './the.other.nextpage.js';\r\n```\r\n\r\næµè§ˆå™¨ç›¸å½“äºæ¥æ”¶åˆ°äº†æ–°çš„Resource Hintâ€œæŒ‡ç¤ºâ€ï¼Œå¹¶åœ¨åˆé€‚çš„æ—¶æœºå‘æœåŠ¡ç«¯è¯·æ±‚`the.other.nextpage.js`è¿™ä¸ªèµ„æºã€‚æ³¨æ„ï¼Œå½“ä½ ä¿®æ”¹`as`å±æ€§æ—¶ï¼Œä¹Ÿä¼šè§¦å‘Resource Hintã€‚\r\n\r\næ³¨æ„ï¼Œå¦‚æœä½ æƒ³é€šè¿‡ä¿®æ”¹å·²æœ‰`link`å…ƒç´ é¢„è·å–`nextpage.html`è¿™ä¸ªèµ„æºï¼Œç„¶ååƒä¸‹é¢è¿™æ ·å†™ä¼šè§¦å‘ä¸¤æ¬¡è¯·æ±‚ã€‚\r\n\r\n```js\r\nvar hint = document.querySelector('[rel=\"prefetch\"]');\r\nhint.as = 'html'; // è§¦å‘ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œå†æ¬¡è¯·æ±‚./nextpage.js\r\nhint.href = './nextpage.html'; // è¯·æ±‚./nextpage.html\r\n```\r\n\r\n## 2. Preload\r\næ—¢ç„¶æåˆ°äº†Resource Hintï¼Œé‚£ä¹ˆä¸å¾—ä¸ä»‹ç»ä¸€ä¸‹ä¸å…¶ç±»ä¼¼çš„Preloadã€‚åœ¨é‡åˆ°éœ€è¦Preloadçš„èµ„æºæ—¶ï¼Œæµè§ˆå™¨ä¼š **ç«‹åˆ»** è¿›è¡Œé¢„è·å–ï¼Œå¹¶å°†ç»“æœæ”¾åœ¨å†…å­˜ä¸­ï¼Œèµ„æºçš„è·å–ä¸ä¼šå½±å“é¡µé¢parseä¸loadäº‹ä»¶çš„è§¦å‘ã€‚ç›´åˆ°å†æ¬¡é‡åˆ°è¯¥èµ„æºçš„ä½¿ç”¨æ ‡ç­¾æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œã€‚\r\n\r\n> (Preload) Initiating an early fetch and separating fetching from resource execution.\r\n\r\nä¾‹å¦‚ä¸‹é¢è¿™ä¸ªHTMLç‰‡æ®µï¼š\r\n\r\n```html\r\n<head>\r\n    <link rel=\"preload\" href=\"./nextpage.js\" as=\"script\">\r\n    <script type=\"text/javascript\" src=\"./current.js\"></script>\r\n    <script type=\"text/javascript\" src=\"./nextpage.js\"></script>\r\n<head>\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/23/164c687371151554?w=1337&h=583&f=gif&s=1585124)\r\n\r\næµè§ˆå™¨é¦–å…ˆä¼šå»è·å–`nextpage.js`ï¼Œç„¶åè·å–å¹¶æ‰§è¡Œ`current.js`ï¼Œæœ€åï¼Œé‡åˆ°ä½¿ç”¨`nextpage.js`èµ„æºçš„`script`æ ‡ç­¾æ—¶ï¼Œå°†å·²ç»è·å–çš„`nextpage.js`æ‰§è¡Œã€‚ç”±äºæˆ‘ä»¬ä¼šå°†`script`æ ‡ç­¾ç½®äºbodyåº•éƒ¨æ¥ä¿è¯æ€§èƒ½ï¼Œå› æ­¤å¯ä»¥è€ƒè™‘åœ¨headæ ‡ç­¾ä¸­æ·»åŠ è¿™äº›èµ„æºçš„Preloadæ¥åŠ é€Ÿé¡µé¢çš„åŠ è½½ä¸æ¸²æŸ“ã€‚\r\n\r\næ›´è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç›‘å¬Preloadçš„æƒ…å†µï¼Œå¹¶è§¦å‘è‡ªå®šä»¥æ“ä½œ\r\n\r\n```html\r\n<script>\r\n  function preloadFinished(e) { ... }\r\n  function preloadError(e)  { ... }\r\n</script>\r\n<!-- listen for load and error events -->\r\n<link rel=\"preload\" href=\"app.js\" as=\"script\" onload=\"preloadFinished()\" onerror=\"preloadError()\">\r\n```\r\n\r\næ­£å¦‚åœ¨å¼•è¨€ä¸­æ‰€æåˆ°çš„ï¼Œåœ¨è¿‡å»å¦‚æœæˆ‘ä»¬æƒ³é¢„åŠ è½½ä¸€äº›èµ„æºéƒ½ä¼šç”¨ä¸€äº›åº”ç”¨å±‚é¢çš„æŠ€æœ¯æ‰‹æ®µï¼Œä½†å¾€å¾€ä¼šé‡åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š\r\n\r\n- æˆ‘ä»¬éœ€è¦å…ˆè·å–èµ„æºï¼Œç„¶ååœ¨é€‚å½“æ—¶æ‰§è¡Œï¼Œä½†ä¸¤è€…å¹¶ä¸æ˜“äºåˆ†ç¦»\r\n- æ— è®ºå“ªç§æŠ€æœ¯å®ç°ï¼Œéƒ½ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½ä¸ä½“éªŒæŸä¼¤\r\n\r\nPreloadï¼ˆåŒ…æ‹¬å‰æ–‡æåˆ°çš„Prefetchç­‰RHLï¼‰ç»™æˆ‘ä»¬å¸¦æ¥çš„ä»·å€¼å°±æ˜¯ä»æµè§ˆå™¨å±‚é¢å¾ˆå¥½åœ°å°†èµ„æºçš„åŠ è½½ä¸æ‰§è¡Œåˆ†ç¦»äº†ï¼Œå¹¶åœ¨æµè§ˆå™¨å±‚é¢æ¥ä¿è¯è‰¯å¥½çš„æ€§èƒ½ä½“éªŒã€‚\r\n\r\nçœ‹åˆ°è¿™é‡Œï¼Œä¹Ÿè®¸ä½ ä¼šç–‘æƒ‘ï¼Œéƒ½æ˜¯ä¼šé¢„è·å–èµ„æºï¼Œéƒ½æ˜¯èµ„æºçš„è·å–ä¸æ‰§è¡Œåˆ†ç¦»ï¼Œé‚£ä¹ˆPreloadä¸Prefetchæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ\r\n\r\nè¿™æ˜¯å®ƒæœ€å®¹æ˜“ä¸Prefetchæ··æ·†çš„åœ°æ–¹ã€‚åœ¨æ ‡å‡†é‡Œæœ‰è¿™ä¹ˆä¸€æ®µè¯è§£é‡Šä¸¤è€…åŒºåˆ«ï¼š\r\n\r\n> The application can use the preload keyword to initiate <u>**early, high-priority, and non-render-blocking**</u> fetch of a CSS resource that can then be applied by the application at appropriate time\r\n\r\nä¸Prefetchç›¸æ¯”ï¼ŒPreloadä¼š[å¼ºåˆ¶æµè§ˆå™¨ç«‹å³è·å–èµ„æºï¼Œå¹¶ä¸”è¯¥è¯·æ±‚å…·æœ‰è¾ƒé«˜çš„ä¼˜å…ˆçº§](https://www.w3.org/TR/preload/#x2.link-type-preload)ï¼ˆmandatory and high-priorityï¼‰ï¼Œå› æ­¤å»ºè®®å¯¹ä¸€äº›**å½“å‰é¡µé¢ä¼šé©¬ä¸Šç”¨åˆ°**èµ„æºä½¿ç”¨Preloadï¼›ç›¸å¯¹çš„ï¼ŒPrefetchçš„èµ„æºè·å–åˆ™æ˜¯å¯é€‰ä¸è¾ƒä½ä¼˜å…ˆçº§çš„ï¼Œå…¶æ˜¯å¦è·å–å®Œå…¨å–å†³äºæµè§ˆå™¨çš„å†³å®šï¼Œé€‚ç”¨äºé¢„è·å–**å°†æ¥å¯èƒ½ä¼šç”¨åˆ°**çš„èµ„æºã€‚\r\n\r\nä¸ºäº†èŠ‚çœä¸å¿…è¦çš„å¸¦å®½æ¶ˆè€—ï¼Œå¦‚æœPreloadçš„èµ„æºåœ¨3så†…æ²¡æœ‰è¢«ä½¿ç”¨ï¼ŒChromeæ§åˆ¶å°ä¼šå‡ºç°ç±»ä¼¼ä¸‹å›¾çš„è­¦å‘Šã€‚è¿™æ—¶ä½ å°±éœ€è¦ä»”ç»†æ€è€ƒï¼Œè¯¥èµ„æºæ˜¯å¦æœ‰å¿…è¦Preloadäº†ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/7/23/164c675aabb374df?w=1536&h=98&f=png&s=52630)\r\n\r\næ›´å¤šPreloadä¸Prefetchçš„ç»†èŠ‚å·®å¼‚å¯ä»¥çœ‹è¿™é‡Œ â€”â€” [Preload, Prefetch And Priorities in Chrome](https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf)ã€‚\r\n\r\n## 3. å†™åœ¨æœ€å\r\n\r\næœ¬æ–‡ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Resource Hintï¼ˆä»¥åŠPreloadï¼‰æ¥æå‡é¡µé¢åŠ è½½æ€§èƒ½ä¸ä½“éªŒï¼Œç®€å•æ¥è¯´ï¼š\r\n\r\n- DNS Prefetch å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿›è¡ŒDNSé¢„æŸ¥è¯¢ï¼›\r\n- Preconnect å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿›è¡Œé¢„è¿æ¥ï¼Œä¾‹å¦‚åœ¨ä¸€äº›é‡å®šå‘æŠ€æœ¯ä¸­ï¼Œå¯ä»¥è®©æµè§ˆå™¨å’Œæœ€ç»ˆç›®æ ‡æºæ›´æ—©å»ºç«‹è¿æ¥ï¼›\r\n- Prefetch å¯ä»¥å¸®åŠ©æˆ‘ä»¬é¢„å…ˆè·å–æ‰€éœ€èµ„æºï¼ˆå¹¶ä¸”ä¸ç”¨æ‹…å¿ƒè¯¥èµ„æºä¼šè¢«æ‰§è¡Œï¼‰ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥æ ¹æ®ç”¨æˆ·è¡Œä¸ºçŒœæµ‹å…¶ä¸‹ä¸€æ­¥æ“ä½œï¼Œç„¶ååŠ¨æ€é¢„è·å–æ‰€éœ€èµ„æºï¼›\r\n- Prerender åˆ™ä¼šæ›´è¿›ä¸€æ­¥ï¼Œä¸ä»…è·å–èµ„æºï¼Œè¿˜ä¼šé¢„åŠ è½½ï¼ˆæ‰§è¡Œï¼‰éƒ¨åˆ†èµ„æºï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬Prerenderä¸‹ä¸€ä¸ªé¡µé¢ï¼Œæ‰“å¼€è¯¥é¡µé¢æ—¶ä¼šè®©ç”¨æˆ·æ„Ÿè§‰éå¸¸æµç•…ï¼›\r\n- Preload åˆ™åƒæ˜¯ Prefetchçš„å‡çº§ç‰ˆï¼Œä¼šå¼ºåˆ¶ç«‹å³é«˜ä¼˜è·å–èµ„æºï¼Œéå¸¸é€‚åˆPreloadï¼ˆå°½æ—©è·å–ï¼‰ä¸€äº›å…³é”®æ¸²æŸ“è·¯å¾„ä¸­çš„èµ„æºã€‚\r\n\r\nè™½ç„¶ï¼Œå¤§éƒ¨åˆ†PWAç›¸å…³èµ„æ–™ä¸­å¹¶ä¸ä¼šæåŠResource Hintï¼Œä½†æ˜¯æ­£å¦‚æˆ‘åœ¨[ç¬¬ä¸€ç¯‡æ–‡ç« ](https://github.com/alienzhou/blog/issues/2)ä¸­æåˆ°çš„\r\n\r\n> PWAæœ¬èº«å…¶å®æ˜¯ä¸€ä¸ªæ¦‚å¿µé›†åˆï¼Œå®ƒä¸æ˜¯æŒ‡æŸä¸€é¡¹æŠ€æœ¯ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ç³»åˆ—çš„WebæŠ€æœ¯ä¸Webæ ‡å‡†æ¥ä¼˜åŒ–Web Appçš„å®‰å…¨ã€æ€§èƒ½å’Œä½“éªŒã€‚\r\n\r\nResource Hintæ˜¾ç„¶ç¬¦åˆè¿™ä¸€ç‚¹ã€‚\r\n\r\næˆ‘ä»¬ä¸åº”è¯¥å°†PWAå±€é™åœ¨Service Workerç¦»çº¿ç¼“å­˜ã€æé†’é€šçŸ¥è¿™äº›å¸¸è§çš„PWAå†…å®¹ä¸­ï¼Œå¸Œæœ›è¯»è€…ä¹Ÿèƒ½å¼€é˜”æ€ç»´ï¼Œç†è§£PWAèƒŒåçš„æ¦‚å¿µä¸æ€æƒ³ã€‚å› æ­¤ï¼Œåœ¨åç»­æ–‡ç« ä¸­æˆ‘ä¹Ÿä¼šä»‹ç»å‰ç«¯å­˜å‚¨(sessionStorage/localStorage/indexDB)ã€HTTP/2.0ä»¥åŠPWAè¿›å±•ç­‰ç›¸å…³å†…å®¹ã€‚\r\n\r\nåœ¨ä¸‹ä¸€ç¯‡é‡Œï¼Œæˆ‘ä»¬ä¼šä¸€èµ·æ¥å­¦ä¹ Googleå¼€æºçš„PWAç¦»çº¿å·¥å…·é›† â€”â€” workboxã€‚é€šè¿‡workboxï¼Œæˆ‘ä»¬å¯ä»¥å­¦ä¹ <u>**å„ç±»ç¦»çº¿ç­–ç•¥**</u>ï¼Œå¹¶ä¸”äº†è§£ä¸€äº›ç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦è€ƒè™‘çš„é—®é¢˜ã€‚éƒ¨åˆ†å¼€æºPWAè§£å†³æ–¹æ¡ˆä¹Ÿæ˜¯åŸºäºworkboxè¿›è¡Œå°è£…çš„ã€‚\r\n\r\n## å‚è€ƒèµ„æ–™\r\n\r\n- [Resource Hints W3C Working Draft 15 January 2018](https://www.w3.org/TR/resource-hints/)\r\n- [Preload W3C Candidate Recommendation 26 October 2017](https://www.w3.org/TR/preload/)\r\n- [Preload, Prefetch And Priorities in Chrome](https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf)\r\n- [Web Linking](https://tools.ietf.org/html/rfc5988)\r\n- [Page Visibility Level 2 W3C Proposed Recommendation 17 October 2017](https://www.w3.org/TR/page-visibility/)\r\n- [CORS settings attributes](https://html.spec.whatwg.org/multipage/urls-and-fetching.html#cors-settings-attributes)\r\n- [Content Security Policy Level 3 W3C Working Draft, 13 September 2016](https://www.w3.org/TR/CSP3/)\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/10","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/10/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/10/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/10/events","html_url":"https://github.com/alienzhou/blog/issues/10","id":390623297,"node_id":"MDU6SXNzdWUzOTA2MjMyOTc=","number":10,"title":"ã€PWAå­¦ä¹ ä¸å®è·µã€‘(9)ç”Ÿäº§ç¯å¢ƒä¸­PWAå®è·µçš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845017,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE3","url":"https://api.github.com/repos/alienzhou/blog/labels/PWA","name":"PWA","color":"008672","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T10:53:55Z","updated_at":"2018-12-13T10:54:16Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« å·²æ•´ç†è‡³[gitbook - PWAå­¦ä¹ æ‰‹å†Œ](https://alienzhou.gitbook.io/learning-pwa/)ï¼Œæ–‡å­—å†…å®¹å·²åŒæ­¥è‡³[learning-pwa-ebook](https://github.com/alienzhou/learning-pwa-ebook)ã€‚è½¬è½½è¯·æ³¨æ˜ä½œè€…ä¸å‡ºå¤„ã€‚\r\n\r\næœ¬æ–‡æ˜¯ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—çš„ç¬¬ä¹ç¯‡æ–‡ç« ã€‚\r\n\r\nPWAä½œä¸ºæ—¶ä¸‹æœ€ç«çƒ­çš„æŠ€æœ¯æ¦‚å¿µä¹‹ä¸€ï¼Œå¯¹æå‡Webåº”ç”¨çš„å®‰å…¨ã€æ€§èƒ½å’Œä½“éªŒæœ‰ç€å¾ˆå¤§çš„æ„ä¹‰ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å»äº†è§£ä¸å­¦ä¹ ã€‚å¯¹PWAæ„Ÿå…´è¶£çš„æœ‹å‹æ¬¢è¿å…³æ³¨ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« ã€‚\r\n\r\n## å¼•è¨€\r\nåœ¨å‰å…«ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å·²ç»ä»‹ç»äº†ä¸€äº›PWAä¸­çš„å¸¸è§æŠ€æœ¯ä¸ä½¿ç”¨æ–¹å¼ã€‚è™½ç„¶æˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¾ˆå¤šç›¸å…³çŸ¥è¯†ï¼Œä½†æ˜¯ï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤šé—®é¢˜åœ¨å®è·µæ—¶æ‰ä¼šæš´éœ²å‡ºæ¥ã€‚è¿™ç¯‡æ–‡ç« æ˜¯ä¸€ç¯‡TroubleShootingï¼Œæ€»ç»“äº†æˆ‘è¿‘æœŸåœ¨PWAå®è·µè¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œä»¥åŠè¿™äº›é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚å¸Œæœ›èƒ½å¸®åŠ©ä¸€äº›é‡åˆ°ç±»ä¼¼é—®é¢˜çš„æœ‹å‹ã€‚\r\n\r\n## 1. Service Worker Scope\r\n\r\n> æ³¨æ„Service Workeræ³¨å†Œæ—¶çš„ä½œç”¨èŒƒå›´ï¼ˆscopeï¼‰\r\n\r\n### 1.1. é‡åˆ°çš„é—®é¢˜\r\næˆ‘åœ¨é¡µé¢`/home`ä¸‹æ³¨å†Œäº†Service Workerï¼š\r\n\r\n```javascript\r\nnavigator.serviceWorker.register('/static/home/js/sw.js')\r\n```\r\n\r\né€šè¿‡åœ¨`.then()`ä¸­è°ƒç”¨`console.log()`å¯ä»¥å‘ç°Service Workerå…¶å®æ³¨å†ŒæˆåŠŸäº†ï¼Œä½†æ˜¯åœ¨é¡µé¢ä¸­å´ä¸ç”Ÿæ•ˆã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ\r\n\r\n### 1.2. äº§ç”Ÿçš„åŸå› \r\n\r\næˆ‘åœ¨å‰å‡ ç¯‡ä»‹ç»Service Workerçš„æ–‡ç« ä¸­æ²¡æœ‰è¿‡å¤šå¼ºè°ƒScopeçš„æ¦‚å¿µï¼š\r\n\r\n> scope: A USVString representing a URL that defines a service worker's registration scope; what range of URLs a service worker can control. This is usually a relative URL. The default value is the URL you'd get if you resolved './' using the service worker script's location as the base.\r\n\r\nScopeè§„å®šäº†Service Workerçš„ä½œç”¨ï¼ˆURLï¼‰èŒƒå›´ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ³¨å†Œåœ¨`https://www.sample.com/list`è·¯å¾„ä¸‹çš„Service Workerï¼Œå…¶ä½œç”¨çš„èŒƒå›´åªèƒ½æ˜¯å®ƒæœ¬èº«ä¸å®ƒçš„å­è·¯å¾„ï¼š\r\n\r\n- `https://www.sample.com/list`\r\n- `https://www.sample.com/list/book`\r\n- `https://www.sample.com/list/book/comic`\r\n\r\nè€Œåœ¨`https://www.sample.com`ã€`https://www.sample.com/book`è¿™äº›è·¯å¾„ä¸‹åˆ™æ˜¯æ— æ•ˆçš„ã€‚\r\n\r\nåŒæ—¶ï¼Œscopeçš„é»˜è®¤å€¼ä¸º`./`ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œæ‰€æœ‰çš„ç›¸å¯¹è·¯å¾„ä¸æ˜¯ç›¸å¯¹äºé¡µé¢ï¼Œè€Œæ˜¯ç›¸å¯¹äºsw.jsè„šæœ¬çš„ï¼‰ã€‚å› æ­¤ï¼Œ`navigator.serviceWorker.register('/static/home/js/sw.js')`ä»£ç ä¸­çš„scopeå®é™…ä¸Šæ˜¯`/static/home/js`ï¼ŒService Workerä¹Ÿå°±æ³¨å†Œåœ¨äº†`/static/home/js`è·¯å¾„ä¸‹ï¼Œæ˜¾ç„¶æ— æ³•åœ¨`/home`ä¸‹ç”Ÿæ•ˆã€‚\r\n\r\nè¿™ç§æƒ…å†µéå¸¸å¸¸è§ï¼šæˆ‘ä»¬ä¼šæŠŠ`sw.js`è¿™æ ·çš„æ–‡ä»¶æ”¾ç½®åœ¨é¡¹ç›®çš„é™æ€ç›®å½•ä¸‹ï¼ˆä¾‹å¦‚æ–‡ä¸­çš„`/static/home/js`ï¼‰ï¼Œè€Œå¹¶éé¡µé¢è·¯å¾„ä¸‹ã€‚æ˜¾ç„¶ï¼Œè¦è§£å†³è¿™ä¸ªé—®é¢˜éœ€è¦è®¾ç½®ç›¸åº”çš„scopeã€‚\r\n\r\nç„¶è€Œï¼Œå¦ä¸€ä¸ªé—®é¢˜å‡ºç°äº†ã€‚å¦‚æœä½ ç›´æ¥å°†scopeè®¾ç½®ä¸º`/home`ï¼š\r\n\r\n```javascript\r\nnavigator.serviceWorker.register('/static/home/js/sw.js', {scope: '/home'})\r\n```\r\n\r\nåœ¨chromeæ§åˆ¶å°ä¼šçœ‹åˆ°å¦‚ä¸‹çš„é”™è¯¯æç¤ºï¼š\r\n\r\n```\r\nUncaught (in promise) DOMException: Failed to register a ServiceWorker: The path of the provided scope ('/home') is not under the max scope allowed ('/static/home/js/'). \r\nAdjust the scope, move the Service Worker script, or use the Service-Worker-Allowed HTTP header to allow the scope.\r\n```\r\n\r\nStackOverflowä¸Šå¯¹æ­¤çš„è§£é‡Šæ˜¯ï¼š\r\n\r\n> Service workers can only intercept requests originating in the scope of the current directory that the service worker script is located in and its subdirectories.\r\n\r\nç®€å•æ¥è¯´ï¼ŒService Workeråªå…è®¸æ³¨å†Œåœ¨Service Workerè„šæœ¬æ‰€å¤„çš„è·¯å¾„åŠå…¶å­è·¯å¾„ä¸‹ã€‚æ˜¾ç„¶ï¼Œæˆ‘ä¸Šé¢çš„ä»£ç è§¦ç¢°åˆ°äº†è¿™ä¸ªè§„åˆ™ã€‚é‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ\r\n\r\n### 1.3. è§£å†³æ–¹æ¡ˆ\r\n\r\nè§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ã€‚\r\n\r\n#### æ–¹æ³•ä¸€ï¼šä¿®æ”¹è·¯ç”±ï¼Œè®©sw.jsçš„è®¿é—®è·¯å¾„å¤„äºåˆé€‚çš„ä½ç½®\r\n\r\n```javascript\r\nrouter.get('/sw.js', function (req, res) {\r\n    res.sendFile(path.join(__dirname, '../../static/kspay-home/static/js/sw/', 'sw.js'));\r\n});\r\n```\r\n\r\nä»¥ä¸Šæ˜¯ä¸€ä¸ªexpressä¸­ç®€å•çš„è·¯ç”±ã€‚é€šè¿‡è·¯ç”±è®¾ç½®ï¼Œæˆ‘ä»¬å°†Service Workerè„šæœ¬è·¯å¾„ç½®äºæ ¹ç›®å½•ä¸‹ï¼Œè¿™æ ·å°±å¯ä»¥è®¾ç½®scopeä¸º`/home`è€Œä¸ä¼šè¿åå…¶è§„åˆ™äº†ï¼š\r\n\r\n```javascript\r\nnavigator.serviceWorker\r\n    .register('/static/home/js/sw.js', {\r\n        scope: '/home'\r\n    })\r\n```\r\n\r\n#### æ–¹æ³•äºŒï¼šæ·»åŠ `Service-Worker-Allowed`å“åº”å¤´\r\n\r\nscopeçš„è§„èŒƒæœ‰æ—¶å€™è¿‡äºä¸¥æ ¼äº†ã€‚å› æ­¤ï¼Œæµè§ˆå™¨ä¹Ÿæä¾›äº†ä¸€ç§æ–¹å¼æ¥ä½¿æˆ‘ä»¬å¯ä»¥è¶Šè¿‡è¿™ç§é™åˆ¶ã€‚æ–¹æ³•å°±æ˜¯è®¾ç½®`Service-Worker-Allowed`å“åº”å¤´ã€‚\r\n\r\nä»¥expressä¸­çš„é™æ€æœåŠ¡ä¸­é—´ä»¶serve-staticä¸ºä¾‹ï¼Œ[è¿›è¡Œç›¸åº”é…ç½®](https://github.com/expressjs/serve-static#options)ï¼š\r\n\r\n```javascript\r\noptions: {\r\n    maxAge: 0,\r\n    setHeaders: function (res, path, stat) {\r\n        // æ·»åŠ Service-Worker-Allowedï¼Œæ‰©å±•service workerçš„scope\r\n        if (/\\/sw\\/.+\\.js/.test(path)) {\r\n            res.set({\r\n                'Content-Type': 'application/javascript',\r\n                'Service-Worker-Allowed': '/home'\r\n            });\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n## 2. CORS\r\n\r\n> è·¨åŸŸèµ„æºçš„ç¼“å­˜æŠ¥é”™\r\n\r\n### 2.1. é‡åˆ°çš„é—®é¢˜\r\n\r\nåœ¨ã€Šã€PWAå­¦ä¹ ä¸å®è·µã€‘(3) è®©ä½ çš„WebAppç¦»çº¿å¯ç”¨ã€‹ä¸­æˆ‘ä»‹ç»äº†å¦‚ä½•ç”¨Service Workerè¿›è¡Œç¼“å­˜ä»¥å®ç°ç¦»çº¿åŠŸèƒ½ã€‚å…¶ä¸­ï¼Œä¸ºäº†æé«˜ä½“éªŒï¼Œæˆ‘ä»¬ä¼šåœ¨Service Workerå®‰è£…æ—¶ç¼“å­˜é™æ€æ–‡ä»¶ï¼Œå®ç°è¿™ä¸€åŠŸèƒ½çš„éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š\r\n\r\n```javascript\r\n// ç›‘å¬installäº‹ä»¶ï¼Œå®‰è£…å®Œæˆåï¼Œè¿›è¡Œæ–‡ä»¶ç¼“å­˜\r\nself.addEventListener('install', e => {\r\n    var cacheOpenPromise = caches.open(cacheName).then(function (cache) {\r\n        return cache.addAll(cacheFiles);\r\n    });\r\n    e.waitUntil(cacheOpenPromise);\r\n});\r\n```\r\n\r\n`cacheFiles`å°±æ˜¯éœ€è¦ç¼“å­˜çš„é™æ€æ–‡ä»¶åˆ—è¡¨ã€‚ç„¶è€ŒService Workerè¿è¡Œåï¼Œåœ¨application tabä¸­å‘ç°`cacheFiles`çš„é™æ€èµ„æºå¹¶æœªè¢«ç¼“å­˜ä¸‹æ¥ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/26/1639b2f3954721b0?w=620&h=200&f=png&s=18505)\r\n\r\n### 2.2. äº§ç”Ÿçš„åŸå› \r\n\r\nåˆ‡æ¢åˆ°Consoleå¯ä»¥çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹çš„æŠ¥é”™ä¿¡æ¯ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/26/1639b385aac7ce3c?w=757&h=69&f=png&s=32044)\r\n\r\nå‰ç«¯åŒå­¦å¯¹è¿™ä¸ªé—®é¢˜éå¸¸ç†Ÿæ‚‰ï¼š**è·¨åŸŸé—®é¢˜**ã€‚\r\n\r\nä¸ºäº†ä½¿æˆ‘ä»¬çš„é¡µé¢èƒ½å¤Ÿé¡ºåˆ©åŠ è½½CDNç­‰å¤–ç«™èµ„æºï¼Œæµè§ˆå™¨åœ¨`script`ã€`link`ã€`img`ç­‰æ ‡ç­¾ä¸Šæ”¾æ¾äº†è·¨åŸŸé™åˆ¶ã€‚è¿™ä½¿å¾—æˆ‘ä»¬åœ¨é¡µé¢ä¸­é€šè¿‡`script`æ ‡ç­¾æ¥åŠ è½½javascriptè„šæœ¬æ˜¯ä¸ä¼šå¯¼è‡´è·¨åŸŸé—®é¢˜çš„ï¼ˆç»å…¸çš„jsonpå°±æ˜¯ä»¥æ­¤ä¸ºåŸºç¡€å®ç°çš„ï¼‰ã€‚\r\n\r\nç„¶è€Œåœ¨Service Workerä¸­ä½¿ç”¨`cache.addAll()`åˆ™ä¼šé€šè¿‡ç±»ä¼¼fetchè¯·æ±‚çš„æ–¹å¼æ¥è·å–èµ„æºï¼ˆç±»ä¼¼åœ¨é¡µé¢ä¸­ä½¿ç”¨XHRè¯·æ±‚å¤–ç«™è„šæœ¬ï¼‰ï¼Œæ˜¯ä¼šå—åˆ°è·¨åŸŸèµ„æºç­–ç•¥é™åˆ¶è€Œæ— æ³•ç¼“å­˜åˆ°æœ¬åœ°çš„ã€‚\r\n\r\nåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸ºäº†ç¼©çŸ­è¯·æ±‚çš„å“åº”æ—¶é—´ä¸ã€å‡è½»æœåŠ¡å™¨å‹åŠ›ï¼Œé€šå¸¸æˆ‘ä»¬éƒ½ä¼šå°†javascriptã€cssã€imageè¿™äº›é™æ€èµ„æºé€šè¿‡CDNè¿›è¡Œåˆ†å‘ï¼Œæˆ–è€…å°†å…¶æ”¾ç½®åœ¨ä¸€äº›ç‹¬ç«‹çš„é™æ€æœåŠ¡é›†ç¾¤ä¸­ã€‚æ‰€ä»¥çº¿ä¸Šçš„é™æ€èµ„æºåŸºæœ¬éƒ½æ˜¯â€œè·¨ç«™èµ„æºâ€ã€‚\r\n\r\n### 2.3. è§£å†³æ–¹æ¡ˆ\r\n\r\nè¯¥é—®é¢˜å…¶å®ä¸ç®—æ˜¯Service Workerä¸­çš„ç‰¹å®šé—®é¢˜ï¼Œè§£å†³æ–¹å¼å’Œå¤„ç†ä¸€èˆ¬çš„è·¨åŸŸé—®é¢˜ç±»ä¼¼ï¼Œå¯ä»¥è®¾ç½®`Access-Control-Allow-Origin`å“åº”å¤´æ¥è§£å†³ã€‚\r\n\r\n- å¦‚æœä½¿ç”¨CDNï¼Œå¯ä»¥åœ¨CDNæœåŠ¡ä¸­è¿›è¡Œé…ç½®ã€‚ä¸€èˆ¬çš„CDNæœåŠ¡æ˜¯ä¼šæ”¯æŒé…ç½®HTTPå“åº”å¤´çš„ï¼›\r\n- å¦‚æœä½¿ç”¨è‡ªå·±æ­å»ºçš„é™æ€æœåŠ¡å™¨é›†ç¾¤ï¼Œå¯ä»¥å¯¹æœåŠ¡å™¨è¿›è¡Œç›¸åº”é…ç½®ã€‚è¿™é‡Œæœ‰ä¸€ä¸ª[ä»“åº“](https://github.com/h5bp/server-configs)åŒ…å«ngixã€apacheã€iisç­‰å¸¸ç”¨æœåŠ¡å™¨çš„é…ç½®ï¼Œå¯ä»¥å‚è€ƒã€‚\r\n\r\n## 3. iOS standalone æ¨¡å¼\r\n\r\n> iOS standaloneæ¨¡å¼ä¸‹çš„ç‰¹æ®Šå¤„ç†\r\n\r\n### 3.1. é‡åˆ°çš„é—®é¢˜\r\n\r\nä»Šå¹´å¹´åˆAppleå®£å¸ƒåœ¨iOS safari 11.3ä¸­æ”¯æŒService Workerï¼Œè¿™å¯¹PWAçš„æ¨å¹¿èµ·åˆ°äº†é‡è¦çš„ä½œç”¨ï¼Œè®©æˆ‘ä»¬å¯ä»¥â€œè·¨å¹³å°â€æ¥å®ç°PWAæŠ€æœ¯ã€‚\r\n\r\nè™½ç„¶ï¼ŒiOS safariä¸æ”¯æŒmanifesté…ç½®æ¥å®ç°æ·»åŠ åˆ°æ¡Œé¢ï¼Œä½†æ˜¯æˆ‘åœ¨ã€Šã€PWAå­¦ä¹ ä¸å®è·µã€‘(2) ä½¿ç”¨Manifestï¼Œè®©ä½ çš„WebAppæ›´â€œNativeâ€ã€‹ä¸­ä»‹ç»äº†å¦‚ä½•ç”¨safariè‡ªæœ‰çš„metaæ ‡ç­¾æ¥å®ç°standaloneæ¨¡å¼ã€‚\r\n\r\nä¸è¿‡ï¼Œé—®é¢˜å°±å‡ºåœ¨äº†standaloneæ¨¡å¼ä¸Šã€‚æŠ›å¼€iOS safari standaloneæ¨¡å¼ç°æœ‰çš„ä¸€äº›å…¶ä»–å°bugï¼ˆåŒ…æ‹¬çŠ¶æ€æ çš„æ˜¾ç¤ºã€ç™½å±ã€é‡å¤æ·»åŠ ç­‰ï¼‰ï¼ŒiOS safari standaloneæ¨¡å¼æœ‰ä¸€ä¸ªæ— æ³•å›é¿çš„é‡å¤§é—®é¢˜ã€‚å…¶æºäºiOSä¸androidçš„ä¸€ä¸ªé‡è¦åŒºåˆ«ï¼š\r\n\r\niOSæ²¡æœ‰åé€€é”®ï¼Œè€Œä¸€èˆ¬androidæœºéƒ½æœ‰ã€‚\r\n\r\nåœ¨iOSä¸Šä½¿ç”¨standaloneæ¨¡å¼æ·»åŠ çš„åº”ç”¨ï¼Œç”±äºæ²¡æœ‰æµè§ˆå™¨çš„å·¥å…·æ ï¼Œæ‰€ä»¥æ— æ³•è¿›è¡Œåé€€ã€‚ä¾‹å¦‚æˆ‘æ‰“å¼€é¦–é¡µï¼Œç„¶åç‚¹å‡»é¦–é¡µè¯¾ç¨‹åˆ—è¡¨ä¸­çš„ä¸€é—¨è¯¾ç¨‹åï¼Œæµè§ˆå™¨è·³è½¬åˆ°è¯¾ç¨‹é¡µï¼Œç”±äºiOSæ²¡æœ‰åé€€é”®ï¼Œæ‰€ä»¥ä½ æ— æ³•å†å›åˆ°é¦–é¡µï¼Œé™¤éæ€æ­»â€œåº”ç”¨â€é‡æ–°å¯åŠ¨ã€‚\r\n\r\n### 3.2. äº§ç”Ÿçš„åŸå› \r\n\r\næ­£å¦‚ä¸Šé¢æ‰€æåˆ°çš„ï¼Œç”±äºiOSæ²¡æœ‰åé€€é”®ï¼Œè€Œstandaloneæ¨¡å¼ä¼šéšè—æµè§ˆå™¨å·¥å…·æ¡å’Œå¯¼èˆªæ¡ï¼Œå› æ­¤ï¼Œåœ¨iOSä¸­ä½¿ç”¨ä¿å­˜åˆ°æ¡Œé¢çš„WebAppï¼Œå°±åƒæ˜¯ä¸€æ¬¡ä¸èƒ½å›å¤´çš„æ—…è¡Œâ€¦â€¦\r\n\r\n### 3.3. è§£å†³æ–¹æ¡ˆ\r\n\r\næ˜¾ç„¶ï¼Œè¿™ç§ä½“éªŒæ˜¯æ— æ³•æ¥å—çš„ã€‚ç›®å‰æˆ‘é‡‡ç”¨çš„è§£å†³æ–¹æ¡ˆéå¸¸ç®€å•ï¼Œåœ¨æ‰“å¼€é¡µé¢æ—¶è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯iOSä¸­çš„standaloneæ¨¡å¼ï¼Œåˆ™åœ¨é¡µé¢å³ä¸Šè§’æ˜¾ç¤ºä¸€ä¸ªâ€œè¿”å›â€å°å›¾æ ‡ã€‚ç‚¹å‡»å›¾æ ‡è¿”å›ä¸Šä¸€ä¸ªé¡µé¢ã€‚\r\n\r\niOSä¸­æœ‰ä¸€ä¸ªä¸“é—¨çš„å±æ€§æ¥åˆ¤æ–­æ˜¯å¦ä¸ºstandaloneæ¨¡å¼ï¼š\r\n\r\n```javascript\r\nif ('standalone' in window.navigator && window.navigator.standalone) {\r\n    // standaloneæ¨¡å¼è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œä¾‹å¦‚å±•ç¤ºè¿”å›æŒ‰é’®\r\n    backBtn.show();\r\n}\r\n```\r\n\r\nä½¿ç”¨history APIå³å¯å®ç°æŒ‰é’®çš„åé€€åŠŸèƒ½ï¼š\r\n\r\n```javascript\r\nbackBtn.addEventListener('click', function () {\r\n    window.history.back();\r\n});\r\n```\r\n\r\n## 4. å›¾ç‰‡ç­–ç•¥\r\n\r\n> è§£å†³PWAç¦»çº¿èµ„æºä¸­éç¼“å­˜å›¾ç‰‡èµ„æºçš„å±•ç¤º\r\n\r\n### 4.1. é‡åˆ°çš„é—®é¢˜\r\nåœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œä¸ºäº†æ»¡è¶³ä¸€å®šçš„ç¦»çº¿åŠŸèƒ½ï¼Œæˆ‘ç¼“å­˜äº†ä¸€äº›å˜åŒ–é¢‘ç‡æå°çš„APIæ•°æ®ï¼Œä¾‹å¦‚ä¸ªäººä¸­å¿ƒé‡Œçš„åˆ—è¡¨ä¿¡æ¯ã€‚è€Œåˆ—è¡¨ä¸­åŒ…å«äº†è¾ƒå¤šçš„å›¾ç‰‡ã€‚ä¸ºäº†èŠ‚çœäº†ç”¨æˆ·çš„å­˜å‚¨ç©ºé—´ï¼Œå¯¹äºå›¾ç‰‡èµ„æºæˆ‘å¹¶æœªé€‰æ‹©ç¼“å­˜ã€‚\r\n\r\nè¿™å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ï¼šç¦»çº¿æƒ…å†µä¸‹ï¼Œè™½ç„¶ç”¨æˆ·èƒ½æ­£å¸¸çœ‹åˆ°åˆ—è¡¨ä¿¡æ¯ï¼Œä½†æ˜¯å…¶ä¸­çš„å›¾ç‰‡éƒ¨åˆ†éƒ½æ˜¯ç±»ä¼¼ä¸‹é¢è¿™ç§â€œå›¾è£‚äº†â€çš„æƒ…å†µï¼Œä½“éªŒä¸å¤ªå¥½ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/25/16397f563295ef0e?w=1422&h=470&f=png&s=27924)\r\n\r\n### 4.2. äº§ç”Ÿçš„åŸå› \r\n\r\nåŸå› ä¸Šé¢å·²ç»è§£é‡Šäº†ï¼Œç¦»çº¿çŠ¶æ€ä¸‹æ— æ³•è¯·æ±‚åˆ°å›¾ç‰‡èµ„æºï¼Œæ‰€ä»¥åœ¨ä¸€äº›æµè§ˆå™¨ä¸­å°±ä¼šè¡¨ç°å‡ºè¿™ç§â€œå›¾æŒ‚äº†â€çš„çŠ¶æ€ã€‚\r\n\r\n### 4.3. è§£å†³æ–¹æ¡ˆ\r\n\r\nè§£å†³è¿™ä¸ªä½“éªŒé—®é¢˜çš„å¤§è‡´æ€è·¯å¦‚ä¸‹ï¼š\r\n\r\n1. é¦–å…ˆï¼Œéœ€è¦åœ¨æœ¬åœ°ç¼“å­˜å ä½å›¾èµ„æº\r\n2. å…¶æ¬¡ï¼Œåœ¨è·å–å›¾ç‰‡æ—¶åˆ¤æ–­æ˜¯å¦å‡ºç°é”™è¯¯\r\n3. æœ€åï¼Œåœ¨é”™è¯¯æ—¶ä½¿ç”¨å ä½å›¾è¿›è¡Œæ›¿æ¢\r\n\r\nç”±äºåªæ˜¯ç¼“å­˜å ä½å›¾ï¼Œè€Œå ä½å›¾ä¸€èˆ¬è¾ƒä¸ºå›ºå®šï¼Œåªä¼šæœ‰æœ‰é™çš„å‡ ç§å°ºå¯¸æ ·å¼ï¼Œå› æ­¤ä¸ä¼šäº§ç”Ÿå¤ªå¤šç¼“å­˜ç©ºé—´çš„å ç”¨ã€‚å ä½å›¾çš„ç¼“å­˜å®Œå…¨å¯ä»¥åœ¨ç¼“å­˜é™æ€èµ„æºæ—¶ä¸€èµ·è¿›è¡Œã€‚\r\n\r\nè€Œå›¾ç‰‡è·å–å‡ºé”™ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œåŸå› ï¼Œä¹Ÿå¯èƒ½æ˜¯URLé”™è¯¯ï¼‰æ—¶ï¼Œè¿›è¡Œå ä½å›¾çš„æ›¿æ¢æœ‰ä¸¤ç§ç®€å•çš„æ–¹å¼ï¼š\r\n\r\n**æ–¹æ³•ä¸€ï¼šåœ¨fetchäº‹ä»¶ä¸­ç›‘å¬å›¾ç‰‡èµ„æºï¼Œå‡ºé”™æ—¶ä½¿ç”¨å ä½å›¾**\r\n\r\n```javascript\r\nself.addEventListener('fetch', e => {\r\n    if (/\\.png|jpeg|jpg|gif/i.test(e.request.url)) {\r\n        e.respondWith(\r\n            fetch(e.request).then(response => {\r\n                return response;\r\n            }).catch(err => {\r\n                // è¯·æ±‚é”™è¯¯æ—¶ä½¿ç”¨å ä½å›¾\r\n                return caches.match(placeholderPic).then(cache => cache);\r\n            })\r\n        );\r\n        return;\r\n    }\r\n```\r\n\r\n**æ–¹æ³•äºŒï¼šé€šè¿‡imgæ ‡ç­¾çš„onerrorå±æ€§æ¥è¯·æ±‚å ä½å›¾**\r\n\r\nå…ˆå°†imgæ ‡ç­¾æ”¹ä¸º\r\n\r\n```HTML\r\n<img class=\"list-cover\"\r\n    src=\"//your.sample.com/1234.png\"\r\n    alt=\"{{ item.desc }}\"\r\n    onerror=\"javascript:this.src='https://your.sample.com/placeholder.png'\"/>   \r\n```\r\n\r\n`onerror`å±æ€§ä¸­æŒ‡å®šçš„æ–¹æ³•ä¼šåœ¨å›¾ç‰‡åŠ è½½é”™è¯¯æ—¶æ›¿æ¢`src`ï¼›åŒæ—¶æˆ‘ä»¬å°†Service Workerä¸­çš„ä»£ç è¿›è¡Œè°ƒæ•´ï¼š\r\n\r\n```javascript\r\nself.addEventListener('fetch', e => {\r\n    if (/\\.png|jpeg|jpg|gif/i.test(e.request.url)) {\r\n        e.respondWith(\r\n            fetch(e.request).then(response => {\r\n                return response;\r\n            // è§¦å‘onerroråï¼Œimgä¼šå†æ¬¡è¯·æ±‚å›¾ç‰‡placeholder.png\r\n            // ç”±äºæ— ç½‘ç»œè¿æ¥ï¼Œæ­¤fetchä¾ç„¶ä¼šå‡ºé”™\r\n            }).catch(err => {\r\n                // ç”±äºæˆ‘ä»¬äº‹å…ˆç¼“å­˜äº†placeholder.pngï¼Œè¿™é‡Œä¼šè¿”å›ç¼“å­˜ç»“æœ\r\n                return caches.match(e.request).then(cache => cache);\r\n            })\r\n        );\r\n        return;\r\n    }\r\n```\r\n\r\n## 5. å†™åœ¨æœ€å\r\n\r\næœ¬æ–‡æ€»ç»“äº†ä¸€äº›æˆ‘åœ¨è¿›è¡ŒPWAå‡çº§å®è·µä¸­é‡åˆ°çš„é—®é¢˜ï¼Œå¸Œæœ›å¯¹é‡åˆ°ç±»ä¼¼é—®é¢˜çš„æœ‹å‹èƒ½å¤Ÿæœ‰ä¸€äº›å¯å‘æˆ–å¸®åŠ©ã€‚\r\n\r\nåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä¼šå›åˆ°PWAç›¸å…³æŠ€æœ¯ï¼Œä»‹ç»Resource Hintï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨Resource Hintæ¥æé«˜é¡µé¢çš„åŠ è½½æ€§èƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚\r\n\r\n## å‚è€ƒèµ„æ–™\r\n### Service Worker Scope\r\n- [Service Worker Scope (MDN)](https://developer.mozilla.org/zh-CN/docs/Web/API/ServiceWorkerContainer/register#%E5%8F%82%E6%95%B0)\r\n- [Understanding Service Worker scope](https://stackoverflow.com/questions/35780397/understanding-service-worker-scope)\r\n- [How exactly add â€œService-Worker-Allowedâ€ to register service worker scope in upper folder](https://stackoverflow.com/questions/49084718/how-exactly-add-service-worker-allowed-to-register-service-worker-scope-in-upp)\r\n\r\n### CORS\r\n- [What limitations apply to opaque responses?](https://stackoverflow.com/questions/39109789/what-limitations-apply-to-opaque-responses)\r\n- [Handle Third Party Requests](https://developers.google.com/web/tools/workbox/guides/handle-third-party-requests)\r\n- [CORS settings attributes](https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_settings_attributes)\r\n- [Cross-Origin Resource Sharing (CORS)](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)\r\n- [Git Repo: server configs](https://github.com/h5bp/server-configs)\r\n\r\n### iOS standalone\r\n- [Donâ€™t use iOS meta tags irresponsibly in your Progressive Web Apps](https://medium.com/@firt/dont-use-ios-web-app-meta-tag-irresponsibly-in-your-progressive-web-apps-85d70f4438cb)\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/9","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/9/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/9/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/9/events","html_url":"https://github.com/alienzhou/blog/issues/9","id":390622897,"node_id":"MDU6SXNzdWUzOTA2MjI4OTc=","number":9,"title":"ã€PWAå­¦ä¹ ä¸å®è·µã€‘(8)ä½¿ç”¨Service Workerè¿›è¡Œåå°åŒæ­¥ - Background Sync","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845017,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE3","url":"https://api.github.com/repos/alienzhou/blog/labels/PWA","name":"PWA","color":"008672","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T10:52:49Z","updated_at":"2018-12-13T10:52:49Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« å·²æ•´ç†è‡³[gitbook - PWAå­¦ä¹ æ‰‹å†Œ](https://alienzhou.gitbook.io/learning-pwa/)ï¼Œæ–‡å­—å†…å®¹å·²åŒæ­¥è‡³[learning-pwa-ebook](https://github.com/alienzhou/learning-pwa-ebook)ã€‚è½¬è½½è¯·æ³¨æ˜ä½œè€…ä¸å‡ºå¤„ã€‚\r\n\r\næœ¬æ–‡æ˜¯ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—çš„ç¬¬å…«ç¯‡æ–‡ç« ã€‚æœ¬æ–‡ä¸­çš„ä»£ç å¯ä»¥åœ¨[learning-pwaçš„syncåˆ†æ”¯](https://github.com/alienzhou/learning-pwa/tree/sync)ä¸Šæ‰¾åˆ°ï¼ˆ`git clone`åæ³¨æ„åˆ‡æ¢åˆ°syncåˆ†æ”¯ï¼‰ã€‚\r\n\r\nPWAä½œä¸ºæ—¶ä¸‹æœ€ç«çƒ­çš„æŠ€æœ¯æ¦‚å¿µä¹‹ä¸€ï¼Œå¯¹æå‡Webåº”ç”¨çš„å®‰å…¨ã€æ€§èƒ½å’Œä½“éªŒæœ‰ç€å¾ˆå¤§çš„æ„ä¹‰ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å»äº†è§£ä¸å­¦ä¹ ã€‚å¯¹PWAæ„Ÿå…´è¶£çš„æœ‹å‹æ¬¢è¿å…³æ³¨ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« ã€‚\r\n\r\n\r\n## 1. å¼•è¨€\r\nç”Ÿæ´»ä¸­ç»å¸¸ä¼šæœ‰è¿™æ ·çš„åœºæ™¯ï¼š\r\n\r\nç”¨æˆ·æ‹¿å‡ºæ‰‹æœºï¼Œæµè§ˆç€æˆ‘ä»¬çš„ç½‘ç«™ï¼Œå‘ç°äº†ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ä¿¡æ¯ï¼Œç‚¹å‡»äº†â€œæäº¤â€æŒ‰é’®ã€‚ç„¶è€Œä¸å¹¸çš„æ˜¯ï¼Œè¿™æ—¶ç”¨æˆ·åˆ°äº†ä¸€ä¸ªç½‘ç»œç¯å¢ƒæå·®çš„åœ°æ–¹ï¼Œæˆ–è€…æ˜¯æ ¹æœ¬æ²¡æœ‰ç½‘ç»œã€‚ä»–èƒ½å¤Ÿåšçš„åªæœ‰çœ‹ç€é¡µé¢ä¸Šçš„æç¤ºæ¡†å’Œä¸æ–­æ—‹è½¬çš„ç­‰å¾…å°åœ†åœˆã€‚1sã€5sã€30sã€1minâ€¦â€¦æ— å°½çš„ç­‰å¾…åï¼Œç”¨æˆ·å°†æ‰‹æœºæ”¾å›äº†å£è¢‹ï¼Œè€Œè¿™ä¸€æ¬¡çš„è¯·æ±‚ä¹Ÿè¢«ç»ˆæ­¢äº†â€”â€”ç”±äºå½“ä¸‹æå·®çš„ç½‘ç»œç»ˆæ­¢åœ¨äº†å®¢æˆ·ç«¯ã€‚\r\n\r\nä¸Šé¢çš„åœºæ™¯å…¶å®æš´éœ²äº†ä¸¤ä¸ªé—®é¢˜ï¼š\r\n\r\n1. æ™®é€šçš„é¡µé¢å‘èµ·çš„è¯·æ±‚ä¼šéšç€æµè§ˆå™¨è¿›ç¨‹çš„ç»“æŸ/æˆ–è€…Tabé¡µé¢çš„å…³é—­è€Œç»ˆæ­¢ï¼›\r\n2. æ— ç½‘ç¯å¢ƒä¸‹ï¼Œæ²¡æœ‰ä¸€ç§æœºåˆ¶èƒ½â€œç»´æŒâ€ä½è¯¥è¯·æ±‚ï¼Œä»¥å¾…æœ‰ç½‘æƒ…å†µä¸‹å†è¿›è¡Œè¯·æ±‚ã€‚\r\n\r\nç„¶è€Œï¼ŒService Workerçš„åå°åŒæ­¥åŠŸèƒ½è§„é¿äº†è¿™äº›ç¼ºé™·ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/13/163598ca174364ed?w=800&h=499&f=gif&s=2269837)\r\n\r\nä¸‹é¢å°±è®©æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹åå°åŒæ­¥ï¼ˆBackground Syncï¼‰çš„å·¥ä½œåŸç†ã€‚\r\n\r\n## 2. åå°åŒæ­¥(Background Sync)æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ\r\n\r\nåå°åŒæ­¥åº”è¯¥ç®—æ˜¯Service Workerç›¸å…³åŠŸèƒ½ï¼ˆAPIï¼‰ä¸­æ¯”è¾ƒæ˜“äºç†è§£ä¸ä½¿ç”¨çš„ä¸€ä¸ªã€‚\r\n\r\nå…¶å¤§è‡´çš„æµç¨‹å¦‚ä¸‹ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/13/1635905056b125a7?w=573&h=129&f=png&s=8623)\r\n\r\n1. é¦–å…ˆï¼Œä½ éœ€è¦åœ¨Service Workerä¸­ç›‘å¬syncäº‹ä»¶ï¼›\r\n2. ç„¶åï¼Œåœ¨æµè§ˆå™¨ä¸­å‘èµ·åå°åŒæ­¥syncï¼ˆå›¾ä¸­ç¬¬ä¸€æ­¥ï¼‰ï¼›\r\n3. ä¹‹åï¼Œä¼šè§¦å‘Service Workerçš„syncäº‹ä»¶ï¼Œåœ¨è¯¥ç›‘å¬çš„å›è°ƒä¸­è¿›è¡Œæ“ä½œï¼Œä¾‹å¦‚å‘åç«¯å‘èµ·è¯·æ±‚ï¼ˆå›¾ä¸­ç¬¬äºŒæ­¥ï¼‰\r\n4. æœ€åï¼Œå¯ä»¥åœ¨Service Workerä¸­å¯¹æœåŠ¡ç«¯è¿”å›çš„æ•°æ®è¿›è¡Œå¤„ç†ã€‚\r\n\r\nç”±äºService Workeråœ¨ç”¨æˆ·å…³é—­è¯¥ç½‘ç«™åä»å¯ä»¥è¿è¡Œï¼Œå› æ­¤è¯¥æµç¨‹åä¸ºâ€œåå°åŒæ­¥â€å®åœ¨æ˜¯éå¸¸è´´åˆ‡ã€‚\r\n\r\næ€ä¹ˆæ ·ï¼Œåœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€å®šçš„Service WorkeråŸºç¡€ä¹‹åï¼Œåå°åŒæ­¥è¿™ä¸€åŠŸèƒ½ç›¸æ¯”ä¹‹å‰çš„åŠŸèƒ½ï¼Œæ˜¯ä¸æ˜¯éå¸¸æ˜“äºç†è§£ï¼Ÿ\r\n\r\n## 3. å¦‚ä½•ä½¿ç”¨åå°åŒæ­¥åŠŸèƒ½ï¼Ÿ\r\n\r\næ—¢ç„¶å·²ç»ç†è§£äº†è¯¥åŠŸèƒ½çš„å¤§è‡´æµç¨‹ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬æ¥å®é™…æ“ä½œä¸€ä¸‹å§ã€‚\r\n\r\n### 3.1 clientè§¦å‘syncäº‹ä»¶\r\n\r\n```javascript\r\n// index.js\r\nnavigator.serviceWorker.ready.then(function (registration) {\r\n    var tag = \"sample_sync\";\r\n    document.getElementById('js-sync-btn').addEventListener('click', function () {\r\n        registration.sync.register(tag).then(function () {\r\n            console.log('åå°åŒæ­¥å·²è§¦å‘', tag);\r\n        }).catch(function (err) {\r\n            console.log('åå°åŒæ­¥è§¦å‘å¤±è´¥', err);\r\n        });\r\n    });\r\n});\r\n```\r\nç”±äºåå°åŒæ­¥åŠŸèƒ½éœ€è¦åœ¨Service Workeræ³¨å†Œå®Œæˆåè§¦å‘ï¼Œå› æ­¤è¾ƒå¥½çš„ä¸€ä¸ªæ–¹å¼æ˜¯åœ¨`navigator.serviceWorker.ready`ä¹‹åç»‘å®šç›¸å…³æ“ä½œã€‚ä¾‹å¦‚ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨readyåç»‘å®šäº†æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ã€‚å½“æŒ‰é’®è¢«ç‚¹å‡»åï¼Œä¼šä½¿ç”¨`registration.sync.register()`æ–¹æ³•æ¥è§¦å‘Service Workerçš„syncäº‹ä»¶ã€‚\r\n\r\n`registration.sync`è¿”å›ä¸€ä¸ª[`SyncManager`å¯¹è±¡](https://developer.mozilla.org/en-US/docs/Web/API/SyncManager)ï¼Œå…¶ä¸ŠåŒ…å«`register`å’Œ`getTags`ä¸¤ä¸ªæ–¹æ³•ï¼š\r\n\r\n> `register()` Create a new sync registration and return a Promise. \r\n\r\n> `getTags()` Return a list of developer-defined identifiers for SyncManager registration.\r\n\r\n`register()`æ–¹æ³•å¯ä»¥æ³¨å†Œä¸€ä¸ªåå°åŒæ­¥äº‹ä»¶ï¼Œå…¶ä¸­æ¥æ”¶çš„å‚æ•°`tag`ç”¨äºä½œä¸ºè¿™ä¸ªåå°åŒæ­¥çš„å”¯ä¸€æ ‡è¯†ã€‚\r\n\r\nå½“ç„¶ï¼Œå¦‚æœæƒ³è¦ä»£ç æ›´å¥å£®çš„è¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨è°ƒç”¨å‰è¿›è¡Œç‰¹æ€§æ£€æµ‹ï¼š\r\n\r\n```javascript\r\n// index.js\r\nif ('serviceWorker' in navigator && 'SyncManager' in window) {\r\n    // â€¦â€¦\r\n}\r\n```\r\n\r\n### 3.2 åœ¨Service Workerä¸­ç›‘å¬syncäº‹ä»¶\r\nå½“clientè§¦å‘äº†syncäº‹ä»¶åï¼Œå‰©ä¸‹çš„å°±äº¤ç»™Service Workerã€‚ç†è®ºä¸Šæ­¤æ—¶å°±ä¸éœ€è¦clientï¼ˆå‰ç«¯ç«™ç‚¹ï¼‰å‚ä¸äº†ã€‚ä¾‹å¦‚å¦ä¸€ä¸ªç»å…¸åœºæ™¯ï¼šç”¨æˆ·ç¦»å¼€æ—¶é¡µé¢ï¼ˆunloadï¼‰æ—¶åœ¨clientç«¯è§¦å‘syncäº‹ä»¶ï¼Œå‰©ä¸‹çš„æ“ä½œäº¤ç»™Service Workerï¼ŒService Workerçš„æ“ä½œå¯ä»¥åœ¨ç¦»å¼€é¡µé¢åæ­£å¸¸è¿›è¡Œã€‚\r\n\r\nåƒæ·»åŠ fetchå’Œpushäº‹ä»¶ç›‘å¬é‚£æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºService Workeræ·»åŠ syncäº‹ä»¶çš„ç›‘å¬ï¼š\r\n\r\n```javascript\r\n// sw.js\r\nself.addEventListener('sync', function (e) {\r\n    // â€¦â€¦\r\n});\r\n```\r\n\r\nåœ¨syncäº‹ä»¶çš„eventå¯¹è±¡ä¸Šå¯ä»¥å–åˆ°tagå€¼ï¼Œè¯¥å€¼å°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚æ³¨å†Œsyncæ—¶çš„å”¯ä¸€æ ‡è¯†ã€‚é€šè¿‡è¿™ä¸ªtagå°±å¯ä»¥åŒºåˆ†å‡ºä¸åŒçš„åå°åŒæ­¥äº‹ä»¶ã€‚ä¾‹å¦‚ï¼Œå½“è¯¥å€¼ä¸º'sample_sync'æ—¶æˆ‘ä»¬å‘åç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ï¼š\r\n\r\n```javascript\r\n// sw.js\r\nself.addEventListener('sync', function (e) {\r\n    console.log(`service workeréœ€è¦è¿›è¡Œåå°åŒæ­¥ï¼Œtag: ${e.tag}`);\r\n    var init = {\r\n        method: 'GET'\r\n    };\r\n    if (e.tag === 'sample_sync') {\r\n        var request = new Request(`sync?name=AlienZHOU`, init);\r\n        e.waitUntil(\r\n            fetch(request).then(function (response) {\r\n                response.json().then(console.log.bind(console));\r\n                return response;\r\n            })\r\n        );\r\n    }\r\n});\r\n```\r\nè¿™é‡Œæˆ‘é€šè¿‡`e.tag`æ¥åˆ¤æ–­clientè§¦å‘çš„ä¸åŒsyncäº‹ä»¶ï¼Œå¹¶åœ¨ç›‘å¬åˆ°tagä¸º'sample_sync'çš„syncäº‹ä»¶åï¼Œæ„å»ºäº†ä¸€ä¸ªrequestå¯¹è±¡ï¼Œä½¿ç”¨fetch APIæ¥è¿›è¡Œåç«¯è¯·æ±‚ã€‚\r\n\r\néœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œfetchè¯·æ±‚ä¸€å®šè¦æ”¾åœ¨`e.waitUntil()`å†…ã€‚å› ä¸ºæˆ‘ä»¬è¦ä¿è¯â€œåå°åŒæ­¥â€ï¼Œå°†Promiseå¯¹è±¡æ”¾åœ¨`e.waitUntil()`å†…å¯ä»¥ç¡®ä¿åœ¨ç”¨æˆ·ç¦»å¼€æˆ‘ä»¬çš„ç½‘ç«™åï¼ŒService Workerä¼šæŒç»­åœ¨åå°è¿è¡Œï¼Œç­‰å¾…è¯¥è¯·æ±‚å®Œæˆã€‚\r\n\r\n### 3.3 å®Œå–„æˆ‘ä»¬çš„åç«¯æœåŠ¡\r\nå®é™…ä¸Šï¼Œç»è¿‡ä¸Šé¢ä¸¤å°èŠ‚ï¼Œæˆ‘ä»¬çš„å¤§è‡´å·¥ä½œå·²ç»å®Œæˆã€‚ä¸è¿‡è¿˜ç¼ºå°‘ä¸€ä¸ªå°ç¯èŠ‚ï¼šæˆ‘ä»¬çš„KOAæœåŠ¡å™¨ä¸Šè¿˜æ²¡æœ‰syncè·¯ç”±å’Œæ¥å£ã€‚æ·»åŠ ä¸€ä¸‹ï¼Œä»¥ä¿è¯demoå¯ä»¥æ­£å¸¸è¿è¡Œï¼š\r\n\r\n```javascript\r\n// app.js\r\nrouter.get('/sync', async (ctx, next) => {\r\n    console.log(`Hello ${ctx.request.query.name}, I have received your msg`);\r\n    ctx.response.body = {\r\n        status: 0\r\n    };\r\n});\r\n```\r\n\r\n### 3.4 Demoæ•ˆæœå±•ç¤º\r\n\r\nä¸‹é¢å°±æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªdemoçš„è¿è¡Œæ•ˆæœï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/13/1635975104e68836?w=800&h=499&f=gif&s=1947627)\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç½‘ç»œç¯å¢ƒæ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œç‚¹å‡»â€œåŒæ­¥â€æŒ‰é’®ä¼šç«‹å³è§¦å‘Service Workerä¸­çš„syncäº‹ä»¶ç›‘å¬ï¼Œå¹¶å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼›è€Œåœ¨æ–­ç½‘æƒ…å†µä¸‹ï¼Œç‚¹å‡»â€œåŒæ­¥â€æŒ‰é’®ï¼Œæ§åˆ¶å°è™½ç„¶æ˜¾ç¤ºæ³¨å†Œäº†åŒæ­¥äº‹ä»¶ï¼Œä½†æ˜¯å¹¶ä¸ä¼šè§¦å‘Service Workerçš„syncç›‘å¬å›è°ƒï¼ŒæŒ‡åˆ°æ¢å¤ç½‘ç»œè¿æ¥ï¼Œæ‰ä¼šåœ¨åå°ï¼ˆService Workerï¼‰ä¸­è¿›è¡Œç›¸å…³å¤„ç†ã€‚\r\n\r\nä¸‹é¢å†æ¥çœ‹ä¸€ä¸‹è§¦å‘syncäº‹ä»¶åï¼Œå…³é—­ç½‘ç«™çš„æ•ˆæœï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/13/163598ca174364ed?w=800&h=499&f=gif&s=2269837)\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿åœ¨å…³é—­ç½‘ç«™åå†é‡æ–°è¿æ¥ç½‘ç»œï¼ŒæœåŠ¡ç«¯ä¾ç„¶å¯ä»¥æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼ˆè¯´æ˜Service Workeråœ¨åå°è¿›è¡Œäº†ç›¸å…³å¤„ç†ï¼‰ã€‚\r\n\r\n## 4. å¦‚ä½•åœ¨åå°åŒæ­¥æ—¶è·å–æ‰€éœ€çš„æ•°æ®ï¼Ÿ\r\n\r\nå…¶å®ä¸Šä¸€èŠ‚ç»“æŸï¼Œæˆ‘ä»¬å°±å·²ç»å¯ä»¥äº†è§£æœ€åŸºç¡€çš„åå°åŒæ­¥åŠŸèƒ½äº†ã€‚è€Œè¿™éƒ¨åˆ†åˆ™ä¼šè¿›ä¸€æ­¥æ¢è®¨åå°åŒæ­¥ä¸­çš„ä¸€ä¸ªé‡è¦é—®é¢˜ï¼šå¦‚ä½•åœ¨åå°åŒæ­¥æ—¶è·å–å¹¶å‘é€clientä¸­çš„æ•°æ®ï¼Ÿ\r\n\r\nä¾‹å¦‚åœ¨æˆ‘ä»¬çš„ä¸Šä¸€ä¸ªDemoä¸­ï¼Œç”¨æˆ·çš„å§“ånameæ˜¯ç¡¬ç¼–ç åœ¨Service Workerä¸­çš„ï¼Œè€Œå®é™…ä¸Šï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½åœ¨é¡µé¢ä¸Šæä¾›ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œå°†ç”¨æˆ·çš„è¾“å…¥å†…å®¹åœ¨åå°åŒæ­¥ä¸­è¿›è¡Œå‘é€ã€‚\r\n\r\nå®ç°çš„æ–¹å¼æœ‰ä¸¤ç§ï¼šä½¿ç”¨postMessageæˆ–ä½¿ç”¨indexedDBã€‚\r\n\r\n### 4.1 ä½¿ç”¨postMessage\r\n\r\næˆ‘ä»¬çŸ¥é“ï¼Œåœ¨æµè§ˆå™¨ä¸»çº¿ç¨‹ä¸Web Workerçº¿ç¨‹ä¹‹é—´å¯ä»¥é€šè¿‡postMessageæ¥è¿›è¡Œé€šä¿¡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ¥å‘Service Workerâ€œä¼ è¾“â€æ•°æ®ã€‚\r\n\r\nå¤§è‡´æ€è·¯å¦‚ä¸‹ï¼š\r\n\r\n1. clientè§¦å‘syncäº‹ä»¶ï¼›\r\n2. åœ¨syncæ³¨å†Œå®Œæˆåï¼Œä½¿ç”¨postMessageå’ŒService Workeré€šä¿¡ï¼›\r\n3. åœ¨Service Workerçš„syncäº‹ä»¶å›è°ƒä¸­ç­‰å¾…messageäº‹ä»¶çš„æ¶ˆæ¯ï¼›\r\n4. æ”¶åˆ°messageäº‹ä»¶çš„æ¶ˆæ¯åï¼Œå°†å…¶ä¸­çš„ä¿¡æ¯æäº¤åˆ°æœåŠ¡ç«¯ã€‚\r\n\r\n```javascript\r\n// index.js\r\n// ä½¿ç”¨postMessageæ¥ä¼ è¾“syncæ•°æ®\r\nnavigator.serviceWorker.ready.then(function (registration) {\r\n    var tag = 'sample_sync_event';\r\n\r\n    document.getElementById('js-sync-event-btn').addEventListener('click', function () {\r\n        registration.sync.register(tag).then(function () {\r\n            console.log('åå°åŒæ­¥å·²è§¦å‘', tag);\r\n\r\n            // ä½¿ç”¨postMessageè¿›è¡Œæ•°æ®é€šä¿¡\r\n            var inputValue = document.querySelector('#js-search-input').value;\r\n            var msg = JSON.stringify({type: 'bgsync', msg: {name: inputValue}});\r\n            navigator.serviceWorker.controller.postMessage(msg);\r\n        }).catch(function (err) {\r\n            console.log('åå°åŒæ­¥è§¦å‘å¤±è´¥', err);\r\n        });\r\n    });\r\n});\r\n```\r\n\r\nåœ¨`registration.sync.register`å®Œæˆåï¼Œè°ƒç”¨`navigator.serviceWorker.controller.postMessage`æ¥å‘Service Worker Postæ•°æ®ã€‚\r\n\r\nä¸ºäº†æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§ï¼Œæˆ‘åœ¨sw.jsä¸­åˆ›å»ºäº†ä¸€ä¸ª`SimpleEvent`ç±»ï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹åšä¸€ä¸ªæœ€ç®€å•çš„EventBusã€‚ç”¨æ¥è§£è€¦Service Workerçš„messageäº‹ä»¶å’Œsyncäº‹ä»¶ã€‚\r\n\r\n```javascript\r\n// sw.js\r\nclass SimpleEvent {\r\n    constructor() {\r\n        this.listenrs = {};\r\n    }\r\n\r\n    once(tag, cb) {\r\n        this.listenrs[tag] || (this.listenrs[tag] = []);\r\n        this.listenrs[tag].push(cb);\r\n    }\r\n\r\n    trigger(tag, data) {\r\n        this.listenrs[tag] = this.listenrs[tag] || [];\r\n        let listenr;\r\n        while (listenr = this.listenrs[tag].shift()) {\r\n            listenr(data)\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nåœ¨messageäº‹ä»¶ä¸­ç›‘å¬clientå‘æ¥çš„æ¶ˆæ¯ï¼Œå¹¶é€šè¿‡SimpleEventé€šçŸ¥æ‰€æœ‰ç›‘å¬è€…ã€‚\r\n\r\n```javascript\r\n// sw.js\r\nconst simpleEvent = new SimpleEvent();\r\nself.addEventListener('message', function (e) {\r\n    var data = JSON.parse(e.data);\r\n    var type = data.type;\r\n    var msg = data.msg;\r\n    console.log(`service workeræ”¶åˆ°æ¶ˆæ¯ typeï¼š${type}ï¼›msgï¼š${JSON.stringify(msg)}`);\r\n\r\n    simpleEvent.trigger(type, msg);\r\n});\r\n```\r\n\r\nåœ¨syncäº‹ä»¶ä¸­ï¼Œä½¿ç”¨SimpleEventç›‘å¬bgsyncæ¥è·å–æ•°æ®ï¼Œç„¶åå†è°ƒç”¨fetchæ–¹æ³•ã€‚æ³¨æ„ï¼Œç”±äº`e.waitUntil()`éœ€è¦æ¥æ”¶Promiseä½œä¸ºå‚æ•°ï¼Œå› æ­¤éœ€è¦å¯¹`SimpleEvent.once`è¿›è¡ŒPromisfyã€‚\r\n\r\n```javascript\r\n// sw.js\r\nself.addEventListener('sync', function (e) {\r\n    if (e.tag === xxx) {\r\n        // â€¦â€¦\r\n    }\r\n\r\n    // sample_sync_eventåŒæ­¥äº‹ä»¶ï¼Œä½¿ç”¨postMessageæ¥è¿›è¡Œæ•°æ®é€šä¿¡\r\n    else if (e.tag === 'sample_sync_event') {\r\n        // å°†SimpleEvent.onceå°è£…ä¸ºPromiseè°ƒç”¨\r\n        let msgPromise = new Promise(function (resolve, reject) {\r\n            // ç›‘å¬messageäº‹ä»¶ä¸­è§¦å‘çš„äº‹ä»¶é€šçŸ¥\r\n            simpleEvent.once('bgsync', function (data) {\r\n                resolve(data);\r\n            });\r\n            // äº”ç§’è¶…æ—¶\r\n            setTimeout(resolve, 5000);\r\n        });\r\n\r\n        e.waitUntil(\r\n            msgPromise.then(function (data) {\r\n                var name = data && data.name ? data.name : 'anonymous';\r\n                var request = new Request(`sync?name=${name}`, init);\r\n                return fetch(request)\r\n            }).then(function (response) {\r\n                response.json().then(console.log.bind(console));\r\n                return response;\r\n            })\r\n        );\r\n    }\r\n});\r\n```\r\n\r\næ˜¯ä¸æ˜¯éå¸¸ç®€å•ï¼Ÿ\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/14/1635a5723bed476c?w=800&h=499&f=gif&s=2772919)\r\n\r\nè¿›è¡Œåå°åŒæ­¥æ—¶ï¼Œä½¿ç”¨postMessageæ¥å®ç°clientå‘Service Workerçš„ä¼ è¾“æ•°æ®ï¼Œæ–¹ä¾¿ä¸ç›´è§‚ï¼Œæ˜¯ä¸€ä¸ªä¸é”™çš„æ–¹æ³•ã€‚\r\n\r\n### 4.2 ä½¿ç”¨indexedDB\r\n\r\nåœ¨clientä¸Servcie Workerä¹‹é—´åŒæ­¥æ•°æ®ï¼Œè¿˜æœ‰ä¸€ä¸ªå¯è¡Œçš„æ€è·¯ï¼šclientå…ˆå°†æ•°æ®å­˜åœ¨æŸå¤„ï¼Œå¾…Servcie Workeréœ€è¦æ—¶å†è¯»å–ä½¿ç”¨å³å¯ã€‚\r\n\r\nä¸ºæ­¤éœ€è¦æ‰¾ä¸€ä¸ªå­˜æ•°æ®çš„åœ°æ–¹ã€‚ä½ ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„å¯èƒ½å°±æ˜¯localStorageäº†ã€‚\r\n\r\nç„¶è€Œï¼Œä¸çŸ¥é“ä½ æ˜¯å¦è¿˜è®°å¾—æˆ‘åœ¨æœ€å¼€å§‹ä»‹ç»Service Workeræ—¶æ‰€æåˆ°çš„ï¼Œä¸ºäº†ä¿è¯æ€§èƒ½ï¼Œå®ç°éƒ¨åˆ†æ“ä½œçš„éé˜»å¡ï¼Œåœ¨Service Workerä¸­æˆ‘ä»¬ç»å¸¸ä¼šç¢°åˆ°å¼‚æ­¥æ“ä½œï¼ˆå› æ­¤å¤§å¤šæ•°APIéƒ½æ˜¯Promiseå½¢å¼çš„ï¼‰ã€‚é‚£ä¹ˆåƒlocalStorageè¿™æ ·çš„åŒæ­¥APIä¼šå˜æˆå¼‚æ­¥åŒ–ä¹ˆï¼Ÿç­”æ¡ˆå¾ˆç®€å•ï¼šä¸ä¼šï¼Œå¹¶ä¸”localStorageåœ¨Servcie Workerä¸­æ— æ³•è°ƒç”¨ã€‚\r\n\r\nä¸è¿‡ä¸è¦æ°”é¦ï¼Œæˆ‘ä»¬è¿˜å¦ä¸€ä¸ªå¼ºå¤§çš„æ•°æ®å­˜å‚¨æ–¹å¼â€”â€”indexedDBã€‚å®ƒæ˜¯å¯ä»¥åœ¨Service Workerä¸­ä½¿ç”¨çš„ã€‚å¯¹äºindexedDBçš„ä½¿ç”¨æ–¹å¼ï¼Œæœ¬ç³»åˆ—åç»­ä¼šæœ‰æ–‡ç« å…·ä½“ä»‹ç»ï¼Œå› æ­¤åœ¨è¿™é‡Œçš„å°±ä¸é‡ç‚¹è®²è§£indexedDBçš„ä½¿ç”¨æ–¹å¼äº†ã€‚\r\n\r\né¦–å…ˆï¼Œéœ€è¦ä¸€ä¸ªæ–¹æ³•ç”¨äºè¿æ¥æ•°æ®åº“å¹¶åˆ›å»ºç›¸åº”çš„storeï¼š\r\n\r\n```javascript\r\n// index.js\r\nfunction openStore(storeName) {\r\n    return new Promise(function (resolve, reject) {\r\n        if (!('indexedDB' in window)) {\r\n            reject('don\\'t support indexedDB');\r\n        }\r\n        var request = indexedDB.open('PWA_DB', 1);\r\n        request.onerror = function(e) {\r\n            console.log('è¿æ¥æ•°æ®åº“å¤±è´¥');\r\n            reject(e);\r\n        }\r\n        request.onsuccess = function(e) {\r\n            console.log('è¿æ¥æ•°æ®åº“æˆåŠŸ');\r\n            resolve(e.target.result);\r\n        }\r\n        request.onupgradeneeded = function (e) {\r\n            console.log('æ•°æ®åº“ç‰ˆæœ¬å‡çº§');\r\n            var db = e.srcElement.result;\r\n            if (e.oldVersion === 0) {\r\n                if (!db.objectStoreNames.contains(storeName)) {\r\n                    var store = db.createObjectStore(storeName, {\r\n                        keyPath: 'tag'\r\n                    });\r\n                    store.createIndex(storeName + 'Index', 'tag', {unique: false});\r\n                    console.log('åˆ›å»ºç´¢å¼•æˆåŠŸ');\r\n                }\r\n            }\r\n        }\r\n    });\r\n}\r\n```\r\n\r\nç„¶åï¼Œåœ¨`navigator.serviceWorker.ready`ä¸­æ‰“å¼€è¯¥æ•°æ®åº“è¿æ¥ï¼Œå¹¶åœ¨ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œå…ˆå°†æ•°æ®å­˜å…¥indexedDBï¼Œå†æ³¨å†Œsyncï¼š\r\n\r\n```javascript\r\n// index.js\r\nnavigator.serviceWorker.ready.then(function (registration) {\r\n    return Promise.all([\r\n        openStore(STORE_NAME),\r\n        registration\r\n    ]);\r\n}).then(function (result) {\r\n    var db = result[0];\r\n    var registration = result[1];\r\n    var tag = 'sample_sync_db';\r\n\r\n    document.getElementById('js-sync-db-btn').addEventListener('click', function () {\r\n        // å°†æ•°æ®å­˜å‚¨è¿›indexedDB\r\n        var inputValue = document.querySelector('#js-search-input').value;\r\n        var tx = db.transaction(STORE_NAME, 'readwrite');\r\n        var store = tx.objectStore(STORE_NAME);\r\n        var item = {\r\n            tag: tag,\r\n            name: inputValue\r\n        };\r\n        store.put(item);\r\n\r\n        registration.sync.register(tag).then(function () {\r\n            console.log('åå°åŒæ­¥å·²è§¦å‘', tag);\r\n        }).catch(function (err) {\r\n            console.log('åå°åŒæ­¥è§¦å‘å¤±è´¥', err);\r\n        });\r\n    });\r\n});\r\n```\r\n\r\nåŒæ ·çš„ï¼Œåœ¨Service Workerä¸­ä¹Ÿéœ€è¦ç›¸åº”çš„æ•°æ®åº“è¿æ¥æ–¹æ³•ï¼š\r\n\r\n```javascript\r\n// sw.js\r\nfunction openStore(storeName) {\r\n    return new Promise(function (resolve, reject) {\r\n        var request = indexedDB.open('PWA_DB', 1);\r\n        request.onerror = function(e) {\r\n            console.log('è¿æ¥æ•°æ®åº“å¤±è´¥');\r\n            reject(e);\r\n        }\r\n        request.onsuccess = function(e) {\r\n            console.log('è¿æ¥æ•°æ®åº“æˆåŠŸ');\r\n            resolve(e.target.result);\r\n        }\r\n    });\r\n}\r\n```\r\n\r\nå¹¶ä¸”åœ¨syncäº‹ä»¶çš„å›è°ƒä¸­ï¼Œgetåˆ°indexedDBä¸­å¯¹åº”çš„æ•°æ®ï¼Œæœ€åå†å‘åç«¯å‘é€è¯·æ±‚ï¼š\r\n\r\n```javascript\r\n// index.js\r\nself.addEventListener('sync', function (e) {\r\n    if (e.tag === xxx) {\r\n        // â€¦â€¦\r\n    }\r\n    else if (e.tag === yyy) {\r\n        // â€¦â€¦\r\n    }\r\n    \r\n    // sample_sync_dbåŒæ­¥äº‹ä»¶ï¼Œä½¿ç”¨indexedDBæ¥è·å–éœ€è¦åŒæ­¥çš„æ•°æ®\r\n    else if (e.tag === 'sample_sync_db') {\r\n        // å°†æ•°æ®åº“æŸ¥è¯¢å°è£…ä¸ºPromiseç±»å‹çš„è¯·æ±‚\r\n        var dbQueryPromise = new Promise(function (resolve, reject) {\r\n            var STORE_NAME = 'SyncData';\r\n            // è¿æ¥indexedDB\r\n            openStore(e.tag).then(function (db) {\r\n                try {\r\n                    // åˆ›å»ºäº‹åŠ¡è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢\r\n                    var tx = db.transaction(STORE_NAME, 'readonly');\r\n                    var store = tx.objectStore(STORE_NAME);\r\n                    var dbRequest = store.get(e.tag);\r\n                    dbRequest.onsuccess = function (e) {\r\n                        resolve(e.target.result);\r\n                    };\r\n                    dbRequest.onerror = function (err) {\r\n                        reject(err);\r\n                    };\r\n                }\r\n                catch (err) {\r\n                    reject(err);\r\n                }\r\n            });\r\n        });\r\n\r\n        e.waitUntil(\r\n            // é€šè¿‡æ•°æ®åº“æŸ¥è¯¢è·å–éœ€è¦åŒæ­¥çš„æ•°æ®\r\n            dbQueryPromise.then(function (data) {\r\n                console.log(data);\r\n                var name = data && data.name ? data.name : 'anonymous';\r\n                var request = new Request(`sync?name=${name}`, init);\r\n                return fetch(request)\r\n            }).then(function (response) {\r\n                response.json().then(console.log.bind(console));\r\n                return response;\r\n            })\r\n        );\r\n    }\r\n});\r\n```\r\n\r\nç›¸æ¯”äºpostMessageï¼Œä½¿ç”¨indexedDBçš„æ–¹æ¡ˆè¦æ›´å¤æ‚ä¸€ç‚¹ã€‚å®ƒæ¯”è¾ƒé€‚ç”¨äºä¸€äº›éœ€è¦æ•°æ®æŒä¹…åŒ–çš„åœºæ™¯ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/14/1635a579ba845ce7?w=800&h=499&f=gif&s=953776)\r\n\r\n## 5. å…¼å®¹æ€§\r\n\r\nä¾ç…§æƒ¯ä¾‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ¥ç®€å•çœ‹ä¸€ä¸‹æ–‡ä¸­ç›¸å…³åŠŸèƒ½çš„å…¼å®¹æ€§ã€‚\r\n\r\nå…ˆæ˜¯[Background Sync](https://caniuse.com/#search=Background%20Sync%20API)ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/13/16359f504955c8b8?w=1240&h=592&f=png&s=134469)\r\n\r\nä»¤äººæ‚²ä¼¤çš„æ˜¯ï¼ŒåŸºæœ¬åªæœ‰Googleè‡ªå®¶çš„Chromeå¯ç”¨ã€‚\r\n\r\nç„¶åæ˜¯[indexedDB](https://caniuse.com/#search=indexedDB)ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/13/16359f671e79ba6b?w=1240&h=580&f=png&s=155435)\r\n\r\nç›¸è¾ƒäºBackground Syncè¿˜æ˜¯æœ‰ç€ä¸é”™çš„å…¼å®¹æ€§çš„ã€‚è€Œä¸”åœ¨safariï¼ˆåŒ…æ‹¬iOS safariï¼‰ä¸­ä¹Ÿå¾—åˆ°äº†æ”¯æŒã€‚\r\n\r\n## 6. å†™åœ¨æœ€å\r\nä»æ–‡ä¸­çš„å†…å®¹ä»¥åŠ[google developerä¸­çš„ä¸€äº›å®ä¾‹](https://developers.google.com/web/updates/2015/12/background-sync#the_solution)æ¥çœ‹ï¼ŒBackground Syncæ˜¯ä¸€ä¸ªéå¸¸æœ‰æ½œåŠ›çš„APIã€‚ç„¶è€Œä»¤äººå ªå¿§çš„å…¼å®¹æ€§åœ¨ä¸€å®šç¨‹åº¦ä¸Šé™åˆ¶äº†å®ƒçš„å‘æŒ¥ç©ºé—´ã€‚ä¸è¿‡ï¼Œä½œä¸ºä¸€é¡¹æŠ€æœ¯ï¼Œè¿˜æ˜¯éå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ä¸äº†è§£çš„ã€‚\r\n\r\næœ¬æ–‡ä¸­æ‰€æœ‰çš„ä»£ç ç¤ºä¾‹å‡å¯ä»¥åœ¨[learn-pwa/sync](https://github.com/alienzhou/learning-pwa/tree/sync)ä¸Šæ‰¾åˆ°ã€‚\r\n\r\nå¦‚æœä½ å–œæ¬¢æˆ–æƒ³è¦äº†è§£æ›´å¤šçš„PWAç›¸å…³çŸ¥è¯†ï¼Œæ¬¢è¿å…³æ³¨æˆ‘ï¼Œå…³æ³¨ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« ã€‚æˆ‘ä¼šæ€»ç»“æ•´ç†è‡ªå·±å­¦ä¹ PWAè¿‡ç¨‹çš„é‡åˆ°çš„ç–‘é—®ä¸æŠ€æœ¯ç‚¹ï¼Œå¹¶é€šè¿‡å®é™…ä»£ç å’Œå¤§å®¶ä¸€èµ·å®è·µã€‚\r\n\r\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†PWAä¸­çš„å¤šä¸ªçŸ¥è¯†ç‚¹ï¼Œåœ¨å…¶åŸºç¡€ä¸Šï¼Œå·²ç»å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿›è¡ŒåŸæœ‰ç«™ç‚¹çš„PWAå‡çº§ã€‚å­¦ä¹ æ˜¯ä¸€æ–¹é¢ï¼Œå®è·µæ˜¯å¦ä¸€æ–¹é¢ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä¼šæ•´ç†ä¸€äº›åœ¨ä¸šåŠ¡ä¸­å‡çº§PWAæ—¶ç¢°åˆ°çš„é—®é¢˜ï¼Œä»¥åŠå¯¹åº”çš„è§£å†³æ–¹æ¡ˆã€‚\r\n\r\n## å‚è€ƒèµ„æ–™\r\n- [Web Background Synchronization](https://wicg.github.io/BackgroundSync/spec/)\r\n- [MDN: SyncManager](https://developer.mozilla.org/en-US/docs/Web/API/SyncManager)\r\n- [MDN: SyncManager.register()](https://developer.mozilla.org/en-US/docs/Web/API/SyncManager/register)\r\n- [MDN: SyncRegistration](https://developer.mozilla.org/en-US/docs/Web/API/SyncRegistration)\r\n- [Introducing Background Sync](https://developers.google.com/web/updates/2015/12/background-sync)\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/8","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/8/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/8/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/8/events","html_url":"https://github.com/alienzhou/blog/issues/8","id":390622345,"node_id":"MDU6SXNzdWUzOTA2MjIzNDU=","number":8,"title":"ã€PWAå­¦ä¹ ä¸å®è·µã€‘(7)ä½¿ç”¨Notification APIæ¥è¿›è¡Œæ¶ˆæ¯æé†’","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845017,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE3","url":"https://api.github.com/repos/alienzhou/blog/labels/PWA","name":"PWA","color":"008672","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T10:51:21Z","updated_at":"2018-12-13T10:51:45Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« å·²æ•´ç†è‡³[gitbook - PWAå­¦ä¹ æ‰‹å†Œ](https://alienzhou.gitbook.io/learning-pwa/)ï¼Œæ–‡å­—å†…å®¹å·²åŒæ­¥è‡³[learning-pwa-ebook](https://github.com/alienzhou/learning-pwa-ebook)ã€‚è½¬è½½è¯·æ³¨æ˜ä½œè€…ä¸å‡ºå¤„ã€‚\r\n\r\næœ¬æ–‡æ˜¯ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—çš„ç¬¬ä¸ƒç¯‡æ–‡ç« ã€‚\r\n\r\nPWAä½œä¸ºæ—¶ä¸‹æœ€ç«çƒ­çš„æŠ€æœ¯æ¦‚å¿µä¹‹ä¸€ï¼Œå¯¹æå‡Webåº”ç”¨çš„å®‰å…¨ã€æ€§èƒ½å’Œä½“éªŒæœ‰ç€å¾ˆå¤§çš„æ„ä¹‰ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å»äº†è§£ä¸å­¦ä¹ ã€‚å¯¹PWAæ„Ÿå…´è¶£çš„æœ‹å‹æ¬¢è¿å…³æ³¨ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« ã€‚\r\n\r\næœ¬æ–‡ä¸­çš„ä»£ç å¯ä»¥åœ¨[learning-pwaçš„notificationåˆ†æ”¯](https://github.com/alienzhou/learning-pwa/tree/notification)ä¸Šæ‰¾åˆ°ï¼ˆ`git clone`åæ³¨æ„åˆ‡æ¢åˆ°notificationåˆ†æ”¯ï¼‰ã€‚\r\n\r\n## 1. å¼•è¨€\r\nåœ¨ç¬¬äº”ç¯‡æ–‡ç« ã€ŠWebä¸­è¿›è¡ŒæœåŠ¡ç«¯æ¶ˆæ¯æ¨é€ã€‹ä¸­ï¼Œæˆ‘ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Push APIè¿›è¡ŒæœåŠ¡ç«¯æ¶ˆæ¯æ¨é€ã€‚æåˆ°Pushå°±ä¸å¾—ä¸è¯´ä¸å…¶è”ç³»ç´§å¯†çš„å¦ä¸€ä¸ªAPIâ€”â€”Notification APIã€‚å®ƒè®©æˆ‘ä»¬å¯ä»¥åœ¨â€œç½‘ç«™å¤–â€æ˜¾ç¤ºæ¶ˆæ¯æç¤ºï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/1/1631a562ba773ddd?w=1275&h=762&f=gif&s=384884)\r\n\r\nå³ä½¿å½“ä½ åˆ‡æ¢åˆ°å…¶ä»–Tabï¼Œä¹Ÿå¯ä»¥é€šè¿‡æé†’äº¤äº’æ¥å¿«é€Ÿè®©ç”¨æˆ·å›åˆ°ä½ çš„ç½‘ç«™ï¼›ç”šè‡³å½“ç”¨æˆ·ç¦»å¼€å½“å‰ç½‘ç«™ï¼Œä»ç„¶å¯ä»¥æ”¶åˆ°ç³»ç»Ÿçš„æé†’æ¶ˆæ¯ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æ¶ˆæ¯æé†’å¿«é€Ÿæ‰“å¼€ä½ çš„ç½‘ç«™ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/1/1631b52052cccb59?w=1270&h=676&f=gif&s=2317289)\r\n\r\nNotificationçš„åŠŸèƒ½æœ¬èº«ä¸Pushå¹¶ä¸è€¦åˆï¼Œä½ å®Œå…¨å¯ä»¥åªä½¿ç”¨Notification APIæˆ–è€…Push APIæ¥æ„å»ºWeb Appçš„æŸäº›åŠŸèƒ½ã€‚å› æ­¤ï¼Œæœ¬æ–‡ä¼šå…ˆä»‹ç»å¦‚ä½•ä½¿ç”¨Notification APIã€‚ç„¶åï¼Œä½œä¸ºNotificationçš„â€œé»„é‡‘æ­æ¡£â€ï¼Œæœ¬æ–‡è¿˜ä¼šä»‹ç»å¦‚ä½•ç»„åˆä½¿ç”¨Push & Notificationï¼ˆæ¶ˆæ¯æ¨é€ä¸æé†’ï¼‰ã€‚\r\n\r\n## 2. ä½¿ç”¨Notification API\r\nåœ¨è¿™ç¬¬äºŒèŠ‚é‡Œï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£å¦‚ä½•ç‹¬ç«‹ä½¿ç”¨NotificationåŠŸèƒ½ã€‚ç›¸è¾ƒäºç¬¬äº”ç¯‡ä¸­çš„PushåŠŸèƒ½ï¼ŒNotification APIæ›´åŠ ç®€æ´æ˜“æ‡‚ã€‚\r\n\r\n### 2.1. è·å–æé†’æƒé™\r\n\r\né¦–å…ˆï¼Œè¿›è¡Œè°ƒç”¨æ¶ˆæ¯æé†’APIéœ€è¦è·å¾—ç”¨æˆ·çš„æˆæƒã€‚\r\n\r\nåœ¨è°ƒç”¨Notificationç›¸å…³APIä¹‹å‰ï¼Œéœ€è¦å…ˆä½¿ç”¨`Notification`å¯¹è±¡ä¸Šçš„é™æ€æ–¹æ³•`Notification.requestPermission()`æ¥è·å–æˆæƒã€‚ç”±äº`Notification.requestPermission()`åœ¨æŸäº›ç‰ˆæœ¬æµè§ˆå™¨ä¸­ä¼šæ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼ˆ`Notification.requestPermission(callback)`ï¼‰ä½œä¸ºå‚æ•°ï¼Œè€Œåœ¨å¦ä¸€äº›æµè§ˆå™¨ç‰ˆæœ¬ä¸­ä¼šè¿”å›ä¸€ä¸ªpromiseï¼Œå› æ­¤å°†è¯¥æ–¹æ³•è¿›è¡ŒåŒ…è£…ï¼Œç»Ÿä¸€ä¸ºpromiseè°ƒç”¨ï¼š\r\n\r\n```javascript\r\n// index.js\r\nfunction askPermission() {\r\n    return new Promise(function (resolve, reject) {\r\n        var permissionResult = Notification.requestPermission(function (result) {\r\n            resolve(result);\r\n        });\r\n  \r\n        if (permissionResult) {\r\n            permissionResult.then(resolve, reject);\r\n        }\r\n    }).then(function (permissionResult) {\r\n        if (permissionResult !== 'granted') {\r\n            throw new Error('We weren\\'t granted permission.');\r\n        }\r\n    });\r\n}\r\n\r\n\r\nregisterServiceWorker('./sw.js').then(function (registration) {\r\n    return Promise.all([\r\n        registration,\r\n        askPermission()\r\n    ])\r\n })\r\n```\r\næˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª`askPermission()`æ–¹æ³•æ¥ç»Ÿä¸€`Notification.requestPermission()`çš„è°ƒç”¨å½¢å¼ï¼Œå¹¶åœ¨Service Workeræ³¨å†Œå®Œæˆåè°ƒç”¨è¯¥æ–¹æ³•ã€‚è°ƒç”¨`Notification.requestPermission()`è·å–çš„`permissionResult`å¯èƒ½çš„å€¼ä¸ºï¼š\r\n\r\n- deniedï¼šç”¨æˆ·æ‹’ç»äº†é€šçŸ¥çš„æ˜¾ç¤º\r\n- grantedï¼šç”¨æˆ·å…è®¸äº†é€šçŸ¥çš„æ˜¾ç¤º\r\n- defaultï¼šå› ä¸ºä¸çŸ¥é“ç”¨æˆ·çš„é€‰æ‹©ï¼Œæ‰€ä»¥æµè§ˆå™¨çš„è¡Œä¸ºä¸deniedæ—¶ç›¸åŒ\r\n\r\nchromeä¸­ï¼Œå¯ä»¥åœ¨`chrome://settings/content/notifications`é‡Œè¿›è¡Œé€šçŸ¥çš„è®¾ç½®ä¸ç®¡ç†ã€‚\r\n\r\n### 2.2. è®¾ç½®ä½ çš„æé†’å†…å®¹\r\nè·å–ç”¨æˆ·æˆæƒåï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡`registration.showNotification()`æ–¹æ³•è¿›è¡Œæ¶ˆæ¯æé†’äº†ã€‚\r\n\r\nå½“æˆ‘ä»¬æ³¨å†Œå®ŒService Workeråï¼Œ`then`æ–¹æ³•çš„å›è°ƒå‡½æ•°ä¼šæ¥æ”¶ä¸€ä¸ª`registration`å‚æ•°ï¼Œé€šè¿‡è°ƒç”¨å…¶ä¸Šçš„`showNotification()`æ–¹æ³•å³å¯è§¦å‘æé†’ï¼š\r\n\r\n```javascript\r\n// index.js\r\nregisterServiceWorker('./sw.js').then(function (registration) {\r\n    return Promise.all([\r\n        registration,\r\n        askPermission()\r\n    ])\r\n}).then(function (result) {\r\n    var registration = result[0];\r\n    /* ===== æ·»åŠ æé†’åŠŸèƒ½ ====== */\r\n    document.querySelector('#js-notification-btn').addEventListener('click', function () {\r\n        var title = 'PWAå³å­¦å³ç”¨';\r\n        var options = {\r\n            body: 'é‚€è¯·ä½ ä¸€èµ·å­¦ä¹ ',\r\n            icon: '/img/icons/book-128.png',\r\n            actions: [{\r\n                action: 'show-book',\r\n                title: 'å»çœ‹çœ‹'\r\n            }, {\r\n                action: 'contact-me',\r\n                title: 'è”ç³»æˆ‘'\r\n            }],\r\n            tag: 'pwa-starter',\r\n            renotify: true\r\n        };\r\n        registration.showNotification(title, options);\r\n    });\r\n    /* ======================= */\r\n})\r\n```\r\n\r\nä¸Šé¢è¿™æ®µä»£ç ä¸ºé¡µé¢ä¸Šçš„buttonæ·»åŠ äº†ä¸€ä¸ªclickäº‹ä»¶ç›‘å¬ï¼šå½“ç‚¹å‡»åï¼Œè°ƒç”¨`registration.showNotification()`æ–¹æ³•æ¥æ˜¾ç¤ºæ¶ˆæ¯æé†’ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š`title`ä¸`option`ã€‚`title`ç”¨æ¥è®¾ç½®è¯¥æé†’çš„ä¸»æ ‡é¢˜ï¼Œ`option`ä¸­åˆ™åŒ…å«äº†ä¸€äº›å…¶ä»–è®¾ç½®ã€‚\r\n\r\n- bodyï¼šæé†’çš„å†…å®¹\r\n- iconï¼šæé†’çš„å›¾æ ‡\r\n- actionsï¼šæé†’å¯ä»¥åŒ…å«ä¸€äº›è‡ªå®šä¹‰æ“ä½œ\r\n- tagï¼šç›¸å½“äºæ˜¯IDï¼Œé€šè¿‡è¯¥IDæ ‡è¯†å¯ä»¥æ“ä½œç‰¹å®šçš„notification\r\n- renotifyï¼šæ˜¯å¦å…è®¸é‡å¤æé†’ï¼Œé»˜è®¤ä¸ºfalseã€‚å½“ä¸å…è®¸é‡å¤æé†’æ—¶ï¼ŒåŒä¸€ä¸ªtagçš„notificationåªä¼šæ˜¾ç¤ºä¸€æ¬¡\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/1/1631a6c6007ffec9?w=800&h=300&f=jpeg&s=114296)\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/1/1631a6f12cc17f0c?w=800&h=161&f=jpeg&s=66563)\r\n\r\n> æ³¨æ„ï¼Œç”±äºä¸åŒæµè§ˆå™¨ä¸­ï¼Œå¯¹äº`option`å±æ€§çš„æ”¯æŒæƒ…å†µå¹¶ä¸ç›¸åŒã€‚éƒ¨åˆ†å±æ€§åœ¨ä¸€äº›æµè§ˆå™¨ä¸­å¹¶ä¸æ”¯æŒã€‚\r\n\r\n### 2.3. æ•è·ç”¨æˆ·çš„ç‚¹å‡»\r\nåœ¨ä¸Šä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä¸ºWeb Appæ·»åŠ äº†æé†’åŠŸèƒ½ã€‚ç‚¹å‡»é¡µé¢ä¸­çš„â€œæé†’â€æŒ‰é’®ï¼Œç³»ç»Ÿå°±ä¼šå¼¹å‡ºæé†’æ¡†ï¼Œå¹¶å±•ç¤ºç›¸å…³æé†’æ¶ˆæ¯ã€‚\r\n\r\nç„¶è€Œæ›´å¤šçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸ä»…ä»…å¸Œæœ›åªå±•ç¤ºæœ‰é™çš„ä¿¡æ¯ï¼Œæ›´å¸Œæœ›èƒ½å¼•å¯¼ç”¨æˆ·è¿›è¡Œäº¤äº’ã€‚ä¾‹å¦‚æ¨èä¸€æœ¬æ–°ä¹¦ï¼Œè®©ç”¨æˆ·ç‚¹å‡»é˜…è¯»æˆ–è´­ä¹°ã€‚åœ¨ä¸Šä¸€éƒ¨åˆ†æˆ‘ä»¬è®¾ç½®çš„æé†’æ¡†ä¸­ï¼ŒåŒ…å«äº†â€œå»çœ‹çœ‹â€å’Œâ€œè”ç³»æˆ‘â€ä¸¤ä¸ªæŒ‰é’®é€‰é¡¹ï¼Œé‚£ä¹ˆæ€ä¹ˆåšæ‰èƒ½æ•è·ç”¨æˆ·çš„ç‚¹å‡»æ“ä½œï¼Œå¹¶ä¸”çŸ¥é“ç”¨æˆ·ç‚¹å‡»äº†å“ªä¸ªå‘¢ï¼Ÿè¿™ä¸€å°èŠ‚ï¼Œå°±ä¼šå‘Šè¯‰ä½ å¦‚ä½•å®ç°ã€‚\r\n\r\nè¿˜è®°çš„ä¸Šä¸€éƒ¨åˆ†é‡Œæˆ‘ä»¬å®šä¹‰çš„actionsä¹ˆï¼Ÿ\r\n\r\n```javascript\r\nâ€¦\r\nactions: [{\r\n    action: 'show-book',\r\n    title: 'å»çœ‹çœ‹'\r\n    }, {\r\n    action: 'contact-me',\r\n    title: 'è”ç³»æˆ‘'\r\n}]\r\nâ€¦\r\n```\r\nä¸ºäº†èƒ½å¤Ÿå“åº”ç”¨æˆ·å¯¹äºæé†’æ¡†çš„ç‚¹å‡»äº‹ä»¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Service Workerä¸­ç›‘å¬`notificationclick`äº‹ä»¶ã€‚åœ¨è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥è·å–ç‚¹å‡»çš„ç›¸å…³ä¿¡æ¯ï¼š\r\n\r\n```javascript\r\n// sw.js\r\nself.addEventListener('notificationclick', function (e) {\r\n    var action = e.action;\r\n    console.log(`action tag: ${e.notification.tag}`, `action: ${action}`);\r\n    \r\n    switch (action) {\r\n        case 'show-book':\r\n            console.log('show-book');\r\n            break;\r\n        case 'contact-me':\r\n            console.log('contact-me');\r\n            break;\r\n        default:\r\n            console.log(`æœªå¤„ç†çš„action: ${e.action}`);\r\n            action = 'default';\r\n            break;\r\n    }\r\n    e.notification.close();\r\n});\r\n```\r\n\r\n`e.action`è·å–çš„å€¼ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨`showNotification()`ä¸­å®šä¹‰çš„actionsé‡Œçš„actionã€‚å› æ­¤ï¼Œé€šè¿‡`e.action`å°±å¯ä»¥çŸ¥é“ç”¨æˆ·ç‚¹å‡»äº†å“ªä¸€ä¸ªæ“ä½œé€‰é¡¹ã€‚æ³¨æ„ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æé†’æœ¬èº«æ—¶ï¼Œä¹Ÿä¼šè§¦å‘`notificationclick`ï¼Œä½†æ˜¯ä¸åŒ…å«ä»»ä½•actionå€¼ï¼Œæ‰€ä»¥åœ¨ä»£ç ä¸­å°†å…¶ç½®äºdefaulté»˜è®¤æ“ä½œä¸­ã€‚\r\n\r\nç°åœ¨è¯•ä¸€ä¸‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ•è·ç”¨æˆ·å¯¹äºä¸åŒé€‰é¡¹çš„ç‚¹å‡»äº†ã€‚ç‚¹å‡»ååœ¨Consoleä¸­ä¼šæœ‰ä¸åŒçš„è¾“å‡ºã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/1/1631a855e6ac1712?w=1120&h=188&f=png&s=52210)\r\n\r\n### 2.4. Service Workerä¸clienté€šä¿¡\r\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥é¡ºåˆ©å¾—ç»™ç”¨æˆ·å±•ç¤ºæé†’ï¼Œå¹¶ä¸”åœ¨ç”¨æˆ·æ“ä½œæé†’åå‡†ç¡®æ•è·åˆ°ç”¨æˆ·çš„æ“ä½œã€‚ç„¶è€Œï¼Œè¿˜ç¼ºæœ€é‡è¦çš„ä¸€æ­¥â€”â€”é’ˆå¯¹ä¸åŒçš„æ“ä½œï¼Œè§¦å‘ä¸åŒçš„äº¤äº’ã€‚ä¾‹å¦‚ï¼Œ\r\n- ç‚¹å‡»æé†’æœ¬èº«ä¼šå¼¹å‡ºä¹¦ç±ç®€ä»‹ï¼›\r\n- ç‚¹å‡»â€œçœ‹ä¸€çœ‹â€ä¼šç»™ç”¨æˆ·å±•ç¤ºæœ¬ä¹¦çš„è¯¦æƒ…ï¼›\r\n- ç‚¹å‡»â€œè”ç³»æˆ‘â€ä¼šå‘åº”ç”¨ç®¡ç†è€…å‘é‚®ä»¶ç­‰ç­‰ã€‚\r\n\r\nè¿™é‡Œæœ‰ä¸ªå¾ˆé‡è¦çš„åœ°æ–¹ï¼šæˆ‘ä»¬åœ¨Service Workerä¸­æ•è·ç”¨æˆ·æ“ä½œï¼Œä½†æ˜¯éœ€è¦åœ¨clientï¼ˆè¿™é‡Œçš„clientæ˜¯æŒ‡å‰ç«¯é¡µé¢çš„è„šæœ¬ç¯å¢ƒï¼‰ä¸­è§¦å‘ç›¸åº”æ“ä½œï¼ˆè°ƒç”¨é¡µé¢æ–¹æ³•/è¿›è¡Œé¡µé¢è·³è½¬â€¦ï¼‰ã€‚å› æ­¤ï¼Œè¿™å°±éœ€è¦è®©Service Workerä¸clientè¿›è¡Œé€šä¿¡ã€‚é€šä¿¡åŒ…æ‹¬ä¸‹é¢ä¸¤ä¸ªéƒ¨åˆ†ï¼š\r\n\r\n1. åœ¨Service Workerä¸­ä½¿ç”¨Workerçš„`postMessage()`æ–¹æ³•æ¥é€šçŸ¥clientï¼š\r\n\r\n```javascript\r\n// sw.js\r\nself.addEventListener('notificationclick', function (e) {\r\n    â€¦â€¦ // ç•¥å»ä¸Šä¸€èŠ‚å†…å®¹\r\n    \r\n    e.waitUntil(\r\n        // è·å–æ‰€æœ‰clients\r\n        self.clients.matchAll().then(function (clients) {\r\n            if (!clients || clients.length === 0) {\r\n                return;\r\n            }\r\n            clients.forEach(function (client) {\r\n                // ä½¿ç”¨postMessageè¿›è¡Œé€šä¿¡\r\n                client.postMessage(action);\r\n            });\r\n        })\r\n    );\r\n});\r\n```\r\n\r\n2. åœ¨clientä¸­ç›‘å¬`message`äº‹ä»¶ï¼Œåˆ¤æ–­`data`ï¼Œè¿›è¡Œä¸åŒçš„æ“ä½œï¼š\r\n\r\n```javascript\r\n// index.js\r\nnavigator.serviceWorker.addEventListener('message', function (e) {\r\n    var action = e.data;\r\n    console.log(`receive post-message from sw, action is '${e.data}'`);\r\n    switch (action) {\r\n        case 'show-book':\r\n            location.href = 'https://book.douban.com/subject/20515024/';\r\n            break;\r\n        case 'contact-me':\r\n            location.href = 'mailto:someone@sample.com';\r\n            break;\r\n        default:\r\n            document.querySelector('.panel').classList.add('show');\r\n            break;\r\n    }\r\n});\r\n```\r\n\r\nå½“ç”¨æˆ·ç‚¹å‡»æé†’åï¼Œæˆ‘ä»¬åœ¨`notificationclick`ç›‘å¬ä¸­ï¼Œå°†actioné€šè¿‡`postMessage()`é€šä¿¡ç»™clientï¼›ç„¶ååœ¨clientä¸­ç›‘å¬`message`äº‹ä»¶ï¼ŒåŸºäºactionï¼ˆ`e.data`ï¼‰æ¥è¿›è¡Œä¸åŒçš„æ“ä½œï¼ˆè·³è½¬åˆ°å›¾ä¹¦è¯¦æƒ…é¡µ/å‘é€é‚®ä»¶/æ˜¾ç¤ºç®€ä»‹é¢æ¿ï¼‰ã€‚\r\n\r\nè‡³æ­¤ï¼Œä¸€ä¸ªæ¯”è¾ƒç®€å•ä¸å®Œæ•´çš„æ¶ˆæ¯æé†’ï¼ˆNotificationï¼‰åŠŸèƒ½å°±å®Œæˆäº†ã€‚\r\n\r\nç„¶è€Œç›®å‰çš„æ¶ˆæ¯æé†’è¿˜å­˜åœ¨ä¸€å®šçš„å±€é™æ€§ã€‚ä¾‹å¦‚ï¼Œåªæœ‰åœ¨ç”¨æˆ·è®¿é—®ç½‘ç«™æœŸé—´æ‰èƒ½æœ‰æœºä¼šè§¦å‘æé†’ã€‚æ­£å¦‚æœ¬æ–‡ä¸€å¼€å§‹æ‰€è¯´ï¼ŒPush & Notificationçš„ç»“åˆå°†ä¼šå¸®åŠ©æˆ‘ä»¬æ„ç­‘ä¸€ä¸ªå¼ºå¤§æ¨é€ä¸æé†’åŠŸèƒ½ã€‚ä¸‹é¢å°±æ¥çœ‹ä¸‹å®ƒä»¬çš„ç®€å•ç»“åˆã€‚\r\n\r\n## 3. æ¶ˆæ¯æ¨é€ä¸æé†’\r\nåœ¨ç¬¬äº”ç¯‡ã€ŠWebä¸­è¿›è¡ŒæœåŠ¡ç«¯æ¶ˆæ¯æ¨é€ã€‹æœ€åï¼Œæˆ‘ä»¬é€šè¿‡ç›‘å¬`push`äº‹ä»¶æ¥å¤„ç†æœåŠ¡ç«¯æ¨é€ï¼š\r\n\r\n```javascript\r\n// sw.js\r\nself.addEventListener('push', function (e) {\r\n    var data = e.data;\r\n    if (e.data) {\r\n        data = data.json();\r\n        console.log('pushçš„æ•°æ®ä¸ºï¼š', data);\r\n        self.registration.showNotification(data.text);        \r\n    } \r\n    else {\r\n        console.log('pushæ²¡æœ‰ä»»ä½•æ•°æ®');\r\n    }\r\n});\r\n```\r\n\r\nç®€å•ä¿®æ”¹ä»¥ä¸Šä»£ç ï¼Œä¸æˆ‘ä»¬æœ¬æ–‡ä¸­çš„æé†’åŠŸèƒ½ç›¸ç»“åˆï¼š\r\n\r\n```javascript\r\n// sw.js\r\nself.addEventListener('push', function (e) {\r\n    var data = e.data;\r\n    if (e.data) {\r\n        data = data.json();\r\n        console.log('pushçš„æ•°æ®ä¸ºï¼š', data);\r\n        var title = 'PWAå³å­¦å³ç”¨';\r\n        var options = {\r\n            body: data,\r\n            icon: '/img/icons/book-128.png',\r\n            image: '/img/icons/book-521.png', // no effect\r\n            actions: [{\r\n                action: 'show-book',\r\n                title: 'å»çœ‹çœ‹'\r\n            }, {\r\n                action: 'contact-me',\r\n                title: 'è”ç³»æˆ‘'\r\n            }],\r\n            tag: 'pwa-starter',\r\n            renotify: true\r\n        };\r\n        self.registration.showNotification(title, options);        \r\n    } \r\n    else {\r\n        console.log('pushæ²¡æœ‰ä»»ä½•æ•°æ®');\r\n    }\r\n});\r\n```\r\n\r\nä½¿ç”¨Pushæ¥å‘ç”¨æˆ·æ¨é€ä¿¡æ¯ï¼Œå¹¶åœ¨Service Workerä¸­ç›´æ¥è°ƒç”¨Notification APIæ¥å±•ç¤ºè¯¥ä¿¡æ¯çš„æé†’æ¡†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯åœ¨ç”¨æˆ·å…³é—­è¯¥Web Appæ—¶ï¼Œä¾ç„¶å¯ä»¥æ”¶åˆ°æé†’ï¼Œç±»ä¼¼äºNativeä¸­çš„æ¶ˆæ¯æ¨é€ä¸æé†’ã€‚\r\n\r\næˆ‘ä»¬è¿˜å¯ä»¥å°†è¿™ä¸ªåŠŸèƒ½å†ä¸°å¯Œä¸€äº›ã€‚ç”±äºç”¨æˆ·åœ¨å…³é—­è¯¥ç½‘ç«™æ—¶ä»ç„¶å¯ä»¥æ”¶åˆ°æé†’ï¼Œå› æ­¤åŠ å…¥ä¸€äº›æ›´å¼ºå¤§åŠŸèƒ½ï¼š\r\n- å½“ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–Tabæ—¶ï¼Œç‚¹å‡»æé†’ä¼šç«‹åˆ»å›åˆ°ç½‘ç«™çš„tabï¼›\r\n- å½“ç”¨æˆ·æœªæ‰“å¼€è¯¥ç½‘ç«™æ—¶ï¼Œç‚¹å‡»æé†’å¯ä»¥ç›´æ¥æ‰“å¼€ç½‘ç«™ã€‚\r\n\r\n```javascript\r\n// sw.js\r\nself.addEventListener('notificationclick', function (e) {\r\n    var action = e.action;\r\n    console.log(`action tag: ${e.notification.tag}`, `action: ${action}`);\r\n    \r\n    switch (action) {\r\n        case 'show-book':\r\n            console.log('show-book');\r\n            break;\r\n        case 'contact-me':\r\n            console.log('contact-me');\r\n            break;\r\n        default:\r\n            console.log(`æœªå¤„ç†çš„action: ${e.action}`);\r\n            action = 'default';\r\n            break;\r\n    }\r\n    e.notification.close();\r\n\r\n    e.waitUntil(\r\n        // è·å–æ‰€æœ‰clients\r\n        self.clients.matchAll().then(function (clients) {\r\n            if (!clients || clients.length === 0) {\r\n                // å½“ä¸å­˜åœ¨clientæ—¶ï¼Œæ‰“å¼€è¯¥ç½‘ç«™\r\n                self.clients.openWindow && self.clients.openWindow('http://127.0.0.1:8085');\r\n                return;\r\n            }\r\n            // åˆ‡æ¢åˆ°è¯¥ç«™ç‚¹çš„tab\r\n            clients[0].focus && clients[0].focus();\r\n            clients.forEach(function (client) {\r\n                // ä½¿ç”¨postMessageè¿›è¡Œé€šä¿¡\r\n                client.postMessage(action);\r\n            });\r\n        })\r\n    );\r\n});\r\n```\r\n\r\næ³¨æ„è¿™ä¸¤è¡Œä»£ç ï¼Œç¬¬ä¸€è¡Œä¼šåœ¨ç½‘ç«™å…³é—­æ—¶æ‰“å¼€è¯¥ç½‘ç«™ï¼Œç¬¬äºŒè¡Œä¼šåœ¨å­˜åœ¨tabæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°ç½‘ç«™çš„tabã€‚\r\n\r\n```javascript\r\nself.clients.openWindow && self.clients.openWindow('http://127.0.0.1:8085');\r\n\r\nclients[0].focus && clients[0].focus();\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/1/1631b52052cccb59?w=1270&h=676&f=gif&s=2317289)\r\n\r\n## 4. MacOS Safariä¸­çš„Web Notification\r\nçœ‹ä¸€ä¸‹[Web Notificationçš„å…¼å®¹æ€§](https://caniuse.com/#search=notification)ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/1/1631afa349ff2f0c?w=2344&h=918&f=png&s=222023)\r\n\r\nç›®å‰ç§»åŠ¨ç«¯æµè§ˆå™¨æ™®éè¿˜ä¸æ”¯æŒè¯¥ç‰¹æ€§ã€‚ä½†æ˜¯åœ¨Mac OSä¸Šçš„safarié‡Œé¢æ˜¯æ”¯æŒè¯¥ç‰¹æ€§çš„ï¼Œä¸è¿‡å…¶è°ƒç”¨æ–¹å¼ä¸ä¸Šæ–‡ä»£ç æœ‰äº›ä¸å¤ªä¸€æ ·ã€‚åœ¨safariä¸­ä½¿ç”¨Web Notificationä¸æ˜¯è°ƒç”¨`registration.showNotification()`æ–¹æ³•ï¼Œè€Œæ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ªNotificationå¯¹è±¡ã€‚\r\n\r\n```javascript\r\n// index.js\r\nâ€¦â€¦\r\ndocument.querySelector('#js-notification-btn').addEventListener('click', function () {\r\n    var title = 'PWAå³å­¦å³ç”¨';\r\n    var options = {\r\n        body: 'é‚€è¯·ä½ ä¸€èµ·å­¦ä¹ ',\r\n        icon: '/img/icons/book-128.png',\r\n        actions: [{\r\n            action: 'show-book',\r\n            title: 'å»çœ‹çœ‹'\r\n        }, {\r\n            action: 'contact-me',\r\n            title: 'è”ç³»æˆ‘'\r\n        }],\r\n        tag: 'pwa-starter',\r\n        renotify: true\r\n    };\r\n    // registration.showNotification(title, options);\r\n\r\n    // ä½¿ç”¨Notificationæ„é€ å‡½æ•°åˆ›å»ºæé†’æ¡†\r\n    // è€Œéregistration.showNotification()æ–¹æ³•\r\n    var notification = new Notification(title, options);\r\n});\r\nâ€¦â€¦\r\n```\r\nNotificationå¯¹è±¡ç»§æ‰¿è‡ªEventTargetæ¥å£ï¼Œå› æ­¤åœ¨safariä¸­éœ€è¦é€šè¿‡æ·»åŠ clickäº‹ä»¶çš„ç›‘å¬æ¥è§¦å‘æé†’æ¡†çš„äº¤äº’æ“ä½œï¼š\r\n\r\n```javascript\r\n// index.js\r\nnotification.addEventListener('click', function (e) {\r\n    document.querySelector('.panel').classList.add('show');\r\n});\r\n```\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/5/1/1631b1ef1e592c36?w=677&h=369&f=gif&s=308375)\r\n\r\nè¯¥åŠŸèƒ½ç¤ºä¾‹å¯ä»¥åœ¨[learn-pwa/notify4safari](https://github.com/alienzhou/learning-pwa/tree/notify4safari)ä¸­æ‰¾åˆ°ã€‚\r\n\r\n## 5. å†™åœ¨æœ€å\r\nWeb Notificationæ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„APIï¼Œå°¤å…¶åœ¨å’ŒPushç»“åˆåï¼Œä¸ºWebAppå¸¦æ¥äº†ç±»ä¼¼Nativeçš„ä¸°å¯Œèƒ½åŠ›ã€‚\r\n\r\næœ¬æ–‡ä¸­æ‰€æœ‰çš„ä»£ç ç¤ºä¾‹å‡å¯ä»¥åœ¨[learn-pwa/notification](https://github.com/alienzhou/learning-pwa/tree/notification)ä¸Šæ‰¾åˆ°ã€‚\r\n\r\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†[Manifest](https://github.com/alienzhou/blog/issues/3)ã€[ç¦»çº¿ç¼“å­˜](https://github.com/alienzhou/blog/issues/4)ã€[æ¶ˆæ¯æ¨é€](https://github.com/alienzhou/blog/issues/6)ã€æ¶ˆæ¯æé†’ã€[Debug](https://github.com/alienzhou/blog/issues/7)ç­‰ä¸€äº›åŸºç¡€çŸ¥è¯†ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä»¬ä¼šç»§ç»­äº†è§£ä¸å­¦ä¹ PWAä¸­çš„ä¸€ä¸ªé‡è¦åŠŸèƒ½â€”â€”åå°åŒæ­¥ã€‚\r\n\r\n## å‚è€ƒèµ„æ–™\r\n- [MDN: notification](https://developer.mozilla.org/zh-CN/docs/Web/API/notification)\r\n- [MDN: ServiceWorkerRegistration.showNotification()](https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/showNotification)\r\n- [MDN: WindowClient](https://developer.mozilla.org/en-US/docs/Web/API/WindowClient)\r\n- [MDN: Clients](https://developer.mozilla.org/en-US/docs/Web/API/Clients)\r\n- [WWDC2013](https://developer.apple.com/videos/play/wwdc2013/614/)","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/7","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/7/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/7/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/7/events","html_url":"https://github.com/alienzhou/blog/issues/7","id":390621274,"node_id":"MDU6SXNzdWUzOTA2MjEyNzQ=","number":7,"title":"ã€PWAå­¦ä¹ ä¸å®è·µã€‘(6) åœ¨Chromeä¸­è°ƒè¯•ä½ çš„PWA","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845017,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE3","url":"https://api.github.com/repos/alienzhou/blog/labels/PWA","name":"PWA","color":"008672","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T10:48:31Z","updated_at":"2018-12-13T10:48:39Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« å·²æ•´ç†è‡³[gitbook - PWAå­¦ä¹ æ‰‹å†Œ](https://alienzhou.gitbook.io/learning-pwa/)ï¼Œæ–‡å­—å†…å®¹å·²åŒæ­¥è‡³[learning-pwa-ebook](https://github.com/alienzhou/learning-pwa-ebook)ã€‚è½¬è½½è¯·æ³¨æ˜ä½œè€…ä¸å‡ºå¤„ã€‚\r\n\r\næœ¬æ–‡æ˜¯ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—çš„ç¬¬å…­ç¯‡æ–‡ç« ã€‚\r\n\r\nPWAä½œä¸ºæ—¶ä¸‹æœ€ç«çƒ­çš„æŠ€æœ¯æ¦‚å¿µä¹‹ä¸€ï¼Œå¯¹æå‡Webåº”ç”¨çš„å®‰å…¨ã€æ€§èƒ½å’Œä½“éªŒæœ‰ç€å¾ˆå¤§çš„æ„ä¹‰ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å»äº†è§£ä¸å­¦ä¹ ã€‚å¯¹PWAæ„Ÿå…´è¶£çš„æœ‹å‹æ¬¢è¿å…³æ³¨ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« ã€‚\r\n\r\nå‰å‡ ç¯‡æ–‡ç« ä»‹ç»äº†PWAä¸­çš„ä¸€äº›åŠŸèƒ½ä¸èƒŒåçš„æŠ€æœ¯ã€‚å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚è¿™ä¸€ç¯‡ä¼šä»‹ç»å¦‚ä½•è°ƒè¯•æˆ‘ä»¬çš„PWAã€‚\r\n\r\n## Service Worker\r\næ–°ç‰ˆçš„chromeè°ƒè¯•å·¥å…·ä¸­é›†æˆäº†Service Workerè°ƒè¯•å·¥å…·ã€‚\r\n\r\nå¼€å¯chromeè°ƒè¯•å·¥å…·ï¼Œé€‰æ‹©Applicationé€‰é¡¹å¡ã€‚åœ¨å·¦ä¾§çš„åˆ—è¡¨é€‰æ‹©Application --> Service Workerï¼Œå°±ä¼šæ˜¾ç¤ºå½“å‰ç«™ç‚¹ä¸‹çš„Service Workerã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/29/16310656fb567e8f?w=1196&h=494&f=png&s=88288)\r\n\r\nåœ¨Service Workerä¸‹æœ‰ä¸‰ä¸ªå¤é€‰æ¡†ï¼š\r\n\r\n- Offlineï¼šåˆ‡æ¢ä¸ºæ— ç½‘ç¯å¢ƒã€‚é€šè¿‡å‹¾é€‰å¯ä»¥æ–¹ä¾¿æŸ¥çœ‹åº”ç”¨åœ¨æ— ç½‘ç¯å¢ƒä¸­çš„è¡¨ç°ã€‚\r\n- Update on reloadï¼šæ¯æ¬¡reloadéƒ½æ›´æ–°Service Workerã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå½“è®¿é—®ç«™ç‚¹å‘ç°Service Workeræœ‰æ›´æ–°åï¼Œä¸ºäº†ä¿è¯æœ¬æ¬¡è®¿é—®ï¼Œä¸ä¼šç«‹å³æ¿€æ´»æ–°çš„Service Workerï¼Œåªä¼šåœ¨å®‰è£…åè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œåœ¨ä¸‹ä¸€æ¬¡è®¿é—®æ—¶æ¿€æ´»ã€‚å‹¾é€‰è¯¥é€‰é¡¹å°±å¯ä»¥ä½¿æ¯æ¬¡Reloadåéƒ½é‡æ–°å®‰è£…ä¸æ¿€æ´»Service Workerã€‚\r\n- Bypass for networkï¼šä½¿ç”¨ç½‘ç»œè¯·æ±‚ã€‚æˆ‘ä»¬çŸ¥é“Service Workerå¯ä»¥æ‹¦æˆªå®¢æˆ·ç«¯è¯·æ±‚ï¼Œå‹¾é€‰è¯¥é€‰é¡¹åæ‰€æœ‰è¯·æ±‚éƒ½ä¼šç›´æ¥èµ°ç½‘ç»œè¯·æ±‚ã€‚\r\n\r\n\r\né¢æ¿å³ä¸Šè§’çš„UpadteæŒ‰é’®å¯ä»¥æ‰‹åŠ¨è§¦å‘Service Workerçš„æ›´æ–°ï¼›è€ŒUnregisterç±»ä¼¼äºä»£ç ä¸­çš„unregisterï¼Œç”¨äºæ³¨é”€å½“å‰çš„Service Workerã€‚\r\n\r\nä»ä¸‹æ–¹â€œService workers from other domainâ€ä¸­ï¼Œå¯ä»¥æŸ¥çœ‹åœ¨è¿™ä¸ªclientä¸Šæ‰€æœ‰æ³¨å†Œè¿‡çš„Service Workerï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/29/163107b914043f63?w=1195&h=894&f=png&s=129528)\r\n\r\nService Workerä¸»é¢æ¿åŒºåŸŸåŒ…æ‹¬äº†ï¼šSourceã€Statusã€Clientsã€Pushå’ŒSyncäº”ä¸ªé¡¹ç›®ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/29/163106e9284cbc26?w=601&h=242&f=png&s=28360)\r\n\r\n- Sourceï¼šå±•ç¤ºäº†å½“å‰æ³¨å†Œæ‰€ä½¿ç”¨çš„Service Workerè„šæœ¬ï¼ˆsw.jsï¼‰ï¼Œç‚¹å‡»å¯ä»¥æŸ¥çœ‹è„šæœ¬å†…å®¹ã€‚åŒæ—¶è¿˜å±•ç¤ºäº†è¯¥Service Workerçš„å®‰è£…æ—¶é—´ã€‚\r\n- Statusï¼šå±•ç¤ºService Workeræ‰€å¤„çš„ç”Ÿå‘½å‘¨æœŸã€‚é€šè¿‡ç‚¹å‡»stopæŒ‰é’®å¯ä»¥æš‚åœè¯¥Service Workerã€‚å…¶ä¸­ï¼Œ`#1201`è¡¨ç¤ºService Workerçš„ç‰ˆæœ¬ï¼Œå½“sw.jsæ–‡ä»¶æœªæ›´æ”¹æ—¶ï¼Œreloadç«™ç‚¹è¯¥æ•°å­—æ˜¯ä¸ä¼šå¢åŠ çš„ï¼›ä½†æ˜¯å½“å‹¾é€‰Update on reloadåï¼Œç”±äºæ¯æ¬¡reloadéƒ½ä¼šè§¦å‘Service Workeré‡æ–°å®‰è£…ï¼Œå› æ­¤è¯¥æ•°å­—ä¼šå¢åŠ ã€‚\r\n- Clientsï¼šæ˜¾ç¤ºäº†å½“å‰Service Workeræ‰€ä½œç”¨çš„rootã€‚focusæŒ‰é’®ç”¨æ¥å¸®ä½ å¿«é€Ÿåˆ‡æ¢åˆ°è¯¥Service Workerå¯¹åº”çš„tabï¼ˆå½“ä½ æ‰“å¼€å¤šä¸ªç«™ç‚¹çš„tabæ—¶ï¼Œç‚¹å‡»å¯ä»¥å¿«é€Ÿåˆ‡æ¢ï¼‰ã€‚\r\n- Pushï¼šç”¨æ¥æ¨¡æ‹Ÿè¿›è¡Œæ¨é€ã€‚\r\n- Syncï¼šç”¨æ¥æ¨¡æ‹Ÿè¿›è¡Œåå°åŒæ­¥ã€‚\r\n\r\nåœ¨Service Workerä¸­`console.log`çš„ä¿¡æ¯ä¹Ÿä¼šæ˜¾ç¤ºåœ¨Consoleä¸­ã€‚æ­¤å¤–ï¼Œç”±äºé»˜è®¤æƒ…å†µä¸‹ï¼Œreloadé¡µé¢ä¼šæ¸…ç©ºconsoleï¼Œä¸ºäº†ä¿å­˜ä¸€äº›æ—¥å¿—ä¿¡æ¯ï¼Œå¯ä»¥æ‰“å¼€Preserve logæ¥ä¿ç•™Consoleä¿¡æ¯ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/29/163108561231f344?w=1195&h=264&f=png&s=73587)\r\n\r\n## Manifest\r\nåœ¨Applicationä¸­ï¼Œç‚¹å‡»Manifestå³å¯çœ‹åˆ°å½“å‰åº”ç”¨æ‰€ä½¿ç”¨çš„Manifesté…ç½®ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/29/163108efbea4b61d?w=1196&h=748&f=png&s=78387)\r\n\r\nåŒæ ·ï¼Œç‚¹å‡»manifest.jsonå‡ºé“¾æ¥å¯ä»¥æŸ¥çœ‹manifestæ–‡ä»¶ã€‚ç‚¹å‡»â€œAdd to homescreenâ€å¯ä»¥æŠŠåº”ç”¨æ·»åŠ åˆ°æ¡Œé¢ã€‚é™¤äº†ç‚¹å‡»â€œAdd to homescreenâ€ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨chromeä¸­çš„æ·»åŠ åˆ°åº”ç”¨æ–‡ä»¶å¤¹ã€‚\r\n\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/29/1631097d137fb789?w=285&h=437&f=png&s=53243)\r\n\r\n## Cache\r\né™¤äº†Service Workerä¸Manifestï¼Œåœ¨æˆ‘ä»¬çš„WebAppä¸­è¿˜ç”¨åˆ°äº†Cacheã€‚åœ¨Applicationä¸­ä¹Ÿæ”¯æŒæŸ¥çœ‹Cacheï¼šåœ¨Cacheåˆ—è¡¨çš„Cache Storageä¸­æŸ¥çœ‹ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/29/163109e551b9cd0f?w=1197&h=393&f=png&s=89517)\r\n\r\nå…¶ä¸­bs-0-2-0å’Œapi-0-1-1å°±æ˜¯æˆ‘ä»¬çš„â€œå›¾ä¹¦æœç´¢â€Web Appæ‰€åˆ›å»ºä¸ä½¿ç”¨çš„ä¸¤ä¸ªcacheã€‚åœ¨bs-0-2-0ä¸­ç¼“å­˜äº†åŒ…æ‹¬é¡µé¢ã€jsã€cssã€å›¾ç‰‡åœ¨å†…çš„ä¸€äº›é™æ€èµ„æºï¼›åœ¨è€Œapi-0-1-1ä¸­åˆ™ç¼“å­˜äº†å›¾ä¹¦æ£€ç´¢çš„XHRè¯·æ±‚ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/29/16310a142d0c794d?w=1197&h=503&f=png&s=116464)\r\n\r\nå¦‚æœæƒ³åˆ é™¤æŸäº›cacheï¼Œå¯ä»¥å³é”®ç‚¹å‡»ï¼Œç„¶åé€‰æ‹©Deleteï¼›ä¹Ÿå¯ä»¥ç‚¹å‡»ä¸Šæ–¹çš„Ã—ã€‚é™¤äº†åœ¨è¿™é‡Œæ¸…é™¤cacheï¼Œè¿˜å¯ä»¥åœ¨Applicationä¸‹çš„Clear Storageä¸­æ¸…é™¤åŒ…æ‹¬Service Workerã€Cacheä¸Storageï¼ˆcookie/localstorage/IndexedDBâ€¦â€¦ï¼‰ç­‰æ•°æ®ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/29/16310a439ef7c605?w=1196&h=664&f=png&s=88822)\r\n\r\n## å†™åœ¨æœ€å\r\n\r\nåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä»¬ä¼šç»§ç»­äº†è§£å¦ä¸€ä¸ªç»å¸¸ä¸Push APIç»„åˆåœ¨ä¸€èµ·çš„åŠŸèƒ½â€”â€”æ¶ˆæ¯æé†’ï¼ŒNotification APIã€‚\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/6","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/6/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/6/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/6/events","html_url":"https://github.com/alienzhou/blog/issues/6","id":390620823,"node_id":"MDU6SXNzdWUzOTA2MjA4MjM=","number":6,"title":"ã€PWAå­¦ä¹ ä¸å®è·µã€‘(5)åœ¨Webä¸­è¿›è¡ŒæœåŠ¡ç«¯æ¶ˆæ¯æ¨é€","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845017,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE3","url":"https://api.github.com/repos/alienzhou/blog/labels/PWA","name":"PWA","color":"008672","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-12-13T10:47:26Z","updated_at":"2020-07-28T08:59:20Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« å·²æ•´ç†è‡³[gitbook - PWAå­¦ä¹ æ‰‹å†Œ](https://alienzhou.gitbook.io/learning-pwa/)ï¼Œæ–‡å­—å†…å®¹å·²åŒæ­¥è‡³[learning-pwa-ebook](https://github.com/alienzhou/learning-pwa-ebook)ã€‚è½¬è½½è¯·æ³¨æ˜ä½œè€…ä¸å‡ºå¤„ã€‚\r\n\r\næœ¬æ–‡æ˜¯ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—çš„ç¬¬äº”ç¯‡æ–‡ç« ã€‚æ–‡ä¸­çš„ä»£ç éƒ½å¯ä»¥åœ¨[learning-pwaçš„pushåˆ†æ”¯](https://github.com/alienzhou/learning-pwa/tree/push)ä¸Šæ‰¾åˆ°ï¼ˆ`git clone`åæ³¨æ„åˆ‡æ¢åˆ°pushåˆ†æ”¯ï¼‰ã€‚\r\n\r\nPWAä½œä¸ºæ—¶ä¸‹æœ€ç«çƒ­çš„æŠ€æœ¯æ¦‚å¿µä¹‹ä¸€ï¼Œå¯¹æå‡Webåº”ç”¨çš„å®‰å…¨ã€æ€§èƒ½å’Œä½“éªŒæœ‰ç€å¾ˆå¤§çš„æ„ä¹‰ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å»äº†è§£ä¸å­¦ä¹ ã€‚å¯¹PWAæ„Ÿå…´è¶£çš„æœ‹å‹æ¬¢è¿å…³æ³¨ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« ã€‚\r\n\r\n## 1. å¼•è¨€\r\nåœ¨ä¹‹å‰çš„å‡ ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å’Œå¤§å®¶åˆ†äº«äº†å¦‚ä½•ä½¿ç”¨manifestï¼ˆä»¥åŠmetaæ ‡ç­¾ï¼‰è®©ä½ çš„Web Appæ›´åŠ â€œnativeâ€ï¼›ä»¥åŠå¦‚ä½•ä½¿ç”¨Service Workeræ¥cacheèµ„æºï¼ŒåŠ é€ŸWeb Appçš„è®¿é—®é€Ÿåº¦ï¼Œæä¾›éƒ¨åˆ†ç¦»çº¿åŠŸèƒ½ã€‚åœ¨æ¥ä¸‹æ¥çš„å†…å®¹é‡Œï¼Œæˆ‘ä»¬ä¼šæ¢ç©¶PWAä¸­çš„å¦ä¸€ä¸ªé‡è¦åŠŸèƒ½â€”â€”æ¶ˆæ¯æ¨é€ä¸æé†’ï¼ˆPush & Notificationï¼‰ã€‚è¿™ä¸ªèƒ½åŠ›è®©æˆ‘ä»¬å¯ä»¥ä»æœåŠ¡ç«¯å‘ç”¨æˆ·æ¨é€å„ç±»æ¶ˆæ¯å¹¶å¼•å¯¼ç”¨æˆ·è§¦å‘ç›¸åº”äº¤äº’ã€‚\r\n\r\n![Web Pushæ•ˆæœ](https://user-gold-cdn.xitu.io/2018/4/13/162bc97ba69e1679?w=1284&h=746&f=gif&s=1843125)\r\n\r\nå®é™…ä¸Šï¼Œæ¶ˆæ¯æ¨é€ä¸æé†’æ˜¯ä¸¤ä¸ªåŠŸèƒ½â€”â€”Push API å’Œ Notification APIã€‚ä¸ºäº†å¤§å®¶èƒ½å¤Ÿæ›´å¥½ç†è§£å…¶ä¸­çš„ç›¸å…³æŠ€æœ¯ï¼Œæˆ‘ä¹Ÿä¼šåˆ†ä¸ºPushï¼ˆæ¨é€æ¶ˆæ¯ï¼‰ä¸Notificationï¼ˆå±•ç¤ºæé†’ï¼‰ä¸¤éƒ¨åˆ†æ¥ä»‹ç»ã€‚åœ¨è¿™ä¸€ç¯‡é‡Œï¼Œæˆ‘ä»¬å…ˆæ¥å­¦ä¹ å¦‚ä½•ä½¿ç”¨Push APIè¿›è¡Œæ¶ˆæ¯æ¨é€ã€‚\r\n\r\n> Push API å’Œ Notification APIå…¶å®æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„æŠ€æœ¯ï¼Œå®Œå…¨å¯ä»¥åˆ†å¼€ä½¿ç”¨ï¼›ä¸è¿‡Push API å’Œ Notification APIç›¸ç»“åˆæ˜¯ä¸€ä¸ªå¸¸è§çš„æ¨¡å¼ã€‚\r\n\r\n## 2. æµè§ˆå™¨æ˜¯å¦‚ä½•å®ç°æœåŠ¡å™¨æ¶ˆæ¯Pushçš„\r\nWeb Pushçš„æ•´ä¸ªæµç¨‹ç›¸è¾ƒä¹‹å‰çš„å†…å®¹æ¥è¯´æœ‰äº›å¤æ‚ã€‚å› æ­¤ï¼Œåœ¨è¿›å…¥å…·ä½“æŠ€æœ¯ç»†èŠ‚ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸€ä¸‹æ•´ä¸ªPushçš„åŸºæœ¬æµç¨‹ä¸ç›¸å…³æ¦‚å¿µã€‚\r\n\r\nå¦‚æœä½ å¯¹Pushå®Œå…¨ä¸äº†è§£ï¼Œå¯èƒ½ä¼šè®¤ä¸ºï¼ŒPushæ˜¯æˆ‘ä»¬çš„æœåŠ¡ç«¯ç›´æ¥ä¸æµè§ˆå™¨è¿›è¡Œäº¤äº’ï¼Œä½¿ç”¨é•¿è¿æ¥ã€WebSocketæˆ–æ˜¯å…¶ä»–æŠ€æœ¯æ‰‹æ®µæ¥å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ã€‚ç„¶è€Œï¼Œè¿™é‡Œçš„Web Pushå¹¶éå¦‚æ­¤ï¼Œå®ƒå…¶å®æ˜¯ä¸€ä¸ªä¸‰æ–¹äº¤äº’çš„è¿‡ç¨‹ã€‚\r\n\r\nåœ¨Pushä¸­ç™»åœºçš„ä¸‰ä¸ªé‡è¦â€œè§’è‰²â€åˆ†åˆ«æ˜¯ï¼š\r\n- æµè§ˆå™¨ï¼šå°±æ˜¯æˆ‘ä»¬çš„å®¢æˆ·ç«¯\r\n- Push Serviceï¼šä¸“é—¨çš„PushæœåŠ¡ï¼Œä½ å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œç›®å‰chromeä¸firefoxéƒ½æœ‰è‡ªå·±çš„Push Service Serviceã€‚ç†è®ºä¸Šåªè¦æµè§ˆå™¨æ”¯æŒï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„çš„Push Service\r\n- åç«¯æœåŠ¡ï¼šè¿™é‡Œå°±æ˜¯æŒ‡æˆ‘ä»¬è‡ªå·±çš„åç«¯æœåŠ¡\r\n\r\nä¸‹é¢å°±ä»‹ç»ä¸€ä¸‹è¿™ä¸‰è€…åœ¨Web Pushä¸­æ˜¯å¦‚ä½•äº¤äº’ã€‚\r\n\r\n### 2.1. æ¶ˆæ¯æ¨é€æµç¨‹\r\nä¸‹å›¾æ¥è‡ª[Web Pushåè®®è‰æ¡ˆ](https://tools.ietf.org/html/draft-ietf-webpush-protocol-12)ï¼Œæ˜¯Web Pushçš„æ•´ä¸ªæµç¨‹ï¼š\r\n\r\n```\r\n    +-------+           +--------------+       +-------------+\r\n    |  UA   |           | Push Service |       | Application |\r\n    +-------+           +--------------+       |   Server    |\r\n        |                      |               +-------------+\r\n        |      Subscribe       |                      |\r\n        |--------------------->|                      |\r\n        |       Monitor        |                      |\r\n        |<====================>|                      |\r\n        |                      |                      |\r\n        |          Distribute Push Resource           |\r\n        |-------------------------------------------->|\r\n        |                      |                      |\r\n        :                      :                      :\r\n        |                      |     Push Message     |\r\n        |    Push Message      |<---------------------|\r\n        |<---------------------|                      |\r\n        |                      |                      |\r\n```\r\n\r\nè¯¥æ—¶åºå›¾è¡¨æ˜äº†Web Pushçš„å„ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶åˆ†ä¸ºè®¢é˜…ï¼ˆsubscribeï¼‰ä¸æ¨é€ï¼ˆpushï¼‰ä¸¤éƒ¨åˆ†æ¥çœ‹ã€‚\r\n\r\n- **subscribe**ï¼Œé¦–å…ˆæ˜¯è®¢é˜…ï¼š\r\n    1. Ask Permissionï¼šè¿™ä¸€æ­¥ä¸å†ä¸Šå›¾çš„æµç¨‹ä¸­ï¼Œè¿™å…¶å®æ˜¯æµè§ˆå™¨ä¸­çš„ç­–ç•¥ã€‚æµè§ˆå™¨ä¼šè¯¢é—®ç”¨æˆ·æ˜¯å¦å…è®¸é€šçŸ¥ï¼Œåªæœ‰åœ¨ç”¨æˆ·å…è®¸åï¼Œæ‰èƒ½è¿›è¡Œåé¢çš„æ“ä½œã€‚\r\n    1. Subscribeï¼šæµè§ˆå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰éœ€è¦å‘Push Serviceå‘èµ·è®¢é˜…ï¼ˆsubscribeï¼‰ï¼Œè®¢é˜…åä¼šå¾—åˆ°ä¸€ä¸ª[`PushSubscription`](https://developer.mozilla.org/en-US/docs/Web/API/PushSubscription)å¯¹è±¡\r\n    2. Monitorï¼šè®¢é˜…æ“ä½œä¼šå’ŒPush Serviceè¿›è¡Œé€šä¿¡ï¼Œç”Ÿæˆç›¸åº”çš„è®¢é˜…ä¿¡æ¯ï¼ŒPush Serviceä¼šç»´æŠ¤ç›¸åº”ä¿¡æ¯ï¼Œå¹¶åŸºäºæ­¤ä¿æŒä¸å®¢æˆ·ç«¯çš„è”ç³»ï¼›\r\n    3. Distribute Push Resourceï¼šæµè§ˆå™¨è®¢é˜…å®Œæˆåï¼Œä¼šè·å–è®¢é˜…çš„ç›¸å…³ä¿¡æ¯ï¼ˆå­˜åœ¨äº`PushSubscription`å¯¹è±¡ä¸­ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™äº›ä¿¡æ¯å‘é€åˆ°è‡ªå·±çš„æœåŠ¡ç«¯ï¼Œåœ¨æœåŠ¡ç«¯è¿›è¡Œä¿å­˜ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/12/162ba587f2a42eca?w=832&h=207&f=png&s=28689)\r\n\r\n- **Push Message**ï¼Œç„¶åæ˜¯æ¨é€ï¼š\r\n    1. Push Messageé˜¶æ®µä¸€ï¼šæˆ‘ä»¬çš„æœåŠ¡ç«¯éœ€è¦æ¨é€æ¶ˆæ¯æ—¶ï¼Œä¸ç›´æ¥å’Œå®¢æˆ·ç«¯äº¤äº’ï¼Œè€Œæ˜¯é€šè¿‡Web Pushåè®®ï¼Œå°†ç›¸å…³ä¿¡æ¯é€šçŸ¥Push Serviceï¼›\r\n    2. Push Messageé˜¶æ®µäºŒï¼šPush Serviceæ”¶åˆ°æ¶ˆæ¯ï¼Œé€šè¿‡æ ¡éªŒåï¼ŒåŸºäºå…¶ç»´æŠ¤çš„å®¢æˆ·ç«¯ä¿¡æ¯ï¼Œå°†æ¶ˆæ¯æ¨é€ç»™è®¢é˜…äº†çš„å®¢æˆ·ç«¯ï¼›\r\n    3. æœ€åï¼Œå®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯ï¼Œå®Œæˆæ•´ä¸ªæ¨é€è¿‡ç¨‹ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/12/162ba59261481104?w=817&h=218&f=png&s=31789)\r\n\r\n### 2.2. ä»€ä¹ˆæ˜¯Push Service\r\nåœ¨ä¸Šé¢çš„Pushæµç¨‹ä¸­ï¼Œå‡ºç°äº†ä¸€ä¸ªæ¯”è¾ƒå°‘æ¥è§¦åˆ°çš„è§’è‰²ï¼šPush Serviceã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯Push Serviceå‘¢ï¼Ÿ\r\n\r\n> A push service receives a network request, validates it and delivers a push message to the appropriate browser.\r\n\r\nPush Serviceå¯ä»¥æ¥æ”¶ç½‘ç»œè¯·æ±‚ï¼Œæ ¡éªŒè¯¥è¯·æ±‚å¹¶å°†å…¶æ¨é€ç»™åˆé€‚çš„æµè§ˆå™¨å®¢æˆ·ç«¯ã€‚Push Serviceè¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„åŠŸèƒ½ï¼šå½“ç”¨æˆ·ç¦»çº¿æ—¶ï¼Œå¯ä»¥å¸®æˆ‘ä»¬ä¿å­˜æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç›´åˆ°ç”¨æˆ·è”ç½‘åå†å‘é€ç»™ä»–ä»¬ã€‚\r\n\r\nç›®å‰ï¼Œä¸åŒçš„æµè§ˆå™¨å‚å•†ä½¿ç”¨äº†ä¸åŒçš„Push Serviceã€‚ä¾‹å¦‚ï¼Œchromeä½¿ç”¨äº†googleè‡ªå®¶çš„FCMï¼ˆå‰èº«ä¸ºGCMï¼‰ï¼Œfirefoxä¹Ÿæ˜¯ä½¿ç”¨è‡ªå®¶çš„æœåŠ¡ã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦éœ€è¦å†™ä¸åŒçš„ä»£ç æ¥å…¼å®¹ä¸åŒçš„æµè§ˆå™¨æ‰€ä½¿ç”¨çš„æœåŠ¡å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¹¶ä¸ç”¨ã€‚Push Serviceéµå¾ª[Web Push Protocol](https://tools.ietf.org/html/draft-ietf-webpush-protocol-12)ï¼Œå…¶è§„å®šäº†è¯·æ±‚åŠå…¶å¤„ç†çš„å„ç§ç»†èŠ‚ï¼Œè¿™å°±ä¿è¯äº†ï¼Œä¸åŒçš„Push Serviceä¹Ÿä¼šå…·æœ‰æ ‡å‡†çš„è°ƒç”¨æ–¹å¼ã€‚\r\n\r\nè¿™é‡Œå†æä¸€ç‚¹ï¼šæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­è¯´äº†Pushçš„æ ‡å‡†æµç¨‹ï¼Œå…¶ä¸­ç¬¬ä¸€æ­¥å°±æ˜¯æµè§ˆå™¨å‘èµ·è®¢é˜…ï¼Œç”Ÿæˆä¸€ä¸ª`PushSubscription`å¯¹ã€‚Push Serviceä¼šä¸ºæ¯ä¸ªå‘èµ·è®¢é˜…çš„æµè§ˆå™¨ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„URLï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬åœ¨æœåŠ¡ç«¯æ¨é€æ¶ˆæ¯æ—¶ï¼Œå‘è¿™ä¸ªURLè¿›è¡Œæ¨é€åï¼ŒPush Serviceå°±ä¼šçŸ¥é“è¦é€šçŸ¥å“ªä¸ªæµè§ˆå™¨ã€‚è€Œè¿™ä¸ªURLä¿¡æ¯ä¹Ÿåœ¨`PushSubscription`å¯¹è±¡é‡Œï¼Œå«åš`endpoint`ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/14/162bfd2d499ba656?w=1408&h=300&f=png&s=86505)\r\n\r\né‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“äº†`endpoint`çš„å€¼ï¼Œæ˜¯å¦å°±ä»£è¡¨æˆ‘ä»¬å¯ä»¥å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯äº†å‘¢ï¼Ÿå¹¶éå¦‚æ­¤ã€‚ä¸‹é¢ä¼šç®€å•ä»‹ç»ä¸€ä¸‹Web Pushä¸­çš„å®‰å…¨ç­–ç•¥ã€‚\r\n\r\n### 2.3. å¦‚ä½•ä¿è¯Pushçš„å®‰å…¨æ€§\r\nåœ¨Web Pushä¸­ï¼Œä¸ºäº†ä¿è¯å®¢æˆ·ç«¯åªä¼šæ”¶åˆ°å…¶è®¢é˜…çš„æœåŠ¡ç«¯æ¨é€çš„æ¶ˆæ¯ï¼ˆå…¶ä»–çš„æœåŠ¡ç«¯å³ä½¿åœ¨æ‹¿åˆ°`endpoint`ä¹Ÿæ— æ³•æ¨é€æ¶ˆæ¯ï¼‰ï¼Œéœ€è¦å¯¹æ¨é€ä¿¡æ¯è¿›è¡Œæ•°å­—ç­¾åã€‚è¯¥è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š\r\n\r\nåœ¨Web Pushä¸­ä¼šæœ‰ä¸€å¯¹å…¬é’¥ä¸ç§é’¥ã€‚å®¢æˆ·ç«¯æŒæœ‰å…¬é’¥ï¼Œè€ŒæœåŠ¡ç«¯æŒæœ‰ç§é’¥ã€‚å®¢æˆ·ç«¯åœ¨è®¢é˜…æ—¶ï¼Œä¼šå°†å…¬é’¥å‘é€ç»™Push Serviceï¼Œè€ŒPush Serviceä¼šå°†è¯¥å…¬é’¥ä¸ç›¸åº”çš„`endpoint`ç»´æŠ¤èµ·æ¥ã€‚è€Œå½“æœåŠ¡ç«¯è¦æ¨é€æ¶ˆæ¯æ—¶ï¼Œä¼šä½¿ç”¨ç§é’¥å¯¹å‘é€çš„æ•°æ®è¿›è¡Œæ•°å­—ç­¾åï¼Œå¹¶æ ¹æ®æ•°å­—ç­¾åç”Ÿæˆä¸€ä¸ªå«`Authorization`è¯·æ±‚å¤´ã€‚Push Serviceæ”¶åˆ°è¯·æ±‚åï¼Œæ ¹æ®`endpoint`å–åˆ°å…¬é’¥ï¼Œå¯¹æ•°å­—ç­¾åè§£å¯†éªŒè¯ï¼Œå¦‚æœä¿¡æ¯ç›¸ç¬¦åˆ™è¡¨æ˜è¯¥è¯·æ±‚æ˜¯é€šè¿‡å¯¹åº”çš„ç§é’¥åŠ å¯†è€Œæˆï¼Œä¹Ÿè¡¨æ˜è¯¥è¯·æ±‚æ¥è‡ªæµè§ˆå™¨æ‰€è®¢é˜…çš„æœåŠ¡ç«¯ã€‚åä¹‹äº¦ç„¶ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/12/162ba68f0d4a5861?w=998&h=441&f=png&s=83966)\r\n\r\nè€Œå…¬é’¥ä¸ç§é’¥å¦‚ä½•ç”Ÿæˆï¼Œä¼šåœ¨ç¬¬ä¸‰éƒ¨åˆ†çš„å®ä¾‹ä¸­è®²è§£ã€‚\r\n\r\n## 3. å¦‚ä½•ä½¿ç”¨Push APIæ¥æ¨é€å‘ç”¨æˆ·æ¨é€ä¿¡æ¯\r\nåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»åŸºæœ¬äº†è§£äº†Web Pushçš„æµç¨‹ã€‚å…‰è¯´ä¸ç»ƒå‡æŠŠå¼ï¼Œä¸‹é¢æˆ‘å°±é€šè¿‡å…·ä½“ä»£ç æ¥è¯´æ˜å¦‚ä½•ä½¿ç”¨Web Pushã€‚\r\n\r\nè¿™éƒ¨åˆ†ä¼šåŸºäº[sw-cache](https://github.com/alienzhou/learning-pwa/tree/sw-cache)åˆ†æ”¯ä¸Šçš„ä»£ç ï¼Œç»§ç»­å¢å¼ºæˆ‘ä»¬çš„â€œå›¾ä¹¦æœç´¢â€WebAppã€‚\r\n\r\nä¸ºäº†ä½¿æ–‡ç« ä¸ä»£ç æ›´æ¸…æ™°ï¼Œå°†Web Pushåˆ†ä¸ºè¿™å‡ ä¸ªéƒ¨åˆ†ï¼š\r\n1. æµè§ˆå™¨å‘èµ·è®¢é˜…ï¼Œå¹¶å°†è®¢é˜…ä¿¡æ¯å‘é€è‡³åç«¯ï¼›\r\n2. å°†è®¢é˜…ä¿¡æ¯ä¿å­˜åœ¨æœåŠ¡ç«¯ï¼Œä»¥ä¾¿ä»Šåæ¨é€ä½¿ç”¨ï¼›\r\n3. æœåŠ¡ç«¯æ¨é€æ¶ˆæ¯ï¼Œå‘Push Serviceå‘èµ·è¯·æ±‚ï¼›\r\n4. æµè§ˆå™¨æ¥æ”¶Pushä¿¡æ¯å¹¶å¤„ç†ã€‚\r\n\r\n> å‹æƒ…æé†’ï¼šç”±äºChromeæ‰€ä¾èµ–çš„Push Serviceâ€”â€”FCMåœ¨å›½å†…ä¸å¯è®¿é—®ï¼Œæ‰€ä»¥è¦æ­£å¸¸è¿è¡Œdemoä¸­çš„ä»£ç éœ€è¦â€œæ¢¯å­â€ï¼Œæˆ–è€…å¯ä»¥é€‰æ‹©Firefoxæ¥è¿›è¡Œæµ‹è¯•ã€‚\r\n\r\n### 3.1. æµè§ˆå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰ç”Ÿæˆsubscriptionä¿¡æ¯\r\né¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨`PushManager`çš„`subscribe`æ–¹æ³•æ¥åœ¨æµè§ˆå™¨ä¸­è¿›è¡Œè®¢é˜…ã€‚\r\n\r\nåœ¨ã€Šè®©ä½ çš„WebAppç¦»çº¿å¯ç”¨ã€‹ä¸­æˆ‘ä»¬å·²ç»çŸ¥é“äº†å¦‚ä½•æ³¨å†ŒService Workerã€‚å½“æˆ‘ä»¬æ³¨å†Œå®ŒService Workeråä¼šå¾—åˆ°ä¸€ä¸ª`Registration`å¯¹è±¡ï¼Œé€šè¿‡è°ƒç”¨`Registration`å¯¹è±¡çš„`registration.pushManager.subscribe()`æ–¹æ³•å¯ä»¥å‘èµ·è®¢é˜…ã€‚\r\n\r\nä¸ºäº†ä½¿ä»£ç æ›´æ¸…æ™°ï¼Œæœ¬ç¯‡demoåœ¨ä¹‹å‰çš„åŸºç¡€ä¸Šï¼Œå…ˆæŠ½ç¦»å‡ºService Workerçš„æ³¨å†Œæ–¹æ³•ï¼š\r\n\r\n```javascript\r\n// index.js\r\nfunction registerServiceWorker(file) {\r\n    return navigator.serviceWorker.register(file);\r\n}\r\n```\r\n\r\nç„¶åå®šä¹‰äº†`subscribeUserToPush()`æ–¹æ³•æ¥å‘èµ·è®¢é˜…ï¼š\r\n\r\n```javascript\r\n// index.js\r\nfunction subscribeUserToPush(registration, publicKey) {\r\n    var subscribeOptions = {\r\n        userVisibleOnly: true,\r\n        applicationServerKey: window.urlBase64ToUint8Array(publicKey)\r\n    }; \r\n    return registration.pushManager.subscribe(subscribeOptions).then(function (pushSubscription) {\r\n        console.log('Received PushSubscription: ', JSON.stringify(pushSubscription));\r\n        return pushSubscription;\r\n    });\r\n}\r\n\r\n```\r\n\r\nè¿™é‡Œä½¿ç”¨äº†`registration.pushManager.subscribe()`æ–¹æ³•ä¸­çš„ä¸¤ä¸ªé…ç½®å‚æ•°ï¼š`userVisibleOnly`å’Œ`applicationServerKey`ã€‚\r\n\r\n- `userVisibleOnly`è¡¨æ˜è¯¥æ¨é€æ˜¯å¦éœ€è¦æ˜¾æ€§åœ°å±•ç¤ºç»™ç”¨æˆ·ï¼Œå³æ¨é€æ—¶æ˜¯å¦ä¼šæœ‰æ¶ˆæ¯æé†’ã€‚å¦‚æœæ²¡æœ‰æ¶ˆæ¯æé†’å°±è¡¨æ˜æ˜¯è¿›è¡Œâ€œé™é»˜â€æ¨é€ã€‚åœ¨Chromeä¸­ï¼Œå¿…é¡»è¦å°†å…¶è®¾ç½®ä¸º`true`ï¼Œå¦åˆ™æµè§ˆå™¨å°±ä¼šåœ¨æ§åˆ¶å°æŠ¥é”™ï¼š\r\n\r\n![userVisibleOnlyä¸ä¸ºtrueæ—¶çš„æŠ¥é”™ä¿¡æ¯](https://user-gold-cdn.xitu.io/2018/4/13/162ba99a6b69af03?w=1458&h=120&f=png&s=58047)\r\n\r\n- `applicationServerKey`æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„å…¬é’¥ï¼Œ[VAPID](https://tools.ietf.org/html/draft-thomson-webpush-vapid-02)å®šä¹‰äº†å…¶è§„èŒƒï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç§°ä¸ºVAPID keysã€‚å¦‚æœä½ è¿˜è®°å¾—2.3ä¸­æåˆ°çš„å®‰å…¨ç­–ç•¥ï¼Œåº”è¯¥å¯¹è¿™ä¸ªå…¬é’¥ä¸é™Œç”Ÿã€‚è¯¥å‚æ•°éœ€è¦Unit8Arrayç±»å‹ã€‚å› æ­¤å®šä¹‰äº†ä¸€ä¸ª[`urlBase64ToUint8Array`](https://github.com/alienzhou/learning-pwa/blob/push/public/base64util.js)æ–¹æ³•å°†base64çš„å…¬é’¥å­—ç¬¦ä¸²è½¬ä¸ºUnit8Arrayã€‚`subscribe()`ä¹Ÿæ˜¯ä¸€ä¸ªPromiseæ–¹æ³•ï¼Œåœ¨thenä¸­æˆ‘ä»¬å¯ä»¥å¾—åˆ°è®¢é˜…çš„ç›¸å…³ä¿¡æ¯â€”â€”ä¸€ä¸ª`PushSubscription`å¯¹è±¡ã€‚ä¸‹å›¾å±•ç¤ºäº†è¿™ä¸ªå¯¹è±¡ä¸­çš„ä¸€äº›ä¿¡æ¯ã€‚æ³¨æ„å…¶ä¸­çš„`endpoint`ï¼ŒPush Serviceä¼šä¸ºæ¯ä¸ªå®¢æˆ·ç«¯éšæœºç”Ÿæˆä¸€ä¸ªä¸åŒçš„å€¼.\r\n\r\n![PushSubscriptionä¿¡æ¯](https://user-gold-cdn.xitu.io/2018/4/14/162bfd2d499ba656?w=1408&h=300&f=png&s=86505)\r\n\r\nä¹‹åï¼Œæˆ‘ä»¬å†å°†`PushSubscription`ä¿¡æ¯å‘é€åˆ°åç«¯ã€‚è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ª`sendSubscriptionToServer()`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„XHRè¯·æ±‚ï¼Œä¼šå‘æ¥å£postè®¢é˜…ä¿¡æ¯ï¼Œä¸ºäº†èŠ‚çº¦ç¯‡å¹…å°±ä¸åˆ—å‡ºå…·ä½“ä»£ç äº†ã€‚\r\n\r\næœ€åï¼Œå°†è¿™ä¸€ç³»åˆ—æ–¹æ³•ç»„åˆåœ¨ä¸€èµ·ã€‚å½“ç„¶ï¼Œä½¿ç”¨Web Pushå‰ï¼Œè¿˜æ˜¯éœ€è¦è¿›è¡Œç‰¹æ€§æ£€æµ‹`'PushManager' in window`ã€‚\r\n\r\n```javascript\r\n// index.js\r\nif ('serviceWorker' in navigator && 'PushManager' in window) {\r\n    var publicKey = 'BOEQSjdhorIf8M0XFNlwohK3sTzO9iJwvbYU-fuXRF0tvRpPPMGO6d_gJC_pUQwBT7wD8rKutpNTFHOHN3VqJ0A';\r\n    // æ³¨å†Œservice worker\r\n    registerServiceWorker('./sw.js').then(function (registration) {\r\n        console.log('Service Worker æ³¨å†ŒæˆåŠŸ');\r\n        // å¼€å¯è¯¥å®¢æˆ·ç«¯çš„æ¶ˆæ¯æ¨é€è®¢é˜…åŠŸèƒ½\r\n        return subscribeUserToPush(registration, publicKey);\r\n    }).then(function (subscription) {\r\n        var body = {subscription: subscription};\r\n        // ä¸ºäº†æ–¹ä¾¿ä¹‹åçš„æ¨é€ï¼Œä¸ºæ¯ä¸ªå®¢æˆ·ç«¯ç®€å•ç”Ÿæˆä¸€ä¸ªæ ‡è¯†\r\n        body.uniqueid = new Date().getTime();\r\n        console.log('uniqueid', body.uniqueid);\r\n        // å°†ç”Ÿæˆçš„å®¢æˆ·ç«¯è®¢é˜…ä¿¡æ¯å­˜å‚¨åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Š\r\n        return sendSubscriptionToServer(JSON.stringify(body));\r\n    }).then(function (res) {\r\n        console.log(res);\r\n    }).catch(function (err) {\r\n        console.log(err);\r\n    });\r\n}\r\n```\r\n\r\næ³¨æ„ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬åé¢çš„æ¨é€ï¼Œä¸ºæ¯ä¸ªå®¢æˆ·ç«¯ç”Ÿæˆäº†ä¸€ä¸ªå”¯ä¸€ID`uniqueid`ï¼Œè¿™é‡Œä½¿ç”¨äº†æ—¶é—´æˆ³ç”Ÿæˆç®€å•çš„`uniqueid`ã€‚\r\n\r\næ­¤å¤–ï¼Œç”±äº`userVisibleOnly`ä¸º`true`ï¼Œæ‰€ä»¥éœ€è¦ç”¨æˆ·æˆæƒå¼€å¯é€šçŸ¥æƒé™ï¼Œå› æ­¤æˆ‘ä»¬ä¼šçœ‹åˆ°ä¸‹é¢çš„æç¤ºæ¡†ï¼Œé€‰æ‹©â€œå…è®¸â€å³å¯ã€‚ä½ å¯ä»¥åœ¨è®¾ç½®ä¸­è¿›è¡Œé€šçŸ¥çš„ç®¡ç†ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/12/162ba85304cba1f5?w=724&h=340&f=png&s=39311)\r\n\r\n### 3.2. æœåŠ¡ç«¯å­˜å‚¨å®¢æˆ·ç«¯subscriptionä¿¡æ¯\r\nä¸ºäº†å­˜å‚¨æµè§ˆå™¨postæ¥çš„è®¢é˜…ä¿¡æ¯ï¼ŒæœåŠ¡ç«¯éœ€è¦å¢åŠ ä¸€ä¸ªæ¥å£`/subscription`ï¼ŒåŒæ—¶æ·»åŠ ä¸­é—´ä»¶`koa-body`ç”¨äºå¤„ç†body\r\n\r\n```javascript\r\n// app.js\r\nconst koaBody = require('koa-body');\r\n/**\r\n * æäº¤subscriptionä¿¡æ¯ï¼Œå¹¶ä¿å­˜\r\n */\r\nrouter.post('/subscription', koaBody(), async ctx => {\r\n    let body = ctx.request.body;\r\n    await util.saveRecord(body);\r\n    ctx.response.body = {\r\n        status: 0\r\n    };\r\n});\r\n```\r\n\r\næ¥æ”¶åˆ°subscriptionä¿¡æ¯åï¼Œéœ€è¦åœ¨æœåŠ¡ç«¯è¿›è¡Œä¿å­˜ï¼Œä½ å¯ä½¿ç”¨ä»»ä½•æ–¹å¼æ¥ä¿å­˜å®ƒï¼šmysqlã€redisã€mongodbâ€¦â€¦è¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä½¿ç”¨äº†[nedb](https://github.com/louischatriot/nedb)æ¥è¿›è¡Œç®€å•çš„å­˜å‚¨ã€‚nedbä¸éœ€è¦éƒ¨ç½²å®‰è£…ï¼Œå¯ä»¥å°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä¹Ÿå¯ä»¥æŒä¹…åŒ–ï¼Œnedbçš„apiå’Œmongodbä¹Ÿæ¯”è¾ƒç±»ä¼¼ã€‚\r\n\r\nè¿™é‡Œ`util.saveRecord()`åšäº†è¿™äº›å·¥ä½œï¼šé¦–å…ˆï¼ŒæŸ¥è¯¢`subscription`ä¿¡æ¯æ˜¯å¦å­˜åœ¨ï¼Œè‹¥å·²å­˜åœ¨åˆ™åªæ›´æ–°`uniqueid`ï¼›å¦åˆ™ï¼Œç›´æ¥è¿›è¡Œå­˜å‚¨ã€‚\r\n\r\nè‡³æ­¤ï¼Œæˆ‘ä»¬å°±å°†å®¢æˆ·ç«¯çš„è®¢é˜…ä¿¡æ¯å­˜å‚¨å®Œæ¯•äº†ã€‚ç°åœ¨ï¼Œå°±å¯ä»¥ç­‰å¾…ä»Šåæ¨é€æ—¶ä½¿ç”¨ã€‚\r\n\r\n### 3.3. ä½¿ç”¨subscriptionä¿¡æ¯æ¨é€ä¿¡æ¯\r\nåœ¨å®é™…ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šç»™è¿è¥æˆ–äº§å“åŒå­¦æä¾›ä¸€ä¸ªæ¨é€é…ç½®åå°ã€‚å¯ä»¥é€‰æ‹©ç›¸åº”çš„å®¢æˆ·ç«¯ï¼Œå¡«å†™æ¨é€ä¿¡æ¯ï¼Œå¹¶å‘èµ·æ¨é€ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘å¹¶æ²¡æœ‰å†™ä¸€ä¸ªæ¨é€é…ç½®åå°ï¼Œè€Œåªæä¾›äº†ä¸€ä¸ªpostæ¥å£`/push`æ¥æäº¤æ¨é€ä¿¡æ¯ã€‚åæœŸæˆ‘ä»¬å®Œå…¨å¯ä»¥å¼€å‘ç›¸åº”çš„æ¨é€åå°æ¥è°ƒç”¨è¯¥æ¥å£ã€‚\r\n\r\n```javascript\r\n// app.js\r\n/**\r\n * æ¶ˆæ¯æ¨é€APIï¼Œå¯ä»¥åœ¨ç®¡ç†åå°è¿›è¡Œè°ƒç”¨\r\n * æœ¬ä¾‹å­ä¸­ï¼Œå¯ä»¥ç›´æ¥postä¸€ä¸ªè¯·æ±‚æ¥æŸ¥çœ‹æ•ˆæœ\r\n */\r\nrouter.post('/push', koaBody(), async ctx => {\r\n    let {uniqueid, payload} = ctx.request.body;\r\n    let list = uniqueid ? await util.find({uniqueid}) : await util.findAll();\r\n    let status = list.length > 0 ? 0 : -1;\r\n\r\n    for (let i = 0; i < list.length; i++) {\r\n        let subscription = list[i].subscription;\r\n        pushMessage(subscription, JSON.stringify(payload));\r\n    }\r\n\r\n    ctx.response.body = {\r\n        status\r\n    };\r\n});\r\n```\r\n\r\næ¥çœ‹ä¸€ä¸‹`/push`æ¥å£ã€‚\r\n\r\n1. é¦–å…ˆï¼Œæ ¹æ®postçš„å‚æ•°ä¸åŒï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`uniqueid`æ¥æŸ¥è¯¢æŸæ¡è®¢é˜…ä¿¡æ¯ï¼š`util.find({uniqueid})`ï¼›ä¹Ÿå¯ä»¥ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ‰€æœ‰è®¢é˜…ä¿¡æ¯ï¼š`util.findAll()`ã€‚\r\n2. ç„¶åé€šè¿‡`pushMessage()`æ–¹æ³•å‘Push Serviceå‘é€è¯·æ±‚ã€‚æ ¹æ®ç¬¬äºŒèŠ‚çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œè¯¥è¯·æ±‚éœ€è¦ç¬¦åˆWeb Pushåè®®ã€‚ç„¶è€Œï¼ŒWeb Pushåè®®çš„è¯·æ±‚å°è£…ã€åŠ å¯†å¤„ç†ç›¸å…³æ“ä½œéå¸¸ç¹çã€‚å› æ­¤ï¼ŒWeb Pushä¸ºå„ç§è¯­è¨€çš„å¼€å‘è€…æä¾›äº†ä¸€ç³»åˆ—å¯¹åº”çš„åº“ï¼š[Web Push Libaray](https://github.com/web-push-libs)ï¼Œç›®å‰æœ‰NodeJSã€PHPã€Pythonã€Javaç­‰ã€‚æŠŠè¿™äº›å¤æ‚è€Œç¹ççš„æ“ä½œäº¤ç»™å®ƒä»¬å¯ä»¥è®©æˆ‘ä»¬äº‹åŠåŠŸå€ã€‚\r\n3. æœ€åè¿”å›ç»“æœï¼Œè¿™é‡Œåªæ˜¯ç®€å•çš„æ ¹æ®æ˜¯å¦æœ‰è®¢é˜…ä¿¡æ¯æ¥è¿›è¡Œè¿”å›ã€‚\r\n\r\nå®‰è£…nodeç‰ˆweb-push\r\n\r\n```bash\r\nnpm install web-push --save\r\n```\r\n\r\nå‰é¢æˆ‘ä»¬æåˆ°çš„å…¬é’¥ä¸ç§é’¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡web-pushæ¥ç”Ÿæˆ\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/13/162badb18824ff12?w=644&h=159&f=png&s=26820)\r\n\r\nä½¿ç”¨web-pushéå¸¸ç®€å•ï¼Œé¦–å…ˆè®¾ç½®VAPID keysï¼š\r\n\r\n```javascript\r\n// app.js\r\nconst webpush = require('web-push');\r\n/**\r\n * VAPIDå€¼\r\n * è¿™é‡Œå¯ä»¥æ›¿æ¢ä¸ºä½ ä¸šåŠ¡ä¸­å®é™…çš„å€¼\r\n */\r\nconst vapidKeys = {\r\n    publicKey: 'BOEQSjdhorIf8M0XFNlwohK3sTzO9iJwvbYU-fuXRF0tvRpPPMGO6d_gJC_pUQwBT7wD8rKutpNTFHOHN3VqJ0A',\r\n    privateKey: 'TVe_nJlciDOn130gFyFYP8UiGxxWd3QdH6C5axXpSgM'\r\n};\r\n\r\n// è®¾ç½®web-pushçš„VAPIDå€¼\r\nwebpush.setVapidDetails(\r\n    'mailto:alienzhou16@163.com',\r\n    vapidKeys.publicKey,\r\n    vapidKeys.privateKey\r\n);\r\n```\r\nè®¾ç½®å®Œæˆåå³å¯ä½¿ç”¨`webpush.sendNotification()`æ–¹æ³•å‘Push Serviceå‘èµ·è¯·æ±‚ã€‚\r\n\r\næœ€åæˆ‘ä»¬æ¥çœ‹ä¸‹`pushMessage()`æ–¹æ³•çš„ç»†èŠ‚ï¼š\r\n\r\n```javascript\r\n// app.js\r\n/**\r\n * å‘push serviceæ¨é€ä¿¡æ¯\r\n * @param {*} subscription \r\n * @param {*} data \r\n */\r\nfunction pushMessage(subscription, data = {}) {\r\n    webpush.sendNotification(subscription, data, options).then(data => {\r\n        console.log('push serviceçš„ç›¸åº”æ•°æ®:', JSON.stringify(data));\r\n        return;\r\n    }).catch(err => {\r\n        // åˆ¤æ–­çŠ¶æ€ç ï¼Œ440å’Œ410è¡¨ç¤ºå¤±æ•ˆ\r\n        if (err.statusCode === 410 || err.statusCode === 404) {\r\n            return util.remove(subscription);\r\n        }\r\n        else {\r\n            console.log(subscription);\r\n            console.log(err);\r\n        }\r\n    })\r\n}\r\n```\r\n`webpush.sendNotification`ä¸ºæˆ‘ä»¬å°è£…äº†è¯·æ±‚çš„å¤„ç†ç»†èŠ‚ã€‚çŠ¶æ€ç 401å’Œ404è¡¨ç¤ºè¯¥subscriptionå·²ç»æ— æ•ˆï¼Œå¯ä»¥ä»æ•°æ®åº“ä¸­åˆ é™¤ã€‚\r\n\r\n### 3.4. Service Workerç›‘å¬Pushæ¶ˆæ¯\r\nè°ƒç”¨`webpush.sendNotification()`åï¼Œæˆ‘ä»¬å°±å·²ç»æŠŠæ¶ˆæ¯å‘é€è‡³Push Serviceäº†ï¼›è€ŒPush Serviceä¼šå°†æˆ‘ä»¬çš„æ¶ˆæ¯æ¨é€è‡³æµè§ˆå™¨ã€‚\r\n\r\nè¦æƒ³åœ¨æµè§ˆå™¨ä¸­è·å–æ¨é€ä¿¡æ¯ï¼Œåªéœ€åœ¨Service Workerä¸­ç›‘å¬`push`çš„äº‹ä»¶å³å¯ï¼š\r\n\r\n```javascript\r\n// sw.js\r\nself.addEventListener('push', function (e) {\r\n    var data = e.data;\r\n    if (e.data) {\r\n        data = data.json();\r\n        console.log('pushçš„æ•°æ®ä¸ºï¼š', data);\r\n        self.registration.showNotification(data.text);        \r\n    } \r\n    else {\r\n        console.log('pushæ²¡æœ‰ä»»ä½•æ•°æ®');\r\n    }\r\n});\r\n```\r\n\r\n## 4. æ•ˆæœå±•ç¤º\r\næˆ‘ä»¬åŒæ—¶ä½¿ç”¨firefoxä¸chromeæ¥è®¿é—®è¯¥WebAppï¼Œå¹¶åˆ†åˆ«å‘è¿™ä¸¤ä¸ªå®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨consoleä¸­æ‰“å°å‡ºæ¥çš„uniqueidï¼Œåœ¨postmanä¸­å‘èµ·`/push`è¯·æ±‚è¿›è¡Œæµ‹è¯•ã€‚\r\n\r\n![Web Pushæ•ˆæœ](https://user-gold-cdn.xitu.io/2018/4/13/162bc954b09d78cf?w=1277&h=774&f=gif&s=2877596)\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åˆ†åˆ«å‘firefoxä¸chromeä¸­æ¨é€äº†â€œwelcome to PWAâ€è¿™æ¡æ¶ˆæ¯ã€‚consoleä¸­çš„è¾“å‡ºæ¥è‡ªäºService Workerä¸­å¯¹pushäº‹ä»¶çš„ç›‘å¬ã€‚è€Œå¼¹å‡ºçš„æµè§ˆå™¨æé†’åˆ™æ¥è‡ªäºä¹‹å‰æåˆ°çš„ã€è®¢é˜…æ—¶é…ç½®çš„`userVisibleOnly: true`å±æ€§ã€‚åœ¨åç»­çš„æ–‡ç« é‡Œï¼Œæˆ‘ç»§ç»­å¸¦å¤§å®¶äº†è§£Notification APIï¼ˆæé†’ï¼‰çš„ä½¿ç”¨ã€‚\r\n\r\næ­£å¦‚å‰æ–‡æ‰€è¿°ï¼ŒPush Serviceå¯ä»¥åœ¨è®¾å¤‡ç¦»çº¿æ—¶ï¼Œå¸®ä½ ç»´æŠ¤æ¨é€æ¶ˆæ¯ã€‚å½“æµè§ˆå™¨è®¾å¤‡é‡æ–°è”ç½‘æ—¶ï¼Œå°±ä¼šæ”¶åˆ°è¯¥æ¨é€ã€‚ä¸‹é¢å±•ç¤ºäº†åœ¨è®¾å¤‡æ¢å¤è”ç½‘åï¼Œå°±ä¼šæ”¶åˆ°æ¨é€ï¼š\r\n\r\n![æ¢å¤ç½‘ç»œåˆ™ä¼šæ”¶åˆ°æ¨é€æ¶ˆæ¯](https://user-gold-cdn.xitu.io/2018/4/14/162bfe83b578881f?w=2560&h=1600&f=gif&s=2478281)\r\n\r\n## 5. ä¸‡æ¶çš„å…¼å®¹æ€§\r\nåˆåˆ°äº†æŸ¥çœ‹[å…¼å®¹æ€§](https://caniuse.com/#search=push)çš„æ—¶é—´äº†ã€‚æ¯”è¾ƒé‡è¦çš„æ˜¯ï¼Œå¯¹äºPush APIï¼Œç›®å‰Safariå›¢é˜Ÿå¹¶æ²¡æœ‰æ˜ç¡®è¡¨æ€è®¡åˆ’æ”¯æŒã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/13/162bfa0147d2b40d?w=2346&h=918&f=png&s=192351)\r\n\r\nå½“ç„¶ï¼Œå…¶å®æ¯”å…¼å®¹æ€§æ›´å¤§çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼ŒChromeæ‰€ä¾èµ–çš„FCMæœåŠ¡åœ¨å›½å†…æ˜¯æ— æ³•è®¿é—®çš„ï¼Œè€ŒFirefoxçš„æœåŠ¡åœ¨å›½å†…å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨ä»£ç ä¸­ä¼šæœ‰è¿™ä¸€é¡¹è®¾ç½®ï¼š\r\n\r\n```javascript\r\nconst options = {\r\n    // proxy: 'http://localhost:1087' // ä½¿ç”¨FCMï¼ˆChromeï¼‰éœ€è¦é…ç½®ä»£ç†\r\n};\r\n```\r\n\r\nä¸Šé¢ä»£ç å…¶å®æ˜¯ç”¨æ¥é…ç½®web-pushä»£ç†çš„ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œç›®å‰ä»npmä¸Šå®‰è£…çš„web-pushæ˜¯ä¸æ”¯æŒè®¾ç½®ä»£ç†é€‰é¡¹çš„ã€‚é’ˆå¯¹è¿™ç‚¹githubä¸Šä¸“é—¨æœ‰[issue](https://github.com/web-push-libs/web-push/issues/280)è¿›è¡Œäº†è®¨è®ºï¼Œå¹¶åœ¨æœ€è¿‘ï¼ˆä¸¤å‘¨å‰ï¼‰åˆå…¥äº†[ç›¸åº”çš„PR](https://github.com/web-push-libs/web-push/commit/f099ec8ff97e86fb6778ece04bd27a36ef93655e)ã€‚å› æ­¤ï¼Œå¦‚æœéœ€è¦web-pushæ”¯æŒä»£ç†ï¼Œç®€å•çš„æ–¹å¼å°±æ˜¯åŸºäºmasterè¿›è¡Œweb-pushä»£ç çš„ç›¸åº”è°ƒæ•´ã€‚\r\n\r\nè™½ç„¶ç”±äºgoogleæœåŠ¡è¢«å±è”½ï¼Œå¯¼è‡´å›½å†…PushåŠŸèƒ½æ— æ³•åœ¨chromeä¸Šä½¿ç”¨ï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ªé‡è¦çš„æŠ€æœ¯ç‚¹ï¼ŒWeb Pushè¿˜æ˜¯éå¸¸å€¼å¾—æˆ‘ä»¬äº†è§£ä¸å­¦ä¹ çš„ã€‚\r\n\r\n## 6. å†™åœ¨æœ€å\r\næœ¬æ–‡ä¸­æ‰€æœ‰çš„ä»£ç ç¤ºä¾‹å‡å¯ä»¥åœ¨[learn-pwa/push](https://github.com/alienzhou/learning-pwa/tree/push)ä¸Šæ‰¾åˆ°ã€‚æ³¨æ„åœ¨git cloneä¹‹åï¼Œåˆ‡æ¢åˆ°pushåˆ†æ”¯ã€‚åˆ‡æ¢å…¶ä»–åˆ†æ”¯å¯ä»¥çœ‹åˆ°ä¸åŒçš„ç‰ˆæœ¬ï¼š\r\n- basicåˆ†æ”¯ï¼šåŸºç¡€é¡¹ç›®demoï¼Œä¸€ä¸ªæ™®é€šçš„å›¾ä¹¦æœç´¢åº”ç”¨ï¼ˆç½‘ç«™ï¼‰ï¼›\r\n- manifeståˆ†æ”¯ï¼šåŸºäºbasicåˆ†æ”¯ï¼Œæ·»åŠ manifestç­‰åŠŸèƒ½ï¼›\r\n- sw-cacheåˆ†æ”¯ï¼šåŸºäºmanifeståˆ†æ”¯ï¼Œæ·»åŠ ç¼“å­˜ä¸ç¦»çº¿åŠŸèƒ½ï¼›\r\n- pushåˆ†æ”¯ï¼šåŸºäºsw-cacheåˆ†æ”¯ï¼Œæ·»åŠ æœåŠ¡ç«¯æ¶ˆæ¯æ¨é€åŠŸèƒ½ï¼›\r\n- masteråˆ†æ”¯ï¼šåº”ç”¨çš„æœ€æ–°ä»£ç ã€‚\r\n\r\nå¦‚æœä½ å–œæ¬¢æˆ–æƒ³è¦äº†è§£æ›´å¤šçš„PWAç›¸å…³çŸ¥è¯†ï¼Œæ¬¢è¿å…³æ³¨æˆ‘ï¼Œå…³æ³¨ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« ã€‚æˆ‘ä¼šæ€»ç»“æ•´ç†è‡ªå·±å­¦ä¹ PWAè¿‡ç¨‹çš„é‡åˆ°çš„ç–‘é—®ä¸æŠ€æœ¯ç‚¹ï¼Œå¹¶é€šè¿‡å®é™…ä»£ç å’Œå¤§å®¶ä¸€èµ·å®è·µã€‚\r\n\r\nåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä»¬å…ˆç¼“ä¸‹è„šæ­¥â€”â€”å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚åœ¨ç»§ç»­äº†è§£æ›´å¤šPWAç›¸å…³æŠ€æœ¯ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€äº›chromeä¸Šçš„PWAè°ƒè¯•æŠ€å·§ã€‚ä¹‹åï¼Œæˆ‘ä»¬ä¼šå†å›æ¥ç»§ç»­äº†è§£å¦ä¸€ä¸ªç»å¸¸ä¸Push APIç»„åˆåœ¨ä¸€èµ·çš„åŠŸèƒ½â€”â€”æ¶ˆæ¯æé†’ï¼ŒNotification APIã€‚\r\n\r\n## å‚è€ƒèµ„æ–™\r\n- [Generic Event Delivery Using HTTP Pus (draft-ietf-webpush-protocol-12)](https://tools.ietf.org/html/draft-ietf-webpush-protocol-12)\r\n- [FCMç®€å•ä»‹ç»](https://segmentfault.com/a/1190000010977980)\r\n- [How Push Works](https://developers.google.com/web/fundamentals/push-notifications/how-push-works)","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/5","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/5/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/5/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/5/events","html_url":"https://github.com/alienzhou/blog/issues/5","id":390620176,"node_id":"MDU6SXNzdWUzOTA2MjAxNzY=","number":5,"title":"ã€PWAå­¦ä¹ ä¸å®è·µã€‘(4) è§£å†³FireBase loginéªŒè¯å¤±è´¥é—®é¢˜","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845017,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE3","url":"https://api.github.com/repos/alienzhou/blog/labels/PWA","name":"PWA","color":"008672","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-12-13T10:45:57Z","updated_at":"2020-04-25T03:57:56Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« å·²æ•´ç†è‡³[gitbook - PWAå­¦ä¹ æ‰‹å†Œ](https://alienzhou.gitbook.io/learning-pwa/)ï¼Œæ–‡å­—å†…å®¹å·²åŒæ­¥è‡³[learning-pwa-ebook](https://github.com/alienzhou/learning-pwa-ebook)ã€‚è½¬è½½è¯·æ³¨æ˜ä½œè€…ä¸å‡ºå¤„ã€‚\r\n\r\næœ¬æ–‡æ˜¯ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—çš„ç¬¬å››ç¯‡ã€‚æ˜¯æˆ‘åœ¨æµ‹è¯•å…¶ä»–demoæ—¶é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œç®—æ˜¯ä¸€ç¯‡TroubleShootingã€‚\r\n\r\nPWAä½œä¸ºæ—¶ä¸‹æœ€ç«çƒ­çš„æŠ€æœ¯æ¦‚å¿µä¹‹ä¸€ï¼Œå¯¹æå‡Webåº”ç”¨çš„å®‰å…¨ã€æ€§èƒ½å’Œä½“éªŒæœ‰ç€å¾ˆå¤§çš„æ„ä¹‰ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å»äº†è§£ä¸å­¦ä¹ ã€‚å¯¹PWAæ„Ÿå…´è¶£çš„æœ‹å‹æ¬¢è¿å…³æ³¨ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« ã€‚\r\n\r\n\r\n## å¼•è¨€\r\nåœ¨å‰ä¸€ç¯‡æ–‡ç« ã€Šè®©ä½ çš„WebAppç¦»çº¿å¯ç”¨ã€‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Service Workeræ¥åšç¼“å­˜ä¸ç¦»çº¿æ”¯æŒã€‚æ˜¯æœ‰ä¸€ä¸ªé‡è¦çš„é—®é¢˜ï¼š**Service Workerå¿…é¡»è¦åœ¨HTTPSåè®®ä¸‹æ‰èƒ½è¿è¡Œï¼ˆæˆ–è€…localhostï¼‰**ã€‚å½“ç„¶ï¼Œå¯¹äºä¸€äº›åªæœ‰å‰ç«¯èµ„æºï¼ˆä¸æ¶‰åŠåç«¯æœåŠ¡ï¼‰çš„demoï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥å°†è¿™äº›å‰ç«¯ï¼ˆé™æ€èµ„æºï¼‰æ‰˜ç®¡åœ¨ä¸€ä¸ªHTTPSæœåŠ¡ä¸‹ï¼Œä½¿å¾—Service Workerå¯ä»¥ä½¿ç”¨ã€‚æˆ‘é€‰æ‹©äº†googleçš„[FireBase](https://firebase.google.com/)æ¥æ‰˜ç®¡demoï¼ˆå…¶å®github pageä¹Ÿæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼‰ã€‚\r\n\r\n\r\nä½¿ç”¨FireBaseéå¸¸ç®€å•ï¼Œåªéœ€è¦`firebase login` -->`firebase init`-->`firebase deploy`å³å¯ã€‚ä½†æ˜¯åœ¨`firebase login`çš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦æ€»ç»“äº†æˆ‘åœ¨`firebase login`é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹å¼ï¼š\r\n1. æ— æ³•è·å–authorization code\r\n2. ` Authentication Error: Your credentials are no longer valid.`\r\n\r\næœ‰éœ€è¦çš„æœ‹å‹å¯ä»¥ç»§ç»­çœ‹ã€‚\r\n\r\né¦–å…ˆï¼Œå¦‚æœä½ å¯¹firebaseå®Œå…¨ä¸äº†è§£ï¼Œä¸‹é¢ä¼šæœ‰ä¸€æ®µéå¸¸ç®€çŸ­çš„ä»‹ç»ã€‚\r\n\r\n## ä»€ä¹ˆæ˜¯FireBase\r\nå‰æ®µæ—¶é—´å­¦ä¹ PWAï¼Œåœ¨è·Ÿç€å®˜æ–¹æ•™ç¨‹å®Œæˆdemoåï¼Œæƒ³è¦åœ¨æ‰‹æœºä¸Šæµ‹è¯•ä¸€ä¸‹æ•ˆæœã€‚ç„¶è€Œï¼Œé‡åˆ°çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼šPWAéœ€è¦HTTPSåè®®ï¼ˆæˆ–è€…ä½¿ç”¨localhostï¼‰ã€‚\r\n\r\nè¿™å°±éœ€è¦æˆ‘ä»¬æœ‰ä¸€ä¸ªHTTPSçš„æœåŠ¡ï¼Œå¹¶åœ¨å…¶ä¸Šé¢éƒ¨ç½²æˆ‘ä»¬æœ¬åœ°å†™å¥½çš„demoã€‚è€Œå®˜æ–¹demoçš„æœ€åï¼Œæ¨èä½¿ç”¨firebaseæ¥æ‰˜ç®¡ä½ çš„ä»£ç ã€‚\r\n\r\n![FireBaseçš„å„ç§åŠŸèƒ½ä¸æœåŠ¡](https://user-gold-cdn.xitu.io/2018/4/10/162afdd08f75977a?w=700&h=394&f=png&s=66460)\r\n\r\nåœ¨FireBaseçš„ä¼—å¤šä½¿ç”¨åœºæ™¯ä¸­ï¼ŒDevelop -> Hostingï¼ˆæ‰˜ç®¡ï¼‰å°±æ˜¯æˆ‘éœ€è¦ç”¨åˆ°çš„äº†ã€‚ç„¶è€Œï¼Œåœ¨æ‰§è¡Œ`firebase login`ï¼ˆè´¦å·ç™»å½•ï¼‰è¿‡ç¨‹ä¸­ï¼Œå´é‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚\r\n\r\n## é—®é¢˜ä¸€ï¼šåœ¨æµè§ˆå™¨ç™»å½•è´¦å·åï¼Œæ— ååº”ï¼ˆæ— æ³•è·å–authorization codeï¼‰\r\næœ€å¼€å§‹ï¼Œæˆ‘åœ¨CLIä¸­è¾“å…¥`firebase login`ï¼Œé€‰æ‹©`y`åï¼ŒCLIä¼šéœ€è¦ä¸€ä¸ªauthorization codeï¼›è€Œæµè§ˆå™¨ä¼šæ‰“å¼€å¹¶æç¤ºä½ è¿›è¡Œç™»å½•ã€‚\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/10/162afdd08f8a3d0a?w=1171&h=158&f=png&s=26957)\r\n\r\nè¿™é‡Œæˆ‘ç”¨googleè´¦æˆ·è¿›è¡Œæˆæƒç™»å½•ã€‚ç„¶è€Œï¼Œåœ¨æˆæƒä¹‹åï¼Œå´è¿Ÿè¿Ÿæ²¡æœ‰å“åº”ï¼ˆæ— æ³•å¾—åˆ°authorization codeï¼‰ã€‚è¿™æ—¶å€™ï¼Œæˆ‘å‘ç°æµè§ˆå™¨æ˜¾ç¤ºï¼Œä¼¼ä¹æ˜¯åœ¨ç­‰å¾…`localhost`è¿›è¡Œå“åº”ã€‚\r\n\r\nè§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•å°±æ˜¯ï¼šåœ¨ç™»å½•æ—¶ï¼Œä½¿ç”¨`firebase login --no-localhost`è¿›è¡Œç™»å½•ã€‚\r\n\r\né‡æ–°ä½¿ç”¨`firebase login --no-localhost`ç™»å½•ã€‚è¿™é‡Œæˆ‘é€‰æ‹©äº†googleè´¦å·è¿›è¡Œç™»å½•ï¼Œé‡å¤ä¸Šé¢çš„è¿‡ç¨‹ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/10/162afdd08f8a3d0a?w=1171&h=158&f=png&s=26957)\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/10/162afdd08f994938?w=508&h=563&f=png&s=28870)\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/10/162afdd08f6cd205?w=484&h=685&f=png&s=83614)\r\n\r\nè¿™æ¬¡ï¼Œä½ å°±ä¼šåœ¨æµè§ˆå™¨ä¸­è·å¾—ä¸€ä¸²authorization codeå€¼ï¼š\r\n\r\n![authorization code](https://user-gold-cdn.xitu.io/2018/4/10/162afdd08f8759e8?w=1240&h=178&f=png&s=16044)\r\n\r\nå°†å®ƒç²˜è´´åˆ°CLIä¸­å³å¯ã€‚ã€é—®é¢˜ä¸€ã€‘è§£å†³ï¼\r\n\r\n## é—®é¢˜äºŒï¼šError: Authentication Error: Your credentials are no longer valid.\r\nç„¶è€Œï¼Œåœ¨CLIä¸­è¾“å…¥authorization codeä¹‹åï¼Œåœ¨ç­‰å¾…äº†è¾ƒé•¿æ—¶é—´çš„éªŒè¯åï¼ŒCLIä¸­æŠ¥å‡ºäº†å¦‚ä¸‹é”™è¯¯ï¼š\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/4/10/162afdd08f96d4ed?w=1240&h=165&f=png&s=76650)\r\n\r\nè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿé€šè¿‡æŸ¥é˜…ä¸€äº›èµ„æ–™å‘ç°ï¼Œè¿™å¾ˆå¯èƒ½æ˜¯ä½ åœ¨ç”µè„‘ä¸Šä½¿ç”¨â€œç¿»å¢™â€å·¥å…·æ‰€å¯¼è‡´çš„ã€‚firebase-toolä¾èµ–çš„npmåŒ…ï¼ˆfaye-websocketï¼‰ä¸­ï¼Œæœªå¼€å¯ä»£ç†çš„ç›¸å…³è®¾ç½®ï¼Œå› æ­¤æ— æ³•è¿›è¡ŒéªŒè¯ã€‚\r\n\r\nè§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æœ‰ä¸¤ç§ï¼š\r\n### æ–¹æ³•ä¸€ï¼šåœ¨è·¯ç”±å™¨ä¸Šè®¾ç½®ä»£ç†ï¼Œè€Œéæœ¬æœº\r\næœ‰äº›æ–‡ç« æŒ‡å‡ºï¼Œé€šè¿‡åœ¨è·¯ç”±å™¨ä¸Šè®¾ç½®ä»£ç†ï¼Œè€Œéåœ¨æœ¬æœºå¼€å¯ä»£ç†ï¼Œå¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚ä¸è¿‡ç”±äºä¸€äº›åŸå› ï¼Œæš‚æ—¶è¿˜æ²¡æœ‰å°è¯•è¿™ç§æ–¹å¼ï¼Œä¸è¿‡é€šè¿‡ä¸€äº›åé¦ˆæ¥çœ‹ï¼Œåº”è¯¥æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ–¹æ³•ã€‚\r\n\r\n### æ–¹æ³•äºŒï¼š(hack) ä¿®æ”¹ä»£ç ä¸ç›¸å…³ç¯å¢ƒå˜é‡\r\nè¯¥æ–¹æ³•è¾ƒç¬¬ä¸€ç§æ–¹æ³•æ¥çœ‹ï¼Œä¼šç¨å¾®â€œç¡¬â€é‚£ä¹ˆä¸€äº›ã€‚å…·ä½“çš„æ“ä½œæ–¹å¼å¦‚ä¸‹ï¼š\r\n\r\n1. è®¾ç½®ç¯å¢ƒå˜é‡`http_proxy`ï¼Œæˆ‘æœ¬æœºçš„ä»£ç†ä½¿ç”¨çš„æ˜¯1087ç«¯å£ã€‚`export http_proxy=http://localhost:1087` \r\n1. ä¿®æ”¹faye-websocketï¼Œå¼€å¯ä»£ç†é…ç½®ã€‚faye-websocketæ˜¯firebaseä¾èµ–çš„ä¸€ä¸ªWebSocketåº“ï¼Œéœ€è¦ä¸ºå…¶client.jsæ·»åŠ å¦‚ä¸‹é…ç½®ï¼š\r\n```javascript\r\nvar Client = function(_url, protocols, options) {\r\n    options = options || {};\r\n    // æ·»åŠ proxyé…ç½®\r\n    options.proxy = {\r\n        origin:  'http://localhost:1087',\r\n    };\r\n    â€¦\r\n}\r\n```\r\nå¦‚æœä½ æ˜¯å…¨å±€å®‰è£…çš„firebase-toolsï¼Œä½ å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•æ‰¾åˆ°client.js\r\n```\r\nNODE_PATH=`npm prefix -g`\r\n// client.jsçš„ä½ç½®\r\n$NODE_PATH/lib/node_modules/firebase-tools/node_modules/firebase/node_modules/faye-websocket/lib/faye/websocket/client.js\r\n```\r\n3. è®¾ç½®ç¯å¢ƒå˜é‡NODE_TLS_REJECT_UNAUTHORIZEDã€‚`export NODE_TLS_REJECT_UNAUTHORIZED=0`\r\n\r\n4. é‡æ–°ç™»å½•ï¼Œ`firebase login --no-localhost`ï¼Œé‡å¤ä¹‹å‰çš„æ“ä½œã€‚ä½ ä¼šå‘ç°ï¼Œç™»å½•æˆåŠŸï¼\r\n\r\n![image.png](https://user-gold-cdn.xitu.io/2018/4/10/162afdd0b8f77b15?w=1177&h=219&f=png&s=44679)\r\n\r\nã€é—®é¢˜äºŒã€‘è§£å†³ï¼\r\n\r\np.s. é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œgithubä¸Šä¹Ÿæœ‰ä¸€ä¸ªissueï¼š[Unable to deploy behind a proxy](https://github.com/firebase/firebase-tools/issues/155)ã€‚\r\n\r\næ­¤å¤–ï¼Œå¦‚æœä½ ä½¿ç”¨äº†ä»£ç†ï¼Œæ¨èä½¿ç”¨å…¨å±€ä»£ç†çš„æ–¹å¼ï¼Œä½¿ä½ çš„CLIä¹Ÿä½¿ç”¨ä»£ç†ã€‚\r\n\r\n## å†™åœ¨æœ€å\r\næœ€åï¼Œè¿˜æ˜¯å›åˆ°æˆ‘å¼€å‘PWAæ—¶çš„éœ€æ±‚ã€‚æ–‡ç« æœ€å¼€å§‹æåˆ°äº†ï¼Œæˆ‘æ˜¯ä¸ºäº†åœ¨ç§»åŠ¨ç«¯æµ‹è¯•PWA demoçš„æ•ˆæœï¼Œæ‰€ä»¥ä½¿ç”¨FireBaseæ¥æ‰˜ç®¡èµ„æºã€‚å½“ç„¶ï¼Œé™¤äº†FireBaseï¼Œè¿˜æœ‰ä¸‹é¢ä¸¤ä¸ªåŠæ³•ï¼š\r\n\r\n1. ä½¿ç”¨github pageã€‚ç”±äºgithubå…¨ç«™éƒ½æ˜¯è¿è¡Œåœ¨HTTPSä¸‹ï¼Œå› æ­¤åœ¨github pageä¸Šæ‰˜ç®¡çš„é™æ€ç«™ç‚¹å¯ä»¥ä½¿ç”¨Service Workerï¼›\r\n\r\n2. ä½¿ç”¨localhost/127.0.0.1ã€‚äº†è§£PWAçš„è¯ï¼Œä½ ä¼šçŸ¥é“é™¤äº†HTTPSä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨localhostï¼ˆè¿™ä¸€è®¾è®¡æ˜¯ä¸ºäº†æ–¹ä¾¿æœ¬æœºè°ƒè¯•ï¼‰ã€‚\r\n\r\næœ¬æ–‡æ˜¯[ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹](https://juejin.im/user/59ad5377518825244d206d2d/posts)ç³»åˆ—ä¸­çš„ç¬¬å››ç¯‡ã€‚è¿™ç¯‡æ–‡ç« å¹¶æ²¡æœ‰æ¢è®¨PWAä¸­å®é™…çš„æŠ€æœ¯ï¼Œè€Œæ˜¯è®°å½•äº†æˆ‘åœ¨å¼€å‘ã€è°ƒè¯•Pè¿‡ç¨‹ä¸é‡åˆ°çš„é—®é¢˜ã€‚å¯èƒ½æœ‰æœ‹å‹ä¹Ÿä¼šé‡åˆ°ç±»ä¼¼é—®é¢˜ï¼Œå› æ­¤è®°å½•ä¸‹æ¥å’Œå¤§å®¶åˆ†äº«ã€‚\r\n\r\nåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¼šå›åˆ°PWAèƒŒåçš„æŠ€æœ¯ï¼Œæ¥äº†è§£ä¸€ä¸‹ï¼Œ**å¦‚ä½•ä½¿ç”¨Push APIæ¥å®ç°åç«¯æœåŠ¡å‘å®¢æˆ·ç«¯è¿›è¡Œæ¶ˆæ¯æ¨é€**ã€‚\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/4","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/4/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/4/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/4/events","html_url":"https://github.com/alienzhou/blog/issues/4","id":390619644,"node_id":"MDU6SXNzdWUzOTA2MTk2NDQ=","number":4,"title":"ã€PWAå­¦ä¹ ä¸å®è·µã€‘(3) è®©ä½ çš„WebAppç¦»çº¿å¯ç”¨","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845017,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE3","url":"https://api.github.com/repos/alienzhou/blog/labels/PWA","name":"PWA","color":"008672","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T10:44:36Z","updated_at":"2018-12-13T10:44:36Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« å·²æ•´ç†è‡³[gitbook - PWAå­¦ä¹ æ‰‹å†Œ](https://alienzhou.gitbook.io/learning-pwa/)ï¼Œæ–‡å­—å†…å®¹å·²åŒæ­¥è‡³[learning-pwa-ebook](https://github.com/alienzhou/learning-pwa-ebook)ã€‚è½¬è½½è¯·æ³¨æ˜ä½œè€…ä¸å‡ºå¤„ã€‚\r\n\r\næœ¬æ–‡æ˜¯ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—çš„ç¬¬ä¸‰ç¯‡æ–‡ç« ã€‚æ–‡ä¸­çš„ä»£ç éƒ½å¯ä»¥åœ¨[learning-pwaçš„sw-cacheåˆ†æ”¯](https://github.com/alienzhou/learning-pwa/tree/sw-cache)ä¸Šæ‰¾åˆ°ï¼ˆ`git clone`åæ³¨æ„åˆ‡æ¢åˆ°sw-cacheåˆ†æ”¯ï¼‰ã€‚\r\n\r\nPWAä½œä¸ºæ—¶ä¸‹æœ€ç«çƒ­çš„æŠ€æœ¯æ¦‚å¿µä¹‹ä¸€ï¼Œå¯¹æå‡Webåº”ç”¨çš„å®‰å…¨ã€æ€§èƒ½å’Œä½“éªŒæœ‰ç€å¾ˆå¤§çš„æ„ä¹‰ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å»äº†è§£ä¸å­¦ä¹ ã€‚å¯¹PWAæ„Ÿå…´è¶£çš„æœ‹å‹æ¬¢è¿å…³æ³¨ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« ã€‚\r\n\r\n## 1. å¼•è¨€\r\nPWAå…¶ä¸­ä¸€ä¸ªä»¤äººç€è¿·çš„èƒ½åŠ›å°±æ˜¯ç¦»çº¿ï¼ˆofflineï¼‰å¯ç”¨ã€‚\r\n\r\n![å³ä½¿åœ¨ç¦»çº¿çŠ¶æ€ä¸‹ï¼Œä¾ç„¶å¯ä»¥è®¿é—®çš„PWA](https://user-gold-cdn.xitu.io/2018/4/8/162a560d0b7dfb84?w=1161&h=728&f=gif&s=1190874)\r\n\r\nç¦»çº¿åªæ˜¯å®ƒçš„ä¸€ç§åŠŸèƒ½è¡¨ç°è€Œå·²ï¼Œå…·ä½“è¯´æ¥ï¼Œå®ƒå¯ä»¥ï¼š\r\n- è®©æˆ‘ä»¬çš„Web Appåœ¨æ— ç½‘ï¼ˆofflineï¼‰æƒ…å†µä¸‹å¯ä»¥è®¿é—®ï¼Œç”šè‡³ä½¿ç”¨éƒ¨åˆ†åŠŸèƒ½ï¼Œè€Œä¸æ˜¯å±•ç¤ºâ€œæ— ç½‘ç»œè¿æ¥â€çš„é”™è¯¯é¡µï¼›\r\n- è®©æˆ‘ä»¬åœ¨å¼±ç½‘çš„æƒ…å†µä¸‹ï¼Œèƒ½ä½¿ç”¨ç¼“å­˜å¿«é€Ÿè®¿é—®æˆ‘ä»¬çš„åº”ç”¨ï¼Œæå‡ä½“éªŒï¼›\r\n- åœ¨æ­£å¸¸çš„ç½‘ç»œæƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å„ç§è‡ªå‘æ§åˆ¶çš„ç¼“å­˜æ–¹å¼æ¥èŠ‚çœéƒ¨åˆ†è¯·æ±‚å¸¦å®½ï¼›\r\n- â€¦â€¦\r\n\r\nè€Œè¿™ä¸€åˆ‡ï¼Œå…¶å®éƒ½è¦å½’åŠŸäºPWAèƒŒåçš„è‹±é›„ â€”â€” **Service Worker**ã€‚\r\n\r\né‚£ä¹ˆï¼ŒService Workeræ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä½ å¯ä»¥æŠŠService Workerç®€å•ç†è§£ä¸ºä¸€ä¸ªç‹¬ç«‹äºå‰ç«¯é¡µé¢ï¼Œåœ¨åå°è¿è¡Œçš„è¿›ç¨‹ã€‚å› æ­¤ï¼Œå®ƒä¸ä¼šé˜»å¡æµè§ˆå™¨è„šæœ¬çš„è¿è¡Œï¼ŒåŒæ—¶ä¹Ÿæ— æ³•ç›´æ¥è®¿é—®æµè§ˆå™¨ç›¸å…³çš„APIï¼ˆä¾‹å¦‚ï¼šDOMã€localStorageç­‰ï¼‰ã€‚æ­¤å¤–ï¼Œå³ä½¿åœ¨ç¦»å¼€ä½ çš„Web Appï¼Œç”šè‡³æ˜¯å…³é—­æµè§ˆå™¨åï¼Œå®ƒä»ç„¶å¯ä»¥è¿è¡Œã€‚å®ƒå°±åƒæ˜¯ä¸€ä¸ªåœ¨Webåº”ç”¨èƒŒåé»˜é»˜å·¥ä½œçš„å‹¤åŠ³å°èœœèœ‚ï¼Œå¤„ç†ç€ç¼“å­˜ã€æ¨é€ã€é€šçŸ¥ä¸åŒæ­¥ç­‰å·¥ä½œã€‚æ‰€ä»¥ï¼Œè¦å­¦ä¹ PWAï¼Œç»•ä¸å¼€çš„å°±æ˜¯Service Workerã€‚\r\n\r\n![PWAèƒŒåçš„è‹±é›„ â€”â€” Service Worker](https://user-gold-cdn.xitu.io/2018/4/8/162a560d0b6f194f?w=670&h=447&f=png&s=631884)\r\n\r\nåœ¨æ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä¼šä»å¦‚ä½•ä½¿ç”¨Service Workeræ¥å®ç°èµ„æºçš„ç¼“å­˜ã€æ¶ˆæ¯çš„æ¨é€ã€æ¶ˆæ¯çš„é€šçŸ¥ä»¥åŠåå°åŒæ­¥è¿™å‡ ä¸ªè§’åº¦ï¼Œæ¥ä»‹ç»ç›¸å…³åŸç†ä¸æŠ€æœ¯å®ç°ã€‚è¿™äº›éƒ¨åˆ†ä¼šæ˜¯PWAæŠ€æœ¯çš„é‡ç‚¹ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œç”±äºService Workeræ‰€å…·æœ‰çš„å¼ºå¤§èƒ½åŠ›ï¼Œå› æ­¤è§„èŒƒè§„å®šï¼Œ**Service Workeråªèƒ½è¿è¡Œåœ¨HTTPSåŸŸä¸‹**ã€‚ç„¶è€Œæˆ‘ä»¬å¼€å‘æ—¶å€™æ²¡æœ‰HTTPSæ€ä¹ˆåŠï¼Ÿåˆ«ç€æ€¥ï¼Œè¿˜æœ‰ä¸€ä¸ªè´´å¿ƒçš„åœ°æ–¹â€”â€”ä¸ºæ–¹ä¾¿æœ¬åœ°å¼€å‘ï¼Œ**Service Workerä¹Ÿå¯ä»¥è¿è¡Œåœ¨localhostï¼ˆ127.0.0.1ï¼‰åŸŸä¸‹**ã€‚\r\n\r\nå¥½äº†ï¼Œç®€å•äº†è§£äº†Service Workerä¸å®ƒèƒ½å®ç°çš„åŠŸèƒ½åï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦å›åˆ°è¿™ä¸€ç¯‡çš„ä¸»é¢˜ï¼Œä¹Ÿå°±æ˜¯Service Workerçš„ç¬¬ä¸€éƒ¨åˆ†â€”â€”å¦‚ä½•åˆ©ç”¨Service Workeræ¥å®ç°å‰ç«¯èµ„æºçš„ç¼“å­˜ï¼Œä»è€Œæå‡äº§å“çš„è®¿é—®é€Ÿåº¦ï¼Œåšåˆ°ç¦»çº¿å¯ç”¨ã€‚\r\n\r\n## 2. Service Workeræ˜¯å¦‚ä½•å®ç°ç¦»çº¿å¯ç”¨çš„ï¼Ÿ\r\nè¿™ä¸€å°èŠ‚ä¼šå‘Šè¯‰å¤§å®¶ï¼ŒService Workeræ˜¯å¦‚ä½•è®©æˆ‘ä»¬åœ¨ç¦»çº¿çš„æƒ…å†µä¸‹ä¹Ÿèƒ½è®¿é—®Web Appçš„ã€‚å½“ç„¶ï¼Œç¦»çº¿è®¿é—®åªæ˜¯å…¶ä¸­ä¸€ç§è¡¨ç°ã€‚\r\n\r\né¦–å…ˆï¼Œæˆ‘ä»¬æƒ³ä¸€ä¸‹ï¼Œå½“è®¿é—®ä¸€ä¸ªwebç½‘ç«™æ—¶ï¼Œæˆ‘ä»¬å®é™…ä¸Šåšäº†ä»€ä¹ˆå‘¢ï¼Ÿæ€»ä½“ä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬é€šè¿‡ä¸ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œè·å–èµ„æºï¼Œç„¶åè·å–åˆ°çš„éƒ¨åˆ†èµ„æºè¿˜ä¼šå»è¯·æ±‚æ–°çš„èµ„æºï¼ˆä¾‹å¦‚htmlä¸­ä½¿ç”¨çš„cssã€jsç­‰ï¼‰ã€‚æ‰€ä»¥ï¼Œç²—ç²’åº¦æ¥è¯´ï¼Œæˆ‘ä»¬è®¿é—®ä¸€ä¸ªç½‘ç«™ï¼Œå°±æ˜¯åœ¨è·å–/è®¿é—®è¿™äº›èµ„æºã€‚\r\n\r\nå¯æƒ³è€ŒçŸ¥ï¼Œå½“å¤„äºç¦»çº¿æˆ–å¼±ç½‘ç¯å¢ƒæ—¶ï¼Œæˆ‘ä»¬æ— æ³•æœ‰æ•ˆè®¿é—®è¿™äº›èµ„æºï¼Œè¿™å°±æ˜¯åˆ¶çº¦æˆ‘ä»¬çš„å…³é”®å› ç´ ã€‚å› æ­¤ï¼Œä¸€ä¸ªæœ€ç›´è§‚çš„æ€è·¯å°±æ˜¯ï¼šå¦‚æœæˆ‘ä»¬æŠŠè¿™äº›èµ„æºç¼“å­˜èµ·æ¥ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå°†ç½‘ç»œè¯·æ±‚å˜ä¸ºæœ¬åœ°è®¿é—®ï¼Œè¿™æ ·æ˜¯å¦èƒ½è§£å†³è¿™ä¸€é—®é¢˜ï¼Ÿæ˜¯çš„ã€‚ä½†è¿™å°±éœ€è¦æˆ‘ä»¬æœ‰ä¸€ä¸ªæœ¬åœ°çš„cacheï¼Œå¯ä»¥çµæ´»åœ°å°†å„ç±»èµ„æºè¿›è¡Œæœ¬åœ°å­˜å–ã€‚\r\n\r\n![å¦‚ä½•è·å–æ‰€éœ€çš„èµ„æºï¼Ÿ](https://user-gold-cdn.xitu.io/2018/4/8/162a560d0ba6b18b?w=567&h=219&f=png&s=7993)\r\n\r\næœ‰äº†æœ¬åœ°çš„cacheè¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦èƒ½å¤Ÿæœ‰æ•ˆåœ°ä½¿ç”¨ç¼“å­˜ã€æ›´æ–°ç¼“å­˜ä¸æ¸…é™¤ç¼“å­˜ï¼Œè¿›ä¸€æ­¥åº”ç”¨å„ç§ä¸ªæ€§åŒ–çš„ç¼“å­˜ç­–ç•¥ã€‚è€Œè¿™å°±éœ€è¦æˆ‘ä»¬æœ‰ä¸ªèƒ½å¤Ÿæ§åˆ¶ç¼“å­˜çš„â€œworkerâ€â€”â€”è¿™ä¹Ÿå°±æ˜¯Service Workerçš„éƒ¨åˆ†å·¥ä½œä¹‹ä¸€ã€‚é¡ºä¾¿å¤šè¯´ä¸€å¥ï¼Œå¯èƒ½æœ‰äººè¿˜è®°å¾— [ApplicationCache](https://developer.mozilla.org/en-US/docs/Web/API/Window/applicationCache) è¿™ä¸ªAPIã€‚å½“åˆå®ƒçš„è®¾è®¡åŒæ ·ä¹Ÿæ˜¯ä¸ºäº†å®ç°Webèµ„æºçš„ç¼“å­˜ï¼Œç„¶è€Œå°±æ˜¯å› ä¸ºä¸å¤Ÿçµæ´»ç­‰å„ç§ç¼ºé™·ï¼Œå¦‚ä»Šå·²è¢«Service Workerä¸cache APIæ‰€å–ä»£äº†ã€‚\r\n\r\nService Workeræœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§ï¼šä½ å¯ä»¥åœ¨Service Workerä¸­ç›‘å¬æ‰€æœ‰å®¢æˆ·ç«¯ï¼ˆWebï¼‰å‘å‡ºçš„è¯·æ±‚ï¼Œç„¶åé€šè¿‡Service Workeræ¥ä»£ç†ï¼Œå‘åç«¯æœåŠ¡å‘èµ·è¯·æ±‚ã€‚é€šè¿‡ç›‘å¬ç”¨æˆ·è¯·æ±‚ä¿¡æ¯ï¼ŒService Workerå¯ä»¥å†³å®šæ˜¯å¦ä½¿ç”¨ç¼“å­˜æ¥ä½œä¸ºWebè¯·æ±‚çš„è¿”å›ã€‚\r\n\r\nä¸‹å›¾å±•ç¤ºæ™®é€šWeb Appä¸æ·»åŠ äº†Service Workerçš„Web Appåœ¨ç½‘ç»œè¯·æ±‚ä¸Šçš„å·®å¼‚ï¼š\r\n\r\n![æ™®é€šWebè¯·æ±‚(ä¸Š)ä¸ä½¿ç”¨Service Workerä»£ç†(ä¸‹)çš„åŒºåˆ«](https://user-gold-cdn.xitu.io/2018/4/8/162a560d0bdb6ed1?w=567&h=271&f=png&s=14952)\r\n\r\nè¿™é‡Œéœ€è¦å¼ºè°ƒä¸€ä¸‹ï¼Œè™½ç„¶å›¾ä¸­å¥½åƒå°†æµè§ˆå™¨ã€SW(Service Worker)ä¸åç«¯æœåŠ¡ä¸‰è€…å¹¶åˆ—æ”¾ç½®äº†ï¼Œä½†å®é™…ä¸Šæµè§ˆå™¨ï¼ˆä½ çš„Webåº”ç”¨ï¼‰å’ŒSWéƒ½æ˜¯è¿è¡Œåœ¨ä½ çš„æœ¬æœºä¸Šçš„ï¼Œæ‰€ä»¥è¿™ä¸ªåœºæ™¯ä¸‹çš„SWç±»ä¼¼ä¸€ä¸ªâ€œå®¢æˆ·ç«¯ä»£ç†â€ã€‚\r\n\r\näº†è§£äº†åŸºæœ¬æ¦‚å¿µä¹‹åï¼Œå°±å¯ä»¥å…·ä½“æ¥çœ‹ä¸‹ï¼Œæˆ‘ä»¬å¦‚ä½•åº”ç”¨è¿™ä¸ªæŠ€æœ¯æ¥å®ç°ä¸€ä¸ªç¦»çº¿å¯ç”¨çš„Webåº”ç”¨ã€‚\r\n\r\n## 3. å¦‚ä½•ä½¿ç”¨Service Workerå®ç°ç¦»çº¿å¯ç”¨çš„â€œç§’å¼€â€åº”ç”¨\r\nè¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰çš„é‚£ä¸ªå›¾ä¹¦æœç´¢çš„demo Web Appä¹ˆï¼Ÿä¸äº†è§£çš„æœ‹å‹å¯ä»¥çœ‹ä¸‹æœ¬ç³»åˆ—çš„[ç¬¬ä¸€ç¯‡æ–‡ç« ](https://juejin.im/post/5ac8a67c5188255c5668b0b8)ï¼Œå½“ç„¶ä½ å¯ä»¥å¿½ç•¥ç»†èŠ‚ï¼Œç»§ç»­å¾€ä¸‹äº†è§£æŠ€æœ¯åŸç†ã€‚\r\n\r\næ²¡é”™ï¼Œè¿™æ¬¡æˆ‘ä»ç„¶ä¼šåŸºäºå®ƒè¿›è¡Œæ”¹é€ ã€‚åœ¨[ä¸Šä¸€ç¯‡æ·»åŠ äº†manifest](https://juejin.im/post/5ac8a89ef265da238440d60a)åï¼Œå®ƒå·²ç»æ‹¥æœ‰äº†è‡ªå·±çš„æ¡Œé¢å›¾æ ‡ï¼Œå¹¶æœ‰ä¸€ä¸ªå¾ˆåƒNative Appçš„å¤–å£³ï¼›è€Œä»Šå¤©ï¼Œæˆ‘ä¼šè®©å®ƒå˜å¾—æ›´é…·ã€‚\r\n\r\n> å¦‚æœæƒ³è¦è·Ÿç€æ–‡ç« å†…å®¹ä¸€èµ·å®è·µï¼Œå¯ä»¥åœ¨[è¿™é‡Œä¸‹è½½åˆ°æ‰€éœ€çš„å…¨éƒ¨ä»£ç ](https://github.com/alienzhou/learning-pwa/tree/master)ã€‚\r\nè®°å¾—åˆ‡æ¢åˆ°`manifest`åˆ†æ”¯ï¼Œå› ä¸ºæœ¬ç¯‡å†…å®¹ï¼Œæ˜¯åŸºäºä¸Šä¸€ç¯‡çš„æœ€ç»ˆä»£ç è¿›è¡Œç›¸åº”çš„å¼€å‘ä¸å‡çº§ã€‚æ¯•ç«Ÿæˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡æ˜¯å°†è¿™ä¸ªæ™®é€šçš„â€œå›¾ä¹¦æœç´¢â€demoå‡çº§ä¸ºPWAã€‚\r\n\r\n### 3.1. æ³¨å†ŒService Worker\r\næ³¨æ„ï¼Œæˆ‘ä»¬çš„åº”ç”¨å§‹ç»ˆåº”è¯¥æ˜¯æ¸è¿›å¯ç”¨çš„ï¼Œåœ¨ä¸æ”¯æŒService Workerçš„ç¯å¢ƒä¸‹ï¼Œä¹Ÿéœ€è¦ä¿è¯å…¶å¯ç”¨æ€§ã€‚è¦å®ç°è¿™ç‚¹ï¼Œå¯ä»¥é€šè¿‡ç‰¹æ€§æ£€æµ‹ï¼Œåœ¨index.jsä¸­æ¥æ³¨å†Œæˆ‘ä»¬çš„Service Workerï¼ˆsw.jsï¼‰ï¼š\r\n\r\n```javascript\r\n// index.js\r\n// æ³¨å†Œservice workerï¼Œservice workerè„šæœ¬æ–‡ä»¶ä¸ºsw.js\r\nif ('serviceWorker' in navigator) {\r\n    navigator.serviceWorker.register('./sw.js').then(function () {\r\n        console.log('Service Worker æ³¨å†ŒæˆåŠŸ');\r\n    });\r\n}\r\n```\r\nè¿™é‡Œæˆ‘ä»¬å°†sw.jsæ–‡ä»¶æ³¨å†Œä¸ºä¸€ä¸ªService Workerï¼Œæ³¨æ„æ–‡ä»¶çš„è·¯å¾„ä¸è¦å†™é”™äº†ã€‚\r\n\r\nå€¼å¾—ä¸€æçš„æ˜¯ï¼ŒService Workerçš„å„ç±»æ“ä½œéƒ½è¢«è®¾è®¡ä¸ºå¼‚æ­¥ï¼Œç”¨ä»¥é¿å…ä¸€äº›é•¿æ—¶é—´çš„é˜»å¡æ“ä½œã€‚è¿™äº›APIéƒ½æ˜¯ä»¥Promiseçš„å½¢å¼æ¥è°ƒç”¨çš„ã€‚æ‰€ä»¥ä½ ä¼šåœ¨æ¥ä¸‹æ¥çš„å„æ®µä»£ç ä¸­ä¸æ–­çœ‹åˆ°Promiseçš„ä½¿ç”¨ã€‚å¦‚æœä½ å®Œå…¨ä¸äº†è§£Promiseï¼Œå¯ä»¥å…ˆåœ¨è¿™é‡Œäº†è§£åŸºæœ¬çš„Promiseæ¦‚å¿µï¼š[Promiseï¼ˆMDNï¼‰](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise)å’Œ[JavaScript Promiseï¼šç®€ä»‹](https://developers.google.com/web/fundamentals/primers/promises)ã€‚\r\n\r\n### 3.2. Service Workerçš„ç”Ÿå‘½å‘¨æœŸ\r\nå½“æˆ‘ä»¬æ³¨å†Œäº†Service Workeråï¼Œå®ƒä¼šç»å†ç”Ÿå‘½å‘¨æœŸçš„å„ä¸ªé˜¶æ®µï¼ŒåŒæ—¶ä¼šè§¦å‘ç›¸åº”çš„äº‹ä»¶ã€‚æ•´ä¸ªç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬äº†ï¼šinstalling --> installed --> activating --> activated --> redundantã€‚å½“Service Workerå®‰è£…ï¼ˆinstalledï¼‰å®Œæ¯•åï¼Œä¼šè§¦å‘installäº‹ä»¶ï¼›è€Œæ¿€æ´»ï¼ˆactivatedï¼‰åï¼Œåˆ™ä¼šè§¦å‘activateäº‹ä»¶ã€‚\r\n\r\n![Service Workerç”Ÿå‘½å‘¨æœŸ](https://user-gold-cdn.xitu.io/2018/4/8/162a560d0bdaf33b?w=579&h=867&f=png&s=39680)\r\n\r\nä¸‹é¢çš„ä¾‹å­ç›‘å¬äº†installäº‹ä»¶ï¼š\r\n```javascript\r\n// ç›‘å¬installäº‹ä»¶\r\nself.addEventListener('install', function (e) {\r\n    console.log('Service Worker çŠ¶æ€ï¼š install');\r\n});\r\n```\r\n`self`æ˜¯Service Workerä¸­ä¸€ä¸ªç‰¹æ®Šçš„å…¨å±€å˜é‡ï¼Œç±»ä¼¼äºæˆ‘ä»¬æœ€å¸¸è§çš„`window`å¯¹è±¡ã€‚`self`å¼•ç”¨äº†å½“å‰è¿™ä¸ªService Workerã€‚\r\n\r\n### 3.3. ç¼“å­˜é™æ€èµ„æº\r\né€šè¿‡ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¼šäº†å¦‚ä½•æ·»åŠ äº‹ä»¶ç›‘å¬ï¼Œæ¥åœ¨åˆé€‚çš„æ—¶æœºè§¦å‘Service Workerçš„ç›¸åº”æ“ä½œã€‚ç°åœ¨ï¼Œè¦ä½¿æˆ‘ä»¬çš„Web Appç¦»çº¿å¯ç”¨ï¼Œå°±éœ€è¦å°†æ‰€éœ€èµ„æºç¼“å­˜ä¸‹æ¥ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªèµ„æºåˆ—è¡¨ï¼Œå½“Service Workerè¢«æ¿€æ´»æ—¶ï¼Œä¼šå°†è¯¥åˆ—è¡¨å†…çš„èµ„æºç¼“å­˜è¿›cacheã€‚\r\n\r\n```javascript\r\n// sw.js\r\nvar cacheName = 'bs-0-2-0';\r\nvar cacheFiles = [\r\n    '/',\r\n    './index.html',\r\n    './index.js',\r\n    './style.css',\r\n    './img/book.png',\r\n    './img/loading.svg'\r\n];\r\n\r\n// ç›‘å¬installäº‹ä»¶ï¼Œå®‰è£…å®Œæˆåï¼Œè¿›è¡Œæ–‡ä»¶ç¼“å­˜\r\nself.addEventListener('install', function (e) {\r\n    console.log('Service Worker çŠ¶æ€ï¼š install');\r\n    var cacheOpenPromise = caches.open(cacheName).then(function (cache) {\r\n        return cache.addAll(cacheFiles);\r\n    });\r\n    e.waitUntil(cacheOpenPromise);\r\n});\r\n```\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œé¦–å…ˆåœ¨`cacheFiles`ä¸­æˆ‘ä»¬åˆ—å‡ºäº†æ‰€æœ‰çš„é™æ€èµ„æºä¾èµ–ã€‚æ³¨æ„å…¶ä¸­çš„`'/'`ï¼Œç”±äºæ ¹è·¯å¾„ä¹Ÿå¯ä»¥è®¿é—®æˆ‘ä»¬çš„åº”ç”¨ï¼Œå› æ­¤ä¸è¦å¿˜äº†å°†å…¶ä¹Ÿç¼“å­˜ä¸‹æ¥ã€‚å½“Service Worker installæ—¶ï¼Œæˆ‘ä»¬å°±ä¼šé€šè¿‡`caches.open()`ä¸`cache.addAll()`æ–¹æ³•å°†èµ„æºç¼“å­˜èµ·æ¥ã€‚è¿™é‡Œæˆ‘ä»¬ç»™ç¼“å­˜èµ·äº†ä¸€ä¸ª`cacheName`ï¼Œè¿™ä¸ªå€¼ä¼šæˆä¸ºè¿™äº›ç¼“å­˜çš„keyã€‚\r\n\r\nä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œ`caches`æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥æ“ä½œCacheç›¸å…³æ¥å£ã€‚\r\n\r\n> Cache æ¥å£æä¾›ç¼“å­˜çš„ Request / Response å¯¹è±¡å¯¹çš„å­˜å‚¨æœºåˆ¶ã€‚Cache æ¥å£åƒ workers ä¸€æ ·, æ˜¯æš´éœ²åœ¨ window ä½œç”¨åŸŸä¸‹çš„ã€‚å°½ç®¡å®ƒè¢«å®šä¹‰åœ¨ service worker çš„æ ‡å‡†ä¸­,  ä½†æ˜¯å®ƒä¸å¿…ä¸€å®šè¦é…åˆ service worker ä½¿ç”¨ã€‚â€”â€”MDN\r\n\r\n### 3.4 ä½¿ç”¨ç¼“å­˜çš„é™æ€èµ„æº\r\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä»…ä»…æ˜¯æ³¨å†Œäº†ä¸€ä¸ªService Workerï¼Œå¹¶åœ¨å…¶installæ—¶ç¼“å­˜äº†ä¸€äº›é™æ€èµ„æºã€‚ç„¶è€Œï¼Œå¦‚æœè¿™æ—¶è¿è¡Œè¿™ä¸ªdemoä½ ä¼šå‘ç°â€”â€”â€œå›¾ä¹¦æœç´¢â€è¿™ä¸ªWeb Appä¾ç„¶æ— æ³•ç¦»çº¿ä½¿ç”¨ã€‚\r\n\r\nä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬ä»…ä»…ç¼“å­˜äº†è¿™äº›èµ„æºï¼Œç„¶è€Œæµè§ˆå™¨å¹¶ä¸çŸ¥é“éœ€è¦å¦‚ä½•ä½¿ç”¨å®ƒä»¬ï¼›æ¢è¨€ä¹‹ï¼Œæµè§ˆå™¨ä»ç„¶ä¼šé€šè¿‡å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ¥ç­‰å¾…å¹¶ä½¿ç”¨è¿™äº›èµ„æºã€‚é‚£æ€ä¹ˆåŠï¼Ÿ\r\n\r\nèªæ˜çš„ä½ åº”è¯¥æƒ³èµ·æ¥äº†ï¼Œæˆ‘ä»¬åœ¨æ–‡ç« å‰åŠéƒ¨åˆ†ä»‹ç»Service Workeræ—¶æåˆ°äº†â€œå®¢æˆ·ç«¯ä»£ç†â€â€”â€”ç”¨Service Workeræ¥å¸®æˆ‘ä»¬å†³å®šå¦‚ä½•ä½¿ç”¨ç¼“å­˜ã€‚\r\n\r\nä¸‹å›¾æ˜¯ä¸€ä¸ªç®€å•çš„ç­–ç•¥ï¼š\r\n\r\n![æœ‰cacheæ—¶çš„é™æ€èµ„æºè¯·æ±‚æµç¨‹](https://user-gold-cdn.xitu.io/2018/4/8/162a560d2d6b1798?w=567&h=284&f=png&s=19408)\r\n\r\n![æ— cacheæ—¶çš„é™æ€èµ„æºè¯·æ±‚æµç¨‹](https://user-gold-cdn.xitu.io/2018/4/8/162a560d30b47136?w=567&h=284&f=png&s=13705)\r\n\r\n1. æµè§ˆå™¨å‘èµ·è¯·æ±‚ï¼Œè¯·æ±‚å„ç±»é™æ€èµ„æºï¼ˆhtml/js/css/imgï¼‰ï¼›\r\n1. Service Workeræ‹¦æˆªæµè§ˆå™¨è¯·æ±‚ï¼Œå¹¶æŸ¥è¯¢å½“å‰cacheï¼›\r\n1. è‹¥å­˜åœ¨cacheåˆ™ç›´æ¥è¿”å›ï¼Œç»“æŸï¼›\r\n1. è‹¥ä¸å­˜åœ¨cacheï¼Œåˆ™é€šè¿‡`fetch`æ–¹æ³•å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚ï¼Œå¹¶è¿”å›è¯·æ±‚ç»“æœç»™æµè§ˆå™¨\r\n\r\n```javascript\r\n// sw.js\r\nself.addEventListener('fetch', function (e) {\r\n    // å¦‚æœæœ‰cacheåˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™é€šè¿‡fetchè¯·æ±‚\r\n    e.respondWith(\r\n        caches.match(e.request).then(function (cache) {\r\n            return cache || fetch(e.request);\r\n        }).catch(function (err) {\r\n            console.log(err);\r\n            return fetch(e.request);\r\n        })\r\n    );\r\n});\r\n```\r\n`fetch`äº‹ä»¶ä¼šç›‘å¬æ‰€æœ‰æµè§ˆå™¨çš„è¯·æ±‚ã€‚`e.respondWith()`æ–¹æ³•æ¥å—Promiseä½œä¸ºå‚æ•°ï¼Œé€šè¿‡å®ƒè®©Service Workerå‘æµè§ˆå™¨è¿”å›æ•°æ®ã€‚`caches.match(e.request)`åˆ™å¯ä»¥æŸ¥çœ‹å½“å‰çš„è¯·æ±‚æ˜¯å¦æœ‰ä¸€ä»½æœ¬åœ°ç¼“å­˜ï¼šå¦‚æœæœ‰ç¼“å­˜ï¼Œåˆ™ç›´æ¥å‘æµè§ˆå™¨è¿”å›`cache`ï¼›å¦åˆ™Service Workerä¼šå‘åç«¯æœåŠ¡å‘èµ·ä¸€ä¸ª`fetch(e.request)`çš„è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚ç»“æœè¿”å›ç»™æµè§ˆå™¨ã€‚\r\n\r\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿è¡Œæˆ‘ä»¬çš„demoï¼šå½“ç¬¬ä¸€è”ç½‘æ‰“å¼€â€œå›¾ä¹¦æœç´¢â€Web Appåï¼Œæ‰€ä¾èµ–çš„é™æ€èµ„æºå°±ä¼šè¢«ç¼“å­˜åœ¨æœ¬åœ°ï¼›ä»¥åå†è®¿é—®æ—¶ï¼Œå°±ä¼šä½¿ç”¨è¿™äº›ç¼“å­˜è€Œä¸å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚å› æ­¤ï¼Œå³ä½¿åœ¨æ— ç½‘æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼¼ä¹ä¾æ—§èƒ½â€œè®¿é—®â€è¯¥åº”ç”¨ã€‚\r\n\r\n### 3.5. æ›´æ–°é™æ€ç¼“å­˜èµ„æº\r\nç„¶è€Œï¼Œå¦‚æœä½ ç»†å¿ƒçš„è¯ï¼Œä¼šå‘ç°ä¸€ä¸ªå°é—®é¢˜ï¼šå½“æˆ‘ä»¬å°†èµ„æºç¼“å­˜åï¼Œé™¤éæ³¨é”€ï¼ˆunregisterï¼‰sw.jsã€æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜ï¼Œå¦åˆ™æ–°çš„é™æ€èµ„æºå°†æ— æ³•ç¼“å­˜ã€‚\r\n\r\nè§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€ä¸ªç®€å•æ–¹æ³•å°±æ˜¯ä¿®æ”¹`cacheName`ã€‚ç”±äºæµè§ˆå™¨åˆ¤æ–­sw.jsæ˜¯å¦æ›´æ–°æ˜¯é€šè¿‡å­—èŠ‚æ–¹å¼ï¼Œå› æ­¤ä¿®æ”¹`cacheName`ä¼šé‡æ–°è§¦å‘installå¹¶ç¼“å­˜èµ„æºã€‚æ­¤å¤–ï¼Œåœ¨activateäº‹ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥`cacheName`æ˜¯å¦å˜åŒ–ï¼Œå¦‚æœå˜åŒ–åˆ™è¡¨ç¤ºæœ‰äº†æ–°çš„ç¼“å­˜èµ„æºï¼ŒåŸæœ‰ç¼“å­˜éœ€è¦åˆ é™¤ã€‚\r\n\r\n```javascript\r\n// sw.js\r\n// ç›‘å¬activateäº‹ä»¶ï¼Œæ¿€æ´»åé€šè¿‡cacheçš„keyæ¥åˆ¤æ–­æ˜¯å¦æ›´æ–°cacheä¸­çš„é™æ€èµ„æº\r\nself.addEventListener('activate', function (e) {\r\n    console.log('Service Worker çŠ¶æ€ï¼š activate');\r\n    var cachePromise = caches.keys().then(function (keys) {\r\n        return Promise.all(keys.map(function (key) {\r\n            if (key !== cacheName) {\r\n                return caches.delete(key);\r\n            }\r\n        }));\r\n    })\r\n    e.waitUntil(cachePromise);\r\n    return self.clients.claim();\r\n});\r\n```\r\n\r\n### 3.6.  ç¼“å­˜APIæ•°æ®çš„â€œç¦»çº¿æœç´¢â€\r\nåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„åº”ç”¨åŸºæœ¬å·²ç»å®Œæˆäº†ç¦»çº¿è®¿é—®çš„æ”¹é€ ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ æ³¨æ„åˆ°æ–‡ç« å¼€å¤´çš„å›¾ç‰‡å°±ä¼šå‘ç°ï¼Œç¦»çº¿æ—¶æˆ‘ä»¬ä¸ä»…å¯ä»¥è®¿é—®ï¼Œè¿˜å¯ä»¥ä½¿ç”¨æœç´¢åŠŸèƒ½ã€‚\r\n\r\n![ç¦»çº¿/æ— ç½‘ç¯å¢ƒä¸‹æ™®é€šWeb App(å·¦)ä¸PWA(å³)çš„å·®å¼‚](https://user-gold-cdn.xitu.io/2018/4/8/162a560d5f79572c?w=1238&h=698&f=png&s=130127)\r\n\r\nè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿå…¶å®è¿™èƒŒåçš„ç§˜å¯†å°±åœ¨äºï¼Œè¿™ä¸ªWeb Appä¹Ÿä¼šæŠŠXHRè¯·æ±‚çš„æ•°æ®ç¼“å­˜ä¸€ä»½ã€‚è€Œå†æ¬¡è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬ä¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼ˆå¦‚æœæœ‰ç¼“å­˜çš„è¯ï¼‰ï¼›ç„¶åå‘æœåŠ¡ç«¯è¯·æ±‚æ•°æ®ï¼ŒæœåŠ¡ç«¯è¿”å›æ•°æ®åï¼ŒåŸºäºè¯¥æ•°æ®æ›¿æ¢å±•ç¤ºã€‚å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š\r\n\r\n![å›¾ä¹¦æŸ¥è¯¢æ¥å£çš„ç¼“å­˜ä¸ä½¿ç”¨ç­–ç•¥](https://user-gold-cdn.xitu.io/2018/4/8/162a560d35c15a67?w=567&h=266&f=png&s=16946)\r\n\r\né¦–å…ˆæˆ‘ä»¬æ”¹é€ ä¸€ä¸‹å‰ä¸€èŠ‚çš„ä»£ç åœ¨sw.jsçš„`fetch`äº‹ä»¶é‡Œè¿›è¡ŒAPIæ•°æ®çš„ç¼“å­˜\r\n```javascript\r\n// sw.js\r\nvar apiCacheName = 'api-0-1-1';\r\nself.addEventListener('fetch', function (e) {\r\n    // éœ€è¦ç¼“å­˜çš„xhrè¯·æ±‚\r\n    var cacheRequestUrls = [\r\n        '/book?'\r\n    ];\r\n    console.log('ç°åœ¨æ­£åœ¨è¯·æ±‚ï¼š' + e.request.url);\r\n\r\n    // åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦éœ€è¦ç¼“å­˜\r\n    var needCache = cacheRequestUrls.some(function (url) {\r\n        return e.request.url.indexOf(url) > -1;\r\n    });\r\n\r\n    /**** è¿™é‡Œæ˜¯å¯¹XHRæ•°æ®ç¼“å­˜çš„ç›¸å…³æ“ä½œ ****/\r\n    if (needCache) {\r\n        // éœ€è¦ç¼“å­˜\r\n        // ä½¿ç”¨fetchè¯·æ±‚æ•°æ®ï¼Œå¹¶å°†è¯·æ±‚ç»“æœcloneä¸€ä»½ç¼“å­˜åˆ°cache\r\n        // æ­¤éƒ¨åˆ†ç¼“å­˜ååœ¨browserä¸­ä½¿ç”¨å…¨å±€å˜é‡cachesè·å–\r\n        caches.open(apiCacheName).then(function (cache) {\r\n            return fetch(e.request).then(function (response) {\r\n                cache.put(e.request.url, response.clone());\r\n                return response;\r\n            });\r\n        });\r\n    }\r\n    /* ******************************* */\r\n\r\n    else {\r\n        // éapiè¯·æ±‚ï¼Œç›´æ¥æŸ¥è¯¢cache\r\n        // å¦‚æœæœ‰cacheåˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™é€šè¿‡fetchè¯·æ±‚\r\n        e.respondWith(\r\n            caches.match(e.request).then(function (cache) {\r\n                return cache || fetch(e.request);\r\n            }).catch(function (err) {\r\n                console.log(err);\r\n                return fetch(e.request);\r\n            })\r\n        );\r\n    }\r\n});\r\n```\r\nè¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿä¸ºAPIç¼“å­˜çš„æ•°æ®åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„ç¼“å­˜ä½ç½®ï¼Œkeyå€¼ä¸ºå˜é‡`apiCacheName`ã€‚åœ¨`fetch`äº‹ä»¶ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡å¯¹æ¯”å½“å‰è¯·æ±‚ä¸`cacheRequestUrls`æ¥åˆ¤æ–­æ˜¯å¦æ˜¯éœ€è¦ç¼“å­˜çš„XHRè¯·æ±‚æ•°æ®ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¼šä½¿ç”¨`fetch`æ–¹æ³•å‘åç«¯å‘èµ·è¯·æ±‚ã€‚\r\n\r\nåœ¨`fetch.then`ä¸­æˆ‘ä»¬ä»¥è¯·æ±‚çš„URLä¸ºkeyï¼Œå‘cacheä¸­æ›´æ–°äº†ä¸€ä»½å½“å‰è¯·æ±‚æ‰€è¿”å›æ•°æ®çš„ç¼“å­˜ï¼š`cache.put(e.request.url, response.clone())`ã€‚è¿™é‡Œä½¿ç”¨`.clone()`æ–¹æ³•æ‹·è´ä¸€ä»½å“åº”æ•°æ®ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¯¹å“åº”ç¼“å­˜è¿›è¡Œå„ç±»æ“ä½œè€Œä¸ç”¨æ‹…å¿ƒåŸå“åº”ä¿¡æ¯è¢«ä¿®æ”¹äº†ã€‚\r\n\r\n### 3.7. åº”ç”¨ç¦»çº¿XHRæ•°æ®ï¼Œå®Œæˆâ€œç¦»çº¿æœç´¢â€ï¼Œæå‡å“åº”é€Ÿåº¦\r\nå¦‚æœä½ è·Ÿç€åšåˆ°äº†è¿™ä¸€æ­¥ï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œè·ç¦»æˆ‘ä»¬é…·é…·çš„ç¦»çº¿åº”ç”¨è¿˜å·®æœ€åä¸€æ­¥äº†ï¼\r\n\r\nç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å¯¹Service Workerï¼ˆsw.jsï¼‰çš„æ”¹é€ å·²ç»å®Œæ¯•äº†ã€‚æœ€ååªå‰©ä¸‹å¦‚ä½•åœ¨XHRè¯·æ±‚æ—¶æœ‰ç­–ç•¥çš„ä½¿ç”¨ç¼“å­˜äº†ï¼Œè¿™ä¸€éƒ¨åˆ†çš„æ”¹é€ å…¨éƒ¨é›†ä¸­äºindex.jsï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„å‰ç«¯è„šæœ¬ã€‚\r\n\r\nè¿˜æ˜¯å›åˆ°ä¸Šä¸€èŠ‚çš„è¿™å¼ å›¾ï¼š\r\n\r\n![å›¾ä¹¦æŸ¥è¯¢æ¥å£çš„ç¼“å­˜ä¸ä½¿ç”¨ç­–ç•¥](https://user-gold-cdn.xitu.io/2018/4/8/162a560d35c15a67?w=567&h=266&f=png&s=16946)\r\n\r\nå’Œæ™®é€šæƒ…å†µä¸åŒï¼Œè¿™é‡Œæˆ‘ä»¬çš„å‰ç«¯æµè§ˆå™¨ä¼šé¦–å…ˆå»å°è¯•è·å–ç¼“å­˜æ•°æ®å¹¶ä½¿ç”¨å…¶æ¥æ¸²æŸ“ç•Œé¢ï¼›åŒæ—¶ï¼Œæµè§ˆå™¨ä¹Ÿä¼šå‘èµ·ä¸€ä¸ªXHRè¯·æ±‚ï¼ŒService Workeré€šè¿‡å°†è¯·æ±‚è¿”å›çš„æ•°æ®æ›´æ–°åˆ°å­˜å‚¨ä¸­çš„åŒæ—¶å‘å‰ç«¯Webåº”ç”¨è¿”å›æ•°æ®ï¼ˆè¿™ä¸€æ­¥åˆ†å°±æ˜¯ä¸Šä¸€èŠ‚æåˆ°çš„ç¼“å­˜ç­–ç•¥ï¼‰ï¼›æœ€ç»ˆï¼Œå¦‚æœåˆ¤æ–­è¿”å›çš„æ•°æ®ä¸æœ€å¼€å§‹å–åˆ°çš„cacheä¸ä¸€è‡´ï¼Œåˆ™é‡æ–°æ¸²æŸ“ç•Œé¢ï¼Œå¦åˆ™å¿½ç•¥ã€‚\r\n\r\nä¸ºäº†æ˜¯ä»£ç æ›´æ¸…æ™°ï¼Œæˆ‘ä»¬å°†åŸæœ¬çš„XHRè¯·æ±‚éƒ¨åˆ†å•ç‹¬å‰¥ç¦»å‡ºæ¥ï¼Œä½œä¸ºä¸€ä¸ªæ–¹æ³•`getApiDataRemote()`ä»¥ä¾›è°ƒç”¨ï¼ŒåŒæ—¶å°†å…¶æ”¹é€ ä¸ºäº†Promiseã€‚ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œæˆ‘éƒ¨åˆ†çš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œå°±ä¸å•ç‹¬è´´å‡ºäº†ã€‚\r\n\r\nè¿™ä¸€èŠ‚æœ€é‡è¦çš„éƒ¨åˆ†å…¶å®æ˜¯è¯»å–ç¼“å­˜ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨Service Workerä¸­æ˜¯å¯ä»¥é€šè¿‡`caches`å˜é‡æ¥è®¿é—®åˆ°ç¼“å­˜å¯¹è±¡çš„ã€‚ä»¤äººé«˜å…´çš„æ˜¯ï¼Œåœ¨æˆ‘ä»¬çš„å‰ç«¯åº”ç”¨ä¸­ï¼Œä¹Ÿä»ç„¶å¯ä»¥é€šè¿‡`caches`æ¥è®¿é—®ç¼“å­˜ã€‚å½“ç„¶ï¼Œä¸ºäº†ä¿è¯æ¸è¿›å¯ç”¨ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè¿›è¡Œåˆ¤æ–­`'caches' in window`ã€‚ä¸ºäº†ä»£ç çš„ç»Ÿä¸€ï¼Œæˆ‘å°†è·å–è¯¥è¯·æ±‚çš„ç¼“å­˜æ•°æ®ä¹Ÿå°è£…æˆäº†ä¸€ä¸ªPromiseæ–¹æ³•ï¼š\r\n\r\n```javascript\r\nfunction getApiDataFromCache(url) {\r\n    if ('caches' in window) {\r\n        return caches.match(url).then(function (cache) {\r\n            if (!cache) {\r\n                return;\r\n            }\r\n            return cache.json();\r\n        });\r\n    }\r\n    else {\r\n        return Promise.resolve();\r\n    }\r\n}\r\n```\r\nè€ŒåŸæœ¬æˆ‘ä»¬åœ¨`queryBook()`æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šè¯·æ±‚åç«¯æ•°æ®ï¼Œç„¶åæ¸²æŸ“é¡µé¢ï¼›è€Œç°åœ¨ï¼Œæˆ‘ä»¬åŠ ä¸ŠåŸºäºç¼“å­˜çš„æ¸²æŸ“ï¼š\r\n```javascript\r\nfunction queryBook() {\r\n    // â€¦â€¦\r\n    // è¿œç¨‹è¯·æ±‚\r\n    var remotePromise = getApiDataRemote(url);\r\n    var cacheData;\r\n    // é¦–å…ˆä½¿ç”¨ç¼“å­˜æ•°æ®æ¸²æŸ“\r\n    getApiDataFromCache(url).then(function (data) {\r\n        if (data) {\r\n            loading(false);\r\n            input.blur();            \r\n            fillList(data.books);\r\n            document.querySelector('#js-thanks').style = 'display: block';\r\n        }\r\n        cacheData = data || {};\r\n        return remotePromise;\r\n    }).then(function (data) {\r\n        if (JSON.stringify(data) !== JSON.stringify(cacheData)) {\r\n            loading(false);                \r\n            input.blur();\r\n            fillList(data.books);\r\n            document.querySelector('#js-thanks').style = 'display: block';\r\n        }\r\n    });\r\n    // â€¦â€¦\r\n}\r\n```\r\nå¦‚æœ`getApiDataFromCache(url).then`è¿”å›ç¼“å­˜æ•°æ®ï¼Œåˆ™ä½¿ç”¨å®ƒå…ˆè¿›è¡Œæ¸²æŸ“ã€‚è€Œå½“`remotePromise`çš„æ•°æ®è¿”å›æ—¶ï¼Œä¸`cacheData`è¿›è¡Œæ¯”å¯¹ï¼Œåªæœ‰åœ¨æ•°æ®ä¸ä¸€è‡´æ—¶éœ€è¦é‡æ–°æ¸²æŸ“é¡µé¢ï¼ˆæ³¨æ„è¿™é‡Œä¸ºäº†ç®€ä¾¿ï¼Œç²—ç•¥åœ°ä½¿ç”¨äº†`JSON.stringify()`æ–¹æ³•è¿›è¡Œå¯¹è±¡é—´çš„æ¯”è¾ƒï¼‰ã€‚è¿™ä¹ˆåšæœ‰ä¸¤ä¸ªä¼˜åŠ¿ï¼š\r\n\r\n1. ç¦»çº¿å¯ç”¨ã€‚å¦‚æœæˆ‘ä»¬ä¹‹å‰è®¿é—®è¿‡æŸäº›URLï¼Œé‚£ä¹ˆå³ä½¿åœ¨ç¦»çº¿çš„æƒ…å†µä¸‹ï¼Œé‡å¤ç›¸åº”çš„æ“ä½œä¾ç„¶å¯ä»¥æ­£å¸¸å±•ç¤ºé¡µé¢ï¼›\r\n2. ä¼˜åŒ–ä½“éªŒï¼Œæé«˜è®¿é—®é€Ÿåº¦ã€‚è¯»å–æœ¬åœ°cacheè€—æ—¶ç›¸æ¯”äºç½‘ç»œè¯·æ±‚æ˜¯éå¸¸ä½çš„ï¼Œå› æ­¤å°±ä¼šç»™æˆ‘ä»¬çš„ç”¨æˆ·ä¸€ç§â€œç§’å¼€â€ã€â€œç§’å“åº”â€çš„æ„Ÿè§‰ã€‚\r\n\r\n## 4. ä½¿ç”¨Lighthouseæµ‹è¯•æˆ‘ä»¬çš„åº”ç”¨\r\nè‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†PWAçš„ä¸¤å¤§åŸºæœ¬åŠŸèƒ½ï¼šWeb App Manifestå’ŒService Workerçš„ç¦»çº¿ç¼“å­˜ã€‚è¿™ä¸¤å¤§åŠŸèƒ½å¯ä»¥å¾ˆå¥½åœ°æå‡ç”¨æˆ·ä½“éªŒä¸åº”ç”¨æ€§èƒ½ã€‚æˆ‘ä»¬ç”¨Chromeä¸­çš„Lighthouseæ¥æ£€æµ‹ä¸€ä¸‹ç›®å‰çš„åº”ç”¨ï¼š\r\n\r\n![Lighthouseæ£€æµ‹ç»“æœ](https://user-gold-cdn.xitu.io/2018/4/8/162a560d5f48ee00?w=724&h=130&f=png&s=22130)\r\n\r\n![Lighthouseæ£€æµ‹ç»“æœ - PWA](https://user-gold-cdn.xitu.io/2018/4/8/162a560d65ba5c20?w=723&h=224&f=png&s=27543)\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œåœ¨PWAè¯„åˆ†ä¸Šï¼Œæˆ‘ä»¬çš„è¿™ä¸ªWeb Appå·²ç»éå¸¸ä¸é”™äº†ã€‚å…¶ä¸­å”¯ä¸€ä¸ªæ‰£åˆ†é¡¹æ˜¯åœ¨HTTPSåè®®ä¸Šï¼šç”±äºæ˜¯æœ¬åœ°è°ƒè¯•ï¼Œæ‰€ä»¥ä½¿ç”¨äº†http://127.0.0.1:8085ï¼Œåœ¨ç”Ÿäº§è‚¯å®šä¼šæ›¿æ¢ä¸ºHTTPSã€‚\r\n\r\n## 5. è¿™å¤ªé…·äº†ï¼Œä½†æ˜¯å…¼å®¹æ€§å‘¢ï¼Ÿ\r\néšç€ä»Šå¹´ï¼ˆ2018å¹´ï¼‰å¹´åˆï¼ŒAppleåœ¨iOS 11.3ä¸­å¼€å§‹æ”¯æŒService Workerï¼ŒåŠ ä¸ŠAppleä¸€ç›´ä»¥æ¥è¾ƒä¸ºè‰¯å¥½çš„ç³»ç»Ÿå‡çº§ç‡ï¼Œæ•´ä¸ªPWAåœ¨å…¼å®¹æ€§é—®é¢˜ä¸Šæœ‰äº†é‡å¤§çš„çªç ´ã€‚\r\n\r\nè™½ç„¶Service Workerä¸­çš„ä¸€äº›å…¶ä»–åŠŸèƒ½ï¼ˆä¾‹å¦‚æ¨é€ã€åå°åŒæ­¥ï¼‰Appleå¹¶æœªè¡¨æ€ï¼Œä½†æ˜¯Web App Manifestå’ŒService Workerçš„ç¦»çº¿ç¼“å­˜æ˜¯iOS 11.3æ‰€æ”¯æŒçš„ã€‚è¿™ä¸¤å¤§æ ¸å¿ƒåŠŸèƒ½ä¸ä»…æ•ˆæœæ‹”ç¾¤ï¼Œè€Œä¸”ç›®å‰çœ‹æ¥å…·æœ‰è¿˜ä¸é”™çš„å…¼å®¹æ€§ï¼Œéå¸¸é€‚åˆæŠ•å…¥ç”Ÿäº§ã€‚\r\n\r\næ›´ä½•å†µï¼Œä½œä¸ºæ¸è¿›å¼ç½‘é¡µåº”ç”¨ï¼Œå…¶æœ€é‡è¦çš„ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯åœ¨å…¼å®¹æ€§æ”¯æŒæ—¶è‡ªåŠ¨å‡çº§åŠŸèƒ½ä¸ä½“éªŒï¼›è€Œåœ¨ä¸æ”¯æŒæ—¶ï¼Œä¼šé™é»˜å›é€€éƒ¨åˆ†æ–°åŠŸèƒ½ã€‚åœ¨ä¿è¯æˆ‘ä»¬çš„æ­£å¸¸æœåŠ¡æƒ…å†µä¸‹ï¼Œå°½å¯èƒ½åˆ©ç”¨æµè§ˆå™¨ç‰¹æ€§ï¼Œæä¾›æ›´ä¼˜è´¨çš„æœåŠ¡ã€‚\r\n\r\n![Service Workerå…¼å®¹æ€§](https://user-gold-cdn.xitu.io/2018/4/8/162a560d66590ff7?w=1240&h=473&f=png&s=133285)\r\n\r\n## 6. å†™åœ¨æœ€å\r\næœ¬æ–‡ä¸­æ‰€æœ‰çš„ä»£ç ç¤ºä¾‹å‡å¯ä»¥åœ¨[learn-pwa/sw-cache](https://github.com/alienzhou/learning-pwa/tree/sw-cache)ä¸Šæ‰¾åˆ°ã€‚æ³¨æ„åœ¨git cloneä¹‹åï¼Œåˆ‡æ¢åˆ°sw-cacheåˆ†æ”¯ï¼Œæœ¬æ–‡æ‰€æœ‰çš„ä»£ç å‡å­˜åœ¨äºè¯¥åˆ†æ”¯ä¸Šã€‚åˆ‡æ¢å…¶ä»–åˆ†å€¼å¯ä»¥çœ‹åˆ°ä¸åŒçš„ç‰ˆæœ¬ï¼š\r\n- basicåˆ†æ”¯ï¼šåŸºç¡€é¡¹ç›®demoï¼Œä¸€ä¸ªæ™®é€šçš„å›¾ä¹¦æœç´¢åº”ç”¨ï¼ˆç½‘ç«™ï¼‰ï¼›\r\n- manifeståˆ†æ”¯ï¼šåŸºäºbasicåˆ†æ”¯ï¼Œæ·»åŠ manifestç­‰åŠŸèƒ½ï¼Œå…·ä½“å¯ä»¥çœ‹ä¸Šä¸€ç¯‡æ–‡ç« äº†è§£ï¼›\r\n- sw-cacheåˆ†æ”¯ï¼šåŸºäºmanifeståˆ†æ”¯ï¼Œæ·»åŠ ç¼“å­˜ä¸ç¦»çº¿åŠŸèƒ½ï¼›\r\n- masteråˆ†æ”¯ï¼šåº”ç”¨çš„æœ€æ–°ä»£ç ã€‚\r\n\r\n> æœ€åå£°æ˜ä¸€ä¸‹ï¼Œæ–‡ä¸­çš„ä»£ç ä½œä¸ºdemoï¼Œä¸»è¦æ˜¯ç”¨äºäº†è§£ä¸å­¦ä¹ PWAæŠ€æœ¯åŸç†ï¼Œå¯èƒ½ä¼šå­˜åœ¨ä¸€äº›ä¸å®Œå–„çš„åœ°æ–¹ï¼Œå› æ­¤ï¼Œä¸å»ºè®®ç›´æ¥ä½¿ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒã€‚\r\n\r\n## å‚è€ƒèµ„æ–™\r\n- [Using Service Workersï¼ˆMDNï¼‰](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API/Using_Service_Workers)\r\n- [Cacheï¼ˆMDNï¼‰](https://developer.mozilla.org/zh-CN/docs/Web/API/Cache)\r\n- [Service Workerä½¿ç”¨æ–¹å¼](https://developers.google.com/web/fundamentals/primers/service-workers/)\r\n- [JavaScript Promiseï¼šç®€ä»‹](https://developers.google.com/web/fundamentals/primers/promises)\r\n- [Promiseï¼ˆMDNï¼‰](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise)","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/3","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/3/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/3/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/3/events","html_url":"https://github.com/alienzhou/blog/issues/3","id":390507083,"node_id":"MDU6SXNzdWUzOTA1MDcwODM=","number":3,"title":"ã€PWAå­¦ä¹ ä¸å®è·µã€‘(2) ä½¿ç”¨Manifestï¼Œè®©ä½ çš„WebAppæ›´â€œNativeâ€","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845017,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE3","url":"https://api.github.com/repos/alienzhou/blog/labels/PWA","name":"PWA","color":"008672","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T03:51:54Z","updated_at":"2018-12-13T03:51:54Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« å·²æ•´ç†è‡³[gitbook - PWAå­¦ä¹ æ‰‹å†Œ](https://alienzhou.gitbook.io/learning-pwa/)ï¼Œæ–‡å­—å†…å®¹å·²åŒæ­¥è‡³[learning-pwa-ebook](https://github.com/alienzhou/learning-pwa-ebook)ã€‚è½¬è½½è¯·æ³¨æ˜ä½œè€…ä¸å‡ºå¤„ã€‚\r\n\r\næœ¬æ–‡æ˜¯ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—çš„ç¬¬äºŒç¯‡æ–‡ç« ã€‚æ–‡ä¸­çš„ä»£ç éƒ½å¯ä»¥åœ¨[learning-pwaçš„manifeståˆ†æ”¯](https://github.com/alienzhou/learning-pwa/tree/manifest)ä¸Šæ‰¾åˆ°ï¼ˆ`git clone`åæ³¨æ„åˆ‡æ¢åˆ°manifeståˆ†æ”¯ï¼‰ã€‚\r\n\r\nPWAä½œä¸ºæ—¶ä¸‹æœ€ç«çƒ­çš„æŠ€æœ¯æ¦‚å¿µä¹‹ä¸€ï¼Œå¯¹æå‡Webåº”ç”¨çš„å®‰å…¨ã€æ€§èƒ½å’Œä½“éªŒæœ‰ç€å¾ˆå¤§çš„æ„ä¹‰ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å»äº†è§£ä¸å­¦ä¹ ã€‚å¯¹PWAæ„Ÿå…´è¶£çš„æœ‹å‹æ¬¢è¿å…³æ³¨ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« ã€‚\r\n\r\n## 1. å¼•è¨€\r\n\r\næˆ‘ä»¬çŸ¥é“ï¼Œåœ¨chromeï¼ˆç­‰ä¸€äº›ç°ä»£æµè§ˆå™¨ï¼‰ä¸­ï¼Œä½ å¯ä»¥å°†è®¿é—®çš„ç½‘ç«™æ·»åŠ åˆ°æ¡Œé¢ï¼Œè¿™æ ·å°±ä¼šåœ¨æ¡Œé¢ç”Ÿæˆä¸€ä¸ªç±»ä¼¼â€œå¿«æ·æ–¹å¼â€çš„å›¾æ ‡ï¼Œå½“ä½ ç‚¹å‡»è¯¥å›¾æ ‡æ—¶ï¼Œä¾¿å¯ä»¥å¿«é€Ÿè®¿é—®è¯¥ç½‘ç«™ï¼ˆWeb Appï¼‰ã€‚æˆ‘ä»¬ä»¥[ç¬¬ä¸€ç¯‡æ–‡ç« ](https://juejin.im/post/5ac8a67c5188255c5668b0b8)ä¸­çš„demoä¸ºä¾‹ï¼Œå…¶æ·»åŠ åˆ°æ¡Œé¢åä»¥åŠé‡æ–°æ‰“å¼€æ—¶çš„çŠ¶æ€å¦‚ä¸‹ï¼š\r\n\r\n![æ™®é€šWeb Appè¢«æ·»åŠ åˆ°æ¡Œé¢åçš„å±•ç¤ºå½¢å¼](https://user-gold-cdn.xitu.io/2018/4/7/1629fd2a527121d2?w=750&h=482&f=png&s=185553)\r\n\r\nç„¶è€Œï¼Œå¯¹äºPWAæ¥è¯´ï¼Œæœ‰ä¸€äº›é‡è¦çš„ç‰¹æ€§ï¼š\r\n\r\n- Web Appå¯ä»¥è¢«æ·»åŠ åˆ°æ¡Œé¢å¹¶æœ‰å®ƒè‡ªå·±çš„åº”ç”¨å›¾æ ‡ï¼›\r\n- åŒæ—¶ï¼Œä»æ¡Œé¢å¼€å¯æ—¶ï¼Œä¼šå’ŒåŸç”Ÿappä¸€æ ·æœ‰å®ƒè‡ªå·±çš„â€œå¼€å±å›¾â€ï¼›\r\n- æ›´è¿›ä¸€æ­¥çš„ï¼Œè¿™ä¸ªWeb Appåœ¨çš„æ ·å­å‡ ä¹å’ŒåŸç”Ÿåº”ç”¨ä¸€æ ·â€”â€”æ²¡æœ‰æµè§ˆå™¨çš„åœ°å€æ ã€å·¥å…·æ¡ï¼Œä¼¼ä¹å’ŒNative Appä¸€æ ·è¿è¡Œåœ¨ä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨ä¸­ã€‚\r\n\r\nå°±åƒä¸‹é¢è¿™æ ·ï¼š\r\n\r\n![PWAè¢«æ·»åŠ åˆ°æ¡Œé¢åçš„å±•ç¤ºå½¢å¼](https://user-gold-cdn.xitu.io/2018/4/7/1629fd2a529adc58?w=750&h=482&f=png&s=187366)\r\n\r\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¼šåŸºäºè¯¥ç³»åˆ—â€”â€”ã€ŠPWAæŠ€æœ¯å­¦ä¹ ä¸å®è·µã€‹çš„å‰ä¸€ç¯‡ã€Š2018ï¼Œå¼€å§‹ä½ çš„PWAå­¦ä¹ ä¹‹æ—…ã€‹ä¸­æ‰€æåŠçš„ä¸€ä¸ªæ™®é€šWeb Appçš„demoæ¥è¿›è¡Œæ”¹é€ ï¼Œæ¥å®ç°PWAçš„è¿™ä¸€æ•ˆæœã€‚æˆ–è€…ç›´æ¥ä»github clone learning-pwaï¼ˆhttps://github.com/alienzhou/learning-pwa/tree/masterï¼‰è¿™ä¸ªä»“åº“ä¹Ÿå¯ä»¥ã€‚åˆ‡æ¢åˆ°manifeståˆ†æ”¯ï¼Œå³å¯çœ‹åˆ°æœ¬æ–‡çš„æœ€åæˆæœã€‚\r\n\r\n## 2. Web App Manifest\r\nManifestæ˜¯ä¸€ä¸ªJSONæ ¼å¼çš„æ–‡ä»¶ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªæŒ‡å®šäº†Web Appæ¡Œé¢å›¾æ ‡ã€åç§°ã€å¼€å±å›¾æ ‡ã€è¿è¡Œæ¨¡å¼ç­‰ä¸€ç³»åˆ—èµ„æºçš„ä¸€ä¸ªæ¸…å•ã€‚\r\n\r\n> manifest çš„ç›®çš„æ˜¯å°†Webåº”ç”¨ç¨‹åºå®‰è£…åˆ°è®¾å¤‡çš„ä¸»å±å¹•ï¼Œä¸ºç”¨æˆ·æä¾›æ›´å¿«çš„è®¿é—®å’Œæ›´ä¸°å¯Œçš„ä½“éªŒã€‚ â€”â€” MDN\r\n\r\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼Œlearning-pwaä¸­çš„[manifest.json](https://github.com/alienzhou/learning-pwa/blob/manifest/public/manifest.json)æ–‡ä»¶å†…å®¹\r\n\r\n```\r\n{\r\n    \"name\": \"å›¾ä¹¦æœç´¢\",\r\n    \"short_name\": \"ä¹¦æŸ¥\",\r\n    \"start_url\": \"/\",\r\n    \"display\": \"standalone\",\r\n    \"background_color\": \"#333\",\r\n    \"description\": \"ä¸€ä¸ªæœç´¢å›¾ä¹¦çš„å°WebAPPï¼ˆåŸºäºè±†ç“£å¼€æ”¾æ¥å£ï¼‰\",\r\n    \"orientation\": \"portrait-primary\",\r\n    \"theme_color\": \"#5eace0\",\r\n    \"icons\": [{\r\n        \"src\": \"img/icons/book-32.png\",\r\n        \"sizes\": \"32x32\",\r\n        \"type\": \"image/png\"\r\n    }, {\r\n        \"src\": \"img/icons/book-72.png\",\r\n        \"sizes\": \"72x72\",\r\n        \"type\": \"image/png\"\r\n    }, {\r\n        \"src\": \"img/icons/book-128.png\",\r\n        \"sizes\": \"128x128\",\r\n        \"type\": \"image/png\"\r\n    }, {\r\n        \"src\": \"img/icons/book-144.png\",\r\n        \"sizes\": \"144x144\",\r\n        \"type\": \"image/png\"\r\n    }, {\r\n        \"src\": \"img/icons/book-192.png\",\r\n        \"sizes\": \"192x192\",\r\n        \"type\": \"image/png\"\r\n    }, {\r\n        \"src\": \"img/icons/book-256.png\",\r\n        \"sizes\": \"256x256\",\r\n        \"type\": \"image/png\"\r\n    }, {\r\n        \"src\": \"img/icons/book-512.png\",\r\n        \"sizes\": \"512x512\",\r\n        \"type\": \"image/png\"\r\n    }]\r\n}\r\n```\r\nå¯ä»¥çœ‹å‡ºï¼Œä¸Šé¢çš„JSONé…ç½®æ–‡ä»¶éå¸¸ç›´è§‚ï¼Œé€šè¿‡å£°æ˜å„ä¸ªå±æ€§çš„å€¼ï¼Œå³å¯æ”¹é€ æˆ‘ä»¬çš„Web Appã€‚é‚£ä¹ˆä¸‹é¢å°±é’ˆå¯¹æ¯ä¸ªå…·ä½“å€¼è¿›è¡Œç®€å•çš„ä»‹ç»ã€‚\r\n### 2.1. name, short_name\r\næŒ‡å®šäº†Web Appçš„åç§°ã€‚`short_name`å…¶å®æ˜¯è¯¥åº”ç”¨çš„ä¸€ä¸ªç®€ç§°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå½“æ²¡æœ‰è¶³å¤Ÿç©ºé—´å±•ç¤ºåº”ç”¨çš„`name`æ—¶ï¼Œç³»ç»Ÿå°±ä¼šä½¿ç”¨`short_name`ã€‚å¯ä»¥çœ‹åˆ°æœ¬æ–‡çš„ä¾‹å­ä¸­ï¼Œå›¾ä¹¦æœç´¢è¿™ä¸ªåº”ç”¨åœ¨æ¡Œé¢ä¸Šå±•ç¤ºçš„åç§°å°±æ˜¯`short_name`ä¹¦æŸ¥ã€‚\r\n\r\n### 2.2. start_url\r\nè¿™ä¸ªå±æ€§æŒ‡å®šäº†ç”¨æˆ·æ‰“å¼€è¯¥Web Appæ—¶åŠ è½½çš„URLã€‚ç›¸å¯¹URLä¼šç›¸å¯¹äºmanifestã€‚è¿™é‡Œæˆ‘ä»¬æŒ‡å®šäº†`start_url`ä¸º`/`ï¼Œè®¿é—®æ ¹ç›®å½•ã€‚\r\n\r\n### 2.3. display\r\n`display`æ§åˆ¶äº†åº”ç”¨çš„æ˜¾ç¤ºæ¨¡å¼ï¼Œå®ƒæœ‰å››ä¸ªå€¼å¯ä»¥é€‰æ‹©ï¼š`fullscreen `ã€`standalone `ã€`minimal-ui`å’Œ`browser `ã€‚\r\n\r\n- `fullscreen `ï¼šå…¨å±æ˜¾ç¤ºï¼Œä¼šå°½å¯èƒ½å°†æ‰€æœ‰çš„æ˜¾ç¤ºåŒºåŸŸéƒ½å æ»¡ï¼›\r\n- `standalone `ï¼šç‹¬ç«‹åº”ç”¨æ¨¡å¼ï¼Œè¿™ç§æ¨¡å¼ä¸‹æ‰“å¼€çš„åº”ç”¨æœ‰è‡ªå·±çš„å¯åŠ¨å›¾æ ‡ï¼Œå¹¶ä¸”ä¸ä¼šæœ‰æµè§ˆå™¨çš„åœ°å€æ ã€‚å› æ­¤çœ‹èµ·æ¥æ›´åƒä¸€ä¸ªNative Appï¼›\r\n- `minimal-ui`ï¼šä¸`standalone `ç›¸æ¯”ï¼Œè¯¥æ¨¡å¼ä¼šå¤šå‡ºåœ°å€æ ï¼›\r\n- `browser `ï¼šä¸€èˆ¬æ¥è¯´ï¼Œä¼šå’Œæ­£å¸¸ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€æ ·å¼ä¸€è‡´ã€‚\r\n\r\nè®©æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™å››ç§æ¨¡å¼çš„å·®å¼‚ï¼š\r\n\r\n![displayå››ç§æ¨¡å¼çš„å·®å¼‚](https://user-gold-cdn.xitu.io/2018/4/7/1629fd2a529dbe50?w=750&h=400&f=png&s=20062)\r\n\r\nå½“ç„¶ï¼Œä¸åŒçš„ç³»ç»Ÿæ‰€è¡¨ç°å‡ºçš„å…·ä½“æ ·å¼ä¹Ÿä¸å®Œå…¨ä¸€æ ·ã€‚å°±åƒç¤ºä¾‹ä¸­çš„è™šæ‹ŸæŒ‰é”®åœ¨`fullscreen `æ¨¡å¼ä¸‹ä¼šé»˜è®¤éšè—ã€‚\r\n\r\n### 2.4. orientation\r\næ§åˆ¶Web Appçš„æ–¹å‘ã€‚è®¾ç½®æŸäº›å€¼ä¼šå…·æœ‰ç±»ä¼¼é”å±çš„æ•ˆæœï¼ˆç¦æ­¢æ—‹è½¬ï¼‰ï¼Œä¾‹å¦‚ä¾‹å­ä¸­çš„`portrait-primary`ã€‚å…·ä½“çš„å€¼åŒ…æ‹¬ï¼š`any, natural, landscape, landscape-primary, landscape-secondary, portrait, portrait-primary, portrait-secondary`ã€‚\r\n\r\n### 2.5. iconsï¼Œ background_color\r\n`icons`ç”¨æ¥æŒ‡å®šåº”ç”¨çš„æ¡Œé¢å›¾æ ‡ã€‚iconsæœ¬èº«æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«ä¸‰ä¸ªå±æ€§ï¼š\r\n- sizesï¼šå›¾æ ‡çš„å¤§å°ã€‚é€šè¿‡æŒ‡å®šå¤§å°ï¼Œç³»ç»Ÿä¼šé€‰å–æœ€åˆé€‚çš„å›¾æ ‡å±•ç¤ºåœ¨ç›¸åº”ä½ç½®ä¸Šã€‚\r\n- srcï¼šå›¾æ ‡çš„æ–‡ä»¶è·¯å¾„ã€‚æ³¨æ„ç›¸å¯¹è·¯å¾„æ˜¯ç›¸å¯¹äºmanifestã€‚\r\n- typeï¼šå›¾æ ‡çš„å›¾ç‰‡ç±»å‹ã€‚\r\n\r\néœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œæˆ‘ä¸€ç›´æçš„â€œå¼€å±å›¾â€å…¶å®æ˜¯èƒŒæ™¯é¢œè‰²+å›¾æ ‡çš„å±•ç¤ºæ¨¡å¼ï¼ˆå¹¶ä¸ä¼šè®¾ç½®ä¸€å¼ æ‰€è°“çš„å¼€å±å›¾ï¼‰ã€‚`background_color`æ˜¯åœ¨åº”ç”¨çš„æ ·å¼èµ„æºä¸ºåŠ è½½å®Œæ¯•å‰çš„é»˜è®¤èƒŒæ™¯ï¼Œå› æ­¤ä¼šå±•ç¤ºåœ¨å¼€å±ç•Œé¢ã€‚`background_color`åŠ ä¸Šæˆ‘ä»¬åˆšæ‰å®šä¹‰çš„`icons`å°±ç»„æˆäº†Web Appæ‰“å¼€æ—¶çš„â€œå¼€å±å›¾â€ã€‚\r\n\r\n### 2.6. theme_color\r\nå®šä¹‰åº”ç”¨ç¨‹åºçš„é»˜è®¤ä¸»é¢˜é¢œè‰²ã€‚ è¿™æœ‰æ—¶ä¼šå½±å“æ“ä½œç³»ç»Ÿæ˜¾ç¤ºåº”ç”¨ç¨‹åºçš„æ–¹å¼ï¼ˆä¾‹å¦‚ï¼Œåœ¨Androidçš„ä»»åŠ¡åˆ‡æ¢å™¨ä¸Šï¼Œä¸»é¢˜é¢œè‰²åŒ…å›´åº”ç”¨ç¨‹åºï¼‰ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥åœ¨metaæ ‡ç­¾ä¸­è®¾ç½®theme_colorï¼š`<meta name=\"theme-color\" content=\"#5eace0\"/>`\r\n\r\n### 2.7. description\r\nè¿™ä¸ªå­—æ®µçš„å«ä¹‰éå¸¸ç®€å•ï¼Œå°±æ˜¯ä¸€æ®µå¯¹è¯¥åº”ç”¨çš„æè¿°ã€‚\r\n\r\n## 3. ä½¿ç”¨Manifest\r\nåˆ›å»ºå¥½manifestæ–‡ä»¶åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯éœ€è¦çŸ¥é“å¦‚ä½•èƒ½è®©æˆ‘ä»¬çš„Web Appä½¿ç”¨å®ƒâ€”â€”éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨headä¸­æ·»åŠ ä¸€ä¸ªlinkæ ‡ç­¾ï¼š\r\n```html\r\n<!-- åœ¨index.htmlä¸­æ·»åŠ ä»¥ä¸‹metaæ ‡ç­¾ -->\r\n<link rel=\"manifest\" href=\"/manifest.json\">\r\n```\r\nè¿™æ ·ï¼Œåœ¨androidä¸Šæˆ‘ä»¬ä½¿ç”¨chromeå°†åº”ç”¨æ·»åŠ åˆ°æ¡Œé¢ï¼Œå°±ä¼šæ‹¥æœ‰æ–‡ç« å¼€å¤´å¤„çš„PWAæ•ˆæœã€‚ä½ å¯åœ¨è¿™é‡ŒéªŒè¯manifest.jsonçš„å†…å®¹ï¼š[Web Manifest Validator](https://manifest-validator.appspot.com/)\r\n\r\nå¦‚æœä½ çœ‹åˆ°è¿™é‡Œï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œå·²ç»çŸ¥é“å¦‚ä½•è®©æˆ‘ä»¬çš„Web Appçœ‹èµ·æ¥æ›´åƒä¸€ä¸ªç‹¬ç«‹çš„Native Appã€‚æ˜¯ä¸æ˜¯éå¸¸ç®€å•ï¼Ÿ\r\n\r\n## 4. iOS, Windows?\r\nä¸Šé¢çš„ä¸€åˆ‡çœ‹ä¼¼ç¾å¥½ï¼Œç„¶è€ŒçœŸçš„å¦‚æ­¤ä¹ˆï¼Ÿ\r\n\r\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„å·¥ä½œéƒ½éå¸¸é¡ºåˆ©ï¼šåˆ›å»ºmanifest.jsonï¼Œæ·»åŠ metaæ ‡ç­¾ï¼Œç„¶åæŠŠæˆ‘ä»¬çš„Web Appæ·»åŠ åˆ°æ¡Œé¢ã€‚ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬åœ¨iPhoneä¸Šè®¿é—®æˆ‘ä»¬çš„ç«™ç‚¹ï¼Œç„¶åâ€œæ·»åŠ åˆ°ä¸»å±å¹•â€ï¼Œä½ ä¼šå‘ç°â€”â€”ä¸€åˆ‡éƒ½å¤±æ•ˆäº†ï¼æ˜¯çš„ï¼Œä½ æ²¡æœ‰çœ‹é”™ï¼Œä¸€åˆ‡éƒ½å›åˆ°äº†åŸæ ·ã€‚\r\n\r\n![manifestçš„å…¼å®¹æ€§](https://user-gold-cdn.xitu.io/2018/4/7/1629fd2a52bb59a0?w=1240&h=476&f=png&s=131349)\r\n\r\nå¦‚æœä½ çœ‹è¿‡[caniuse](https://caniuse.com/#search=manifest)ä¸Šmanifestçš„å…¼å®¹æ€§ï¼Œé‚£ä¼šä»¤ä½ æ›´åŠ å¤´ç–¼ã€‚ä½†æ˜¯ï¼Œä¹Ÿä¸å¿…å¤ªè¿‡å¿§ä¼¤ï¼Œåœ¨iOSä¸windowsä¸Šï¼Œæˆ‘ä»¬æœ‰å…¶ä»–çš„æ–¹å¼\r\n\r\n## 5. iOSï¼ˆsafariï¼‰ä¸­çš„å¤„ç†æ–¹å¼\r\nsafariè™½ç„¶ä¸æ”¯æŒWeb App Manifestï¼Œä½†æ˜¯å®ƒæœ‰è‡ªå·±çš„ä¸€äº›headæ ‡ç­¾æ¥å®šä¹‰ç›¸åº”çš„èµ„æºä¸å±•ç¤ºå½¢å¼ï¼š\r\n\r\n- `apple-touch-icon`ï¼šæ¡Œé¢å›¾æ ‡ï¼Œé€šè¿‡åœ¨headä¸­æ·»åŠ `<link rel=\"apple-touch-icon\" href=\"your_icon.png\">`å³å¯ã€‚å…¶ä¸­è¿˜å¯ä»¥æ·»åŠ sizeså±æ€§ï¼Œæ¥æŒ‡ç¤ºç³»ç»Ÿä½¿ç”¨åœ¨å„ç±»å¹³å°ï¼ˆiphoneã€ipadâ€¦ï¼‰ä¸­ä½¿ç”¨æœ€åˆé€‚çš„å›¾æ ‡\r\n- `apple-mobile-web-app-title`ï¼šåº”ç”¨çš„æ ‡é¢˜ã€‚æ³¨æ„ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨metaæ ‡ç­¾`<meta name=\"apple-mobile-web-app-title\" content=\"AppTitle\">`\r\n- `apple-mobile-web-app-capable`ï¼šç±»ä¼¼äºmanifestä¸­çš„displayçš„åŠŸèƒ½ï¼Œé€šè¿‡è®¾ç½®ä¸ºyeså¯ä»¥è¿›å…¥standaloneæ¨¡å¼ï¼ŒåŒæ ·ä¹Ÿæ˜¯metaæ ‡ç­¾`<meta name=\"apple-mobile-web-app-capable\" content=\"yes\">`\r\n- `apple-mobile-web-app-status-bar-style`ï¼šè¿™ä¼šæ”¹å˜iOSç§»åŠ¨è®¾å¤‡çš„çŠ¶æ€æ çš„æ ·å¼ï¼Œå¹¶ä¸”åªæœ‰åœ¨standaloneæ¨¡å¼ä¸­æ‰ä¼šæœ‰æ•ˆæœã€‚`<meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black\">`ï¼Œä¸è¿‡åœ¨iPhoneXä¸Šblackä¼šå¯¼è‡´çŠ¶æ€æ ä¸æ˜¾ç¤ºä»»ä½•ä¸œè¥¿ã€‚\r\n\r\nä¸‹é¢æ˜¯learning-pwaé¡¹ç›®ä¸­çš„ç›¸å…³è®¾ç½®\r\n```html\r\n<meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\r\n<meta name=\"apple-mobile-web-app-status-bar-style\" content=\"default\">\r\n<meta name=\"apple-mobile-web-app-title\" content=\"å›¾ä¹¦æœç´¢\">\r\n<link rel=\"apple-touch-icon\" href=\"img/icons/book-256.png\">\r\n```\r\n## 6. IEä¸­çš„å¤„ç†æ–¹å¼\r\nä¸Safariç±»ä¼¼ï¼ŒIEä¸­ä¹Ÿæœ‰è‡ªå·±çš„metaæ ‡ç­¾æ¥æŒ‡ç¤ºç›¸åº”çš„èµ„æºã€‚å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æœ‰ï¼š\r\n- `application-name`ï¼šæŒ‡æ˜äº†appçš„åç§°\r\n- `msapplication-TileColor`ï¼šæŒ‡æ˜äº†â€œtileâ€çš„èƒŒæ™¯é¢œè‰²\r\n- `msapplication-xxxlogo`ï¼šä¸åŒå¤§å°çš„â€œtileâ€æ‰€ä½¿ç”¨çš„å›¾æ ‡ï¼ŒåŒ…æ‹¬è¿™å‡ ç§ï¼š`msapplication-square70x70logo, msapplication-square150x150logo, msapplication-wide310x150logo, msapplication-square310x310logo`\r\n\r\nä¸‹é¢æ˜¯learning-pwaé¡¹ç›®ä¸­çš„ç›¸å…³è®¾ç½®ï¼Œå…¶ä¸­å›¾æ ‡çš„è®¾ç½®ä¸ºäº†æ–¹ä¾¿å°±å¤ç”¨äº†å·²æœ‰çš„å›¾æ ‡æ–‡ä»¶\r\n```html\r\n<meta name=\"application-name\" content=\"å›¾ä¹¦æœç´¢\" />\r\n<meta name=\"msapplication-TileColor\" content=\"#222\">\r\n<meta name=\"msapplication-square70x70logo\" content=\"img/icons/book-72.png\" />\r\n<meta name=\"msapplication-square150x150logo\" content=\"img/icons/book-144.png\" />\r\n<meta name=\"msapplication-square310x310logo\" content=\"img/icons/book-256.png\" />\r\n```\r\n\r\n## å†™åœ¨æœ€å\r\næœ¬æ–‡ä¸»è¦æ¢ç´¢å¦‚ä½•è®©è¢«æ·»åŠ åˆ°æ¡Œé¢çš„Web Appå…·æœ‰æ›´è´´è¿‘Native Appçš„ä½¿ç”¨ä½“éªŒï¼ˆæ¡Œé¢å›¾æ ‡ã€å¼€å±é¡µã€shellâ€¦ï¼‰ã€‚\r\n\r\nå› æ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Web App Manifestã€‚é€šè¿‡æˆ‘ä»¬æ·»åŠ manifestæ–‡ä»¶ï¼Œå¹¶åœ¨HTMLä¸­è®¾ç½®ç›¸åº”çš„metaæ ‡ç­¾æ¥ä½¿ç”¨å®ƒå³å¯ï¼›è€Œåœ¨safariä¸ieä¸­ï¼Œå¯ä»¥é€šè¿‡ä¸€äº›ç‰¹æœ‰çš„metaã€linkæ ‡ç­¾æ¥å®ç°ã€‚æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Œå¾ˆæ–¹ä¾¿ï¼Ÿè¿™å°±ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿä»¥å¾ˆä½æˆæœ¬çš„æ”¹åŠ¨æˆ‘ä»¬Web Appã€‚è¿™ä¹Ÿå°±æ˜¯PWAæ¦‚å¿µçš„ç†å¿µä¹‹ä¸€ï¼šä½ å¯ä»¥æ¸è¿›å¼åœ°æé«˜Web Appçš„èƒ½åŠ›ï¼ŒåŒæ—¶åœ¨å…¼å®¹æ€§ä¸Šï¼Œä¹Ÿä¼šæ ¹æ®ä¸åŒçš„æµè§ˆå™¨çš„æ”¯æŒåº¦æä¾›æ¸è¿›å¢å¼ºçš„èƒ½åŠ›ã€‚\r\n\r\nå¥½äº†ï¼Œè¿™ç¯‡æ–‡ç« çš„å†…å®¹å°±åˆ°è¿™é‡Œäº†ã€‚\r\n\r\n## å‚è€ƒèµ„æ–™\r\n- [Web App Manifestï¼ˆMDNï¼‰](https://developer.mozilla.org/zh-CN/docs/Web/Manifest)\r\n- [Configuring Web Applicationsï¼ˆSafariï¼‰](https://developer.apple.com/library/content/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html)\r\n- [Pinned site enhancements ï¼ˆInternet Explorerï¼‰](https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/dev-guides/bg183312(v=vs.85))\r\n- [caniuse manifest](https://caniuse.com/#search=manifest)\r\n- [Web Manifest Validator](https://manifest-validator.appspot.com/)\r\n- [Address Bar Matches Brand Colors](https://developers.google.com/web/tools/lighthouse/audits/address-bar)\r\n- [demoä»£ç åœ°å€ï¼šlearning-pwa/tree/manifest](https://github.com/alienzhou/learning-pwa/tree/manifest)\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/2","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/2/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/2/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/2/events","html_url":"https://github.com/alienzhou/blog/issues/2","id":390505889,"node_id":"MDU6SXNzdWUzOTA1MDU4ODk=","number":2,"title":"ã€PWAå­¦ä¹ ä¸å®è·µã€‘(1) 2018ï¼Œå¼€å§‹ä½ çš„PWAå­¦ä¹ ä¹‹æ—…","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845017,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE3","url":"https://api.github.com/repos/alienzhou/blog/labels/PWA","name":"PWA","color":"008672","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T03:45:14Z","updated_at":"2018-12-13T03:46:03Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"> ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« å·²æ•´ç†è‡³[gitbook - PWAå­¦ä¹ æ‰‹å†Œ](https://alienzhou.gitbook.io/learning-pwa/)ï¼Œæ–‡å­—å†…å®¹å·²åŒæ­¥è‡³[learning-pwa-ebook](https://github.com/alienzhou/learning-pwa-ebook)ã€‚è½¬è½½è¯·æ³¨æ˜ä½œè€…ä¸å‡ºå¤„ã€‚\r\n\r\nPWAä½œä¸ºä»Šå¹´æœ€ç«çƒ­çš„æŠ€æœ¯æ¦‚å¿µä¹‹ä¸€ï¼Œå¯¹æå‡Webåº”ç”¨çš„å®‰å…¨ã€æ€§èƒ½å’Œä½“éªŒæœ‰ç€å¾ˆå¤§çš„æ„ä¹‰ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å»äº†è§£ä¸å­¦ä¹ ã€‚\r\n\r\næœ¬ç³»åˆ—æ–‡ç« ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ä¼šé€æ­¥æ‹†è§£PWAèƒŒåçš„å„é¡¹æŠ€æœ¯ï¼Œé€šè¿‡å®ä¾‹ä»£ç æ¥è®²è§£è¿™äº›æŠ€æœ¯çš„åº”ç”¨æ–¹å¼ã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºPWAä¸­æŠ€æœ¯ç‚¹ä¼—å¤šã€çŸ¥è¯†ç»†ç¢ï¼Œå› æ­¤æˆ‘åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œè¿›è¡Œäº†æ•´ç†ï¼Œå¹¶äº§å‡ºäº†ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« ï¼Œå¸Œæœ›èƒ½å¸¦å¤§å®¶å…¨é¢äº†è§£PWAä¸­çš„å„é¡¹æŠ€æœ¯ã€‚å¯¹PWAæ„Ÿå…´è¶£çš„æœ‹å‹æ¬¢è¿å…³æ³¨ã€‚\r\n\r\né¦–å…ˆç®€å•äº†è§£ä¸€ä¸‹PWAã€‚\r\n\r\n## 1. ä»€ä¹ˆæ˜¯PWA\r\n\r\n> PWAï¼Œå³Progressive Web App, æ˜¯æå‡ Web App çš„ä½“éªŒçš„ä¸€ç§æ–°æ–¹æ³•ï¼Œèƒ½ç»™ç”¨æˆ·åŸç”Ÿåº”ç”¨çš„ä½“éªŒã€‚\r\n\r\næˆ‘ä»¬éœ€è¦ç†è§£çš„æ˜¯ï¼ŒPWAä¸æ˜¯æŸä¸€é¡¹æŠ€æœ¯ï¼Œæˆ–è€…æŸä¸€ä¸ªæ–°çš„äº§ç‰©ï¼›è€Œæ˜¯ä¸€ç³»åˆ—WebæŠ€æœ¯ä¸æ ‡å‡†çš„é›†åˆä¸åº”ç”¨ã€‚é€šè¿‡åº”ç”¨è¿™äº›æ–°çš„æŠ€æœ¯ä¸æ ‡å‡†ï¼Œå¯ä»¥ä»å®‰å…¨ã€æ€§èƒ½å’Œä½“éªŒä¸‰ä¸ªæ–¹é¢ï¼Œä¼˜åŒ–æˆ‘ä»¬çš„Web Appã€‚æ‰€ä»¥ï¼Œå…¶å®PWAæœ¬è´¨ä¸Šä¾ç„¶æ˜¯ä¸€ä¸ªWeb Appã€‚\r\n\r\nå› æ­¤ï¼Œå­¦ä¹ PWAå…¶å®å°±æ˜¯äº†è§£ä¸æŒæ¡è¿™äº›PWAèƒŒåçš„æŠ€æœ¯ã€‚æœ¬ç³»åˆ—æ–‡ç« ä¼šé’ˆå¯¹PWAä¸­æ‰€æ¶‰åŠåˆ°çš„æŠ€æœ¯è¿›è¡Œä»‹ç»ï¼Œå¹¶é…åˆä»£ç å®ä¾‹æ¥å±•ç¤ºå„ç±»æŠ€æœ¯çš„ä½¿ç”¨æ–¹å¼ã€‚å¸Œæœ›é€šè¿‡è¿™ä¸€ç³»åˆ—æ–‡ç« ï¼Œè®©å¤§å®¶å¯¹PWAæŠ€æœ¯æœ‰ä¸€ä¸ªæ›´æ·±å…¥çš„è®¤è¯†ã€‚è€ŒPWAæœ¬èº«æ¸è¿›å¼çš„æ€æƒ³ä¹Ÿå¯ä»¥è®©æˆ‘ä»¬åœ¨ä¸šåŠ¡ä¸­â€œæ¸è¿›å¼â€åœ°ä½¿ç”¨è¿™äº›æŠ€æœ¯ï¼Œåœ¨æˆæœ¬å¯æ§çš„å‰æä¸‹ï¼Œä¸æ–­ä¼˜åŒ–æˆ‘ä»¬çš„äº§å“ã€‚\r\n\r\n## 2. PWAä¸­çš„ä¸€äº›æŠ€æœ¯\r\nPWAæœ¬èº«å…¶å®æ˜¯ä¸€ä¸ªæ¦‚å¿µé›†åˆï¼Œå®ƒä¸æ˜¯æŒ‡æŸä¸€é¡¹æŠ€æœ¯ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ç³»åˆ—çš„WebæŠ€æœ¯ä¸Webæ ‡å‡†æ¥ä¼˜åŒ–Web Appçš„å®‰å…¨ã€æ€§èƒ½å’Œä½“éªŒã€‚å…¶ä¸­æ¶‰åŠåˆ°çš„ä¸€äº›æŠ€æœ¯æ¦‚å¿µåŒ…æ‹¬äº†ï¼š\r\n\r\n- Web App Manifest\r\n- Service Worker\r\n- Cache API ç¼“å­˜\r\n- Push&Notification æ¨é€ä¸é€šçŸ¥\r\n- Background Sync åå°åŒæ­¥\r\n- å“åº”å¼è®¾è®¡\r\n- â€¦â€¦\r\n\r\nè¿™äº›æŠ€æœ¯éƒ½æ˜¯ä½ åœ¨å­¦ä¹ PWAä¸­ä¸å¯æˆ–ç¼ºçš„ã€‚è€Œéšç€[appleåœ¨iOS Safariä¸­ä¹Ÿå¼€å§‹æ”¯æŒPWA]((https://medium.com/@firt/progressive-web-apps-on-ios-are-here-d00430dee3a7))ï¼ˆå…¶ä¸­çš„æŸäº›æŠ€æœ¯ï¼‰ï¼ŒPWAçš„èˆå°æ›´å¤§äº†ã€‚\r\n\r\n## 3. é¡¹ç›®DEMO\r\nä¸ºäº†é…åˆPWAä¸­ç›¸å…³çŸ¥è¯†çš„å­¦ä¹ ï¼Œæˆ‘ä¸“é—¨åˆ›å»ºäº†ä¸€ä¸ªdemo Web Appâ€”â€”\r\n\r\nä¸€ä¸ªæ ¹æ®å…³é”®å­—æŸ¥è¯¢å›¾ä¹¦ä¿¡æ¯çš„demoï¼ˆhttps://github.com/alienzhou/learning-pwaï¼‰ã€‚\r\n\r\nè¿™ä¸ªWeb Appæœ€å¼€å§‹æ˜¯ä¸å…·å¤‡ä»»ä½•PWAçš„èƒ½åŠ›ã€‚æˆ‘ä¼šåœ¨è¿™ä¸€ç³»åˆ—æ–‡ç« ä¸­ä»¥è¿™ä¸ªdemoä¸ºä¾‹ï¼Œé˜è¿°å„é¡¹æŠ€æœ¯çš„åŒæ—¶ï¼Œå°†å…¶åº”ç”¨åœ¨demoä¸Šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¿™ä¸€ç³»åˆ—çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä¼šå’Œå¤§å®¶ä¸€èµ·å°†ä¸€ä¸ªæ™®é€šçš„ç½‘é¡µåº”ç”¨é€æ­¥å‡çº§ä¸ºä¸€ä¸ªç®€å•çš„PWAï¼Œé€šè¿‡è¿™ç§æ–¹å¼ä¸€èµ·å­¦ä¹ ã€‚\r\n\r\né¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ªdemoã€‚è¿™æ˜¯ä¸€ä¸ªæ ¹æ®å…³é”®è¯æœç´¢å›¾ä¹¦ä¿¡æ¯çš„åº”ç”¨ï¼Œç”¨æˆ·åœ¨å‰ç«¯è¾“å…¥å…³é”®è¯ï¼Œç‚¹å‡»æœç´¢ï¼Œä¼šè¯·æ±‚æˆ‘ä»¬è‡ªå·±çš„æœåŠ¡å™¨ï¼Œè€ŒæœåŠ¡å™¨ä½¿ç”¨[è±†ç“£å›¾ä¹¦API V2](https://developers.douban.com/wiki/?title=book_v2)æ¥è·å–æ•°æ®ã€‚\r\n\r\n![å›¾ä¹¦æœç´¢demo](https://user-gold-cdn.xitu.io/2018/4/7/1629fca5313ecb88?w=1238&h=590&f=jpeg&s=30210)\r\n\r\né¡¹ç›®ä½¿ç”¨[Koa](http://koajs.com/)æ¥æ­å»ºnodeæœåŠ¡å™¨ï¼Œæ‰€ä»¥éœ€è¦nodeç‰ˆæœ¬>7.6.0ï¼Œå¯ä»¥ä½¿ç”¨[nvm](https://github.com/creationix/nvm)æ¥åˆ‡æ¢åˆ°é€‚åˆçš„nodeç‰ˆæœ¬ã€‚\r\n\r\nè¦è¿è¡Œè¯¥é¡¹ç›®ï¼Œé¦–å…ˆ\r\n```bash\r\ngit clone git@github.com:alienzhou/learning-pwa.git\r\n# åˆ‡æ¢åˆ°åŸºç¡€é¡¹ç›®åˆ†æ”¯\r\ngit checkout basic\r\n```\r\næ³¨æ„ï¼Œéœ€è¦åˆ‡æ¢åˆ°basicåˆ†æ”¯ï¼Œmasteråˆ†æ”¯æ˜¯ä¸Šç»è¿‡PWAå‡çº§åæœ€æ–°çš„demoä»£ç ã€‚åªæœ‰åœ¨basicåˆ†æ”¯æ‰èƒ½çœ‹åˆ°åŸå§‹çš„Web Appã€‚æ¥ä¸‹æ¥ï¼Œå®‰è£…ä¾èµ–ï¼š\r\n```\r\nnpm install\r\n```\r\næœ€åï¼Œè¿è¡Œé¡¹ç›®ï¼š\r\n```\r\nnpm run start\r\n```\r\nç„¶åå°±å¯ä»¥åœ¨`127.0.0.1:8085`ä¸Šè®¿é—®åˆ°è¯¥é¡¹ç›®ã€‚\r\n\r\nåŸºç¡€demoçš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œå°±ä¸å»èµ˜è¿°demoä¸­çš„ä»£ç ç»†èŠ‚äº†ã€‚ç®€å•äº†è§£ä¸€ä¸‹é¡¹ç›®ç»“æ„ï¼Œå‰ç«¯ä»£ç éƒ½å­˜æ”¾äº`public`ç›®å½•ä¸­ï¼Œå…·ä½“ç»“æ„å¦‚ä¸‹ï¼š\r\n```\r\n|---public---|---index.html // å‰ç«¯é¡µé¢\r\n|            |---index.js // browserçš„JavaScriptè„šæœ¬\r\n|            |---style.css // æ ·å¼æ–‡ä»¶\r\n|            |---img // å›¾ç‰‡æ–‡ä»¶å¤¹\r\n|---app.js // nodeæœåŠ¡å¯åŠ¨å…¥å£\r\n|---util.js // nodeæœåŠ¡å·¥å…·åº“\r\n```\r\n\r\nå€¼å¾—ä¸€æçš„æ˜¯ï¼Œåç»­æ–‡ç« å†…çš„ä»£ç ä¼šä»¥åˆ†æ”¯çš„å½¢å¼å­˜åœ¨ï¼Œæ¯ç¯‡æ–‡ç« çš„æœ€ç»ˆä»£ç ä¼šå­˜æ”¾äºä¸€ä¸ªå¯¹åº”çš„åˆ†æ”¯ä¸­ã€‚ä½ å¯ä»¥é€šè¿‡æ–¹ä¾¿å¾—åˆ‡æ¢åˆ†æ”¯ï¼Œæ¥æŸ¥çœ‹æ¯ç¯‡æ–‡ç« å¯¹åº”çš„ç¤ºä¾‹ä»£ç ã€‚\r\n\r\n- basicåˆ†æ”¯ï¼šåŸºç¡€é¡¹ç›®demoï¼Œä¸€ä¸ªæ™®é€šçš„å›¾ä¹¦æœç´¢åº”ç”¨ï¼ˆç½‘ç«™ï¼‰ï¼›\r\n- manifeståˆ†æ”¯ï¼šåŸºäºbasicåˆ†æ”¯ï¼Œæ·»åŠ manifestç­‰åŠŸèƒ½ï¼›\r\n- sw-cacheåˆ†æ”¯ï¼šåŸºäºmanifeståˆ†æ”¯ï¼Œæ·»åŠ ç¼“å­˜ä¸ç¦»çº¿åŠŸèƒ½ï¼›\r\n- masteråˆ†æ”¯ï¼šåº”ç”¨çš„æœ€æ–°ä»£ç ã€‚\r\n- â€¦â€¦\r\n\r\nä½œä¸ºæœ¬ç³»åˆ—çš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œæœ¬æ–‡ç®€å•ä»‹ç»äº†PWAä¸å…¶ç›¸å…³çš„æŠ€æœ¯æ¦‚å¿µã€‚é€šè¿‡å­¦ä¹ PWAï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«å°†å…¶ä¸­çš„ä¼˜ç§€æŠ€æœ¯åº”ç”¨åˆ°æˆ‘ä»¬çš„å·¥ä½œé‡Œã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°±ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨manifestæ¥è®©ä½ çš„Web Appâ€œæ›´Nativeâ€ï¼Œæ‹¥æœ‰ä¸€ä¸ªApp Shellã€‚æƒ³äº†è§£PWAæ›´å¤šçš„åç»­çŸ¥è¯†ï¼Œå…³æ³¨ã€ŠPWAå­¦ä¹ ä¸å®è·µã€‹ç³»åˆ—æ–‡ç« ã€‚\r\n\r\nè¯ä¸å¤šè¯´ï¼Œä¸‹é¢å°±è®©æˆ‘ä»¬æ¥å…·ä½“åœ°å­¦ä¹ PWAç›¸å…³æŠ€æœ¯å§ï¼","performed_via_github_app":null},{"url":"https://api.github.com/repos/alienzhou/blog/issues/1","repository_url":"https://api.github.com/repos/alienzhou/blog","labels_url":"https://api.github.com/repos/alienzhou/blog/issues/1/labels{/name}","comments_url":"https://api.github.com/repos/alienzhou/blog/issues/1/comments","events_url":"https://api.github.com/repos/alienzhou/blog/issues/1/events","html_url":"https://github.com/alienzhou/blog/issues/1","id":390504563,"node_id":"MDU6SXNzdWUzOTA1MDQ1NjM=","number":1,"title":"(S)CSSä¸­å®ç°ä¸»é¢˜æ ·å¼çš„4Â½ç§æ–¹å¼ [è¯‘]","user":{"login":"alienzhou","id":9822789,"node_id":"MDQ6VXNlcjk4MjI3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9822789?v=4","gravatar_id":"","url":"https://api.github.com/users/alienzhou","html_url":"https://github.com/alienzhou","followers_url":"https://api.github.com/users/alienzhou/followers","following_url":"https://api.github.com/users/alienzhou/following{/other_user}","gists_url":"https://api.github.com/users/alienzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/alienzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alienzhou/subscriptions","organizations_url":"https://api.github.com/users/alienzhou/orgs","repos_url":"https://api.github.com/users/alienzhou/repos","events_url":"https://api.github.com/users/alienzhou/events{/privacy}","received_events_url":"https://api.github.com/users/alienzhou/received_events","type":"User","site_admin":false},"labels":[{"id":1159845018,"node_id":"MDU6TGFiZWwxMTU5ODQ1MDE4","url":"https://api.github.com/repos/alienzhou/blog/labels/CSS","name":"CSS","color":"7057ff","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T03:38:10Z","updated_at":"2018-12-13T03:41:45Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"åŸSlides: [4Â½ Methods for Theming in (S)CSS](https://speakerdeck.com/csswizardry/4half-methods-for-theming-in-s-css)\r\nä½œè€…: Harry Roberts\r\n\r\n> PMè¯´è¦å®ç°ä¸€ä¸ªä¸€é”®è®¾ç½®ä¸»é¢˜çš„åŠŸèƒ½ï¼Œä½œä¸ºæŠ€æœ¯ï¼Œä½ èƒ½æƒ³åˆ°çš„å®ç°æ–¹å¼æœ‰å“ªäº›å‘¢ï¼Ÿ\r\n\r\n## 1. ä»€ä¹ˆæ˜¯ä¸»é¢˜æ ·å¼ï¼Ÿ\r\n\r\nç›¸ä¿¡å¤§å®¶å¯¹ç½‘é¡µçš„ä¸»é¢˜æ ·å¼åŠŸèƒ½è‚¯å®šä¸é™Œç”Ÿã€‚å¯¹äºä¸€äº›ç«™ç‚¹ï¼Œåœ¨åŸºç¡€æ ·å¼ä¸Šï¼Œå¼€å‘è€…è¿˜ä¼šä¸ºç”¨æˆ·æä¾›å¤šç§ä¸»é¢˜æ ·å¼ä»¥ä¾›é€‰æ‹©ã€‚\r\n\r\nä¸‹é¢å°±æ˜¯ä¸€ä¸ªä¸»é¢˜æ ·å¼åŠŸèƒ½ï¼šç”¨æˆ·å¯ä»¥åœ¨å³ä¾§é€‰æ‹©è‡ªå·±å–œæ¬¢çš„ä¸»é¢˜è‰²ï¼Œä»è€Œå¾—åˆ°ä¸€ä¸ªâ€œä¸ªæ€§â€çš„é¡µé¢ã€‚\r\n\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/12/12/1679e2f8c6f75eea?w=1918&h=1038&f=png&s=199638)\r\n\r\nè¿˜æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ªç³»ç»Ÿç”¨æ¥å”®å–ï¼Œé‡‡è´­æˆ‘ä»¬ç³»ç»Ÿçš„å®¢æˆ·å¯èƒ½æœ‰å¤šä¸ªã€‚ä¹Ÿè®¸å…¶ä¸­ä¸€ä¸ªå®¢æˆ·å¾ˆå–œæ¬¢æˆ‘ä»¬å½“å‰çš„æ·±è‰²è‰²ç³»ä¸»é¢˜ï¼Œä½†æ˜¯å¦ä¸€ä¸ªç³»ç»Ÿçš„é‡‡è´­æ–¹å¸Œæœ›æˆ‘ä»¬èƒ½ä¸ºå®ƒä»¬å®šåˆ¶ä¸€å¥—æ–°çš„æ ·å¼ã€‚ä»–ä»¬å¸Œæœ›ä¹°æ¥çš„ç³»ç»Ÿèƒ½è´´åˆå®ƒä»¬è‡ªå·±çš„å“ç‰Œè°ƒæ€§ï¼Œå˜ä¸ºæµ…è‰²çš„ã€‚è¿™å…¶å®ä¹Ÿæ˜¯ä¸€ç§ä¸»é¢˜æ ·å¼çš„éœ€æ±‚ã€‚\r\n\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/12/12/1679e2fac347b63b?w=1920&h=1200&f=png&s=373192)\r\n\r\n\r\nåœ¨ä¸Šé¢çš„è®¨è®ºé‡Œï¼Œé™¤äº†â€œä¸»é¢˜â€å¤–ï¼Œæˆ‘ä»¬åˆå¼•å‡ºäº†ä¸€ä¸ªæ¦‚å¿µâ€”â€”ä¸ªæ€§åŒ–ã€‚ç»å¸¸ï¼Œæˆ‘ä»¬è¯´åˆ°ä¸»é¢˜æ—¶ï¼Œè¿˜ä¼šæœ‰ä¸€ç§è¯´æ³•å«åšï¼šä¸ªæ€§åŒ–ä¸»é¢˜ã€‚è¿™ä¸¤è€…åœ¨è‹±æ–‡ä¸­åˆ†åˆ«æœ‰ä¸¤ä¸ªå¯¹åº”çš„è¯ï¼š Theming ä¸ Customisationã€‚\r\n\r\nå½“æˆ‘ä»¬è¯´ä¸»é¢˜ï¼ˆThemingï¼‰ä¸ä¸ªæ€§åŒ–å®šåˆ¶ï¼ˆCustomisationï¼‰çš„æ—¶å€™ï¼Œå¾ˆå¤šæ—¶å€™å…¶å®å¹¶æ²¡æœ‰åŒºåˆ†ä¸¤è€…ã€‚ä½†å®é™…ä¸Šï¼Œä¸¤è€…è¿˜æ˜¯æœ‰ä¸€äº›å¾®å¦™çš„åŒºåˆ«çš„ã€‚\r\n\r\n### 1.1. ä¸»é¢˜ Theming ä¸ä¸ªæ€§åŒ–å®šåˆ¶ Customisation çš„åŒºåˆ«\r\n\r\næˆ‘ä»¬è¯´çš„ä¸»é¢˜ï¼ˆThemingï¼‰ä¸ä¸ªæ€§åŒ–å®šåˆ¶ï¼ˆCustomisationï¼‰çš„æ—¶å€™ï¼Œè¿˜æ˜¯æœ‰ä¸€äº›å¾®å¦™çš„åŒºåˆ«çš„ã€‚\r\n\r\n\r\n#### ä¸»é¢˜ï¼šç”±å¼€å‘è€…å®šä¹‰\r\n\r\nä¸»è¦è¡¨ç°åœ¨ï¼š\r\n\r\n- ç³»ç»Ÿçš„è¾“å…¥æ˜¯ç”±å¼€å‘è€…å®šä¹‰çš„\r\n- ä¸€èˆ¬æ¥è¯´å…·æœ‰æœ‰é™çš„ç§ç±»\r\n- å…·æœ‰å·²çŸ¥çš„è§„åˆ™ä¸å¸¸é‡\r\n\r\nä¾‹å¦‚ï¼Œæˆ‘ä»¬å¸¸è§çš„ä¸€äº›åº”ç”¨ä¼šæä¾›å¤œé—´ä¸»é¢˜ã€é˜…è¯»æ¨¡å¼ï¼Œè¿™äº›ä¹Ÿç®—æ˜¯ä¸»é¢˜ï¼ˆThemingï¼‰çš„èŒƒç•´ã€‚\r\n\r\n\r\n#### ä¸ªæ€§åŒ–å®šåˆ¶ï¼šç”±ç”¨æˆ·å®šä¹‰\r\n\r\nç‰¹ç‚¹è¡¨ç°åœ¨ï¼š\r\n\r\n- ç³»ç»Ÿçš„è¾“å…¥æ˜¯ç”±ç”¨æˆ·æ¥æä¾›\r\n- ä¸€èˆ¬å…·æœ‰æ— é™ç§å¯èƒ½\r\n- è§„åˆ™æ›´çµæ´»ï¼Œç”¨æˆ·â€œä¸ºæ‰€æ¬²ä¸ºâ€\r\n\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œâ€œä¸ªæ€§åŒ–â€å…¶å®æ›´å¼ºè°ƒäº†ç”¨æˆ·å¯¹ç³»ç»Ÿçš„çš„å½±å“åŠ›ã€‚\r\n\r\nå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬è°ˆåˆ°â€œä¸»é¢˜â€ä¸â€œä¸ªæ€§åŒ–å®šåˆ¶â€æ—¶ï¼Œä¹Ÿè®¸å¹¶æ²¡æœ‰ä¸€ä¸ªæ˜ç¡®çš„è¾¹ç•Œã€‚ä»ä¸Šé¢çš„æè¿°ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œä¸¤è€…ä¼¼ä¹æ˜¯å¤„äºå¤©å¹³çš„ä¸¤ç«¯ï¼ŒåŒºåˆ«ä¸»è¦åœ¨äºå¼€å‘è€…å¯¹è§„åˆ™çš„æ§åˆ¶åŠ›åº¦ä»¥åŠæ‰€èƒ½å®ç°çš„å·®å¼‚åŒ–çš„ç²’åº¦ã€‚\r\n\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/12/12/1679e2fd21633517?w=1678&h=1006&f=png&s=515617)\r\n\r\nè€Œæˆ‘ä»¬æ›´å¤šçš„æ˜¯åœ¨ä¸¤ç‚¹ä¹‹é—´æ‰¾åˆ°ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚\r\n\r\n### 1.2. å¯¹å®ç°â€œä¸»é¢˜åŠŸèƒ½â€çš„å»ºè®®\r\n\r\næˆ‘ä»¬å·²ç»å¯¹ä¸»é¢˜æ ·å¼æœ‰äº†åˆæ­¥çš„äº†è§£ï¼Œå¦‚æœä½ ä¹Ÿåœ¨äº§å“ä¸­é‡åˆ°äº†ä¸»é¢˜æ ·å¼çš„ç›¸å…³éœ€æ±‚ï¼Œä¸å¦¨å…ˆçœ‹çœ‹ä»¥ä¸‹å‡ ç‚¹å»ºè®®ï¼š\r\n\r\n1. å°½å¯èƒ½é¿å…è¿™ä¸ªåŠŸèƒ½ã€‚å› ä¸ºå¾ˆå¤šæ—¶å€™è¿™å¯èƒ½åªæ˜¯ä¸ªä¼ªéœ€æ±‚ã€‚\r\n2. KISSåŸåˆ™ï¼ˆKeep It Simple, Stupid!ï¼‰ã€‚å°½å¯èƒ½é™ä½å…¶å¤æ‚æ€§ã€‚\r\n3. å°½é‡åªå»æ”¹å˜å¤–è§‚ï¼Œè€Œä¸è¦æ”¹åŠ¨å…ƒç´ ç›’æ¨¡å‹ï¼ˆbox-modelï¼‰ã€‚\r\n4. ä¸¥æ ¼æ§åˆ¶ä½ çš„è§„åˆ™ï¼Œé¿å…é¢„æœŸå¤–çš„å·®å¼‚ã€‚\r\n5. æŠŠå®ƒä½œä¸ºä¸€ä¸ªé”¦ä¸Šæ·»èŠ±çš„åŠŸèƒ½æ¥å‘ä¸Šä¿ƒé”€ï¼ˆup-sellï¼‰ã€‚\r\n\r\n## 2. å®ç°â€œä¸»é¢˜æ ·å¼â€çš„æ–¹å¼\r\n\r\n### 2.1. æ–¹å¼ä¸€ï¼šTheme Layer\r\n\r\n> Overriding default style with additional CSS.\r\n\r\nè¿™åº”è¯¥æ˜¯å®ç°ä¸»é¢˜åŠŸèƒ½çš„ä¸€ç§æœ€å¸¸ç”¨çš„æ‰‹æ®µäº†ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬çš„ç«™ç‚¹ä¼šæœ‰ä¸€ä¸ªæœ€åˆçš„åŸºç¡€æ ·å¼ï¼ˆæˆ–è€…å«é»˜è®¤æ ·å¼ï¼‰ï¼›ç„¶åé€šè¿‡æ·»åŠ ä¸€äº›åç»­çš„é¢å¤–çš„CSSæ¥è¦†ç›–ä¸é‡æ–°å®šä¹‰éƒ¨åˆ†æ ·å¼ã€‚\r\n\r\n#### å…·ä½“å®ç°\r\n\r\né¦–å…ˆï¼Œæˆ‘ä»¬å¼•å…¥åŸºç¡€çš„æ ·å¼ `components.*` æ–‡ä»¶\r\n\r\n```scss\r\n@import \"components.tabs\";\r\n@import \"components.buttons\"\r\n```\r\n\r\nå…¶ä¸­ `components.tabs` æ–‡ä»¶å†…å®¹å¦‚ä¸‹\r\n\r\n```scss\r\n.tab {\r\n    margin: 0;\r\n    padding: 0;\r\n    background-color: gray;\r\n}\r\n```\r\n\r\nç„¶åï¼Œå‡è®¾æˆ‘ä»¬çš„æŸä¸ªä¸»é¢˜çš„æ ·å¼æ–‡ä»¶å­˜æ”¾äº `theme.*` æ–‡ä»¶ï¼š\r\n\r\nå¯¹åº”äº `components.tabs`ï¼Œ`theme.tabs` æ–‡ä»¶å†…å®¹å¦‚ä¸‹\r\n\r\n```scss\r\n.tab {\r\n    background-color: red;\r\n}\r\n```\r\n\r\nå› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦å¼•å…¥ä¸»é¢˜æ ·å¼æ–‡ä»¶å³å¯\r\n\r\n```css\r\n@import \"components.tabs\";\r\n@import \"components.buttons\"\r\n\r\n@import \"theme.tabs\";\r\n```\r\n\r\nè¿™æ ·å½“å‰çš„æ ·å¼å°±å˜ä¸ºäº†\r\n\r\n```scss\r\n.tab {\r\n    margin: 0;\r\n    padding: 0;\r\n    /* background-color: gray; */\r\n    background-color: red;\r\n}\r\n```\r\n\r\n#### ä¼˜ç‚¹\r\n\r\n- å®ç°æ–¹å¼ç®€å•\r\n- å¯ä»¥å®ç°å°†ä¸»é¢˜åº”ç”¨ä¸æ‰€æœ‰å…ƒç´ \r\n\r\n#### ç¼ºç‚¹\r\n\r\n- è¿‡å¤šçš„å†—ä½™ä»£ç \r\n- è®¸å¤šçš„CSSå…¶å®æ˜¯æ— ç”¨çš„ï¼Œæµªè´¹äº†å¸¦å®½\r\n- æŠŠæ ·å¼æ–‡ä»¶åˆ‡åˆ†åˆ°è®¸å¤šæ–‡ä»¶ä¸­ï¼Œæ›´åŠ çç¢\r\n\r\n---\r\n\r\n### 2.2. æ–¹å¼äºŒï¼šStateful Theming\r\n\r\n> Styling a UI based on a state or condition.\r\n\r\nè¯¥æ–¹å¼å¯ä»¥å®ç°åŸºäºæ¡ä»¶é€‰æ‹©ä¸åŒçš„ä¸»é¢˜çš®è‚¤ï¼Œå¹¶å…è®¸ç”¨æˆ·åœ¨å®¢æˆ·ç«¯éšæ—¶åˆ‡æ¢ä¸»é¢˜ã€‚éå¸¸é€‚åˆéœ€è¦å®¢æˆ·ç«¯æ ·å¼åˆ‡æ¢åŠŸèƒ½ï¼Œæˆ–è€…éœ€è¦å¯¹ç«™ç‚¹æŸä¸€éƒ¨åˆ†ï¼ˆåŒºåŸŸï¼‰è¿›è¡Œç‹¬ç«‹æ ·å¼è®¾ç½®çš„åœºæ™¯ã€‚\r\n\r\n#### å…·ä½“å®ç°\r\n\r\nè¿˜æ˜¯ç±»ä¼¼ä¸Šä¸€èŠ‚ä¸­ Tab çš„è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å°† Tab éƒ¨åˆ†çš„ (S)CSS æ”¹ä¸ºå¦‚ä¸‹å½¢å¼ï¼š\r\n\r\n```scss\r\n.tab {\r\n    background-color: gray;\r\n    \r\n    .t-red & {\r\n        background-color: red;\r\n    }\r\n    \r\n    .t-blue & {\r\n        background-color: blue;\r\n    }\r\n}\r\n```\r\n\r\nè¿™é‡Œæˆ‘ä»¬æŠŠ`.t-red`ä¸`.t-blue`ç§°ä¸º Tab å…ƒç´ çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ˆcontextï¼‰ã€‚Tab å…ƒç´ ä¼šæ ¹æ® context çš„ä¸åŒå±•ç¤ºå‡ºä¸åŒçš„æ ·å¼ã€‚\r\n\r\næœ€åæˆ‘ä»¬ç»™`body`å…ƒç´ åŠ ä¸Šè¿™ä¸ªå¼€å…³\r\n\r\n```html\r\n<body class=\"t-red\">\r\n    <ul class=\"tabs\">...</ul>\r\n</body>\r\n```\r\n\r\næ­¤æ—¶ Tab çš„é¢œè‰²ä¸ºçº¢è‰²ã€‚\r\n\r\nå½“æˆ‘ä»¬å°†`t-red`æ”¹ä¸º`t-blue`æ—¶ï¼ŒTab å°±å˜ä¸ºäº†è“è‰²ä¸»é¢˜ã€‚\r\n\r\nè¿›ä¸€æ­¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€äº› (S)CSS çš„ util classï¼ˆå·¥å…·ç±»ï¼‰æ¥ä¸“é—¨æ§åˆ¶ä¸€äº› CSS å±æ€§ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°æ§åˆ¶ä¸»é¢˜ã€‚ä¾‹å¦‚æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹çš„`.u-color-current`ç±»æ¥æ§åˆ¶ä¸åŒä¸»é¢˜ä¸‹çš„å­—ä½“é¢œè‰²\r\n\r\n```scss\r\n.u-color-current {\r\n    .t-red & {\r\n        color: red;\r\n    }\r\n    \r\n    .t-blue & {\r\n        color: blue;\r\n    }\r\n}\r\n```\r\n\r\nè¿™æ ·ï¼Œå½“æˆ‘ä»¬åœ¨ä¸åŒä¸»é¢˜ä¸Šä¸‹æ–‡ç¯å¢ƒä¸‹ä½¿ç”¨`.u-color-current`æ—¶ï¼Œå°±å¯ä»¥æ§åˆ¶å…ƒç´ å±•ç¤ºå‡ºä¸åŒä¸»é¢˜çš„å­—ä½“é¢œè‰²\r\n\r\n```html\r\n<body class=\"t-red\">\r\n    <h1 class=\"page-title u-color-current\">...</h1>\r\n</body>\r\n```\r\n\r\nä¸Šé¢è¿™æ®µä»£ç ä¼šæ§åˆ¶`<h1>`å…ƒç´ å­—ä½“é¢œè‰²ä¸ºçº¢è‰²ä¸»é¢˜æ—¶çš„é¢œè‰²ã€‚\r\n\r\n#### ä¼˜ç‚¹\r\n\r\n- å°†è®¸å¤šä¸»é¢˜æ”¾åœ¨äº†åŒä¸€å¤„ä»£ç ä¸­\r\n- éå¸¸é€‚åˆä¸»é¢˜åˆ‡æ¢çš„åŠŸèƒ½\r\n- éå¸¸é€‚åˆç«™ç‚¹å±€éƒ¨çš„ä¸»é¢˜åŒ–\r\n- å¯ä»¥å®ç°å°†ä¸»é¢˜åº”ç”¨äºæ‰€æœ‰å…ƒç´ \r\n\r\n#### ç¼ºç‚¹\r\n\r\n- æœ‰æ—¶æœ‰ç‚¹ä¹Ÿæ˜¯ç¼ºç‚¹ï¼Œå°†è®¸å¤šä¸»é¢˜æ··æ‚åœ¨äº†åŒä¸€å—ä»£ç ä¸­\r\n- å¯èƒ½ä¼šå­˜åœ¨å†—ä½™\r\n\r\n---\r\n\r\n### 2.3. æ–¹å¼ä¸‰ï¼šConfig Theming\r\n\r\n> Invoking a theme based on settings.\r\n\r\nè¿™ç§æ–¹å¼å…¶å®æ˜¯åœ¨å¼€å‘ä¾§æ¥å®ç°ä¸»é¢˜æ ·å¼çš„åŒºåˆ†ä¸åˆ‡æ¢çš„ã€‚åŸºäºä¸åŒçš„é…ç½®ï¼Œé…åˆä¸€äº›å¼€å‘çš„è‡ªåŠ¨åŒ–å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¼€å‘æ—¶æœŸæ ¹æ®é…ç½®æ–‡ä»¶ï¼Œç¼–è¯‘ç”Ÿæˆä¸åŒä¸»é¢˜çš„ CSS æ–‡ä»¶ã€‚\r\n\r\nå®ƒä¸€èˆ¬ä¼šç»“åˆä½¿ç”¨ä¸€äº› CSS é¢„å¤„ç†å™¨ï¼Œå¯ä»¥å¯¹ä¸åŒçš„ UI å…ƒç´ è¿›è¡Œä¸»é¢˜åˆ†ç¦»ï¼Œå¹¶ä¸”å‘å®¢æˆ·ç«¯ç›´æ¥æä¾›ä¸»é¢˜æ ·å¼ä¸‹æœ€ç»ˆçš„ CSSã€‚\r\n\r\n#### å…·ä½“å®ç°\r\n\r\næˆ‘ä»¬è¿˜æ˜¯ä»¥ Sass ä¸ºä¾‹ï¼š\r\n\r\né¦–å…ˆä¼šæœ‰ä¸€ä»½ Sass çš„é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚`settings.config.scss`ï¼Œåœ¨è¿™ä»½é…ç½®ä¸­å®šä¹‰å½“å‰çš„ä¸»é¢˜å€¼ä»¥åŠä¸€äº›å…¶ä»–å˜é‡\r\n\r\n```scss\r\n$theme: red;\r\n```\r\n\r\nç„¶åå¯¹äºä¸€ä¸ª Tab ç»„ä»¶ï¼Œæˆ‘ä»¬è¿™ä¹ˆæ¥å†™å®ƒçš„ Sass æ–‡ä»¶\r\n\r\n```scss\r\n.tab {\r\n    margin: 0;\r\n    padding: 0;\r\n    \r\n    @if ($theme == red) {\r\n        background-color: red;\r\n    } @else {\r\n        background-color: gray;\r\n    }\r\n}\r\n```\r\n\r\nè¿™æ—¶ï¼Œæˆ‘ä»¬åœ¨å…¶ä¹‹å‰å¼•å…¥ç›¸åº”çš„é…ç½®æ–‡ä»¶å\r\n\r\n```scss\r\n@import \"settings.config\";\r\n@import \"components.tabs\";\r\n```\r\n\r\nTab ç»„ä»¶å°±ä¼šå‘ˆç°å‡ºçº¢è‰²ä¸»é¢˜ã€‚\r\n\r\nå½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠæˆ‘ä»¬çš„`settings.config.scss`åšçš„æ›´å¥å£®ä¸æ˜“æ‰©å±•ä¸€äº›\r\n\r\n```scss\r\n$config: (\r\n    theme: red,\r\n    env: dev,\r\n)\r\n\r\n// ä»$configä¸­è·å–ç›¸åº”çš„é…ç½®å˜é‡\r\n@function config($key) {\r\n    @return map-get($config, $key);\r\n}\r\n```\r\n\r\nä¸ä¹‹å‰ç›¸æ¯”ï¼Œè¿™æ—¶å€™ä½¿ç”¨èµ·æ¥åªéœ€è¦è¿›è¡Œä¸€äº›å°çš„ä¿®æ”¹ï¼Œå°†ç›´æ¥ä½¿ç”¨`theme`å˜é‡æ”¹ä¸ºè°ƒç”¨`config`æ–¹æ³•\r\n\r\n```scss\r\n.tab {\r\n    margin: 0;\r\n    padding: 0;\r\n    \r\n    @if (config(theme) == red) {\r\n        background-color: red;\r\n    } @else {\r\n        background-color: gray;\r\n    }\r\n}\r\n```\r\n\r\n#### ä¼˜ç‚¹\r\n\r\n- è®¿é—®ç½‘ç«™æ—¶ï¼Œåªä¼šä¼ è¾“æ‰€éœ€çš„ CSSï¼ŒèŠ‚çœå¸¦å®½\r\n- å°†ä¸»é¢˜çš„æ§åˆ¶ä½ç½®æ”¾åœ¨äº†ä¸€ä¸ªåœ°æ–¹ï¼ˆä¾‹å¦‚ä¸Šä¾‹ä¸­çš„`settings.config.scss`æ–‡ä»¶ï¼‰\r\n- å¯ä»¥å®ç°å°†ä¸»é¢˜åº”ç”¨äºæ‰€æœ‰å…ƒç´ \r\n\r\n#### ç¼ºç‚¹\r\n\r\n- åœ¨ Sass ä¸­ä¼šæœ‰éå¸¸å¤šé€»è¾‘ä»£ç \r\n- åªæ”¯æŒæœ‰é™æ•°é‡çš„ä¸»é¢˜\r\n- ä¸»é¢˜ç›¸å…³çš„ä¿¡æ¯ä¼šéå¸ƒä»£ç åº“ä¸­\r\n- æ·»åŠ ä¸€ä¸ªæ–°ä¸»é¢˜ä¼šéå¸¸è´¹åŠ²\r\n\r\n---\r\n\r\n### 2.4. æ–¹å¼å››ï¼šTheme Palettes\r\n\r\n> Holding entire themes in a palette file.\r\n\r\nè¿™ç§æ–¹å¼æœ‰äº›ç±»ä¼¼äºæˆ‘ä»¬ç»˜å›¾æ—¶ï¼Œé¢„è®¾äº†ä¸€ä¸ªè°ƒè‰²æ¿ï¼ˆpaletteï¼‰ï¼Œç„¶åä½¿ç”¨çš„é¢œè‰²éƒ½ä»å…¶ä¸­å–å‡ºä¸€æ ·ã€‚\r\n\r\nåœ¨å®ç°ä¸»é¢˜åŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¼šæœ‰ä¸€ä¸ªç±»ä¼¼çš„â€œè°ƒè‰²æ¿â€ï¼Œå…¶ä¸­å®šä¹‰äº†ä¸»é¢˜æ‰€éœ€è¦çš„å„ç§å±æ€§å€¼ï¼Œä¹‹åå†å°†è¿™äº›ä¿¡æ¯æ³¨å…¥åˆ°é¡¹ç›®ä¸­ã€‚\r\n\r\nå½“ä½ ç»å¸¸éœ€è¦ä¸ºå®¢æˆ·ç«¯æä¾›å®Œå…¨çš„å®šåˆ¶åŒ–ä¸»é¢˜ï¼Œå¹¶ä¸”ç»å¸¸å¸Œæœ›æ›´æ–°æˆ–æ·»åŠ ä¸»é¢˜æ—¶ï¼Œè¿™ç§æ¨¡å¼ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚\r\n\r\n#### å…·ä½“å®ç°\r\n\r\nåœ¨æ–¹å¼ä¸‰ä¸­ï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ä¸­è®¾ç½®äº†ä¸€äº›â€œç¯å¢ƒâ€å˜é‡ï¼Œæ¥æ ‡ç¤ºå½“å‰æ‰€å¤„çš„ä¸»é¢˜ã€‚è€Œåœ¨æ–¹å¼å››ä¸­ï¼Œæˆ‘ä»¬ä¼šæ›´è¿›ä¸€æ­¥ï¼ŒæŠ½å–å‡ºä¸€ä¸ªä¸“é—¨çš„ palette æ–‡ä»¶ï¼Œç”¨äºå­˜æ”¾ä¸åŒä¸»é¢˜çš„å˜é‡ä¿¡æ¯ã€‚\r\n\r\nä¾‹å¦‚ï¼Œç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ª`settings.palette.red.scss`æ–‡ä»¶\r\n\r\n```scss\r\n$color: red;\r\n$color-tabs-background: $color-red;\r\n```\r\n\r\nç„¶åæˆ‘ä»¬çš„`components.tabs.scss`æ–‡ä»¶å†…å®¹å¦‚ä¸‹\r\n\r\n```css\r\n.tabs {\r\n    margin: 0;\r\n    padding: 0;\r\n    backgroung-color: $color-tabs-background;\r\n}\r\n```\r\n\r\nè¿™æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦å¼•å…¥è¿™ä¸¤ä¸ªæ–‡ä»¶å³å¯\r\n\r\n```css\r\n@import \"settings.palette.red\";\r\n@import \"components.tabs\";\r\n```\r\n\r\nå¯ä»¥çœ‹åˆ°ï¼Œ`components.tabs.scss`ä¸­å¹¶æ²¡æœ‰å…³äºä¸»é¢˜çš„é€»è¾‘åˆ¤æ–­ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸“æ³¨äºç¼–è¾‘æ ·å¼ï¼Œå‰©ä¸‹å°±æ˜¯é€‰æ‹©æ‰€éœ€çš„ä¸»é¢˜è°ƒè‰²æ¿ï¼ˆpaletteï¼‰å³å¯ã€‚\r\n\r\n#### ä¼˜ç‚¹\r\n\r\n- ç¼–è¯‘å‡ºæ¥çš„æ ·å¼ä»£ç æ— å†—ä½™\r\n- éå¸¸é€‚åˆåšä¸€äº›å®šåˆ¶åŒ–ä¸»é¢˜ï¼Œä¾‹å¦‚ä¸€ä¸ªå…¬å¸é‡‡è´­äº†ä½ ä»¬çš„ç³»ç»Ÿï¼Œä½ å¯ä»¥å¾ˆæ–¹ä¾¿å®ç°ä¸€ä¸ªè¯¥å…¬å¸çš„ä¸»é¢˜\r\n- å¯ä»¥ä»ä¸€ä¸ªæ–‡ä»¶ä¸­å®Œå…¨é‡åˆ¶å‡ºä½ éœ€è¦çš„ä¸»é¢˜æ ·å¼\r\n\r\n#### ç¼ºç‚¹\r\n\r\n- ç”±äºä¸»è¦é€šè¿‡è®¾å®šä¸åŒå˜é‡ï¼Œæ‰€ä»¥ä»£ç ç¡®å®šåï¼Œèƒ½å®ç°çš„ä¿®æ”¹èŒƒå›´ä¼šæ˜¯æœ‰é™çš„\r\n\r\n---\r\n\r\n### 2.5. æ–¹å¼äº”ï¼šç”¨æˆ·å®šåˆ¶åŒ– User Customisation\r\n\r\n> Letting users style their own UIs.\r\n\r\nè¿™ç§æ¨¡å¼ä¸€èˆ¬ä¼šæä¾›ä¸€ä¸ªä¸ªæ€§åŒ–é…ç½®ä¸ç®¡ç†ç•Œé¢ï¼Œè®©ç”¨æˆ·èƒ½è‡ªå·±å®šä¹‰é¡µé¢çš„å±•ç¤ºæ ·å¼ã€‚\r\n\r\nâ€œç”¨æˆ·å®šåˆ¶åŒ–â€åœ¨ç¤¾äº¤åª’ä½“äº§å“ã€SaaS å¹³å°æˆ–è€…æ˜¯ Brandable Software ä¸­æœ€ä¸ºå¸¸è§ã€‚\r\n\r\n#### å…·ä½“å®ç°\r\n\r\nè¦å®ç°å®šåˆ¶åŒ–ï¼Œå¯ä»¥ç»“åˆæ–¹å¼äºŒä¸­æåˆ°çš„ util classã€‚\r\n\r\né¦–å…ˆï¼Œé¡µé¢ä¸­æ”¯æŒè‡ªå®šä¹‰çš„å…ƒç´ ä¼šè¢«é¢„å…ˆæ·»åŠ  util classï¼Œä¾‹å¦‚ Tab å…ƒç´ ä¸­çš„`u-user-color-background`\r\n\r\n```html\r\n<ul class=\"tabs u-user-color-background\">...</ul>\r\n```\r\n\r\næ­¤æ—¶ï¼Œ`u-user-color-background`è¿˜å¹¶æœªå®šä¹‰ä»»ä½•æ ·å¼ã€‚è€Œå½“ç”¨æˆ·è¾“å…¥äº†ä¸€ä¸ªèƒŒæ™¯è‰²æ—¶ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª`<style>`æ ‡ç­¾ï¼Œå¹¶å°† hex å€¼æ³¨å…¥å…¶ä¸­\r\n\r\n```html\r\n<style id=\"my-custom\">\r\n    .u-user-color-background {\r\n        background-color: #00ffff;\r\n    }\r\n</style>\r\n```\r\n\r\nè¿™æ—¶ç”¨æˆ·å°±å¾—åˆ°äº†ä¸€ä¸ªçº¢è‰²çš„ Tabã€‚\r\n\r\nTwitter å°±æ˜¯ä½¿ç”¨è¿™ç§æ–¹å¼æ¥å®ç°ç”¨æˆ·å®šåˆ¶åŒ–çš„ç•Œé¢æ ·å¼çš„ï¼š\r\n\r\n\r\n![](https://user-gold-cdn.xitu.io/2018/12/12/1679e300d854a05e?w=1353&h=749&f=png&s=377033)\r\n\r\n#### ä¼˜ç‚¹\r\n\r\n- ä¸éœ€è¦å¼€å‘äººå‘˜çš„è¾“å…¥ä¿¡æ¯ï¼ˆæ˜¯ç”¨æˆ·å®šä¹‰çš„ï¼‰\r\n- å…è®¸ç”¨æˆ·æ‹¥æœ‰è‡ªå·±â€œç‹¬ä¸€æ— äºŒâ€çš„ç«™ç‚¹\r\n- éå¸¸å®ç”¨\r\n\r\n#### ç¼ºç‚¹\r\n\r\n- ä¸éœ€è¦å¼€å‘äººå‘˜çš„è¾“å…¥ä¿¡æ¯ä¹Ÿæ„å‘³ç€ä½ éœ€è¦å¤„ç†æ›´å¤šçš„â€œä¸å¯æ§â€æƒ…å†µ\r\n- ä¼šæœ‰è®¸å¤šçš„å†—ä½™\r\n- ä¼šæµªè´¹ CSS çš„å¸¦å®½\r\n- å¤±å»éƒ¨åˆ† CSS çš„æµè§ˆå™¨ç¼“å­˜èƒ½åŠ›\r\n\r\n---\r\n\r\n## 3. å¦‚ä½•é€‰æ‹©æ–¹æ¡ˆï¼Ÿ\r\n\r\næœ€åæ¥èŠèŠæ–¹æ¡ˆçš„é€‰æ‹©ã€‚\r\n\r\nåœ¨ç¬¬äºŒéƒ¨åˆ†æˆ‘ä»¬å·²ç»äº†è§£äº†äº”ç§å®ç°æ–¹å¼ï¼ˆæˆ–è€…è¯´4Â½ç§æ–¹æ³•ï¼Œå› ä¸ºç¬¬äº”ç§å…¶å®æ›´åä¸ªæ€§åŒ–å®šåˆ¶ä¸€äº›ï¼‰ï¼Œé‚£ä¹ˆé¢å¯¹äº§å“éœ€æ±‚ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿ\r\n\r\nè¿™é‡Œæœ‰ä¸€ä¸ªä¸æ˜¯éå¸¸ä¸¥è°¨çš„æ–¹å¼å¯ä»¥å‚è€ƒã€‚ä½ å¯ä»¥é€šè¿‡å°è¯•é—®è‡ªå·±ä¸‹é¢è¿™å‡ ä¸ªé—®é¢˜æ¥åšå‡ºå†³å®šï¼š\r\n\r\n- **æ˜¯ä½ è¿˜æ˜¯ç”¨æˆ·è°æ¥ç¡®å®šæ ·å¼ï¼Ÿ**\r\nç”¨æˆ·ï¼šé€‰æ‹©ã€æ–¹å¼äº”ã€‘User Customisation\r\n\r\n- **ä¸»é¢˜æ˜¯å¦ä¼šåœ¨å®¢æˆ·ç«¯ä¸­è¢«åˆ‡æ¢ï¼Ÿ**\r\næ˜¯ï¼šé€‰æ‹©ã€æ–¹å¼äºŒã€‘Stateful Theming æˆ–ã€æ–¹å¼äº”ã€‘User Customisation\r\n\r\n- **æ˜¯å¦æœ‰ä¸»é¢˜èƒ½è®©ç”¨æˆ·åˆ‡æ¢ï¼Ÿ**\r\næ˜¯ï¼šé€‰æ‹©ã€æ–¹å¼äºŒã€‘Stateful Theming\r\n\r\n- **ä½ æ˜¯å¸Œæœ›ç½‘ç«™çš„æŸäº›éƒ¨åˆ†éœ€è¦æœ‰ä¸åŒä¹ˆï¼Ÿ**\r\næ˜¯ï¼šé€‰æ‹©ã€æ–¹å¼äºŒã€‘Stateful Theming\r\n\r\n- **æ˜¯å¦æœ‰é¢„è®¾çš„ä¸»é¢˜è®©å®¢æˆ·ç«¯æ¥é€‰æ‹©ï¼Ÿ**\r\næ˜¯ï¼šé€‰æ‹©ã€æ–¹å¼ä¸‰ã€‘Config Theming\r\n\r\n- **æ˜¯å¦æ˜¯ç±»ä¼¼â€œè´´ç‰Œâ€è¿™ç±»åœºæ™¯ï¼Ÿ**\r\næ˜¯ï¼šé€‰æ‹©ã€æ–¹å¼ä¸€ã€‘Theme Layer æˆ–ã€æ–¹å¼å››ã€‘Theme Palettes\r\n\r\n\r\n","performed_via_github_app":null}]